<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#1a3a5c" />
  <title>ğŸš Maass Family RV Adventure 2026</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- exifr: read GPS + datetime EXIF from uploaded photos -->
  <script src="https://cdn.jsdelivr.net/npm/exifr@7.1.3/dist/lite.umd.cjs"></script>
  <style>
    /* â”€â”€ RESET & BASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --orange:   #E8813A;
      --orange-d: #C96820;
      --orange-l: #FDF0E6;
      --blue:     #2C5F8A;
      --blue-l:   #E8F2FA;
      --green:    #3A8A5C;
      --green-l:  #E6F4EC;
      --purple:   #7B5EA7;
      --purple-l: #F0EBF9;
      --red:      #D94F3D;
      --red-l:    #FCECEA;
      --gold:     #D4A017;
      --gold-l:   #FDF6E3;
      --bg:       #F7F4EF;
      --card:     #FFFFFF;
      --border:   #E2DDD6;
      --text:     #2D2A25;
      --text-2:   #6B6560;
      --text-3:   #9E9890;
      --radius:   12px;
      --radius-s: 8px;
      --shadow:   0 1px 3px rgba(0,0,0,.04), 0 6px 20px rgba(0,0,0,.10);
      --shadow-m: 0 2px 6px rgba(0,0,0,.06), 0 12px 36px rgba(0,0,0,.16);
      --font:     -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      /* â”€â”€ SPACING SCALE (4-point grid) â”€â”€ */
      --sp-1: 4px;   /* tight: badge gap, icon gap         */
      --sp-2: 8px;   /* close: labelâ†”value, badge padding  */
      --sp-3: 12px;  /* inner: card-body narrow, chip pad  */
      --sp-4: 16px;  /* base:  card-header, card-body      */
      --sp-5: 20px;  /* wide:  card-body default           */
      --sp-6: 24px;  /* section: tab padding, section gap  */
      --sp-8: 32px;  /* large: section header margin       */
      /* â”€â”€ TYPE SCALE (3 tiers) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      --fs-display: 1.8rem;   /* stat numbers, hero values         */
      --fs-h1:      1.1rem;   /* section titles                    */
      --fs-h2:      1rem;     /* card titles, emphasis labels      */
      --fs-body:    .875rem;  /* all body / description text       */
      --fs-caption: .75rem;   /* labels, sub-text, badges, meta    */
    }
    /* â”€â”€ DARK MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body.dark-mode {
      --orange:   #F09050;
      --orange-d: #E8813A;
      --orange-l: #3D2510;
      --blue:     #5A9EC8;
      --blue-l:   #0F2030;
      --green:    #5ABF84;
      --green-l:  #0E2B1A;
      --purple:   #A882D0;
      --purple-l: #1E1030;
      --red:      #E87060;
      --red-l:    #2A1010;
      --gold:     #E0B840;
      --gold-l:   #2A2008;
      --bg:       #0F0F14;
      --card:     #1C1C24;
      --border:   #2E2E3A;
      --text:     #E8E6E0;
      --text-2:   #A8A4A0;
      --text-3:   #6A6868;
      --shadow:   0 2px 8px rgba(0,0,0,.3);
      --shadow-m: 0 4px 20px rgba(0,0,0,.5);
    }
    @media (prefers-color-scheme: dark) {
      body:not(.light-mode) {
        --orange:   #F09050;
        --orange-d: #E8813A;
        --orange-l: #3D2510;
        --blue:     #5A9EC8;
        --blue-l:   #0F2030;
        --green:    #5ABF84;
        --green-l:  #0E2B1A;
        --purple:   #A882D0;
        --purple-l: #1E1030;
        --red:      #E87060;
        --red-l:    #2A1010;
        --gold:     #E0B840;
        --gold-l:   #2A2008;
        --bg:       #0F0F14;
        --card:     #1C1C24;
        --border:   #2E2E3A;
        --text:     #E8E6E0;
        --text-2:   #A8A4A0;
        --text-3:   #6A6868;
        --shadow:   0 2px 8px rgba(0,0,0,.3);
        --shadow-m: 0 4px 20px rgba(0,0,0,.5);
      }
    }
    html, body { height: 100%; font-family: var(--font); background: var(--bg); color: var(--text); font-size: 16px; overflow-x: hidden; }
    @media (min-width: 768px) {
      html { font-size: 18px; }
      .tab-panel { padding: 22px !important; }
      .nav-tab { font-size: .88rem; padding: 10px 14px; }
      .header-title { font-size: 1.25rem !important; }
      .header-stat { font-size: .88rem !important; }
      .section-title { font-size: 1.15rem !important; }
    }

    /* â”€â”€ UTILITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hidden   { display: none !important; }
    .flex     { display: flex; }
    .flex-col { display: flex; flex-direction: column; }
    .items-center { align-items: center; }
    .justify-center { justify-content: center; }
    .justify-between { justify-content: space-between; }
    .gap-1  { gap: 6px; }
    .gap-2  { gap: 12px; }
    .gap-3  { gap: 18px; }
    .gap-4  { gap: 24px; }
    .w-full { width: 100%; }
    .text-sm { font-size: .85rem; }
    .text-xs { font-size: .75rem; }
    .font-bold { font-weight: 700; }
    .rounded { border-radius: var(--radius); }
    .rounded-s { border-radius: var(--radius-s); }

    /* â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-screen {
      position: fixed; inset: 0; z-index: 1000;
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(145deg, #1a3a5c 0%, #2C5F8A 40%, #E8813A 100%);
      overflow: hidden;
    }
    #login-screen::before {
      content: '';
      position: absolute; inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.04'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
    }
    .login-card {
      position: relative;
      background: rgba(255,255,255,.97);
      border-radius: 20px;
      padding: 48px 40px;
      width: 420px;
      box-shadow: 0 24px 60px rgba(0,0,0,.3);
      text-align: center;
    }
    .login-rv-icon {
      font-size: 3.5rem;
      margin-bottom: 8px;
      display: block;
    }
    .login-title {
      font-size: 1.6rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }
    .login-sub {
      color: var(--text-2);
      font-size: .95rem;
      margin-bottom: 32px;
    }
    .login-dates {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--orange-l);
      border: 1px solid #f0c89e;
      border-radius: 30px;
      padding: 6px 16px;
      font-size: .85rem;
      font-weight: 600;
      color: var(--orange-d);
      margin-bottom: 28px;
    }
    .login-form { text-align: left; }
    .login-label {
      display: block;
      font-size: .8rem;
      font-weight: 600;
      color: var(--text-2);
      letter-spacing: .05em;
      text-transform: uppercase;
      margin-bottom: 6px;
    }
    .login-input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: var(--radius-s);
      font-size: 1rem;
      font-family: var(--font);
      color: var(--text);
      background: var(--bg);
      transition: border-color .2s;
      outline: none;
    }
    .login-input:focus { border-color: var(--orange); }
    .login-error {
      color: var(--red);
      font-size: .85rem;
      margin-top: 8px;
      min-height: 20px;
    }
    .login-btn {
      width: 100%;
      margin-top: 20px;
      padding: 14px;
      background: var(--orange);
      color: #fff;
      border: none;
      border-radius: var(--radius-s);
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: background .2s, transform .1s;
      font-family: var(--font);
    }
    .login-btn:hover  { background: var(--orange-d); }
    .login-btn:active { transform: scale(.98); }
    .login-family {
      margin-top: 24px;
      display: flex;
      justify-content: center;
      gap: 16px;
    }
    .family-avatar {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
    }
    .avatar-circle {
      width: 44px; height: 44px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; font-weight: 800; color: #fff;
    }
    .avatar-name { font-size: .72rem; color: var(--text-2); font-weight: 600; }
    .login-profile-btn {
      cursor: pointer;
      background: none;
      border: 3px solid transparent;
      border-radius: 50%;
      padding: 2px;
      transition: border-color .2s, transform .15s;
      display: block;
    }
    .login-profile-btn.selected {
      border-color: var(--orange, #E8813A);
      transform: scale(1.1);
    }
    .login-profile-btn.selected .avatar-circle {
      box-shadow: 0 0 0 4px rgba(232,129,58,.25);
    }

    /* â”€â”€ APP SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; width: 100%; max-width: 100vw; box-sizing: border-box; overflow-x: hidden; padding-left: env(safe-area-inset-left); padding-right: env(safe-area-inset-right); }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app-header {
      background: var(--blue);
      color: #fff;
      padding: env(safe-area-inset-top) 24px 0;
      height: auto;
      min-height: 62px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      box-shadow: 0 2px 12px rgba(0,0,0,.2);
      z-index: 100;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-logo { font-size: 1.5rem; }
    .header-title { font-size: 1.1rem; font-weight: 800; letter-spacing: -.01em; }
    .header-title span { color: var(--orange); }
    .header-right { display: flex; align-items: center; gap: 16px; }
    .header-stat {
      display: flex; align-items: center; gap: 6px;
      font-size: .8rem; color: rgba(255,255,255,.75);
    }
    .header-stat strong { color: #fff; font-size: .9rem; }
    .header-stat i { color: var(--orange); font-size: .85rem; }
    .progress-pill {
      background: rgba(255,255,255,.12);
      border-radius: 30px;
      padding: 4px 12px;
      font-size: .8rem;
      display: flex; align-items: center; gap: 8px;
    }
    .progress-bar-mini {
      width: 80px; height: 6px;
      background: rgba(255,255,255,.2);
      border-radius: 3px; overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%; background: var(--orange);
      border-radius: 3px; transition: width .5s;
    }
    .logout-btn {
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.2);
      color: #fff;
      width: 34px; height: 34px;
      padding: 0;
      border-radius: 50%;
      font-size: .95rem;
      cursor: pointer;
      transition: background .2s;
      font-family: var(--font);
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .logout-btn:hover { background: rgba(255,255,255,.28); }

    /* â”€â”€ NAV TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app-nav {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      display: flex;
      padding: 0 8px;
      flex-shrink: 0;
      overflow-x: auto;
    }
    .nav-tab {
      display: flex; align-items: center; gap: 0;
      padding: 14px 16px;
      font-size: 0; /* icons-only on all screen sizes */
      font-weight: 600;
      color: var(--text-2);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      transition: color .2s, border-color .2s;
      border: none; background: none;
      font-family: var(--font);
    }
    .nav-tab:hover { color: var(--text); }
    .nav-tab.active { color: var(--orange); border-bottom-color: var(--orange); }
    .nav-tab i { font-size: 1.05rem; }

    /* â”€â”€ MAIN CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app-main {
      flex: 1; overflow: hidden;
      position: relative;
    }
    .tab-panel {
      position: absolute; inset: 0;
      overflow-y: auto;
      padding: var(--sp-6);  /* 24px â€” on the 8pt grid */
      display: none;
    }
    .tab-panel.active { display: block; }

    /* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background: var(--card);
      border-radius: var(--radius);
      border: none;
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card-header {
      padding: var(--sp-4) var(--sp-5);  /* 16px 20px */
      border-bottom: none;
      display: flex; align-items: center; justify-content: space-between;
    }
    .card-title {
      font-size: var(--fs-h2); font-weight: 700;
      display: flex; align-items: center; gap: var(--sp-2);
    }
    .card-title i { color: var(--orange); }
    .card-body { padding: var(--sp-5); }  /* 20px */

    /* â”€â”€ BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .badge {
      display: inline-flex; align-items: center; gap: var(--sp-1);
      padding: var(--sp-1) var(--sp-2); border-radius: 100px;
      font-size: var(--fs-caption); font-weight: 700;
      letter-spacing: .03em; text-transform: uppercase;
    }
    .badge-orange  { background: var(--orange-l); color: var(--orange-d); }
    .badge-blue    { background: var(--blue-l);   color: var(--blue); }
    .badge-green   { background: var(--green-l);  color: var(--green); }
    .badge-purple  { background: var(--purple-l); color: var(--purple); }
    .badge-red     { background: var(--red-l);    color: var(--red); }
    .badge-gold    { background: var(--gold-l);   color: var(--gold); }

    /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display: inline-flex; align-items: center; gap: var(--sp-2);  /* 8px */
      padding: var(--sp-2) var(--sp-4); border-radius: 100px;  /* 8px 16px */
      font-size: .875rem; font-weight: 600;
      cursor: pointer; border: none; font-family: var(--font);
      transition: opacity .15s, transform .1s;
    }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: var(--orange); color: #fff; }
    .btn-primary:hover { background: var(--orange-d); }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-blue { background: var(--blue); color: #fff; }
    .btn-blue:hover { opacity: .88; }
    .btn-ghost { background: transparent; color: var(--text-2); }
    .btn-ghost:hover { background: var(--bg); color: var(--text); }
    .btn-sm { padding: var(--sp-1) var(--sp-3); font-size: .8rem; }  /* 4px 12px */
    .btn-icon { padding: var(--sp-2); border-radius: 50%; }  /* 8px */

    /* â”€â”€ FORM ELEMENTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 9px 12px;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-s);
      font-size: .875rem;
      font-family: var(--font);
      color: var(--text);
      background: var(--card);
      outline: none;
      transition: border-color .2s;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: var(--orange);
    }
    .form-textarea { resize: vertical; min-height: 80px; }
    .form-label {
      display: block;
      font-size: .8rem; font-weight: 600;
      color: var(--text-2); margin-bottom: 5px;
    }
    .form-group { margin-bottom: 14px; }

    /* â”€â”€ DIVIDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .divider {
      border: none; border-top: 1px solid var(--border);
      margin: 16px 0;
    }

    /* â”€â”€ SECTION TITLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-title {
      font-size: var(--fs-h1); font-weight: 800;
      color: var(--text); margin-bottom: var(--sp-4);
      display: flex; align-items: center; gap: var(--sp-2);
    }
    .section-title i { color: var(--orange); }

    /* â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: var(--sp-4); }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--sp-4); }
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--sp-4); }

    /* â”€â”€ STAT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: var(--sp-4) var(--sp-5);  /* 16px 20px */
      display: flex; flex-direction: column; gap: var(--sp-1);
    }
    .stat-label { font-size: var(--fs-caption); font-weight: 600; color: var(--text-2); text-transform: uppercase; letter-spacing: .04em; }
    .stat-value { font-size: var(--fs-display); font-weight: 800; color: var(--text); line-height: 1; }
    .stat-sub { font-size: var(--fs-caption); color: var(--text-3); }
    .stat-icon { font-size: 1.1rem; margin-bottom: 6px; color: var(--orange); }

    /* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-3); }

    /* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #toast {
      position: fixed; bottom: 24px; right: 24px;
      background: var(--text); color: #fff;
      padding: 12px 20px; border-radius: var(--radius-s);
      font-size: .875rem; font-weight: 500;
      box-shadow: var(--shadow-m);
      z-index: 9999;
      transform: translateY(80px); opacity: 0;
      transition: transform .3s, opacity .3s;
    }
    #toast.show { transform: translateY(0); opacity: 1; }

    /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.45);
      z-index: 500;
      display: flex; align-items: flex-start; justify-content: center;
      padding: var(--sp-6);          /* 24px breathing room on all sides */
      overflow-y: auto;
    }
    .modal {
      background: var(--card);
      border-radius: 20px;           /* slightly softer corners */
      width: 600px; max-width: 100%;
      box-shadow: var(--shadow-m);
      margin: auto;                  /* vertical centering within scroll */
    }
    .modal-header {
      padding: var(--sp-6) var(--sp-6) var(--sp-4);  /* 24px 24px 16px */
      border-bottom: none;           /* remove divider â€” use whitespace */
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; background: var(--card); z-index: 1;
      border-radius: 20px 20px 0 0;
    }
    .modal-title { font-size: var(--fs-h1); font-weight: 700; }
    .modal-close {
      background: var(--bg); border: none;
      width: 36px; height: 36px; border-radius: 50%;  /* bigger tap target */
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; color: var(--text-2); font-size: 1rem;
      transition: background .2s; flex-shrink: 0;
    }
    .modal-close:hover { background: var(--border); }
    .modal-body { padding: var(--sp-4) var(--sp-6) var(--sp-6); }  /* 16px 24px 24px */
    .modal-footer {
      padding: var(--sp-4) var(--sp-6) var(--sp-6);  /* 16px 24px 24px */
      border-top: none;              /* remove divider â€” buttons float */
      display: flex; justify-content: flex-end; gap: var(--sp-2);
    }

    /* â”€â”€ PLACEHOLDER TAB MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .coming-soon {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 60vh; gap: 12px;
      color: var(--text-3); text-align: center;
    }
    .coming-soon i { font-size: 3rem; }
    .coming-soon h3 { font-size: 1.1rem; color: var(--text-2); }
    .coming-soon p { font-size: .875rem; max-width: 320px; line-height: 1.5; }

    /* â”€â”€ STOP CARD GRID LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sc-header {
      display: flex; align-items: stretch; cursor: pointer;
    }
    .sc-emoji-col {
      flex-shrink: 0; min-width: 54px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 7px 6px; gap: 3px;
    }
    .sc-name-col {
      flex: 1; min-width: 0; padding: 10px 14px;
    }
    /* Col-label/value shared styles */
    .sc-col-label {
      font-size: .62rem; font-weight: 700;
      color: var(--text-3); text-transform: uppercase;
      letter-spacing: .04em; margin-top: 2px; line-height: 1.2;
    }
    .sc-col-value {
      font-size: .92rem; font-weight: 800; color: var(--text); line-height: 1.2;
    }
    /* These cols hidden on mobile â€” shown on wider screens */
    .sc-chevron-col {
      display: flex; align-items: center;
      padding: 0 14px 0 6px;
      font-size: .75rem; color: var(--text-3); flex-shrink: 0;
    }
    .sc-fcst-col {
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; padding: 0 10px;
    }
    /* Inline subtitle always visible */
    .sc-mobile-meta { display: block; margin-top: 2px; }

    /* â”€â”€ RESPONSIVE â€” tablet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 768px) {
      .tab-panel { padding: 16px; }
      .grid-4 { grid-template-columns: 1fr 1fr; }
      .grid-3 { grid-template-columns: 1fr; }
      #app-header { padding: env(safe-area-inset-top) 14px 0; }
      .header-stat { display: none; }
      .card-body { padding: 16px; }
    }

    /* â”€â”€ RESPONSIVE â€” iPad/tablet (641â€“1024px): compact nav â”€â”€â”€â”€â”€â”€â”€ */
    @media (min-width: 641px) and (max-width: 1024px) {
      /* Icon-only nav: text hidden so all tabs fit without overflow */
      .nav-tab { padding: 10px 12px; font-size: 0; gap: 0; }
      .nav-tab i { font-size: 1.1rem; }
      .nav-tab.active { border-bottom-color: var(--orange); }
      /* Tablet: wider tab panels */
      .tab-panel { padding: 24px 28px !important; }
    }

    /* â”€â”€ RESPONSIVE â€” Desktop / Laptop (â‰¥1025px): sidebar nav â”€â”€â”€â”€â”€â”€ */
    @media (min-width: 1025px) {
      /* â”€â”€ App shell: CSS grid â€” sidebar left, header+content right â”€â”€ */
      #app {
        display: grid;
        grid-template-columns: 210px 1fr;
        grid-template-rows: auto 1fr;
        grid-template-areas:
          "sidebar header"
          "sidebar main";
        height: 100vh; height: 100dvh;
      }
      #app-header { grid-area: header; box-shadow: none; border-bottom: 1px solid rgba(255,255,255,.12); }
      #app-nav    { grid-area: sidebar; }
      #app-main   { grid-area: main; }

      /* â”€â”€ Sidebar nav â”€â”€ */
      #app-nav {
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        padding: 20px 10px 16px;
        gap: 2px;
        overflow-x: hidden;
        overflow-y: auto;
        border-bottom: none;
        border-right: 1px solid var(--border);
        background: var(--card);
        height: 100%;
      }
      #sidebar-brand { display: block !important; }

      /* Nav item: row layout with icon + label */
      .nav-tab {
        flex-direction: row;
        justify-content: flex-start;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 9px 14px;
        font-size: .82rem;     /* show labels */
        font-weight: 600;
        border-bottom: none;
        border-left: 3px solid transparent;
        border-radius: 9px;
        text-align: left;
        white-space: nowrap;
        overflow: hidden;
        color: var(--text-2);
        min-height: unset;
      }
      .nav-tab i {
        font-size: .9rem;
        width: 18px;
        text-align: center;
        flex-shrink: 0;
      }
      .nav-tab:hover { background: var(--bg); color: var(--text); }
      .nav-tab.active {
        border-bottom: none;
        border-left-color: var(--orange);
        border-bottom-color: transparent;
        background: var(--orange-l);
        color: var(--orange);
      }
      .nav-tab.active:hover { background: var(--orange-l); }

      /* Dot badges: reposition for row layout */
      #whatsnew-dot, #tools-new-dot, #ideas-new-dot {
        top: 6px !important; right: 6px !important;
      }

      /* Labels are now inline â€” tooltip only shows on mobile */
      #nav-tooltip { display: none !important; }

      /* â”€â”€ Content panels: wider, breathing room â”€â”€ */
      .tab-panel { padding: 32px 40px !important; }

      /* â”€â”€ Grids: more columns on desktop â”€â”€ */
      .grid-4 { grid-template-columns: repeat(4, 1fr) !important; }
      .grid-3 { grid-template-columns: repeat(3, 1fr) !important; }

      /* â”€â”€ Modals: slightly wider â”€â”€ */
      .modal { max-width: 680px; }

      /* â”€â”€ Stat cards: tighter minimum so all 8 fit one row â”€â”€ */
      #tab-dashboard .stat-card,
      [id^="tab-"] .stat-card { min-width: 0; }
    }

    /* â”€â”€ RESPONSIVE â€” Wide desktop (â‰¥1400px): even more breathing room â”€â”€ */
    @media (min-width: 1400px) {
      #app { grid-template-columns: 230px 1fr; }
      .tab-panel { padding: 36px 52px !important; }
    }

    /* â”€â”€ RESPONSIVE â€” mobile phone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 640px) {
      /* Prevent iOS input-focus zoom (needs font-size â‰¥ 16px) */
      input, textarea, select { font-size: 16px !important; touch-action: manipulation; }

      /* Better tap response everywhere */
      button, a, .nav-tab, label {
        -webkit-tap-highlight-color: rgba(0,0,0,.07);
        touch-action: manipulation;
      }

      /* â”€â”€ App shell: flex order so nav sits at bottom in-flow â”€â”€â”€â”€â”€ */
      /* Using order instead of position:fixed â€” far more reliable on iOS */
      #app { display: flex; flex-direction: column; }
      #app-header { order: 1; }
      #app-main   { order: 2; flex: 1; min-height: 0; }
      #app-nav    { order: 3; flex-shrink: 0; }

      /* â”€â”€ Header: tight compact bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #app-header {
        height: auto;
        min-height: 52px;
        padding: env(safe-area-inset-top) 10px 0;   /* full override for mobile */
      }
      .header-logo { font-size: 1.2rem; }
      .progress-pill { display: none; }
      #sync-status { display: none !important; }
      .logout-btn { width: 30px; height: 30px; font-size: .85rem; }
      #tg-btn { padding: 6px 9px; font-size: .72rem; gap: 4px; border-radius: 100px; }
      .tg-btn-label { display: none; }
      .plan-trip-label { display: none; }
      #plan-trip-btn { padding: 6px 9px; }
      .change-plan-label { display: none; }
      #change-plan-btn { padding: 6px 9px; }
      .header-right { gap: 8px; }
      .header-left { gap: 6px; }

      /* â”€â”€ Nav: bottom bar, in-flow (reliable iOS sticky) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #app-nav {
        position: static;           /* stays in flex flow â€” no iOS fixed glitches */
        border-bottom: none;
        border-top: 1px solid var(--border);
        padding: 0 0 env(safe-area-inset-bottom);
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
        box-shadow: 0 -2px 14px rgba(0,0,0,.08);
        justify-content: flex-start;
        align-items: stretch;
        background: var(--card);
        z-index: 200;
      }
      #app-nav::-webkit-scrollbar { display: none; }

      .nav-tab {
        flex-direction: column;
        gap: 1px;
        padding: 7px 10px 5px;
        font-size: .58rem;
        font-weight: 700;
        min-width: 56px;
        min-height: 50px;
        border-bottom: none;
        border-top: 2.5px solid transparent;
        align-items: center;
        justify-content: center;
        letter-spacing: .01em;
        position: relative;   /* for adj-badge absolute positioning */
      }
      .nav-tab i { font-size: 1.1rem; margin-bottom: 1px; }
      .nav-tab.active {
        border-bottom: none;
        border-top-color: var(--orange);
        color: var(--orange);
        background: var(--orange-l);
      }

      /* â”€â”€ Adjustments badge: top-right corner of tab, not below â”€â”€ */
      .adj-badge {
        position: absolute !important;
        top: 4px !important;
        right: 4px !important;
        margin-left: 0 !important;
        vertical-align: unset !important;
        line-height: 1 !important;
      }

      /* â”€â”€ Content: tab-panel fills #app-main exactly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      /* No bottom padding needed since nav is in-flow, not overlapping */
      .tab-panel { padding: 12px !important; }

      /* â”€â”€ Map: fill available height instead of hard-coded 100vh â”€â”€ */
      #tab-map > div { height: 100% !important; min-height: 0 !important; }
      #map-container { min-height: 260px !important; }

      /* â”€â”€ Journal: stack meta fields single-column â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .journal-meta-grid {
        grid-template-columns: 1fr !important;
        gap: 10px !important;
      }
      .journal-photos-grid {
        grid-template-columns: 1fr !important;
      }

      /* â”€â”€ Cards: tighten up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .card-body { padding: var(--sp-3); }      /* 12px */
      .card-header { padding: var(--sp-3) var(--sp-4); }  /* 12px 16px */
      .modal-body { padding: var(--sp-4); }     /* 16px */
      .modal-footer { padding: var(--sp-3) var(--sp-4); } /* 12px 16px */
      .section-title { font-size: 1rem !important; }

      /* â”€â”€ Day detail modal: slide-up sheet on mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #day-detail-modal {
        align-items: flex-end !important;
        padding: 0 !important;
      }
      .ddm-card {
        width: 100% !important;
        border-radius: 20px 20px 0 0 !important;
        max-height: 90dvh;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .ddm-header { border-radius: 20px 20px 0 0 !important; }

      /* â”€â”€ AI info modal: slide-up sheet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #ai-info-modal {
        align-items: flex-end !important;
        padding: 0 !important;
      }
      .aim-card {
        width: 100% !important;
        border-radius: 20px 20px 0 0 !important;
        max-height: 88dvh;
        padding-bottom: env(safe-area-inset-bottom);
      }
      .aim-header { border-radius: 20px 20px 0 0 !important; }

      /* â”€â”€ TripGenie: safe area padding â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #tg-head { padding-top: calc(14px + env(safe-area-inset-top)); }
      #tg-foot { padding-bottom: calc(10px + env(safe-area-inset-bottom)); }

      /* â”€â”€ Test mode banner: safe area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #test-mode-banner { padding-top: calc(8px + env(safe-area-inset-top)); }

      /* â”€â”€ Schedule card grid: 2-col on small phones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .day-stat-grid { grid-template-columns: 1fr 1fr !important; }
    }

    /* â”€â”€ DAY DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #day-detail-modal {
      position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:900;
      display:flex;align-items:flex-start;justify-content:center;
      padding:16px;overflow-y:auto;
    }
    .ddm-card {
      background:var(--card);border-radius:16px;width:min(98vw,490px);
      max-height:calc(100vh - 32px);overflow-y:auto;
      box-shadow:0 8px 40px rgba(0,0,0,.28);
    }
    .ddm-header {
      background:linear-gradient(135deg,var(--orange),#b85a20);color:#fff;
      padding:16px 20px;border-radius:16px 16px 0 0;
      position:sticky;top:0;z-index:10;
    }
    /* â”€â”€ LOCAL MUSIC PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #music-modal {
      position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:2000;
      display:flex;align-items:flex-end;justify-content:center;
    }
    #music-modal.hidden { display:none; }
    .music-card {
      background:var(--card);border-radius:20px 20px 0 0;
      width:100%;max-width:520px;max-height:88vh;
      overflow-y:auto;
      box-shadow:0 -4px 40px rgba(0,0,0,.3);
    }
    .music-header {
      background:linear-gradient(135deg,#1DB954,#158a3e);
      color:#fff;padding:16px 20px;border-radius:20px 20px 0 0;
      position:sticky;top:0;z-index:10;
    }
    .music-artist-card {
      display:flex;align-items:center;gap:12px;padding:12px 16px;
      border-bottom:1px solid var(--border);cursor:pointer;
      transition:background .15s;text-decoration:none;color:inherit;
    }
    .music-artist-card:hover, .music-artist-card:active { background:var(--bg); }
    .music-artist-icon {
      width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#1DB954,#158a3e);
      display:flex;align-items:center;justify-content:center;
      font-size:1.2rem;flex-shrink:0;
    }
    /* Game modal: add padding around injected game content */
    #day-detail-modal[data-mode="game"] #ddm-blocks { padding: 16px; }

    .tbb-row {
      display:flex;gap:10px;padding:12px 16px;
      border-bottom:1px solid var(--border);align-items:flex-start;
      transition:opacity .15s, border-top .1s;
    }
    .tbb-row:last-child { border-bottom:none; }
    .tbb-row.tbb-dragging { opacity:.35; }
    .tbb-row.tbb-drag-over { border-top:2.5px solid var(--orange) !important; }
    .tbb-row[data-editable]:active { background:var(--orange-l); }
    /* Drag handle */
    .tbb-drag { display:flex;align-items:center;padding:0 4px 0 0;color:var(--border);font-size:1.1rem;cursor:grab;touch-action:none;flex-shrink:0;user-select:none;letter-spacing:1px; }
    .tbb-drag:hover { color:var(--text-3); }
    /* Drive time micro-separator */
    .dtb-drive-sep { display:flex;align-items:center;gap:6px;padding:3px 16px;font-size:.66rem;font-weight:700;color:var(--text-3);pointer-events:none; }
    .dtb-drive-sep::before, .dtb-drive-sep::after { content:'';flex:1;height:1px;background:var(--border);opacity:.6; }
    /* Duration picker buttons */
    .iem-dur-btn { background:var(--bg);border:1.5px solid var(--border);border-radius:100px;padding:6px 12px;font-size:.78rem;font-family:var(--font);cursor:pointer;color:var(--text-2);transition:all .15s; }
    .iem-dur-btn.active { background:var(--orange);color:#fff;border-color:var(--orange); }
    .tbb-time { min-width:64px;font-size:.69rem;font-weight:800;color:var(--text-3);padding-top:3px;line-height:1.3; }
    .tbb-icon { font-size:1.25rem;min-width:26px;text-align:center;flex-shrink:0; }
    .tbb-content { flex:1;min-width:0; }
    .tbb-title { font-weight:700;font-size:.87rem;color:var(--text);line-height:1.4; }
    .tbb-sub { font-size:.74rem;color:var(--text-2);margin-top:2px;line-height:1.4; }
    .tbb-tags { margin-top:5px;display:flex;flex-wrap:wrap;gap:4px; }
    .tbb-tag { display:inline-block;font-size:.61rem;font-weight:800;padding:2px 7px;border-radius:100px; }
    .tbb-drive   { background:#FEF3E2;color:#b07020; }
    .tbb-eat     { background:#FFF3E0;color:#d05810; }
    .tbb-explore { background:#E3F2FD;color:#1565C0; }
    .tbb-planned { background:#E8F5E9;color:#2E7D32; }
    .ai-info-btn {
      font-size:.61rem;font-weight:800;padding:2px 8px;border-radius:100px;
      background:#F3E8FF;color:#7B5EA7;border:1px solid #D0B4F0;
      cursor:pointer;font-family:var(--font);white-space:nowrap;
    }
    .ai-info-btn:hover { background:#E8D4FF; }
    /* â”€â”€ AI INFO MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #ai-info-modal {
      position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:1000;
      display:flex;align-items:center;justify-content:center;
      padding:16px;
      /* NO overflow-y here â€” only .aim-card scrolls, keeps header sticky */
    }
    .aim-card {
      background:var(--card);border-radius:16px;width:min(98vw,530px);
      max-height:calc(100dvh - 32px);overflow-y:auto;
      box-shadow:0 8px 40px rgba(0,0,0,.32);
    }
    .aim-header {
      background:linear-gradient(135deg,#7B5EA7,#5a3d8a);color:#fff;
      padding:16px 20px;border-radius:16px 16px 0 0;
      position:sticky;top:0;z-index:10;
    }
    .aim-body { padding:16px 20px;font-size:.88rem;line-height:1.65;color:var(--text); }
    .aim-body p { margin:0 0 12px; }
    .aim-body strong { font-weight:800;color:var(--text); }
    #aim-photo-strip::-webkit-scrollbar { display:none; }
    #aim-facts-strip { border-top:1px solid var(--border); background:var(--card); }
    /* schedule card tap hint */
    .sched-tap { cursor:pointer; }
    .sched-tap:hover .sched-mid { background:rgba(0,0,0,.02); }

    /* â”€â”€ WEATHER CHIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .wx-chip {
      display:inline-flex;align-items:center;gap:3px;
      font-size:.69rem;font-weight:700;padding:2px 7px;border-radius:100px;
      white-space:nowrap;
    }
    .wx-forecast { background:#E3F2FD;color:#1565C0;border:1px solid #90CAF9; }
    .wx-typical  { background:#F3F3F0;color:#777;border:1px solid #ddd; }
    .wx-loading  { background:#F5F5F5;color:#aaa;border:1px solid #eee;animation:wxpulse 1.4s infinite; }
    @keyframes wxpulse { 0%,100%{opacity:.5} 50%{opacity:1} }

    /* â”€â”€ POSTCARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .pc-step-label {
      font-size:.72rem;font-weight:800;color:var(--text-3);text-transform:uppercase;
      letter-spacing:.06em;margin:16px 0 7px;display:flex;align-items:center;gap:6px;
    }
    .pc-step-num {
      width:20px;height:20px;border-radius:50%;background:var(--orange);color:#fff;
      font-size:.68rem;font-weight:900;display:inline-flex;align-items:center;justify-content:center;
    }
    .pc-photo-thumb {
      width:72px;height:72px;object-fit:cover;border-radius:8px;border:3px solid transparent;
      cursor:pointer;transition:border-color .15s,transform .15s;flex-shrink:0;
    }
    .pc-photo-thumb.selected {
      border-color:var(--orange);transform:scale(1.05);box-shadow:0 2px 8px rgba(232,129,58,.4);
    }
    .pc-photo-thumb.selected::after { content:'âœ“'; }
    .pc-preview-wrap {
      border-radius:12px;overflow:hidden;box-shadow:0 6px 30px rgba(0,0,0,.22);
      background:#fff;margin:0 auto;
    }
    .pc-share-btn {
      display:flex;align-items:center;justify-content:center;gap:8px;
      padding:14px 20px;border:none;border-radius:100px;font-size:1rem;
      font-weight:800;cursor:pointer;font-family:var(--font);flex:1;min-width:120px;
    }
    @keyframes pcpulse { 0%,100%{opacity:.7} 50%{opacity:1} }
    .pc-generating { animation:pcpulse 1.3s infinite; }

    /* â”€â”€ SWIPE-TO-DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .swipe-row { position:relative;overflow:hidden;border-radius:8px;margin-bottom:5px; }
    .swipe-trash {
      position:absolute;right:0;top:0;bottom:0;width:72px;
      background:var(--red);display:flex;align-items:center;justify-content:center;
      border-radius:0 8px 8px 0;pointer-events:none;opacity:0;transition:opacity .12s;
    }
    .swipe-trash.visible { pointer-events:auto;opacity:1; }
    .swipe-content { display:block;position:relative;transition:transform .15s;will-change:transform; }
    .swipe-content.swiped { transform:translateX(-72px) !important; }

    /* â”€â”€ FUN / TOOLS SUB-TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-sub-bar {
      display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;
      padding-bottom:14px;border-bottom:1.5px solid var(--border);
    }
    .section-sub-btn {
      background:var(--bg);color:var(--text-2);
      border:1.5px solid var(--border);border-radius:20px;
      padding:7px 16px;font-size:.8rem;font-weight:700;
      cursor:pointer;font-family:var(--font);transition:all .15s;
      display:flex;align-items:center;gap:6px;
    }
    .section-sub-btn.active {
      background:var(--blue);color:#fff;border-color:var(--blue);
    }
    /* â”€â”€ STATE BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .state-badge {
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      border-radius:100px;padding:8px 4px 6px;cursor:pointer;
      transition:transform .12s,box-shadow .12s;border:2px solid transparent;
      min-width:54px;gap:2px;user-select:none;
    }
    .state-badge:hover { transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.15); }
    .state-badge.visited {
      background:var(--green-l);border-color:var(--green);
    }
    .state-badge.on-route {
      background:var(--blue-l);border-color:var(--blue);
    }
    .state-badge.unvisited {
      background:#f5f5f2;border-color:#e0e0d8;
    }
    .state-abbr { font-size:.95rem;font-weight:900;line-height:1; }
    .state-name { font-size:.52rem;font-weight:600;text-align:center;line-height:1.2; }
    /* â”€â”€ TRIVIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .trivia-card {
      background:var(--card);border:1.5px solid var(--border);
      border-radius:var(--radius);padding:16px 18px;margin-bottom:12px;
    }
    .trivia-q { font-weight:700;font-size:.92rem;color:var(--text);margin-bottom:10px;line-height:1.5; }
    .trivia-opt {
      display:block;width:100%;text-align:left;padding:9px 14px;margin-bottom:6px;
      background:var(--bg);border:1.5px solid var(--border);border-radius:8px;
      font-size:.85rem;font-family:var(--font);cursor:pointer;transition:all .15s;
      color:var(--text);font-weight:500;
    }
    .trivia-opt:hover { background:var(--blue-l);border-color:var(--blue); }
    .trivia-opt.correct { background:#e8f5e9;border-color:var(--green);color:var(--green);font-weight:700; }
    .trivia-opt.wrong   { background:#ffebee;border-color:var(--red);color:var(--red); }
    /* â”€â”€ EXPENSE TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .exp-cat-btn {
      border-radius:100px;padding:6px 13px;font-size:.78rem;font-weight:700;
      cursor:pointer;font-family:var(--font);border:1.5px solid var(--border);
      background:var(--bg);color:var(--text-2);transition:all .12s;white-space:nowrap;
    }
    .exp-cat-btn.sel { color:#fff; }
    /* â”€â”€ TRIPGENIE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #tg-btn {
      display:flex;align-items:center;gap:7px;
      background:linear-gradient(135deg,var(--orange) 0%,var(--orange-d) 100%);
      color:#fff;border:none;border-radius:100px;
      padding:7px 15px;font-size:.8rem;font-weight:800;
      cursor:pointer;font-family:var(--font);white-space:nowrap;
      box-shadow:0 2px 10px rgba(232,129,58,.4);
      transition:transform .15s,box-shadow .15s;
      flex-shrink:0;
    }
    #tg-btn:hover { transform:translateY(-1px);box-shadow:0 4px 16px rgba(232,129,58,.5); }
    #tg-btn:active { transform:translateY(0); }
    #tg-drawer {
      position:fixed;inset:0;z-index:5000;display:flex;flex-direction:column;
      background:#fff;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
    }
    #tg-drawer.open { transform:translateY(0); }
    #tg-head {
      background:linear-gradient(135deg,var(--blue) 0%,#1a3a5c 100%);
      color:#fff;padding:14px 18px;display:flex;align-items:center;gap:12px;
      flex-shrink:0;box-shadow:0 2px 12px rgba(0,0,0,.2);
    }
    #tg-history {
      flex:1;overflow-y:auto;padding:16px;
      display:flex;flex-direction:column;gap:12px;
      background:linear-gradient(180deg,var(--blue-l) 0%,var(--card) 100%);
    }
    .tg-bubble-user {
      align-self:flex-end;max-width:82%;
      background:linear-gradient(135deg,var(--orange),var(--orange-d));
      color:#fff;border-radius:18px 18px 4px 18px;
      padding:10px 14px;font-size:var(--fs-body);line-height:1.55;
      box-shadow:0 2px 8px rgba(232,129,58,.25);
    }
    .tg-bubble-genie {
      align-self:flex-start;max-width:88%;
      background:#fff;color:var(--text);
      border:1.5px solid var(--border);border-radius:18px 18px 18px 4px;
      padding:10px 14px;font-size:var(--fs-body);line-height:1.6;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    .tg-bubble-genie strong { color:var(--blue); }
    .tg-photo-prev {
      width:60px;height:60px;object-fit:cover;border-radius:10px;
      border:2px solid rgba(255,255,255,.5);margin-bottom:6px;display:block;
    }
    #tg-foot {
      padding:12px 14px;background:#fff;
      border-top:1.5px solid var(--border);flex-shrink:0;
      display:flex;flex-direction:column;gap:8px;
    }
    #tg-photo-strip {
      display:flex;align-items:center;gap:8px;
      display:none; /* shown via JS when photo attached */
    }
    #tg-photo-thumb {
      width:48px;height:48px;object-fit:cover;border-radius:8px;
      border:2px solid var(--border);
    }
    #tg-input-row { display:flex;align-items:flex-end;gap:8px; }
    #tg-input {
      flex:1;border:1.5px solid var(--border);border-radius:14px;
      padding:10px 14px;font-size:.9rem;font-family:var(--font);
      resize:none;outline:none;min-height:44px;max-height:120px;
      background:var(--bg);color:var(--text);
      transition:border-color .2s;
    }
    #tg-input:focus { border-color:var(--orange); }
    .tg-icon-btn {
      width:44px;height:44px;border-radius:50%;border:none;cursor:pointer;
      display:flex;align-items:center;justify-content:center;font-size:1.15rem;
      flex-shrink:0;transition:transform .15s;font-family:var(--font);
    }
    .tg-icon-btn:active { transform:scale(.93); }
    #tg-photo-btn { background:var(--orange-l);color:var(--orange-d); }
    #tg-send-btn {
      background:var(--orange);
      color:#fff;box-shadow:0 2px 8px rgba(232,129,58,.35);
    }
    @keyframes tg-thinking {
      0%,100% { opacity:.4; }
      50% { opacity:1; }
    }
    .tg-thinking { animation:tg-thinking 1.2s infinite; font-style:italic;color:var(--blue); }

    /* â”€â”€ BORDERLESS DESIGN: shadow-only containment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    [style*="border:1px solid var(--border)"],
    [style*="border: 1px solid var(--border)"] {
      border-color: transparent !important;
      box-shadow: 0 1px 3px rgba(0,0,0,.04), 0 4px 14px rgba(0,0,0,.08) !important;
    }
    [style*="border:1.5px solid var(--border)"],
    [style*="border: 1.5px solid var(--border)"] {
      border-color: transparent !important;
      box-shadow: 0 1px 3px rgba(0,0,0,.04), 0 4px 14px rgba(0,0,0,.09) !important;
    }
    .stat-card {
      border: none !important;
      box-shadow: 0 1px 3px rgba(0,0,0,.04), 0 4px 14px rgba(0,0,0,.08) !important;
    }
    /* Preserve nav separator, form usability borders, and colored accent stripes */
    #app-nav { border-bottom: 1px solid var(--border) !important; }
    input, textarea, select { border: 1.5px solid var(--border) !important; }
    [style*="border-left:3px"], [style*="border-left: 3px"],
    [style*="border-left:4px"], [style*="border-left: 4px"],
    [style*="border-left:6px"], [style*="border-left: 6px"] {
      box-shadow: 0 1px 3px rgba(0,0,0,.04), 0 4px 14px rgba(0,0,0,.08) !important;
    }

    /* â”€â”€ TYPE SCALE NORMALIZER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Inline styles in JS use many similar-but-different font sizes.
       This pulls them all toward the 3-tier scale:
         .85rem / .82rem / .88rem â†’ body (.875rem)
         .78rem / .8rem           â†’ caption (.75rem)
         .68rem / .7rem / .72rem  â†’ caption (.75rem)
       Applied via class selectors on the containers that can be
       targeted without touching thousands of inline style strings.  */
    .card-body,
    .modal-body,
    .tab-panel { font-size: var(--fs-body); }

    /* Caption tier â€” force all badge-size text to the same size */
    .badge,
    .stat-label,
    .stat-sub { font-size: var(--fs-caption); }

    /* Headline tier */
    .card-header .card-title,
    h2.section-title { font-size: var(--fs-h1); }

    /* â”€â”€ COLOR PALETTE: 3-color system â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       Orange = brand accent (actions, active states)
       Blue   = chrome / navigation / informational
       Red    = warnings / decisions / danger
       Purple â†’ retire as brand color; remap TripGenie to blue-toned.
       Gold   â†’ retire; replaced by orange-l tints.               */

    /* TripGenie suggest chips (inline purple #f0e8ff/#7B2FBE) â†’ orange-tinted */
    [style*="background:#f0e8ff"][style*="color:#7B2FBE"],
    [style*="background:#f0e8ff"][style*="color: #7B2FBE"] {
      background: var(--orange-l) !important;
      color: var(--orange-d) !important;
      border-color: rgba(232,129,58,.35) !important;
    }
    /* TripGenie "Open TripGenie Now" and tutorial gradient buttons */
    [style*="background:linear-gradient(135deg,#7B2FBE"],
    [style*="background: linear-gradient(135deg, #7B2FBE"],
    [style*="background:linear-gradient(135deg,#5b1fa3"] {
      background: linear-gradient(135deg, var(--orange), var(--orange-d)) !important;
      box-shadow: 0 2px 8px rgba(232,129,58,.3) !important;
    }
    /* Trip variance / pause genie purple section */
    [style*="background:linear-gradient(135deg,#f3e5f5"] {
      background: var(--orange-l) !important;
      border-color: rgba(232,129,58,.4) !important;
      border-left-color: var(--orange) !important;
    }
    [style*="color:#7b1fa2"], [style*="color: #7b1fa2"],
    [style*="color:#5b1fa3"], [style*="color: #5b1fa3"] { color: var(--orange-d) !important; }
    [style*="background:#9c27b0"], [style*="background: #9c27b0"],
    [style*="background:#ad1457"], [style*="background: #ad1457"],
    [style*="background:#7B2FBE"], [style*="background: #7B2FBE"] {
      background: var(--orange) !important;
    }
    /* Photo attached label */
    [style*="color:#7B2FBE"] { color: var(--orange-d) !important; }

    /* Spring Break badge: purple â†’ orange */
    .badge-purple {
      background: var(--orange-l) !important;
      color: var(--orange-d) !important;
      border: 1px solid rgba(232,129,58,.3) !important;
    }

    /* Gold backgrounds â†’ orange-l tint */
    [style*="--gold-l"],
    [style*="background:#FDF6E3"],
    [style*="background: #FDF6E3"] {
      background: var(--orange-l) !important;
    }
    [style*="color:#D4A017"],
    [style*="color: #D4A017"] { color: var(--orange-d) !important; }

    /* Ideas/suggestion card gold header â†’ orange */
    [style*="background:linear-gradient(135deg,#f9a825"],
    [style*="background: linear-gradient(135deg, #f9a825"] {
      background: linear-gradient(135deg, var(--orange), var(--orange-d)) !important;
    }


/* â”€â”€ Simple Mode Container â”€â”€ */
#sm {
  position: fixed;
  inset: 0;
  z-index: 8000;
  display: none;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: #F8F6F2;
  overflow: hidden;
}
#sm.sm-active { display: block; }

  #sm *, #sm *::before, #sm *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --orange:   #E8813A;
    --orange-d: #C96820;
    --orange-l: #FFF4EC;
    --blue:     #1E4D7B;
    --blue-l:   #EAF2FB;
    --green:    #2E7D52;
    --green-l:  #EAF5EF;
    --red:      #C0392B;
    --red-l:    #FDEDED;
    --bg:       #F8F6F2;
    --card:     #FFFFFF;
    --border:   #E8E4DC;
    --text:     #1A1714;
    --text-2:   #6B6560;
    --text-3:   #A09890;
    --radius:   20px;
    --radius-s: 12px;
    --font:     -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --nav-h:    72px;
    --header-h: 56px;
  }

  #sm, #sm {
    height: 100%;
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    overflow: hidden;
  }

  #sm /* â”€â”€ SHELL â”€â”€ */
  #shell {
    display: flex;
    flex-direction: column;
    height: 100%;
    background: var(--bg);
    position: relative;
    overflow: hidden;
  }

  #sm /* â”€â”€ SIDEBAR BRAND (hidden on mobile) â”€â”€ */
  #sidebar-brand-2 { display: none; }

  #sm /* â”€â”€ RIGHT PANEL (hidden on mobile/tablet) â”€â”€ */
  #right-panel { display: none; }

  #sm /* â”€â”€ HEADER â”€â”€ */
  #top-bar {
    flex-shrink: 0;
    height: var(--header-h);
    background: var(--card);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    padding: 0 20px;
    gap: 12px;
    z-index: 100;
  }
  #sm #back-btn {
    width: 36px; height: 36px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    background: none;
    color: var(--text);
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: .9rem;
    flex-shrink: 0;
  }
  #sm #back-btn.show { display: flex; }
  #sm #top-title {
    flex: 1;
    font-size: .9rem;
    font-weight: 700;
    color: var(--text);
  }
  #sm #top-action {
    font-size: .78rem;
    font-weight: 800;
    color: var(--orange);
    background: none;
    border: none;
    cursor: pointer;
    font-family: var(--font);
    display: none;
  }
  #sm #top-action.show { display: block; }

  #sm /* Progress bar under header */
  #progress-strip {
    flex-shrink: 0;
    height: 3px;
    background: var(--border);
  }
  #sm #progress-fill {
    height: 100%;
    background: var(--orange);
    transition: width .4s ease;
  }

  #sm /* â”€â”€ SCREENS â”€â”€ */
  #screen-area {
    flex: 1;
    position: relative;
    overflow: hidden;
  }
  #sm .screen {
    position: absolute;
    inset: 0;
    overflow-y: auto;
    padding: 24px 20px calc(var(--nav-h) + 16px);
    transform: translateX(100%);
    transition: transform .32s cubic-bezier(.4,0,.2,1);
    will-change: transform;
  }
  #sm .screen.active {
    transform: translateX(0);
  }
  #sm .screen.exit-left {
    transform: translateX(-40%);
  }

  #sm /* â”€â”€ BOTTOM NAV â”€â”€ */
  #bottom-nav {
    flex-shrink: 0;
    height: var(--nav-h);
    background: var(--card);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-around;
    padding: 0 8px;
    padding-bottom: env(safe-area-inset-bottom, 0);
    z-index: 100;
  }
  #sm .nav-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 12px;
    border: none;
    background: none;
    cursor: pointer;
    color: var(--text-3);
    font-family: var(--font);
    border-radius: 12px;
    transition: color .15s, background .15s;
    min-width: 56px;
  }
  #sm .nav-btn i { font-size: 1.2rem; }
  #sm .nav-btn span { font-size: .65rem; font-weight: 700; letter-spacing: .02em; }
  #sm .nav-btn.active { color: var(--orange); }
  #sm .nav-btn:hover { background: var(--orange-l); }
  @media (max-width: 380px) {
    #sm .nav-btn { padding: 6px 6px; min-width: 44px; }
    #sm .nav-btn span { font-size: .58rem; letter-spacing: 0; }
  }
  /* Segmented toggle for combined Schedule+Stops screen */
  .sm-seg-bar {
    display: flex;
    gap: 6px;
    padding: 10px 16px 4px;
    background: var(--bg);
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 1px solid var(--border);
  }
  .sm-seg-btn {
    flex: 1;
    padding: 8px 12px;
    border: 1.5px solid var(--border);
    border-radius: 50px;
    background: var(--card);
    color: var(--text-2);
    font-family: var(--font);
    font-size: .78rem;
    font-weight: 700;
    cursor: pointer;
    transition: all .15s;
    text-align: center;
  }
  .sm-seg-btn.active {
    background: var(--orange);
    border-color: var(--orange);
    color: #fff;
  }

  #sm /* â”€â”€ TYPOGRAPHY â”€â”€ */
  .screen-eyebrow {
    font-size: .72rem;
    font-weight: 800;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--text-3);
    margin-bottom: 6px;
  }
  #sm .screen-title {
    font-size: 2rem;
    font-weight: 900;
    color: var(--text);
    line-height: 1.1;
    margin-bottom: 4px;
  }
  #sm .screen-subtitle {
    font-size: .9rem;
    color: var(--text-2);
    line-height: 1.5;
    margin-bottom: 28px;
  }
  #sm h2.section-head {
    font-size: .72rem;
    font-weight: 800;
    letter-spacing: .08em;
    text-transform: uppercase;
    color: var(--text-3);
    margin: 28px 0 12px;
  }
  #sm h2.section-head:first-child { margin-top: 0; }

  #sm /* â”€â”€ CARDS â”€â”€ */
  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,.04), 0 4px 16px rgba(0,0,0,.07);
  }
  #sm .card-sm {
    background: var(--card);
    border-radius: var(--radius-s);
    padding: 16px;
    margin-bottom: 10px;
    box-shadow: 0 1px 2px rgba(0,0,0,.03), 0 2px 8px rgba(0,0,0,.05);
    cursor: pointer;
    transition: box-shadow .15s, transform .15s;
  }
  #sm .card-sm:hover { box-shadow: 0 2px 6px rgba(0,0,0,.06), 0 8px 24px rgba(0,0,0,.10); transform: translateY(-1px); }
  #sm .card-sm:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,.05); }

  #sm /* Hero card â€” full bleed gradient */
  .hero-card {
    border-radius: var(--radius);
    padding: 24px;
    margin-bottom: 20px;
    position: relative;
    overflow: hidden;
    min-height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    cursor: pointer;
    transition: transform .2s;
  }
  #sm .hero-card:active { transform: scale(.985); }
  #sm .hero-card .hero-bg {
    position: absolute;
    inset: 0;
    background: linear-gradient(160deg, #1E4D7B 0%, #E8813A 100%);
    z-index: 0;
  }
  #sm .hero-card .hero-bg-img {
    position: absolute;
    inset: 0;
    background-size: cover;
    background-position: center;
    z-index: 0;
    opacity: .55;
  }
  #sm .hero-card .hero-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(10,20,40,.75) 0%, rgba(10,20,40,.1) 100%);
    z-index: 1;
  }
  #sm .hero-card * { position: relative; z-index: 2; }
  #sm .hero-card .hero-label {
    font-size: .68rem;
    font-weight: 800;
    letter-spacing: .1em;
    text-transform: uppercase;
    color: rgba(255,255,255,.7);
    margin-bottom: 4px;
  }
  #sm .hero-card .hero-title {
    font-size: 1.55rem;
    font-weight: 900;
    color: #fff;
    line-height: 1.1;
    margin-bottom: 6px;
  }
  #sm .hero-card .hero-sub {
    font-size: .8rem;
    color: rgba(255,255,255,.75);
  }

  #sm /* â”€â”€ PILLS / BADGES â”€â”€ */
  .pill {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 11px;
    border-radius: 100px;
    font-size: .72rem;
    font-weight: 800;
    letter-spacing: .01em;
  }
  #sm .pill-orange { background: var(--orange-l); color: var(--orange-d); }
  #sm .pill-blue { background: var(--blue-l);   color: var(--blue);     }
  #sm .pill-green { background: var(--green-l);  color: var(--green);    }
  #sm .pill-red { background: var(--red-l);    color: var(--red);      }
  #sm .pill-dark { background: rgba(0,0,0,.08); color: var(--text-2);   }

  #sm /* â”€â”€ BUTTONS â”€â”€ */
  .btn-primary {
    width: 100%;
    padding: 17px;
    background: var(--orange);
    color: #fff;
    border: none;
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 800;
    font-family: var(--font);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: background .15s, transform .1s;
    margin-bottom: 10px;
  }
  #sm .btn-primary:hover { background: var(--orange-d); }
  #sm .btn-primary:active { transform: scale(.98); }
  #sm .btn-secondary {
    width: 100%;
    padding: 15px;
    background: var(--card);
    color: var(--text);
    border: 1.5px solid var(--border);
    border-radius: var(--radius);
    font-size: .9rem;
    font-weight: 700;
    font-family: var(--font);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: border-color .15s, background .15s;
    margin-bottom: 10px;
  }
  #sm .btn-secondary:hover { border-color: var(--orange); background: var(--orange-l); }

  #sm /* â”€â”€ STAT ROW â”€â”€ */
  .stat-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 20px;
  }
  #sm .stat-box {
    background: var(--card);
    border-radius: var(--radius-s);
    padding: 14px 10px;
    text-align: center;
    box-shadow: 0 1px 2px rgba(0,0,0,.04), 0 2px 8px rgba(0,0,0,.05);
  }
  #sm .stat-num {
    font-size: 1.5rem;
    font-weight: 900;
    color: var(--text);
    line-height: 1;
    margin-bottom: 4px;
  }
  #sm .stat-lbl {
    font-size: .65rem;
    font-weight: 700;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: .06em;
  }

  #sm /* â”€â”€ LIST ROW â”€â”€ */
  .list-row {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }
  #sm .list-row:last-child { border-bottom: none; }
  #sm .list-row .row-icon {
    width: 40px;
    height: 40px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: .95rem;
    flex-shrink: 0;
  }
  #sm .list-row .row-body { flex: 1; min-width: 0; }
  #sm .list-row .row-title { font-size: .88rem; font-weight: 700; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  #sm .list-row .row-sub { font-size: .75rem; color: var(--text-2); }
  #sm .list-row .row-caret { color: var(--text-3); font-size: .75rem; }

  #sm /* â”€â”€ DIVIDER â”€â”€ */
  .divider { height: 1px; background: var(--border); margin: 4px 0; }

  #sm /* â”€â”€ INPUT â”€â”€ */
  .field { margin-bottom: 20px; }
  #sm .field label { display: block; font-size: .75rem; font-weight: 800; color: var(--text-2); letter-spacing: .04em; text-transform: uppercase; margin-bottom: 8px; }
  #sm .field textarea, #sm .field input {
    width: 100%;
    padding: 14px 16px;
    border: 1.5px solid var(--border);
    border-radius: var(--radius-s);
    font-size: .92rem;
    font-family: var(--font);
    color: var(--text);
    background: var(--card);
    outline: none;
    resize: vertical;
    transition: border-color .15s;
  }
  #sm .field textarea:focus, #sm .field input:focus { border-color: var(--orange); }

  #sm /* â”€â”€ TODAY SPECIFIC â”€â”€ */
  .today-drive {
    background: linear-gradient(135deg, var(--orange-l) 0%, #fff 100%);
    border: 1.5px solid rgba(232,129,58,.25);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
  }
  #sm .today-drive-head {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
  }
  #sm .today-drive-icon {
    width: 44px;
    height: 44px;
    border-radius: 14px;
    background: var(--orange);
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    flex-shrink: 0;
  }
  #sm .route-viz {
    display: flex;
    align-items: center;
    gap: 0;
    margin-top: 4px;
  }
  #sm .route-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: var(--blue);
    flex-shrink: 0;
  }
  #sm .route-dot.end { background: var(--orange); }
  #sm .route-line {
    flex: 1;
    height: 2px;
    background: repeating-linear-gradient(90deg, var(--border) 0, var(--border) 5px, transparent 5px, transparent 10px);
    margin: 0 4px;
    position: relative;
  }
  #sm .route-car {
    position: absolute;
    left: 35%;
    top: 50%;
    transform: translateY(-50%);
    font-size: .75rem;
    color: var(--orange);
  }
  #sm .route-label {
    font-size: .72rem;
    font-weight: 700;
    color: var(--text-2);
    margin-top: 8px;
    display: flex;
    justify-content: space-between;
  }

  #sm /* â”€â”€ STOP PHOTO HERO â”€â”€ */
  .stop-photo {
    height: 220px;
    border-radius: var(--radius);
    margin: -24px -20px 24px;
    background: linear-gradient(160deg, #2c7a9a 0%, #1E4D7B 50%, #E8813A 100%);
    position: relative;
    overflow: hidden;
  }
  #sm .stop-photo-label {
    position: absolute;
    bottom: 16px;
    left: 20px;
    right: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
  }
  #sm .stop-photo-night {
    font-size: .7rem;
    font-weight: 800;
    color: rgba(255,255,255,.85);
    background: rgba(0,0,0,.35);
    padding: 4px 10px;
    border-radius: 20px;
    backdrop-filter: blur(4px);
  }
  #sm .stop-photo-num {
    font-size: 2.4rem;
    font-weight: 900;
    color: rgba(255,255,255,.18);
    line-height: 1;
  }

  #sm /* Day row in schedule */
  .day-row {
    background: var(--card);
    border-radius: var(--radius-s);
    padding: 14px 16px;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    transition: box-shadow .15s, transform .15s;
    box-shadow: 0 1px 2px rgba(0,0,0,.03), 0 2px 8px rgba(0,0,0,.05);
  }
  #sm .day-row:hover { box-shadow: 0 2px 6px rgba(0,0,0,.07), 0 8px 20px rgba(0,0,0,.09); transform: translateY(-1px); }
  #sm .day-row.is-today { border-left: 4px solid var(--orange); padding-left: 12px; }
  #sm .day-row.is-past { opacity: .55; }
  #sm .day-num {
    width: 38px;
    text-align: center;
    flex-shrink: 0;
  }
  #sm .day-num .d { font-size: 1.15rem; font-weight: 900; line-height: 1; }
  #sm .day-num .mo { font-size: .6rem; font-weight: 700; color: var(--text-3); text-transform: uppercase; }

  #sm /* Week group header */
  .week-head {
    font-size: .68rem;
    font-weight: 800;
    letter-spacing: .09em;
    text-transform: uppercase;
    color: var(--text-3);
    padding: 20px 0 8px;
  }
  #sm .week-head:first-child { padding-top: 0; }

  #sm /* genie CTA */
  .genie-bar {
    background: linear-gradient(135deg, var(--orange) 0%, var(--orange-d) 100%);
    border-radius: var(--radius);
    padding: 18px 20px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    margin-bottom: 12px;
    transition: transform .15s;
  }
  #sm .genie-bar:active { transform: scale(.985); }
  #sm .genie-bar .genie-icon { font-size: 1.6rem; }
  #sm .genie-bar .genie-text .t1 { font-size: .92rem; font-weight: 900; color: #fff; }
  #sm .genie-bar .genie-text .t2 { font-size: .75rem; color: rgba(255,255,255,.75); margin-top: 2px; }

  #sm /* Activity tag */
  .act-tag {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-radius: 100px;
    border: 1.5px solid var(--border);
    font-size: .8rem;
    font-weight: 600;
    color: var(--text);
    margin: 4px;
    cursor: pointer;
    transition: border-color .15s, background .15s;
  }
  #sm .act-tag:hover { border-color: var(--orange); background: var(--orange-l); }
  #sm .act-tag.added {
    border-color: var(--green);
    background: var(--green-l);
    color: var(--green);
    font-weight: 700;
  }
  #sm .act-tag.added .act-check { display: inline-block !important; }

  #sm /* Weather forecast row */
  .wx-day {
    flex: 1;
    min-width: 52px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 10px 4px;
    border-radius: var(--radius-s);
    background: var(--bg);
    text-align: center;
  }
  #sm .wx-day.today { background: var(--blue-l); }
  #sm .wx-day-name { font-size: .6rem; font-weight: 800; text-transform: uppercase; letter-spacing: .05em; color: var(--text-3); }
  #sm .wx-day.today .wx-day-name { color: var(--blue); }
  #sm .wx-icon { font-size: 1.3rem; }
  #sm .wx-hi { font-size: .82rem; font-weight: 900; color: var(--text); }
  #sm .wx-lo { font-size: .72rem; font-weight: 600; color: var(--text-3); }

  #sm /* Plan list in stop detail */
  .plan-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 11px 0;
    border-bottom: 1px solid var(--border);
    font-size: .85rem;
    font-weight: 700;
  }
  #sm .plan-row:last-child { border-bottom: none; }

  #sm /* School day card */
  .school-card {
    display: flex;
    gap: 14px;
    align-items: center;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
  }
  #sm .school-card:last-child { border-bottom: none; }
  #sm .school-icon { width: 38px; height: 38px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: .9rem; flex-shrink: 0; }

  #sm /* Animated screen transitions */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  #sm .screen.active > * { animation: fadeUp .28s ease both; }
  #sm .screen.active > *:nth-child(2) { animation-delay: .04s; }
  #sm .screen.active > *:nth-child(3) { animation-delay: .08s; }
  #sm .screen.active > *:nth-child(4) { animation-delay: .12s; }
  #sm .screen.active > *:nth-child(5) { animation-delay: .16s; }
  #sm .screen.active > *:nth-child(6) { animation-delay: .20s; }

  #sm /* â”€â”€ TABLET + DESKTOP (â‰¥680px): sidebar nav layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (min-width: 680px) {
    html, body { overflow: auto; }

    #shell {
      display: grid;
      grid-template-columns: 220px 1fr;
      grid-template-rows: auto 3px 1fr;
      grid-template-areas:
        "sidebar topbar"
        "sidebar strip"
        "sidebar screens";
      height: 100vh; height: 100dvh;
      overflow: hidden;
    }

    #top-bar        { grid-area: topbar;   border-left: 1px solid var(--border); height: auto; min-height: 60px; padding: 0 24px; }
    #progress-strip { grid-area: strip; }
    #screen-area    { grid-area: screens; }

    /* Bottom nav â†’ left sidebar */
    #bottom-nav {
      grid-area: sidebar;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      height: 100%;
      border-top: none;
      border-right: 1px solid var(--border);
      padding: 0;
      padding-bottom: 0;
      overflow-y: auto;
      background: var(--card);
      gap: 0;
    }

    /* Sidebar brand header */
    #sidebar-brand-2 {
      display: block;
      padding: 14px 18px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 6px;
      flex-shrink: 0;
    }

    /* Nav buttons: row layout */
    .nav-btn {
      flex-direction: row;
      justify-content: flex-start;
      gap: 12px;
      min-width: unset;
      width: 100%;
      padding: 13px 18px;
      border-radius: 0;
      font-size: .88rem;
      min-height: 50px;
      color: var(--text-2);
    }
    .nav-btn i    { font-size: 1rem; width: 20px; text-align: center; flex-shrink: 0; }
    .nav-btn span { font-size: .88rem; font-weight: 700; }
    .nav-btn.active {
      background: var(--orange-l);
      color: var(--orange);
      box-shadow: inset 3px 0 0 var(--orange);
    }
    .nav-btn:hover { background: var(--bg); color: var(--text); }
    .nav-btn.active:hover { background: var(--orange-l); color: var(--orange); }

    /* Screens: no bottom-padding, proper side padding */
    .screen { padding: 36px 44px 36px; }

    /* Stop photo: account for wider padding */
    .stop-photo { margin: -36px -44px 28px; height: 260px; border-radius: 0; }

    /* Top bar: show title as brand on desktop */
    #top-title { font-size: 1rem; font-weight: 800; }
    #top-action { font-size: .82rem; padding: 8px 16px; background: var(--orange-l); color: var(--orange-d); border-radius: 20px; font-weight: 800; }
  }

  #sm /* â”€â”€ DESKTOP (â‰¥1025px): add right context panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (min-width: 1025px) {
    #shell {
      grid-template-columns: 220px 1fr 300px;
      grid-template-areas:
        "sidebar topbar  right"
        "sidebar strip   right"
        "sidebar screens right";
    }
    #right-panel {
      grid-area: right;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      border-left: 1px solid var(--border);
      background: var(--card);
    }
    .screen { padding: 40px 52px 40px; }
    .stop-photo { margin: -40px -52px 32px; }
  }

  #sm /* â”€â”€ WIDE DESKTOP (â‰¥1300px) â”€â”€ */
  @media (min-width: 1300px) {
    #shell { grid-template-columns: 240px 1fr 320px; }
    .nav-btn { padding: 14px 22px; }
    .screen { padding: 44px 60px 44px; }
  }

  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  LOGIN SCREEN                                                   -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-card">
    <span class="login-rv-icon">ğŸš</span>
    <div class="login-title" id="login-trip-title">Maass Family<br>RV 2026</div>
    <div class="login-sub" id="login-trip-sub">Your 46-day cross-country road trip</div>
    <div class="login-dates">
      <i class="fa-solid fa-calendar-days"></i>
      <span id="login-trip-dates">Feb 28 â€“ Apr 14, 2026</span>
    </div>

    <!-- Profile picker â€” choose who you are FIRST -->
    <div style="margin-bottom:20px;">
      <div style="font-size:.75rem;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">Choose Profile</div>
      <div class="login-family" style="margin-top:0;">
        <div class="family-avatar">
          <button class="login-profile-btn" id="profile-btn-Paul" onclick="selectLoginProfile('Paul')" type="button" title="Paul">
            <div class="avatar-circle" style="background:#2C5F8A">P</div>
          </button>
          <span class="avatar-name">Paul</span>
        </div>
        <div class="family-avatar">
          <button class="login-profile-btn" id="profile-btn-Melissa" onclick="selectLoginProfile('Melissa')" type="button" title="Melissa">
            <div class="avatar-circle" style="background:#3A8A5C">M</div>
          </button>
          <span class="avatar-name">Melissa</span>
        </div>
        <div class="family-avatar">
          <button class="login-profile-btn" id="profile-btn-Leila" onclick="selectLoginProfile('Leila')" type="button" title="Leila">
            <div class="avatar-circle" style="background:#E8813A">L</div>
          </button>
          <span class="avatar-name">Leila, 9</span>
        </div>
        <div class="family-avatar">
          <button class="login-profile-btn" id="profile-btn-Luna" onclick="selectLoginProfile('Luna')" type="button" title="Luna">
            <div class="avatar-circle" style="background:#7B5EA7">L</div>
          </button>
          <span class="avatar-name">Luna, 4</span>
        </div>
        <div class="family-avatar">
          <button class="login-profile-btn" id="profile-btn-Eli" onclick="selectLoginProfile('Eli')" type="button" title="Eli">
            <div class="avatar-circle" style="background:#D4A017">E</div>
          </button>
          <span class="avatar-name">Eli, 2</span>
        </div>
      </div>
    </div>

    <div class="login-form" id="login-form">
      <label class="login-label" for="password-input">Password</label>
      <input
        class="login-input"
        type="password"
        id="password-input"
        placeholder="Family or friends password"
        autofocus
        onkeydown="if(event.key==='Enter'){event.preventDefault();doLogin();}"
      />
      <div class="login-error" id="login-error"></div>
      <button class="login-btn" type="button" onclick="doLogin()">
        <i class="fa-solid fa-unlock-keyhole"></i> Let's Go!
      </button>
    </div>

    <!-- Test Mode trigger â€” flask icon, top-right of card -->
    <button onclick="enterTestMode()" title="Test Mode â€” explore without saving"
      style="position:absolute;top:14px;right:14px;background:rgba(245,166,35,.12);border:1.5px solid rgba(245,166,35,.45);color:#d47f00;border-radius:100px;padding:5px 13px;font-size:.76rem;font-weight:700;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:6px;transition:all .2s;"
      onmouseover="this.style.background='rgba(245,166,35,.25)';this.style.borderColor='#E8813A';this.style.color='#b86a00';"
      onmouseout="this.style.background='rgba(245,166,35,.12)';this.style.borderColor='rgba(245,166,35,.45)';this.style.color='#d47f00';">
      <i class="fa-solid fa-flask-vial"></i> Test
    </button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  APP SHELL                                                       -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="hidden">

  <!-- HEADER -->
  <header id="app-header">
    <div class="header-left">
      <button id="plan-trip-btn" onclick="openTripBuilder()" title="Plan a new trip with AI"
        style="display:flex;align-items:center;gap:6px;
               background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.32);
               color:#fff;border-radius:100px;padding:6px 13px;font-size:.78rem;font-weight:800;
               cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;
               transition:background .15s;">
        <i class="fa-solid fa-map"></i><span class="plan-trip-label"> Plan a New Trip</span>
      </button>
      <button id="tg-btn" onclick="openTripGenie()" title="Ask TripGenie anything">
        <span style="font-size:1rem;">âœ¨</span><span class="tg-btn-label"> Ask TripGenie</span>
      </button>
      <button id="change-plan-btn" onclick="openChangePlanModal()" title="Tell TripGenie about a change to the plan"
        style="display:flex;align-items:center;gap:6px;
               background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.32);
               color:#fff;border-radius:100px;padding:6px 13px;font-size:.78rem;font-weight:800;
               cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;
               transition:background .15s;">
        <i class="fa-solid fa-arrows-spin"></i><span class="change-plan-label"> Change the plan</span>
      </button>
    </div>
    <div class="header-right">
      <!-- Trip selector dropdown -->
      <div id="trip-selector-wrap" onclick="toggleTripSelectorMenu()" style="position:relative;cursor:pointer;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.28);border-radius:12px;padding:5px 12px;display:flex;align-items:center;gap:8px;min-width:110px;max-width:200px;">
        <span style="font-size:.78rem;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;font-weight:700;" id="trip-selector-label">Maass Family RV 2026</span>
        <span style="color:rgba(255,255,255,.7);font-size:.65rem;flex-shrink:0;">â–¾</span>
        <div id="trip-selector-menu" onclick="event.stopPropagation()" style="display:none;position:absolute;top:calc(100% + 8px);right:0;background:var(--card,#fff);border:1.5px solid var(--border);border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,.22);min-width:250px;z-index:1000;overflow:hidden;">
          <div id="trip-selector-list" style="padding:6px;"></div>
        </div>
      </div>
      <!-- Keep JS ref elements hidden (referenced by initApp / updateHeader) -->
      <strong id="hdr-day" style="display:none;">â€”</strong>
      <strong id="hdr-miles" style="display:none;">0</strong>
      <span id="hdr-miles-lbl" style="display:none;"></span>
      <div id="hdr-progress-bar" style="display:none;"></div>
      <span id="hdr-progress-pct" style="display:none;"></span>
      <span id="sync-status" style="font-size:.7rem;color:rgba(255,255,255,.45);white-space:nowrap;display:flex;align-items:center;gap:4px;" title="Cloud sync status"></span>
      <div title="Switch view" style="display:flex;align-items:center;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25);border-radius:12px;padding:3px;gap:2px;flex-shrink:0;">
        <span style="background:rgba(255,255,255,.18);color:#fff;border-radius:100px;padding:4px 11px;font-size:.72rem;font-weight:800;cursor:pointer;white-space:nowrap;font-family:var(--font);" onclick="_showSimpleMode()"><i class="fa-solid fa-mobile-screen-button"></i> Driving</span>
        <span style="background:var(--orange);color:#fff;border-radius:100px;padding:4px 11px;font-size:.72rem;font-weight:800;white-space:nowrap;font-family:var(--font);"><i class="fa-solid fa-sliders"></i> Planning</span>
      </div>
      <button onclick="openHelpSearch()" title="Search the app â€” ask anything" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.28);color:#fff;border-radius:100px;padding:5px 11px;font-size:.72rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;display:flex;align-items:center;gap:5px;"><i class="fa-solid fa-magnifying-glass"></i> Help</button>
      <button id="dark-mode-btn" onclick="toggleDarkMode()" title="Toggle dark/light mode" style="background:rgba(255,255,255,.15);border:none;color:#fff;border-radius:100px;padding:6px 10px;font-size:1rem;cursor:pointer;line-height:1;display:flex;align-items:center;">ğŸŒ™</button>
      <button class="logout-btn" id="logout-btn" title="Logout">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </header>

  <!-- HELP SEARCH OVERLAY -->
  <div id="help-search-overlay" onclick="closeHelpSearch()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:5500;align-items:flex-start;justify-content:center;padding:20px;padding-top:72px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:var(--card);border-radius:20px;width:100%;max-width:560px;margin:auto;box-shadow:0 16px 56px rgba(0,0,0,.32);overflow:hidden;">
      <!-- Header -->
      <div style="background:linear-gradient(135deg,var(--blue) 0%,#1a3a5c 100%);padding:18px 20px 14px;display:flex;align-items:center;gap:12px;">
        <div style="flex:1;">
          <div style="font-weight:900;font-size:1rem;color:#fff;margin-bottom:2px;"><i class="fa-solid fa-magnifying-glass"></i> App Help</div>
          <div style="font-size:.76rem;color:rgba(255,255,255,.7);">Ask what you're looking for â€” "How do I add a stop?" or "Where's the map?"</div>
        </div>
        <button onclick="closeHelpSearch()" style="background:rgba(255,255,255,.15);border:none;color:#fff;width:30px;height:30px;border-radius:50%;cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center;">âœ•</button>
      </div>
      <!-- Search input -->
      <div style="padding:16px 20px 12px;border-bottom:1px solid var(--border);">
        <input id="help-search-input" type="text" placeholder="Search or ask anythingâ€¦" autocomplete="off"
          style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);outline:none;background:var(--bg);"
          oninput="renderHelpResults(this.value)" onkeydown="if(event.key==='Escape')closeHelpSearch()"/>
      </div>
      <!-- Results -->
      <div id="help-results" style="padding:10px 12px 16px;max-height:360px;overflow-y:auto;"></div>
    </div>
  </div>

  <!-- CHANGE THE PLAN MODAL -->
  <div id="change-plan-overlay" onclick="closeChangePlanModal()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:4000;display:none;align-items:flex-start;justify-content:center;padding:24px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:var(--card);border-radius:20px;width:100%;max-width:560px;margin:auto;box-shadow:0 12px 48px rgba(0,0,0,.28);overflow:hidden;">
      <div style="background:linear-gradient(135deg,var(--blue) 0%,#1a3a5c 100%);padding:20px 24px 16px;display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div style="font-weight:900;font-size:1.05rem;color:#fff;margin-bottom:2px;"><i class="fa-solid fa-arrows-spin"></i> Change the Plan</div>
          <div style="font-size:.78rem;color:rgba(255,255,255,.7);">Tell TripGenie what needs to change</div>
        </div>
        <button onclick="closeChangePlanModal()" style="background:rgba(255,255,255,.15);border:none;color:#fff;width:34px;height:34px;border-radius:50%;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;">âœ•</button>
      </div>
      <div style="padding:20px 24px 24px;">
        <div style="font-size:.82rem;color:var(--text-2);margin-bottom:14px;line-height:1.5;">Speak or type what you need â€” e.g. <em>"avoid freezing temperatures"</em>, <em>"more time at the Grand Canyon"</em> â€” and get specific, actionable suggestions with one-tap apply.</div>
        <div style="position:relative;margin-bottom:12px;">
          <textarea id="adj-voice-ta" rows="5" placeholder="e.g. The RV isn't winterized â€” avoid any stops with freezing temperatures in March and Aprilâ€¦" style="width:100%;box-sizing:border-box;min-height:140px;padding:12px 50px 12px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:.88rem;font-family:var(--font);color:var(--text);background:var(--card);resize:vertical;outline:none;line-height:1.5;transition:border-color .15s;" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border)'"></textarea>
          <button id="adj-voice-mic-btn" onclick="_adjStartMic()" title="Tap to speak" style="position:absolute;bottom:10px;right:10px;width:34px;height:34px;border-radius:50%;background:var(--orange);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;"><i class="fa-solid fa-microphone"></i></button>
        </div>
        <button id="adj-voice-btn" onclick="_adjGetSuggestions()" style="background:linear-gradient(135deg,var(--blue) 0%,#5b2d8a 100%);color:#fff;border:none;border-radius:100px;padding:12px 20px;font-size:.9rem;font-weight:800;cursor:pointer;font-family:var(--font);width:100%;"><i class="fa-solid fa-wand-magic-sparkles"></i> Get Suggestions</button>
        <div id="adj-voice-results" style="margin-top:8px;"></div>
        <div id="adj-reply-bar" style="display:none;margin-top:12px;border-top:1px solid var(--border);padding-top:12px;">
          <div style="font-size:.75rem;font-weight:700;color:var(--text-2);margin-bottom:6px;"><i class="fa-solid fa-reply"></i> Not right? Refine your request:</div>
          <div style="display:flex;gap:8px;">
            <input id="adj-reply-input" type="text" placeholder="e.g. I don't want to skip Savannahâ€¦" style="flex:1;padding:9px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.84rem;font-family:var(--font);color:var(--text);background:var(--card);outline:none;" onfocus="this.style.borderColor='var(--blue)'" onblur="this.style.borderColor='var(--border)'">
            <button onclick="_adjRefineSuggestions()" style="background:var(--blue);color:#fff;border:none;border-radius:100px;padding:9px 14px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;"><i class="fa-solid fa-rotate-right"></i> Refine</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- NAV TABS -->
  <nav id="app-nav">
    <!-- Sidebar brand â€” visible only on desktop (hidden on tablet/mobile via CSS) -->
    <div id="sidebar-brand" style="display:none;padding:4px 14px 12px;flex-shrink:0;">
      <div style="font-size:.7rem;font-weight:700;color:var(--text-3);">ğŸš Maass Family RV 2026</div>
    </div>
    <button class="nav-tab active" data-tab="dashboard" data-tooltip="Dashboard">
      <i class="fa-solid fa-gauge-high"></i>
    <span class="nav-tab-lbl">Dashboard</span></button>
    <button class="nav-tab" data-tab="map" data-tooltip="Route Map">
      <i class="fa-solid fa-map"></i>
    <span class="nav-tab-lbl">Route Map</span></button>
    <button class="nav-tab" data-tab="planner" data-tooltip="Planner">
      <i class="fa-solid fa-route"></i>
    <span class="nav-tab-lbl">Planner</span></button>
    <button class="nav-tab" data-tab="school" data-tooltip="School">
      <i class="fa-solid fa-book-open"></i>
    <span class="nav-tab-lbl">School</span></button>
    <button class="nav-tab" data-tab="journal" data-tooltip="Journal">
      <i class="fa-solid fa-book"></i>
    <span class="nav-tab-lbl">Journal</span></button>
    <button class="nav-tab" data-tab="gallery" data-tooltip="Gallery">
      <i class="fa-solid fa-images"></i>
    <span class="nav-tab-lbl">Gallery</span></button>
    <button class="nav-tab" data-tab="postcards" data-tooltip="Postcards">
      <i class="fa-solid fa-address-card"></i>
    <span class="nav-tab-lbl">Postcards</span></button>
    <button class="nav-tab" data-tab="lists" data-tooltip="Lists">
      <i class="fa-solid fa-list-check"></i>
    <span class="nav-tab-lbl">Lists</span></button>
    <button class="nav-tab hidden" data-tab="suggestions" id="suggestions-nav-tab" data-tooltip="Suggestions">
      <i class="fa-solid fa-lightbulb"></i>
    <span class="nav-tab-lbl">Suggestions</span></button>
    <button class="nav-tab" data-tab="adjustments" id="adj-nav-tab" data-tooltip="Recommendations" style="position:relative;">
      <i class="fa-solid fa-wand-magic-sparkles"></i>
    <span class="nav-tab-lbl">Recommendations</span></button>
    <button class="nav-tab" data-tab="decisions" id="decisions-nav-tab" data-tooltip="Decisions" style="position:relative;">
      <i class="fa-solid fa-triangle-exclamation" style="color:var(--red);"></i>
    <span class="nav-tab-lbl">Decisions</span></button>
    <button class="nav-tab" data-tab="fun" data-tooltip="Fun">
      <i class="fa-solid fa-face-laugh-beam"></i>
    <span class="nav-tab-lbl">Fun</span></button>
    <button class="nav-tab" data-tab="whatsnew" data-tooltip="What's New" style="position:relative;">
      <i class="fa-solid fa-newspaper"></i>
      <span id="whatsnew-dot" style="position:absolute;top:8px;right:8px;width:7px;height:7px;background:var(--orange);border-radius:50%;display:block;"></span>
    
    <span class="nav-tab-lbl">What's New</span></button></span></button>
    <button class="nav-tab" data-tab="tools" data-tooltip="Tools" style="position:relative;">
      <i class="fa-solid fa-screwdriver-wrench"></i>
    <span class="nav-tab-lbl">Tools</span></button>
    <button class="nav-tab" data-tab="ideas" data-tooltip="Ideas" title="Share an Idea" style="position:relative;">
      <i class="fa-solid fa-lightbulb"></i>
      <span id="ideas-new-dot" style="position:absolute;top:8px;right:8px;width:7px;height:7px;background:var(--green);border-radius:50%;display:none;"></span>
    
    <span class="nav-tab-lbl">Ideas</span></button></span></button>
  </nav>

  <!-- TEST MODE BANNER (hidden by default, shown in test mode) -->
  <div id="test-mode-banner" class="hidden" style="background:#F5A623;color:#fff;padding:8px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;font-size:.82rem;font-weight:800;letter-spacing:.01em;flex-wrap:wrap;position:sticky;top:0;z-index:200;box-shadow:0 2px 8px rgba(0,0,0,.15);">
    <span style="display:flex;align-items:center;gap:8px;">
      <span style="font-size:1.1rem;">&#129514;</span>
      TEST MODE &mdash; Nothing you do here will affect your real trip plans. Go nuts!
    </span>
    <button onclick="exitTestMode()" style="background:rgba(0,0,0,.2);border:1.5px solid rgba(255,255,255,.6);color:#fff;border-radius:100px;padding:5px 14px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;">&#215; Exit Test Mode</button>
  </div>

  <!-- MAIN CONTENT -->
  <main id="app-main">

    <!-- DASHBOARD TAB -->
    <div class="tab-panel active" id="tab-dashboard">
      <div id="dashboard-content"></div>
    </div>

    <!-- MAP TAB -->
    <div class="tab-panel" id="tab-map">
      <div style="display:flex;flex-direction:column;height:calc(100vh - 130px);gap:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
          <h2 class="section-title" style="margin:0"><i class="fa-solid fa-map"></i> Full Route Map</h2>
          <div style="display:flex;gap:14px;font-size:.8rem;color:var(--text-2);align-items:center;">
            <span style="display:flex;align-items:center;gap:5px;"><span style="width:12px;height:12px;background:var(--orange);border-radius:50%;display:inline-block;border:2px solid white;box-shadow:0 0 0 1px var(--orange)"></span> Stop</span>
            <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:var(--blue);display:inline-block;border-radius:2px"></span> Outbound</span>
            <span style="display:flex;align-items:center;gap:5px;"><span style="width:20px;height:3px;background:#a855f7;display:inline-block;border-radius:2px;border-top:3px dashed #a855f7;height:0"></span> Return</span>
          </div>
        </div>
        <div id="map-container" style="flex:1;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);box-shadow:var(--shadow);min-height:400px;"></div>
      </div>
    </div>

    <!-- PLANNER TAB (Schedule + Stops combined) -->
    <div class="tab-panel" id="tab-planner">
      <div style="display:flex;gap:8px;margin-bottom:20px;padding-top:4px;">
        <button id="plan-seg-schedule" onclick="_mainSeg('schedule')" style="flex:1;padding:9px 16px;border:1.5px solid var(--orange);border-radius:50px;background:var(--orange);color:#fff;font-family:var(--font);font-size:.82rem;font-weight:700;cursor:pointer;transition:all .15s;"><i class="fa-solid fa-calendar-days"></i> Schedule</button>
        <button id="plan-seg-stops" onclick="_mainSeg('stops')" style="flex:1;padding:9px 16px;border:1.5px solid var(--border);border-radius:50px;background:var(--card);color:var(--text-2);font-family:var(--font);font-size:.82rem;font-weight:700;cursor:pointer;transition:all .15s;"><i class="fa-solid fa-campground"></i> Stops</button>
      </div>
      <div id="schedule-content" style="display:block"></div>
      <div id="stops-content" style="display:none"></div>
    </div>

    <!-- SCHOOL TAB -->
    <div class="tab-panel" id="tab-school">
      <div id="school-content"></div>
    </div>

    <!-- JOURNAL TAB -->
    <div class="tab-panel" id="tab-journal">

      <!-- Header -->
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <h2 class="section-title" style="margin:0;"><i class="fa-solid fa-book"></i> Trip Journal</h2>
        <div id="journal-count" style="font-size:.8rem;color:var(--text-3);"></div>
      </div>

      <!-- Compose card -->
      <div style="background:var(--card);border:2px solid var(--gold);border-radius:var(--radius);padding:20px;margin-bottom:24px;box-shadow:var(--shadow);">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">
          <span style="font-size:1.1rem;">&#9997;&#65039;</span>
          <h3 style="font-size:.9rem;font-weight:800;color:var(--gold);margin:0;">New Journal Entry</h3>
        </div>

        <!-- Day + Author + Location row -->
        <div class="journal-meta-grid" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:14px;">
          <div>
            <label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Day</label>
            <select id="j-day" onchange="updateJournalLocation()" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.82rem;"></select>
          </div>
          <div>
            <label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Author</label>
            <select id="j-author" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.82rem;">
              <option value="Paul">&#128102; Paul</option>
              <option value="Melissa">&#128103; Melissa</option>
              <option value="Leila">&#128102; Leila (9)</option>
              <option value="Luna">&#128103; Luna (4)</option>
              <option value="Eli">&#128102; Eli (2)</option>
            </select>
          </div>
          <div>
            <label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Location</label>
            <div style="display:flex;gap:6px;align-items:stretch;">
              <select id="j-location-select" style="flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.82rem;color:var(--text);min-width:0;"></select>
              <button onclick="detectJournalLocation()" title="Detect GPS location" style="padding:6px 10px;background:var(--blue-l);border:1px solid var(--border);border-radius:var(--radius-s);cursor:pointer;font-size:.9rem;flex-shrink:0;font-family:var(--font);">&#128205;</button>
            </div>
          </div>
        </div>

        <!-- Note textarea -->
        <div style="margin-bottom:14px;">
          <label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Note</label>
          <textarea id="j-text" placeholder="What happened today? Best moment? Funniest thing a kid said?..." style="width:100%;min-height:100px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.875rem;resize:vertical;line-height:1.55;color:var(--text);outline:none;"></textarea>
        </div>

        <!-- Photos + Audio row -->
        <div class="journal-photos-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
          <div>
            <label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:7px;text-transform:uppercase;letter-spacing:.04em;"><i class="fa-solid fa-camera"></i> Photos &amp; Videos</label>
            <label for="j-photos" style="display:flex;align-items:center;gap:7px;padding:9px 14px;background:var(--blue-l);border:1px dashed #7aaac8;border-radius:var(--radius-s);cursor:pointer;font-size:.8rem;font-weight:700;color:var(--blue);">
              <i class="fa-solid fa-cloud-arrow-up"></i> Choose photos or videos
            </label>
            <input type="file" id="j-photos" accept="image/*,video/*" multiple style="display:none;" onchange="handlePhotoUpload(event)">
            <div id="j-photo-previews" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:8px;"></div>
          </div>
          <div>
            <label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:7px;text-transform:uppercase;letter-spacing:.04em;"><i class="fa-solid fa-microphone"></i> Voice Memo</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <button id="j-rec-btn" onclick="toggleRecording()" style="display:flex;align-items:center;gap:6px;padding:9px 14px;background:var(--red-l);border:1px solid #e0a8a4;border-radius:var(--radius-s);font-family:var(--font);font-size:.8rem;font-weight:700;color:var(--red);cursor:pointer;"><i class="fa-solid fa-circle"></i> Record</button>
              <span id="j-rec-timer" style="display:none;font-size:.82rem;color:var(--red);font-weight:700;">0:00</span>
            </div>
            <div id="j-audio-preview" style="margin-top:8px;"></div>
          </div>
        </div>

        <!-- Submit row -->
        <div style="display:flex;gap:8px;">
          <button onclick="aiCleanupJournal()" id="j-cleanup-btn" style="flex:0 0 auto;padding:12px 16px;background:var(--purple-l);color:var(--purple);border:1.5px solid #c9b8e8;border-radius:var(--radius-s);font-family:var(--font);font-size:.85rem;font-weight:800;cursor:pointer;white-space:nowrap;">
            <i class="fa-solid fa-wand-magic-sparkles"></i> AI Clean Up
          </button>
          <button onclick="submitJournalEntry()" style="flex:1;padding:12px;background:var(--gold);color:#fff;border:none;border-radius:var(--radius-s);font-family:var(--font);font-size:.9rem;font-weight:800;cursor:pointer;">
            <i class="fa-solid fa-floppy-disk"></i> Save Journal Entry
          </button>
        </div>
      </div>

      <!-- Entries list -->
      <div id="journal-entries"></div>

    </div>


    <!-- SUGGESTIONS TAB -->
    <!-- POSTCARDS TAB -->
    <div class="tab-panel" id="tab-postcards">
      <div id="postcards-content"></div>
    </div>

    <!-- LISTS TAB -->
    <div class="tab-panel" id="tab-lists">
      <div id="lists-content"></div>
    </div>

    <div class="tab-panel hidden" id="tab-suggestions">
      <div id="suggestions-content"></div>
    </div>
    <!-- ADJUSTMENTS TAB -->
    <div class="tab-panel" id="tab-adjustments">
      <div id="adjustments-content"></div>
    </div>

    <!-- DECISIONS TAB -->
    <div class="tab-panel" id="tab-decisions">
      <div id="decisions-content"></div>
    </div>

    <!-- FUN TAB (Games + State Badges + Trivia) -->
    <div class="tab-panel" id="tab-fun">
      <div id="fun-content"></div>
    </div>

    <!-- GALLERY TAB -->
    <div class="tab-panel" id="tab-gallery">
      <div id="gallery-tab-content" style="padding:16px;"></div>
    </div>

    <!-- TOOLS TAB (Expenses + Memory Book) -->
    <div class="tab-panel" id="tab-tools">
      <div id="tools-content"></div>
    </div>

    <div class="tab-panel hidden" id="tab-whatsnew">
      <div id="whatsnew-content"></div>
    </div>

    <div class="tab-panel hidden" id="tab-ideas">
      <div id="ideas-content"></div>
    </div>

  </main>
</div>

<!-- TRIPGENIE DRAWER -->
<div id="tg-drawer" role="dialog" aria-label="TripGenie AI Assistant">
  <div id="tg-head">
    <span style="font-size:1.6rem;line-height:1;">âœ¨</span>
    <div style="flex:1;">
      <div style="font-weight:900;font-size:1.05rem;letter-spacing:-.01em;">TripGenie</div>
      <div style="font-size:.72rem;opacity:.8;">Your AI road-trip assistant â€” ask anything!</div>
    </div>
    <button onclick="closeTripGenie()" style="background:rgba(255,255,255,.18);border:1.5px solid rgba(255,255,255,.4);color:#fff;border-radius:100px;padding:6px 14px;font-size:.85rem;font-weight:800;cursor:pointer;font-family:var(--font);">&#215; Close</button>
  </div>

  <div id="tg-history">
    <!-- welcome message injected by JS -->
  </div>

  <div id="tg-foot">
    <!-- photo preview strip (shown when photo attached) -->
    <div id="tg-photo-strip">
      <img id="tg-photo-thumb" src="" alt="Attached photo" />
      <div style="flex:1;">
        <div style="font-size:.78rem;font-weight:700;color:#7B2FBE;">ğŸ“ Photo attached</div>
        <div style="font-size:.72rem;color:var(--text-3);">TripGenie will analyze this image</div>
      </div>
      <button onclick="removeTripGeniePhoto()" style="background:var(--red-l);border:1px solid var(--red);color:var(--red);border-radius:100px;padding:4px 10px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);">âœ• Remove</button>
    </div>

    <!-- suggested questions (shown when history is empty) -->
    <div id="tg-suggestions" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:4px;">
      <button onclick="tgSuggest(this)" style="background:#f0e8ff;color:#7B2FBE;border:1.5px solid #d4b8f8;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">How do I empty the gray water tank?</button>
      <button onclick="tgSuggest(this)" style="background:#f0e8ff;color:#7B2FBE;border:1.5px solid #d4b8f8;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">What's the best RV park check-in tip?</button>
      <button onclick="tgSuggest(this)" style="background:#f0e8ff;color:#7B2FBE;border:1.5px solid #d4b8f8;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">How do I unhook the sewer connection safely?</button>
      <button onclick="tgSuggest(this)" style="background:#f0e8ff;color:#7B2FBE;border:1.5px solid #d4b8f8;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">What should I do if a tire looks low?</button>
      <button onclick="tgSuggest(this)" style="background:#f0e8ff;color:#7B2FBE;border:1.5px solid #d4b8f8;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">What's a good campfire dinner recipe?</button>
      <button onclick="tgSuggest(this)" style="background:#f0e8ff;color:#7B2FBE;border:1.5px solid #d4b8f8;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">Activities near Sedona for kids?</button>
    </div>

    <div id="tg-input-row">
      <textarea id="tg-input" placeholder="Ask anything â€” RV tips, local spots, what's in this photoâ€¦" rows="1"
        onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();askTripGenie();}"
        oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"></textarea>
      <input type="file" id="tg-file-input" accept="image/*" style="display:none" onchange="handleTripGeniePhoto(event)" />
      <button class="tg-icon-btn" id="tg-photo-btn" onclick="document.getElementById('tg-file-input').click()" title="Attach a photo">ğŸ“·</button>
      <button class="tg-icon-btn" id="tg-send-btn" onclick="askTripGenie()" title="Send">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      </button>
    </div>
    <div style="text-align:center;font-size:.68rem;color:var(--text-3);padding-top:7px;border-top:1px solid rgba(0,0,0,.07);margin-top:6px;">TripGenie is AI and can make mistakes. Please double-check important details.</div>
  </div>
</div>

<!-- UPDATE BANNER -->
<div id="update-banner" style="display:none;position:fixed;top:0;left:0;right:0;z-index:99999;background:var(--blue);color:#fff;align-items:center;justify-content:center;gap:12px;padding:11px 20px;font-size:.88rem;font-weight:700;box-shadow:0 2px 10px rgba(0,0,0,.25);" onclick="location.reload(true)">
  <span>ğŸ†• New version ready â€” tap to reload</span>
  <button onclick="event.stopPropagation();document.getElementById('update-banner').style.display='none'" style="background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:100px;padding:3px 12px;font-size:.76rem;font-weight:700;cursor:pointer;font-family:var(--font);">Dismiss</button>
</div>

<!-- TOAST -->
<div id="toast"></div>

<!-- PHOTO LIGHTBOX -->

<!-- LOCAL MUSIC MODAL -->
<div id="music-modal" class="hidden" onclick="if(event.target===this)closeLocalMusic()">
  <div class="music-card">
    <div class="music-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="font-size:.68rem;opacity:.8;font-weight:700;text-transform:uppercase;letter-spacing:.06em;">ğŸµ Local Sounds</div>
          <div style="font-size:1rem;font-weight:900;margin-top:2px;" id="music-location-title">Loadingâ€¦</div>
        </div>
        <button onclick="closeLocalMusic()" style="background:rgba(255,255,255,.2);border:none;color:#fff;font-size:1.4rem;line-height:1;width:34px;height:34px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;">&#215;</button>
      </div>
      <div style="font-size:.78rem;opacity:.85;margin-top:8px;line-height:1.4;" id="music-scene-desc"></div>
    </div>
    <div id="music-body" style="padding:16px;">
      <div style="text-align:center;padding:40px 20px;color:var(--text-3);">
        <div style="font-size:2rem;margin-bottom:8px;">ğŸµ</div>
        <div>Finding local soundsâ€¦</div>
      </div>
    </div>
    <!-- Genre / Search section -->
    <div id="music-genres-row" style="padding:0 16px 16px;display:none;">
      <div style="font-size:.72rem;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">Search on Spotify</div>
      <div id="music-genre-chips" style="display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
    <div style="padding:0 16px 24px;">
      <div style="font-size:.72rem;color:var(--text-3);text-align:center;line-height:1.5;">Tap any artist or genre chip to open in Spotify.<br>Spotify app or web player will open.</div>
    </div>
  </div>
</div>

<!-- DAY DETAIL MODAL -->
<div id="day-detail-modal" class="hidden" onclick="if(event.target===this)closeDayDetail()">
  <div class="ddm-card">
    <div class="ddm-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <div style="font-size:.7rem;opacity:.75;font-weight:700;text-transform:uppercase;letter-spacing:.06em;" id="ddm-phase"></div>
          <div style="font-size:1.05rem;font-weight:900;margin-top:2px;line-height:1.3;" id="ddm-title"></div>
          <div style="font-size:.77rem;opacity:.85;margin-top:4px;" id="ddm-meta"></div>
        </div>
        <button onclick="closeDayDetail()" style="background:rgba(255,255,255,.2);border:none;color:#fff;font-size:1.4rem;line-height:1;width:34px;height:34px;border-radius:50%;cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;flex-shrink:0;">&#215;</button>
      </div>
      <div style="font-size:.68rem;opacity:.7;margin-top:8px;font-weight:600;letter-spacing:.02em;">Hold a row to edit &nbsp;Â·&nbsp; Drag â ¿ to reorder</div>
      <div style="display:flex;gap:8px;margin-top:6px;padding-top:8px;border-top:1px solid rgba(255,255,255,.2);flex-wrap:wrap;align-items:center;">
        <button id="ddm-arrive-btn"
          onclick="recordArrival()"
          onmousedown="startLongPress('arrive')" onmouseup="cancelLongPress()" onmouseleave="cancelLongPress()"
          ontouchstart="startLongPress('arrive')" ontouchend="cancelLongPress()"
          style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:100px;padding:5px 14px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);user-select:none;-webkit-user-select:none;">&#129001; We Arrived!</button>
        <button id="ddm-leave-btn"
          onclick="recordDeparture()"
          onmousedown="startLongPress('depart')" onmouseup="cancelLongPress()" onmouseleave="cancelLongPress()"
          ontouchstart="startLongPress('depart')" ontouchend="cancelLongPress()"
          style="background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:100px;padding:5px 14px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);user-select:none;-webkit-user-select:none;">&#128666; We Left</button>
        <button id="ddm-music-btn"
          onclick="openLocalMusic()"
          style="background:rgba(29,185,84,.25);border:1px solid rgba(29,185,84,.6);color:#fff;border-radius:100px;padding:5px 14px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:5px;margin-left:auto;">&#127926; Local Music</button>
      </div>
    </div>
    <div id="ddm-blocks"></div>
  </div>
</div>

<!-- AI INFO MODAL -->
<!-- TIME EDIT OVERLAY -->
<!-- POSTCARD RENDER CANVAS (off-screen, used by html2canvas) -->
<div id="postcard-render-root" style="position:fixed;left:-1300px;top:0;width:1200px;height:800px;overflow:hidden;pointer-events:none;z-index:-1;"></div>

<!-- ADD DESTINATION MODAL -->
<div id="add-dest-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:4000;display:flex;align-items:center;justify-content:center;padding:16px;" onclick="if(event.target===this)closeAddDest()">
  <div style="background:var(--card);border-radius:var(--radius);padding:22px;max-width:440px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.25);max-height:85vh;overflow-y:auto;">

    <!-- Header -->
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
      <div style="font-size:1.4rem;">&#128205;</div>
      <div>
        <div style="font-weight:900;font-size:1rem;color:var(--text);">Add a New Destination</div>
        <div style="font-size:.78rem;color:var(--text-2);">TripGenie will verify the place and suggest how it fits your trip.</div>
      </div>
    </div>

    <!-- Step indicator -->
    <div id="adm-steps" style="display:flex;gap:6px;margin-bottom:18px;align-items:center;">
      <div id="adm-dot1" style="width:8px;height:8px;border-radius:50%;background:var(--blue);"></div>
      <div style="flex:1;height:2px;background:var(--border);border-radius:1px;"><div id="adm-prog1" style="height:100%;width:0%;background:var(--blue);border-radius:1px;transition:width .4s;"></div></div>
      <div id="adm-dot2" style="width:8px;height:8px;border-radius:50%;background:var(--border);"></div>
      <div style="flex:1;height:2px;background:var(--border);border-radius:1px;"><div id="adm-prog2" style="height:100%;width:0%;background:var(--blue);border-radius:1px;transition:width .4s;"></div></div>
      <div id="adm-dot3" style="width:8px;height:8px;border-radius:50%;background:var(--border);"></div>
    </div>

    <!-- Step 1: Input -->
    <div id="adm-step1">
      <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:6px;">Step 1 â€” Enter a place</div>
      <input id="adm-city" type="text" placeholder="e.g. Nashville, TN  or  Mesa Verde" style="width:100%;padding:11px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.95rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);margin-bottom:14px;box-sizing:border-box;" onkeydown="if(event.key==='Enter')lookupDestination()" />
      <div style="display:flex;gap:8px;">
        <button onclick="lookupDestination()" style="flex:1;background:var(--blue);color:#fff;border:none;border-radius:100px;padding:11px;font-size:.92rem;font-weight:800;cursor:pointer;font-family:var(--font);">&#128269; Look Up Place</button>
        <button onclick="closeAddDest()" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:11px 16px;font-size:.88rem;cursor:pointer;font-family:var(--font);color:var(--text-2);">Cancel</button>
      </div>
    </div>

    <!-- Loading state (shared between steps) -->
    <div id="adm-loading" class="hidden" style="text-align:center;padding:28px 20px;color:var(--text-2);">
      <div style="font-size:1.6rem;margin-bottom:10px;">&#128269;</div>
      <div id="adm-loading-msg" style="font-size:.9rem;font-weight:600;">Looking up placeâ€¦</div>
      <div style="font-size:.78rem;color:var(--text-3);margin-top:4px;">Asking TripGenieâ€¦</div>
    </div>

    <!-- Step 2: Confirmation -->
    <div id="adm-step2" class="hidden">
      <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:10px;">Step 2 â€” Confirm the place</div>
      <div id="adm-confirm-card" style="background:var(--blue-l);border:1.5px solid var(--blue);border-radius:12px;padding:14px;margin-bottom:14px;"></div>
      <div style="display:flex;gap:8px;">
        <button onclick="analyzeDestination()" id="adm-yes-btn" style="flex:1;background:var(--blue);color:#fff;border:none;border-radius:100px;padding:10px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">&#10003; Yes, Add This Place</button>
        <button onclick="admBackToStep1()" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:10px 14px;font-size:.85rem;cursor:pointer;font-family:var(--font);color:var(--text-2);">&#8592; Try Again</button>
      </div>
    </div>

    <!-- Step 3: Trip fit analysis -->
    <div id="adm-step3" class="hidden">
      <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:10px;">Step 3 â€” TripGenie's Analysis</div>
      <div id="adm-analysis-card" style="margin-bottom:14px;"></div>
      <div style="font-size:.75rem;color:var(--text-2);background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:10px;line-height:1.5;">
        <strong>Choose how to handle the extra days:</strong><br>
        ğŸ”„ <strong>Accept trade-off</strong> â€” you'll decide what to shorten elsewhere (goes to Adjustments).<br>
        â• <strong>Add without trade-off</strong> â€” trip extends; flagged in Decisions for you to resolve later.
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="addDestToAdjustments(true)" style="flex:1;background:var(--orange);color:#fff;border:none;border-radius:100px;padding:11px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ”„ Accept Trade-off</button>
        <button onclick="addDestToAdjustments(false)" style="flex:1;background:var(--blue);color:#fff;border:none;border-radius:100px;padding:11px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">â• Add, Decide Later</button>
      </div>
      <div style="margin-top:8px;">
        <button onclick="closeAddDest()" style="width:100%;background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:9px;font-size:.85rem;cursor:pointer;font-family:var(--font);color:var(--text-2);">Cancel</button>
      </div>
    </div>

  </div>
</div>

<!-- ITEM EDIT MODAL (bottom-sheet) â€” opened by long-pressing a schedule row -->
<div id="item-edit-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:5500;display:flex;align-items:flex-end;justify-content:center;" onclick="if(event.target===this)closeItemEdit()">
  <div style="background:var(--card);border-radius:16px 16px 0 0;padding:0 0 32px;max-width:480px;width:100%;box-shadow:0 -8px 40px rgba(0,0,0,.25);max-height:88vh;overflow-y:auto;">
    <!-- Handle bar -->
    <div style="width:36px;height:4px;background:var(--border);border-radius:2px;margin:12px auto 0;"></div>
    <!-- Header -->
    <div style="display:flex;align-items:center;gap:12px;padding:16px 20px 12px;border-bottom:1px solid var(--border);">
      <div id="iem-icon" style="font-size:1.5rem;flex-shrink:0;"></div>
      <div style="flex:1;min-width:0;">
        <div style="font-weight:900;font-size:.95rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" id="iem-title">Edit Item</div>
      </div>
      <button onclick="closeItemEdit()" style="background:var(--bg);border:1px solid var(--border);border-radius:50%;width:30px;height:30px;cursor:pointer;font-size:1.1rem;line-height:1;color:var(--text-2);flex-shrink:0;">âœ•</button>
    </div>

    <div style="padding:16px 20px;display:flex;flex-direction:column;gap:14px;">
      <!-- Time editor -->
      <div>
        <div style="font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:6px;">Start Time</div>
        <input type="time" id="iem-time" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:1rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
      </div>

      <!-- Duration picker -->
      <div>
        <div style="font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:6px;">Duration</div>
        <div style="display:flex;gap:6px;flex-wrap:wrap;" id="iem-dur-btns">
          <button onclick="setItemDuration(30)"  class="iem-dur-btn" data-mins="30">30 min</button>
          <button onclick="setItemDuration(60)"  class="iem-dur-btn" data-mins="60">1 hr</button>
          <button onclick="setItemDuration(90)"  class="iem-dur-btn" data-mins="90">1.5 hrs</button>
          <button onclick="setItemDuration(120)" class="iem-dur-btn" data-mins="120">2 hrs</button>
          <button onclick="setItemDuration(180)" class="iem-dur-btn" data-mins="180">3 hrs</button>
          <button onclick="setItemDuration(480)" class="iem-dur-btn" data-mins="480">All day</button>
        </div>
      </div>

      <!-- AI: Suggest Different Option -->
      <button onclick="suggestItemAlternative()" style="background:var(--purple-l);border:1px solid #c8b4e8;color:var(--purple);border-radius:100px;padding:11px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);width:100%;">ğŸ”„ Suggest a Different Option</button>
      <div id="iem-alt-result" style="display:none;background:var(--bg);border:1.5px solid var(--border);border-radius:12px;padding:12px;font-size:.82rem;color:var(--text);line-height:1.5;"></div>

      <!-- Search / enter a custom place -->
      <div>
        <div style="font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:6px;">Change Place</div>
        <div style="display:flex;gap:6px;">
          <input id="iem-search" type="text" placeholder="Search or type a place nameâ€¦" style="flex:1;padding:10px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.88rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);" onkeydown="if(event.key==='Enter')searchItemPlace()" />
          <button onclick="searchItemPlace()" style="background:var(--blue);color:#fff;border:none;border-radius:100px;padding:10px 14px;font-size:.85rem;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;">ğŸ” Look Up</button>
        </div>
        <div id="iem-search-result" style="display:none;margin-top:8px;background:var(--blue-l);border:1.5px solid var(--blue);border-radius:12px;padding:12px;font-size:.82rem;color:var(--text);line-height:1.5;"></div>
      </div>

      <!-- Notes -->
      <div>
        <div style="font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:6px;">Notes</div>
        <textarea id="iem-notes" rows="2" placeholder="Any notes for this itemâ€¦" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:10px;font-size:.88rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);resize:vertical;box-sizing:border-box;line-height:1.5;"></textarea>
      </div>

      <!-- Action buttons -->
      <div style="display:flex;gap:8px;">
        <button onclick="saveItemEdit()" style="flex:1;background:var(--orange);color:#fff;border:none;border-radius:100px;padding:12px;font-size:.92rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœ“ Save Changes</button>
        <button onclick="removeItemOverride()" title="Reset to defaults" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:12px 14px;font-size:.82rem;cursor:pointer;font-family:var(--font);color:var(--text-2);">â†º Reset</button>
        <button onclick="closeItemEdit()" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:12px 14px;font-size:.82rem;cursor:pointer;font-family:var(--font);color:var(--text-2);">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- PAUSE DAY EDITOR MODAL -->
<div id="pause-day-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:4000;display:flex;align-items:center;justify-content:center;padding:16px;" onclick="if(event.target===this)closePauseDayModal()">
  <div style="background:var(--card);border-radius:var(--radius);padding:22px;max-width:480px;width:100%;box-shadow:0 8px 40px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto;">
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border);">
      <div style="font-size:1.4rem;">â¸ï¸</div>
      <div>
        <div style="font-weight:900;font-size:1rem;color:var(--text);">Pause Trip</div>
        <div style="font-size:.78rem;color:var(--text-2);">Pause the RV trip for any reason. Dates are required â€” flight info is optional.</div>
      </div>
      <button onclick="closePauseDayModal()" style="margin-left:auto;background:var(--bg);border:1px solid var(--border);border-radius:50%;width:28px;height:28px;cursor:pointer;font-size:1rem;line-height:1;color:var(--text-2);">âœ•</button>
    </div>

    <div style="display:flex;flex-direction:column;gap:14px;">
      <!-- Dates (required) -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:120px;">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Trip Pause Start <span style="color:var(--red);">*</span></div>
          <input id="pd-start" type="date" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
        </div>
        <div style="flex:1;min-width:120px;">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Trip Resume <span style="color:var(--red);">*</span></div>
          <input id="pd-end" type="date" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
        </div>
      </div>
      <!-- Optional flight section -->
      <div style="background:var(--bg);border:1px solid var(--border);border-radius:12px;padding:12px 14px;">
        <div style="font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.05em;color:var(--text-2);margin-bottom:10px;">âœˆï¸ Flight Details (optional)</div>
        <!-- Destination -->
        <div style="margin-bottom:10px;">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Flying To</div>
          <input id="pd-destination" type="text" placeholder="e.g. Madrid, Spain" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.95rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
        </div>
        <!-- Departing From -->
        <div>
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Departing From (RV location)</div>
          <input id="pd-from" type="text" placeholder="e.g. Grand Junction, CO" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.95rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
        </div>
      </div>
      <!-- Layover -->
      <div>
        <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Layover City (optional)</div>
        <input id="pd-layover" type="text" placeholder="e.g. Dallas, TX" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.88rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
      </div>
      <!-- Flights -->
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <div style="flex:1;min-width:120px;">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Outbound Flight # (optional)</div>
          <input id="pd-flight-out" type="text" placeholder="e.g. AA1234" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.88rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
        </div>
        <div style="flex:1;min-width:120px;">
          <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Return Flight # (optional)</div>
          <input id="pd-flight-ret" type="text" placeholder="e.g. IB3456" style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:100px;font-size:.88rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;" />
        </div>
      </div>
      <!-- Notes -->
      <div>
        <div style="font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:5px;">Notes (optional)</div>
        <textarea id="pd-notes" rows="2" placeholder="e.g. Park RV at Grand Junction, fly home via Dallas..." style="width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:10px;font-size:.88rem;font-family:var(--font);outline:none;color:var(--text);background:var(--bg);box-sizing:border-box;resize:vertical;"></textarea>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:18px;">
      <button onclick="savePauseDay()" style="flex:1;background:var(--red);color:#fff;border:none;border-radius:100px;padding:12px;font-size:.92rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ”º Save Trip Pause</button>
      <button onclick="closePauseDayModal()" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:12px 18px;font-size:.88rem;cursor:pointer;font-family:var(--font);color:var(--text-2);">Cancel</button>
    </div>
  </div>
</div>

<!-- PLAN DAY PICKER MODAL -->
<div id="plan-day-modal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:4000;display:flex;align-items:center;justify-content:center;" onclick="if(event.target===this)closePlanPicker()">
  <div style="background:var(--card);border-radius:var(--radius);padding:22px;max-width:340px;width:92%;box-shadow:0 8px 40px rgba(0,0,0,.25);">
    <div style="font-weight:800;font-size:1rem;color:var(--text);margin-bottom:4px;" id="pdm-title">Add to Your Plan</div>
    <div style="font-size:.82rem;color:var(--text-2);margin-bottom:14px;" id="pdm-sub">Which day will you do this?</div>
    <div id="pdm-days" style="display:flex;flex-direction:column;gap:7px;max-height:260px;overflow-y:auto;"></div>
    <button onclick="closePlanPicker()" style="margin-top:14px;width:100%;background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:9px;font-size:.88rem;font-weight:600;cursor:pointer;font-family:var(--font);color:var(--text-2);">Cancel</button>
  </div>
</div>

<div id="time-edit-overlay" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:3500;display:flex;align-items:center;justify-content:center;">
  <div style="background:var(--card);border-radius:var(--radius);padding:24px;max-width:300px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,.4);">
    <div id="teo-label" style="font-weight:800;font-size:1rem;margin-bottom:6px;color:var(--text);"></div>
    <div style="font-size:.82rem;color:var(--text-2);margin-bottom:16px;">Edit exact time if you forgot to tap earlier.</div>
    <input type="time" id="teo-time" style="width:100%;padding:10px 14px;border:2px solid var(--orange);border-radius:var(--radius-s);font-size:1.1rem;font-family:var(--font);outline:none;margin-bottom:16px;box-sizing:border-box;">
    <div style="display:flex;gap:10px;">
      <button onclick="confirmTimeEdit()" style="flex:1;padding:10px;background:var(--orange);color:#fff;border:none;border-radius:var(--radius-s);font-family:var(--font);font-size:.9rem;font-weight:800;cursor:pointer;">Save Time</button>
      <button onclick="document.getElementById('time-edit-overlay').classList.add('hidden')" style="padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-s);font-family:var(--font);font-size:.9rem;cursor:pointer;">Cancel</button>
    </div>
  </div>
</div>

<div id="ai-info-modal" class="hidden" onclick="if(event.target===this)closePlaceInfo()">
  <div class="aim-card">
    <div class="aim-header">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div style="flex:1;min-width:0;">
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
            <div style="font-size:.7rem;opacity:.75;font-weight:700;text-transform:uppercase;letter-spacing:.06em;" id="aim-sub"></div>
            <span id="aim-price-badge" style="display:none;background:rgba(255,255,255,.18);color:#fff;font-size:.7rem;font-weight:800;padding:2px 7px;border-radius:100px;border:1px solid rgba(255,255,255,.25);letter-spacing:.02em;"></span>
          </div>
          <div id="aim-weather-row" style="display:none;margin-top:5px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.22);border-radius:12px;padding:6px 11px;display:none;align-items:center;gap:9px;">
            <span id="aim-wx-icon" style="font-size:1.3rem;line-height:1;"></span>
            <div>
              <div id="aim-wx-label" style="font-size:.66rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;opacity:.75;"></div>
              <div id="aim-wx-temps" style="font-size:.8rem;font-weight:800;color:#fff;margin-top:1px;"></div>
              <div id="aim-wx-desc" style="font-size:.72rem;opacity:.8;margin-top:1px;"></div>
            </div>
          </div>
          <div style="font-size:1.05rem;font-weight:900;margin-top:2px;" id="aim-title"></div>
          <div id="aim-rating-row" style="display:none;align-items:center;gap:5px;margin-top:4px;">
            <span id="aim-rating-stars" style="color:#FFD700;font-size:.9rem;letter-spacing:1.5px;line-height:1;"></span>
            <span id="aim-rating-num" style="font-size:.78rem;font-weight:800;color:#fff;"></span>
            <span id="aim-rating-source" style="font-size:.68rem;color:rgba(255,255,255,.55);">Â· Google</span>
          </div>
          <div id="aim-contact-row" style="display:flex;flex-wrap:wrap;gap:12px;margin-top:5px;">
            <a id="aim-address-link" target="_blank" rel="noopener" style="font-size:.75rem;color:#c8e0ff;text-decoration:none;display:none;align-items:center;gap:4px;">&#128205; <span id="aim-address-text"></span></a>
            <a id="aim-phone" style="font-size:.75rem;color:#c8e0ff;display:none;align-items:center;gap:4px;text-decoration:none;" target="_self">&#128222; <span id="aim-phone-text"></span></a>
          </div>
          <a id="aim-official-link" target="_blank" rel="noopener" style="font-size:.74rem;color:#d4b8ff;margin-top:3px;display:block;text-decoration:underline;word-break:break-all;"></a>
          <!-- Reservation buttons (restaurants only) -->
          <div id="aim-reservation-row" style="display:none;gap:6px;flex-wrap:wrap;margin-top:7px;align-items:center;">
            <a id="aim-opentable-btn" target="_blank" rel="noopener" style="display:none;align-items:center;gap:4px;background:#DA3743;color:#fff;border-radius:100px;padding:4px 11px;font-size:.73rem;font-weight:800;text-decoration:none;font-family:-apple-system,sans-serif;white-space:nowrap;">ğŸ½ï¸ OpenTable</a>
            <a id="aim-google-reserve-btn" target="_blank" rel="noopener" style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,.2);color:#fff;border-radius:100px;padding:4px 11px;font-size:.73rem;font-weight:800;text-decoration:none;font-family:-apple-system,sans-serif;border:1px solid rgba(255,255,255,.35);white-space:nowrap;">ğŸ” Reservations</a>
            <span id="aim-no-res-badge" style="display:none;background:rgba(255,255,255,.15);color:#fff;border-radius:100px;padding:4px 11px;font-size:.73rem;font-weight:800;white-space:nowrap;border:1px solid rgba(255,255,255,.3);">ğŸš¶ Walk-ins Only</span>
            <span id="aim-wait-info" style="display:none;background:rgba(255,165,0,.25);color:#ffe082;border-radius:100px;padding:4px 10px;font-size:.73rem;font-weight:700;white-space:nowrap;border:1px solid rgba(255,165,0,.3);">â± ~â€” min wait</span>
          </div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:7px;flex-shrink:0;margin-left:10px;">
          <button onclick="closePlaceInfo()" style="background:rgba(255,255,255,.2);border:none;color:#fff;font-size:1.4rem;line-height:1;width:34px;height:34px;border-radius:50%;cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;">&#215;</button>
          <button id="aim-plan-btn" onclick="" style="display:none;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.3);color:#fff;font-size:.7rem;font-weight:800;padding:5px 10px;border-radius:100px;cursor:pointer;font-family:var(--font);white-space:nowrap;">+ Plan</button>
        </div>
      </div>
    </div>
    <!-- Photo carousel strip (populated by fetchAimPhotos) -->
    <div id="aim-photo-strip" style="display:none;gap:6px;overflow-x:auto;padding:8px 14px 4px;scrollbar-width:none;-webkit-overflow-scrolling:touch;background:rgba(0,0,0,.08);border-top:1px solid rgba(255,255,255,.12);"></div>
    <div class="aim-body" id="aim-body"></div>
    <!-- Fun Facts strip (appended after aim-body content by JS) -->
    <div id="aim-facts-strip" style="display:none;padding:10px 14px 14px;"></div>
  </div>
</div>
<!-- License Plate Gallery Modal -->
<div id="plate-gallery-modal" class="hidden" style="position:fixed;inset:0;background:var(--bg);z-index:5300;display:flex;flex-direction:column;overflow:hidden;">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--border);background:var(--card);flex-shrink:0;">
    <div>
      <div style="font-weight:900;font-size:1rem;color:var(--text);">ğŸš— US License Plates</div>
      <div style="font-size:.74rem;color:var(--text-3);">Reference guide for License Plate Bingo</div>
    </div>
    <button onclick="closePlateGallery()" style="background:var(--bg);border:1px solid var(--border);border-radius:50%;width:32px;height:32px;font-size:1.1rem;cursor:pointer;color:var(--text-2);display:flex;align-items:center;justify-content:center;">&#215;</button>
  </div>
  <div id="plate-gallery-grid" style="flex:1;overflow-y:auto;padding:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;align-content:start;"></div>
</div>

<!-- PHOTO GALLERY MODAL -->
<div id="photo-gallery-modal" class="hidden" style="position:fixed;inset:0;background:var(--bg);z-index:5200;display:flex;flex-direction:column;overflow:hidden;" onclick="">
  <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0;">
    <div style="font-size:1rem;font-weight:900;display:flex;align-items:center;gap:8px;"><i class="fa-solid fa-images" style="color:var(--orange);"></i> Photo Gallery</div>
    <button onclick="closePhotoGallery()" style="background:var(--bg);border:1px solid var(--border);border-radius:50%;width:32px;height:32px;font-size:1.1rem;cursor:pointer;color:var(--text-2);display:flex;align-items:center;justify-content:center;">&#215;</button>
  </div>
  <div id="gallery-filter-row" style="display:flex;gap:6px;overflow-x:auto;padding:10px 14px;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0;scrollbar-width:none;"></div>
  <div id="gallery-grid" style="flex:1;overflow-y:auto;padding:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:4px;align-content:start;"></div>
</div>
<div id="photo-modal" onclick="closePhotoModal()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.88);z-index:9999;align-items:center;justify-content:center;cursor:zoom-out;flex-direction:column;gap:10px;">
  <img id="photo-modal-img" src="" style="max-width:92vw;max-height:80vh;border-radius:8px;box-shadow:0 8px 40px rgba(0,0,0,.6);" />
  <div id="photo-modal-caption" style="color:rgba(255,255,255,.8);font-size:.8rem;text-align:center;max-width:360px;padding:0 16px;line-height:1.5;"></div>
  <button onclick="closePhotoModal()" style="position:absolute;top:18px;right:22px;background:none;border:none;color:#fff;font-size:1.8rem;cursor:pointer;line-height:1;">&times;</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCRIPTS                                                         -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHUNK 2 â€” TRIP DATA
   All stops, all 46 days, restaurants, activities, sleep options
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const FAMILY = {
  drivers: ['Paul', 'Melissa'],
  kids: [
    { name: 'Leila', age: 9, grade: '4th', color: '#E8813A' },
    { name: 'Luna',  age: 4, grade: 'Pre-K', color: '#7B5EA7' },
    { name: 'Eli',   age: 2, grade: 'Toddler', color: '#D4A017' },
  ]
};

/* â”€â”€ STOPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var TRIP_STOPS = [
  {
    id: 1, name: 'Shenandoah Valley', state: 'VA',
    lat: 38.6648, lng: -78.4647,
    emoji: 'ğŸ”ï¸',
    description: 'Stunning Blue Ridge mountain valley with 105-mile Skyline Drive, cascading waterfalls, and Luray Caverns â€” a perfect first night to break up the drive south.',
    highlights: ['Scenic drives', 'Waterfall hikes', 'History & wildlife'],
    activities: [
      { name: 'Skyline Drive', desc: '105-mile scenic ridge road with 75 overlooks. Plan 3â€“4 hours. Kids love spotting deer!', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '3â€“4 hours', website: 'nps.gov/shen' },
      { name: 'Luray Caverns', price: '$$', desc: 'One of the largest caverns in the east â€” massive stalactites and the famous "stalacpipe organ." All ages love it.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: '1.5 hours', website: 'luraycaverns.com' },
      { name: 'Stony Man Trail', desc: 'Easy 1.6-mile loop to summit with panoramic views. Very manageable for all kids.', type: 'hike', kidRating: 5, toddlerOk: true , duration: '1 hour', website: 'nps.gov/shen' },
      { name: 'Picnic at Big Meadows', desc: 'Wide open meadow perfect for running, picnicking, and spotting wildlife at dusk.', type: 'outdoor', kidRating: 5, toddlerOk: true , duration: '1â€“2 hours', website: 'nps.gov/shen' },
    ],
    restaurants: [
      { name: 'Brookside Restaurant', type: 'American', rating: 4.3, price: '$$', desc: 'Classic family roadside diner. Big portions, friendly staff, kids menu.' , hours: '7amâ€“9pm daily', address: '2978 US-211 E, Luray, VA', website: '' },
      { name: 'Gathering Grounds CafÃ©', type: 'CafÃ©', rating: 4.6, price: '$', desc: 'Charming coffee and breakfast spot in downtown Luray. Great pastries.' , hours: '7amâ€“3pm daily', address: '60 W Main St, Luray, VA', website: '' },
      { name: 'Main Street Mill', type: 'American', rating: 4.2, price: '$$', desc: 'Converted mill with local comfort food. Perfect after a hike.' , hours: '11amâ€“9pm Tueâ€“Sun', address: '53 W Main St, Front Royal, VA', website: '' },
      { name: "Dan's Steakhouse", type: 'Steakhouse', rating: 4.4, price: '$$', desc: 'Local favorite, hearty meals, very family-friendly.' },
      { name: 'Farmhouse Kitchen', type: 'Southern', rating: 4.1, price: '$$', desc: 'Home-style Southern cooking with all-day breakfast.' , hours: '7amâ€“2pm daily', address: '20 Mechanic St, Luray, VA', website: '' },
    ],
    sleepOptions: ['Luray RV Resort (full hookups)', 'Shenandoah Valley Campground', 'Elkton / Harrisonburg Walmart'],
    weatherLat: 38.6648, weatherLng: -78.4647,
  },
  {
    id: 2, name: 'Great Smoky Mountains', state: 'TN',
    lat: 35.7143, lng: -83.5102,
    emoji: 'ğŸŒ«ï¸',
    description: "America's most visited national park â€” misty mountain peaks, Cades Cove wildlife loop, stunning waterfalls, and the fun bustle of Gatlinburg and Pigeon Forge.",
    highlights: ['Waterfall hikes', 'Wildlife drives', 'Theme parks', 'Local food & shops'],
    activities: [
      { name: 'Cades Cove Loop', desc: '11-mile scenic loop road. Incredible wildlife â€” deer, turkeys, bears. Go early morning for best sightings. Toddler-friendly from the RV/car.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '2â€“3 hours', website: 'nps.gov/grsm' },
      { name: 'Laurel Falls', desc: 'Most popular waterfall in the park. 2.6-mile paved round trip. Easy for Leila, doable for Luna.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '1.5 hours', website: 'nps.gov/grsm' },
      { name: 'Dollywood', price: '$$$', desc: "One of America's best theme parks. Great for all ages â€” rides for Leila and Luna, character experiences, incredible food.", type: 'attraction', kidRating: 5, toddlerOk: true , duration: 'Full day', website: 'dollywood.com' },
      { name: 'Gatlinburg Strip', desc: "Fun town to walk â€” Ripley's Aquarium, mini golf, salt water taffy shops. Kids love every step.", type: 'town', kidRating: 5, toddlerOk: true , duration: '2â€“3 hours', website: 'gatlinburg.com' },
    ],
    restaurants: [
      { name: "Pancake Pantry", type: 'Breakfast', rating: 4.6, price: '$', desc: 'Gatlinburg institution since 1960. Massive pancake menu. Expect a line â€” worth it.' , hours: '7amâ€“3pm daily', address: '628 Parkway, Gatlinburg, TN', website: 'pancakepantry.com' },
      { name: "Mel's Diner", type: 'American', rating: 4.3, price: '$', desc: 'Classic 50s diner in Pigeon Forge. Kids adore the retro vibe and milkshakes.' },
      { name: 'The Peddler Steakhouse', type: 'Steakhouse', rating: 4.5, price: '$$$', desc: 'Riverside steakhouse with legendary salad bar. Special occasion dinner.' , hours: '4:30â€“9pm daily', address: '820 River Rd, Gatlinburg, TN', website: 'peddlersteakhouse.com' },
      { name: "Crockett's Breakfast Camp", type: 'Breakfast', rating: 4.7, price: '$$', desc: 'Rustic cabin theme, huge breakfasts. A Gatlinburg favorite for families.' },
      { name: 'Ole Smoky BBQ', type: 'BBQ', rating: 4.2, price: '$$', desc: 'Casual smoky BBQ right in Gatlinburg. Great pulled pork and ribs.' , hours: '11amâ€“9pm daily', address: '511 Parkway, Gatlinburg, TN', website: '' },
    ],
    sleepOptions: ['Creekwood Farm RV Park (full hookups)', 'Twin Creek RV Resort', 'Pigeon Forge / Sevierville KOA', 'Walmart Sevierville'],
    weatherLat: 35.7143, weatherLng: -83.5102,
  },
  {
    id: 3, name: 'Ozark Mountains', state: 'AR',
    lat: 36.2298, lng: -93.1077,
    emoji: 'ğŸŒ²',
    description: 'Wild and beautiful Ozark highlands â€” Buffalo National River, dramatic limestone bluffs, crystal-clear swimming holes, and peaceful mountain roads.',
    highlights: ['Buffalo National River', 'Scenic bluffs', 'Caves', 'Small-town charm'],
    activities: [
      { name: 'Buffalo National River', desc: "America's first national river. Canoe or float a section, swim in crystal clear water. Kids absolutely love it.", type: 'outdoor', kidRating: 5, toddlerOk: true , duration: 'Half day', website: 'nps.gov/buff' },
      { name: 'Mystic Caverns', price: '$$', desc: 'Guided cave tours through two connected caves. Kids love the stalactites and cave stories.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: '1.5 hours', website: 'mysticcaverns.com' },
      { name: 'Boxley Valley Scenic Drive', desc: 'Beautiful pastoral valley drive â€” elk herds in the morning are a can\'t-miss. Great from the RV.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '1â€“2 hours', website: 'nps.gov/buff' },
      { name: 'Lost Valley Trail', desc: 'Easy 2-mile loop to Eden Falls cave. Perfect for all kids â€” Leila will want to explore every inch.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '1.5 hours', website: 'nps.gov/buff' },
    ],
    restaurants: [
      { name: "Kelt's Irish Pub & Grille", type: 'American/Irish', rating: 4.4, price: '$$', desc: 'Surprisingly great food in Harrison. Family-friendly pub grub, huge portions.' },
      { name: 'Ozark CafÃ©', type: 'American', rating: 4.3, price: '$', desc: 'Classic small-town diner in Jasper. Legendary pies and homestyle cooking.' , hours: '6amâ€“8pm Monâ€“Sat', address: '107 E Court St, Jasper, AR', website: '' },
      { name: "Cliff House Inn Restaurant", type: 'American', rating: 4.5, price: '$$', desc: 'Stunning bluff-top views. Comfort food with a jaw-dropping backdrop.' , hours: '7amâ€“9pm daily', address: 'Hwy 7 S, Jasper, AR', website: 'cliffhouseinn.net' },
      { name: "Rolando's Nuevo Latino", type: 'Latin', rating: 4.6, price: '$$', desc: 'Excellent tacos and Latin food in Fayetteville if you venture north.' },
      { name: 'Purple Cow Restaurant', type: 'American', rating: 4.2, price: '$', desc: 'Kid-magnet diner â€” great burgers, shakes, and silly purple decor.' , hours: '10:30amâ€“9pm daily', address: 'Multiple AR locations', website: '' },
    ],
    sleepOptions: ['Lost Bridge Village RV Park (full hookups)', 'Withrow Springs State Park', 'Buffalo River Campground', 'Walmart Harrison'],
    weatherLat: 36.2298, weatherLng: -93.1077,
  },
  {
    id: 4, name: 'Texas Hill Country', state: 'TX',
    lat: 30.2752, lng: -98.8720,
    emoji: 'ğŸ¤ ',
    description: 'Rolling hills, wildflower fields, German-heritage towns, and the best BBQ in America. Base in Fredericksburg for wine country, Hamilton Pool, and Austin day trips.',
    highlights: ['Wildflowers', 'Day trips', 'Rock climbing', 'Small-town charm'],
    activities: [
      { name: 'Enchanted Rock State Park', price: '$', desc: 'Massive pink granite dome you can hike up for 360Â° Hill Country views. Leila will summit it, Luna might with help!', type: 'hike', kidRating: 5, toddlerOk: false , duration: '3â€“4 hours', website: 'tpwd.texas.gov' },
      { name: 'Hamilton Pool Preserve', price: '$', desc: 'Stunning natural swimming hole under a limestone grotto. One of Texas\'s most magical spots. Reserve ahead!', type: 'outdoor', kidRating: 5, toddlerOk: true , duration: '2â€“3 hours (reserve ahead!)', website: 'parks.traviscountytx.gov' },
      { name: 'Austin Day Trip', desc: 'Congress Ave bridge bat colony at dusk, South Congress shops, Barton Springs pool, Whole Foods HQ flagship.', type: 'town', kidRating: 5, toddlerOk: true , duration: 'Full day', website: 'austintexas.gov' },
      { name: 'Fredericksburg Main Street', desc: 'Charming German-Texas town with amazing food, shops, and the National Museum of the Pacific War.', type: 'town', kidRating: 4, toddlerOk: true , duration: '2â€“3 hours', website: 'visitfredericksburgtx.com' },
      { name: 'Bluebonnet Wildflower Drive', desc: 'If timing is right (late Marchâ€“April), the highways are covered in Texas bluebonnets. Iconic photo stop!', type: 'scenic', kidRating: 4, toddlerOk: true , duration: '1â€“2 hours', website: '' },
    ],
    restaurants: [
      { name: "Hondo's on Main", type: 'Tex-Mex/American', rating: 4.5, price: '$$', desc: 'Fredericksburg institution. Big outdoor patio, live music, great for families.' },
      { name: 'Rather Sweet Bakery & CafÃ©', type: 'CafÃ©/Bakery', rating: 4.7, price: '$', desc: 'James Beard-nominated bakery. The cookies and kolaches are unforgettable.' , hours: '7amâ€“5pm Tueâ€“Sun', address: '249 E Main St, Fredericksburg, TX', website: 'rathersweet.com' },
      { name: 'Alamo Springs CafÃ©', desc: 'Famous cash-only burger joint near Enchanted Rock. Best burgers in Texas Hill Country.', rating: 4.8, price: '$', type: 'Burgers' , hours: '11amâ€“8pm Wedâ€“Sun (cash only)', address: '107 Alamo Rd, Comfort, TX', website: '' },
      { name: 'Salt Lick BBQ (Driftwood)', type: 'BBQ', rating: 4.6, price: '$$', desc: "Legendary Texas BBQ pit. BYOB, communal picnic tables, all-you-can-eat option. A Texas pilgrimage." , hours: '11amâ€“9:30pm daily', address: '18300 FM 1826, Driftwood, TX', website: 'saltlickbbq.com' },
      { name: 'Perini Ranch Steakhouse', type: 'Steakhouse', rating: 4.7, price: '$$$', desc: "Buffalo Gap â€” worth the drive. Top steakhouse in all of Texas." , hours: '5â€“9pm Friâ€“Sat, Sun lunch', address: '3002 FM 89, Buffalo Gap, TX', website: 'periniranch.com' },
    ],
    sleepOptions: ['Fredericksburg KOA Holiday', 'Lady Bird Lake RV Park (Austin)', 'Llano River RV Park', 'Walmart Fredericksburg'],
    weatherLat: 30.2752, weatherLng: -98.8720,
  },
  {
    id: 5, name: 'Carlsbad Caverns', state: 'NM',
    lat: 32.1479, lng: -104.5567,
    emoji: 'ğŸ¦‡',
    description: 'One of the world\'s most spectacular cave systems â€” a vast underground cathedral with 400,000 Brazilian free-tail bats. An unforgettable night bat flight spectacle.',
    highlights: ['Cave tours', 'Desert landscapes', 'Wildlife spotting'],
    activities: [
      { name: 'Big Room Self-Guided Tour', price: '$$', desc: '1.25-mile paved underground loop â€” the largest cave chamber in North America. Stroller accessible! Kids will be speechless.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: '1.5 hours', website: 'nps.gov/cave' },
      { name: 'Bat Flight Program', desc: "At dusk (Mayâ€“Oct), 400,000 bats spiral out of the cave entrance. One of nature's great wildlife spectacles.", type: 'attraction', kidRating: 5, toddlerOk: true , duration: '1 hour at dusk', website: 'nps.gov/cave' },
      { name: 'Sitting Bull Falls', desc: '50-ft waterfall in the desert â€” a surprising oasis. Short easy walk. Great for a quick splash!', type: 'outdoor', kidRating: 5, toddlerOk: true , duration: '1 hour', website: 'blm.gov' },
      { name: 'White\'s City & Desert Driving', desc: 'Explore the unique Chihuahuan Desert landscape around Carlsbad.', type: 'scenic', kidRating: 3, toddlerOk: true },
    ],
    restaurants: [
      { name: 'Trinity Hotel Restaurant', type: 'American/Steakhouse', rating: 4.5, price: '$$', desc: 'Best dinner in Carlsbad inside a converted 1892 bank. Excellent steaks.' , hours: '11amâ€“9pm Monâ€“Sat', address: '201 S Canal St, Carlsbad, NM', website: 'thetrinityhotel.com' },
      { name: 'Blue House Bakery & CafÃ©', type: 'CafÃ©', rating: 4.6, price: '$', desc: 'Delightful breakfast and lunch spot with fresh pastries and great coffee.' , hours: '7amâ€“3pm Monâ€“Sat', address: '609 N Canyon St, Carlsbad, NM', website: '' },
      { name: 'Red Chimney Pit Bar-B-Que', type: 'BBQ', rating: 4.4, price: '$', desc: 'Old-school Texas BBQ in NM. Smoky, tender, and very kid-friendly.' , hours: '11amâ€“8pm Monâ€“Sat', address: '817 N Canal St, Carlsbad, NM', website: '' },
      { name: 'Yellow Brix Restaurant', type: 'American', rating: 4.3, price: '$$', desc: 'Creative American fare, cozy atmosphere, great for a family dinner.' , hours: '11amâ€“9pm Monâ€“Sat', address: '201 S Canal St, Carlsbad, NM', website: '' },
      { name: "Bamboo Garden", type: 'Chinese', rating: 4.1, price: '$', desc: 'Solid Chinese-American comfort food â€” great when everyone wants something different.' , hours: '11amâ€“9pm daily', address: '1511 S Canal St, Carlsbad, NM', website: '' },
    ],
    sleepOptions: ['Carlsbad RV Park & Campground', "White's City RV Park (near caverns)", 'Brantley Lake State Park', 'Walmart Carlsbad'],
    weatherLat: 32.1479, weatherLng: -104.5567,
  },
  {
    id: 6, name: 'Sedona', state: 'AZ',
    lat: 34.8697, lng: -111.7610,
    emoji: 'ğŸœï¸',
    description: 'Otherworldly red rock formations, spiritual vortexes, and a charming arts town. Sedona is arguably the most beautiful landscape in America â€” the kids will think it\'s Mars.',
    highlights: ['Red rock views', 'Scenic drives', 'Historic chapels', 'Swimming holes'],
    activities: [
      { name: 'Red Rock Scenic Byway (SR 179)', desc: 'Drive through the heart of the red rocks. Cathedral Rock, Bell Rock â€” pull over constantly.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '1â€“2 hours', website: 'visitsedona.com' },
      { name: 'Slide Rock State Park', price: '$', desc: 'Natural water slide carved into red rock canyon. Kids go absolutely nuts for this. One of the best swimming holes in Arizona.', type: 'outdoor', kidRating: 5, toddlerOk: false , duration: '2â€“3 hours', website: 'azstateparks.com' },
      { name: 'Chapel of the Holy Cross', desc: 'Stunning chapel built into a red rock butte. Short walk, jaw-dropping views. Free and open to all.', type: 'attraction', kidRating: 4, toddlerOk: true , duration: '45 min', website: 'chapeloftheholycross.com' },
      { name: 'Uptown Sedona & Tlaquepaque', desc: 'Charming shopping village and art galleries. Great lunch stop, kids love the fountains.', type: 'town', kidRating: 3, toddlerOk: true , duration: '1â€“2 hours', website: 'tlaq.com' },
    ],
    restaurants: [
      { name: 'Coffee Pot Restaurant', type: 'Breakfast', rating: 4.5, price: '$', desc: 'Sedona breakfast institution with 101 types of omelettes. Very family-friendly.' , hours: '6amâ€“2pm daily', address: '2050 W Hwy 89A, Sedona, AZ', website: '' },
      { name: 'Hideaway House', type: 'Italian/Pizza', rating: 4.4, price: '$$', desc: 'Amazing red rock views from the patio. Great pizza and pasta â€” kids will be happy.' , hours: '11amâ€“8:30pm daily', address: 'Country Club Dr, Sedona, AZ', website: 'hideawayhouse.com' },
      { name: 'Oak Creek Brewery & Grill', type: 'American/Brewery', rating: 4.3, price: '$$', desc: 'Casual family pub with excellent burgers, local craft beer, and creek views.' , hours: '11:30amâ€“8pm daily', address: '2050 Yavapai Dr, Sedona, AZ', website: 'oakcreekbrew.com' },
      { name: 'Red Rock CafÃ©', type: 'CafÃ©/American', rating: 4.4, price: '$$', desc: 'Friendly neighborhood spot â€” great sandwiches and salads, chill vibe.' , hours: '7amâ€“3pm daily', address: '275 US-89A, Sedona, AZ', website: '' },
      { name: 'Elote CafÃ©', type: 'Mexican', rating: 4.7, price: '$$', desc: 'Outstanding creative Mexican food. Reserve ahead â€” consistently rated one of Arizona\'s best.' , hours: '5â€“9pm Tueâ€“Sun (reservations essential)', address: '771 Hwy 179, Sedona, AZ', website: 'elotecafe.com' },
    ],
    sleepOptions: ['Rancho Sedona RV Park (along Oak Creek)', 'Sedona RV Resort', 'Cave Springs Campground (Coconino NF)', 'Cottonwood Walmart (~20 min away)'],
    weatherLat: 34.8697, weatherLng: -111.7610,
  },
  {
    id: 7, name: 'Grand Canyon', state: 'AZ',
    lat: 36.0544, lng: -112.2401,
    emoji: 'ğŸï¸',
    description: 'One of the seven natural wonders of the world. No photo, no description, no words prepare you. Stand at the rim and let the kids try to comprehend a mile-deep canyon.',
    highlights: ['Canyon viewpoints', 'Rim Trail walks', 'Sunrise & sunset', 'Desert wildlife'],
    activities: [
      { name: 'Mather Point & Rim Trail', desc: 'The iconic viewpoint. Walk the paved 13-mile Rim Trail (do a section). Sunrise here is life-changing.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '2â€“3 hours', website: 'nps.gov/grca' },
      { name: 'Desert View Drive', desc: '25-mile scenic road along the East Rim with pullouts, a watchtower, and Colorado River views.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '2â€“3 hours', website: 'nps.gov/grca' },
      { name: 'IMAX Film at Grand Canyon Visitor Center', price: '$', desc: 'The "Grand Canyon: The Hidden Secrets" film is spectacular. Great intro for the kids before seeing the real thing.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: '34-min film', website: 'grandcanyonvisitorscenter.com' },
      { name: 'Sunset at Hopi Point', desc: 'Best sunset viewpoint on the South Rim. Arrive 30 min early. The colors are indescribable.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '1 hour', website: 'nps.gov/grca' },
    ],
    restaurants: [
      { name: "Bright Angel Restaurant", type: 'American', rating: 4.2, price: '$$', desc: 'Right on the rim inside the park â€” casual, reliable, good burgers and breakfast. Book in advance.' , hours: '6:30amâ€“10pm daily', address: 'Bright Angel Lodge, Grand Canyon S. Rim', website: 'grandcanyonlodges.com' },
      { name: 'El Tovar Dining Room', type: 'Fine Dining', rating: 4.5, price: '$$$', desc: 'Historic 1905 lodge restaurant on the rim. Special occasion dinner with unforgettable views.' , hours: '6:30â€“11am, 11:30amâ€“2pm, 5â€“10pm', address: 'El Tovar Hotel, South Rim', website: 'grandcanyonlodges.com' },
      { name: 'Canyon Village Market Deli', type: 'Deli/Fast Casual', rating: 4.0, price: '$', desc: 'Quick, affordable, and convenient inside the park. Great for lunches and grab-and-go.' , hours: '8amâ€“8pm daily', address: 'Market Plaza, Grand Canyon Village', website: '' },
      { name: 'Yavapai Lodge Restaurant', type: 'American', rating: 4.1, price: '$$', desc: 'Good all-day dining option inside the park with views.' , hours: '6amâ€“9pm daily', address: 'Yavapai Lodge, Grand Canyon Village', website: '' },
      { name: 'Tusayan restaurants (outside park)', type: 'Various', rating: 4.0, price: '$$', desc: 'Several casual options just south of the park entrance including pizza and Mexican.' , hours: 'Varies', address: 'Hwy 64, Tusayan, AZ', website: '' },
    ],
    sleepOptions: ['Trailer Village RV Park (IN the park!)', 'Ten-X Campground (Kaibab NF)', 'Grand Canyon Camper Village (Tusayan)', 'Williams KOA (~1hr south)'],
    weatherLat: 36.0544, weatherLng: -112.2401,
  },
  {
    id: 8, name: 'Zion National Park', state: 'UT',
    lat: 37.2982, lng: -113.0263,
    emoji: 'ğŸ—¿',
    description: 'Towering sandstone cliffs, emerald pools, and the famous Narrows â€” Zion is spectacular. The free park shuttle makes it incredibly easy with young kids.',
    highlights: ['Canyon views', 'Waterfall pools', 'Scenic drives', 'Shuttle exploration'],
    activities: [
      { name: 'Canyon Overlook Trail', desc: 'Best easy hike in Zion â€” 1-mile round trip to panoramic canyon views. Perfect for the whole family including Luna.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '45 min', website: 'nps.gov/zion' },
      { name: 'Lower Emerald Pool', desc: 'Easy 1.2-mile round trip to a hanging waterfall and pool. Very family-friendly â€” Leila and Luna will love it.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '1 hour', website: 'nps.gov/zion' },
      { name: 'Zion Canyon Shuttle', desc: 'Ride the free park shuttle up and down the canyon, hopping off at viewpoints. Kids love the bus!', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '1â€“3 hours', website: 'nps.gov/zion' },
      { name: 'Pa\'rus Trail', desc: 'Paved 3.5-mile riverside trail. Stroller/wagon friendly. Beautiful and easy. Great for Eli!', type: 'hike', kidRating: 5, toddlerOk: true },
      { name: 'Weeping Rock', desc: 'Short 0.5-mile hike to a "crying" rock alcove with hanging gardens. Magical for kids.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '30 min', website: 'nps.gov/zion' },
    ],
    restaurants: [
      { name: 'Red Rock Grill (Zion Lodge)', type: 'American', rating: 4.3, price: '$$', desc: "Inside the park at Zion Lodge. Breakfast/dinner â€” perfect after a hike." , hours: '6:30amâ€“9pm daily', address: 'Zion Lodge, Zion Canyon, UT', website: 'zionlodge.com' },
      { name: 'OSO Restaurant', type: 'Mexican/American', rating: 4.5, price: '$$', desc: 'Springdale favorite outside the park. Great tacos, family-friendly patio.' , hours: '11:30amâ€“9pm daily', address: '1212 Zion Park Blvd, Springdale, UT', website: '' },
      { name: 'Bit & Spur Restaurant', type: 'Mexican', rating: 4.6, price: '$$', desc: 'Creative Southwestern cuisine in Springdale. Excellent margaritas, great kids menu.' , hours: '5â€“9pm daily (seasonal)', address: '1212 Zion Park Blvd, Springdale, UT', website: 'bitandspur.com' },
      { name: 'Deep Creek Coffee Co.', type: 'CafÃ©', rating: 4.7, price: '$', desc: 'Best coffee near Zion. Also great breakfast burritos and baked goods.' , hours: '6amâ€“5pm daily', address: '932 Zion Park Blvd, Springdale, UT', website: '' },
      { name: 'Springdale Harvest', type: 'Health/Organic', rating: 4.4, price: '$$', desc: 'Fresh organic plates in Springdale. Great for a healthy lunch before a big hike.' , hours: '8amâ€“8pm daily', address: '2481 Zion Park Blvd, Springdale, UT', website: '' },
    ],
    sleepOptions: ['Zion River Resort (full hookups, Springdale)', "Watchman Campground (IN the park)", 'South Campground (Zion NP)', 'St. George KOA (~45 min west)'],
    weatherLat: 37.2982, weatherLng: -113.0263,
  },
  {
    id: 9, name: 'Bryce Canyon', state: 'UT',
    lat: 37.6283, lng: -112.1669,
    emoji: 'ğŸ§¡',
    description: "Not actually a canyon but an amphitheater of thousands of crimson hoodoos â€” otherworldly orange spires that look like a Dr. Seuss dreamscape. Kids will be obsessed.",
    highlights: ['Hoodoo formations', 'Sunrise views', 'Rim Trail walks', 'Stargazing'],
    activities: [
      { name: 'Sunrise & Sunset Points', desc: 'The classic Bryce views. Walk the paved rim path between them at golden hour â€” absolutely magical colors.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '1â€“2 hours', website: 'nps.gov/brca' },
      { name: 'Navajo Loop Trail', desc: '1.3-mile loop down among the hoodoos. Leila will be in heaven scrambling through Wall Street canyon. Stunning.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '1 hour', website: 'nps.gov/brca' },
      { name: 'Stargazing at Bryce', desc: "Bryce Canyon has some of the darkest skies in the US. After dark, the stargazing is absolutely extraordinary.", type: 'outdoor', kidRating: 5, toddlerOk: true , duration: '1â€“2 hours after dark', website: 'nps.gov/brca' },
      { name: 'Mossy Cave Trail', desc: 'Easy 1-mile round trip to a hidden waterfall and cave. Less crowded than other trails.', type: 'hike', kidRating: 5, toddlerOk: false , duration: '45 min', website: 'nps.gov/brca' },
    ],
    restaurants: [
      { name: "Lodge at Bryce Canyon Dining Room", type: 'American', rating: 4.3, price: '$$', desc: 'Cozy lodge restaurant inside the park. Reliable comfort food after a big hike day.' , hours: '7amâ€“9pm daily (seasonal)', address: 'Bryce Canyon National Park, UT', website: 'brycecanyonforever.com' },
      { name: 'Valhalla Pizzeria & Coffee', type: 'Pizza/CafÃ©', rating: 4.4, price: '$', desc: 'Fun pizza place near the park. Kids love the casual atmosphere and good pies.' , hours: '7amâ€“9pm daily (seasonal)', address: 'Bryce Canyon NP, UT', website: '' },
      { name: 'Bryce Canyon Pines Restaurant', type: 'American', rating: 4.2, price: '$$', desc: 'Classic roadside family diner with great homemade pies. Very kid-friendly.' , hours: '7amâ€“9pm daily', address: 'Hwy 12, Bryce, UT', website: '' },
      { name: 'Stone Hearth Grille', type: 'American', rating: 4.3, price: '$$', desc: 'Nice dinner spot in Tropic. Good steaks and mountain comfort food.' , hours: '5â€“9pm daily (seasonal)', address: '1380 N Hwy 12, Tropic, UT', website: '' },
      { name: 'Ebenezer\'s Barn & Grill', type: 'BBQ/Country', rating: 4.5, price: '$$', desc: 'Country BBQ and entertainment â€” live music, dancing, Western fun. Kids will love it.' },
    ],
    sleepOptions: ['Bryce Canyon Pines RV Park', 'Ruby\'s Inn RV Park & Campground (huge, full hookups)', 'North Campground (in park)', 'Sunset Campground (in park)'],
    weatherLat: 37.6283, weatherLng: -112.1669,
  },
  {
    id: 10, name: 'Moab', state: 'UT',
    lat: 38.5733, lng: -109.5498,
    emoji: 'ğŸª¨',
    description: "Red rock adventure capital of the world â€” Arches National Park, Canyonlands, whitewater rafting, and mountain biking. Spring Break starts here! Let loose.",
    highlights: ['Arches & spires', 'Canyon overlooks', 'River views', 'Off-road adventures'],
    activities: [
      { name: 'Arches National Park', desc: 'Over 2,000 natural arches. Drive the main road with many pullouts â€” all family-friendly. Do not miss Delicate Arch at sunset!', type: 'scenic', kidRating: 5, toddlerOk: true , duration: 'Half to full day', website: 'nps.gov/arch' },
      { name: 'Colorado River Jet Boat Tour', desc: 'Thrilling flat-water jet boat tour along the Colorado. All ages welcome. Kids scream with delight.', type: 'outdoor', kidRating: 5, toddlerOk: true , duration: '2 hours', website: 'moabjettours.com' },
      { name: 'Dead Horse Point State Park', desc: 'Dramatic overlook above a horseshoe bend in the Colorado â€” one of the most photographed views in the world.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '1.5 hours', website: 'stateparks.utah.gov' },
      { name: 'Moab Giants Dinosaur Park', desc: 'Outdoor museum with life-size dinosaur sculptures and a real fossil trackway. Eli and Luna will be amazed.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: '1.5â€“2 hours', website: 'moabgiants.com' },
    ],
    restaurants: [
      { name: 'Moab Brewery', type: 'American/Brewery', rating: 4.4, price: '$$', desc: "Moab's original craft brewery. Great burgers, pizzas, and kids menu. Very family-friendly." , hours: '11:30amâ€“9pm daily', address: '686 S Main St, Moab, UT', website: 'moabbrewery.com' },
      { name: "Milt's Stop & Eat", type: 'Burgers/Milkshakes', rating: 4.7, price: '$', desc: 'Legendary Moab burger shack since 1954. Best milkshakes in the desert. Cash only.' },
      { name: "Pasta Jay's", type: 'Italian', rating: 4.4, price: '$$', desc: 'Casual Italian with great pasta and pizza. Perfect for kids.' },
      { name: 'Love Muffin CafÃ©', type: 'Breakfast', rating: 4.6, price: '$', desc: 'Fantastic breakfast burritos and baked goods. The best morning stop before hitting the parks.' , hours: '7amâ€“2pm daily', address: '139 N Main St, Moab, UT', website: '' },
      { name: 'Desert Bistro', type: 'Fine Dining/American', rating: 4.6, price: '$$$', desc: "Moab's best restaurant for a special spring break dinner. Creative American cuisine." , hours: '5:30â€“10pm Tueâ€“Sat', address: '36 S 100 W, Moab, UT', website: 'desertbistro.com' },
    ],
    sleepOptions: ['Moab Valley RV Resort (full hookups)', 'Canyonlands Campground', 'Slickrock Campground', 'Moab Walmart'],
    weatherLat: 38.5733, weatherLng: -109.5498,
  },
  {
    id: 11, name: 'Durango', state: 'CO',
    lat: 37.2753, lng: -107.8801,
    emoji: 'ğŸš‚',
    description: "Charming mountain town with Victorian architecture, the legendary Durango & Silverton Narrow Gauge Railroad, and access to gorgeous San Juan Mountain scenery.",
    highlights: ['Historic railroad', 'Mountain scenery', 'Day trips', 'River walks'],
    activities: [
      { name: 'Durango & Silverton Narrow Gauge Railroad', desc: 'Historic steam train through spectacular mountain canyons to Silverton. Kids absolutely love the steam engine. A bucket-list experience.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: 'Full day (9hr round trip)', website: 'durangotrain.com' },
      { name: 'Animas River Trail', desc: 'Easy paved riverside path through Durango. Great for a family walk or bike ride along the river.', type: 'outdoor', kidRating: 5, toddlerOk: true , duration: '1â€“2 hours', website: 'durangogov.org' },
      { name: 'Purgatory Resort (skiing or scenic)', desc: 'If snow, ski day with the family. If no snow, scenic chairlift and mountain biking.', type: 'outdoor', kidRating: 4, toddlerOk: false , duration: 'Half to full day', website: 'purgatoryresort.com' },
      { name: 'Downtown Durango', desc: 'Walkable Victorian Main Avenue with shops, ice cream, and restaurants. Very charming.', type: 'town', kidRating: 4, toddlerOk: true , duration: '1â€“2 hours', website: 'durango.org' },
      { name: 'Mesa Verde National Park', desc: 'Ancient Ancestral Pueblo cliff dwellings â€” a UNESCO World Heritage Site 35 miles west. Absolutely fascinating for all ages.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: 'Half to full day', website: 'nps.gov/meve' },
    ],
    restaurants: [
      { name: 'Steamworks Brewing', type: 'American/Brewery', rating: 4.5, price: '$$', desc: "Durango's best brewery and pub. Great burgers, nachos, and kids menu." , hours: '11amâ€“10pm daily', address: '801 E 2nd Ave, Durango, CO', website: 'steamworksbrewing.com' },
      { name: 'Serious Texas Bar-B-Q', type: 'BBQ', rating: 4.6, price: '$', desc: 'Best BBQ in the Four Corners region. Huge portions, smoky perfection.' , hours: '11amâ€“8pm Monâ€“Sat', address: '3535 Main Ave, Durango, CO', website: 'serioustexasbbq.com' },
      { name: 'Durango Diner', type: 'American/Breakfast', rating: 4.4, price: '$', desc: 'Classic diner serving Durango since 1990. Huge pancakes, friendly staff.' , hours: '6amâ€“2pm daily', address: '957 Main Ave, Durango, CO', website: '' },
      { name: 'Jean Pierre Bakery', type: 'French Bakery', rating: 4.7, price: '$', desc: 'Outstanding French pastries, croissants, and coffee. Best breakfast treat.' , hours: '6:30amâ€“5:30pm Monâ€“Sat', address: '601 Main Ave, Durango, CO', website: '' },
      { name: 'Guido\'s Favorite Foods', type: 'Italian/Deli', rating: 4.5, price: '$$', desc: 'Fantastic Italian deli and marketplace. Great sandwiches for hiking days.' },
    ],
    sleepOptions: ['Durango North / Ponderosa KOA', 'Durango East Campground', 'Lightner Creek Campground', 'Walmart Durango'],
    weatherLat: 37.2753, weatherLng: -107.8801,
  },
  {
    id: 12, name: 'Oklahoma City', state: 'OK',
    lat: 35.4676, lng: -97.5164,
    emoji: 'ğŸŒ¾',
    description: 'Overnight transit stop on the long drive east. Worth a quick visit to the National Memorial and the fun Bricktown district.',
    highlights: ['Historic memorials', 'Stockyards culture', 'City sights', 'Comfort stop'],
    activities: [
      { name: 'OKC National Memorial & Museum', desc: 'Powerful and moving memorial to the 1995 bombing. Appropriate for Leila â€” an important piece of American history.', type: 'attraction', kidRating: 3, toddlerOk: true , duration: '1.5â€“2 hours', website: 'oklahomacitynationalmemorial.org' },
      { name: 'Bricktown Entertainment District', desc: 'Fun waterfront district with restaurants, canal boats, and activities. Great for a family evening.', type: 'town', kidRating: 4, toddlerOk: true , duration: '1â€“2 hours', website: 'bricktownokc.com' },
      { name: 'Stockyards City', desc: "America's largest cattle market turned visitor attraction. Very authentic Western experience.", type: 'town', kidRating: 4, toddlerOk: true , duration: '1.5 hours', website: 'stockyardscity.org' },
    ],
    restaurants: [
      { name: "Cattlemen's Steakhouse", type: 'Steakhouse', rating: 4.5, price: '$$', desc: "OKC's most famous steakhouse since 1945, in the historic Stockyards." },
      { name: 'Cheever\'s CafÃ©', type: 'American', rating: 4.5, price: '$$', desc: 'Charming neighborhood restaurant in a former flower shop. Creative American cuisine.' },
      { name: 'Mahogany Prime Steakhouse', type: 'Steakhouse', rating: 4.6, price: '$$$', desc: 'If you want a really special dinner on the transit night.' , hours: '5â€“10pm Monâ€“Sat', address: '100 Leadership Sq, Oklahoma City, OK', website: '' },
      { name: 'Irma\'s Burger Shack', type: 'Burgers', rating: 4.5, price: '$', desc: 'Famous cash-only burger spot. Worth the trip.' },
      { name: 'The Garage Burgers and Beer', type: 'Burgers', rating: 4.3, price: '$', desc: 'Family-friendly burger joint in Bricktown â€” easy and fun.' , hours: '11amâ€“10pm daily', address: '309 E Sheridan Ave, Oklahoma City, OK', website: '' },
    ],
    sleepOptions: ['OKC East KOA', 'H&H RV Park', 'Walmart (multiple locations)'],
    weatherLat: 35.4676, weatherLng: -97.5164,
  },
  {
    id: 13, name: 'Kansas City', state: 'MO',
    lat: 39.0997, lng: -94.5786,
    emoji: 'ğŸ·',
    description: "BBQ capital of the world, jazz birthplace, and a surprisingly fun city for families. The City Market, fountains, and world-class BBQ make this a highlight of the return leg.",
    highlights: ["World's best BBQ", 'Jazz history', 'War memorials', 'City culture'],
    activities: [
      { name: 'Kansas City BBQ Crawl', desc: "It's practically required. Hit Joe's KC, Gates, and Jack Stack. Compare brisket. Discuss seriously.", type: 'food', kidRating: 5, toddlerOk: true , duration: '2â€“3 hours', website: 'visitkc.com' },
      { name: 'National WWI Museum', desc: 'One of the most impressive war museums in the world. Great for Leila â€” interactive and moving.', type: 'attraction', kidRating: 4, toddlerOk: false , duration: '2 hours', website: 'theworldwar.org' },
      { name: 'City Market & River Market', desc: 'Huge public market with fresh produce, crafts, and diverse food. Kids love exploring.', type: 'town', kidRating: 4, toddlerOk: true , duration: '1â€“2 hours', website: 'kcrivermarket.com' },
      { name: 'Worlds of Fun Amusement Park', desc: 'Great regional theme park â€” coasters for Leila, Snoopy-themed rides for Luna.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: 'Full day', website: 'worldsoffun.com' },
      { name: 'Country Club Plaza', desc: 'Gorgeous Spanish-inspired outdoor shopping district. Great for a family stroll and ice cream.', type: 'town', kidRating: 3, toddlerOk: true , duration: '1â€“2 hours', website: 'countryclubplaza.com' },
    ],
    restaurants: [
      { name: "Joe's Kansas City BBQ", type: 'BBQ', rating: 4.8, price: '$$', desc: "The #1 BBQ in Kansas City, inside a gas station. Z-Man sandwich is life-changing. LINE OUT THE DOOR." },
      { name: "Jack Stack Barbecue", type: 'BBQ', rating: 4.7, price: '$$', desc: "More upscale KC BBQ experience. The burnt ends are legendary. Great for a family dinner." , hours: '11amâ€“9:30pm daily', address: '4747 Wyandotte St, Kansas City, MO', website: 'jackstackbbq.com' },
      { name: "Gates Bar-B-Q", type: 'BBQ', rating: 4.6, price: '$', desc: "A KC institution since 1946. Staff will yell 'HI MAY I HELP YOU' the moment you walk in. Very fun." , hours: '10amâ€“11pm daily', address: '1026 State Ave, Kansas City, KS', website: 'gatesbbq.com' },
      { name: 'Westport Flea Market Bar & Grill', type: 'Burgers', rating: 4.6, price: '$', desc: 'The best burger in KC â€” giant patties, great atmosphere, family-friendly.' , hours: '10amâ€“1am Monâ€“Sat', address: '817 Westport Rd, Kansas City, MO', website: '' },
      { name: 'Stroud\'s Oak Ridge Manor', type: 'American/Chicken', rating: 4.6, price: '$$', desc: "Famous fried chicken and pan gravy since 1933. A KC tradition. Kids go nuts for it." },
    ],
    sleepOptions: ['Kansas City East KOA', 'Basswood Country RV Resort', 'Paradise Point RV Park', 'Walmart (multiple)'],
    weatherLat: 39.0997, weatherLng: -94.5786,
  },
  {
    id: 14, name: 'Blue Ridge Mountains', state: 'VA',
    lat: 37.2710, lng: -79.9414,
    emoji: 'ğŸ’™',
    description: "The Blue Ridge Parkway â€” America's most scenic highway â€” through rolling Appalachian highlands. Waterfalls, overlooks, and a perfect gentle ending to the western adventure.",
    highlights: ['Parkway drives', 'Waterfall hikes', 'Mountain views', 'Historic sites'],
    activities: [
      { name: 'Blue Ridge Parkway Drives', desc: 'Multiple scenic overlooks and pullouts along the parkway. Stop at Mabry Mill â€” most photographed spot on the parkway.', type: 'scenic', kidRating: 5, toddlerOk: true , duration: '2â€“4 hours', website: 'nps.gov/blri' },
      { name: 'Natural Bridge State Park', desc: '215-foot natural limestone arch â€” one of the natural wonders of the world. Easy walk. Kids are stunned.', type: 'attraction', kidRating: 5, toddlerOk: true , duration: '1.5 hours', website: 'dcr.virginia.gov' },
      { name: 'Roanoke City Market', desc: "Virginia's oldest farmer's market in a charming small city. Great for stocking up for the final drive home.", type: 'town', kidRating: 3, toddlerOk: true , duration: '1 hour', website: 'downtownroanoke.org' },
      { name: 'Explore Park', desc: 'Living history village and nature park along the Blue Ridge â€” family-friendly with easy trails.', type: 'outdoor', kidRating: 4, toddlerOk: true , duration: '2 hours', website: 'roanokeva.gov' },
    ],
    restaurants: [
      { name: 'Local Roots Restaurant', type: 'American/Farm-to-Table', rating: 4.7, price: '$$', desc: "Roanoke's best farm-to-table restaurant. Seasonal menu, warm atmosphere, worth a splurge." , hours: '5â€“9pm Tueâ€“Sat', address: '1314 Grandin Rd SW, Roanoke, VA', website: 'localrootsroanoke.com' },
      { name: 'Fork in the Market', type: 'American', rating: 4.5, price: '$$', desc: 'Beloved Roanoke spot right at the City Market. Great brunch and lunch.' , hours: '8amâ€“2pm daily', address: '204 Market Sq, Roanoke, VA', website: '' },
      { name: 'Texas Tavern', type: 'Diner', rating: 4.4, price: '$', desc: "Open 24/7 since 1930. Only 10 seats. The 'Thousand Island' chili burger is a Roanoke legend." , hours: 'Open 24 hours', address: '114 W Church Ave, Roanoke, VA', website: 'texastavern-inc.com' },
      { name: "Scratch", type: 'American', rating: 4.6, price: '$$', desc: 'Creative seasonal menu from scratch â€” one of the best meals in western Virginia.' , hours: '5â€“9pm Tueâ€“Sat', address: '339 Salem Ave SW, Roanoke, VA', website: '' },
      { name: 'Big Lick Brewing Co.', type: 'Brewery/Pizza', rating: 4.4, price: '$$', desc: 'Great craft brewery with excellent pizza. Very family-friendly atmosphere.' , hours: '12â€“9pm Sunâ€“Thu, 12â€“10pm Friâ€“Sat', address: '409 Salem Ave SW, Roanoke, VA', website: 'biglickbrewing.com' },
    ],
    sleepOptions: ['Blue Ridge Parkway KOA (Fancy Gap)', 'Explore Park Campground', 'Staunton / Waynesboro KOA', 'Walmart Roanoke'],
    weatherLat: 37.2710, weatherLng: -79.9414,
  },
  {
    id: 15, name: 'Warwick, NY', state: 'NY',
    lat: 41.2559, lng: -74.3593,
    emoji: 'ğŸ ',
    description: 'HOME! You made it â€” 46 days, ~7,000 miles, 5 states of mind, and a lifetime of memories.',
    highlights: ['Home sweet home'],
    activities: [
      { name: 'Unpack the RV', desc: 'The bittersweet finale. Sort through 46 days of memories, sand, and snacks.', type: 'other', kidRating: 3, toddlerOk: true },
      { name: 'Share your journey', desc: 'Review the journal, look at photos, pick your top 10 moments.', type: 'other', kidRating: 5, toddlerOk: true },
    ],
    restaurants: [
      { name: 'Your favorite local spot!', type: 'Home', rating: 5.0, price: '$', desc: "After 46 days on the road, home cooking hits different." , hours: 'Whenever!', address: 'Home, Warwick, NY', website: '' },
    ],
    sleepOptions: ['Home!'],
    weatherLat: 41.2559, weatherLng: -74.3593,
  },
];

/* â”€â”€ TYPICAL WEATHER BY STOP (month of visit) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Typical historical highs/lows (Â°F) and conditions for the visit month */
const STOP_WEATHER = {
  1:  { hi:52, lo:34, desc:'Partly cloudy, chilly nights',    icon:'ğŸŒ¤ï¸' }, // Shenandoah, late Feb/Mar
  2:  { hi:59, lo:38, desc:'Mostly cloudy, chance of rain',   icon:'ğŸŒ¦ï¸' }, // Smokies, early Mar
  3:  { hi:57, lo:37, desc:'Mild with occasional showers',    icon:'ğŸŒ§ï¸' }, // Ozarks, mid Mar
  4:  { hi:73, lo:50, desc:'Sunny â€” peak wildflower season!', icon:'â˜€ï¸' },  // TX Hill Country, mid Mar
  5:  { hi:72, lo:44, desc:'Dry and sunny',                   icon:'â˜€ï¸' },  // Guadalupe/Carlsbad, late Mar
  6:  { hi:66, lo:42, desc:'Gorgeous and sunny',              icon:'â˜€ï¸' },  // Sedona, late Mar
  7:  { hi:57, lo:29, desc:'Cool at the Rim, sunny',          icon:'ğŸŒ¤ï¸' }, // Grand Canyon, late Mar
  8:  { hi:64, lo:40, desc:'Warm and sunny',                  icon:'ğŸŒ¤ï¸' }, // Zion/St. George, late Mar
  9:  { hi:50, lo:25, desc:'Snow possible at elevation!',     icon:'â„ï¸' },  // Bryce Canyon, early Apr
  10: { hi:67, lo:40, desc:'Sunny and warm â€” ideal',          icon:'â˜€ï¸' },  // Moab/Arches, Apr
  11: { hi:55, lo:28, desc:'Cool, mountain snow possible',    icon:'ğŸŒ¨ï¸' }, // Durango/Silverton, Apr
  12: { hi:68, lo:46, desc:'Variable spring weather',         icon:'â›…' },  // Oklahoma City, Apr
  13: { hi:65, lo:44, desc:'Spring showers possible',         icon:'ğŸŒ¦ï¸' }, // Kansas City, Apr
  14: { hi:63, lo:40, desc:'Green hills, mild with some rain',icon:'ğŸŒ¦ï¸' }, // Roanoke, Apr
  15: { hi:56, lo:38, desc:'Home sweet home!',                icon:'ğŸŒ¤ï¸' }, // Warwick NY
};

/* â”€â”€ 46-DAY ITINERARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var TRIP_DAYS = [
  // === PHASE 1: SHENANDOAH ===
  { day:1,  date:'2026-02-28', stopId:1,  driveDay:true,  miles:370, driveHours:6,   driver:'Paul',    sleep:'Luray RV Resort',               sleepType:'rv_park',    springBreak:false, phase:'Shenandoah Valley',    title:'Depart Warwick â†’ Shenandoah Valley, VA' },
  { day:2,  date:'2026-03-01', stopId:1,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Luray RV Resort',               sleepType:'rv_park',    springBreak:false, phase:'Shenandoah Valley',    title:'Explore Shenandoah â€” Skyline Drive & Luray Caverns' },
  // === PHASE 2: SMOKY MOUNTAINS ===
  { day:3,  date:'2026-03-02', stopId:2,  driveDay:true,  miles:445, driveHours:7,   driver:'Melissa', sleep:'Creekwood Farm RV Park',         sleepType:'rv_park',    springBreak:false, phase:'Great Smoky Mountains', title:'Shenandoah â†’ Gatlinburg, TN' },
  { day:4,  date:'2026-03-03', stopId:2,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Creekwood Farm RV Park',         sleepType:'rv_park',    springBreak:false, phase:'Great Smoky Mountains', title:'Smokies â€” Cades Cove Loop & Waterfalls' },
  { day:5,  date:'2026-03-04', stopId:2,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Creekwood Farm RV Park',         sleepType:'rv_park',    springBreak:false, phase:'Great Smoky Mountains', title:'Smokies â€” Dollywood Day!' },
  { day:6,  date:'2026-03-05', stopId:2,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Creekwood Farm RV Park',         sleepType:'rv_park',    springBreak:false, phase:'Great Smoky Mountains', title:'Smokies â€” Gatlinburg & Pigeon Forge' },
  // === PHASE 3: OZARKS ===
  { day:7,  date:'2026-03-06', stopId:3,  driveDay:true,  miles:450, driveHours:7,   driver:'Paul',    sleep:'Lost Bridge Village RV Park',    sleepType:'rv_park',    springBreak:false, phase:'Ozark Mountains',       title:'Gatlinburg â†’ Harrison, AR (Ozarks)' },
  { day:8,  date:'2026-03-07', stopId:3,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Lost Bridge Village RV Park',    sleepType:'rv_park',    springBreak:false, phase:'Ozark Mountains',       title:'Ozarks â€” Buffalo National River' },
  { day:9,  date:'2026-03-08', stopId:3,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Lost Bridge Village RV Park',    sleepType:'rv_park',    springBreak:false, phase:'Ozark Mountains',       title:'Ozarks â€” Mystic Caverns & Boxley Valley' },
  { day:10, date:'2026-03-09', stopId:3,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Lost Bridge Village RV Park',    sleepType:'rv_park',    springBreak:false, phase:'Ozark Mountains',       title:'Ozarks â€” Lost Valley Trail & Swimming' },
  // === PHASE 4: TEXAS HILL COUNTRY ===
  { day:11, date:'2026-03-10', stopId:4,  driveDay:true,  miles:490, driveHours:8,   driver:'Paul',    sleep:'Fredericksburg KOA Holiday',     sleepType:'rv_park',    springBreak:false, phase:'Texas Hill Country',    title:'Ozarks â†’ Fredericksburg, TX (Hill Country)' },
  { day:12, date:'2026-03-11', stopId:4,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Fredericksburg KOA Holiday',     sleepType:'rv_park',    springBreak:false, phase:'Texas Hill Country',    title:'Texas â€” Enchanted Rock & Wildflowers' },
  { day:13, date:'2026-03-12', stopId:4,  driveDay:false, miles:150, driveHours:2.5, driver:'Paul',    sleep:'Fredericksburg KOA Holiday',     sleepType:'rv_park',    springBreak:false, phase:'Texas Hill Country',    title:'Austin Day Trip â€” Bats, Barton Springs & South Congress' },
  { day:14, date:'2026-03-13', stopId:4,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Fredericksburg KOA Holiday',     sleepType:'rv_park',    springBreak:false, phase:'Texas Hill Country',    title:'Texas â€” Hamilton Pool & Salt Lick BBQ' },
  // === PHASE 5: CARLSBAD CAVERNS ===
  { day:15, date:'2026-03-14', stopId:5,  driveDay:true,  miles:380, driveHours:6,   driver:'Paul',    sleep:'Carlsbad RV Park & Campground',  sleepType:'rv_park',    springBreak:false, phase:'Carlsbad Caverns',      title:'Texas â†’ Carlsbad, NM' },
  { day:16, date:'2026-03-15', stopId:5,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Carlsbad RV Park & Campground',  sleepType:'rv_park',    springBreak:false, phase:'Carlsbad Caverns',      title:'Carlsbad Caverns â€” Big Room Tour & Bat Flight' },
  // === PHASE 6: SEDONA ===
  { day:17, date:'2026-03-16', stopId:6,  driveDay:true,  miles:430, driveHours:6.5, driver:'Paul',    sleep:'Rancho Sedona RV Park',          sleepType:'rv_park',    springBreak:false, phase:'Sedona',                title:'Carlsbad â†’ Sedona, AZ' },
  { day:18, date:'2026-03-17', stopId:6,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Rancho Sedona RV Park',          sleepType:'rv_park',    springBreak:false, phase:'Sedona',                title:'Sedona â€” Slide Rock & Red Rock Scenic Byway' },
  { day:19, date:'2026-03-18', stopId:6,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Rancho Sedona RV Park',          sleepType:'rv_park',    springBreak:false, phase:'Sedona',                title:'Sedona â€” Bell Rock & Chapel of the Holy Cross' },
  { day:20, date:'2026-03-19', stopId:6,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Rancho Sedona RV Park',          sleepType:'rv_park',    springBreak:false, phase:'Sedona',                title:'Sedona â€” Rest, Vortex, Elote CafÃ© Dinner' },
  // === PHASE 7: GRAND CANYON ===
  { day:21, date:'2026-03-20', stopId:7,  driveDay:true,  miles:115, driveHours:2,   driver:'Paul',    sleep:'Trailer Village RV Park',        sleepType:'rv_park',    springBreak:false, phase:'Grand Canyon',          title:'Sedona â†’ Grand Canyon South Rim' },
  { day:22, date:'2026-03-21', stopId:7,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Trailer Village RV Park',        sleepType:'rv_park',    springBreak:false, phase:'Grand Canyon',          title:'Grand Canyon â€” Mather Point Sunrise & Rim Trail' },
  { day:23, date:'2026-03-22', stopId:7,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Trailer Village RV Park',        sleepType:'rv_park',    springBreak:false, phase:'Grand Canyon',          title:'Grand Canyon â€” Desert View Drive & Bright Angel Top' },
  { day:24, date:'2026-03-23', stopId:7,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Trailer Village RV Park',        sleepType:'rv_park',    springBreak:false, phase:'Grand Canyon',          title:'Grand Canyon â€” Sunset at Hopi Point' },
  // === PHASE 8: ZION ===
  { day:25, date:'2026-03-24', stopId:8,  driveDay:true,  miles:165, driveHours:2.5, driver:'Paul',    sleep:'Zion River Resort',              sleepType:'rv_park',    springBreak:false, phase:'Zion National Park',    title:'Grand Canyon â†’ Zion National Park, UT' },
  { day:26, date:'2026-03-25', stopId:8,  driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Zion River Resort',              sleepType:'rv_park',    springBreak:false, phase:'Zion National Park',    title:'Zion â€” Emerald Pools & Canyon Overlook Trail' },
  { day:27, date:'2026-03-26', stopId:8,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Zion River Resort',              sleepType:'rv_park',    springBreak:false, phase:'Zion National Park',    title:"Zion â€” Pa'rus Trail & Shuttle Exploration" },
  // === PHASE 9: BRYCE CANYON ===
  { day:28, date:'2026-03-27', stopId:9,  driveDay:true,  miles:80,  driveHours:1.5, driver:'Melissa', sleep:"Ruby's Inn RV Park",             sleepType:'rv_park',    springBreak:false, phase:'Bryce Canyon',          title:'Zion â†’ Bryce Canyon, UT' },
  { day:29, date:'2026-03-28', stopId:9,  driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:"Ruby's Inn RV Park",             sleepType:'rv_park',    springBreak:false, phase:'Bryce Canyon',          title:'Bryce Canyon â€” Navajo Loop & Hoodoo Magic' },
  // === PHASE 10: MOAB (SPRING BREAK) ===
  { day:30, date:'2026-03-29', stopId:10, driveDay:true,  miles:215, driveHours:3.5, driver:'Paul',    sleep:'Moab Valley RV Resort',          sleepType:'rv_park',    springBreak:false, phase:'Moab',                  title:'Bryce Canyon â†’ Moab, UT' },
  { day:31, date:'2026-03-30', stopId:10, driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Moab Valley RV Resort',          sleepType:'rv_park',    springBreak:true,  phase:'Moab',                  title:'ğŸŒŸ SPRING BREAK â€” Arches National Park!' },
  { day:32, date:'2026-03-31', stopId:10, driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Moab Valley RV Resort',          sleepType:'rv_park',    springBreak:true,  phase:'Moab',                  title:'ğŸŒŸ SPRING BREAK â€” Delicate Arch & Colorado River' },
  // === PHASE 11: DURANGO (SPRING BREAK) ===
  { day:33, date:'2026-04-01', stopId:11, driveDay:true,  miles:165, driveHours:2.5, driver:'Melissa', sleep:'Durango North / Ponderosa KOA',  sleepType:'rv_park',    springBreak:true,  phase:'Durango, CO',           title:'ğŸŒŸ SPRING BREAK â€” Moab â†’ Durango, CO' },
  { day:34, date:'2026-04-02', stopId:11, driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Durango North / Ponderosa KOA',  sleepType:'rv_park',    springBreak:true,  phase:'Durango, CO',           title:'ğŸŒŸ SPRING BREAK â€” Narrow Gauge Railroad & Mesa Verde' },
  { day:35, date:'2026-04-03', stopId:11, driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Durango North / Ponderosa KOA',  sleepType:'rv_park',    springBreak:true,  phase:'Durango, CO',           title:'ğŸŒŸ SPRING BREAK (Last Day) â€” Animas River & Downtown' },
  // === PHASE 12: MIDWEST TRANSIT ===
  { day:36, date:'2026-04-04', stopId:12, driveDay:true,  miles:520, driveHours:7.5, driver:'Paul',    sleep:'OKC East KOA',                   sleepType:'rv_park',    springBreak:false, phase:'Oklahoma City, OK',     title:'Durango â†’ Oklahoma City, OK (Transit)' },
  { day:37, date:'2026-04-05', stopId:13, driveDay:true,  miles:330, driveHours:5,   driver:'Melissa', sleep:'Kansas City East KOA',           sleepType:'rv_park',    springBreak:false, phase:'Kansas City, MO',       title:'Oklahoma City â†’ Kansas City, MO' },
  { day:38, date:'2026-04-06', stopId:13, driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Kansas City East KOA',           sleepType:'rv_park',    springBreak:false, phase:'Kansas City, MO',       title:"Kansas City â€” BBQ, Jazz & World's Best Burnt Ends" },
  // === PHASE 13: NASHVILLE TRANSIT ===
  { day:39, date:'2026-04-07', stopId:14, driveDay:true,  miles:550, driveHours:8,   driver:'Melissa', sleep:'Walmart Nashville area',          sleepType:'walmart',    springBreak:false, phase:'Nashville, TN',         title:'Kansas City â†’ Nashville, TN (Transit)' },
  // === PHASE 14: BLUE RIDGE ===
  { day:40, date:'2026-04-08', stopId:14, driveDay:true,  miles:400, driveHours:6,   driver:'Paul',    sleep:'Blue Ridge Parkway KOA',         sleepType:'rv_park',    springBreak:false, phase:'Blue Ridge Mountains',  title:'Nashville â†’ Blue Ridge Mountains, VA' },
  { day:41, date:'2026-04-09', stopId:14, driveDay:false, miles:0,   driveHours:0,   driver:'Melissa', sleep:'Blue Ridge Parkway KOA',         sleepType:'rv_park',    springBreak:false, phase:'Blue Ridge Mountains',  title:'Blue Ridge Parkway â€” Mabry Mill & Natural Bridge' },
  { day:42, date:'2026-04-10', stopId:14, driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'Blue Ridge Parkway KOA',         sleepType:'rv_park',    springBreak:false, phase:'Blue Ridge Mountains',  title:'Blue Ridge â€” Cascades Falls & Roanoke City Market' },
  // === RETURN HOME ===
  { day:43, date:'2026-04-11', stopId:15, driveDay:true,  miles:180, driveHours:3,   driver:'Melissa', sleep:'Walmart Fredericksburg, VA',     sleepType:'walmart',    springBreak:false, phase:'Heading Home',          title:'Blue Ridge â†’ Fredericksburg, VA (Final Night Away)' },
  { day:44, date:'2026-04-12', stopId:15, driveDay:true,  miles:270, driveHours:4,   driver:'Paul',    sleep:'HOME!',                          sleepType:'home',       springBreak:false, phase:'Heading Home',          title:'Fredericksburg â†’ Warwick, NY â€” Welcome Home! ğŸ‰' },
  { day:45, date:'2026-04-13', stopId:15, driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'HOME!',                          sleepType:'home',       springBreak:false, phase:'Home',                  title:'Home â€” Unpack, Rest, Relive Memories' },
  { day:46, date:'2026-04-14', stopId:15, driveDay:false, miles:0,   driveHours:0,   driver:'Paul',    sleep:'HOME!',                          sleepType:'home',       springBreak:false, phase:'Home',                  title:'Home â€” Share Your Story' },
];

/* â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getStop(id) { return TRIP_STOPS.find(s => s.id === id); }
function getDay(n)   { return TRIP_DAYS.find(d => d.day === n); }
function isSpringBreak(dateStr) {
  return dateStr >= '2026-03-30' && dateStr <= '2026-04-03';
}
function totalMilesDriven() {
  return TRIP_DAYS.reduce((sum, d) => sum + d.miles, 0);
}
function formatDate(dateStr) {
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
}
/* â”€â”€ SUPABASE CLOUD SYNC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var SUPA_URL = 'https://xsczuyekwtuswiyqtrwh.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhzY3p1eWVrd3R1c3dpeXF0cndoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0NTc0MTcsImV4cCI6MjA4NzAzMzQxN30.7dhQKGAsAWEyHZ53tXMXwBIPBdhVJKCPP6GBgfmLRUY';
var SUPA_TABLE = 'trip_state';
var SUPA_ROW   = 'maass_family';
var _syncTimer  = null;

function _setSyncStatus(icon, text, color) {
  var el = document.getElementById('sync-status');
  if (!el) return;
  el.innerHTML = icon + ' ' + text;
  el.style.color = color || 'rgba(255,255,255,.45)';
}

function _doCloudSave(state) {
  if (_isTestMode || _isViewer) return;
  _setSyncStatus('&#8593;', 'Savingâ€¦', 'rgba(255,255,255,.5)');
  // First check if someone else saved since we loaded
  fetch(SUPA_URL + '/rest/v1/' + SUPA_TABLE + '?id=eq.' + SUPA_ROW + '&select=updated_at,data', {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  })
  .then(function(r) { return r.json(); })
  .then(function(rows) {
    var cloudTs = rows && rows.length ? new Date(rows[0].updated_at || 0).getTime() : 0;
    if (cloudTs > _cloudLoadedAt + 2000) { // 2s buffer for own saves
      // Conflict! Someone else saved more recently
      var theirName = (rows[0].data && rows[0].data._savedBy) ? rows[0].data._savedBy : 'someone else';
      _showConflictBanner(state, rows[0].data, theirName);
      return;
    }
    // No conflict â€” proceed with save
    _doActualCloudSave(state);
  })
  .catch(function() {
    // Offline â€” just save anyway
    _doActualCloudSave(state);
  });
}

function _doActualCloudSave(state) {
  fetch(SUPA_URL + '/rest/v1/' + SUPA_TABLE, {
    method: 'POST',
    headers: {
      'apikey': SUPA_KEY,
      'Authorization': 'Bearer ' + SUPA_KEY,
      'Content-Type': 'application/json',
      'Prefer': 'resolution=merge-duplicates'
    },
    body: JSON.stringify({ id: SUPA_ROW, data: state, updated_at: state._savedAt })
  })
  .then(function(r) {
    if (r.ok) {
      _cloudLoadedAt = new Date(state._savedAt).getTime();
      var savedBy = state._savedBy ? ' (' + state._savedBy + ')' : '';
      _setSyncStatus('&#9729;', 'Saved' + savedBy, 'rgba(255,255,255,.45)');
    } else {
      _setSyncStatus('&#9888;', 'Sync error', 'rgba(255,215,0,.8)');
    }
  })
  .catch(function() { _setSyncStatus('&#9888;', 'Offline', 'rgba(255,215,0,.75)'); });
}

function _showConflictBanner(myState, theirState, theirName) {
  _setSyncStatus('&#9888;', 'Conflict!', 'rgba(255,200,0,.9)');
  // Remove old banner if any
  var old = document.getElementById('conflict-banner');
  if (old) old.remove();
  var banner = document.createElement('div');
  banner.id = 'conflict-banner';
  banner.style.cssText = 'position:fixed;top:56px;left:0;right:0;z-index:4500;'
    + 'background:#d32f2f;color:#fff;padding:12px 16px;'
    + 'display:flex;align-items:center;gap:10px;flex-wrap:wrap;font-size:.85rem;font-weight:600;'
    + 'box-shadow:0 2px 12px rgba(0,0,0,.3);';
  var myName = _userName || 'You';
  var theirTime = theirState && theirState._savedAt ? new Date(theirState._savedAt).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : '';
  banner.innerHTML = '<i class="fa-solid fa-triangle-exclamation" style="font-size:1.2rem;flex-shrink:0;"></i>'
    + '<span style="flex:1;">' + theirName + ' saved changes at ' + theirTime + ' while ' + myName + ' was editing.</span>'
    + '<button onclick="_resolveConflict(\'mine\')" style="background:#fff;color:#d32f2f;border:none;border-radius:100px;padding:7px 14px;font-weight:700;cursor:pointer;font-size:.8rem;">Keep ' + myName + '\'s</button>'
    + '<button onclick="_resolveConflict(\'theirs\')" style="background:rgba(255,255,255,.2);color:#fff;border:1px solid rgba(255,255,255,.5);border-radius:100px;padding:7px 14px;font-weight:700;cursor:pointer;font-size:.8rem;">Take ' + theirName + '\'s</button>';
  document.body.appendChild(banner);
  // Store both states for resolution
  window._conflictMyState = myState;
  window._conflictTheirState = theirState;
}

function _resolveConflict(choice) {
  var banner = document.getElementById('conflict-banner');
  if (banner) banner.remove();
  if (choice === 'mine') {
    // Force-save our version
    _doActualCloudSave(window._conflictMyState);
    showToast('âœ“ Your changes saved â€” overwrote ' + (window._conflictTheirState && window._conflictTheirState._savedBy ? window._conflictTheirState._savedBy + '\'s' : 'their') + ' version', 3000);
  } else {
    // Take their version
    appState = window._conflictTheirState;
    _cloudLoadedAt = new Date((appState._savedAt || 0)).getTime();
    localStorage.setItem('rv_state', JSON.stringify(appState));
    // Re-render everything
    renderDashboard(); renderSchedule(); renderDecisions(); renderSchedule();
    showToast('âœ“ Synced to ' + (appState._savedBy || 'their') + '\'s version', 3000);
    _setSyncStatus('&#9729;', 'Synced', 'rgba(255,255,255,.45)');
  }
  window._conflictMyState = null;
  window._conflictTheirState = null;
}

function syncToCloud(state) {
  if (_isTestMode || _isViewer) return;
  if (_syncTimer) clearTimeout(_syncTimer);
  _syncTimer = setTimeout(function() { _doCloudSave(state); }, 1800);
}

function loadFromCloud(callback) {
  fetch(SUPA_URL + '/rest/v1/' + SUPA_TABLE + '?id=eq.' + SUPA_ROW + '&select=data,updated_at', {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  })
  .then(function(r) { return r.json(); })
  .then(function(rows) {
    if (rows && rows.length && rows[0].data) {
      var remote     = rows[0].data;
      var remoteTs   = new Date(rows[0].updated_at || 0).getTime();
      var localTs    = appState._savedAt ? new Date(appState._savedAt).getTime() : 0;
      _cloudLoadedAt = remoteTs; // remember what we loaded
      if (remoteTs > localTs) {
        appState = remote;
        localStorage.setItem('rv_state', JSON.stringify(appState));
        var byWho = remote._savedBy ? ' by ' + remote._savedBy : '';
        showToast('&#9729;&#65039; Synced from cloud' + byWho + ' â€” up to date!', 2500);
      } else {
        _cloudLoadedAt = localTs; // use local timestamp as baseline
        _setSyncStatus('&#9729;', 'Saved', 'rgba(255,255,255,.45)');
      }
    }
    if (typeof callback === 'function') callback();
  })
  .catch(function() {
    /* Offline or table not yet created â€” just use localStorage */
    _setSyncStatus('&#9888;', 'Offline', 'rgba(255,215,0,.75)');
    if (typeof callback === 'function') callback();
  });
}

/* â”€â”€ EDITABLE STATE (persisted in localStorage + cloud) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadState() {
  try { return JSON.parse(localStorage.getItem('rv_state') || '{}'); }
  catch(e) { return {}; }
}
function saveState(state) {
  if (_isViewer) return; // read-only mode â€” never persist
  state._savedAt = new Date().toISOString();
  if (_userName) state._savedBy = _userName;
  localStorage.setItem('rv_state', JSON.stringify(state));
  syncToCloud(state);
}
var appState = loadState();

function getDayState(day) {
  return appState['day_' + day] || {};
}
function setDayState(day, updates) {
  appState['day_' + day] = Object.assign({}, getDayState(day), updates);
  saveState(appState);
}
function getDayDriver(day) {
  return getDayState(day).driver || TRIP_DAYS[day-1].driver;
}
function getDaySleep(day) {
  return getDayState(day).sleep || TRIP_DAYS[day-1].sleep;
}

/* â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var CONFIG = {
  password:        'rvtrip2026',    // Family password
  friendsPassword: 'maassfriends', // Friends/limited view password
  viewerPassword:  'readonly',     // Read-only full view (all tabs, no edits)
  startDate: '2026-02-28',
  endDate:   '2026-04-14',
  totalDays: 46,
  totalMiles: 7000,
};

/* â”€â”€ BUILTIN TRIP SNAPSHOT (original hardcoded data, never mutated) â”€â”€â”€â”€â”€â”€â”€â”€ */
var _BUILTIN_TRIP = {
  stops:    TRIP_STOPS,
  days:     TRIP_DAYS,
  startDate: '2026-02-28',
  endDate:   '2026-04-14',
  totalDays: 46,
  totalMiles: 7000,
  tripName:  'Maass Family RV 2026'
};

/* â”€â”€ AUTH (in-memory â€” works in all environments incl. sandboxed iframes) â”€â”€ */
var _authed = false;
var _isFriend = false;
var _isTestMode = false;
var _isViewer = false;
var _userName = '';
var _cloudLoadedAt = 0;
var _realAppState = null;

function enterTestMode() {
  _isTestMode = true;
  _authed = true;
  _isFriend = false;
  _realAppState = appState;
  appState = {
    arrivals:{}, departures:{}, dayNotes:{}, planned:{}, weather:{},
    drivers:{}, sleepOverrides:{}, phaseExtraDays:{}, removedStops:{},
    listChecked:{ todo:{}, pack:{} }, listHidden:{ todo:{}, pack:{} },
    customListItems:{ todo:[], pack:[] }, listSortOrder:{ todo:[], pack:[] },
    bookingStatus:{}, customBookings:[], savedPostcards:[], journal:{},
    listsSubTab:'todo', pcBgImage: (_realAppState && _realAppState.pcBgImage) || null,
    aiSuggestions: [
      { id:'test1', title:'Leave Ozarks a day early', detail:'You arrived ahead of schedule. Shorten Ozarks by 1 day to gain buffer time before Texas.', impact:'Gains 1 buffer day', affectedDays:[7,8], sourceDay:7, triggerType:'depart', status:'pending', created: new Date().toISOString() },
      { id:'test2', title:'Add a night in Memphis', detail:'You have extra time â€” Memphis BBQ + Beale Street is an easy add between Ozarks and Texas.', impact:'Adds Memphis detour', affectedDays:[10,11], sourceDay:7, triggerType:'depart', status:'pending', created: new Date().toISOString() },
      { id:'test3', title:'Extend Sedona by 1 day', detail:'The kids love Slide Rock â€” an extra explore day here is always worth it.', impact:'+1 Sedona day', affectedDays:[18,19,20], sourceDay:7, triggerType:'depart', status:'pending', created: new Date().toISOString() }
    ]
  };
  /* patch saveState to no-op so nothing touches localStorage */
  window._origSaveState = window.saveState;
  window.saveState = function(_s) { /* TEST MODE: no-op */ };
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('app').classList.remove('hidden');
  var banner = document.getElementById('test-mode-banner');
  if (banner) banner.classList.remove('hidden');
  initApp();
  updateAdjBadge();
  updateDecisionsBadge();
  showToast('ğŸ§ª Test Mode â€” explore freely, nothing will be saved!', 4000);
}

function exitTestMode() {
  if (_realAppState) appState = _realAppState;
  if (window._origSaveState) {
    window.saveState = window._origSaveState;
    delete window._origSaveState;
  }
  _isTestMode = false;
  _authed = false;
  _realAppState = null;
  document.getElementById('app').classList.add('hidden');
  var banner = document.getElementById('test-mode-banner');
  if (banner) banner.classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
  var pw = document.getElementById('password-input');
  if (pw) { pw.value = ''; pw.focus(); }
  showToast('Exited Test Mode â€” your real plans are safe âœ“', 3000);
}

function checkAuth() { return _authed; }

function _updateHeaderProfile() {
  var chip = document.getElementById('hdr-profile-chip');
  var avatar = document.getElementById('hdr-profile-avatar');
  var nameEl = document.getElementById('hdr-profile-name');
  if (!chip || !nameEl) return;
  if (_userName) {
    // Find profile emoji from appState profiles
    var profiles = (appState && appState.profiles) || [];
    var prof = profiles.find(function(p) { return p.name === _userName; });
    var emoji = prof ? (prof.emoji || 'ğŸ‘¤') : 'ğŸ‘¤';
    avatar.textContent = emoji;
    nameEl.textContent = _userName;
    chip.style.display = 'flex';
  } else {
    chip.style.display = 'none';
  }
}

function doLogin() {
  var val = document.getElementById('password-input').value.trim();
  if (val === CONFIG.password) {
    // Profile required for family login
    if (!window._loginProfile) {
      var err = document.getElementById('login-error');
      err.textContent = 'Please pick who you are first! ğŸ‘†';
      setTimeout(function() { err.textContent = ''; }, 3000);
      // Highlight the profile row
      var profRow = document.querySelector('.login-profiles-row');
      if (profRow) { profRow.style.animation = 'none'; profRow.offsetHeight; profRow.style.animation = 'pulse-border .5s 2'; }
      return;
    }
    _authed = true;
    _isFriend = false;
    _isViewer = false;
    _userName = window._loginProfile || '';
    _saveSession('family', _userName);
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    showToast('&#9729;&#65039; Loading your trip dataâ€¦', 1800);
    loadFromCloud(function() { initApp(); _updateHeaderProfile(); if (_userName) { _setSyncStatus('&#9729;', 'Hi ' + _userName + '!', 'rgba(255,255,255,.7)'); setTimeout(function(){ _setSyncStatus('&#9729;','Saved (' + _userName + ')','rgba(255,255,255,.45)'); }, 2500); } });
  } else if (val === CONFIG.viewerPassword) {
    _authed = true;
    _isFriend = false;
    _isViewer = true;
    _userName = window._loginProfile || '';
    _saveSession('viewer', _userName);
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadFromCloud(function() { initApp(); _updateHeaderProfile(); applyViewerMode(); });
  } else if (val === CONFIG.friendsPassword) {
    _authed = true;
    _isFriend = true;
    _isViewer = false;
    _saveSession('friend', '');
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    loadFromCloud(function() { initApp(); applyFriendMode(); });
  } else {
    var err = document.getElementById('login-error');
    err.textContent = 'Wrong password â€” try again.';
    setTimeout(function() { err.textContent = ''; }, 3000);
    document.getElementById('password-input').value = '';
    document.getElementById('password-input').focus();
  }
}

function selectLoginProfile(name) {
  window._loginProfile = name;
  // Update visual selection
  var btns = document.querySelectorAll('.login-profile-btn');
  for (var bi = 0; bi < btns.length; bi++) btns[bi].classList.remove('selected');
  var btn = document.getElementById('profile-btn-' + name);
  if (btn) btn.classList.add('selected');
}


function applyViewerMode() {
  // Show all tabs (full view), but save is disabled
  var hdr = document.querySelector('.app-header');
  if (hdr) {
    var badge = document.createElement('div');
    badge.id = 'viewer-badge';
    badge.style.cssText = 'background:rgba(255,255,255,.2);color:#fff;font-size:.7rem;font-weight:800;'
      + 'padding:3px 10px;border-radius:100px;margin-left:8px;border:1px solid rgba(255,255,255,.4);';
    badge.textContent = 'ğŸ‘ View Only';
    var title = hdr.querySelector('.header-logo');
    if (title) title.appendChild(badge);
  }
  showToast('ğŸ‘ View-only mode â€” changes won\'t be saved', 3500);
}

document.getElementById('logout-btn').addEventListener('click', function() {
  _authed = false;
  localStorage.removeItem('rv_session');
  document.getElementById('app').classList.add('hidden');
  document.getElementById('login-screen').classList.remove('hidden');
  document.getElementById('password-input').value = '';
});

/* â”€â”€ AUTO-LOGIN: persist session across reloads (30-day TTL) â”€â”€â”€â”€â”€â”€â”€ */
function _saveSession(mode, userName) {
  try {
    localStorage.setItem('rv_session', JSON.stringify({
      mode: mode, userName: userName, savedAt: Date.now()
    }));
  } catch(e) {}
}

function _tryAutoLogin() {
  try {
    var raw = localStorage.getItem('rv_session');
    if (!raw) return false;
    var s = JSON.parse(raw);
    if (!s || !s.mode) return false;
    // 30-day TTL
    if (Date.now() - s.savedAt > 30 * 24 * 60 * 60 * 1000) {
      localStorage.removeItem('rv_session');
      return false;
    }
    _authed   = true;
    _userName = s.userName || '';
    _isFriend = (s.mode === 'friend');
    _isViewer = (s.mode === 'viewer');
    document.getElementById('login-screen').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    if (s.mode === 'family') {
      loadFromCloud(function() {
        initApp(); _updateHeaderProfile();
        if (_userName) { _setSyncStatus('â˜', 'Hi ' + _userName + '!', 'rgba(255,255,255,.7)'); setTimeout(function(){ _setSyncStatus('â˜','Saved (' + _userName + ')','rgba(255,255,255,.45)'); }, 2500); }
      });
    } else if (s.mode === 'viewer') {
      loadFromCloud(function() { initApp(); _updateHeaderProfile(); applyViewerMode(); });
    } else if (s.mode === 'friend') {
      loadFromCloud(function() { initApp(); applyFriendMode(); });
    }
    return true;
  } catch(e) { return false; }
}

/* â”€â”€ VERSION CHECK: poll for new Netlify deploy every 5 minutes â”€â”€â”€ */
var _appEtag = null;
var _updateCheckTimer = null;

/* â”€â”€ Global Escape key handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.addEventListener('keydown', function(e) {
  if (e.key !== 'Escape') return;
  /* Close modals in priority order */
  var closers = [
    function() {
      var m = document.getElementById('ai-info-modal');
      if (m && !m.classList.contains('hidden')) { closePlaceInfo(); return true; }
    },
    function() {
      var m = document.getElementById('day-detail-modal');
      if (m && !m.classList.contains('hidden')) { closeDayDetail(); return true; }
    },
    function() {
      var m = document.getElementById('music-modal');
      if (m && !m.classList.contains('hidden')) { closeLocalMusic(); return true; }
    },
    function() {
      var m = document.getElementById('help-search-overlay');
      if (m && m.style.display !== 'none') { closeHelpSearch(); return true; }
    },
    function() {
      var m = document.getElementById('change-plan-overlay');
      if (m && m.style.display !== 'none') { closeChangePlanModal(); return true; }
    },
    function() {
      var m = document.getElementById('pause-day-modal');
      if (m && !m.classList.contains('hidden')) { closePauseDayModal(); return true; }
    },
    function() {
      var m = document.getElementById('photo-modal');
      if (m && m.style.display !== 'none') { closePhotoModal(); return true; }
    },
    function() {
      var m = document.getElementById('photo-gallery-modal');
      if (m && m.style.display !== 'none') { closePhotoGallery(); return true; }
    },
    function() {
      var m = document.getElementById('forecast-modal-wrapper');
      if (m && m.style.display !== 'none') { _closeForecastModal(); return true; }
    }
  ];
  for (var ci = 0; ci < closers.length; ci++) {
    if (closers[ci]()) { e.preventDefault(); break; }
  }
});

function _initVersionCheck() {
  // Record initial ETag on load
  fetch(location.href + '?_vc=' + Date.now(), { method: 'HEAD', cache: 'no-store' })
    .then(function(r) {
      _appEtag = r.headers.get('etag') || r.headers.get('last-modified') || r.headers.get('content-length') || '';
    })
    .catch(function() {});

  // Poll every 5 minutes
  _updateCheckTimer = setInterval(function() {
    fetch(location.href + '?_vc=' + Date.now(), { method: 'HEAD', cache: 'no-store' })
      .then(function(r) {
        var fresh = r.headers.get('etag') || r.headers.get('last-modified') || r.headers.get('content-length') || '';
        if (_appEtag && fresh && fresh !== _appEtag) {
          clearInterval(_updateCheckTimer);
          document.getElementById('update-banner').style.display = 'flex';
        }
      })
      .catch(function() {});
  }, 5 * 60 * 1000);
}

/* â”€â”€ PAGE LOAD STARTUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
(function() {
  _initVersionCheck();
  if (!_tryAutoLogin()) {
    // No saved session â€” show login screen as normal (it's already visible in HTML)
  }
})();

/* â”€â”€ TAB NAVIGATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
document.querySelectorAll('.nav-tab').forEach(btn => {
  btn.addEventListener('click', function() {
    const tab = this.dataset.tab;
    document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    this.classList.add('active');
    const panel = document.getElementById('tab-' + tab);
    if (panel) {
      panel.classList.remove('hidden'); // critical: remove hidden before adding active
      panel.classList.add('active');
    }
    // Re-render tabs that need fresh data on each visit
    if (tab === 'adjustments') renderAdjustments();
    if (tab === 'decisions')   renderDecisions();
    if (tab === 'postcards')   renderPostcards();
    if (tab === 'lists')       renderLists();
    if (tab === 'fun')         renderFun();
    if (tab === 'gallery')     renderGalleryTab();
    if (tab === 'tools')       { renderTools(); }
    if (tab === 'whatsnew')    { renderWhatsNew(); document.getElementById('whatsnew-dot') && (document.getElementById('whatsnew-dot').style.display='none'); }
    if (tab === 'ideas')       { renderIdeas(); }
    if (tab === 'planner')     { _mainSeg('schedule'); renderSchedule(); }
  });
});

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showToast(msg, duration = 2800) {
  const t = document.getElementById('toast');
  t.innerHTML = msg;  // innerHTML so HTML entities (&#9993; etc.) render as characters
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

/* â”€â”€ UTILS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function tripDay() {
  const now  = new Date();
  const start = new Date(CONFIG.startDate);
  const diff  = Math.floor((now - start) / 86400000) + 1;
  return Math.max(1, Math.min(diff, CONFIG.totalDays));
}
function tripIsLive() {
  // Returns true only if today is on or after the trip start date
  var now   = new Date(); now.setHours(0,0,0,0);
  var start = new Date(CONFIG.startDate + 'T00:00:00');
  return now >= start;
}

function pct() {
  if (!tripIsLive()) return 0;  // 0% until trip actually starts
  const d = tripDay();
  return Math.round((d / CONFIG.totalDays) * 100);
}

/* â”€â”€ TRIP CITY HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Single source of truth: derive start/end city from TRIP_STOPS.
   TRIP_STOPS[0] is always the departure, TRIP_STOPS[last] the arrival.
   Nothing reads appState.tripSettings.startCity/endCity at runtime â€”
   those fields only exist in the Trip Builder (new-trip creation flow).
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _tripCityLabel(s) {
  /* Avoid "Warwick, NY, NY" when stop name already contains the state */
  if (!s) return 'home';
  var stateStr = s.state ? ', ' + s.state : '';
  if (stateStr && s.name.slice(-stateStr.length) === stateStr) return s.name;
  return s.name + stateStr;
}
function _tripHomeStop() {
  for (var _hi = TRIP_DAYS.length - 1; _hi >= 0; _hi--) {
    if (TRIP_DAYS[_hi].sleepType === 'home') return getStop(TRIP_DAYS[_hi].stopId);
  }
  return null;
}
function _sn(stop) {
  if (!stop) return '';
  if (!stop.state) return stop.name || '';
  var suffix = ', ' + stop.state;
  if ((stop.name || '').slice(-suffix.length) === suffix) return stop.name;
  return (stop.name || '') + suffix;
}
function _snE(stop) {
  return stop ? ((stop.emoji ? stop.emoji + ' ' : '') + _sn(stop)) : '';
}
function _tripStartCity() {
  var home = _tripHomeStop();
  if (home) return _tripCityLabel(home);
  return TRIP_STOPS.length ? _tripCityLabel(TRIP_STOPS[0]) : 'home';
}
function _tripIsRoundTrip() {
  if (_tripHomeStop()) return true;
  return TRIP_STOPS.length < 2 || TRIP_STOPS[0].id === TRIP_STOPS[TRIP_STOPS.length - 1].id;
}
function _tripEndCity() {
  return TRIP_STOPS.length ? _tripCityLabel(TRIP_STOPS[TRIP_STOPS.length - 1]) : _tripStartCity();
}
/* _tripIsRoundTrip moved above */

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHUNK 3 â€” DASHBOARD + MAP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ WEATHER LINK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function weatherUrl(stop) {
  return `https://forecast.weather.gov/MapClick.php?lat=${stop.weatherLat}&lon=${stop.weatherLng}`;
}
function openWeatherLink(stopId) {
  const stop = getStop(stopId);
  if (stop) window.open(weatherUrl(stop), '_blank');
}

function fetchTripPrecipitation() {
  showToast('ğŸŒ§ï¸ Fetching precipitation data for all stopsâ€¦', 3000);
  var totalMm = 0;
  var pending = TRIP_STOPS.length;
  if (!pending) return;
  TRIP_STOPS.forEach(function(stop) {
    var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stop.id; });
    if (!stopDays.length) { pending--; if (pending === 0) _savePrecip(totalMm); return; }
    var firstDate = stopDays[0].date;
    var lastDate  = stopDays[stopDays.length - 1].date;
    // Use archive (2025 historical dates mapped to 2026)
    var archStart = firstDate.replace('2026-', '2025-');
    var archEnd   = lastDate.replace('2026-', '2025-');
    var url = 'https://archive-api.open-meteo.com/v1/archive?latitude=' + stop.lat
      + '&longitude=' + stop.lng
      + '&start_date=' + archStart + '&end_date=' + archEnd
      + '&daily=precipitation_sum&timezone=auto';
    fetch(url).then(function(r) { return r.json(); }).then(function(data) {
      if (data.daily && data.daily.precipitation_sum) {
        data.daily.precipitation_sum.forEach(function(v) { if (v != null) totalMm += v; });
      }
      pending--;
      if (pending === 0) _savePrecip(totalMm);
    }).catch(function() { pending--; if (pending === 0) _savePrecip(totalMm); });
  });
}
function _savePrecip(totalMm) {
  var inches = totalMm / 25.4;
  appState.tripPrecipInches = Math.round(inches * 10) / 10;
  saveState();
  renderDashboard();
  showToast('ğŸŒ§ï¸ ' + appState.tripPrecipInches.toFixed(1) + '" total precipitation loaded!', 3000);
}

function _loadStopWeather(stopId) {
  // Load weather for a specific stop and refresh the stops view
  var stop = getStop(stopId);
  if (!stop) return;
  if (!appState.weather) appState.weather = {};
  if (!appState.weather[stopId]) appState.weather[stopId] = {};
  var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  if (!stopDays.length) { showToast('No days scheduled for this stop yet.', 2200); return; }
  var firstDate = stopDays[0].date;
  var lastDate  = stopDays[stopDays.length - 1].date;
  var archStart = firstDate.replace('2026-', '2025-');
  var archEnd   = lastDate.replace('2026-', '2025-');
  showToast('&#127777;&#65039; Loading weather for ' + stop.name + 'â€¦', 2000);
  var archUrl = 'https://archive-api.open-meteo.com/v1/archive?latitude=' + stop.lat
    + '&longitude=' + stop.lng
    + '&start_date=' + archStart + '&end_date=' + archEnd
    + '&daily=temperature_2m_max,temperature_2m_min,weathercode&temperature_unit=fahrenheit&timezone=auto';
  fetch(archUrl).then(function(r){return r.json();}).then(function(data){
    if (!data.daily || !data.daily.time) return;
    for (var di = 0; di < data.daily.time.length; di++) {
      var tripDate = data.daily.time[di].replace('2025-', '2026-');
      appState.weather[stopId][tripDate] = {
        high: Math.round(data.daily.temperature_2m_max[di]),
        low:  Math.round(data.daily.temperature_2m_min[di]),
        code: data.daily.weathercode ? data.daily.weathercode[di] : null,
        type: 'typical'
      };
    }
    saveState(appState);
    renderStops();
    showToast('&#9989; Weather loaded for ' + stop.name, 2000);
  }).catch(function(){
    showToast('&#9888;&#65039; Weather load failed. Check your connection.', 2800);
  });
  // Also try live forecast
  var today = new Date();
  var cutoff = new Date(today); cutoff.setDate(cutoff.getDate() + 16);
  var cutoffStr = cutoff.toISOString().slice(0,10);
  if (firstDate <= cutoffStr) {
    var fUrl = 'https://api.open-meteo.com/v1/forecast?latitude=' + stop.lat
      + '&longitude=' + stop.lng
      + '&daily=temperature_2m_max,temperature_2m_min,weathercode'
      + '&temperature_unit=fahrenheit&timezone=auto&forecast_days=16';
    fetch(fUrl).then(function(r){return r.json();}).then(function(data){
      if (!data.daily || !data.daily.time) return;
      for (var di = 0; di < data.daily.time.length; di++) {
        var fDate = data.daily.time[di];
        if (fDate >= firstDate && fDate <= lastDate) {
          appState.weather[stopId][fDate] = {
            high: Math.round(data.daily.temperature_2m_max[di]),
            low:  Math.round(data.daily.temperature_2m_min[di]),
            code: data.daily.weathercode ? data.daily.weathercode[di] : null,
            type: 'forecast'
          };
        }
      }
      saveState(); renderStops();
    }).catch(function(){});
  }
}

/* â”€â”€ STOP FORECAST MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showStopForecastModal(stopId) {
  var stop = getStop(stopId);
  if (!stop) return;
  var hasData = appState.weather && appState.weather[stopId] && Object.keys(appState.weather[stopId]).length > 0;
  if (hasData) {
    _renderForecastModal(stopId);
  } else {
    // Load first, then show modal
    showToast('ğŸŒ¡ï¸ Loading forecast for ' + stop.name + 'â€¦', 2000);
    _loadStopWeatherSilent(stopId, function() { _renderForecastModal(stopId); });
  }
}

function _loadStopWeatherSilent(stopId, callback) {
  var stop = getStop(stopId);
  if (!stop) return;
  if (!appState.weather) appState.weather = {};
  if (!appState.weather[stopId]) appState.weather[stopId] = {};
  var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  if (!stopDays.length) { showToast('No days scheduled for this stop yet.', 2200); return; }
  var firstDate = stopDays[0].date;
  var lastDate  = stopDays[stopDays.length - 1].date;
  var archStart = firstDate.replace('2026-', '2025-');
  var archEnd   = lastDate.replace('2026-', '2025-');
  var archUrl = 'https://archive-api.open-meteo.com/v1/archive?latitude=' + stop.lat
    + '&longitude=' + stop.lng
    + '&start_date=' + archStart + '&end_date=' + archEnd
    + '&daily=temperature_2m_max,temperature_2m_min,weathercode&temperature_unit=fahrenheit&timezone=auto';
  fetch(archUrl).then(function(r){return r.json();}).then(function(data){
    if (data.daily && data.daily.time) {
      for (var di = 0; di < data.daily.time.length; di++) {
        var tripDate = data.daily.time[di].replace('2025-', '2026-');
        appState.weather[stopId][tripDate] = {
          high: Math.round(data.daily.temperature_2m_max[di]),
          low:  Math.round(data.daily.temperature_2m_min[di]),
          code: data.daily.weathercode ? data.daily.weathercode[di] : null,
          type: 'typical'
        };
      }
    }
    saveState(appState); renderStops();
    if (callback) callback();
  }).catch(function(){
    showToast('âš ï¸ Could not load weather data. Check your connection.', 2800);
    if (callback) callback(); // still open modal with whatever data we have
  });
}

function _renderForecastModal(stopId) {
  var stop = getStop(stopId);
  if (!stop) return;
  var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  var wxData = (appState.weather && appState.weather[stopId]) || {};

  // Weather code to icon+label
  function wxCode(c) {
    if (c === null || c === undefined) return { icon: 'â€”', label: 'Unknown' };
    if (c === 0)  return { icon: 'â˜€ï¸', label: 'Clear' };
    if (c <= 2)   return { icon: 'â›…', label: 'Partly cloudy' };
    if (c <= 49)  return { icon: 'â˜ï¸', label: 'Cloudy/fog' };
    if (c <= 67)  return { icon: 'ğŸŒ§ï¸', label: 'Rain' };
    if (c <= 77)  return { icon: 'â„ï¸', label: 'Snow' };
    return { icon: 'â›ˆï¸', label: 'Storms' };
  }

  var rows = '';
  for (var di = 0; di < stopDays.length; di++) {
    var d = stopDays[di];
    var wx = wxData[d.date];
    var wxi = wx ? wxCode(wx.code) : { icon: 'â€”', label: 'â€”' };
    var badge = (wx && wx.type === 'forecast') ? '<span style="font-size:.6rem;background:#e8f4fd;color:#1a6896;border:1px solid #b0d8f0;border-radius:100px;padding:1px 5px;font-weight:700;">Live</span>' : '';
    rows += '<div style="display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);">'
      + '<div style="font-size:.82rem;color:var(--text);">' + formatDate(d.date) + ' <span style="color:var(--text-3);font-size:.73rem;">Day ' + d.day + '</span> ' + badge + '</div>'
      + '<div style="font-size:1.2rem;">' + wxi.icon + '</div>'
      + '<div style="font-size:.8rem;color:var(--text-2);">' + (wx ? '<strong>' + wx.high + 'Â°</strong> / ' + wx.low + 'Â°' : 'â€”') + '</div>'
      + '<div style="font-size:.72rem;color:var(--text-3);">' + (wx ? wxi.label : 'â€”') + '</div>'
      + '</div>';
  }

  // Remove any existing modal first
  _closeForecastModal();

  var wrapper = document.createElement('div');
  wrapper.setAttribute('data-forecast-modal', '1');
  wrapper.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9500;display:flex;align-items:center;justify-content:center;padding:20px;';
  wrapper.addEventListener('click', function(e) {
    if (e.target === wrapper) _closeForecastModal();
  });

  var inner = document.createElement('div');
  inner.style.cssText = 'background:var(--card);border-radius:16px;max-width:440px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.35);';

  inner.innerHTML = '<div style="background:var(--blue);color:#fff;padding:16px 18px;border-radius:16px 16px 0 0;display:flex;align-items:center;justify-content:space-between;">'
    + '<div><div style="font-size:1.0rem;font-weight:900;">' + stop.emoji + ' ' + _sn(stop) + '</div>'
    + '<div style="font-size:.75rem;opacity:.8;">' + (stopDays.length ? formatDate(stopDays[0].date) + ' â€“ ' + formatDate(stopDays[stopDays.length-1].date) : '') + ' Â· ' + stopDays.length + ' nights Â· Historical/Typical</div></div>'
    + '<button id="forecast-modal-close" style="background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:100px;padding:4px 10px;font-size:.9rem;cursor:pointer;">âœ•</button>'
    + '</div>'
    + '<div style="padding:16px 18px;">'
    + rows
    + '<div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">'
    + '<button id="forecast-modal-refresh" style="flex:1;min-width:140px;display:flex;align-items:center;justify-content:center;gap:7px;padding:9px 14px;background:var(--orange-l);border:1px solid #f0c898;border-radius:100px;font-size:.82rem;font-weight:700;color:var(--orange);cursor:pointer;font-family:var(--font);">ğŸ”„ Refresh Data</button>'
    + '</div></div>';

  wrapper.appendChild(inner);
  document.body.appendChild(wrapper);

  // Wire up close and refresh with real event listeners (no inline onclick)
  document.getElementById('forecast-modal-close').addEventListener('click', _closeForecastModal);
  document.getElementById('forecast-modal-refresh').addEventListener('click', function() {
    showToast('ğŸ”„ Refreshing weather dataâ€¦', 1800);
    _loadStopWeatherSilent(stopId, function() {
      _closeForecastModal();
      _renderForecastModal(stopId);
    });
  });
}

function _closeForecastModal() {
  var els = document.querySelectorAll('[data-forecast-modal]');
  for (var i = 0; i < els.length; i++) els[i].remove();
}

/* â”€â”€ DASHBOARD RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderDashboard() {
  var today    = new Date();
  var start    = new Date(CONFIG.startDate);
  var end      = new Date(CONFIG.endDate);
  var dayNum   = tripDay();
  var dayData  = getDay(dayNum);
  var curStop  = dayData ? getStop(dayData.stopId) : null;
  var sleep    = dayData ? getDaySleep(dayNum)  : 'â€”';
  var daysLeft = Math.max(0, Math.ceil((end - today) / 86400000));

  // â”€â”€ Pre-compute stats (no logic inside template strings) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var milesCompleted = 0;
  for (var mi = 0; mi < Math.min(dayNum, TRIP_DAYS.length); mi++) {
    milesCompleted += TRIP_DAYS[mi].miles;
  }
  var visitedSet = {};
  var stopsVisited = 0;
  for (var vi = 0; vi < Math.min(dayNum, TRIP_DAYS.length); vi++) {
    var sid = TRIP_DAYS[vi].stopId;
    if (sid < 15 && !visitedSet[sid]) { visitedSet[sid] = true; stopsVisited++; }
  }
  stopsVisited = Math.min(stopsVisited, 14);
  var fuelEst = appState.tripStarted
    ? ('$' + Math.round(milesCompleted / 12 * 3.5).toLocaleString())
    : '$0';

  // Photos taken
  var photosCount = 0;
  var jArr = _journalEntries || [];
  for (var jpi = 0; jpi < jArr.length; jpi++) {
    if (jArr[jpi].photos && jArr[jpi].photos.length) photosCount += jArr[jpi].photos.length;
  }

  // Postcards generated
  var postcardsCount = (appState.savedPostcards && appState.savedPostcards.length) || 0;

  // License plates / games played
  var lpCount = 0;
  if (appState.lpChecked) {
    lpCount = typeof appState.lpChecked === 'object' ? Object.keys(appState.lpChecked).length : 0;
  }
  var gamesPlayed = lpCount; // primary game metric

  // Hottest high & coldest low across all weather data
  var tripHigh = null, tripLow = null, tripHighStop = '', tripLowStop = '';
  if (appState.weather) {
    for (var ws in appState.weather) {
      var wStop = getStop(parseInt(ws));
      var wStopName = wStop ? wStop.name : '';
      for (var wd in appState.weather[ws]) {
        var wx = appState.weather[ws][wd];
        if (wx.high != null && (tripHigh === null || wx.high > tripHigh)) { tripHigh = wx.high; tripHighStop = wStopName; }
        if (wx.low  != null && (tripLow  === null || wx.low  < tripLow))  { tripLow  = wx.low;  tripLowStop  = wStopName; }
      }
    }
  }

  // States visited â€” unique states from stops we've reached so far
  var _visitedStateSet = {};
  for (var _vsi = 0; _vsi < Math.min(dayNum, TRIP_DAYS.length); _vsi++) {
    var _vsStop = getStop(TRIP_DAYS[_vsi].stopId);
    if (_vsStop && _vsStop.state) _visitedStateSet[_vsStop.state] = true;
  }
  var _statesList = Object.keys(_visitedStateSet);
  var _statesCount = _statesList.length;
  var _statesSub   = _statesCount > 0 ? _statesList.join(' Â· ') : 'Trip not started yet';

  // Precipitation â€” stored separately after user fetches it
  var _precipIn  = (appState.tripPrecipInches != null) ? parseFloat(appState.tripPrecipInches) : null;
  var _precipVal = _precipIn !== null ? _precipIn.toFixed(1) + '"' : 'â€”';
  var _precipSub = _precipIn !== null ? 'rain &amp; snow combined' : '<button onclick="fetchTripPrecipitation()" style="background:var(--blue-l);border:1px solid #c0d8ec;color:var(--blue);border-radius:100px;font-size:.65rem;font-weight:700;padding:3px 9px;cursor:pointer;font-family:var(--font);">Load Data</button>';

  // â”€â”€ Weather warnings banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Fix: use today's date string as dismiss key so pre-trip dayNum=1 bug can't permanently hide it
  var _todayStr      = today.toISOString().slice(0, 10);
  var _warnDismissed = appState._warnDismissedDate || '';
  var _warnings      = [];

  if (_warnDismissed !== _todayStr) {
    // Collect raw events: { type, icon, label, where, lo, hi }
    // Then group by type+where so multiple days collapse into one chip.
    var _rawEvents = [];

    // 1. Scan live weather for next 14 days
    if (appState.weather) {
      var _liveStart = Math.max(0, dayNum - 1);
      for (var _wi = _liveStart; _wi < Math.min(_liveStart + 14, TRIP_DAYS.length); _wi++) {
        var _wDay  = TRIP_DAYS[_wi];
        if (!_wDay) continue;
        var _wSW   = appState.weather[_wDay.stopId];
        if (!_wSW) continue;
        var _wX    = _wSW[_wDay.date];
        if (!_wX) continue;
        var _wCode = _wX.code;
        var _wHi   = _wX.high;
        var _wLo   = _wX.low;
        var _wStop = getStop(_wDay.stopId);
        var _wWhere= _wStop ? _wStop.name : 'upcoming stop';
        if (_wCode >= 65 && _wCode <= 67) _rawEvents.push({ type:'rain',   icon:'ğŸŒ§ï¸', label:'Heavy Rain',           where:_wWhere });
        if (_wCode >= 71 && _wCode <= 77) _rawEvents.push({ type:'snow',   icon:'â„ï¸',  label:'Snow',                 where:_wWhere });
        if (_wCode >= 95)                 _rawEvents.push({ type:'storm',  icon:'â›ˆï¸',  label:'Severe Thunderstorms', where:_wWhere });
        if (_wHi != null && _wHi >= 100)  _rawEvents.push({ type:'heat',   icon:'ğŸ¥µ',  label:'Extreme Heat',         where:_wWhere, hi:Math.round(_wHi) });
        if (_wLo != null && _wLo <= 36)   _rawEvents.push({ type:'cold',   icon:'ğŸ§Š',  label:'Cold Temperatures',    where:_wWhere, lo:Math.round(_wLo) });
      }
    }

    // 2. Fallback: static STOP_WEATHER for upcoming stops without live data
    var _liveStopsCovered = {};
    if (appState.weather) { for (var _lsc in appState.weather) _liveStopsCovered[_lsc] = true; }
    var _upcomingStopIds  = {};
    for (var _usi = Math.max(0, dayNum - 1); _usi < TRIP_DAYS.length; _usi++) {
      var _usDay = TRIP_DAYS[_usi];
      if (_usDay && !_usDay.driveDay) _upcomingStopIds[_usDay.stopId] = true;
    }
    for (var _stopId in _upcomingStopIds) {
      if (_liveStopsCovered[_stopId]) continue;
      var _sw    = STOP_WEATHER[parseInt(_stopId)];
      if (!_sw) continue;
      var _swStop= getStop(parseInt(_stopId));
      var _swName= _swStop ? _swStop.name : 'Stop #' + _stopId;
      if (_sw.lo <= 36) _rawEvents.push({ type:'cold', icon:'ğŸ§Š', label:'Cold Temperatures', where:_swName, lo:_sw.lo });
      if (_sw.lo <= 15) _rawEvents.push({ type:'cold', icon:'ğŸ¥¶', label:'Extreme Cold',       where:_swName, lo:_sw.lo });
    }

    // 3. Group by type + where â€” one chip per condition per location
    var _grouped = {};
    _rawEvents.forEach(function(e) {
      var key = e.type + '|' + e.where;
      if (!_grouped[key]) {
        _grouped[key] = { icon: e.icon, label: e.label, where: e.where, lo: e.lo, hi: e.hi };
      } else {
        // Keep the most extreme value seen
        if (e.lo !== undefined && (e.lo < (_grouped[key].lo || 999))) _grouped[key].lo = e.lo;
        if (e.hi !== undefined && (e.hi > (_grouped[key].hi || 0)))   _grouped[key].hi = e.hi;
      }
    });
    _warnings = Object.keys(_grouped).map(function(k) { return _grouped[k]; });
  }

  var warnBannerHtml = '';
  if (_warnings.length > 0) {
    warnBannerHtml = '<div id="dash-warn-banner" style="background:var(--red-l);border:1.5px solid rgba(217,79,61,.2);border-left:4px solid var(--red);border-radius:var(--radius);padding:12px 16px;margin-bottom:16px;">'
      + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">'
      + '<div style="font-weight:900;font-size:.85rem;color:var(--red);display:flex;align-items:center;gap:7px;"><i class="fa-solid fa-triangle-exclamation"></i> Weather Alerts â€” Upcoming Stops</div>'
      + '<div style="display:flex;align-items:center;gap:6px;">'
      + '<button onclick="openTripGenie(\'We have weather alerts for upcoming stops on our trip. What should we know and are there any route or schedule adjustments we should consider?\')" title="Ask TripGenie about these alerts" style="display:flex;align-items:center;gap:5px;background:var(--orange-l);border:none;color:var(--orange-d);border-radius:100px;padding:5px 11px;font-size:.72rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;">âœ¨ Ask</button>'
      + '<button onclick="appState._warnDismissedDate=\'' + _todayStr + '\';saveState(appState);document.getElementById(\'dash-warn-banner\').remove()" title="Dismiss for today" style="background:none;border:none;color:var(--text-3);font-size:.8rem;cursor:pointer;padding:4px 6px;border-radius:100px;line-height:1;" onmouseover="this.style.color=\'var(--text)\'" onmouseout="this.style.color=\'var(--text-3)\'">âœ•</button>'
      + '</div>'
      + '</div>'
      + '<div style="display:flex;flex-wrap:wrap;gap:7px;">';
    _warnings.forEach(function(w) {
      var detail = '';
      if (w.lo !== undefined && w.hi !== undefined) detail = ' (' + w.lo + 'Â°â€“' + w.hi + 'Â°F)';
      else if (w.lo !== undefined) detail = ' (low ' + w.lo + 'Â°F)';
      else if (w.hi !== undefined) detail = ' (' + w.hi + 'Â°F)';
      warnBannerHtml += '<div style="background:#fff;border:1px solid rgba(217,79,61,.18);border-radius:20px;padding:5px 12px;font-size:.78rem;font-weight:700;color:var(--text);display:inline-flex;align-items:center;gap:5px;">'
        + w.icon + ' <span style="color:var(--red);font-weight:800;">' + w.label + '</span>' + (detail ? '<span style="color:var(--text-2);font-weight:600;">' + detail + '</span>' : '') + ' <span style="color:var(--text-3);">Â·</span> <span style="color:var(--text-2);">' + w.where + '</span>'
        + '</div>';
    });
    warnBannerHtml += '</div>'
      + '</div>';
  }

  // â”€â”€ Hero banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var heroBanner = '';
  if (today < start) {
    var daysUntil = Math.ceil((start - today) / 86400000);
    var _startBtn = !appState.tripStarted
      ? '<button onclick="startTrip()" style="background:var(--orange);color:#fff;border:none;border-radius:100px;padding:7px 18px;font-size:.82rem;font-weight:900;cursor:pointer;font-family:var(--font);display:inline-flex;align-items:center;gap:6px;box-shadow:0 3px 10px rgba(232,129,58,.4);flex-shrink:0;">ğŸšŒ Start Trip</button>'
      : '<span style="display:inline-block;background:rgba(255,255,255,.15);border-radius:100px;padding:5px 12px;font-size:.76rem;font-weight:700;flex-shrink:0;">âœ… Trip active</span>';

    /* On desktop: countdown pill + alerts on ONE compact row */
    var countdownPill = '<div style="background:linear-gradient(135deg,var(--blue) 0%,#1a3a5c 100%);color:#fff;border-radius:var(--radius);padding:14px 20px;display:flex;align-items:center;gap:14px;flex:1;min-width:220px;">'
      + '<span style="font-size:2rem;flex-shrink:0;">ğŸš</span>'
      + '<div style="flex:1;min-width:0;">'
      + '<div style="font-size:1.1rem;font-weight:800;white-space:nowrap;">Starts in <span style="color:var(--orange);">' + daysUntil + '</span> day' + (daysUntil===1?'':'s') + '</div>'
      + '<div style="opacity:.75;font-size:.78rem;">Departing ' + _tripStartCity() + ' Â· ' + formatDate(CONFIG.startDate) + '</div>'
      + '</div>'
      + _startBtn
      + '</div>';

    if (warnBannerHtml) {
      /* Side-by-side on desktop, stacked on mobile */
      heroBanner += '<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;align-items:stretch;">'
        + countdownPill
        + '<div style="flex:2;min-width:260px;">' + warnBannerHtml.replace(/margin-bottom:[^;]+;/,'') + '</div>'
        + '</div>';
    } else {
      heroBanner += '<div style="margin-bottom:16px;">' + countdownPill + '</div>';
    }
  } else if (today > end) {
    heroBanner += '<div style="background:linear-gradient(135deg,var(--green) 0%,#1a4a30 100%);color:#fff;border-radius:var(--radius);padding:28px 32px;margin-bottom:20px;display:flex;align-items:center;gap:20px;">'
      + '<span style="font-size:3rem">ğŸ </span><div>'
      + '<div style="font-size:1.5rem;font-weight:800;margin-bottom:4px">Welcome home, Maass family!</div>'
      + '<div style="opacity:.8">46 days, ~7,000 miles, and a lifetime of memories. What an adventure.</div>'
      + '</div></div>';
  }

  // â”€â”€ Today card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var springBadge = dayData && dayData.springBreak
    ? '<span class="badge badge-purple" style="font-size:.8rem;padding:5px 12px"><i class="fa-solid fa-star"></i> Spring Break!</span>' : '';

  /* â”€â”€ Weather snippet for tonight's stop â”€â”€ */
  var _destWxHi = null, _destWxLo = null, _destWxIcon = '', _destWxDesc = '';
  if (curStop) {
    var _dLiveWx = (appState.weather && appState.weather[curStop.id] && dayData)
      ? appState.weather[curStop.id][dayData.date] : null;
    var _dStatWx = STOP_WEATHER[curStop.id] || null;
    if (_dLiveWx) {
      _destWxHi   = _dLiveWx.high;
      _destWxLo   = _dLiveWx.low;
      if (_dLiveWx.code != null) {
        var _dc = _dLiveWx.code;
        _destWxIcon = _dc===0?'â˜€ï¸':_dc<=2?'â›…':_dc<=49?'â˜ï¸':_dc<=67?'ğŸŒ§ï¸':_dc<=77?'â„ï¸':'â›ˆï¸';
      }
    } else if (_dStatWx) {
      _destWxHi   = _dStatWx.hi;
      _destWxLo   = _dStatWx.lo;
      _destWxIcon = _dStatWx.icon || 'ğŸŒ¡ï¸';
      _destWxDesc = _dStatWx.desc || '';
    }
  }
  var _destWxRange = (_destWxLo !== null && _destWxHi !== null)
    ? _destWxIcon + ' ' + Math.round(_destWxLo) + 'Â°â€“' + Math.round(_destWxHi) + 'Â°F'
    : '';
  var _destIsHome  = !curStop || (today < start);
  var _destLabel   = _destIsHome ? '<i class="fa-solid fa-house"></i> Home' : (curStop.emoji + ' ' + curStop.name + ', ' + curStop.state);
  var _destSub     = _destIsHome ? 'Before the adventure begins!' : (sleep || '');
  var _destFcstBtn = (!_destIsHome && curStop)
    ? ' <span style="font-size:.68rem;color:var(--green);font-weight:700;white-space:nowrap;">â˜ï¸ tap for forecast</span>'
    : '';

  /* â”€â”€ Tonight card: compact 3-box row (Destination | Sleep | Weather) â”€â”€ */
  var _wxBox = _destWxRange
    ? (_destWxRange + (_destWxDesc ? '<div style="font-size:.68rem;color:var(--text-2);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + _destWxDesc + '</div>' : ''))
    : '<span style="color:var(--text-3);font-size:.78rem;">Tap for forecast</span>';
  var _boxStyle = 'flex:1;min-width:0;padding:10px 12px;border-radius:var(--radius-s);text-align:center;cursor:pointer;';
  var tonightTile = (!_destIsHome && curStop)
    ? '<div style="display:flex;gap:8px;margin-top:12px;">'
      + '<div style="' + _boxStyle + 'background:var(--green-l);border:1px solid #a5d6a7;" onclick="showStopForecastModal(' + curStop.id + ')" title="Tap for weather forecast">'
        + '<div style="font-size:.6rem;font-weight:800;color:#2e7d32;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">Destination</div>'
        + '<div style="font-weight:800;font-size:.85rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + _destLabel + '</div>'
      + '</div>'
      + '<div style="' + _boxStyle + 'background:var(--blue-l);border:1px solid rgba(44,95,138,.2);" onclick="openCampInfo(' + dayNum + ')" title="Tap for AI campground info">'
        + '<div style="font-size:.6rem;font-weight:800;color:var(--blue);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">Sleep âœ¨</div>'
        + '<div style="font-weight:700;font-size:.82rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + (_destSub || 'â€”') + '</div>'
      + '</div>'
      + '<div style="' + _boxStyle + 'background:var(--orange-l);border:1px solid rgba(232,129,58,.25);" onclick="showStopForecastModal(' + curStop.id + ')" title="Tap for weather forecast">'
        + '<div style="font-size:.6rem;font-weight:800;color:var(--orange-d);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">Tonight\'s Weather</div>'
        + '<div style="font-weight:700;font-size:.82rem;color:var(--text);">' + _wxBox + '</div>'
      + '</div>'
      + '</div>'
    : (function() {
        /* Pre-trip: show first stop info with real weather if loaded */
        var _fs      = TRIP_STOPS.find(function(s){return s.id===1;}) || TRIP_STOPS[0];
        var _fsId    = _fs ? _fs.id : 1;
        var _fsDay1  = TRIP_DAYS[0]; // Day 1 date
        /* Prefer live/forecast weather from appState, fall back to static STOP_WEATHER */
        var _fsWxLive = (appState.weather && appState.weather[_fsId] && _fsDay1)
          ? appState.weather[_fsId][_fsDay1.date] : null;
        var _fsWxLabel = '';
        var _fsWxStr   = 'â€”';
        if (_fsWxLive && _fsWxLive.high != null) {
          var _wxIcons = [null,'â˜€ï¸','ğŸŒ¤ï¸','â›…','ğŸŒ¥ï¸','','','','','ğŸŒ«ï¸','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','','ğŸŒ§ï¸','','','','','ğŸŒ¨ï¸','','','ğŸŒ©ï¸'];
          var _wIc = (_fsWxLive.code != null && _wxIcons[_fsWxLive.code]) ? _wxIcons[_fsWxLive.code] : 'ğŸŒ¡ï¸';
          _fsWxStr   = _wIc + ' ' + _fsWxLive.high + 'Â° / ' + _fsWxLive.low + 'Â°F';
          _fsWxLabel = _fsWxLive.type === 'forecast' ? 'Day 1 Forecast' : 'Typical Weather';
        } else {
          var _fsWxFallback = (STOP_WEATHER && STOP_WEATHER[_fsId]) || {};
          if (_fsWxFallback.icon && _fsWxFallback.lo != null) {
            _fsWxStr   = _fsWxFallback.icon + ' ' + Math.round(_fsWxFallback.lo) + 'Â°â€“' + Math.round(_fsWxFallback.hi) + 'Â°F';
            _fsWxLabel = 'Typical Weather';
          } else {
            _fsWxLabel = 'Typical Weather';
          }
        }
        var _fsName  = _fs ? (_fs.emoji + ' ' + _fs.name + ', ' + _fs.state) : 'Shenandoah Valley, VA';
        var _fsSleep = _fsDay1 ? (_fsDay1.sleep || 'First campground') : 'Luray RV Resort';
        return '<div style="display:flex;gap:8px;margin-top:12px;">'
          + '<div style="' + _boxStyle + 'background:var(--green-l);border:1px solid #a5d6a7;cursor:pointer;" onclick="showStopForecastModal(' + _fsId + ')">'
            + '<div style="font-size:.6rem;font-weight:800;color:#2e7d32;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">First Stop</div>'
            + '<div style="font-weight:800;font-size:.78rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + _fsName + '</div>'
          + '</div>'
          + '<div style="' + _boxStyle + 'background:var(--blue-l);border:1px solid rgba(44,95,138,.2);cursor:pointer;" onclick="openCampInfo(1)" title="Tap for AI campground info">'
            + '<div style="font-size:.6rem;font-weight:800;color:var(--blue);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">Sleep âœ¨</div>'
            + '<div style="font-weight:700;font-size:.76rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + _fsSleep + '</div>'
          + '</div>'
          + '<div style="' + _boxStyle + 'background:var(--orange-l);border:1px solid rgba(232,129,58,.25);cursor:pointer;" onclick="showStopForecastModal(' + _fsId + ')">'
            + '<div style="font-size:.6rem;font-weight:800;color:var(--orange-d);text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px;">' + _fsWxLabel + '</div>'
            + '<div style="font-weight:700;font-size:.8rem;color:var(--text);">' + _fsWxStr + '</div>'
          + '</div>'
          + '</div>';
      })();

  var todayCard = '';
  if (dayData) {
    todayCard = '<div class="card" style="margin-bottom:16px;">'
      + '<div class="card-header" style="background:linear-gradient(135deg,var(--blue) 0%,#1a3a5c 100%);color:#fff;border:none;display:flex;align-items:center;flex-wrap:wrap;gap:8px;">'
      + '<div class="card-title" style="color:#fff;margin:0;"><i class="fa-solid fa-calendar-day" style="color:var(--orange)"></i> Day ' + dayNum + ' of ' + TRIP_DAYS.length + ' â€” ' + formatDate(dayData.date) + '</div>'
      + springBadge + '</div>'
      + '<div class="card-body">'
      + '<div style="font-size:1.2rem;font-weight:700;margin-bottom:16px;color:var(--text);">' + dayData.title + '</div>'
      + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">'
      + '<div style="text-align:center;padding:14px;background:var(--orange-l);border-radius:var(--radius-s);"><div style="font-size:1.4rem;font-weight:800;color:var(--orange-d)">' + (dayData.miles || 'â€”') + '</div><div style="font-size:.75rem;color:var(--text-2);font-weight:600">Miles Today</div></div>'
      + '<div style="text-align:center;padding:14px;background:var(--blue-l);border-radius:var(--radius-s);"><div style="font-size:1.4rem;font-weight:800;color:var(--blue)">' + (dayData.driveHours || '0') + 'h</div><div style="font-size:.75rem;color:var(--text-2);font-weight:600">Drive Time</div></div>'
      + '</div>'
      + tonightTile
      + '</div></div>';
  }

  // â”€â”€ Stats row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var milesVal  = appState.tripStarted ? milesCompleted.toLocaleString() : '0';
  var milesSub  = 'of ~' + CONFIG.totalMiles.toLocaleString() + ' total';
  var _si = function(cls) { return '<i class="fa-solid ' + cls + '"></i>'; };
  // Journal entries count (loaded from localStorage same way as renderJournal)
  var _journalCount = 0;
  try { var _jRaw = localStorage.getItem('rv_journal'); _journalCount = _jRaw ? JSON.parse(_jRaw).length : 0; } catch(e) {}

  // Peak elevation across planned stops (~9,105 ft at Bryce Canyon, highest planned stop)
  var _peakElevFt = 9105;
  var _peakElevStop = 'Bryce Canyon';

  var statsRow = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;margin-bottom:20px;">'
    + '<div class="stat-card"><div class="stat-icon">' + _si('fa-road') + '</div><div class="stat-label">Miles Driven</div><div class="stat-value">' + milesVal + '</div><div class="stat-sub">' + milesSub + '</div></div>'
    + '<div class="stat-card"><div class="stat-icon">' + _si('fa-calendar-day') + '</div><div class="stat-label">Days on Road</div><div class="stat-value">' + (appState.tripStarted ? dayNum : 0) + '</div><div class="stat-sub">' + (appState.tripStarted ? daysLeft + ' left' : 'Not started') + '</div></div>'
    + '<div class="stat-card" onclick="switchTab(\'journal\')" style="cursor:pointer;"><div class="stat-icon">' + _si('fa-book') + '</div><div class="stat-label">Journal Entries</div><div class="stat-value">' + _journalCount + '</div><div class="stat-sub">days written</div></div>'
    + '<div class="stat-card" onclick="switchTab(\'journal\')" style="cursor:pointer;"><div class="stat-icon">' + _si('fa-camera') + '</div><div class="stat-label">Photos Taken</div><div class="stat-value">' + photosCount + '</div><div class="stat-sub">in entries</div></div>'
    + '<div class="stat-card" onclick="switchTab(\'postcards\')" style="cursor:pointer;"><div class="stat-icon">' + _si('fa-envelope') + '</div><div class="stat-label">Postcards Sent</div><div class="stat-value">' + postcardsCount + '</div><div class="stat-sub">created &amp; saved</div></div>'
    + '<div class="stat-card" title="' + _statesList.join(', ') + '"><div class="stat-icon">' + _si('fa-map') + '</div><div class="stat-label">States Visited</div><div class="stat-value">' + (_statesCount || 'â€”') + '</div><div class="stat-sub" style="font-size:.68rem;line-height:1.4;overflow:hidden;max-height:2.8em;">' + _statesSub + '</div></div>'
    + '<div class="stat-card"><div class="stat-icon">' + _si('fa-gas-pump') + '</div><div class="stat-label">Est. Fuel Cost</div><div class="stat-value">' + fuelEst + '</div><div class="stat-sub">~12 mpg Â· $3.50/gal</div></div>'
    + '<div class="stat-card"><div class="stat-icon">' + _si('fa-mountain') + '</div><div class="stat-label">Peak Elevation</div><div class="stat-value" style="font-size:1.15rem;">' + _peakElevFt.toLocaleString() + ' ft</div><div class="stat-sub">' + _peakElevStop + '</div></div>'
    + '</div>';

  // â”€â”€ Up next cards (pre-built, no logic in template) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var upcoming = TRIP_DAYS.slice(dayNum, Math.min(dayNum + 3, 46));
  var upNextHtml = '';
  if (upcoming.length) {
    var upCards = '';
    for (var ui = 0; ui < upcoming.length; ui++) {
      var ud = upcoming[ui];
      var us = getStop(ud.stopId);
      var uEmoji = us ? us.emoji + ' ' + us.name : 'En Route';
      var uBreak = ud.springBreak ? '<span class="badge badge-purple"><i class="fa-solid fa-star"></i> Break</span>' : '';
      var uDrive = ud.driveDay
        ? '<div style="font-size:.78rem;color:var(--orange);margin-top:4px;font-weight:600"><i class="fa-solid fa-car-side"></i> Drive â€” ' + ud.miles + ' mi / ' + ud.driveHours + 'h</div>'
        : '<div style="font-size:.78rem;color:var(--green);margin-top:4px;font-weight:600"><i class="fa-solid fa-campground"></i> Explore day</div>';
      upCards += '<div class="card" style="cursor:pointer;" onclick="openDayDetail(' + ud.day + ')">'
        + '<div class="card-body" style="padding:14px;">'
        + '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;"><span class="badge badge-blue">Day ' + ud.day + '</span>' + uBreak + '</div>'
        + '<div style="font-weight:700;font-size:.9rem;margin-bottom:4px;line-height:1.3">' + uEmoji + '</div>'
        + '<div style="font-size:.78rem;color:var(--text-2)">' + formatDate(ud.date) + '</div>'
        + uDrive + '</div></div>';
    }
    upNextHtml = '<h3 style="font-size:1rem;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:12px;">Up Next</h3>'
      + '<div style="display:grid;grid-template-columns:repeat(' + upcoming.length + ',1fr);gap:12px;margin-bottom:20px;">' + upCards + '</div>';
  }

  // â”€â”€ Mini map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var miniMapHtml = '<div class="card" style="margin-bottom:20px;">'
    + '<div class="card-header"><div class="card-title"><i class="fa-solid fa-map"></i> Route Overview</div>'
    + '<button class="btn btn-secondary btn-sm" onclick="switchToMap()"><i class="fa-solid fa-maximize"></i> Full Map</button></div>'
    + '<div id="mini-map-container" style="height:260px;"></div></div>';

  // â”€â”€ Phase progress (pre-built) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var phaseNames = [];
  var seenPhases = {};
  for (var pi = 0; pi < TRIP_DAYS.length; pi++) {
    if (!seenPhases[TRIP_DAYS[pi].phase]) {
      seenPhases[TRIP_DAYS[pi].phase] = true;
      phaseNames.push(TRIP_DAYS[pi].phase);
    }
  }
  var phasesHtml = '';
  for (var pj = 0; pj < phaseNames.length; pj++) {
    var pName     = phaseNames[pj];
    var pDays     = TRIP_DAYS.filter(function(d) { return d.phase === pName; });
    var pFirst    = pDays[0].day;
    var pLast     = pDays[pDays.length - 1].day;
    var pDone     = pLast < dayNum;
    var pCurrent  = pFirst <= dayNum && dayNum <= pLast;
    var pStop     = getStop(pDays[0].stopId);
    var pMiles    = 0;
    for (var pk = 0; pk < pDays.length; pk++) { pMiles += pDays[pk].miles; }
    var pBg       = pCurrent ? 'var(--orange-l)' : pDone ? 'var(--green-l)' : 'var(--bg)';
    var pColor    = pCurrent ? 'var(--orange-d)'  : pDone ? 'var(--green)'   : 'var(--text)';
    var pStatus   = pDone ? 'âœ… Done' : pCurrent ? 'ğŸ“ Now' : 'â³';
    var pStatusC  = pCurrent ? 'var(--orange)' : pDone ? 'var(--green)' : 'var(--text-3)';
    var pMiText   = pMiles > 0 ? ' Â· ' + pMiles + ' mi' : '';
    // Get typical weather for first day of this phase
    var pWx = appState.weather && pDays[0] && appState.weather[pDays[0].stopId] && appState.weather[pDays[0].stopId][pDays[0].date];
    var pWxHtml = '';
    if (pWx && pWx.high != null && pWx.low != null) {
      var pWxIcon = (function(c) {
        if (!c && c !== 0) return 'ğŸŒ¡ï¸';
        if (c === 0) return 'â˜€ï¸';
        if (c <= 2) return 'â›…';
        if (c <= 49) return 'â˜ï¸';
        if (c <= 67) return 'ğŸŒ§ï¸';
        if (c <= 77) return 'â„ï¸';
        return 'â›ˆï¸';
      })(pWx.code);
      pWxHtml = '<span style="font-size:.72rem;color:var(--text-3);white-space:nowrap;">' + pWxIcon + ' ' + Math.round(pWx.high) + 'Â°/' + Math.round(pWx.low) + 'Â°</span>';
    }
    phasesHtml += '<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:var(--radius-s);background:' + pBg + ';">'
      + '<span style="font-size:1.1rem">' + (pStop ? pStop.emoji : 'ğŸš—') + '</span>'
      + '<div style="flex:1;"><div style="font-weight:600;font-size:.875rem;color:' + pColor + '">' + pName + '</div>'
      + '<div style="font-size:.75rem;color:var(--text-3)">Days ' + pFirst + 'â€“' + pLast + ' Â· ' + formatDate(pDays[0].date) + pMiText + '</div>'
      + (pWxHtml ? '<div style="margin-top:2px;">' + pWxHtml + '</div>' : '')
      + '</div>'
      + '<span style="font-size:.8rem;font-weight:700;color:' + pStatusC + '">' + pStatus + '</span></div>';
  }
  var phaseProgress = '<div class="card"><div class="card-header"><div class="card-title"><i class="fa-solid fa-route"></i> Trip Phases</div></div>'
    + '<div class="card-body" style="padding:16px 20px;"><div style="display:flex;flex-direction:column;gap:8px;">'
    + phasesHtml + '</div></div></div>';

  // â”€â”€ Assemble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('dashboard-content').innerHTML =
    heroBanner + todayCard + upNextHtml + statsRow + miniMapHtml;

  setTimeout(function() { initMiniMap(dayNum); }, 50);
}

/* â”€â”€ MAP INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var mainMap = null;
var miniMap = null;

// Route coordinates in order: outbound + return
const ROUTE_OUT = [
  [41.2559, -74.3593], // Warwick
  [38.6648, -78.4647], // Shenandoah
  [35.7143, -83.5102], // Smokies
  [36.2298, -93.1077], // Ozarks
  [30.2752, -98.8720], // TX Hill Country
  [32.1479,-104.5567], // Carlsbad
  [34.8697,-111.7610], // Sedona
  [36.0544,-112.2401], // Grand Canyon
  [37.2982,-113.0263], // Zion
  [37.6283,-112.1669], // Bryce
  [38.5733,-109.5498], // Moab
  [37.2753,-107.8801], // Durango
];
const ROUTE_RETURN = [
  [37.2753,-107.8801], // Durango
  [35.4676, -97.5164], // OKC
  [39.0997, -94.5786], // KC
  [36.1627, -86.7816], // Nashville
  [37.2710, -79.9414], // Blue Ridge
  [38.3032, -77.4605], // Fredericksburg VA
  [41.2559, -74.3593], // Warwick
];

function buildMapMarkers(mapObj) {
  // Draw route dynamically from TRIP_STOPS so any added/removed stops are always reflected
  var _roundTrip  = _tripIsRoundTrip();
  // Use the first stop's coords as the departure pin (falls back to Warwick, NY if no stops yet)
  var _firstStop  = TRIP_STOPS.length ? TRIP_STOPS[0] : null;
  var _homeCoords = (_firstStop && _firstStop.lat && _firstStop.lng)
    ? [_firstStop.lat, _firstStop.lng]
    : [41.2559, -74.3593];
  var _validStops = TRIP_STOPS.filter(function(s) { return s.lat && s.lng; });
  if (_validStops.length) {
    var _routeLine = _validStops.map(function(s) { return [s.lat, s.lng]; });
    // For round trips close the loop back to the start
    if (_roundTrip) {
      var _lastPt = _routeLine[_routeLine.length - 1];
      if (Math.abs(_lastPt[0] - _homeCoords[0]) > 0.05 || Math.abs(_lastPt[1] - _homeCoords[1]) > 0.05) {
        _routeLine.push(_homeCoords);
      }
    }
    // Draw outbound (blue) and return (purple) legs separately
    var _outboundStops = _validStops.filter(function(s) { return s.id <= 11; });
    var _returnStops   = _validStops.filter(function(s) { return s.id >= 11; });
    if (_outboundStops.length > 1) {
      var _outLine = _outboundStops.map(function(s) { return [s.lat, s.lng]; });
      L.polyline(_outLine, { color: '#2C5F8A', weight: 3, opacity: .8 }).addTo(mapObj);
    }
    if (_returnStops.length > 1) {
      var _retLine = _returnStops.map(function(s) { return [s.lat, s.lng]; });
      L.polyline(_retLine, { color: '#7B5EA7', weight: 3, opacity: .8, dashArray: '8 4' }).addTo(mapObj);
    }
  }

  // Add departure marker (using first stop's coords + canonical city name)
  const homeIcon = L.divIcon({
    html: `<div style="width:28px;height:28px;background:#3A8A5C;border-radius:50%;border:3px solid white;box-shadow:0 2px 6px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:14px;">ğŸ </div>`,
    className: '', iconSize: [28, 28], iconAnchor: [14, 14]
  });
  L.marker(_homeCoords, { icon: homeIcon })
    .addTo(mapObj)
    .bindPopup('<strong>ğŸ  ' + _tripStartCity() + '</strong><br>' + (_roundTrip ? 'Start &amp; End' : 'Start'));

  // Add all stops
  TRIP_STOPS.forEach(stop => {
    if (!stop.lat || !stop.lng) return; // skip stops with no coordinates
    const bgColor = '#E8813A';
    const stopEmoji = stop.emoji || 'ğŸ“';
    const icon = L.divIcon({
      html: `<div style="width:32px;height:32px;background:${bgColor};border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;font-size:15px;">${stopEmoji}</div>`,
      className: '', iconSize: [32, 32], iconAnchor: [16, 16]
    });
    const stopDays = TRIP_DAYS.filter(d => d.stopId === stop.id);
    const firstDay = stopDays[0];
    const nights = stopDays.length;
    const acts = stop.activities || [];
    const topActs = acts.slice(0, 3).map(a => `<li style="margin-bottom:1px;">${a.name}</li>`).join('');

    /* Typical weather widget */
    const wx = STOP_WEATHER[stop.id] || {};
    const visitMonth = firstDay ? new Date(firstDay.date + 'T12:00:00').toLocaleDateString('en-US', { month:'short' }) : '';
    const weatherRow = wx.hi
      ? `<div style="display:flex;align-items:center;gap:8px;background:#EEF5FB;border:1px solid #C5DCF0;border-radius:12px;padding:7px 10px;margin-bottom:9px;">
          <span style="font-size:1.35rem;line-height:1;">${wx.icon}</span>
          <div>
            <div style="font-weight:700;font-size:.72rem;color:#2C5F8A;letter-spacing:.02em;text-transform:uppercase;">${visitMonth} Typical Weather</div>
            <div style="font-size:.78rem;color:#333;margin-top:1px;"><strong>${wx.hi}Â°F</strong> high &nbsp;Â·&nbsp; <strong>${wx.lo}Â°F</strong> low</div>
            <div style="font-size:.73rem;color:#555;margin-top:1px;">${wx.desc}</div>
          </div>
          <button onclick="showStopForecastModal(${stop.id})" style="margin-left:auto;font-size:.7rem;color:#2C5F8A;text-decoration:none;white-space:nowrap;border:1px solid #a8cde8;border-radius:100px;padding:3px 7px;background:#fff;cursor:pointer;font-family:inherit;">Forecast â†’</button>
        </div>`
      : `<div style="margin-bottom:8px;"><button onclick="showStopForecastModal(${stop.id})" style="font-size:.78rem;color:#2C5F8A;background:none;border:none;text-decoration:none;cursor:pointer;padding:0;font-family:inherit;">ğŸŒ¤ï¸ Check forecast â†’</button></div>`;

    const stopDesc = (stop.description || stop.desc || '');
    const popup = `
      <div style="min-width:230px;max-width:290px;font-family:-apple-system,sans-serif;">
        <div style="font-weight:800;font-size:.98rem;margin-bottom:2px;">${stopEmoji} ${stop.name}${stop.state ? ', ' + stop.state : ''}</div>
        <div style="font-size:.76rem;color:#888;margin-bottom:9px;">${firstDay ? formatDate(firstDay.date) : ''} &nbsp;Â·&nbsp; ${nights} night${nights!==1?'s':''}</div>
        ${weatherRow}
        ${stopDesc ? `<div style="font-size:.79rem;color:#444;line-height:1.5;margin-bottom:8px;">${stopDesc.substring(0, 110)}${stopDesc.length > 110 ? 'â€¦' : ''}</div>` : ''}
        ${topActs ? `<ul style="font-size:.76rem;padding-left:16px;margin:0 0 10px;">${topActs}</ul>` : ''}
        <button onclick="openMapStopInfo(${stop.id})" style="width:100%;background:#2C5F8A;color:#fff;border:none;border-radius:100px;padding:8px 12px;font-size:.8rem;font-weight:700;cursor:pointer;font-family:-apple-system,sans-serif;display:flex;align-items:center;justify-content:center;gap:5px;margin-top:2px;">âœ¨ AI Area Overview</button>
      </div>`;
    L.marker([stop.lat, stop.lng], { icon })
      .addTo(mapObj)
      .bindPopup(popup, { maxWidth: 300 });
  });
}

/* Safe helper: remove all non-tile layers then rebuild markers */
function _clearAndRebuildMapMarkers(mapObj) {
  var toRemove = [];
  mapObj.eachLayer(function(layer) {
    if (!(layer instanceof L.TileLayer)) toRemove.push(layer);
  });
  toRemove.forEach(function(layer) { mapObj.removeLayer(layer); });
  buildMapMarkers(mapObj);
}

function initMainMap() {
  if (mainMap) {
    mainMap.invalidateSize();
    /* Rebuild markers with current TRIP_STOPS (handles post-change refresh) */
    _clearAndRebuildMapMarkers(mainMap);
    return;
  }
  mainMap = L.map('map-container', { zoomControl: true }).setView([37, -98], 4);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors', maxZoom: 18
  }).addTo(mainMap);
  buildMapMarkers(mainMap);
}

/* Called from initApp() after trip data changes â€” redraws map markers without re-creating the map */
function refreshMainMap() {
  if (!mainMap) return; // map hasn't been opened yet â€” nothing to do
  _clearAndRebuildMapMarkers(mainMap);
}

function initMiniMap(dayNum) {
  if (document.getElementById('mini-map-container')) {
    const m = L.map('mini-map-container', { zoomControl: false, scrollWheelZoom: false, dragging: false, touchZoom: false, doubleClickZoom: false }).setView([37, -98], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '', maxZoom: 18
    }).addTo(m);
    buildMapMarkers(m);
    // Highlight today's stop
    const today = getDay(dayNum);
    if (today) {
      const stop = getStop(today.stopId);
      if (stop && stop.id !== 15) {
        const pulseIcon = L.divIcon({
          html: `<div style="width:20px;height:20px;background:#E8813A;border-radius:50%;border:3px solid white;box-shadow:0 0 0 4px rgba(232,129,58,.3);"></div>`,
          className: '', iconSize: [20, 20], iconAnchor: [10, 10]
        });
        L.marker([stop.lat, stop.lng], { icon: pulseIcon }).addTo(m).bindPopup('<strong>ğŸ“ You are here</strong>').openPopup();
      }
    }
  }
}

/* â”€â”€ NAV HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function switchToMap() {
  document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('[data-tab="map"]').classList.add('active');
  document.getElementById('tab-map').classList.add('active');
  setTimeout(initMainMap, 100);
}
function switchToSchedule() {
  document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector('[data-tab="schedule"]').classList.add('active');
  document.getElementById('tab-schedule').classList.add('active');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHUNK 4 â€” SCHEDULE TAB
   Day-by-day list: driver toggle, editable sleep, spring break,
   phase headers, miles/drive time, weather links
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ SLEEP TYPE ICON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sleepIcon(type) {
  if (type === 'rv_park')    return '<i class="fa-solid fa-campground"></i>';
  if (type === 'walmart')    return '<i class="fa-solid fa-store"></i>';
  if (type === 'home')       return '<i class="fa-solid fa-house"></i>';
  if (type === 'campground') return '<i class="fa-solid fa-tree"></i>';
  return '<i class="fa-solid fa-bed"></i>';
}

/* â”€â”€ EDIT SLEEP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function editSleep(dayNum) {
  var current = getDaySleep(dayNum);
  var el = document.getElementById('sleep-input-' + dayNum);
  if (!el) return;
  el.classList.toggle('hidden');
  if (!el.classList.contains('hidden')) {
    el.querySelector('input').value = current;
    el.querySelector('input').focus();
  }
}
function saveSleep(dayNum) {
  var el = document.getElementById('sleep-input-' + dayNum);
  if (!el) return;
  var val = el.querySelector('input').value.trim();
  if (val) {
    setDayState(dayNum, { sleep: val });
    showToast('Sleep location saved for Day ' + dayNum);
  }
  el.classList.add('hidden');
  renderSchedule();
}

/* â”€â”€ PHASE HEADER HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function phaseHeaderHtml(phase, firstDay) {
  var pStop = getStop(firstDay.stopId);
  var totalMi = 0;
  var phaseDays = TRIP_DAYS.filter(function(d) { return d.phase === phase; });
  for (var i = 0; i < TRIP_DAYS.length; i++) {
    if (TRIP_DAYS[i].phase === phase) totalMi += TRIP_DAYS[i].miles;
  }
  var nights = phaseDays.length;
  var extras = (appState.phaseExtraDays && appState.phaseExtraDays[firstDay.stopId]) || 0;
  var totalNights = nights + extras;
  var btnStyle = 'background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;border-radius:50%;width:26px;height:26px;font-size:1rem;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;font-family:var(--font);line-height:1;flex-shrink:0;';

  /* Compute average high/low temps for this phase from weather data */
  var _wxHtml = '';
  var _wxData = appState.weather && appState.weather[firstDay.stopId];
  if (_wxData && phaseDays.length > 0) {
    var _highs = [], _lows = [], _codes = [];
    phaseDays.forEach(function(pd) {
      var wx = _wxData[pd.date];
      if (wx) {
        if (wx.high !== undefined) _highs.push(wx.high);
        if (wx.low  !== undefined) _lows.push(wx.low);
        if (wx.code !== undefined) _codes.push(wx.code);
      }
    });
    if (_highs.length > 0) {
      var _avgHigh = Math.round(_highs.reduce(function(a,b){return a+b;},0) / _highs.length);
      var _avgLow  = Math.round(_lows.reduce(function(a,b){return a+b;},0) / _lows.length);
      /* Pick most-common weather code for icon */
      var _codeCount = {}; _codes.forEach(function(c){ _codeCount[c]=(_codeCount[c]||0)+1; });
      var _topCode = _codes.length ? parseInt(Object.keys(_codeCount).sort(function(a,b){return _codeCount[b]-_codeCount[a];})[0]) : null;
      var _wxIcon = _topCode === null ? 'ğŸŒ¡ï¸' : (_topCode <= 1 ? 'â˜€ï¸' : _topCode <= 3 ? 'â›…' : _topCode <= 49 ? 'ğŸŒ«ï¸' : _topCode <= 67 ? 'ğŸŒ§ï¸' : _topCode <= 77 ? 'â„ï¸' : 'ğŸŒ©ï¸');
      var _wxType = (_wxData[phaseDays[0].date] && _wxData[phaseDays[0].date].type === 'forecast') ? 'Forecast' : 'Typical';
      _wxHtml = '<div style="display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.15);border-radius:20px;padding:3px 9px;flex-shrink:0;cursor:pointer;" onclick="event.stopPropagation();showStopForecastModal(' + firstDay.stopId + ')" title="' + _wxType + ' weather â€” tap for full forecast">'
        + '<span style="font-size:.85rem;">' + _wxIcon + '</span>'
        + '<span style="font-size:.76rem;font-weight:800;color:#fff;white-space:nowrap;">' + _avgHigh + 'Â° / ' + _avgLow + 'Â°</span>'
        + '</div>';
    } else {
      /* No data yet â€” show load button */
      _wxHtml = '<button onclick="event.stopPropagation();loadStopWeather(' + firstDay.stopId + ')" style="background:rgba(255,255,255,.12);border:1px dashed rgba(255,255,255,.4);color:rgba(255,255,255,.7);border-radius:20px;padding:3px 9px;font-size:.72rem;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;" title="Load weather">ğŸŒ¡ï¸ Weather</button>';
    }
  } else if (pStop && pStop.lat) {
    _wxHtml = '<button onclick="event.stopPropagation();loadStopWeather(' + firstDay.stopId + ')" style="background:rgba(255,255,255,.12);border:1px dashed rgba(255,255,255,.4);color:rgba(255,255,255,.7);border-radius:20px;padding:3px 9px;font-size:.72rem;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;" title="Load weather">ğŸŒ¡ï¸ Weather</button>';
  }

  return '<div style="display:flex;align-items:center;gap:8px;padding:10px 14px;background:var(--blue);color:#fff;border-radius:var(--radius-s);margin:20px 0 8px;flex-wrap:wrap;">'
    + '<span style="font-size:1.3rem">' + (pStop ? pStop.emoji : '&#128663;') + '</span>'
    + '<div style="flex:1;min-width:0;">'
    + '<div style="font-weight:800;font-size:.97rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">' + phase + '</div>'
    + '<div style="font-size:.76rem;opacity:.8;">' + totalNights + ' nights' + (totalMi > 0 ? ' \u00b7 ' + totalMi + ' mi' : '') + (extras > 0 ? ' (+' + extras + ' added)' : extras < 0 ? ' (' + extras + ' shortened)' : '') + '</div>'
    + '</div>'
    + (firstDay.springBreak ? '<span style="background:rgba(255,255,255,.2);border-radius:20px;padding:3px 10px;font-size:.73rem;font-weight:700;flex-shrink:0;">&#127775; Spring Break</span>' : '')
    + _wxHtml
    + '<div style="display:flex;flex-direction:column;align-items:center;gap:3px;flex-shrink:0;">'
    + '<span style="font-size:.6rem;font-weight:800;opacity:.75;letter-spacing:.03em;text-transform:uppercase;white-space:nowrap;">Days</span>'
    + '<div style="display:flex;align-items:center;gap:4px;">'
    + '<button onclick="event.stopPropagation();removePhaseDay(' + firstDay.stopId + ')" style="' + btnStyle + '" title="Remove a day">&#8722;</button>'
    + '<span style="font-size:.65rem;opacity:.65;font-weight:700;">/</span>'
    + '<button onclick="event.stopPropagation();addPhaseDay(' + firstDay.stopId + ')" style="' + btnStyle + '" title="Add a day">&#43;</button>'
    + '</div>'
    + '</div>'
    + '<button onclick="event.stopPropagation();removeStopFromTrip(' + firstDay.stopId + ',\'' + phase.replace(/'/g, "\\'") + '\')" style="background:rgba(220,80,60,.35);border:1px solid rgba(255,100,80,.5);color:#fff;border-radius:100px;padding:5px 10px;font-size:.7rem;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;" title="Remove this stop from trip">ğŸ—‘ï¸ Remove</button>'
    + '<button onclick="event.stopPropagation();openAreaInfo(\'' + phase.replace(/'/g, "\\'") + '\',' + firstDay.stopId + ')" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:100px;padding:5px 10px;font-size:.72rem;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;">&#128269; Area Info</button>'
    + '<button onclick="event.stopPropagation();_openMusicForStop(' + firstDay.stopId + ')" title="Local Music" style="background:#1DB954;border:2px solid rgba(255,255,255,.5);color:#fff;border-radius:50%;width:32px;height:32px;font-size:.9rem;font-weight:700;cursor:pointer;font-family:var(--font);flex-shrink:0;display:flex;align-items:center;justify-content:center;line-height:1;padding:0;">&#127926;</button>'
    + '</div>';
}
function addPhaseDay(stopId) {
  if (!appState.phaseExtraDays) appState.phaseExtraDays = {};
  appState.phaseExtraDays[stopId] = (appState.phaseExtraDays[stopId] || 0) + 1;
  saveState(appState); renderSchedule();
  showToast('Extra day added!', 1600);
}
function removePhaseDay(stopId) {
  if (!appState.phaseExtraDays) appState.phaseExtraDays = {};
  var phaseDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  var minAllowed = -(phaseDays.length - 1); // always keep at least 1 day
  var cur = appState.phaseExtraDays[stopId] || 0;
  if (cur <= minAllowed) { showToast('Need at least 1 day at each stop!', 1800); return; }
  appState.phaseExtraDays[stopId] = cur - 1;
  saveState(appState); renderSchedule();
  var newVal = appState.phaseExtraDays[stopId];
  showToast(newVal < 0 ? 'Day hidden from schedule' : 'Extra day removed', 1600);
}

/* â”€â”€ RENDER PAUSE SCHEDULE BLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Remove an entire stop/phase from the trip (hides all days for that stop) */
function removeStopFromTrip(stopId, phaseName) {
  var phaseDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  if (phaseDays.length === 0) { showToast('Stop not found', 1600); return; }
  /* Confirm */
  if (!confirm('Remove "' + phaseName + '" from your trip? This hides all ' + phaseDays.length + ' days at this stop. You can restore it by adding days back with the + button.')) return;
  if (!appState.phaseExtraDays) appState.phaseExtraDays = {};
  /* Set phaseExtraDays to -(phaseDays.length - 1) so only 1 day remains hidden in minimum logic
     Actually we want to hide ALL days, so we set a special flag: removedStop */
  if (!appState.removedStops) appState.removedStops = {};
  appState.removedStops[stopId] = true;
  /* Also set phaseExtraDays to max negative to collapse days via existing logic */
  appState.phaseExtraDays[stopId] = -(phaseDays.length);
  saveState(appState);
  renderSchedule();
  showToast('ğŸ—‘ï¸ ' + phaseName + ' removed from schedule. Use + to restore days.', 2800);
}

function restoreStopToTrip(stopId) {
  if (!appState.removedStops) appState.removedStops = {};
  delete appState.removedStops[stopId];
  if (appState.phaseExtraDays) appState.phaseExtraDays[stopId] = 0;
  saveState(appState);
  renderSchedule();
  showToast('â†© Stop restored to schedule!', 1800);
}

/* Wrapper to trigger weather load and re-render */
function loadStopWeather(stopId) {
  showToast('ğŸŒ¡ï¸ Loading weatherâ€¦', 1800);
  _loadStopWeatherSilent(stopId, function() { renderSchedule(); showToast('âœ… Weather loaded!', 1800); });
}

function _renderPauseScheduleBlock(pd, nights) {
  var nightStr = nights + ' night' + (nights !== 1 ? 's' : '');
  var dateRange = pd.startDate ? pd.startDate + (pd.endDate ? ' â†’ ' + pd.endDate : '') : '';
  return '<div style="background:#fff8e1;border:2px dashed #f57c00;border-radius:10px;margin-bottom:6px;overflow:hidden;">'
    + '<div style="display:grid;grid-template-columns:76px 1fr;align-items:center;gap:0;">'
    + '<div style="display:flex;flex-direction:column;align-self:stretch;min-width:76px;">'
    + '<div style="background:#f57c00;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:1px;padding:6px 8px;">'
    + '<i class="fa-solid fa-plane-departure" style="font-size:.75rem;font-weight:900;"></i>'
    + '<span style="font-size:.82rem;font-weight:900;">' + nightStr + '</span>'
    + '</div>'
    + '<div style="background:#fff3e0;text-align:center;padding:3px 4px;font-size:.6rem;font-weight:800;color:#f57c00;letter-spacing:.04em;border-top:1px solid #f57c00;white-space:nowrap;">PAUSE</div>'
    + '</div>'
    + '<div style="padding:10px 14px;">'
    + '<div style="font-weight:800;font-size:.88rem;color:#e65100;margin-bottom:3px;"><i class="fa-solid fa-plane-departure"></i> Trip Pause â€” ' + (pd.destination || 'Away from RV') + '</div>'
    + '<div style="font-size:.75rem;color:#795548;line-height:1.5;">'
    + (dateRange ? dateRange + ' Â· ' : '') + nightStr + ' off the road'
    + (pd.flightOut ? '<br>âœˆ Out: ' + pd.flightOut + (pd.flightRet ? ' Â· In: ' + pd.flightRet : '') : '')
    + '</div>'
    + '</div>'
    + '</div>';
}

/* â”€â”€ RENDER SCHEDULE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderSchedule() {
  var el = document.getElementById('schedule-content');
  if (!el) return;

  var todayNum  = tripDay();
  var _live     = tripIsLive(); // only mark "Today" if trip has actually started
  var lastPhase = '';
  var html      = '';

  /* Pre-compute which day numbers are hidden because a stop had days removed */
  var skipDayNums = {};
  var removedStopIds = appState.removedStops || {};
  if (appState.phaseExtraDays) {
    var stopDayMap = {};
    TRIP_DAYS.forEach(function(d) {
      if (!stopDayMap[d.stopId]) stopDayMap[d.stopId] = [];
      stopDayMap[d.stopId].push(d);
    });
    Object.keys(appState.phaseExtraDays).forEach(function(sid) {
      var extra = appState.phaseExtraDays[sid];
      if (extra < 0) {
        var days = stopDayMap[sid] || [];
        /* If stop is fully removed, skip ALL days; otherwise keep at least 1 */
        var skip = removedStopIds[sid] ? days.length : Math.min(Math.abs(extra), days.length - 1);
        for (var si = days.length - skip; si < days.length; si++) {
          skipDayNums[days[si].day] = true;
        }
      }
    });
  }

  // Header row
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-calendar-days"></i> 46-Day Schedule</h2>'
    + '<button onclick="openAddDest()" style="background:var(--orange);color:#fff;border:none;border-radius:100px;padding:7px 14px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:6px;">&#128205; Add Destination</button>'
    + '</div>'

  /* Pre-compute pause blocks for schedule injection */
  var _schPauses = (appState.pauseDays || [])
    .filter(function(pd) { return pd.startDate && pd.endDate; })
    .sort(function(a,b) { return a.startDate < b.startDate ? -1 : 1; });
  var _schPausePtrIdx = 0;
  var _schCumulativeNights = 0;
  var _plannedEndDate = new Date(CONFIG.endDate + 'T00:00:00');
  var _overflowDayCount = 0;

  for (var i = 0; i < TRIP_DAYS.length; i++) {
    var d        = TRIP_DAYS[i];

    /* Inject pause blocks that start at or before this day's original date */
    while (_schPausePtrIdx < _schPauses.length && _schPauses[_schPausePtrIdx].startDate <= d.date) {
      var _sp = _schPauses[_schPausePtrIdx];
      var _spNights = Math.max(0, Math.round((new Date(_sp.endDate+'T00:00:00') - new Date(_sp.startDate+'T00:00:00')) / 86400000));
      _schCumulativeNights += _spNights;
      html += _renderPauseScheduleBlock(_sp, _spNights);
      _schPausePtrIdx++;
    }

    /* Effective date = original date shifted by cumulative pause nights */
    var _effectiveDate = new Date(new Date(d.date + 'T00:00:00').getTime() + _schCumulativeNights * 86400000);
    var _isOverflow = _effectiveDate > _plannedEndDate;
    if (_isOverflow) _overflowDayCount++;

    var stop     = getStop(d.stopId);
    var sleep    = getDaySleep(d.day);
    var isToday  = _live && d.day === todayNum;
    var isBefore = _live && d.day < todayNum;

    // Phase header when phase changes (always show even if first day is skipped)
    if (d.phase !== lastPhase) {
      if (removedStopIds[d.stopId]) {
        /* Show a compact restore banner instead of full phase header */
        var _rStop = getStop(d.stopId);
        html += '<div style="display:flex;align-items:center;gap:10px;padding:8px 14px;background:#e0e0e0;color:#555;border-radius:var(--radius-s);margin:12px 0 4px;opacity:.7;">'
          + '<span style="font-size:1.1rem">' + (_rStop ? _rStop.emoji : 'ğŸ“') + '</span>'
          + '<div style="flex:1;font-size:.85rem;font-weight:700;">' + d.phase + ' <span style="font-weight:400;font-size:.78rem;">(removed from schedule)</span></div>'
          + '<button onclick="restoreStopToTrip(' + d.stopId + ')" style="background:var(--green);color:#fff;border:none;border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">â†© Restore</button>'
          + '</div>';
      } else {
        html += phaseHeaderHtml(d.phase, d);
      }
      lastPhase = d.phase;
    }

    // Skip this day if it was hidden by the - button or full stop removal
    if (skipDayNums[d.day]) continue;

    // Card background â€” border-free, whitespace + light shadow as separator
    var cardBg = isToday      ? 'border-left:4px solid var(--orange);background:var(--orange-l);box-shadow:0 1px 8px rgba(232,129,58,.12);'
               : d.springBreak ? 'border-left:4px solid var(--purple);background:var(--purple-l);box-shadow:0 1px 4px rgba(0,0,0,.05);'
               : isBefore     ? 'background:#fafaf8;opacity:.75;box-shadow:none;'
               : 'background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.04),0 3px 10px rgba(0,0,0,.06);';

    html += '<div style="' + cardBg + 'border-radius:var(--radius-s);margin-bottom:8px;overflow:hidden;">';

    // Main row
    html += '<div style="display:grid;grid-template-columns:76px 1fr auto;align-items:center;gap:0;">';

    // Day badge: date in colored bar, Day# in white area
    var dayBg = isToday ? 'var(--orange)' : d.springBreak ? 'var(--purple)' : isBefore ? '#aaa' : 'var(--blue)';
    var dObj2 = new Date(d.date + 'T12:00:00');
    var dWday = dObj2.toLocaleDateString('en-US', { weekday:'short' });
    var dMDay = dObj2.toLocaleDateString('en-US', { month:'short', day:'numeric' });
    html += '<div style="display:flex;flex-direction:column;align-self:stretch;min-width:76px;">'
      + '<div style="background:' + dayBg + ';color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:1px;padding:6px 8px;">'
      + '<span style="font-size:.7rem;font-weight:700;opacity:.85;letter-spacing:.02em;white-space:nowrap;">' + dWday + '</span>'
      + '<span style="font-size:.95rem;font-weight:900;line-height:1.2;white-space:nowrap;">' + dMDay + '</span>'
      + '</div>'
      + '<div style="background:#f0ece6;text-align:center;padding:3px 4px;font-size:.65rem;font-weight:800;color:var(--text-3);letter-spacing:.04em;text-transform:uppercase;white-space:nowrap;border-top:1px solid var(--border);">Day ' + d.day + '</div>'
      + '</div>';

    // Middle: title + meta
    html += '<div style="padding:10px 14px;cursor:pointer;" onclick="openDayDetail(' + d.day + ')" title="View day schedule">';
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:3px;flex-wrap:wrap;">';
    if (stop) html += '<span style="font-size:.95rem">' + stop.emoji + '</span>';
    html += '<span style="font-weight:700;font-size:1rem;color:var(--text);line-height:1.3;">' + d.title + '</span>';
    if (isToday) html += '<span style="background:var(--orange);color:#fff;font-size:.68rem;font-weight:800;padding:2px 8px;border-radius:100px;text-transform:uppercase;">Today</span>';
    if (_isOverflow) html += '<span style="background:#c62828;color:#fff;font-size:.65rem;font-weight:800;padding:2px 8px;border-radius:100px;white-space:nowrap;">ğŸ”º Over Schedule</span>';
    html += '</div>';

    // Meta row (date no longer here since it is in the badge)
    html += '<div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">';
    if (d.driveDay && d.miles > 0) {
      var _maxDriveH = (appState.drivingPrefs && appState.drivingPrefs.maxHours) || 4;
      var _splitResolved = appState.dayOverrides && appState.dayOverrides[d.day] && appState.dayOverrides[d.day].splitResolved;
      var _splitHours = _splitResolved && appState.dayOverrides[d.day].splitHours;
      var _isLongDrive = !_splitResolved && d.driveHours > _maxDriveH;
      /* Stop-break padding */
      var _sbEvery = (appState.drivingPrefs && appState.drivingPrefs.stopBreakEvery) || 0;
      var _sbMins  = (appState.drivingPrefs && appState.drivingPrefs.stopBreakMins)  || 15;
      var _sbStops = (_sbEvery > 0 && d.driveHours > 0) ? Math.floor(d.driveHours / _sbEvery) : 0;
      var _sbExtra = _sbStops > 0 ? ' + ' + _sbStops + ' stop' + (_sbStops !== 1 ? 's' : '') : '';
      var _driveDisp = _splitResolved ? (_splitHours + 'h each leg') : (d.driveHours + 'h' + _sbExtra);
      html += '<span style="font-size:.75rem;color:var(--orange);font-weight:600;"><i class="fa-solid fa-car-side"></i> ' + d.miles + ' mi Â· ' + _driveDisp + '</span>';
      if (_splitResolved) {
        html += '<span style="background:var(--green);color:#fff;font-size:.66rem;font-weight:800;padding:2px 8px;border-radius:100px;white-space:nowrap;">âœ“ Drive Time Split</span>';
      } else if (_isLongDrive) {
        html += '<span style="background:var(--orange);color:#fff;font-size:.66rem;font-weight:800;padding:2px 8px;border-radius:100px;white-space:nowrap;cursor:pointer;" onclick="openDayDetail(' + d.day + ')"><i class="fa-solid fa-triangle-exclamation"></i> Long Drive â€” tap to split</span>';
      }
    } else if (!d.driveDay) {
      html += '<span style="font-size:.75rem;color:var(--green);font-weight:600;"><i class="fa-solid fa-campground"></i> Explore day</span>';
    }
    // Sleep
    html += '<span style="font-size:.75rem;color:var(--text-2);">' + sleepIcon(d.sleepType) + ' ' + sleep + '</span>';
    html += '</div>';
    html += '</div>'; // middle

    // Right: action buttons + weather (right-aligned = consistent horizontal position)
    html += '<div style="padding:8px 12px;display:flex;flex-direction:column;align-items:flex-end;gap:6px;">';
    html += '<div style="display:flex;gap:4px;">';
    if (stop && stop.id !== 15) {
      html += '<button onclick="showStopForecastModal(' + stop.id + ')" title="Forecast" style="background:var(--blue-l);border:1px solid var(--border);border-radius:100px;padding:4px 8px;font-size:.72rem;cursor:pointer;color:var(--blue);font-family:var(--font);">&#127780;&#65039;</button>';
    }
    html += '</div>';
    html += '<span id="wx-d-' + d.day + '" class="wx-chip wx-loading" style="text-align:right;">&#9729;&#65039;</span>';
    html += '</div>'; // right

    html += '</div>'; // grid

    // Planned items for this stop
    var stopForDay2 = getStop(d.stopId);
    if (stopForDay2 && typeof getPlannedForStop === 'function') {
      var dp = getPlannedForStop(d.stopId, d.day);
      if (dp.activities.length > 0 || dp.restaurants.length > 0) {
        html += '<div style="padding:8px 12px 10px;border-top:1px solid var(--border);background:var(--green-l);">';
        html += '<div style="font-size:.7rem;font-weight:800;color:var(--green);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px;">&#9989; Your Plan for ' + stopForDay2.name + '</div>';
        html += '<div style="display:flex;flex-wrap:wrap;gap:5px;">';
        var sf2Acts  = stopForDay2.activities  || [];
        var sf2Rests = stopForDay2.restaurants || [];
        for (var pla = 0; pla < dp.activities.length; pla++) {
          var plAct = sf2Acts[dp.activities[pla]];
          if (plAct) html += '<div style="background:#fff;border:1px solid #a8d5b8;border-radius:12px;font-size:.72rem;font-weight:600;color:var(--green);padding:3px 10px;">&#127939; ' + plAct.name + '</div>';
        }
        for (var plr = 0; plr < dp.restaurants.length; plr++) {
          var plRest = sf2Rests[dp.restaurants[plr]];
          if (plRest) html += '<div style="background:#fff;border:1px solid #a8d5b8;border-radius:12px;font-size:.72rem;font-weight:600;color:var(--green);padding:3px 10px;">&#127869; ' + plRest.name + '</div>';
        }
        html += '</div></div>';
      }
    }



    html += '</div>'; // card

    // After last day of a phase, inject extra flex days
    var isLastInPhase = (i === TRIP_DAYS.length - 1) || (TRIP_DAYS[i + 1].phase !== d.phase);
    if (isLastInPhase && appState.phaseExtraDays && appState.phaseExtraDays[d.stopId]) {
      var extCt = appState.phaseExtraDays[d.stopId];
      var pStop2 = getStop(d.stopId);
      for (var ex = 1; ex <= extCt; ex++) {
        html += '<div style="background:var(--card);border:1.5px dashed var(--green);border-radius:var(--radius-s);margin-bottom:6px;overflow:hidden;opacity:.85;">';
        html += '<div style="display:grid;grid-template-columns:76px 1fr auto;align-items:center;gap:0;">';
        html += '<div style="display:flex;flex-direction:column;align-self:stretch;min-width:76px;">'
          + '<div style="background:var(--green);color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:1px;padding:6px 8px;">'
          + '<span style="font-size:.7rem;font-weight:700;">+' + ex + '</span>'
          + '<span style="font-size:.82rem;font-weight:900;">Day</span>'
          + '</div>'
          + '<div style="background:#e8f4ec;text-align:center;padding:3px 4px;font-size:.65rem;font-weight:800;color:var(--green);letter-spacing:.04em;border-top:1px solid var(--green);white-space:nowrap;">EXTRA</div>'
          + '</div>';
        html += '<div style="padding:10px 14px;">';
        html += '<div style="font-size:.8rem;font-weight:700;color:var(--green);">&#127811; Bonus Explore Day â€” ' + d.phase + '</div>';
        html += '<div style="font-size:.75rem;color:var(--text-2);margin-top:3px;">' + (pStop2 ? pStop2.emoji + ' ' + pStop2.name : '') + ' &mdash; free day to explore!</div>';
        html += '</div>';
        html += '<div style="padding:8px 12px;"><button onclick="removePhaseDay(' + d.stopId + ')" style="background:var(--red-l);border:1px solid var(--red);color:var(--red);border-radius:12px;padding:4px 8px;font-size:.7rem;cursor:pointer;font-family:var(--font);">&#215; Remove</button></div>';
        html += '</div></div>';
      }
    }
  }

  el.innerHTML = html;
  loadWeather();

  // Scroll today into view
  var todayEl = el.querySelector('[style*="background:var(--orange)"][style*="Today"]');
  if (!todayEl) {
    // fallback: find today's card via day badge
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHUNK 5 â€” SCHOOL TAB
   Leila (9/4th), Luna (4/Pre-K), Eli (2/Toddler)
   Drive days: 4h school + 2h free. Teacher = non-driver.
   Spring break Mar 30â€“Apr 3. Road-school geography bonus every day.
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ SUBJECT DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var LEILA_SUBJECTS = [
  { id: 'math',    label: 'Math',           icon: 'â•', color: '#2C5F8A', desc: '4th grade: fractions, multiplication, geometry' },
  { id: 'ela',     label: 'Reading & ELA',  icon: 'ğŸ“–', color: '#E8813A', desc: 'Chapter books, writing journal, spelling' },
  { id: 'science', label: 'Science',        icon: 'ğŸ”¬', color: '#3A8A5C', desc: 'Earth science, geology, ecosystems' },
  { id: 'geo',     label: 'Road Geography', icon: 'ğŸ—ºï¸', color: '#7B5EA7', desc: 'Map reading, state facts, landmarks' },
  { id: 'art',     label: 'Art & Projects', icon: 'ğŸ¨', color: '#D4A017', desc: 'Sketching, nature journals, crafts' },
];

var LUNA_ACTIVITIES = [
  { icon: 'ğŸ”¤', label: 'ABC Practice',    desc: 'Letter tracing, phonics songs, flashcards' },
  { icon: 'ğŸ”¢', label: 'Counting & Math', desc: 'Counting objects, simple addition with fingers' },
  { icon: 'ğŸ¨', label: 'Coloring & Art',  desc: 'Coloring books, stickers, finger painting' },
  { icon: 'ğŸ“š', label: 'Story Time',      desc: 'Picture books, audiobooks, made-up stories' },
  { icon: 'ğŸµ', label: 'Songs & Rhymes',  desc: 'Nursery rhymes, learning songs, sing-alongs' },
];

var ELI_ACTIVITIES = [
  { icon: 'ğŸ§¸', label: 'Sensory Play',  desc: 'Playdough, kinetic sand at stops, water play' },
  { icon: 'ğŸµ', label: 'Music & Dance', desc: 'Kids songs, dancing at rest stops' },
  { icon: 'ğŸ“š', label: 'Board Books',   desc: 'Simple picture books, touch-and-feel books' },
  { icon: 'ğŸš—', label: 'Toy Time',      desc: 'Small toys, stacking blocks, RV window watching' },
];

/* â”€â”€ DRIVE-DAY SCHEDULE BLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function getDriveDaySchedule(driver) {
  var teacher = driver === 'Paul' ? 'Melissa' : 'Paul';
  return [
    { time: 'Hour 1â€“2',   leila: 'Math + Reading',         luna: 'ABC Practice + Counting', eli: 'Toy Time',      teacher: teacher, type: 'school' },
    { time: 'Hour 3',     leila: 'â˜• Break / Lunch Stop',  luna: 'Free play at stop',        eli: 'Stretch & snack', teacher: 'Both', type: 'break'  },
    { time: 'Hour 4â€“5',   leila: 'Science + Road Geo',     luna: 'Coloring + Story Time',   eli: 'Music & Songs', teacher: teacher, type: 'school' },
    { time: 'Hour 6',     leila: 'ğŸ¨ Art / Free Choice',   luna: 'Audiobook / Sing-along',  eli: 'Window watching', teacher: 'Either', type: 'free' },
  ];
}

/* â”€â”€ EXPLORE-DAY SCHEDULE BLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var EXPLORE_DAY_SCHEDULE = [
  { time: '9â€“10am',  leila: 'Math',             luna: 'ABC Practice',   eli: 'Board Books',  teacher: 'Rotating', type: 'school' },
  { time: '10â€“11am', leila: 'Reading & ELA',    luna: 'Story Time',     eli: 'Sensory Play', teacher: 'Rotating', type: 'school' },
  { time: '11amâ€“1pm', leila: 'ğŸ•ï¸ Adventure Time!', luna: 'Explore!',   eli: 'Explore!',     teacher: 'Both', type: 'break'  },
  { time: '1â€“2pm',   leila: 'Science + Geo',    luna: 'Coloring / Art', eli: 'Nap / Rest',   teacher: 'Rotating', type: 'school' },
  { time: '2â€“3pm',   leila: 'Art / Project',    luna: 'Songs & Rhymes', eli: 'Toy Time',     teacher: 'Rotating', type: 'school' },
  { time: '3pm+',    leila: 'ğŸŒ² Explore / Hike', luna: 'Free play',     eli: 'Free play',    teacher: 'Both', type: 'free'  },
];

/* â”€â”€ GEOGRAPHY FACT PER STOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var GEO_FACTS = {
  1:  'Virginia is one of the original 13 colonies! Find VA on the map and count the states between home and here.',
  2:  'Tennessee borders 8 states â€” more than almost any other! The Smokies straddle TN and NC.',
  3:  'Arkansas comes from a Quapaw Native American word. The Ozarks are one of the oldest mountain ranges in North America.',
  4:  'Texas is the 2nd largest US state. If it were a country, it would have the 10th largest economy in the world!',
  5:  'New Mexico was the 47th state (1912). Carlsbad Caverns formed over millions of years as sulfuric acid dissolved limestone.',
  6:  'Arizona means "little spring" in a local Native language. Sedona\'s red rocks are 300 million years old!',
  7:  'The Grand Canyon is 277 miles long, up to 18 miles wide, and over 1 mile deep. It took 5â€“6 million years to form.',
  8:  'Utah has 5 national parks in one small area â€” called the "Mighty 5." Zion gets 4+ million visitors a year!',
  9:  'Bryce Canyon sits at 8,000â€“9,000 feet elevation. The hoodoos form because water freezes and thaws 200 days a year.',
  10: 'Moab sits on the Colorado River. Arches NP has the highest density of natural stone arches in the world (2,000+).',
  11: 'Colorado has 58 mountain peaks over 14,000 feet â€” called "fourteeners." Only Alaska has higher peaks in the US.',
  12: 'Oklahoma comes from Choctaw words meaning "red people." The Land Run of 1889 gave away 2 million acres in one day!',
  13: 'Missouri is the "Gateway to the West." The Gateway Arch is 630 feet tall â€” as wide as it is tall!',
  14: 'Virginia is called the "Mother of Presidents" â€” 8 US presidents were born here, more than any other state.',
  15: 'New York state has 62 counties. The Hudson Valley, where Warwick sits, was home to the first American art movement!',
};

/* â”€â”€ RENDER SCHOOL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderSchool() {
  var el = document.getElementById('school-content');
  if (!el) return;

  var todayNum = tripDay();
  var html = '';

  // â”€â”€ Header stats row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  var schoolDays = 0;
  var schoolDone = 0;
  for (var si = 0; si < TRIP_DAYS.length; si++) {
    if (!TRIP_DAYS[si].springBreak && TRIP_DAYS[si].stopId !== 15) {
      schoolDays++;
      if (TRIP_DAYS[si].day < todayNum) schoolDone++;
    }
  }
  var springBreakDays = TRIP_DAYS.filter(function(d) { return d.springBreak; }).length;

  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-book-open"></i> Road School</h2>'
    + '</div>';

  // Stats cards
  html += '<div class="grid-4" style="margin-bottom:20px;">'
    + '<div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-book-open"></i></div><div class="stat-label">School Days</div><div class="stat-value">' + schoolDays + '</div><div class="stat-sub">total on this trip</div></div>'
    + '<div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-circle-check"></i></div><div class="stat-label">Days Done</div><div class="stat-value">' + schoolDone + '</div><div class="stat-sub">lessons completed</div></div>'
    + '<div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-star"></i></div><div class="stat-label">Spring Break</div><div class="stat-value">' + springBreakDays + '</div><div class="stat-sub">days off (Mar 30â€“Apr 3)</div></div>'
    + '<div class="stat-card"><div class="stat-icon"><i class="fa-solid fa-earth-americas"></i></div><div class="stat-label">Geo Lessons</div><div class="stat-value">15</div><div class="stat-sub">one per destination</div></div>'
    + '</div>';

  // â”€â”€ Kids legend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div style="display:flex;gap:10px;margin-bottom:20px;">';
  html += '<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--orange-l);border:1px solid #f0c89e;border-radius:var(--radius-s);flex:1;">'
    + '<div style="width:32px;height:32px;background:#E8813A;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.9rem;">L</div>'
    + '<div><div style="font-weight:700;font-size:.9rem;">Leila, 9</div><div style="font-size:.75rem;color:var(--text-2);">4th Grade Â· 4h/day Â· Math, ELA, Science, Geo, Art</div></div></div>';
  html += '<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--purple-l);border:1px solid #d4bbf5;border-radius:var(--radius-s);flex:1;">'
    + '<div style="width:32px;height:32px;background:#7B5EA7;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.9rem;">L</div>'
    + '<div><div style="font-weight:700;font-size:.9rem;">Luna, 4</div><div style="font-size:.75rem;color:var(--text-2);">Pre-K Â· 1â€“2h/day Â· ABCs, counting, stories, art</div></div></div>';
  html += '<div style="display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--gold-l);border:1px solid #e8d080;border-radius:var(--radius-s);flex:1;">'
    + '<div style="width:32px;height:32px;background:#D4A017;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:.9rem;">E</div>'
    + '<div><div style="font-weight:700;font-size:.9rem;">Eli, 2</div><div style="font-size:.75rem;color:var(--text-2);">Toddler Â· Play-based Â· Sensory, music, books</div></div></div>';
  html += '</div>';

  // â”€â”€ Day-by-day school schedule â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html += '<div style="display:flex;flex-direction:column;gap:8px;">';

  for (var di = 0; di < TRIP_DAYS.length; di++) {
    var d       = TRIP_DAYS[di];
    var stop    = getStop(d.stopId);
    var driver  = getDayDriver(d.day);
    var teacher = driver === 'Paul' ? 'Melissa' : 'Paul';
    var isToday = tripIsLive() && d.day === todayNum;
    var isBefore = tripIsLive() && d.day < todayNum;
    var isHome  = d.stopId === 15;

    // Skip home days
    if (isHome) continue;

    // Card border/bg
    var cardBorder = isToday      ? 'border:2px solid var(--orange);background:var(--orange-l);'
                   : d.springBreak ? 'border:1px solid var(--purple);background:var(--purple-l);'
                   : isBefore     ? 'border:1px solid var(--border);background:#fafaf8;opacity:.8;'
                   : 'border:1px solid var(--border);background:var(--card);';
    var dayBg = isToday ? 'var(--orange)' : d.springBreak ? 'var(--purple)' : isBefore ? '#aaa' : 'var(--blue)';

    html += '<div style="' + cardBorder + 'border-radius:var(--radius-s);overflow:hidden;">';

    // â”€â”€ Collapsed header row (always visible) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += '<div onclick="toggleSchoolDay(' + d.day + ')" style="display:grid;grid-template-columns:44px 1fr auto;align-items:center;gap:0;cursor:pointer;">';

    // Day number
    html += '<div style="background:' + dayBg + ';color:#fff;font-weight:800;font-size:.85rem;display:flex;align-items:center;justify-content:center;align-self:stretch;min-height:54px;">' + d.day + '</div>';

    // Title + summary
    html += '<div style="padding:9px 12px;">';
    html += '<div style="display:flex;align-items:center;gap:6px;margin-bottom:2px;">';
    if (stop) html += '<span>' + stop.emoji + '</span>';
    html += '<span style="font-weight:700;font-size:.875rem;">' + formatDate(d.date) + ' â€” ' + _sn(stop) + '</span>';
    if (isToday) html += '<span style="background:var(--orange);color:#fff;font-size:.65rem;font-weight:800;padding:1px 6px;border-radius:100px;">Today</span>';
    html += '</div>';

    if (d.springBreak) {
      html += '<div style="font-size:.78rem;color:var(--purple);font-weight:700;"><i class="fa-solid fa-star"></i> Spring Break â€” No school today!</div>';
    } else {
      var dayType = d.driveDay ? ('<i class="fa-solid fa-car-side"></i> Drive day Â· 4h school + 2h free Â· Teacher: ' + teacher) : ('<i class="fa-solid fa-campground"></i> Explore day Â· 4h school Â· Teacher: ' + teacher);
      html += '<div style="font-size:.78rem;color:var(--text-2);">' + dayType + '</div>';
    }
    html += '</div>'; // title

    // Expand chevron
    html += '<div id="chevron-' + d.day + '" style="padding:0 14px;font-size:.75rem;color:var(--text-3);">â–¼</div>';
    html += '</div>'; // header row

    // â”€â”€ Expandable detail panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += '<div id="school-day-' + d.day + '" class="hidden" style="border-top:1px solid var(--border);">';

    if (d.springBreak) {
      html += '<div style="padding:16px 20px;text-align:center;">'
        + '<div style="font-size:2rem;margin-bottom:8px;color:var(--purple);"><i class="fa-solid fa-star"></i></div>'
        + '<div style="font-weight:700;color:var(--purple);">Spring Recess!</div>'
        + '<div style="font-size:.85rem;color:var(--text-2);margin-top:4px;">No lessons today â€” explore, play, and enjoy the adventure.</div>'
        + '</div>';
    } else {
      // Schedule blocks
      var blocks = d.driveDay ? getDriveDaySchedule(driver) : EXPLORE_DAY_SCHEDULE;

      html += '<div style="padding:12px 16px;">';

      // Schedule table
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:10px;">ğŸ“‹ Daily Schedule</div>';
      html += '<div style="border:1px solid var(--border);border-radius:var(--radius-s);overflow:hidden;margin-bottom:14px;">';
      html += '<div style="display:grid;grid-template-columns:80px 1fr 1fr 1fr 70px;background:var(--blue);color:#fff;font-size:.72rem;font-weight:700;padding:6px 10px;gap:8px;">'
        + '<div>TIME</div><div>ğŸŸ  LEILA (4th)</div><div>ğŸŸ£ LUNA (Pre-K)</div><div>ğŸŸ¡ ELI (Toddler)</div><div>TEACHER</div></div>';

      for (var bi = 0; bi < blocks.length; bi++) {
        var blk = blocks[bi];
        var blkBg = blk.type === 'school' ? 'var(--card)' : blk.type === 'break' ? 'var(--green-l)' : 'var(--blue-l)';
        var teacherColor = blk.teacher === 'Paul' ? '#2C5F8A' : blk.teacher === 'Melissa' ? '#3A8A5C' : 'var(--text-3)';
        html += '<div style="display:grid;grid-template-columns:80px 1fr 1fr 1fr 70px;background:' + blkBg + ';font-size:.78rem;padding:8px 10px;gap:8px;border-top:1px solid var(--border);">'
          + '<div style="font-weight:700;color:var(--text-2);">' + blk.time + '</div>'
          + '<div>' + blk.leila + '</div>'
          + '<div>' + blk.luna + '</div>'
          + '<div>' + blk.eli + '</div>'
          + '<div style="font-weight:700;color:' + teacherColor + ';font-size:.72rem;">' + blk.teacher + '</div>'
          + '</div>';
      }
      html += '</div>'; // table

      // Geo fact for this stop
      var geoFact = GEO_FACTS[d.stopId] || '';
      if (geoFact) {
        html += '<div style="background:var(--purple-l);border:1px solid #d4bbf5;border-radius:var(--radius-s);padding:12px 14px;margin-bottom:14px;">'
          + '<div style="font-weight:700;font-size:.8rem;color:var(--purple);margin-bottom:4px;">ğŸ—ºï¸ Today\'s Geography Lesson</div>'
          + '<div style="font-size:.82rem;color:var(--text);">' + geoFact + '</div>'
          + '</div>';
      }

      // Leila subject chips
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;">ğŸ“š Leila\'s Subjects Today</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:14px;">';
      for (var sj = 0; sj < LEILA_SUBJECTS.length; sj++) {
        var sub = LEILA_SUBJECTS[sj];
        html += '<div style="display:flex;align-items:center;gap:5px;padding:5px 10px;background:' + sub.color + '15;border:1px solid ' + sub.color + '40;border-radius:20px;">'
          + '<span style="font-size:.85rem;">' + sub.icon + '</span>'
          + '<span style="font-size:.78rem;font-weight:600;color:' + sub.color + ';">' + sub.label + '</span>'
          + '</div>';
      }
      html += '</div>';

      // Luna activities
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;">ğŸŸ£ Luna\'s Activities</div>';
      html += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:10px;">';
      for (var la = 0; la < LUNA_ACTIVITIES.length; la++) {
        var act = LUNA_ACTIVITIES[la];
        html += '<div style="display:flex;align-items:center;gap:5px;padding:5px 10px;background:var(--purple-l);border:1px solid #d4bbf5;border-radius:20px;">'
          + '<span>' + act.icon + '</span>'
          + '<span style="font-size:.78rem;font-weight:600;color:var(--purple);">' + act.label + '</span>'
          + '</div>';
      }
      html += '</div>';

      html += '</div>'; // padding
    }

    html += '</div>'; // expandable
    html += '</div>'; // card
  }

  html += '</div>'; // day list
  el.innerHTML = html;
}

/* â”€â”€ TOGGLE SCHOOL DAY EXPAND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleSchoolDay(dayNum) {
  var panel   = document.getElementById('school-day-' + dayNum);
  var chevron = document.getElementById('chevron-' + dayNum);
  if (!panel) return;
  var isHidden = panel.classList.contains('hidden');
  panel.classList.toggle('hidden');
  if (chevron) chevron.textContent = isHidden ? 'â–²' : 'â–¼';
}


/* â”€â”€ PLAN / FAVORITES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function isPlan(stopId, type, idx) {
  if (!appState.planned) return false;
  return !!appState.planned['p_' + stopId + '_' + type + '_' + idx];
}
function togglePlan(stopId, type, idx, dayNum) {
  if (!appState.planned) appState.planned = {};
  var key = 'p_' + stopId + '_' + type + '_' + idx;
  var adding = !appState.planned[key];
  if (adding) { appState.planned[key] = dayNum || true; }
  else { delete appState.planned[key]; }
  saveState(appState);
  renderStops();
  renderSchedule();
  showToast(adding ? ('Added to Day ' + (dayNum || '?') + '!') : 'Removed from plan', 1800);
}
var _planPickerCtx = null;
function openPlanPicker(stopId, type, idx) {
  if (!appState.planned) appState.planned = {};
  var key = 'p_' + stopId + '_' + type + '_' + idx;
  // If already planned, toggle off
  if (appState.planned[key]) {
    delete appState.planned[key];
    saveState(appState);
    renderStops(); renderSchedule();
    showToast('Removed from plan', 1600); return;
  }
  var stop = getStop(stopId);
  var item = type === 'a' ? (stop && (stop.activities||[])[idx]) : (stop && (stop.restaurants||[])[idx]);
  var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  _planPickerCtx = { stopId: stopId, type: type, idx: idx };
  var modal = document.getElementById('plan-day-modal');
  document.getElementById('pdm-title').textContent = (item ? item.name : 'Place') + ' \u2192 Add to Plan';
  document.getElementById('pdm-sub').textContent = 'Which day will you do this?';
  var daysHtml = '';
  for (var di = 0; di < stopDays.length; di++) {
    var sd = stopDays[di];
    var dObj3 = new Date(sd.date + 'T12:00:00');
    var dLabel = dObj3.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
    daysHtml += '<button onclick="confirmPlan(' + stopId + ',\'' + type + '\',' + idx + ',' + sd.day + ')" style="background:var(--blue-l);border:1px solid var(--blue);color:var(--blue);border-radius:100px;padding:9px 14px;font-size:.88rem;font-weight:700;cursor:pointer;font-family:var(--font);text-align:left;display:flex;justify-content:space-between;align-items:center;">'
      + '<span>' + dLabel + '</span>'
      + '<span style="font-size:.75rem;color:var(--text-2);">Day ' + sd.day + (sd.driveDay ? ' \u2022 Drive day' : '') + '</span>'
      + '</button>';
  }
  document.getElementById('pdm-days').innerHTML = daysHtml;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function confirmPlan(stopId, type, idx, dayNum) {
  closePlanPicker();
  togglePlan(stopId, type, idx, dayNum);
}
function closePlanPicker() {
  document.getElementById('plan-day-modal').classList.add('hidden');
  document.body.style.overflow = '';
}
function getPlannedForStop(stopId, forDay) {
  var result = { activities: [], restaurants: [] };
  if (!appState.planned) return result;
  var stop = getStop(stopId);
  if (!stop) return result;
  /* Find first day of this stop so old val===true items show only once */
  var stopDaysAll = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  var firstStopDay = stopDaysAll.length ? stopDaysAll[0].day : null;
  var stopActs  = stop.activities  || [];
  var stopRests = stop.restaurants || [];
  for (var ai = 0; ai < stopActs.length; ai++) {
    var val = appState.planned['p_' + stopId + '_a_' + ai];
    if (!val) continue;
    if (forDay == null) { result.activities.push(ai); continue; }
    /* val===true (legacy) â†’ show only on first day of stop; otherwise match exact day */
    if (val === true ? forDay === firstStopDay : val === forDay) result.activities.push(ai);
  }
  for (var ri = 0; ri < stopRests.length; ri++) {
    var valr = appState.planned['p_' + stopId + '_r_' + ri];
    if (!valr) continue;
    if (forDay == null) { result.restaurants.push(ri); continue; }
    if (valr === true ? forDay === firstStopDay : valr === forDay) result.restaurants.push(ri);
  }
  return result;
}

/* â”€â”€ STOPS RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderStops() {
  var el = document.getElementById('stops-content');
  if (!el) return;

  var todayNum = tripDay();
  var totalActs = 0;
  var totalRests = 0;
  for (var si2 = 0; si2 < TRIP_STOPS.length; si2++) {
    totalActs  += (TRIP_STOPS[si2].activities  || []).length;
    totalRests += (TRIP_STOPS[si2].restaurants || []).length;
  }
  var totalPlanned = appState.planned ? Object.keys(appState.planned).length : 0;

  var html = '';

  // Header
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-map-pin"></i> Trip Stops</h2>';
  if (totalPlanned > 0) {
    html += '<div style="background:var(--green);color:#fff;font-size:.75rem;font-weight:800;padding:4px 12px;border-radius:12px;">'
      + totalPlanned + ' item' + (totalPlanned !== 1 ? 's' : '') + ' planned</div>';
  }
  html += '</div>';

  // Stats
  html += '<div class="grid-4" style="margin-bottom:20px;">'
    + '<div class="stat-card"><div class="stat-icon">&#128205;</div><div class="stat-label">Destinations</div><div class="stat-value">' + TRIP_STOPS.length + '</div><div class="stat-sub">stops on the route</div></div>'
    + '<div class="stat-card"><div class="stat-icon">&#127939;</div><div class="stat-label">Activities</div><div class="stat-value">' + totalActs + '</div><div class="stat-sub">stroller-friendly picks</div></div>'
    + '<div class="stat-card"><div class="stat-icon">&#127869;</div><div class="stat-label">Restaurants</div><div class="stat-value">' + totalRests + '</div><div class="stat-sub">family-friendly picks</div></div>'
    + '<div class="stat-card"><div class="stat-icon">&#9989;</div><div class="stat-label">Planned</div><div class="stat-value">' + totalPlanned + '</div><div class="stat-sub">activities &amp; restaurants</div></div>'
    + '</div>';

  html += '<div style="display:flex;flex-direction:column;gap:20px;">';

  for (var i = 0; i < TRIP_STOPS.length; i++) {
    var stop = TRIP_STOPS[i];
    var stopDays = [];
    for (var di = 0; di < TRIP_DAYS.length; di++) {
      if (TRIP_DAYS[di].stopId === stop.id) stopDays.push(TRIP_DAYS[di]);
    }
    var firstDay = stopDays.length > 0 ? stopDays[0] : null;
    var lastDay  = stopDays.length > 0 ? stopDays[stopDays.length - 1] : null;
    var nights   = stopDays.length;
    var isCurrentStop = false;
    if (tripIsLive() && appState.tripStarted) {
      for (var cs = 0; cs < stopDays.length; cs++) {
        if (stopDays[cs].day === todayNum) { isCurrentStop = true; break; }
      }
    }
    var isPastStop = tripIsLive() && appState.tripStarted && lastDay && lastDay.day < todayNum && !isCurrentStop;
    var dateRange = firstDay ? formatDate(firstDay.date) : '';
    if (firstDay && lastDay && firstDay.date !== lastDay.date) {
      dateRange += ' â€“ ' + formatDate(lastDay.date);
    }
    var planned = getPlannedForStop(stop.id);
    var plannedCount = planned.activities.length + planned.restaurants.length;

    var cardStyle = isCurrentStop  ? 'border-left:4px solid var(--orange);background:var(--orange-l);box-shadow:0 2px 12px rgba(232,129,58,.15);'
      : isPastStop ? 'background:#fafaf8;opacity:.82;box-shadow:none;'
      : 'background:var(--card);box-shadow:0 1px 3px rgba(0,0,0,.04),0 4px 14px rgba(0,0,0,.07);';
    var headerBg = isCurrentStop ? 'var(--orange)' : isPastStop ? '#bbb' : 'var(--blue)';

    html += '<div style="' + cardStyle + 'border-radius:var(--radius-s);overflow:hidden;">';

    // Compute weather range for this stop â€” prefer live fetched data, fall back to static typical weather
    var _swHi = null, _swLo = null, _swIcon = '', _swTypical = false;
    if (appState.weather && appState.weather[stop.id]) {
      for (var _swd = 0; _swd < stopDays.length; _swd++) {
        var _swDay = stopDays[_swd];
        var _swx = appState.weather[stop.id][_swDay.date];
        if (_swx) {
          if (_swx.high != null && (_swHi === null || _swx.high > _swHi)) _swHi = _swx.high;
          if (_swx.low  != null && (_swLo === null || _swx.low  < _swLo)) _swLo = _swx.low;
          if (!_swIcon && _swx.code != null) {
            _swIcon = (function(c){
              if (c===0) return 'â˜€ï¸'; if (c<=2) return 'â›…'; if (c<=49) return 'â˜ï¸';
              if (c<=67) return 'ğŸŒ§ï¸'; if (c<=77) return 'â„ï¸'; return 'â›ˆï¸';
            })(_swx.code);
          }
        }
      }
    }
    // Fall back to static historical typical weather when live data isn't available
    if (_swHi === null && STOP_WEATHER[stop.id]) {
      var _stw = STOP_WEATHER[stop.id];
      _swHi = _stw.hi; _swLo = _stw.lo; _swIcon = _stw.icon || 'ğŸŒ¡ï¸';
      _swTypical = true; // flag so we can label it "typical" vs live
    }
    var _wxStr = (_swHi !== null && _swLo !== null)
      ? (_swIcon||'ğŸŒ¡ï¸') + ' ' + Math.round(_swLo) + 'Â°â€“' + Math.round(_swHi) + 'Â°F' + (_swTypical ? ' typical' : '')
      : 'â€”';
    // Compact date label for columns (e.g. "2/28â€“3/6")
    var _dateShort = firstDay ? firstDay.date.slice(5).replace('-','/') : '';
    if (firstDay && lastDay && firstDay.date !== lastDay.date)
      _dateShort += 'â€“' + lastDay.date.slice(5).replace('-','/');

    // â”€â”€ Grid header row â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += '<div class="sc-header" onclick="toggleStop(' + stop.id + ')">';

    // Col 1: emoji strip
    html += '<div class="sc-emoji-col" style="background:' + headerBg + ';color:#fff;">'
      + '<div style="font-size:1.5rem;line-height:1;">' + stop.emoji + '</div>'
      + '<div style="font-size:.63rem;opacity:.85;font-weight:700;">#' + stop.id + '</div>'
      + '</div>';

    // Col 2: name + inline subtitle (always visible)
    html += '<div class="sc-name-col">';
    html += '<div style="display:flex;align-items:center;flex-wrap:wrap;gap:5px;margin-bottom:1px;">'
      + '<span style="font-weight:800;font-size:1rem;">' + _sn(stop) + '</span>';
    if (isCurrentStop)  html += '<span style="background:var(--orange);color:#fff;font-size:.6rem;font-weight:800;padding:2px 7px;border-radius:100px;">HERE NOW</span>';
    else if (isPastStop) html += '<span style="background:#888;color:#fff;font-size:.6rem;font-weight:800;padding:2px 7px;border-radius:100px;">&#10003; Visited</span>';
    if (plannedCount > 0) html += '<span style="background:var(--green);color:#fff;font-size:.6rem;font-weight:800;padding:2px 7px;border-radius:100px;">&#9989; ' + plannedCount + ' planned</span>';
    html += '</div>';
    // Subtitle: dates Â· nights Â· weather â€” always visible
    var _wxBadge = _wxStr !== 'â€”'
      ? '<span style="background:var(--blue-l);color:var(--blue);font-size:.72rem;font-weight:700;padding:1px 7px;border-radius:100px;white-space:nowrap;">' + _wxStr + '</span>'
      : '';
    html += '<div class="sc-mobile-meta" style="font-size:.78rem;color:var(--text-2);display:flex;flex-wrap:wrap;align-items:center;gap:5px;">'
      + '<span>' + dateRange + '</span>'
      + '<span style="color:var(--text-3);">&middot;</span>'
      + '<span>' + nights + ' night' + (nights !== 1 ? 's' : '') + '</span>'
      + (_wxBadge ? '<span style="color:var(--text-3);">&middot;</span>' + _wxBadge : '')
      + '</div>';
    html += '</div>'; // sc-name-col

    // Forecast button
    html += '<div class="sc-fcst-col">'
      + '<button onclick="event.stopPropagation();showStopForecastModal(' + stop.id + ')" style="background:#fff;border:1.5px solid var(--blue);color:var(--blue);border-radius:100px;font-size:.75rem;font-weight:800;padding:6px 11px;cursor:pointer;font-family:var(--font);white-space:nowrap;display:flex;align-items:center;gap:5px;"><i class="fa-solid fa-cloud-sun"></i> Forecast</button>'
      + '</div>';

    // Chevron
    html += '<div id="stop-chevron-' + stop.id + '" class="sc-chevron-col">&#9660;</div>';

    html += '</div>'; // sc-header

    // Expandable
    html += '<div id="stop-detail-' + stop.id + '" class="hidden" style="border-top:1px solid var(--border);">';
    html += '<div style="padding:16px;">';

    // Description
    html += '<div style="font-size:.875rem;color:var(--text);line-height:1.6;margin-bottom:14px;padding:12px 14px;background:var(--bg);border-radius:var(--radius-s);">' + stop.description + '</div>';

    // Highlights
    if (stop.highlights && stop.highlights.length > 0) {
      html += '<div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:18px;">';
      for (var hi = 0; hi < stop.highlights.length; hi++) {
        html += '<div style="padding:5px 12px;background:var(--blue-l);border:1px solid #c0d8ec;border-radius:20px;font-size:.78rem;font-weight:600;color:var(--blue);">&#11088; ' + stop.highlights[hi] + '</div>';
      }
      html += '</div>';
    }

    // ACTIVITIES
    var stopActivities  = stop.activities  || [];
    var stopRestaurants = stop.restaurants || [];
    html += '<div style="font-weight:700;font-size:.78rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;"><i class="fa-solid fa-person-hiking"></i> Activities &amp; Things To Do</div>';
    html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">';
    if (!stopActivities.length) html += '<div style="font-size:.83rem;color:var(--text-2);padding:10px 0;">No activities listed yet for this stop.</div>';

    for (var ai = 0; ai < stopActivities.length; ai++) {
      var act = stopActivities[ai];
      var isPlannedA = isPlan(stop.id, 'a', ai);
      var kidStars = '';
      for (var ks = 0; ks < 5; ks++) { kidStars += (ks < act.kidRating) ? '&#9733;' : '&#9734;'; }
      var actIcon = act.type === 'hike'       ? '&#129406; Hike'
                  : act.type === 'scenic'     ? '&#128663; Scenic'
                  : act.type === 'outdoor'    ? '&#127754; Outdoor'
                  : act.type === 'attraction' ? '&#127903; Attraction'
                  : act.type === 'town'       ? '&#127963; Town'
                  : act.type === 'food'       ? '&#127830; Food'
                  : '&#10024; Activity';
      var actBg = act.type === 'hike' ? '#3A8A5C' : act.type === 'scenic' ? '#2C5F8A'
                : act.type === 'outdoor' ? '#5A8A2C' : act.type === 'attraction' ? '#8A2C7B'
                : act.type === 'food' ? '#C96820' : '#6B6560';
      var planBtnA = isPlannedA
        ? 'background:var(--green);color:#fff;border:none;'
        : 'background:var(--green-l);color:var(--green);border:1px solid #a8d5b8;';

      html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-s);padding:11px 14px;cursor:pointer;" onclick="openPlaceInfo(\'a\',' + stop.id + ',' + ai + ')">';
      html += '<div style="display:flex;align-items:flex-start;gap:10px;">';
      html += '<div style="flex:1;">';
      html += '<div style="display:flex;align-items:center;flex-wrap:wrap;gap:6px;margin-bottom:5px;">';
      html += '<span style="font-weight:700;font-size:.875rem;">' + act.name + '</span>';
      html += '<span style="background:' + actBg + ';color:#fff;font-size:.63rem;font-weight:700;padding:2px 8px;border-radius:100px;">' + actIcon + '</span>';
      if (act.toddlerOk) html += '<span style="background:#3A8A5C;color:#fff;font-size:.63rem;font-weight:700;padding:2px 8px;border-radius:100px;">&#128188; Toddler OK</span>';
      if (act.duration)  html += '<span style="background:var(--bg);color:var(--text-2);font-size:.63rem;padding:2px 8px;border-radius:100px;border:1px solid var(--border);">&#9200; ' + act.duration + '</span>';
      html += '</div>';
      html += '<div style="font-size:.82rem;color:var(--text-2);line-height:1.5;margin-bottom:6px;">' + act.desc + '</div>';
      if (act.website) {
        html += '<a href="https://' + act.website + '" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="font-size:.75rem;color:var(--blue);text-decoration:none;"><i class="fa-solid fa-arrow-up-right-from-square"></i> ' + act.website + '</a>';
      }
      html += '</div>';
      html += '<div style="text-align:center;min-width:56px;display:flex;flex-direction:column;align-items:center;gap:6px;">';
      html += '<div><div style="font-size:.82rem;font-weight:700;color:var(--text-2);">' + act.kidRating + '<span style="color:#E8813A;">&#9733;</span></div><div style="font-size:.62rem;color:var(--text-3);">kids</div></div>';
      html += '<button onclick="event.stopPropagation();openPlanPicker(' + stop.id + ',\'a\',' + ai + ')" style="' + planBtnA + 'border-radius:100px;font-family:var(--font);font-size:.7rem;font-weight:800;padding:5px 8px;cursor:pointer;white-space:nowrap;">'
        + (isPlannedA ? '&#9989; Planned' : '+ Plan') + '</button>';
      html += '<span style="font-size:.9rem;color:var(--text-3);">&#8250;</span>';
      html += '</div>';
      html += '</div></div>';
    }
    html += '</div>';

    // RESTAURANTS
    html += '<div style="font-weight:700;font-size:.78rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;"><i class="fa-solid fa-utensils"></i> Top Restaurants</div>';
    html += '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">';
    if (!stopRestaurants.length) html += '<div style="font-size:.83rem;color:var(--text-2);padding:10px 0;">No restaurants listed yet for this stop.</div>';

    for (var ri = 0; ri < stopRestaurants.length; ri++) {
      var rest = stopRestaurants[ri];
      var isPlannedR = isPlan(stop.id, 'r', ri);
      var restDesc = rest.desc || '';
      var roundedR = Math.round(rest.rating);
      var restStars = '';
      for (var rs = 0; rs < 5; rs++) { restStars += (rs < roundedR) ? '&#9733;' : '&#9734;'; }
      var priceBg  = rest.price === '$' ? 'var(--green-l)' : rest.price === '$$$' ? 'var(--red-l)' : 'var(--gold-l)';
      var priceClr = rest.price === '$' ? 'var(--green)'   : rest.price === '$$$' ? 'var(--red)'   : 'var(--gold)';
      var planBtnR = isPlannedR
        ? 'background:var(--green);color:#fff;border:none;'
        : 'background:var(--green-l);color:var(--green);border:1px solid #a8d5b8;';

      html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-s);padding:11px 14px;cursor:pointer;" onclick="openPlaceInfo(\'r\',' + stop.id + ',' + ri + ')">';
      html += '<div style="display:flex;align-items:flex-start;gap:10px;">';
      html += '<div style="flex:1;">';
      html += '<div style="display:flex;align-items:center;flex-wrap:wrap;gap:7px;margin-bottom:4px;">';
      html += '<span style="font-weight:700;font-size:.875rem;">' + rest.name + '</span>';
      html += '<span style="font-size:.75rem;color:var(--text-3);">' + rest.type + '</span>';
      html += '</div>';
      html += '<div style="font-size:.82rem;color:var(--text-2);line-height:1.5;margin-bottom:6px;">' + restDesc + '</div>';
      if (rest.hours) {
        html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:4px;">';
        html += '<span style="font-size:.72rem;color:var(--text-2);">&#128341; ' + rest.hours + '</span>';
        if (rest.address) html += '<span style="font-size:.72rem;color:var(--text-3);">&#128205; ' + rest.address + '</span>';
        html += '</div>';
      }
      if (rest.website) {
        html += '<a href="https://' + rest.website + '" target="_blank" rel="noopener" onclick="event.stopPropagation()" style="font-size:.75rem;color:var(--blue);text-decoration:none;"><i class="fa-solid fa-arrow-up-right-from-square"></i> ' + rest.website + '</a>';
      }
      html += '</div>';
      html += '<div style="text-align:center;min-width:58px;display:flex;flex-direction:column;align-items:center;gap:5px;">';
      html += '<div>'
        + '<div style="font-size:.82rem;font-weight:700;color:var(--text-2);">' + rest.rating + '<span style="color:#E8813A;">&#9733;</span></div>'
        + '<div style="font-size:.72rem;font-weight:800;color:' + priceClr + ';background:' + priceBg + ';border-radius:12px;padding:1px 6px;">' + rest.price + '</div></div>';
      html += '<button onclick="event.stopPropagation();openPlanPicker(' + stop.id + ',\'r\',' + ri + ')" style="' + planBtnR + 'border-radius:100px;font-family:var(--font);font-size:.7rem;font-weight:800;padding:5px 8px;cursor:pointer;white-space:nowrap;">'
        + (isPlannedR ? '&#9989; Planned' : '+ Plan') + '</button>';
      html += '<span style="font-size:.9rem;color:var(--text-3);">&#8250;</span>';
      html += '</div>';
      html += '</div></div>';
    }
    html += '</div>';

    // SLEEP
    var stopSleepOptions = stop.sleepOptions || [];
    html += '<div style="font-weight:700;font-size:.78rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;"><i class="fa-solid fa-moon"></i> Sleep Options</div>';
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:18px;">';
    if (!stopSleepOptions.length) html += '<div style="font-size:.83rem;color:var(--text-2);">No sleep options listed yet â€” check RV parks near this stop.</div>';
    for (var soi = 0; soi < stopSleepOptions.length; soi++) {
      var so2 = stopSleepOptions[soi];
      var isWM2   = so2.toLowerCase().indexOf('walmart') !== -1;
      var isHome2 = so2.toLowerCase().indexOf('home') !== -1;
      var soIcon  = isHome2 ? '&#127968;' : isWM2 ? '&#87;' : '&#127957;';
      var soBg    = isHome2 ? 'var(--green-l)' : isWM2 ? 'var(--gold-l)' : 'var(--blue-l)';
      var soBdr   = isHome2 ? '#a8d5b8' : isWM2 ? '#e8c840' : '#c0d8ec';
      var soClr   = isHome2 ? 'var(--green)' : isWM2 ? '#9A7000' : 'var(--blue)';
      html += '<div style="display:flex;align-items:center;gap:6px;padding:7px 13px;background:' + soBg + ';border:1px solid ' + soBdr + ';border-radius:20px;font-size:.8rem;font-weight:600;color:' + soClr + ';">'
        + soIcon + ' ' + so2 + '</div>';
    }
    html += '</div>';

    // Links
    var mUrl = 'https://www.google.com/maps/search/?api=1&query=' + stop.weatherLat + ',' + stop.weatherLng;
    html += '<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:14px;">';
    html += '<button onclick="closePlaceInfo();showStopForecastModal(' + stop.id + ')" style="display:flex;align-items:center;gap:7px;padding:9px 16px;background:var(--blue-l);border:1px solid #b0ccde;border-radius:var(--radius-s);font-size:.82rem;font-weight:700;color:var(--blue);cursor:pointer;font-family:var(--font);"><i class="fa-solid fa-cloud-sun"></i> Weather Forecast</button>';
    html += '<a href="' + mUrl + '" target="_blank" rel="noopener" style="display:flex;align-items:center;gap:7px;padding:9px 16px;background:var(--green-l);border:1px solid #a8d5b8;border-radius:var(--radius-s);font-size:.82rem;font-weight:700;color:var(--green);text-decoration:none;"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a>';
    html += '<button id="stop-events-btn-' + stop.id + '" onclick="event.stopPropagation();toggleStopEvents(' + stop.id + ')" style="display:flex;align-items:center;gap:7px;padding:9px 16px;background:var(--purple-l);border:1px solid #c9b8e8;border-radius:var(--radius-s);font-size:.82rem;font-weight:700;color:var(--purple);cursor:pointer;font-family:var(--font);"><i class="fa-solid fa-calendar-star"></i> Events Near Here</button>';
    html += '</div>';

    // Events expandable panel
    html += '<div id="stop-events-panel-' + stop.id + '" class="hidden" style="margin-top:2px;border:1px solid #c9b8e8;border-radius:var(--radius-s);overflow:hidden;">'
      + '<div style="background:var(--purple);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:8px 14px;">'
      + '<span style="font-size:.78rem;font-weight:800;text-transform:uppercase;letter-spacing:.05em;"><i class="fa-solid fa-calendar-star"></i> Events Near ' + stop.name + '</span>'
      + '<button onclick="event.stopPropagation();_stopEventsLoaded[' + stop.id + ']=false;loadStopEvents(' + stop.id + ')" style="background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:100px;padding:3px 9px;font-size:.72rem;font-weight:700;cursor:pointer;font-family:var(--font);">&#8635; Refresh</button>'
      + '</div>'
      + '<div id="stop-events-body-' + stop.id + '"></div>'
      + '</div>';

    html += '</div></div></div>';
  }

  html += '</div>';
  el.innerHTML = html;
}

function toggleStop(stopId) {
  var panel   = document.getElementById('stop-detail-' + stopId);
  var chevron = document.getElementById('stop-chevron-' + stopId);
  if (!panel) return;
  var isHidden = panel.classList.contains('hidden');
  panel.classList.toggle('hidden');
  if (chevron) chevron.textContent = isHidden ? 'â–²' : 'â–¼';
}


/* â”€â”€ JOURNAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _journalEntries  = [];
var _pendingPhotos   = [];
var _pendingAudio    = null;
var _mediaRecorder   = null;
var _audioChunks     = [];
var _recTimerInt     = null;
var _recSeconds      = 0;
var _photoLookup     = [];

function loadJournal() {
  try {
    var raw = localStorage.getItem('rv_journal');
    _journalEntries = raw ? JSON.parse(raw) : [];
  } catch(e) { _journalEntries = []; }
}

function saveJournal() {
  try {
    localStorage.setItem('rv_journal', JSON.stringify(_journalEntries));
  } catch(e) {
    showToast('Storage full â€” try removing some photos to free space', 4000);
  }
}

function renderJournal() {
  loadJournal();
  var todayNum = tripDay();

  // Populate day selector once
  var sel = document.getElementById('j-day');
  if (sel && sel.options.length === 0) {
    for (var di = 0; di < TRIP_DAYS.length; di++) {
      var d = TRIP_DAYS[di];
      var opt = document.createElement('option');
      opt.value = d.day;
      opt.textContent = 'Day ' + d.day + ' \u2014 ' + formatDate(d.date);
      if (d.day === todayNum) opt.selected = true;
      sel.appendChild(opt);
    }
    updateJournalLocation();
  }

  // Populate location select once
  var locSel = document.getElementById('j-location-select');
  if (locSel && locSel.options.length === 0) {
    var locGrp = document.createElement('optgroup');
    locGrp.label = 'Trip Stops';
    for (var si = 0; si < TRIP_STOPS.length; si++) {
      var st = TRIP_STOPS[si];
      var lo = document.createElement('option');
      lo.value = 'stop:' + st.id;
      lo.textContent = st.emoji + ' ' + st.name + ', ' + st.state;
      locGrp.appendChild(lo);
    }
    locSel.appendChild(locGrp);
    // Sync to current day's stop
    var curDay = getDay(parseInt(sel.value));
    if (curDay) {
      for (var li = 0; li < locSel.options.length; li++) {
        if (locSel.options[li].value === 'stop:' + curDay.stopId) {
          locSel.selectedIndex = li; break;
        }
      }
    }
  }

  // Pre-select author from logged-in profile
  var authorSel = document.getElementById('j-author');
  if (authorSel && _userName) {
    for (var ai = 0; ai < authorSel.options.length; ai++) {
      if (authorSel.options[ai].value === _userName) {
        authorSel.selectedIndex = ai;
        break;
      }
    }
  }

  // Entry count badge
  var countEl = document.getElementById('journal-count');
  if (countEl) {
    var n = _journalEntries.length;
    countEl.textContent = n + ' entr' + (n === 1 ? 'y' : 'ies');
  }

  renderJournalEntries();
}

function updateJournalLocation() {
  var sel    = document.getElementById('j-day');
  var locSel = document.getElementById('j-location-select');
  if (!sel) return;
  var dayNum = parseInt(sel.value);
  var d = getDay(dayNum);
  if (d && locSel && locSel.options.length > 0) {
    for (var li = 0; li < locSel.options.length; li++) {
      if (locSel.options[li].value === 'stop:' + d.stopId) {
        locSel.selectedIndex = li; break;
      }
    }
  }
}

function _buildPhotoCaption(exif) {
  if (!exif) return '';
  var parts = [];
  if (exif.locationName) parts.push('ğŸ“ ' + exif.locationName);
  if (exif.dt) {
    try {
      var d = new Date(exif.dt);
      if (!isNaN(d.getTime())) {
        parts.push('ğŸ• ' + d.toLocaleDateString('en-US', { month:'short', day:'numeric' })
          + ' ' + d.toLocaleTimeString('en-US', { hour:'numeric', minute:'2-digit' }));
      }
    } catch(e) {}
  } else if (exif.lat != null) {
    parts.push('ğŸ“ ' + exif.lat.toFixed(4) + ', ' + exif.lon.toFixed(4));
  }
  return parts.join('  Â·  ');
}

function renderJournalEntries() {
  var container = document.getElementById('journal-entries');
  if (!container) return;
  _photoLookup = [];

  if (_journalEntries.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:48px 20px;color:var(--text-3);">'
      + '<div style="font-size:2.5rem;margin-bottom:12px;">\uD83D\uDCD4</div>'
      + '<div style="font-weight:700;font-size:.95rem;margin-bottom:6px;">No entries yet</div>'
      + '<div style="font-size:.82rem;">Write your first journal entry above!</div>'
      + '</div>';
    return;
  }

  // Sort newest day first
  var sorted = _journalEntries.slice().sort(function(a, b) { return b.day - a.day; });

  var html = '<div style="display:flex;flex-direction:column;gap:14px;">';

  for (var i = 0; i < sorted.length; i++) {
    var entry = sorted[i];
    var stop  = getStop(entry.stopId);
    var stopLabel = entry.location || (stop ? (stop.emoji + ' ' + _sn(stop)) : '');

    html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px;box-shadow:var(--shadow);">';

    // â”€â”€ Entry header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    html += '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;">';
    html += '<div>';
    var authorName = entry.author || 'Family';
    var authorBg = authorName === 'Paul' ? '#2C5F8A' : authorName === 'Melissa' ? '#3A8A5C' : authorName === 'Leila' ? '#E8813A' : authorName === 'Luna' ? '#7B5EA7' : '#D4A017';
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">';
    html += '<span style="background:var(--gold);color:#fff;font-size:.7rem;font-weight:800;padding:3px 10px;border-radius:100px;">Day ' + entry.day + '</span>';
    html += '<span style="background:' + authorBg + ';color:#fff;font-size:.7rem;font-weight:800;padding:3px 10px;border-radius:100px;">' + authorName + '</span>';
    html += '<span style="font-weight:700;font-size:.875rem;">' + formatDate(entry.date) + '</span>';
    html += '</div>';
    html += '<div style="font-size:.8rem;color:var(--text-2);">' + stopLabel + '</div>';
    html += '</div>';
    html += '<div style="display:flex;gap:4px;">';
    html += '<button id="jclean-' + entry.id + '" onclick="cleanupJournalEntry(' + entry.id + ')" title="AI cleanup" style="background:#F3E8FF;border:1px solid #D0B4F0;color:#7B5EA7;border-radius:100px;cursor:pointer;font-size:.68rem;font-weight:800;padding:4px 8px;font-family:var(--font);">&#129302; Clean up</button>';
    html += '<button onclick="deleteJournalEntry(' + entry.id + ')" title="Delete entry" style="background:none;border:none;cursor:pointer;color:var(--text-3);font-size:1rem;padding:4px 6px;"><i class="fa-solid fa-trash-can"></i></button>';
    html += '</div>';
    html += '</div>';

    // â”€â”€ Note text â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (entry.text) {
      var safeText = entry.text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      html += '<div style="font-size:.875rem;line-height:1.65;color:var(--text);margin-bottom:14px;white-space:pre-wrap;">' + safeText + '</div>';
    }

    // â”€â”€ Photos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (entry.photos && entry.photos.length > 0) {
      html += '<div style="display:flex;flex-wrap:wrap;gap:10px;margin-bottom:12px;">';
      for (var pi = 0; pi < entry.photos.length; pi++) {
        var photo = entry.photos[pi];
        // Support legacy plain string photos and new {dataUrl, exif} objects
        var pSrc  = (photo && photo.dataUrl) ? photo.dataUrl : photo;
        var pExif = (photo && photo.exif)    ? photo.exif    : null;
        var pIdx  = _photoLookup.length;
        _photoLookup.push({ dataUrl: pSrc, caption: _buildPhotoCaption(pExif) });
        // Caption text: "ğŸ“ City, State  |  ğŸ• Mar 15 2:34 PM"
        var capLine = _buildPhotoCaption(pExif);
        html += '<div style="display:inline-flex;flex-direction:column;align-items:center;gap:3px;">'
          + '<img src="' + pSrc + '" '
          + 'onclick="openPhotoModal(' + pIdx + ')" '
          + 'style="width:88px;height:88px;object-fit:cover;border-radius:var(--radius-s);cursor:zoom-in;border:2px solid var(--border);transition:border-color .15s;" />'
          + (capLine ? '<div style="font-size:.6rem;color:var(--text-3);text-align:center;max-width:88px;line-height:1.35;">' + capLine + '</div>' : '')
          + '</div>';
      }
      html += '</div>';
    }

    // â”€â”€ Audio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (entry.audio) {
      html += '<div style="margin-top:4px;">';
      html += '<div style="font-size:.72rem;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:6px;">'
        + '<i class="fa-solid fa-microphone"></i> Voice Memo</div>';
      html += '<audio controls src="' + entry.audio + '" style="width:100%;max-width:360px;height:36px;"></audio>';
      html += '</div>';
    }

    // â”€â”€ Timestamp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (entry.created) {
      var ts = new Date(entry.created);
      var tsStr = ts.toLocaleString('en-US', { month:'short', day:'numeric', hour:'numeric', minute:'2-digit' });
      html += '<div style="font-size:.7rem;color:var(--text-3);margin-top:10px;border-top:1px solid var(--border);padding-top:8px;">Saved ' + tsStr + '</div>';
    }

    html += '</div>'; // entry card
  }

  html += '</div>';
  container.innerHTML = html;
}

/* â”€â”€ PHOTO UPLOAD (with EXIF GPS + datetime extraction) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function handlePhotoUpload(event) {
  var files = event.target.files;
  if (!files || files.length === 0) return;
  var preview = document.getElementById('j-photo-previews');
  for (var fi = 0; fi < files.length; fi++) {
    (function(file) {
      var isVideo = file.type.startsWith('video/');
      var reader = new FileReader();
      reader.onload = function(e) {
        var dataUrl = e.target.result;
        // Build photo/video object â€” EXIF filled in async below for images
        var photoObj = { dataUrl: dataUrl, exif: null, type: isVideo ? 'video' : 'image' };
        _pendingPhotos.push(photoObj);

        // Build preview thumb
        if (preview) {
          var wrap = document.createElement('div');
          wrap.style.cssText = 'position:relative;display:inline-block;';
          var img;
          if (isVideo) {
            img = document.createElement('video');
            img.src = dataUrl;
            img.muted = true;
            img.style.cssText = 'width:60px;height:60px;object-fit:cover;border-radius:6px;border:2px solid #E8813A;cursor:pointer;display:block;';
            // Overlay play icon
            var playBadge = document.createElement('div');
            playBadge.textContent = 'â–¶';
            playBadge.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:1.2rem;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.7);pointer-events:none;';
            wrap.appendChild(playBadge);
          } else {
            img = document.createElement('img');
            img.src = dataUrl;
            img.title = 'Click to remove';
            img.style.cssText = 'width:60px;height:60px;object-fit:cover;border-radius:6px;border:2px solid var(--border);cursor:pointer;display:block;';
          }
          var exifLabel = document.createElement('div');
          exifLabel.style.cssText = 'font-size:.52rem;color:var(--text-3);text-align:center;max-width:60px;word-break:break-word;line-height:1.3;margin-top:2px;';
          wrap.onclick = function() {
            var idx2 = _pendingPhotos.indexOf(photoObj);
            if (idx2 !== -1) _pendingPhotos.splice(idx2, 1);
            wrap.remove();
          };
          wrap.appendChild(img);
          wrap.appendChild(exifLabel);
          preview.appendChild(wrap);

          // Try EXIF extraction
          if (window.exifr && file.type.match(/^image\/(jpeg|jpg|tiff)/i)) {
            exifr.parse(file, ['DateTimeOriginal','GPSLatitude','GPSLongitude','GPSLatitudeRef','GPSLongitudeRef'])
              .then(function(exif) {
                if (!exif) return;
                photoObj.exif = {};
                if (exif.latitude != null) photoObj.exif.lat = exif.latitude;
                if (exif.longitude != null) photoObj.exif.lon = exif.longitude;
                if (exif.DateTimeOriginal) {
                  var dt = exif.DateTimeOriginal;
                  photoObj.exif.dt = dt instanceof Date ? dt.toISOString() : String(dt);
                }
                // Reverse geocode if GPS available
                if (photoObj.exif.lat != null && photoObj.exif.lon != null) {
                  var geocodeUrl = 'https://nominatim.openstreetmap.org/reverse?lat=' + photoObj.exif.lat
                    + '&lon=' + photoObj.exif.lon + '&format=json&zoom=12';
                  fetch(geocodeUrl, { headers: { 'Accept-Language': 'en' } })
                    .then(function(r2) { return r2.json(); })
                    .then(function(geo) {
                      if (geo && geo.address) {
                        var city = geo.address.city || geo.address.town || geo.address.village || geo.address.county || '';
                        var state = geo.address.state || '';
                        photoObj.exif.locationName = [city, state].filter(Boolean).join(', ');
                        exifLabel.textContent = photoObj.exif.locationName || '';
                      }
                    }).catch(function() {});
                }
                // Show datetime if available
                if (photoObj.exif.dt && !photoObj.exif.locationName) {
                  try {
                    var d2 = new Date(photoObj.exif.dt);
                    exifLabel.textContent = d2.toLocaleDateString('en-US', { month:'short', day:'numeric' });
                  } catch(e2) {}
                }
              }).catch(function() {});
          }
        }
      };
      reader.readAsDataURL(file);
    })(files[fi]);
  }
  event.target.value = '';
}

/* â”€â”€ PHOTO MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openPhotoModal(idx) {
  var entry = _photoLookup[idx];
  var src   = entry && entry.dataUrl ? entry.dataUrl : entry;
  var cap   = (entry && entry.caption) ? entry.caption : '';
  var modal = document.getElementById('photo-modal');
  var img   = document.getElementById('photo-modal-img');
  var capEl = document.getElementById('photo-modal-caption');
  if (modal && img && src) {
    img.src = src;
    if (capEl) capEl.textContent = cap;
    modal.style.display = 'flex';
  }
}
function closePhotoModal() {
  var modal = document.getElementById('photo-modal');
  if (modal) modal.style.display = 'none';
  var cap = document.getElementById('photo-modal-caption');
  if (cap) cap.textContent = '';
  var img = document.getElementById('photo-modal-img');
  if (img) img.src = '';
}

/* â”€â”€ AUDIO RECORDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleRecording() {
  if (_mediaRecorder && _mediaRecorder.state === 'recording') {
    stopRecording();
  } else {
    startRecording();
  }
}

function startRecording() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showToast('Audio recording not supported on this device', 3000);
    return;
  }
  navigator.mediaDevices.getUserMedia({ audio: true }).then(function(stream) {
    _audioChunks  = [];
    _pendingAudio = null;
    var opts = {};
    if (typeof MediaRecorder !== 'undefined') {
      if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
        opts.mimeType = 'audio/webm;codecs=opus';
      } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
        opts.mimeType = 'audio/mp4';
      }
    }
    _mediaRecorder = new MediaRecorder(stream, opts);
    _mediaRecorder.ondataavailable = function(e) {
      if (e.data && e.data.size > 0) _audioChunks.push(e.data);
    };
    _mediaRecorder.onstop = function() {
      var blob   = new Blob(_audioChunks, { type: _mediaRecorder.mimeType || 'audio/webm' });
      var reader = new FileReader();
      reader.onload = function(e) {
        _pendingAudio = e.target.result;
        var prev = document.getElementById('j-audio-preview');
        if (prev) {
          prev.innerHTML = '<audio controls style="width:100%;height:32px;margin-top:2px;" src="' + _pendingAudio + '"></audio>'
            + '<div style="font-size:.7rem;color:var(--green);margin-top:3px;">&#10003; Voice memo ready</div>';
        }
      };
      reader.readAsDataURL(blob);
      stream.getTracks().forEach(function(t) { t.stop(); });
    };
    _mediaRecorder.start(250);

    // Update button to "Stop"
    var btn = document.getElementById('j-rec-btn');
    if (btn) {
      btn.innerHTML = '<i class="fa-solid fa-stop"></i> Stop';
      btn.style.background = 'var(--red)';
      btn.style.color = '#fff';
      btn.style.borderColor = 'var(--red)';
    }

    // Start timer
    _recSeconds = 0;
    var timerEl = document.getElementById('j-rec-timer');
    if (timerEl) timerEl.style.display = 'inline';
    _recTimerInt = setInterval(function() {
      _recSeconds++;
      var m = Math.floor(_recSeconds / 60);
      var s = _recSeconds % 60;
      if (timerEl) timerEl.textContent = m + ':' + (s < 10 ? '0' : '') + s;
      if (_recSeconds >= 300) stopRecording(); // auto-stop at 5 min
    }, 1000);

  }).catch(function() {
    showToast('Microphone access denied \u2014 check browser permissions', 3500);
  });
}

function stopRecording() {
  if (_mediaRecorder && _mediaRecorder.state !== 'inactive') {
    _mediaRecorder.stop();
  }
  clearInterval(_recTimerInt);
  var btn = document.getElementById('j-rec-btn');
  if (btn) {
    btn.innerHTML = '<i class="fa-solid fa-circle"></i> Record';
    btn.style.background = 'var(--red-l)';
    btn.style.color      = 'var(--red)';
    btn.style.borderColor = '#e0a8a4';
  }
  var timerEl = document.getElementById('j-rec-timer');
  if (timerEl) timerEl.style.display = 'none';
}

/* â”€â”€ JOURNAL SUBMIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function aiCleanupJournal() {
  var textEl = document.getElementById('j-text');
  var btn = document.getElementById('j-cleanup-btn');
  if (!textEl) return;
  var raw = textEl.value.trim();
  if (!raw) { showToast('Write something first, then clean it up!', 2000); return; }
  if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Cleaning up\u2026'; }
  var authorEl = document.getElementById('j-author');
  var author = authorEl ? authorEl.value : 'family member';
  var dayEl = document.getElementById('j-day');
  var dayNum = dayEl ? parseInt(dayEl.value) : 1;
  var d = TRIP_DAYS[dayNum - 1];
  var context = d ? 'Day ' + dayNum + ' of the trip (' + d.phase + ')' : 'a day on the trip';
  var prompt = 'You are helping ' + author + ' write a family travel journal entry for an RV trip. '
    + 'Here are their rough notes from ' + context + ':\n\n'
    + raw + '\n\n'
    + 'Please clean up and reorganize these notes into a warm, personal, vivid journal entry. '
    + 'Keep the author\'s voice and all specific details. Fix grammar and spelling. '
    + 'Organize into a clear narrative (2-4 paragraphs). Don\'t add things that aren\'t in the notes. '
    + 'Return ONLY the cleaned-up journal text â€” no introduction, no explanation, just the entry itself.';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:600, temperature:0.65} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r){ return r.json(); })
  .then(function(data) {
    var cleaned = '';
    try { cleaned = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    if (cleaned) { textEl.value = cleaned.trim(); showToast('\u2728 Journal cleaned up!', 2000); }
    else { showToast('Could not clean up â€” check your connection', 2500); }
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> AI Clean Up'; }
  })
  .catch(function() {
    showToast('Error contacting AI', 2000);
    if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> AI Clean Up'; }
  });
}
function submitJournalEntry() {
  var sel  = document.getElementById('j-day');
  var text = document.getElementById('j-text');
  if (!sel || !text) return;

  var dayNum   = parseInt(sel.value);
  var noteText = text.value.trim();

  if (!noteText && _pendingPhotos.length === 0 && !_pendingAudio) {
    showToast('Add a note, photo, or voice memo first', 2500);
    return;
  }

  var authorEl = document.getElementById('j-author');
  var author = authorEl ? authorEl.value : 'Paul';
  var d = getDay(dayNum);
  var locSel = document.getElementById('j-location-select');
  var locationText = '';
  if (locSel && locSel.selectedIndex >= 0) {
    locationText = locSel.options[locSel.selectedIndex].textContent;
  } else {
    var ds = getStop(d ? d.stopId : 1);
    locationText = ds ? (ds.emoji + ' ' + ds.name + ', ' + ds.state) : '';
  }
  var entry = {
    id:       Date.now(),
    day:      dayNum,
    author:   author,
    date:     d ? d.date : '',
    stopId:   d ? d.stopId : 1,
    location: locationText,
    text:     noteText,
    photos:   _pendingPhotos.slice(),
    audio:    _pendingAudio,
    created:  new Date().toISOString()
  };

  _journalEntries.push(entry);
  saveJournal();

  // Reset compose form
  text.value    = '';
  _pendingPhotos = [];
  _pendingAudio  = null;
  var pp = document.getElementById('j-photo-previews');
  if (pp) pp.innerHTML = '';
  var ap = document.getElementById('j-audio-preview');
  if (ap) ap.innerHTML = '';

  showToast('\uD83D\uDCD4 Journal entry saved!', 2200);
  renderJournal();
}

/* â”€â”€ JOURNAL DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function deleteJournalEntry(id) {
  _journalEntries = _journalEntries.filter(function(e) { return e.id !== id; });
  saveJournal();
  renderJournal();
  showToast('Entry deleted', 1800);
}

/* â”€â”€ PHOTO GALLERY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _galleryFilter = 'all';

function openPlateGallery() {
  var modal = document.getElementById('plate-gallery-modal');
  if (!modal) return;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  _loadPlateImages();
}

function closePlateGallery() {
  var modal = document.getElementById('plate-gallery-modal');
  if (modal) { modal.classList.add('hidden'); document.body.style.overflow = ''; }
}

function _loadPlateImages() {
  var grid = document.getElementById('plate-gallery-grid');
  if (!grid) return;
  if (grid.dataset.loaded === '1') return;
  grid.dataset.loaded = '1';
  grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px 20px;color:var(--text-3);"><div style="font-size:1.5rem;margin-bottom:8px;">ğŸ”„</div><div style="font-size:.82rem;">Loading plate images from Wikipediaâ€¦</div></div>';
  var _plateResults = {};
  var _pending = US_STATES_LP.length;
  function _checkDone() {
    _pending--;
    if (_pending === 0) _renderPlateGallery(_plateResults);
  }
  US_STATES_LP.forEach(function(s) {
    var urlName = encodeURIComponent(s.name.replace(/ /g,'_'));
    fetch('https://en.wikipedia.org/api/rest_v1/page/summary/Vehicle_registration_plates_of_' + urlName)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data && data.thumbnail && data.thumbnail.source) {
          _plateResults[s.abbr] = data.thumbnail.source;
        } else { _plateResults[s.abbr] = null; }
        _checkDone();
      })
      .catch(function() { _plateResults[s.abbr] = null; _checkDone(); });
  });
}

function _renderPlateGallery(results) {
  var grid = document.getElementById('plate-gallery-grid');
  if (!grid) return;
  var found = (appState.games && appState.games.license && appState.games.license.found) || [];
  var html = '';
  US_STATES_LP.forEach(function(s) {
    var imgUrl = results[s.abbr];
    var isFound = found.indexOf(s.abbr) >= 0;
    html += '<div style="display:flex;flex-direction:column;align-items:center;gap:3px;">'
      + '<div style="position:relative;width:100%;background:#f0f0f0;border-radius:6px;overflow:hidden;border:2px solid ' + (isFound ? '#2e7d32' : 'var(--border)') + ';aspect-ratio:2/1;">';
    if (imgUrl) {
      html += '<img src="' + imgUrl + '" style="width:100%;height:100%;object-fit:contain;" loading="lazy" />';
    } else {
      html += '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:.62rem;color:var(--text-3);text-align:center;padding:4px;">' + s.name + '</div>';
    }
    if (isFound) html += '<div style="position:absolute;top:2px;right:3px;background:#2e7d32;color:#fff;font-size:.58rem;font-weight:800;padding:1px 5px;border-radius:12px;">âœ“ Got it!</div>';
    html += '</div>'
      + '<div style="font-size:.64rem;font-weight:800;color:var(--text-2);text-align:center;">' + s.abbr + '</div>'
      + '</div>';
  });
  grid.innerHTML = html;
}

function renderGalleryTab() {
  var el = document.getElementById('gallery-tab-content');
  if (!el) return;
  loadJournal();

  // Collect all photos and videos from journal entries
  var allPhotos = [];
  _journalEntries.forEach(function(entry) {
    (entry.photos || []).forEach(function(p) {
      var src = (p && p.dataUrl) ? p.dataUrl : p;
      allPhotos.push({
        src: src,
        type: (p && p.type) ? p.type : (src && src.startsWith('data:video') ? 'video' : 'image'),
        caption: (p && p.caption) || '',
        location: entry.location || entry.stopName || '',
        date: entry.date || '',
        day: entry.day,
        entryId: entry.id
      });
    });
  });

  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-images"></i> Photo Gallery</h2>'
    + '<span style="font-size:.8rem;color:var(--text-3);">' + allPhotos.length + ' photo' + (allPhotos.length !== 1 ? 's' : '') + '</span>'
    + '</div>';

  if (allPhotos.length === 0) {
    html += '<div style="text-align:center;padding:60px 20px;color:var(--text-3);">'
      + '<div style="font-size:3rem;margin-bottom:12px;">ğŸ“·</div>'
      + '<div style="font-weight:700;font-size:.95rem;margin-bottom:6px;">No photos yet</div>'
      + '<div style="font-size:.83rem;">Add photos to your journal entries and they\'ll appear here.</div>'
      + '<button onclick="switchTab(\'journal\')" style="margin-top:16px;padding:10px 20px;background:var(--orange);color:#fff;border:none;border-radius:20px;font-weight:700;cursor:pointer;font-family:var(--font);">Go to Journal</button>'
      + '</div>';
    el.innerHTML = html;
    return;
  }

  html += '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;">';
  allPhotos.forEach(function(p) {
    var isVid = p.type === 'video' || (p.src && p.src.startsWith('data:video'));
    html += '<div style="cursor:zoom-in;position:relative;aspect-ratio:1;overflow:hidden;border-radius:6px;" data-media-src="' + (p.src||'') + '" data-media-type="' + (isVid?'video':'image') + '" data-media-cap="' + ((p.caption||p.location||'').replace(/"/g,'&quot;')) + '">'
      + (isVid
        ? '<video src="' + p.src + '" style="width:100%;height:100%;object-fit:cover;" muted preload="metadata"></video>'
          + '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);"><span style="font-size:1.8rem;filter:drop-shadow(0 1px 3px rgba(0,0,0,.6));">â–¶ï¸</span></div>'
        : '<img src="' + p.src + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy" />')
      + (p.caption || p.location ? '<div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.65));padding:4px 6px 4px;font-size:.56rem;color:#fff;line-height:1.3;">' + (p.caption || p.location) + '</div>' : '')
      + '</div>';
  });
  html += '</div>';
  el.innerHTML = html;
  // Attach click handlers after DOM insert
  el.querySelectorAll('[data-media-src]').forEach(function(tile) {
    tile.addEventListener('click', function() {
      _openMediaLightbox(tile.dataset.mediaSrc, tile.dataset.mediaType, tile.dataset.mediaCap);
    });
  });
}

function openPhotoGallery() {
  loadJournal();
  _galleryFilter = 'all';
  var modal = document.getElementById('photo-gallery-modal');
  if (modal) { modal.classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
  _renderGallery();
}

function closePhotoGallery() {
  var modal = document.getElementById('photo-gallery-modal');
  if (modal) { modal.classList.add('hidden'); document.body.style.overflow = ''; }
}

function _renderGallery() {
  // Build filter chips: All + each stop that has photos
  var stopPhotos = {}; // stopId -> count
  _journalEntries.forEach(function(e) {
    if (e.photos && e.photos.length) {
      var sid = e.stopId || 1;
      stopPhotos[sid] = (stopPhotos[sid] || 0) + e.photos.length;
    }
  });

  var filterRow = document.getElementById('gallery-filter-row');
  if (filterRow) {
    var filterHtml = '<button onclick="_setGalleryFilter(\'all\')" id="gf-all" style="background:' + (_galleryFilter === 'all' ? 'var(--orange)' : 'var(--bg)') + ';color:' + (_galleryFilter === 'all' ? '#fff' : 'var(--text-2)') + ';border:1px solid var(--border);border-radius:100px;padding:5px 14px;font-size:.78rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:var(--font);">All Photos</button>';
    Object.keys(stopPhotos).forEach(function(sid) {
      var stop = getStop(parseInt(sid));
      var label = stop ? (stop.emoji + ' ' + stop.name) : 'Stop ' + sid;
      var active = _galleryFilter === sid;
      filterHtml += '<button onclick="_setGalleryFilter(\'' + sid + '\')" style="background:' + (active ? 'var(--orange)' : 'var(--bg)') + ';color:' + (active ? '#fff' : 'var(--text-2)') + ';border:1px solid var(--border);border-radius:100px;padding:5px 14px;font-size:.78rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:var(--font);">' + label + ' (' + stopPhotos[sid] + ')</button>';
    });
    filterRow.innerHTML = filterHtml;
  }

  // Build grid
  var grid = document.getElementById('gallery-grid');
  if (!grid) return;
  var allPhotos = []; // { src, caption, entryId, date, location }
  var sorted = _journalEntries.slice().sort(function(a, b) { return a.day - b.day; });
  sorted.forEach(function(e) {
    if (!e.photos || !e.photos.length) return;
    if (_galleryFilter !== 'all' && String(e.stopId) !== String(_galleryFilter)) return;
    var stop = getStop(e.stopId);
    var locLabel = e.location || (stop ? _sn(stop) : '');
    e.photos.forEach(function(photo) {
      var src  = (photo && photo.dataUrl) ? photo.dataUrl : photo;
      var exif = (photo && photo.exif)    ? photo.exif    : null;
      var typ  = (photo && photo.type)    ? photo.type    : (src && src.startsWith('data:video') ? 'video' : 'image');
      allPhotos.push({ src: src, type: typ, caption: _buildPhotoCaption(exif), location: locLabel, date: e.date, day: e.day });
    });
  });

  if (allPhotos.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:48px 20px;color:var(--text-3);">'
      + '<div style="font-size:2.5rem;margin-bottom:12px;">ğŸ“·</div>'
      + '<div style="font-weight:700;">No photos yet</div>'
      + '<div style="font-size:.82rem;margin-top:6px;">Add photos to your journal entries to see them here.</div>'
      + '</div>';
    return;
  }

  var html = '';
  allPhotos.forEach(function(p) {
    var isVid = p.type === 'video' || (p.src && p.src.startsWith('data:video'));
    var cap = p.caption || [p.location, p.date ? formatDate(p.date) : ''].filter(Boolean).join(' Â· ');
    html += '<div style="cursor:zoom-in;position:relative;aspect-ratio:1;overflow:hidden;border-radius:4px;" data-media-src="' + (p.src||'') + '" data-media-type="' + (isVid?'video':'image') + '" data-media-cap="' + (cap.replace(/"/g,'&quot;')) + '">'
      + (isVid
        ? '<video src="' + p.src + '" style="width:100%;height:100%;object-fit:cover;" muted preload="metadata"></video>'
          + '<div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.25);"><span style="font-size:1.8rem;filter:drop-shadow(0 1px 3px rgba(0,0,0,.6));">â–¶ï¸</span></div>'
        : '<img src="' + p.src + '" style="width:100%;height:100%;object-fit:cover;" loading="lazy" />')
      + (cap ? '<div style="position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.6));padding:4px 5px 3px;font-size:.56rem;color:#fff;line-height:1.3;">' + cap + '</div>' : '')
      + '</div>';
  });
  grid.innerHTML = html;
  grid.querySelectorAll('[data-media-src]').forEach(function(tile) {
    tile.addEventListener('click', function() {
      _openMediaLightbox(tile.dataset.mediaSrc, tile.dataset.mediaType, tile.dataset.mediaCap);
    });
  });
}

function _setGalleryFilter(filter) {
  _galleryFilter = filter;
  _renderGallery();
}

function openGalleryPhoto(idx) {
  var photos = window._galleryLookup || [];
  var p = photos[idx];
  if (!p) return;
  _openMediaLightbox(p.dataUrl, 'image', p.caption || '');
}

function _openMediaLightbox(src, type, caption) {
  // Remove existing lightbox
  var old = document.getElementById('_media-lightbox');
  if (old) old.remove();

  var overlay = document.createElement('div');
  overlay.id = '_media-lightbox';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';

  var mediaEl;
  if (type === 'video') {
    mediaEl = document.createElement('video');
    mediaEl.src = src;
    mediaEl.controls = true;
    mediaEl.autoplay = true;
    mediaEl.style.cssText = 'max-width:100%;max-height:80vh;border-radius:10px;box-shadow:0 8px 40px rgba(0,0,0,.6);';
  } else {
    mediaEl = document.createElement('img');
    mediaEl.src = src;
    mediaEl.style.cssText = 'max-width:100%;max-height:80vh;object-fit:contain;border-radius:10px;box-shadow:0 8px 40px rgba(0,0,0,.6);';
  }

  var closeBtn = document.createElement('button');
  closeBtn.textContent = 'âœ•';
  closeBtn.style.cssText = 'position:absolute;top:16px;right:20px;background:rgba(255,255,255,.15);border:none;color:#fff;font-size:1.4rem;width:40px;height:40px;border-radius:50%;cursor:pointer;line-height:1;';
  closeBtn.onclick = function() { overlay.remove(); };

  var capEl = document.createElement('div');
  capEl.textContent = caption || '';
  capEl.style.cssText = 'color:rgba(255,255,255,.75);font-size:.8rem;margin-top:12px;text-align:center;max-width:600px;';

  overlay.appendChild(closeBtn);
  overlay.appendChild(mediaEl);
  overlay.appendChild(capEl);
  overlay.addEventListener('click', function(e) { if (e.target === overlay) overlay.remove(); });
  document.body.appendChild(overlay);
}

/* â”€â”€ SWITCH TAB HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _mainSeg(which) {
  var schDiv = document.getElementById('schedule-content');
  var stpDiv = document.getElementById('stops-content');
  var btnSch = document.getElementById('plan-seg-schedule');
  var btnStp = document.getElementById('plan-seg-stops');
  if (!schDiv || !stpDiv) return;
  if (which === 'schedule') {
    schDiv.style.display = 'block'; stpDiv.style.display = 'none';
    if (btnSch) { btnSch.style.background='var(--orange)'; btnSch.style.borderColor='var(--orange)'; btnSch.style.color='#fff'; }
    if (btnStp) { btnStp.style.background='var(--card)';   btnStp.style.borderColor='var(--border)'; btnStp.style.color='var(--text-2)'; }
  } else {
    schDiv.style.display = 'none'; stpDiv.style.display = 'block';
    if (btnSch) { btnSch.style.background='var(--card)';   btnSch.style.borderColor='var(--border)'; btnSch.style.color='var(--text-2)'; }
    if (btnStp) { btnStp.style.background='var(--orange)'; btnStp.style.borderColor='var(--orange)'; btnStp.style.color='#fff'; }
    renderStops();
  }
}

function switchTab(tabId) {
  document.querySelectorAll('.nav-tab').forEach(function(b) { b.classList.remove('active'); });
  document.querySelectorAll('.tab-panel').forEach(function(p) { p.classList.remove('active'); });
  var navBtn = document.querySelector('[data-tab="' + tabId + '"]');
  var panel  = document.getElementById('tab-' + tabId);
  if (navBtn) navBtn.classList.add('active');
  if (panel)  { panel.classList.remove('hidden'); panel.classList.add('active'); }
}

/* â”€â”€ FRIEND MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function applyFriendMode() {
  // Hide family-only tabs, show only map + stops + suggestions
  var allTabs = document.querySelectorAll('.nav-tab');
  var allPanels = document.querySelectorAll('.tab-panel');
  var friendTabs = ['map', 'planner', 'suggestions'];

  for (var ti = 0; ti < allTabs.length; ti++) {
    var tab = allTabs[ti];
    var tabId = tab.getAttribute('data-tab');
    if (friendTabs.indexOf(tabId) === -1) {
      tab.style.display = 'none';
    } else {
      tab.classList.remove('hidden'); // ensure suggestions tab button is visible
    }
  }
  for (var pi = 0; pi < allPanels.length; pi++) {
    var panel = allPanels[pi];
    if (panel.id === 'tab-suggestions') {
      panel.classList.remove('hidden');
    }
  }

  // Update header to show friend mode
  var hdr = document.querySelector('.app-header');
  if (hdr) {
    var badge = document.createElement('div');
    badge.style.cssText = 'background:#7B5EA7;color:#fff;font-size:.7rem;font-weight:800;padding:3px 10px;border-radius:100px;margin-left:8px;';
    badge.textContent = 'Friends View';
    var title = hdr.querySelector('h1, .header-title');
    if (title) title.appendChild(badge);
  }

  // Switch to suggestions tab first
  setTimeout(function() { switchTab('suggestions'); }, 100);
}

/* â”€â”€ SUGGESTIONS DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadSuggestions() {
  try {
    var raw = localStorage.getItem('rv_suggestions');
    return raw ? JSON.parse(raw) : [];
  } catch(e) { return []; }
}
function saveSuggestions(arr) {
  try { localStorage.setItem('rv_suggestions', JSON.stringify(arr)); } catch(e) {}
}

/* â”€â”€ RENDER SUGGESTIONS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderSuggestions() {
  var el = document.getElementById('suggestions-content');
  if (!el) return;

  var suggestions = loadSuggestions();
  var isFamily = !_isFriend;
  var html = '';

  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-lightbulb"></i> '
    + (_isFriend ? 'Suggest a Stop!' : 'Friend Suggestions')
    + '</h2></div>';

  if (_isFriend) {
    // Friends see: submit form + list of their own suggestions
    html += '<div style="background:var(--card);border:2px solid var(--purple);border-radius:var(--radius);padding:20px;margin-bottom:24px;box-shadow:var(--shadow);">';
    html += '<div style="font-size:.875rem;color:var(--text-2);margin-bottom:16px;line-height:1.5;">'
      + 'Got a great idea for the Maass family trip? Suggest a stop, restaurant, or activity! The family will see your suggestions.</div>';
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">';
    html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Your Name</label>'
      + '<input id="sug-name" type="text" placeholder="e.g. Uncle Bob" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.82rem;" /></div>';
    html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Type</label>'
      + '<select id="sug-type" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.82rem;">'
      + '<option value="stop">New Stop / Detour</option>'
      + '<option value="restaurant">Restaurant Pick</option>'
      + '<option value="activity">Activity / Attraction</option>'
      + '<option value="tip">General Tip</option>'
      + '</select></div>';
    html += '</div>';
    /* Near which stop dropdown */
    html += '<div style="margin-bottom:12px;"><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Near which stop on the trip?</label>'
      + '<select id="sug-stop" style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.82rem;">'
      + '<option value="">â€” Any / Not sure â€”</option>';
    TRIP_STOPS.forEach(function(st) {
      if (st.id < 15) html += '<option value="' + st.id + '">' + st.emoji + ' ' + st.name + ', ' + st.state + '</option>';
    });
    html += '</select></div>';
    html += '<div style="margin-bottom:14px;"><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:5px;text-transform:uppercase;letter-spacing:.04em;">Place or Suggestion Name</label>'
      + '<input id="sug-title" type="text" placeholder="e.g. Slide Rock State Park, Annie\'s BBQ..." style="width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.875rem;margin-bottom:8px;" />'
      + '<textarea id="sug-details" placeholder="Why do you recommend it? Include a Google Maps link if you have one!" style="width:100%;min-height:80px;padding:10px 12px;border:1px solid var(--border);border-radius:var(--radius-s);background:var(--bg);font-family:var(--font);font-size:.875rem;resize:vertical;line-height:1.5;"></textarea></div>';
    html += '<button onclick="submitSuggestion()" style="width:100%;padding:12px;background:var(--purple);color:#fff;border:none;border-radius:var(--radius-s);font-family:var(--font);font-size:.9rem;font-weight:800;cursor:pointer;"><i class="fa-solid fa-paper-plane"></i> Send to the Maass Family</button>';
    html += '</div>';
  } else {
    // Family sees: manage & delete suggestions
    html += '<div style="background:var(--purple-l);border:1px solid #d4bbf5;border-radius:var(--radius-s);padding:12px 16px;margin-bottom:18px;font-size:.82rem;color:var(--purple);">'
      + '<strong>Friends mode password:</strong> <code style="background:#fff;padding:2px 8px;border-radius:4px;font-size:.85rem;">maassfriends</code> '
      + '&mdash; Share this with friends and family to let them suggest stops without seeing your private schedule.</div>';
  }

  if (suggestions.length === 0) {
    html += '<div style="text-align:center;padding:40px 20px;color:var(--text-3);">'
      + '<div style="font-size:2.5rem;margin-bottom:12px;">&#128161;</div>'
      + '<div style="font-weight:700;font-size:.95rem;margin-bottom:6px;">' + (_isFriend ? 'Be the first to suggest something!' : 'No suggestions yet') + '</div>'
      + '<div style="font-size:.82rem;">' + (_isFriend ? 'Fill in the form above.' : 'Share the friends password to collect suggestions.') + '</div>'
      + '</div>';
  } else {
    var typeColors = { stop: 'var(--blue)', restaurant: 'var(--orange)', activity: 'var(--green)', tip: 'var(--purple)' };
    var typeIcons  = { stop: '&#128205;', restaurant: '&#127869;', activity: '&#127939;', tip: '&#128161;' };
    html += '<div style="display:flex;flex-direction:column;gap:12px;">';
    for (var si3 = 0; si3 < suggestions.length; si3++) {
      var s = suggestions[si3];
      var tc = typeColors[s.type] || 'var(--text-2)';
      var ti2 = typeIcons[s.type]  || '&#128161;';
      var ts2 = new Date(s.created).toLocaleDateString('en-US', { month:'short', day:'numeric' });
      html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-s);padding:14px 16px;">';
      html += '<div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;">';
      html += '<div style="display:flex;align-items:center;gap:8px;">';
      html += '<span style="font-size:1.1rem;">' + ti2 + '</span>';
      html += '<div><div style="font-weight:700;font-size:.9rem;">' + s.title + '</div>'
        + '<div style="font-size:.75rem;color:var(--text-3);">from ' + s.name + ' &middot; ' + ts2 + ' &middot; <span style="color:' + tc + ';font-weight:700;">' + s.type + '</span>'
        + (s.stopLabel ? ' &middot; <span style="color:var(--blue);font-weight:600;">' + s.stopLabel + '</span>' : '')
        + '</div></div>';
      html += '</div>';
      if (isFamily) {
        html += '<button onclick="deleteSuggestion(' + s.id + ')" style="background:none;border:none;cursor:pointer;color:var(--text-3);font-size:.95rem;padding:4px 6px;"><i class="fa-solid fa-trash-can"></i></button>';
      }
      html += '</div>';
      if (s.details) {
        var safeD = s.details.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        html += '<div style="font-size:.82rem;color:var(--text-2);line-height:1.5;">' + safeD + '</div>';
      }
      html += '</div>';
    }
    html += '</div>';
  }

  el.innerHTML = html;
}

function submitSuggestion() {
  var name    = (document.getElementById('sug-name')    || {}).value || '';
  var type    = (document.getElementById('sug-type')    || {}).value || 'tip';
  var title   = (document.getElementById('sug-title')   || {}).value || '';
  var details = (document.getElementById('sug-details') || {}).value || '';
  var stopId  = (document.getElementById('sug-stop')    || {}).value || '';
  if (!name.trim() || !title.trim()) {
    showToast('Please add your name and a suggestion title', 2500);
    return;
  }
  var stopLabel = '';
  if (stopId) {
    var foundStop = TRIP_STOPS.find(function(st){ return String(st.id) === String(stopId); });
    if (foundStop) stopLabel = foundStop.emoji + ' ' + foundStop.name + ', ' + foundStop.state;
  }
  var suggestions = loadSuggestions();
  suggestions.push({ id: Date.now(), name: name.trim(), type: type, title: title.trim(), details: details.trim(), stopLabel: stopLabel, created: new Date().toISOString() });
  saveSuggestions(suggestions);
  showToast('&#128161; Suggestion sent to the Maass family! Thanks!', 3000);
  renderSuggestions();
}

function deleteSuggestion(id) {
  var suggestions = loadSuggestions().filter(function(s) { return s.id !== id; });
  saveSuggestions(suggestions);
  renderSuggestions();
  showToast('Suggestion removed', 1500);
}

/* â”€â”€ APP INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LISTS TAB â€” To-Do & Packing Checklist
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var DEFAULT_TODO = [
  { id:'t1',  cat:'Before We Leave', text:'Schedule RV inspection & oil change' },
  { id:'t2',  cat:'Before We Leave', text:'Check tire pressure (all 6)' },
  { id:'t3',  cat:'Before We Leave', text:'Renew car insurance / roadside assistance' },
  { id:'t4',  cat:'Before We Leave', text:'Make campground reservations (confirm all)' },
  { id:'t5',  cat:'Before We Leave', text:'Download offline maps for all stops' },
  { id:'t6',  cat:'Before We Leave', text:'Refill prescription medications' },
  { id:'t7',  cat:'Before We Leave', text:'Notify bank/cards of travel dates' },
  { id:'t8',  cat:'Before We Leave', text:'Set mail hold at post office' },
  { id:'t9',  cat:'Before We Leave', text:'Arrange pet care / house sitter' },
  { id:'t10', cat:'Before We Leave', text:'Charge all devices & power banks' },
  { id:'t11', cat:'Before We Leave', text:'Stock RV pantry with snack staples' },
  { id:'t12', cat:'Before We Leave', text:'Pack kids\' school workbooks & supplies' },
  { id:'t13', cat:'Before We Leave', text:'Test all RV systems (water, electric, propane)' },
  { id:'t14', cat:'Before We Leave', text:'Empty & clean black/gray tanks' },
  { id:'t15', cat:'Before We Leave', text:'Fill fresh water tank' },
  { id:'t16', cat:'On The Road', text:'Check tire pressure every 3â€“4 days' },
  { id:'t17', cat:'On The Road', text:'Empty tanks at each campsite' },
  { id:'t18', cat:'On The Road', text:'Journal entry each day' },
  { id:'t19', cat:'On The Road', text:'School lessons on drive days' },
  { id:'t20', cat:'On The Road', text:'Take a family photo at each stop' },
  { id:'t21', cat:'Coming Home',  text:'Take final family photo at last stop' },
  { id:'t22', cat:'Coming Home',  text:'Deep clean RV' },
  { id:'t23', cat:'Coming Home',  text:'Return borrowed / rented gear' }
];
var DEFAULT_PACKING = [
  { id:'p1',  cat:'Documents', text:'Driver\'s license & RV registration' },
  { id:'p2',  cat:'Documents', text:'Insurance cards (health, RV, auto)' },
  { id:'p3',  cat:'Documents', text:'Campground reservation confirmations' },
  { id:'p4',  cat:'Documents', text:'Emergency contact list (printed)' },
  { id:'p5',  cat:'Tech & Power', text:'iPads, charging cables, cases' },
  { id:'p6',  cat:'Tech & Power', text:'Phone chargers + car charger' },
  { id:'p7',  cat:'Tech & Power', text:'Portable battery packs (2)' },
  { id:'p8',  cat:'Tech & Power', text:'Laptop + hotspot / cellular plan' },
  { id:'p9',  cat:'Tech & Power', text:'Camera + memory cards' },
  { id:'p10', cat:'RV Essentials', text:'Water hose (potable, 25 ft)' },
  { id:'p11', cat:'RV Essentials', text:'Sewer hose kit' },
  { id:'p12', cat:'RV Essentials', text:'Leveling blocks' },
  { id:'p13', cat:'RV Essentials', text:'Power cord (30 or 50 amp)' },
  { id:'p14', cat:'RV Essentials', text:'Wheel chocks' },
  { id:'p15', cat:'RV Essentials', text:'Basic tools (screwdrivers, wrench, zip ties)' },
  { id:'p16', cat:'RV Essentials', text:'Duct tape & WD-40' },
  { id:'p17', cat:'Kitchen', text:'Plates, bowls, cups (camping set)' },
  { id:'p18', cat:'Kitchen', text:'Pots, pans, spatula, tongs' },
  { id:'p19', cat:'Kitchen', text:'Coffee maker' },
  { id:'p20', cat:'Kitchen', text:'Paper towels, dish soap, sponges' },
  { id:'p21', cat:'Kitchen', text:'Snack bin (granola bars, nuts, crackers, fruit pouches)' },
  { id:'p22', cat:'Kitchen', text:'Spice kit (salt, pepper, olive oil, garlic, cumin)' },
  { id:'p23', cat:'Clothing', text:'Leila: 7 days clothes + 2 warm layers' },
  { id:'p24', cat:'Clothing', text:'Luna: 7 days clothes + 2 warm layers' },
  { id:'p25', cat:'Clothing', text:'Eli: extra onesies & pants (10+ sets)' },
  { id:'p26', cat:'Clothing', text:'Rain jackets for everyone' },
  { id:'p27', cat:'Clothing', text:'Hiking shoes / trail runners' },
  { id:'p28', cat:'Clothing', text:'Water shoes (all kids)' },
  { id:'p29', cat:'Clothing', text:'Pajamas, underwear, socks' },
  { id:'p30', cat:'Kids & Fun', text:'Leila\'s chapter books (3â€“4)' },
  { id:'p31', cat:'Kids & Fun', text:'Luna\'s coloring books & markers' },
  { id:'p32', cat:'Kids & Fun', text:'Eli\'s comfort items & favorite toys' },
  { id:'p33', cat:'Kids & Fun', text:'Card games (Uno, Go Fish, etc.)' },
  { id:'p34', cat:'Kids & Fun', text:'Travel journal / sticker books' },
  { id:'p35', cat:'Kids & Fun', text:'Portable white noise machine (Eli)' },
  { id:'p36', cat:'Health & Safety', text:'First aid kit (bandages, antiseptic, gauze)' },
  { id:'p37', cat:'Health & Safety', text:'Ibuprofen, Tylenol (adult & kids)' },
  { id:'p38', cat:'Health & Safety', text:'Allergy medication (Zyrtec, Benadryl)' },
  { id:'p39', cat:'Health & Safety', text:'Sunscreen SPF 50+ (4 bottles)' },
  { id:'p40', cat:'Health & Safety', text:'Bug spray (DEET-free for kids)' },
  { id:'p41', cat:'Health & Safety', text:'Motion sickness meds (Dramamine kids)' },
  { id:'p42', cat:'Health & Safety', text:'Prescriptions (90-day supply)' },
  { id:'p43', cat:'Outdoor Gear', text:'Camping chairs (5)' },
  { id:'p44', cat:'Outdoor Gear', text:'Folding table' },
  { id:'p45', cat:'Outdoor Gear', text:'Headlamps + extra batteries' },
  { id:'p46', cat:'Outdoor Gear', text:'Daypacks / hiking backpacks' },
  { id:'p47', cat:'Outdoor Gear', text:'Reusable water bottles (5)' },
  { id:'p48', cat:'Outdoor Gear', text:'Swimsuits & beach towels' },
  { id:'p49', cat:'Outdoor Gear', text:'Binoculars (for wildlife & stargazing)' }
];
/* â”€â”€ SWIPE-TO-DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _sw = { el: null, startX: 0, startY: 0, moved: false, locked: false };

function swipeStart(e, el) {
  // Close any other open swipe first
  if (_sw.el && _sw.el !== el) swipeClose(_sw.el);
  _sw.el = el;
  var t = e.touches ? e.touches[0] : e;
  _sw.startX = t.clientX;
  _sw.startY = t.clientY;
  _sw.moved  = false;
  _sw.locked = el.classList.contains('swiped');
}
function swipeMove(e, el) {
  if (!_sw.el || _sw.el !== el) return;
  var t = e.touches ? e.touches[0] : e;
  var dx = t.clientX - _sw.startX;
  var dy = t.clientY - _sw.startY;
  // If more vertical than horizontal on first move, let scroll happen
  if (!_sw.moved && Math.abs(dy) > Math.abs(dx) + 6) { _sw.el = null; return; }
  _sw.moved = true;
  if (e.cancelable) e.preventDefault();
  var offset = _sw.locked ? Math.max(-72, Math.min(0, dx - 72)) : Math.max(-72, Math.min(0, dx));
  el.style.transform = 'translateX(' + offset + 'px)';
  var trash = el.parentElement && el.parentElement.querySelector('.swipe-trash');
  if (trash) { trash.classList.toggle('visible', offset < -20); }
}
function swipeEnd(e, el) {
  if (!_sw.el || _sw.el !== el) return;
  var t = e.changedTouches ? e.changedTouches[0] : e;
  var dx = t.clientX - _sw.startX;
  _sw.el = null;
  var threshold = _sw.locked ? -20 : -55;
  if (dx < threshold || (_sw.locked && dx < 0)) {
    el.classList.add('swiped');
    el.style.transform = 'translateX(-72px)';
    var trash = el.parentElement && el.parentElement.querySelector('.swipe-trash');
    if (trash) trash.classList.add('visible');
  } else {
    swipeClose(el);
  }
}
function swipeClose(el) {
  if (!el) return;
  el.classList.remove('swiped');
  el.style.transform = '';
  var trash = el.parentElement && el.parentElement.querySelector('.swipe-trash');
  if (trash) trash.classList.remove('visible');
}
function swipeDeleteItem(type, id, trashBtn) {
  var row = trashBtn.closest('.swipe-row');
  if (row) {
    row.style.transition = 'opacity .2s, max-height .3s, margin-bottom .3s';
    row.style.opacity = '0';
    row.style.maxHeight = '0';
    row.style.marginBottom = '0';
    row.style.overflow = 'hidden';
  }
  setTimeout(function() { hideOrDeleteListItem(type, id); }, 310);
}
function hideOrDeleteListItem(type, id) {
  // Custom items â†’ remove; default items â†’ mark hidden
  if (id && id.indexOf('_c_') !== -1) {
    if (!appState.customListItems) return;
    var arr = appState.customListItems[type] || [];
    appState.customListItems[type] = arr.filter(function(i) { return i.id !== id; });
  } else {
    if (!appState.listHidden) appState.listHidden = {};
    if (!appState.listHidden[type]) appState.listHidden[type] = {};
    appState.listHidden[type][id] = true;
  }
  saveState(appState); renderLists();
}

function getListState() {
  if (!appState.listChecked) appState.listChecked = { todo:{}, pack:{} };
  if (!appState.listChecked.todo) appState.listChecked.todo = {};
  if (!appState.listChecked.pack) appState.listChecked.pack = {};
  return appState.listChecked;
}
function toggleListItem(type, id) {
  getListState();
  appState.listChecked[type][id] = !appState.listChecked[type][id];
  saveState(appState);
  renderLists();
}
function addCustomListItem(type) {
  var inp = document.getElementById('list-add-' + type);
  var catSel = document.getElementById('list-cat-' + type);
  var val = (inp && inp.value.trim()) || '';
  if (!val) return;
  if (!appState.customListItems) appState.customListItems = { todo:[], pack:[] };
  if (!appState.customListItems[type]) appState.customListItems[type] = [];
  var newId = type + '_c_' + Date.now();
  var cat = catSel ? catSel.value : (type === 'todo' ? 'Custom' : 'Other');
  appState.customListItems[type].push({ id: newId, cat: cat, text: val });
  saveState(appState); renderLists();
  if (inp) inp.value = '';
}

/* â”€â”€ LIST DRAG-TO-REORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _listDrag = { active: false, type: null, id: null, startY: 0, ghost: null, srcEl: null, insertBefore: null };
function listDragStart(evt, type, id) {
  evt.stopPropagation();
  var touch = evt.touches[0];
  var srcEl = document.querySelector('[data-list-id="' + id + '"]');
  if (!srcEl) return;
  _listDrag.active = true; _listDrag.type = type; _listDrag.id = id; _listDrag.startY = touch.clientY; _listDrag.srcEl = srcEl;
  var ghost = srcEl.cloneNode(true);
  ghost.style.cssText = 'position:fixed;z-index:9999;left:' + srcEl.getBoundingClientRect().left + 'px;width:' + srcEl.offsetWidth + 'px;top:' + srcEl.getBoundingClientRect().top + 'px;opacity:.88;pointer-events:none;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.22);transform:scale(1.03);transition:none;';
  document.body.appendChild(ghost);
  _listDrag.ghost = ghost;
  srcEl.style.opacity = '0.3';
  evt.preventDefault();
}
function listDragMove(evt) {
  if (!_listDrag.active) return;
  evt.preventDefault();
  var touch = evt.touches[0];
  var dy = touch.clientY - _listDrag.startY;
  if (_listDrag.ghost) _listDrag.ghost.style.top = (_listDrag.srcEl.getBoundingClientRect().top + dy) + 'px';
  // Find which item we're hovering over
  var all = document.querySelectorAll('[data-list-id]');
  var hoverEl = null;
  for (var i = 0; i < all.length; i++) {
    var rect = all[i].getBoundingClientRect();
    if (touch.clientY > rect.top && touch.clientY < rect.bottom) { hoverEl = all[i]; break; }
  }
  document.querySelectorAll('[data-list-id]').forEach(function(el){ el.style.borderTop = ''; });
  if (hoverEl && hoverEl !== _listDrag.srcEl) {
    hoverEl.style.borderTop = '2px solid var(--orange)';
    _listDrag.insertBefore = hoverEl.getAttribute('data-list-id');
  } else { _listDrag.insertBefore = null; }
}
function listDragEnd(evt) {
  if (!_listDrag.active) return;
  _listDrag.active = false;
  if (_listDrag.ghost) { _listDrag.ghost.remove(); _listDrag.ghost = null; }
  document.querySelectorAll('[data-list-id]').forEach(function(el){ el.style.borderTop=''; el.style.opacity=''; });
  var targetId = _listDrag.insertBefore;
  if (targetId && targetId !== _listDrag.id) {
    // Reorder in appState.customListItems
    var type = _listDrag.type;
    if (!appState.customListItems) appState.customListItems = { todo:[], pack:[] };
    if (!appState.customListItems[type]) appState.customListItems[type] = [];
    // Also build a full reorder map using appState.listSortOrder
    if (!appState.listSortOrder) appState.listSortOrder = {};
    if (!appState.listSortOrder[type]) {
      // Initialize from DEFAULT items + custom items current order
      var all2 = (type === 'todo' ? DEFAULT_TODO : DEFAULT_PACKING).concat(appState.customListItems[type] || []);
      appState.listSortOrder[type] = all2.map(function(i){ return i.id; });
    }
    var order = appState.listSortOrder[type];
    var fromIdx = order.indexOf(_listDrag.id);
    var toIdx = order.indexOf(targetId);
    if (fromIdx !== -1 && toIdx !== -1) {
      order.splice(fromIdx, 1);
      order.splice(toIdx, 0, _listDrag.id);
      appState.listSortOrder[type] = order;
      saveState(appState);
    }
  }
  _listDrag.id = null; _listDrag.insertBefore = null; _listDrag.srcEl = null;
  renderLists();
}

function renderListSection(items, customItems, type, checkedMap) {
  var hidden = (appState.listHidden && appState.listHidden[type]) || {};
  var allItems = items.concat(customItems || []).filter(function(i) { return !hidden[i.id]; });
  var hiddenCount = items.filter(function(i) { return hidden[i.id]; }).length;

  // Apply sort order if user has reordered
  var order = appState.listSortOrder && appState.listSortOrder[type];
  if (order && order.length > 0) {
    allItems.sort(function(a, b) {
      var ai = order.indexOf(a.id); var bi = order.indexOf(b.id);
      if (ai === -1) ai = 9999; if (bi === -1) bi = 9999;
      return ai - bi;
    });
  }

  var cats = [];
  var catMap = {};
  for (var ci = 0; ci < allItems.length; ci++) {
    var itm = allItems[ci];
    if (!catMap[itm.cat]) { catMap[itm.cat] = []; cats.push(itm.cat); }
    catMap[itm.cat].push(itm);
  }
  var doneCount = 0;
  for (var k in checkedMap) { if (checkedMap[k] && !hidden[k]) doneCount++; }
  var totalCount = allItems.length;
  var pctDone = totalCount > 0 ? Math.round(doneCount / totalCount * 100) : 0;
  var h = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">';
  h += '<div style="font-size:.77rem;color:var(--text-2);">' + doneCount + ' of ' + totalCount + ' done</div>';
  h += '<div style="flex:1;margin:0 12px;background:var(--border);border-radius:4px;height:7px;overflow:hidden;">';
  h += '<div style="background:var(--green);height:100%;width:' + pctDone + '%;transition:width .4s;border-radius:4px;"></div></div>';
  h += '<div style="font-size:.77rem;font-weight:800;color:var(--green);">' + pctDone + '%</div>';
  h += '</div>';
  if (hiddenCount > 0) {
    h += '<div style="font-size:.75rem;color:var(--text-3);margin-bottom:6px;cursor:pointer;text-decoration:underline;" onclick="restoreHiddenItems(\'' + type + '\')">' + hiddenCount + ' hidden item' + (hiddenCount > 1 ? 's' : '') + ' \u2014 tap to restore</div>';
  }
  for (var ci2 = 0; ci2 < cats.length; ci2++) {
    var cat = cats[ci2];
    var catItems = catMap[cat];
    h += '<div style="font-size:.72rem;font-weight:800;color:var(--text-3);text-transform:uppercase;letter-spacing:.06em;margin:12px 0 6px;">' + cat + '</div>';
    for (var ii = 0; ii < catItems.length; ii++) {
      var it = catItems[ii];
      var checked = !!checkedMap[it.id];
      var itemBg  = checked ? 'var(--green-l)' : 'var(--card)';
      var itemBdr = checked ? '#a8d5b8' : 'var(--border)';
      h += '<div class="swipe-row" data-list-id="' + it.id + '">';
      h += '<div class="swipe-trash"><button onclick="swipeDeleteItem(\'' + type + '\',\'' + it.id + '\',this)" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;padding:0;line-height:1;">&#128465;</button></div>';
      h += '<label class="swipe-content" ontouchstart="swipeStart(event,this)" ontouchmove="swipeMove(event,this)" ontouchend="swipeEnd(event,this)" style="display:flex;align-items:center;gap:10px;padding:10px 13px;background:' + itemBg + ';border:1px solid ' + itemBdr + ';border-radius:100px;cursor:pointer;touch-action:pan-y;" onclick="toggleListItem(\'' + type + '\',\'' + it.id + '\')">';
      h += '<span style="width:24px;height:24px;border-radius:50%;border:2px solid ' + (checked ? 'var(--green)' : 'var(--border)') + ';display:flex;align-items:center;justify-content:center;flex-shrink:0;background:' + (checked ? 'var(--green)' : '#fff') + ';color:#fff;font-size:.88rem;">' + (checked ? '&#10003;' : '') + '</span>';
      h += '<span style="font-size:.88rem;color:' + (checked ? 'var(--text-3)' : 'var(--text)') + ';' + (checked ? 'text-decoration:line-through;' : '') + 'line-height:1.4;flex:1;">' + it.text + '</span>';
      // Drag handle
      h += '<span ontouchstart="listDragStart(event,\'' + type + '\',\'' + it.id + '\')" ontouchmove="listDragMove(event)" ontouchend="listDragEnd(event)" style="padding:4px 6px;color:var(--text-3);font-size:1rem;cursor:grab;touch-action:none;flex-shrink:0;"><i class="fa-solid fa-grip-lines"></i></span>';
      h += '</label>';
      h += '</div>';
    }
  }
  // Section dropdown + add row
  var todoCats = type === 'todo' ? ['Before We Leave','On The Road','Coming Home'] : ['Documents','Clothing','Sleeping','Kitchen & Food','Kids','Tools & RV','Fun & Entertainment','First Aid','Toiletries'];
  h += '<div style="margin-top:14px;display:flex;flex-direction:column;gap:7px;">';
  h += '<select id="list-cat-' + type + '" style="width:100%;padding:8px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.85rem;font-family:var(--font);background:var(--bg);color:var(--text);">';
  for (var tci = 0; tci < todoCats.length; tci++) {
    h += '<option value="' + todoCats[tci] + '">' + todoCats[tci] + '</option>';
  }
  h += '</select>';
  h += '<div style="display:flex;gap:8px;">';
  h += '<input id="list-add-' + type + '" type="text" placeholder="Add your own item\u2026" style="flex:1;padding:9px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.88rem;font-family:var(--font);outline:none;background:var(--bg);" onkeydown="if(event.key===\'Enter\')addCustomListItem(\'' + type + '\')" />';
  h += '<button onclick="addCustomListItem(\'' + type + '\')" style="background:var(--orange);color:#fff;border:none;border-radius:100px;padding:9px 16px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">+ Add</button>';
  h += '</div></div>';
  return h;
}
function restoreHiddenItems(type) {
  if (!appState.listHidden) return;
  appState.listHidden[type] = {};
  saveState(appState); renderLists();
}
function renderLists() {
  var el = document.getElementById('lists-content');
  if (!el) return;
  var ls = getListState();
  var customItems = appState.customListItems || { todo:[], pack:[] };
  var activeTab = appState.listsSubTab || 'todo';

  var tabs = [
    { id:'todo',     label:'&#9989; To-Do',    color:'var(--orange)' },
    { id:'pack',     label:'&#127959; Packing', color:'var(--blue)' },
    { id:'bookings', label:'&#127978; Bookings', color:'var(--green)' }
  ];

  var html = '<div style="display:flex;gap:0;border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:18px;">';
  for (var ti = 0; ti < tabs.length; ti++) {
    var tab = tabs[ti];
    var isActive = activeTab === tab.id;
    html += '<button onclick="setListsTab(\'' + tab.id + '\')" style="flex:1;padding:10px 4px;font-size:.82rem;font-weight:800;border:none;cursor:pointer;font-family:var(--font);background:' + (isActive ? tab.color : 'var(--card)') + ';color:' + (isActive ? '#fff' : 'var(--text-2)') + ';' + (ti > 0 ? 'border-left:1px solid var(--border);' : '') + '">' + tab.label + '</button>';
  }
  html += '</div>';

  if (activeTab === 'todo') {
    html += '<h3 style="font-size:.97rem;font-weight:800;color:var(--text);margin-bottom:10px;">&#9989; Pre-Trip To-Do</h3>';
    html += renderListSection(DEFAULT_TODO, customItems.todo, 'todo', ls.todo);
  } else if (activeTab === 'pack') {
    html += '<h3 style="font-size:.97rem;font-weight:800;color:var(--text);margin-bottom:10px;">&#127959; Packing Checklist</h3>';
    html += renderListSection(DEFAULT_PACKING, customItems.pack, 'pack', ls.pack);
  } else {
    html += renderBookings();
  }
  el.innerHTML = html;
}
function setListsTab(tab) {
  appState.listsSubTab = tab;
  renderLists();
}

/* â”€â”€ BOOKINGS RENDERER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderBookings() {
  if (!appState.bookingStatus) appState.bookingStatus = {};
  // Build unique lodging list from TRIP_DAYS
  var lodgings = [];
  var seen = {};
  for (var di = 0; di < TRIP_DAYS.length; di++) {
    var d = TRIP_DAYS[di];
    if (!d.sleep || d.sleepType === 'home' || d.sleep === 'HOME!') continue;
    if (!seen[d.sleep]) {
      seen[d.sleep] = {
        name: d.sleep, type: d.sleepType, phase: d.phase,
        checkIn: d.date, checkOut: d.date, nights: 1, stopId: d.stopId
      };
      lodgings.push(seen[d.sleep]);
    } else {
      seen[d.sleep].checkOut = d.date;
      seen[d.sleep].nights++;
    }
  }

  var bookedCount = lodgings.filter(function(l) { return appState.bookingStatus[l.name] && appState.bookingStatus[l.name].booked; }).length;

  var h = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">';
  h += '<h3 style="font-size:.97rem;font-weight:800;color:var(--text);margin:0;">&#127978; Campground &amp; Hotel Bookings</h3>';
  h += '<span style="font-size:.77rem;font-weight:800;color:var(--green);">' + bookedCount + ' / ' + lodgings.length + ' booked</span>';
  h += '</div>';

  // Progress bar
  var pct = lodgings.length > 0 ? Math.round(bookedCount / lodgings.length * 100) : 0;
  h += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;">';
  h += '<div style="flex:1;background:var(--border);border-radius:4px;height:8px;overflow:hidden;"><div style="background:var(--green);height:100%;width:' + pct + '%;transition:width .4s;border-radius:4px;"></div></div>';
  h += '<div style="font-size:.77rem;font-weight:800;color:var(--green);">' + pct + '%</div>';
  h += '</div>';

  var typeIcon = { rv_park:'&#127959;', hotel:'&#127970;', cabin:'&#127864;', airbnb:'&#127968;', home:'&#127968;' };
  var typeLabel = { rv_park:'RV Park', hotel:'Hotel', cabin:'Cabin', airbnb:'Airbnb', home:'Home' };

  for (var li = 0; li < lodgings.length; li++) {
    var lg = lodgings[li];
    var key = lg.name;
    var bs  = appState.bookingStatus[key] || {};
    var booked = !!bs.booked;
    var confirmNum = bs.confirmNum || '';
    var checkInFmt  = lg.checkIn  ? new Date(lg.checkIn  + 'T12:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric'}) : '';
    var checkOutFmt = lg.checkOut ? new Date(lg.checkOut + 'T12:00:00').toLocaleDateString('en-US', {month:'short',day:'numeric'}) : '';
    var icon = typeIcon[lg.type] || '&#127959;';
    var lbl  = typeLabel[lg.type] || lg.type;

    h += '<div style="background:' + (booked ? 'var(--green-l)' : 'var(--card)') + ';border:1.5px solid ' + (booked ? '#a8d5b8' : 'var(--border)') + ';border-radius:var(--radius-s);padding:13px 15px;margin-bottom:8px;">';
    // Top row
    h += '<div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:8px;">';
    h += '<div style="font-size:1.4rem;flex-shrink:0;line-height:1;">' + icon + '</div>';
    h += '<div style="flex:1;">';
    h += '<div style="font-weight:800;font-size:.92rem;color:var(--text);line-height:1.3;">' + lg.name + '</div>';
    h += '<div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:3px;">';
    h += '<span style="font-size:.72rem;color:var(--text-2);">&#128197; ' + checkInFmt + ' &ndash; ' + checkOutFmt + '</span>';
    h += '<span style="font-size:.72rem;color:var(--text-2);">&#127769; ' + lg.nights + ' night' + (lg.nights > 1 ? 's' : '') + '</span>';
    h += '<span style="font-size:.72rem;font-weight:700;color:var(--text-3);">' + lbl + '</span>';
    h += '</div>';
    h += '<div style="font-size:.72rem;color:var(--text-3);margin-top:2px;">&#128648; ' + lg.phase + '</div>';
    h += '</div>';
    // Booked toggle
    h += '<button onclick="toggleBooking(\'' + key.replace(/'/g,"\\'") + '\')" style="background:' + (booked ? 'var(--green)' : 'var(--bg)') + ';border:1.5px solid ' + (booked ? 'var(--green)' : 'var(--border)') + ';color:' + (booked ? '#fff' : 'var(--text-2)') + ';border-radius:100px;padding:6px 12px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;">'
      + (booked ? '&#10003; Booked' : 'Mark Booked') + '</button>';
    h += '</div>';
    // Confirmation number input (shown when booked)
    if (booked) {
      h += '<div style="display:flex;gap:6px;align-items:center;">';
      h += '<span style="font-size:.77rem;color:var(--green);font-weight:700;white-space:nowrap;">Confirm #:</span>';
      h += '<input type="text" value="' + confirmNum + '" placeholder="Enter confirmation number..." onchange="saveConfirmNum(\'' + key.replace(/'/g,"\\'") + '\',this.value)" style="flex:1;padding:6px 10px;border:1px solid #a8d5b8;border-radius:100px;font-size:.83rem;font-family:var(--font);background:#fff;outline:none;" />';
      h += '</div>';
    }
    // Google search link
    h += '<div style="margin-top:6px;">';
    h += '<a href="https://www.google.com/search?q=' + encodeURIComponent(lg.name + ' ' + lg.phase + ' campground reservations') + '" target="_blank" rel="noopener" style="font-size:.74rem;color:var(--blue);text-decoration:none;display:inline-flex;align-items:center;gap:4px;">&#128279; Search &amp; Book Online</a>';
    h += '</div>';
    h += '</div>';
  }

  // Add custom booking
  h += '<div style="margin-top:14px;padding:12px 14px;background:var(--bg);border:1.5px dashed var(--border);border-radius:var(--radius-s);">';
  h += '<div style="font-size:.77rem;font-weight:700;color:var(--text-3);margin-bottom:7px;">+ Add a custom booking (hotel, Airbnb, etc.)</div>';
  h += '<div style="display:flex;gap:6px;">';
  h += '<input id="booking-add-name" type="text" placeholder="Place name..." style="flex:2;padding:8px 10px;border:1.5px solid var(--border);border-radius:100px;font-size:.86rem;font-family:var(--font);background:#fff;outline:none;" />';
  h += '<button onclick="addCustomBooking()" style="background:var(--green);color:#fff;border:none;border-radius:100px;padding:8px 14px;font-size:.86rem;font-weight:800;cursor:pointer;font-family:var(--font);">+ Add</button>';
  h += '</div></div>';

  return h;
}
function toggleBooking(key) {
  if (!appState.bookingStatus) appState.bookingStatus = {};
  if (!appState.bookingStatus[key]) appState.bookingStatus[key] = {};
  appState.bookingStatus[key].booked = !appState.bookingStatus[key].booked;
  saveState(appState); renderLists();
}
function saveConfirmNum(key, val) {
  if (!appState.bookingStatus) appState.bookingStatus = {};
  if (!appState.bookingStatus[key]) appState.bookingStatus[key] = {};
  appState.bookingStatus[key].confirmNum = val;
  saveState(appState);
}
function addCustomBooking() {
  var inp = document.getElementById('booking-add-name');
  var name = inp ? inp.value.trim() : '';
  if (!name) return;
  if (!appState.customBookings) appState.customBookings = [];
  appState.customBookings.push({ name: name, type: 'hotel', phase: 'Custom', checkIn: '', checkOut: '', nights: 1, stopId: null });
  saveState(appState);
  if (inp) inp.value = '';
  renderLists();
  showToast('Booking added!', 1600);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   POSTCARDS TAB
   Compose â†’ AI text â†’ photo picker â†’ preview â†’ iOS share
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ POSTCARD STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _pcDraft = {
  stopId:        null,
  locationLabel: '',
  message:       '',
  toName:        '',    // recipient name
  toAddress:     '',    // recipient address (optional)
  selectedPhotos: [],   // array of dataUrl strings (max 3)
  bgImageDataUrl: null  // user-uploaded background image
};

/* â”€â”€ POSTCARD BACKGROUND GRADIENT (used if no image uploaded) â”€â”€â”€â”€â”€â”€ */
// SWAP THIS OUT when user provides their postcard image:
// set _pcBgDataUrl = 'data:image/png;base64,...' and call savePcBg()
var PC_BG_GRADIENT = 'linear-gradient(135deg, #fdf6e8 0%, #f5e6cc 35%, #ecdbc0 65%, #e4d0b0 100%)';

function getPcBg() {
  // Returns stored background image data URL, or null (gradient used as fallback)
  return appState.pcBgImage || null;
}
function savePcBg(dataUrl) {
  appState.pcBgImage = dataUrl;
  saveState(appState);
}

/* â”€â”€ RENDER POSTCARDS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderPostcards() {
  var el = document.getElementById('postcards-content');
  if (!el) return;

  // Under Construction banner â€” prepend to content
  var _ucBanner = '<div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;border-radius:var(--radius);padding:14px 18px;margin-bottom:18px;display:flex;align-items:center;gap:12px;">'
    + '<span style="font-size:1.8rem;flex-shrink:0;">ğŸš§</span>'
    + '<div>'
    + '<div style="font-weight:900;font-size:.95rem;margin-bottom:2px;">Under Construction</div>'
    + '<div style="font-size:.82rem;opacity:.9;">The postcard builder is being improved. Rendering may not work perfectly yet â€” check back soon for a polished experience!</div>'
    + '</div>'
    + '</div>';
  // We'll inject this at the top of el after the rest of the HTML is built

  // Collect all journal photos across all entries
  var allJournalPhotos = [];
  for (var ji = 0; ji < _journalEntries.length; ji++) {
    var je = _journalEntries[ji];
    if (je.photos && je.photos.length) {
      for (var pi = 0; pi < je.photos.length; pi++) {
        var _jpSrc = (je.photos[pi] && je.photos[pi].dataUrl) ? je.photos[pi].dataUrl : je.photos[pi];
        allJournalPhotos.push({ dataUrl: _jpSrc, day: je.day, location: je.location, entryId: je.id });
      }
    }
  }

  // Location options: trip stops
  var stopOpts = '';
  for (var si = 0; si < TRIP_STOPS.length; si++) {
    var ps = TRIP_STOPS[si];
    var sel = (_pcDraft.stopId === ps.id) ? ' selected' : '';
    stopOpts += '<option value="' + ps.id + '"' + sel + '>' + ps.emoji + ' ' + ps.name + ', ' + ps.state + '</option>';
  }

  var html = '';

  // Header
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;flex-wrap:wrap;gap:8px;">';
  html += '<h2 class="section-title" style="margin:0;">&#9993; Send a Postcard</h2>';
  // Background image upload button
  html += '<label style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:6px 12px;font-size:.78rem;font-weight:700;color:var(--text-2);cursor:pointer;display:flex;align-items:center;gap:5px;" title="Optional: upload a photo to use as the postcard background (otherwise a parchment gradient is used)">'
    + '&#128444; Background Photo <span style="font-weight:400;font-size:.72rem;opacity:.7;">(optional)</span><input type="file" accept="image/*" style="display:none;" onchange="handlePcBgUpload(event)"></label>';
  html += '</div>';
  html += '<div style="font-size:.83rem;color:var(--text-2);margin-bottom:18px;">Write a postcard to friends &amp; family â€” AI writes the message, you send it.</div>';

  // â”€â”€ STEP 1: Location
  html += '<div class="pc-step-label"><span class="pc-step-num">1</span> Choose Your Location</div>';
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
  html += '<select id="pc-stop-sel" onchange="pcSelectStop(this.value)" style="flex:1;min-width:160px;padding:9px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;">';
  html += '<option value="">â€” Select a stop â€”</option>' + stopOpts;
  html += '</select>';
  html += '<input id="pc-custom-loc" type="text" placeholder="Or type: Postcard from the Ozarks..." value="' + (_pcDraft.locationLabel || '') + '" oninput="pcSetCustomLabel(this.value)" style="flex:2;min-width:180px;padding:9px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '</div>';

  // â”€â”€ STEP 1b: To: field
  html += '<div class="pc-step-label" style="margin-top:16px;"><span class="pc-step-num" style="background:var(--orange);">&#9993;</span> Address It To: <span style="font-weight:400;text-transform:none;color:var(--text-3);font-size:.7rem;">(who is this postcard for?)</span></div>';
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">';
  html += '<input id="pc-to-name" type="text" placeholder="Grandma &amp; Grandpa Maass" value="' + (_pcDraft.toName||'') + '" oninput="pcSetToName(this.value)" style="flex:1;min-width:150px;padding:9px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '<input id="pc-to-address" type="text" placeholder="123 Main St, Springfield, IL (optional)" value="' + (_pcDraft.toAddress||'') + '" oninput="pcSetToAddress(this.value)" style="flex:2;min-width:180px;padding:9px 12px;border:1.5px solid var(--border);border-radius:100px;font-size:.9rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '</div>';

  // â”€â”€ STEP 2: Pick Photos
  html += '<div class="pc-step-label" style="margin-top:16px;"><span class="pc-step-num">2</span> Pick Photos <span style="font-weight:400;text-transform:none;color:var(--text-3);font-size:.7rem;">(choose up to 3 from your journal or upload new)</span></div>';

  if (allJournalPhotos.length > 0) {
    html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:10px;" id="pc-journal-photos">';
    for (var jpi = 0; jpi < allJournalPhotos.length; jpi++) {
      var jp = allJournalPhotos[jpi];
      var isSelPh = _pcDraft.selectedPhotos.indexOf(jp.dataUrl) !== -1;
      var selIdx  = _pcDraft.selectedPhotos.indexOf(jp.dataUrl);
      html += '<div style="position:relative;cursor:pointer;" onclick="pcTogglePhoto(\'' + jpi + '\')" data-url-idx="' + jpi + '">';
      html += '<img src="' + jp.dataUrl + '" class="pc-photo-thumb' + (isSelPh ? ' selected' : '') + '" />';
      if (isSelPh) html += '<div style="position:absolute;top:2px;right:2px;background:var(--orange);color:#fff;border-radius:50%;width:20px;height:20px;font-size:.68rem;font-weight:900;display:flex;align-items:center;justify-content:center;">' + (selIdx + 1) + '</div>';
      html += '<div style="font-size:.58rem;color:var(--text-3);text-align:center;margin-top:2px;">Day ' + jp.day + '</div>';
      html += '</div>';
    }
    html += '</div>';
  } else {
    html += '<div style="background:var(--bg);border:1.5px dashed var(--border);border-radius:12px;padding:14px;font-size:.83rem;color:var(--text-3);margin-bottom:10px;text-align:center;">No journal photos yet &mdash; upload some below or in the Journal tab</div>';
  }

  // Store all journal photo data urls for picker
  html += '<script>window._pcAllPhotos=' + JSON.stringify(allJournalPhotos.map(function(x){return x.dataUrl;})) + ';<\/script>';

  // Upload new photos for postcard
  html += '<label style="display:inline-flex;align-items:center;gap:7px;padding:7px 14px;background:var(--blue-l);border:1px dashed #7aaac8;border-radius:100px;cursor:pointer;font-size:.8rem;font-weight:700;color:var(--blue);margin-bottom:4px;">';
  html += '&#128247; Upload Photos<input type="file" accept="image/*" multiple style="display:none;" onchange="handlePcPhotoUpload(event)"></label>';
  if (_pcDraft.selectedPhotos.length > 0) {
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0;" id="pc-selected-summary">';
    for (var spi = 0; spi < _pcDraft.selectedPhotos.length; spi++) {
      html += '<div style="position:relative;">'
        + '<img src="' + _pcDraft.selectedPhotos[spi] + '" style="width:56px;height:56px;object-fit:cover;border-radius:8px;border:3px solid var(--orange);" />'
        + '<button onclick="pcRemovePhoto(' + spi + ')" style="position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:.7rem;cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;">&#215;</button>'
        + '</div>';
    }
    html += '</div>';
  }

  // â”€â”€ STEP 3: Message
  html += '<div class="pc-step-label"><span class="pc-step-num">3</span> Your Message</div>';
  html += '<button onclick="generatePostcardText()" id="pc-gen-btn" style="background:var(--purple);color:#fff;border:none;border-radius:100px;padding:10px 18px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);margin-bottom:10px;display:flex;align-items:center;gap:8px;">&#129302; Write my postcard from our journal entries</button>';
  html += '<textarea id="pc-message" placeholder="Your postcard message will appear here after AI generates it, or type your own..." style="width:100%;min-height:120px;padding:11px 13px;border:1.5px solid var(--border);border-radius:10px;font-size:.92rem;font-family:var(--font);line-height:1.6;color:var(--text);background:var(--bg);resize:vertical;outline:none;" oninput="pcSetMessage(this.value)">' + (_pcDraft.message || '') + '</textarea>';

  // â”€â”€ STEP 4: Preview & Send
  html += '<div class="pc-step-label" style="margin-top:18px;"><span class="pc-step-num">4</span> Preview &amp; Send</div>';
  html += '<button onclick="buildAndShowPostcardPreview()" style="width:100%;background:var(--blue);color:#fff;border:none;border-radius:100px;padding:13px;font-size:.97rem;font-weight:800;cursor:pointer;font-family:var(--font);margin-bottom:14px;display:flex;align-items:center;justify-content:center;gap:8px;">&#128247; Build Postcard Preview</button>';

  // Preview area
  html += '<div id="pc-preview-area" style="margin-bottom:14px;"></div>';

  // Share buttons (hidden until preview built)
  html += '<div id="pc-share-btns" style="display:none;gap:10px;flex-wrap:wrap;margin-bottom:20px;">';
  html += '<button class="pc-share-btn" onclick="sharePostcard()" style="background:var(--green);color:#fff;">&#128279; Share via iOS</button>';
  html += '<button class="pc-share-btn" onclick="downloadPostcard()" style="background:var(--blue);color:#fff;">&#8681; Download</button>';
  html += '<button class="pc-share-btn" onclick="copyPostcardText()" style="background:var(--bg);color:var(--text);border:1.5px solid var(--border);">&#128203; Copy Text</button>';
  html += '</div>';

  // Saved postcards
  if (appState.savedPostcards && appState.savedPostcards.length > 0) {
    html += '<div class="pc-step-label" style="margin-top:8px;"><span class="pc-step-num" style="background:var(--green);">&#10003;</span> Sent Postcards</div>';
    html += '<div style="display:flex;flex-direction:column;gap:8px;">';
    for (var sci = appState.savedPostcards.length - 1; sci >= 0; sci--) {
      var sc = appState.savedPostcards[sci];
      html += '<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:12px;">';
      html += '<span style="font-size:1.4rem;">&#9993;</span>';
      html += '<div style="flex:1;"><div style="font-weight:700;font-size:.88rem;">' + sc.location + '</div>';
      html += '<div style="font-size:.75rem;color:var(--text-2);">' + new Date(sc.created).toLocaleDateString() + ' &mdash; ' + sc.message.substring(0, 60) + '&hellip;</div></div>';
      html += '<button onclick="deleteSavedPostcard(' + sci + ')" style="background:var(--red-l);border:1px solid var(--red);color:var(--red);border-radius:100px;padding:4px 8px;font-size:.7rem;cursor:pointer;font-family:var(--font);">&#215;</button>';
      html += '</div>';
    }
    html += '</div>';
  }

  el.innerHTML = _ucBanner + html;
}

/* â”€â”€ POSTCARD DRAFT HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pcSelectStop(val) {
  _pcDraft.stopId = val ? parseInt(val) : null;
  var stop = val ? getStop(parseInt(val)) : null;
  if (stop) {
    _pcDraft.locationLabel = 'Postcard from ' + _sn(stop);
    var inp = document.getElementById('pc-custom-loc');
    if (inp) inp.value = _pcDraft.locationLabel;
  }
}
function pcSetCustomLabel(val) {
  _pcDraft.locationLabel = val;
}
function pcSetMessage(val) {
  _pcDraft.message = val;
}
function pcSetToName(val) { _pcDraft.toName = val; }
function pcSetToAddress(val) { _pcDraft.toAddress = val; }
function pcTogglePhoto(idx) {
  var photos = window._pcAllPhotos || [];
  var url = photos[parseInt(idx)];
  if (!url) return;
  var pos = _pcDraft.selectedPhotos.indexOf(url);
  if (pos !== -1) {
    _pcDraft.selectedPhotos.splice(pos, 1);
  } else {
    if (_pcDraft.selectedPhotos.length >= 3) { showToast('Max 3 photos per postcard', 1800); return; }
    _pcDraft.selectedPhotos.push(url);
  }
  renderPostcards();
}
function pcRemovePhoto(idx) {
  _pcDraft.selectedPhotos.splice(idx, 1);
  renderPostcards();
}
function handlePcPhotoUpload(event) {
  var files = event.target.files;
  if (!files || !files.length) return;
  for (var fi = 0; fi < files.length; fi++) {
    if (_pcDraft.selectedPhotos.length >= 3) { showToast('Max 3 photos per postcard', 1800); break; }
    (function(file) {
      var reader = new FileReader();
      reader.onload = function(e) {
        if (_pcDraft.selectedPhotos.length < 3) {
          _pcDraft.selectedPhotos.push(e.target.result);
          renderPostcards();
        }
      };
      reader.readAsDataURL(file);
    })(files[fi]);
  }
  event.target.value = '';
}
function handlePcBgUpload(event) {
  var file = event.target.files && event.target.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    savePcBg(e.target.result);
    showToast('&#127774; Background image saved!', 2000);
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}

/* â”€â”€ AI POSTCARD MESSAGE GENERATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function generatePostcardText() {
  var loc = (_pcDraft.locationLabel || '').trim();
  if (!loc) { showToast('Pick a location first (Step 1)', 2000); return; }
  if (_journalEntries.length === 0) {
    showToast('&#9998; Add some journal entries first â€” that way the AI can write something personal!', 3200);
    return;
  }

  var btn = document.getElementById('pc-gen-btn');
  if (btn) { btn.textContent = '&#129302; Writing your postcard...'; btn.disabled = true; btn.classList.add('pc-generating'); }

  // Gather journal context for this stop
  var journalContext = '';
  var stopDays = _pcDraft.stopId ? TRIP_DAYS.filter(function(d) { return d.stopId === _pcDraft.stopId; }) : [];
  var stopDayNums = stopDays.map(function(d) { return d.day; });
  var relEntries = _journalEntries.filter(function(e) { return stopDayNums.indexOf(e.day) !== -1; });
  if (relEntries.length === 0) relEntries = _journalEntries.slice(-5); // fallback: recent
  for (var ri = 0; ri < Math.min(relEntries.length, 5); ri++) {
    var re = relEntries[ri];
    if (re.text) journalContext += 'Day ' + re.day + ' (' + (re.author || 'us') + '): ' + re.text.substring(0, 180) + '\n';
  }

  var stopName = '';
  if (_pcDraft.stopId) {
    var ps2 = getStop(_pcDraft.stopId);
    if (ps2) stopName = ps2.name + ', ' + ps2.state;
  }

  var prompt = 'Write a warm, personal, family postcard message from the Maass family '
    + '(Paul, Melissa, Leila age 9, Luna age 4, Eli age 2) who are on a 46-day cross-country RV trip.\n\n'
    + 'Location: ' + (stopName || loc) + '\n'
    + 'Postcard from: "' + loc + '"\n'
    + (journalContext ? 'Journal entries from this stop:\n' + journalContext + '\n' : '')
    + 'Write exactly 2 paragraphs. Tone: warm, excited, a little funny, like you\'re writing to grandparents or close friends. '
    + 'Mention specific things they did or saw if journal context is provided. End with a sign-off like "Love, the Maass crew ğŸš" or similar. '
    + 'No asterisks, no headers, just two paragraphs of postcard text. Max 120 words total.';

  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:200,temperature:0.88} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    text = text.replace(/\*/g, '').trim();
    _pcDraft.message = text;
    var ta = document.getElementById('pc-message');
    if (ta) ta.value = text;
    if (btn) { btn.innerHTML = '&#129302; AI Write My Postcard'; btn.disabled = false; btn.classList.remove('pc-generating'); }
    showToast('&#9993; Postcard message ready!', 2000);
  })
  .catch(function() {
    if (btn) { btn.innerHTML = '&#129302; AI Write My Postcard'; btn.disabled = false; btn.classList.remove('pc-generating'); }
    showToast('Could not generate message â€” check connection', 2400);
  });
}

/* â”€â”€ POSTCARD PREVIEW BUILDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _pcCanvasDataUrl = null; // most recently rendered postcard image

function buildAndShowPostcardPreview() {
  // Read latest message from textarea
  var ta = document.getElementById('pc-message');
  if (ta) _pcDraft.message = ta.value;
  var loc = (_pcDraft.locationLabel || '').trim() || 'Postcard from the Road';
  var msg = (_pcDraft.message || '').trim() || 'We\'re having an amazing adventure on our RV trip! Wish you were here.';
  var today = new Date().toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });

  // Build the off-screen postcard HTML
  var root = document.getElementById('postcard-render-root');
  if (!root) return;

  var toName    = (_pcDraft.toName    || '').trim();
  var toAddress = (_pcDraft.toAddress || '').trim();

  var bgImg = getPcBg();
  var bgStyle = bgImg
    ? 'background:url(' + bgImg + ') center/cover no-repeat;'
    : PC_BG_GRADIENT + ';background:' + PC_BG_GRADIENT + ';';

  // Photo strip layout (left 40% = photos, right 60% = text)
  var photos = _pcDraft.selectedPhotos;
  var photoHtml = '';
  if (photos.length === 0) {
    // Placeholder photo area
    photoHtml = '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.15);border-radius:10px;border:2px dashed rgba(255,255,255,.5);">'
      + '<span style="font-size:4rem;opacity:.5;">&#128247;</span></div>';
  } else if (photos.length === 1) {
    photoHtml = '<img src="' + photos[0] + '" style="width:100%;height:100%;object-fit:cover;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.25);" crossorigin="anonymous" />';
  } else if (photos.length === 2) {
    // Side-by-side collage
    photoHtml = '<div style="display:flex;flex-direction:row;gap:8px;height:100%;">'
      + '<img src="' + photos[0] + '" style="flex:1;height:100%;object-fit:cover;border-radius:8px;box-shadow:0 3px 12px rgba(0,0,0,.22);" crossorigin="anonymous" />'
      + '<img src="' + photos[1] + '" style="flex:1;height:100%;object-fit:cover;border-radius:8px;box-shadow:0 3px 12px rgba(0,0,0,.22);" crossorigin="anonymous" />'
      + '</div>';
  } else {
    photoHtml = '<div style="display:flex;flex-direction:column;gap:6px;height:100%;">'
      + '<img src="' + photos[0] + '" style="flex:2;width:100%;object-fit:cover;border-radius:8px;box-shadow:0 3px 12px rgba(0,0,0,.22);" crossorigin="anonymous" />'
      + '<div style="flex:1;display:flex;gap:6px;">'
      + '<img src="' + photos[1] + '" style="flex:1;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.2);" crossorigin="anonymous" />'
      + '<img src="' + photos[2] + '" style="flex:1;object-fit:cover;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.2);" crossorigin="anonymous" />'
      + '</div></div>';
  }

  // Format message: split into two paragraphs
  var paragraphs = msg.split(/\n\n+/);
  var msgHtml = '';
  for (var pi = 0; pi < paragraphs.length; pi++) {
    msgHtml += '<p style="margin:0 0 12px;line-height:1.65;font-size:17px;color:#3a3020;">' + paragraphs[pi].replace(/\n/g, '<br>') + '</p>';
  }

  root.innerHTML = '<div style="width:1200px;height:800px;' + bgStyle + 'position:relative;font-family:Georgia,serif;padding:36px;">'
    // Postmark circle (top right)
    + '<div style="position:absolute;top:30px;right:36px;width:90px;height:90px;border-radius:50%;border:3px solid rgba(150,100,50,.45);display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(255,255,255,.18);text-align:center;">'
    + '<div style="font-size:9px;font-weight:700;color:rgba(100,60,20,.7);letter-spacing:.05em;text-transform:uppercase;">U.S. MAIL</div>'
    + '<div style="font-size:10px;font-weight:700;color:rgba(100,60,20,.8);">' + today + '</div>'
    + '<div style="font-size:8px;color:rgba(100,60,20,.6);letter-spacing:.04em;">RV TRIP</div>'
    + '</div>'
    // Main layout: left = photos, right = message
    + '<div style="display:flex;gap:28px;height:100%;align-items:stretch;">'
    // Left: photos
    + '<div style="flex:0 0 440px;height:700px;">' + photoHtml + '</div>'
    // Dividing line
    + '<div style="width:1px;background:rgba(150,100,50,.25);flex-shrink:0;align-self:stretch;margin:20px 0;"></div>'
    // Right: message card
    + '<div style="flex:1;display:flex;flex-direction:column;justify-content:space-between;padding:10px 0;">'
    // Location header
    + '<div>'
    + '<div style="font-size:11px;font-weight:700;color:rgba(100,60,20,.6);text-transform:uppercase;letter-spacing:.12em;margin-bottom:6px;">&#10022; A NOTE FROM THE MAASS FAMILY &#10022;</div>'
    + '<div style="font-size:26px;font-weight:900;color:#4a3010;line-height:1.2;margin-bottom:16px;font-family:Georgia,serif;">' + loc + '</div>'
    // Decorative line
    + '<div style="height:2px;background:linear-gradient(90deg,rgba(150,100,50,.5),transparent);margin-bottom:18px;width:80%;"></div>'
    // Message
    + '<div style="flex:1;">' + msgHtml + '</div>'
    + '</div>'
    // Bottom row: RV emoji + optional To: address block
    + '<div style="border-top:1px solid rgba(150,100,50,.2);padding-top:14px;display:flex;align-items:flex-end;justify-content:space-between;gap:12px;">'
    + '<div style="flex-shrink:0;">'
    + '<div style="font-size:28px;line-height:1;">&#128663;</div>'
    + '<div style="font-size:12px;font-style:italic;color:#6b4f28;font-family:Georgia,serif;margin-top:4px;">Wish you were here!</div>'
    + '<div style="font-size:10px;color:rgba(100,60,20,.5);margin-top:2px;">Maass Family RV Adventure 2026</div>'
    + '</div>'
    + (toName
        ? '<div style="border:1.5px solid rgba(150,100,50,.35);border-radius:12px;padding:10px 14px;background:rgba(255,255,255,.3);text-align:left;min-width:180px;">'
          + '<div style="font-size:10px;font-weight:700;color:rgba(100,60,20,.55);letter-spacing:.1em;text-transform:uppercase;margin-bottom:4px;">To:</div>'
          + '<div style="font-size:15px;font-weight:700;color:#4a3010;font-family:Georgia,serif;line-height:1.3;">' + toName + '</div>'
          + (toAddress ? '<div style="font-size:12px;color:#6b4f28;margin-top:3px;font-style:italic;">' + toAddress + '</div>' : '')
          + '</div>'
        : '')
    + '</div>'
    + '</div>'
    + '</div>'
    + '</div>';

  // Use html2canvas to capture it
  var previewArea = document.getElementById('pc-preview-area');
  if (previewArea) previewArea.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-2);font-size:.88rem;">&#128247; Rendering your postcard&hellip;</div>';

  if (typeof html2canvas === 'undefined') {
    // html2canvas not loaded yet â€” show HTML preview directly
    showPcHtmlFallback(root, previewArea, loc, msg);
    return;
  }

  // Move render root into the visible viewport for html2canvas (it can't capture off-screen elements)
  // A black overlay hides this briefly from the user
  var _capOverlay = document.createElement('div');
  _capOverlay.style.cssText = 'position:fixed;inset:0;background:#000;z-index:8888;pointer-events:none;';
  document.body.appendChild(_capOverlay);

  root.style.position = 'fixed';
  root.style.left     = '0';
  root.style.top      = '0';
  root.style.zIndex   = '8889';
  root.style.overflow = 'visible';

  // Give the browser a frame to paint the element before capturing
  requestAnimationFrame(function() {
    requestAnimationFrame(function() {
      html2canvas(root, {
        width: 1200, height: 800,
        useCORS: true, allowTaint: true,
        backgroundColor: null, scale: 1,
        scrollX: 0, scrollY: 0,
        windowWidth: 1200, windowHeight: 800,
        logging: false
      }).then(function(canvas) {
        // Restore root to off-screen
        root.style.left     = '-1300px';
        root.style.top      = '0';
        root.style.zIndex   = '-1';
        root.style.overflow = 'hidden';
        _capOverlay.remove();
        root.innerHTML = '';

        _pcCanvasDataUrl = canvas.toDataURL('image/jpeg', 0.92);
        var previewImg = document.createElement('img');
        previewImg.src = _pcCanvasDataUrl;
        previewImg.style.cssText = 'width:100%;border-radius:12px;box-shadow:0 6px 30px rgba(0,0,0,.22);display:block;';
        if (previewArea) {
          previewArea.innerHTML = '';
          previewArea.appendChild(previewImg);
        }
        var shareRow = document.getElementById('pc-share-btns');
        if (shareRow) shareRow.style.display = 'flex';
        showToast('&#9993; Postcard ready to share!', 2200);
      }).catch(function(err) {
        root.style.left     = '-1300px';
        root.style.top      = '0';
        root.style.zIndex   = '-1';
        root.style.overflow = 'hidden';
        _capOverlay.remove();
        if (previewArea) previewArea.innerHTML = '<div style="color:var(--red);padding:12px;">Preview error: ' + (err.message||'unknown') + '</div>';
      });
    });
  });
}

function showPcHtmlFallback(root, previewArea, loc, msg) {
  // Fallback when html2canvas isn't ready: show a simplified preview
  root.innerHTML = '';
  _pcCanvasDataUrl = null;
  if (previewArea) {
    previewArea.innerHTML = '<div style="background:linear-gradient(135deg,#fdf6e8,#ecdbc0);border-radius:12px;padding:24px;box-shadow:0 6px 24px rgba(0,0,0,.18);">'
      + '<div style="font-weight:800;font-size:1.1rem;color:#4a3010;margin-bottom:10px;">' + loc + '</div>'
      + '<div style="font-size:.88rem;color:#3a3020;line-height:1.6;white-space:pre-wrap;">' + msg + '</div>'
      + '<div style="margin-top:16px;font-size:.75rem;color:rgba(100,60,20,.6);">Maass Family RV Adventure 2026 &#128663;</div>'
      + '</div>';
    var shareRow = document.getElementById('pc-share-btns');
    if (shareRow) shareRow.style.display = 'flex';
  }
}

/* â”€â”€ SHARE & DOWNLOAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function sharePostcard() {
  var msg = (_pcDraft.message || '').trim() || '';
  var loc = (_pcDraft.locationLabel || '').trim() || 'The Road';
  var shareText = loc + '\n\n' + msg + '\n\nâ€” Maass Family RV Adventure 2026 ğŸš';

  if (_pcCanvasDataUrl) {
    // Convert data URL to blob
    try {
      var arr = _pcCanvasDataUrl.split(',');
      var mimeType = arr[0].match(/:(.*?);/)[1];
      var bstr = atob(arr[1]);
      var n = bstr.length;
      var u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      var blob = new Blob([u8arr], { type: mimeType });
      var file = new File([blob], 'postcard-' + Date.now() + '.jpg', { type: mimeType });

      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({ files: [file], title: loc, text: shareText })
          .then(function() {
            saveCurrentPostcard();
            showToast('&#9993; Postcard sent!', 2400);
          })
          .catch(function(e) { if (e.name !== 'AbortError') shareTextOnly(shareText); });
        return;
      }
    } catch(e2) { /* fall through */ }
  }
  // Fallback: share text only
  shareTextOnly(shareText);
}

function shareTextOnly(text) {
  if (navigator.share) {
    navigator.share({ title: _pcDraft.locationLabel || 'Postcard from the Road', text: text })
      .then(function() { saveCurrentPostcard(); showToast('&#9993; Postcard shared!', 2200); })
      .catch(function(e) { if (e.name !== 'AbortError') copyPostcardText(); });
  } else {
    copyPostcardText();
  }
}

function downloadPostcard() {
  if (!_pcCanvasDataUrl) { showToast('Build the preview first', 1800); return; }
  var a = document.createElement('a');
  a.href = _pcCanvasDataUrl;
  a.download = 'postcard-' + (_pcDraft.locationLabel || 'maass').replace(/[^a-z0-9]/gi,'_').toLowerCase() + '.jpg';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  saveCurrentPostcard();
  showToast('&#8681; Postcard downloaded!', 2000);
}

function copyPostcardText() {
  var loc = (_pcDraft.locationLabel || '').trim() || 'Postcard from the Road';
  var msg = (_pcDraft.message || '').trim();
  var full = loc + '\n\n' + msg + '\n\nâ€” Maass Family RV Adventure 2026 ğŸš';
  if (navigator.clipboard) {
    navigator.clipboard.writeText(full).then(function() {
      showToast('&#128203; Text copied! Paste into iMessage or email.', 2800);
    });
  } else {
    var ta = document.createElement('textarea');
    ta.value = full; ta.style.cssText = 'position:fixed;opacity:0;';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    showToast('&#128203; Text copied!', 2000);
  }
}

function saveCurrentPostcard() {
  if (!appState.savedPostcards) appState.savedPostcards = [];
  appState.savedPostcards.push({
    location: _pcDraft.locationLabel || 'Unknown',
    message:  _pcDraft.message || '',
    created:  new Date().toISOString()
  });
  saveState(appState);
}

function deleteSavedPostcard(idx) {
  if (!appState.savedPostcards) return;
  appState.savedPostcards.splice(idx, 1);
  saveState(appState);
  renderPostcards();
}

/* â”€â”€ ADD NEW DESTINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _admConfirmedName = '';
var _admConfirmedDesc = '';
var _admDaysNeeded    = 2;
var _admConfirmedAttraction = '';
var _admAnalysisText  = '';

function _admSetStep(n) {
  ['adm-step1','adm-step2','adm-step3','adm-loading'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) el.classList.add('hidden');
  });
  var active = n === 'loading' ? 'adm-loading' : 'adm-step' + n;
  var el2 = document.getElementById(active);
  if (el2) el2.classList.remove('hidden');
  /* progress dots */
  var stepN = n === 'loading' ? 0 : parseInt(n);
  ['adm-dot1','adm-dot2','adm-dot3'].forEach(function(id, i) {
    var d = document.getElementById(id);
    if (d) d.style.background = (i < stepN) ? 'var(--blue)' : 'var(--border)';
  });
  var p1 = document.getElementById('adm-prog1');
  var p2 = document.getElementById('adm-prog2');
  if (p1) p1.style.width = (stepN >= 2 ? '100%' : '0%');
  if (p2) p2.style.width = (stepN >= 3 ? '100%' : '0%');
}

function openAddDest() {
  _admConfirmedName = ''; _admConfirmedDesc = ''; _admDaysNeeded = 2; _admConfirmedAttraction = ''; _admAnalysisText = '';
  document.getElementById('add-dest-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  document.getElementById('adm-city').value = '';
  _admSetStep(1);
  setTimeout(function(){ document.getElementById('adm-city').focus(); }, 150);
}
function closeAddDest() {
  document.getElementById('add-dest-modal').classList.add('hidden');
  document.body.style.overflow = '';
}
function admBackToStep1() {
  _admSetStep(1);
  setTimeout(function(){ document.getElementById('adm-city').focus(); }, 120);
}

function lookupDestination() {
  var city = (document.getElementById('adm-city').value || '').trim();
  if (!city) { showToast('Please enter a city or place name', 2000); return; }

  document.getElementById('adm-loading-msg').textContent = 'Verifying \u201c' + city + '\u201d\u2026';
  _admSetStep('loading');

  var prompt = 'A family is planning an RV road trip and typed: "' + city + '".\n\n'
    + 'Identify the best US destination CITY or REGION they should visit.\n'
    + 'IMPORTANT: If they typed a specific attraction, venue, or landmark (not a city/region), '
    + 'return the CITY it is located in \u2014 not the attraction itself.\n\n'
    + 'Respond in this EXACT format with no extra text:\n'
    + 'CONFIRMED: [City or Region, e.g. "El Paso, Texas" \u2014 never a specific venue]\n'
    + 'ATTRACTION: [the specific venue/attraction name if they typed one, otherwise leave blank]\n'
    + 'VALID: [yes or no \u2014 is this a real visitable place in the US?]\n'
    + 'DESC: [1-2 sentences about why this city/region is great for a family with young kids on an RV trip]\n'
    + 'DAYS: [recommended number of days to spend, just a single digit like 2]';

  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:200,temperature:0.3} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = ''; try { text = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}
    if (!text) { _admSetStep(1); showToast('Could not verify place. Try again.', 2500); return; }

    var confirmed   = (text.match(/CONFIRMED:\s*(.+)/i)||[])[1] || city;
    var attraction  = (text.match(/ATTRACTION:\s*(.+)/i)||[])[1] || '';
    var valid       = (text.match(/VALID:\s*(\w+)/i)||[])[1] || 'yes';
    var desc        = (text.match(/DESC:\s*(.+)/i)||[])[1] || '';
    var days        = parseInt((text.match(/DAYS:\s*(\d)/i)||[])[1]) || 2;

    confirmed  = confirmed.trim().replace(/^"|"$/g,'');
    attraction = attraction.trim().replace(/^"|"$/g,'');
    desc       = desc.trim();

    if (valid.toLowerCase() === 'no') {
      _admSetStep(1);
      showToast('Couldn\u2019t find that place. Try a different name.', 2800);
      return;
    }

    _admConfirmedName       = confirmed;
    _admConfirmedDesc       = desc;
    _admDaysNeeded          = days;
    _admConfirmedAttraction = attraction;

    var cardHtml = '<div style="display:flex;align-items:flex-start;gap:12px;">'
      + '<div style="font-size:1.8rem;flex-shrink:0;">&#128205;</div>'
      + '<div>'
      + '<div style="font-weight:900;font-size:1rem;color:var(--blue);margin-bottom:4px;">' + confirmed + '</div>'
      + (desc ? '<div style="font-size:.84rem;color:var(--text);line-height:1.55;margin-bottom:8px;">' + desc + '</div>' : '')
      + '<div style="display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--blue);border-radius:20px;padding:3px 10px;font-size:.75rem;font-weight:700;color:var(--blue);">'
      + '&#9200; Suggested stay: ' + days + ' day' + (days !== 1 ? 's' : '') + '</div>'
      + '</div></div>';
    document.getElementById('adm-confirm-card').innerHTML = cardHtml;
    _admSetStep(2);
  })
  .catch(function() { _admSetStep(1); showToast('Network error. Try again.', 2500); });
}

function analyzeDestination() {
  if (!_admConfirmedName) return;
  document.getElementById('adm-loading-msg').textContent = 'Analyzing fit for ' + _admConfirmedName + '\u2026';
  _admSetStep('loading');

  var tripSummary = TRIP_STOPS.map(function(s) { return s.name + ' (' + s.state + ')'; }).join(' \u2192 ');
  var prompt = 'A family with kids (ages 2, 4, 9) is on a 46-day RV trip visiting: ' + tripSummary + '.\n\n'
    + 'They want to add ' + _admConfirmedName + ' (' + _admDaysNeeded + ' days).\n\n'
    + 'Respond in this EXACT structured format â€” each section on its own line, no extra text:\n'
    + 'FIT: [1 sentence â€” which part of the trip it fits best and why, e.g. "between Sedona and the Grand Canyon"]\n'
    + 'ACTIVITIES: [2-3 specific family-friendly things to do there, comma-separated]\n'
    + 'TRADEOFF: [1 specific suggestion for what to shorten or adjust to fit it in]\n'
    + 'IMPACT: [brief impact label, e.g. "+ ' + _admDaysNeeded + ' days added"]';

  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:300,temperature:0.6} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = ''; try { text = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}
    if (!text) { _admSetStep(2); showToast('Could not analyze. Try again.', 2500); return; }

    _admAnalysisText = text;

    var fit        = (text.match(/FIT:\s*(.+)/i)||[])[1] || '';
    var activities = (text.match(/ACTIVITIES:\s*(.+)/i)||[])[1] || '';
    var tradeoff   = (text.match(/TRADEOFF:\s*(.+)/i)||[])[1] || '';
    var impact     = (text.match(/IMPACT:\s*(.+)/i)||[])[1] || ('+' + _admDaysNeeded + ' days');

    function sectionBlock(icon, label, content, color) {
      return '<div style="border-radius:8px;overflow:hidden;border:1px solid var(--border);margin-bottom:8px;">'
        + '<div style="background:' + color + ';color:#fff;font-size:.68rem;font-weight:800;padding:5px 12px;text-transform:uppercase;letter-spacing:.06em;">' + icon + '  ' + label + '</div>'
        + '<div style="padding:9px 12px;font-size:.84rem;line-height:1.55;color:var(--text);">' + content + '</div></div>';
    }

    var aHtml = '<div style="background:var(--blue-l);border:1.5px solid var(--blue);border-radius:12px;padding:12px;margin-bottom:12px;display:flex;align-items:center;gap:10px;">'
      + '<div style="font-size:1.4rem;">&#128205;</div>'
      + '<div><div style="font-weight:900;font-size:.95rem;color:var(--blue);">' + _admConfirmedName + '</div>'
      + '<div style="font-size:.78rem;color:var(--text-2);">' + _admDaysNeeded + ' day' + (_admDaysNeeded !== 1 ? 's' : '') + ' recommended</div></div>'
      + '</div>';
    if (fit)        aHtml += sectionBlock('&#128205;', 'Best fit in trip', fit, 'var(--blue)');
    if (activities) aHtml += sectionBlock('&#127775;', 'Things to do', activities, 'var(--green)');
    if (tradeoff)   aHtml += sectionBlock('&#9878;&#65039;', 'Suggested trade-off', tradeoff, 'var(--orange)');
    if (impact)     aHtml += '<div style="background:var(--orange-l);border:1px solid #f0c89e;border-radius:12px;padding:8px 12px;font-size:.8rem;font-weight:700;color:var(--orange-d);">&#9889; Impact: ' + impact.replace(/\*/g,'') + '</div>';

    document.getElementById('adm-analysis-card').innerHTML = aHtml;
    _admSetStep(3);
  })
  .catch(function() { _admSetStep(2); showToast('Network error. Try again.', 2500); });
}

function addDestToAdjustments(withTradeoff) {
  if (_admConfirmedName === undefined) withTradeoff = true; // legacy call
  if (!_admConfirmedName) return;
  if (!appState.aiSuggestions) appState.aiSuggestions = [];

  var fit      = (_admAnalysisText.match(/FIT:\s*(.+)/i)||[])[1] || '';
  var tradeoff = (_admAnalysisText.match(/TRADEOFF:\s*(.+)/i)||[])[1] || '';
  var acts     = (_admAnalysisText.match(/ACTIVITIES:\s*(.+)/i)||[])[1] || '';

  var detail = (_admConfirmedDesc ? _admConfirmedDesc + ' ' : '')
    + (fit        ? 'Best fit: ' + fit.trim() + ' ' : '')
    + (acts       ? 'Activities: ' + acts.trim() + ' ' : '')
    + (tradeoff   ? 'Suggested trade-off: ' + tradeoff.trim() : '');

  var sugg = {
    id:          'dest-' + Date.now(),
    sourceDay:   1,
    title:       '&#128205; New Destination: ' + _admConfirmedName,
    detail:      detail.trim(),
    impact:      '+' + _admDaysNeeded + ' day' + (_admDaysNeeded !== 1 ? 's' : '') + ' needed',
    affectedDays: [],
    status:      'pending',
    isNewDest:   true,
    daysNeeded:  _admDaysNeeded,
    destName:    _admConfirmedName,
    attraction:  _admConfirmedAttraction,
    acceptedTradeoff: !!withTradeoff
  };
  appState.aiSuggestions.unshift(sugg);

  /* When NOT accepting trade-off, also log an explicit Decisions item */
  if (!withTradeoff) {
    if (!appState.decisions) appState.decisions = [];
    appState.decisions.unshift({
      id:          'dest-over-' + Date.now(),
      title:       'ğŸ“ ' + _admConfirmedName + ' added â€” trip now ~' + _admDaysNeeded + ' day' + (_admDaysNeeded !== 1 ? 's' : '') + ' longer',
      detail:      'You added ' + _admConfirmedName + ' without accepting a trade-off. Decide what to shorten to keep the trip within schedule, or ask TripGenie for ideas.',
      impact:      '+' + _admDaysNeeded + ' day' + (_admDaysNeeded !== 1 ? 's' : '') + ' over schedule',
      affectedDays: [],
      status:      'pending',
      isDestOver:  true
    });
    updateDecisionsBadge();
  }

  saveState(appState);
  closeAddDest();
  if (withTradeoff) {
    switchTab('adjustments');
    renderAdjustments();
    updateAdjBadge();
    showToast('&#128205; ' + _admConfirmedName + ' added â€” now set your trade-off in Adjustments!', 3500);
  } else {
    renderDecisions();
    switchTab('decisions');
    showToast('&#128205; ' + _admConfirmedName + ' added â€” flagged in Decisions to resolve later.', 3500);
  }
}

/* â”€â”€ TRIP SELECTOR (header dropdown) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _updateTripSelector() {
  var label = document.getElementById('trip-selector-label');
  var list  = document.getElementById('trip-selector-list');
  if (!label || !list) return;

  var activeIsCustom = appState.activeTrip === 'custom';
  var customName     = (appState.customTripData && appState.customTripData.tripName) || 'Custom Trip';
  var builtinName    = (appState.tripSettings && appState.tripSettings.tripName) || _BUILTIN_TRIP.tripName || 'Maass Family RV 2026';

  label.textContent = activeIsCustom ? customName : builtinName;

  var itemStyle = 'padding:10px 14px;cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:100px;';
  var html = '<div onclick="_switchToBuiltinTrip();toggleTripSelectorMenu()" style="' + itemStyle + (!activeIsCustom ? 'background:var(--orange-l,#fff3e0);' : '') + '">'
    + '<span style="font-size:1.1rem;">ğŸš</span>'
    + '<div style="flex:1;">'
    + '<div style="font-size:.82rem;font-weight:800;color:var(--text);">' + builtinName + '</div>'
    + (!activeIsCustom ? '<div style="font-size:.7rem;color:var(--orange);font-weight:700;">â— Active</div>' : '')
    + '</div></div>';

  if (appState.customTripData) {
    html += '<div onclick="_switchToCustomTrip();toggleTripSelectorMenu()" style="' + itemStyle + (activeIsCustom ? 'background:var(--orange-l,#fff3e0);' : '') + '">'
      + '<span style="font-size:1.1rem;">ğŸ—ºï¸</span>'
      + '<div style="flex:1;">'
      + '<div style="font-size:.82rem;font-weight:800;color:var(--text);">' + customName + '</div>'
      + (activeIsCustom ? '<div style="font-size:.7rem;color:var(--orange);font-weight:700;">â— Active</div>' : '')
      + '</div></div>';
  }

  html += '<div style="border-top:1px solid var(--border);margin:4px 0;"></div>'
    + '<div onclick="openTripBuilder();toggleTripSelectorMenu()" style="' + itemStyle + '">'
    + '<i class="fa-solid fa-wand-magic-sparkles" style="font-size:1rem;color:var(--orange);flex-shrink:0;"></i>'
    + '<span style="font-size:.82rem;font-weight:700;color:var(--orange);white-space:nowrap;">Build New Trip with AI</span>'
    + '</div>';

  list.innerHTML = html;
}

function _truncate(str, n) { return str && str.length > n ? str.slice(0, n) + 'â€¦' : (str || ''); }

function toggleTripSelectorMenu() {
  var menu = document.getElementById('trip-selector-menu');
  if (!menu) return;
  _updateTripSelector();
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
  if (menu.style.display === 'block') {
    setTimeout(function() {
      document.addEventListener('click', _closeTripMenuOnOutsideClick, { once: true });
    }, 0);
  }
}

function _closeTripMenuOnOutsideClick(e) {
  var menu = document.getElementById('trip-selector-menu');
  var wrap = document.getElementById('trip-selector-wrap');
  if (menu && !menu.contains(e.target) && (!wrap || !wrap.contains(e.target))) closeTripSelectorMenu();
}

function closeTripSelectorMenu() {
  var menu = document.getElementById('trip-selector-menu');
  if (menu) menu.style.display = 'none';
}

function _switchToBuiltinTrip() {
  appState.activeTrip = 'builtin';
  saveState(appState);
  closeTripSelectorMenu();
  initApp();
  showToast('ğŸš Switched to Maass Family RV 2026', 2200);
}

function _switchToCustomTrip() {
  appState.activeTrip = 'custom';
  saveState(appState);
  closeTripSelectorMenu();
  initApp();
  var name = (appState.customTripData && appState.customTripData.tripName) || 'your custom trip';
  showToast('ğŸ—ºï¸ Switched to ' + name, 2200);
}

/* â”€â”€ TRIP BUILDER WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _tbStep = 1;
var _tbDesc = '';
var _tbGenerated = null;
var _tbStartDate = '';
var _tbEndDate = '';
var _tbStartCity = undefined; /* undefined = pre-populate from tripSettings on first open */
var _tbEndCity   = undefined;
var _tbAdults = '2';
var _tbKidAges = '';
var _tbPrefs = '';

function openTripBuilder() {
  closeTripSelectorMenu();
  _tbStep = 1; _tbDesc = ''; _tbGenerated = null;
  _tbStartDate = ''; _tbEndDate = ''; _tbAdults = '2'; _tbKidAges = ''; _tbPrefs = '';
  _renderTripBuilder();
}

function closeTripBuilder() {
  var el = document.getElementById('trip-builder-modal');
  if (el) el.remove();
}

function _renderTripBuilder() {
  var existing = document.getElementById('trip-builder-modal');
  if (existing) existing.remove();

  var wrap = document.createElement('div');
  wrap.id = 'trip-builder-modal';
  wrap.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:9600;display:flex;align-items:flex-start;justify-content:center;padding:16px;padding-top:env(safe-area-inset-top,16px);overflow-y:auto;';

  var inner = '';
  if (_tbStep === 1) inner = _tbStep1HTML();
  else if (_tbStep === 2) inner = _tbStep2HTML();
  else if (_tbStep === 3) inner = _tbStep3HTML();

  wrap.innerHTML = '<div onclick="event.stopPropagation()" style="background:#fff;border-radius:20px;max-width:620px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,.4);margin:auto;">'
    + inner + '</div>';

  wrap.addEventListener('click', function(e) { if (e.target === wrap) closeTripBuilder(); });
  document.body.appendChild(wrap);

  // Auto-focus textarea on step 1
  if (_tbStep === 1) {
    setTimeout(function() {
      var ta = document.getElementById('tb-desc');
      if (ta) ta.focus();
    }, 100);
  }
}

function _tbHeader(step, title, subtitle) {
  return '<div style="background:linear-gradient(135deg,#E8813A,#d4611e);color:#fff;padding:20px 22px;border-radius:20px 20px 0 0;">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">'
    + '<div style="font-size:.68rem;font-weight:800;opacity:.75;text-transform:uppercase;letter-spacing:.08em;">Step ' + step + ' of 3</div>'
    + '<button onclick="closeTripBuilder()" style="background:rgba(255,255,255,.2);border:none;color:#fff;border-radius:100px;padding:3px 10px;font-size:.9rem;cursor:pointer;">âœ•</button>'
    + '</div>'
    + '<div style="font-size:1.15rem;font-weight:900;margin-bottom:3px;">' + title + '</div>'
    + '<div style="font-size:.78rem;opacity:.85;">' + subtitle + '</div>'
    + '</div>';
}

function _tbStep1HTML() {
  var fldStyle = 'width:100%;border:2px solid #e0e0e0;border-radius:100px;padding:10px 12px;font-size:.87rem;font-family:inherit;outline:none;color:#333;box-sizing:border-box;background:#fff;';
  var lblStyle = 'font-size:.73rem;font-weight:700;color:#666;margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:.05em;';
  var prefs = ['ğŸ¥¾ Hiking','ğŸ–ï¸ Beaches','ğŸ•ï¸ Camping','ğŸ™ï¸ Cities','ğŸ¢ Theme Parks','ğŸ½ï¸ Foodie','ğŸ£ Fishing','ğŸ¨ Arts & Culture','ğŸ¾ Pet-friendly','ğŸšµ Mountain Biking','ğŸŒ¿ Nature','ğŸ›ï¸ History'];

  return _tbHeader(1, 'ğŸ—ºï¸ Plan Your Trip', 'Describe your dream trip â€” TripGenie builds the full itinerary, stops, and day-by-day schedule.')
    + '<div style="padding:20px 22px 22px;">'

    /* â•â• SECTION 1: Big voice/text input â•â• */
    + '<div style="margin-bottom:6px;">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">'
    + '<label style="font-size:1rem;font-weight:900;color:#333;">Tell us about your trip plan</label>'
    + '<button id="tb-mic-btn" onclick="_tbStartMic()" title="Tap to speak your trip idea" style="background:#E8813A;color:#fff;border:none;border-radius:50%;width:42px;height:42px;font-size:1.15rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 2px 8px rgba(232,129,58,.4);transition:all .2s;"><i class="fa-solid fa-microphone"></i></button>'
    + '</div>'
    + '<textarea id="tb-desc" placeholder="e.g. Family RV trip starting from ' + _tripStartCity() + ' in June, heading west through Yellowstone, Glacier, and the Pacific Northwest, then down the California coast to LA. 2 adults, 3 kids ages 4, 10, 14. About 6 weeks. We love hiking, national parks, and beaches. Max 5 hour drive days." style="width:100%;border:2.5px solid #e0e0e0;border-radius:10px;padding:14px 16px;font-size:.9rem;font-family:inherit;outline:none;color:#333;box-sizing:border-box;background:#fff;min-height:130px;resize:vertical;line-height:1.65;transition:border-color .15s;" oninput="this.style.borderColor=\'#E8813A\'">' + (_tbDesc||'') + '</textarea>'
    + '</div>'

    /* â•â• DIVIDER â•â• */
    + '<div style="display:flex;align-items:center;gap:12px;margin:20px 0 18px;">'
    + '<div style="flex:1;height:1.5px;background:#eee;"></div>'
    + '<span style="font-size:.72rem;font-weight:800;color:#bbb;letter-spacing:.1em;text-transform:uppercase;white-space:nowrap;">â€” or fill in manually â€”</span>'
    + '<div style="flex:1;height:1.5px;background:#eee;"></div>'
    + '</div>'

    /* â•â• SECTION 2: Manual fields â•â• */
    /* Cities â€” pre-populate from current first/last stop; user can override for the new trip */
    + (function(){
        var _scVal = (_tbStartCity !== undefined ? _tbStartCity : _tripStartCity());
        var _ecVal = (_tbEndCity   !== undefined ? _tbEndCity   : (_tripIsRoundTrip() ? '' : _tripEndCity()));
        return '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">'
          + '<div><label style="' + lblStyle + '">Starting City</label>'
          + '<input id="tb-start-city" type="text" value="' + (_scVal||'').replace(/"/g,'&quot;') + '" placeholder="e.g. Warwick, NY" style="' + fldStyle + '" oninput="this.style.borderColor=\'#E8813A\'"></div>'
          + '<div><label style="' + lblStyle + '">Ending City <span style="font-weight:400;text-transform:none;letter-spacing:0;">(blank = same)</span></label>'
          + '<input id="tb-end-city" type="text" value="' + (_ecVal||'').replace(/"/g,'&quot;') + '" placeholder="Leave blank for round trip" style="' + fldStyle + '" oninput="this.style.borderColor=\'#E8813A\'"></div>'
          + '</div>';
      }())
    /* Dates */
    + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;">'
    + '<div><label style="' + lblStyle + '">Start Date</label>'
    + '<input id="tb-start" type="date" value="' + (_tbStartDate||'') + '" style="' + fldStyle + '" oninput="this.style.borderColor=\'#E8813A\'"></div>'
    + '<div><label style="' + lblStyle + '">End Date</label>'
    + '<input id="tb-end" type="date" value="' + (_tbEndDate||'') + '" style="' + fldStyle + '" oninput="this.style.borderColor=\'#E8813A\'"></div>'
    + '</div>'
    /* Travelers */
    + '<div style="display:grid;grid-template-columns:1fr 2fr;gap:12px;margin-bottom:14px;">'
    + '<div><label style="' + lblStyle + '"># Adults</label>'
    + '<input id="tb-adults" type="number" min="1" max="10" value="' + (_tbAdults||'2') + '" style="' + fldStyle + '" oninput="this.style.borderColor=\'#E8813A\'"></div>'
    + '<div><label style="' + lblStyle + '">Kids\' Ages <span style="font-weight:400;text-transform:none;letter-spacing:0;">(e.g. 4, 10, 14)</span></label>'
    + '<input id="tb-kids" type="text" placeholder="blank if no kids" value="' + (_tbKidAges||'') + '" style="' + fldStyle + '" oninput="this.style.borderColor=\'#E8813A\'"></div>'
    + '</div>'
    /* Preference chips */
    + '<div style="margin-bottom:4px;">'
    + '<label style="' + lblStyle + '">Travel Style</label>'
    + '<div style="display:flex;flex-wrap:wrap;gap:7px;" id="tb-pref-chips">'
    + prefs.map(function(p) {
        var active = (_tbPrefs||'').indexOf(p) >= 0;
        return '<button type="button" onclick="_tbTogglePref(this,\'' + p.replace(/'/g,'\\\'') + '\')" style="padding:5px 11px;border-radius:100px;border:2px solid ' + (active?'#E8813A':'#ddd') + ';background:' + (active?'#FFF3EB':'#fafafa') + ';color:' + (active?'#E8813A':'#555') + ';font-size:.78rem;font-weight:700;cursor:pointer;font-family:inherit;transition:all .15s;" data-pref="' + p + '">' + p + '</button>';
      }).join('')
    + '</div>'
    + '</div>'

    /* â•â• FOOTER BUTTONS â•â• */
    + '<div style="display:flex;gap:10px;margin-top:22px;">'
    + '<button onclick="closeTripBuilder()" style="flex:1;padding:13px;background:#f5f5f5;border:none;border-radius:100px;font-size:.87rem;font-weight:700;cursor:pointer;color:#666;">Cancel</button>'
    + '<button onclick="_tbNextStep1()" style="flex:2;padding:13px;background:linear-gradient(135deg,#E8813A,#d4611e);color:#fff;border:none;border-radius:100px;font-size:.92rem;font-weight:900;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;"><i class="fa-solid fa-wand-magic-sparkles"></i> Plan My Trip</button>'
    + '</div></div>';
}

/* â”€â”€ Microphone transcription for Trip Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _tbMicRecognition = null;
function _tbStartMic() {
  var SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) {
    showToast('ğŸ™ï¸ Speech recognition not supported in this browser. Try Chrome!', 3000);
    return;
  }
  var btn = document.getElementById('tb-mic-btn');
  var ta  = document.getElementById('tb-desc');

  // If already recording, stop
  if (_tbMicRecognition) {
    _tbMicRecognition.stop();
    _tbMicRecognition = null;
    if (btn) { btn.style.background = '#E8813A'; btn.style.boxShadow = '0 2px 8px rgba(232,129,58,.4)'; btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; }
    return;
  }

  var rec = new SpeechRec();
  rec.continuous      = true;
  rec.interimResults  = true;
  rec.lang            = 'en-US';
  _tbMicRecognition   = rec;

  // Capture whatever was already typed so we can append
  var existingText = (ta ? ta.value.trim() : '');

  rec.onstart = function() {
    if (btn) {
      btn.style.background  = '#d32f2f';
      btn.style.boxShadow   = '0 0 0 4px rgba(211,47,47,.25)';
      btn.style.animation   = 'pulse-border .9s infinite';
      btn.innerHTML = '<i class="fa-solid fa-stop"></i>';
      btn.title = 'Tap to stop';
    }
    showToast('ğŸ™ï¸ Listeningâ€¦ speak your trip plan!', 2000);
  };

  rec.onresult = function(e) {
    var interim = '';
    var final   = existingText;
    for (var i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) {
        final += (final ? ' ' : '') + e.results[i][0].transcript;
      } else {
        interim += e.results[i][0].transcript;
      }
    }
    if (ta) {
      ta.value = final + (interim ? ' ' + interim : '');
      ta.style.borderColor = '#E8813A';
    }
    existingText = final; // update running final
  };

  rec.onerror = function(e) {
    showToast('ğŸ™ï¸ Mic error: ' + (e.error || 'unknown'), 2500);
    _tbMicRecognition = null;
    if (btn) { btn.style.background = '#E8813A'; btn.style.boxShadow = '0 2px 8px rgba(232,129,58,.4)'; btn.style.animation = ''; btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.title = 'Tap to speak'; }
  };

  rec.onend = function() {
    _tbMicRecognition = null;
    if (btn) { btn.style.background = '#E8813A'; btn.style.boxShadow = '0 2px 8px rgba(232,129,58,.4)'; btn.style.animation = ''; btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.title = 'Tap to speak'; }
  };

  rec.start();
}

function _tbTogglePref(btn, pref) {
  var prefs = (_tbPrefs || '').split(',').map(function(s){return s.trim();}).filter(Boolean);
  var idx = prefs.indexOf(pref);
  if (idx >= 0) { prefs.splice(idx, 1); }
  else { prefs.push(pref); }
  _tbPrefs = prefs.join(', ');
  var active = idx < 0; // now active if we just added it
  btn.style.borderColor = active ? '#E8813A' : '#ddd';
  btn.style.background  = active ? '#FFF3EB' : '#fafafa';
  btn.style.color       = active ? '#E8813A' : '#555';
}

function _tbNextStep1() {
  // Stop mic if still recording
  if (_tbMicRecognition) { _tbMicRecognition.stop(); _tbMicRecognition = null; }

  var ta = document.getElementById('tb-desc');
  var desc = ta ? ta.value.trim() : '';

  _tbStartDate = (document.getElementById('tb-start')      || {}).value || '';
  _tbEndDate   = (document.getElementById('tb-end')        || {}).value || '';
  _tbStartCity = (document.getElementById('tb-start-city') || {}).value.trim() || _tripStartCity();
  _tbEndCity   = (document.getElementById('tb-end-city')   || {}).value.trim() || _tbStartCity;
  _tbAdults    = (document.getElementById('tb-adults')     || {}).value || '2';
  _tbKidAges   = (document.getElementById('tb-kids')       || {}).value || '';

  // Require at least a description OR at least start+end dates
  var hasManual = _tbStartDate && _tbEndDate;
  if (desc.length < 10 && !hasManual) {
    if (ta) ta.style.borderColor = '#d32f2f';
    showToast('Tell us about your trip â€” or fill in the dates above!', 2500);
    return;
  }
  _tbDesc = desc;

  // Build a rich prompt combining structured fields + freeform
  var parts = [];
  parts.push('Departure city: ' + _tbStartCity);
  parts.push('Arrival city: ' + (_tbEndCity === _tbStartCity ? _tbStartCity + ' (round trip)' : _tbEndCity));
  if (_tbStartDate) parts.push('Start date: ' + _tbStartDate);
  if (_tbEndDate)   parts.push('End date: ' + _tbEndDate);
  if (!_tbStartDate && !_tbEndDate) parts.push('Choose appropriate dates based on the description');
  var travelers = _tbAdults + ' adult' + (_tbAdults !== '1' ? 's' : '');
  if (_tbKidAges.trim()) travelers += ', kids ages: ' + _tbKidAges.trim();
  parts.push('Travelers: ' + travelers);
  if (_tbPrefs) parts.push('Travel preferences: ' + _tbPrefs);
  parts.push('Trip description: ' + _tbDesc);

  var fullPrompt = parts.join('\n');
  _tbStep = 2;
  _renderTripBuilder();
  _buildTripWithAI(fullPrompt);
}

function _tbStep2HTML() {
  return _tbHeader(2, 'âœ¨ TripGenie is Building Your Trip', 'Generating your personalized itineraryâ€¦')
    + '<div style="padding:40px 22px;text-align:center;">'
    + '<div style="font-size:3rem;margin-bottom:16px;animation:spin 2s linear infinite;">ğŸŒ</div>'
    + '<div style="font-size:1rem;font-weight:800;color:#333;margin-bottom:8px;">Crafting your adventureâ€¦</div>'
    + '<div style="font-size:.83rem;color:#777;line-height:1.6;max-width:320px;margin:0 auto;">TripGenie is mapping out your stops, calculating drive times, and building a day-by-day plan tailored to your family.</div>'
    + '<div id="tb-progress" style="margin-top:20px;font-size:.77rem;color:#E8813A;font-weight:700;min-height:20px;"></div>'
    + '</div>'
    + '<style>@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }</style>';
}

function _tbStep3HTML() {
  if (!_tbGenerated) {
    return '<div style="padding:30px;text-align:center;color:#d32f2f;font-size:.9rem;">Generation failed. <button onclick="_tbStep=1;_renderTripBuilder()">Try again</button></div>';
  }
  var d = _tbGenerated;
  var stopsHtml = '';
  (d.stops || []).forEach(function(s, i) {
    var nights = 0;
    (d.days || []).forEach(function(dy) { if (dy.stopId === s.id) nights++; });
    stopsHtml += '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;' + (i > 0 ? 'border-top:1px solid #f0f0f0;' : '') + '">'
      + '<span style="font-size:1.4rem;">' + (s.emoji || 'ğŸ“') + '</span>'
      + '<div style="flex:1;">'
      + '<div style="font-weight:700;font-size:.87rem;">' + s.name + ', ' + s.state + '</div>'
      + '<div style="font-size:.75rem;color:#888;">' + nights + ' night' + (nights !== 1 ? 's' : '') + '</div>'
      + '</div></div>';
  });

  return _tbHeader(3, 'ğŸ‰ Your Trip is Ready!', (d.tripName || 'Custom Trip') + ' Â· ' + (d.stops||[]).length + ' stops Â· ' + (d.days||[]).length + ' days')
    + '<div style="padding:22px;">'
    + '<div style="background:#f9f9f9;border-radius:12px;padding:14px 16px;margin-bottom:16px;">'
    + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;text-align:center;margin-bottom:14px;">'
    + '<div><div style="font-size:1.3rem;font-weight:900;color:#E8813A;">' + (d.days||[]).length + '</div><div style="font-size:.7rem;color:#888;font-weight:700;">DAYS</div></div>'
    + '<div><div style="font-size:1.3rem;font-weight:900;color:#E8813A;">' + (d.stops||[]).length + '</div><div style="font-size:.7rem;color:#888;font-weight:700;">STOPS</div></div>'
    + '<div><div style="font-size:1.3rem;font-weight:900;color:#E8813A;">' + Math.round((d.totalMiles||0)/100)*100 + '</div><div style="font-size:.7rem;color:#888;font-weight:700;">EST. MILES</div></div>'
    + '</div>'
    + '<div style="max-height:200px;overflow-y:auto;">' + stopsHtml + '</div>'
    + '</div>'
    + '<div id="tb-err" style="color:#d32f2f;font-size:.78rem;min-height:16px;margin-bottom:8px;"></div>'
    + '<div style="display:flex;gap:10px;">'
    + '<button onclick="_tbStep=1;_tbGenerated=null;_renderTripBuilder()" style="flex:1;padding:12px;background:#f5f5f5;border:none;border-radius:100px;font-size:.84rem;font-weight:700;cursor:pointer;color:#555;">â†º Start Over</button>'
    + '<button onclick="_tbConfirmTrip()" style="flex:2;padding:12px;background:linear-gradient(135deg,#3A8A5C,#2d6e48);color:#fff;border:none;border-radius:100px;font-size:.9rem;font-weight:900;cursor:pointer;">âœ… Use This Trip!</button>'
    + '</div></div>';
}

function _tbConfirmTrip() {
  if (!_tbGenerated) return;
  appState.customTripData = _tbGenerated;
  appState.activeTrip = 'custom';
  // Clear old trip state that doesn't apply to the new trip
  appState.weather = {};
  appState.plannedEvents = {};
  appState.planned = {};
  appState.tripStarted = false;
  saveState(appState);
  closeTripBuilder();
  initApp();
  showToast('ğŸ—ºï¸ ' + (_tbGenerated.tripName || 'New trip') + ' is loaded â€” let\'s go!', 3500);
}

function _buildTripWithAI(description) {
  var progressEl = document.getElementById('tb-progress');
  if (progressEl) progressEl.textContent = 'Analyzing your trip descriptionâ€¦';

  var today = new Date().toISOString().slice(0, 10);
  var prompt = 'You are a road trip planning API. Build a complete RV trip itinerary from this description:\n\n'
    + '"' + description + '"\n\n'
    + 'Today\'s date: ' + today + '. '
    + 'Return ONLY a single valid JSON object with no markdown, no code fences, no explanation â€” just raw JSON.\n\n'
    + 'JSON SCHEMA:\n'
    + '{\n'
    + '  "tripName": "string",\n'
    + '  "startDate": "YYYY-MM-DD",\n'
    + '  "endDate": "YYYY-MM-DD",\n'
    + '  "totalMiles": number,\n'
    + '  "stops": [\n'
    + '    { "id": 1, "name": "string", "state": "XX", "emoji": "emoji", "description": "2-3 sentences about this destination", "highlights": ["string","string","string"], "lat": number, "lng": number, "weatherLat": number, "weatherLng": number, "activities": [], "restaurants": [], "sleepOptions": ["option1","option2"] }\n'
    + '  ],\n'
    + '  "days": [\n'
    + '    { "day": 1, "date": "YYYY-MM-DD", "stopId": 1, "driveDay": true, "miles": number, "driveHours": number, "driver": "Driver 1", "sleep": "Campground name", "sleepType": "rv_park", "phase": "Stop Name", "title": "Origin â†’ Destination, STATE" }\n'
    + '  ]\n'
    + '}\n\n'
    + 'Rules:\n'
    + '- sleepType must be one of: rv_park, walmart, home, hotel\n'
    + '- days array must have one entry per calendar day (including non-drive explore days where driveDay=false, miles=0, driveHours=0)\n'
    + '- stopId must match an id in the stops array\n'
    + '- First day is the departure day from home (driveDay=true)\n'
    + '- Last day is the return home day (driveDay=true, stopId of the last stop before home)\n'
    + '- Assign realistic coordinates (lat/lng) for each stop\n'
    + '- Keep drive days under the user\'s stated max (default 6h if not specified)\n'
    + '- Return ONLY the JSON. No other text.';

  fetch(GEMINI_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      contents: [{ parts: [{ text: prompt }] }],
      generationConfig: { maxOutputTokens: 4000, temperature: 0.3 }
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    if (progressEl) progressEl.textContent = 'Parsing your itineraryâ€¦';
    var raw = '';
    try { raw = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}

    // Strip any markdown code fences if present
    raw = raw.replace(/^```json?\s*/i, '').replace(/\s*```\s*$/i, '').trim();

    var parsed = null;
    try { parsed = JSON.parse(raw); } catch(e) {
      // Try to extract JSON from within the response
      var m = raw.match(/\{[\s\S]+\}/);
      if (m) { try { parsed = JSON.parse(m[0]); } catch(e2) {} }
    }

    if (!parsed || !parsed.stops || !parsed.days) {
      _tbGenerationFailed('Could not parse the trip plan. Please try again or rephrase your description.');
      return;
    }

    _tbGenerated = parsed;
    _tbStep = 3;
    _renderTripBuilder();
  })
  .catch(function() {
    _tbGenerationFailed('Network error â€” please check your connection and try again.');
  });
}

function _tbGenerationFailed(msg) {
  _tbStep = 1;
  _renderTripBuilder();
  showToast('âš ï¸ ' + msg, 3500);
}

function initApp() {
  // Apply dark mode preference immediately
  _initDarkMode();

  // â”€â”€ Load custom trip data if one has been built â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (appState.activeTrip === 'custom' && appState.customTripData) {
    var ct = appState.customTripData;
    var ctDays  = ct.days   || _BUILTIN_TRIP.days;
    var ctStops = ct.stops  || _BUILTIN_TRIP.stops;

    /* Sanity-check: first day must reference a valid stopId, day count must be reasonable,
       and the first day's stop must be in the first half of the stops list (not the last stop
       placed first by a bad Gemini reorder). If any check fails, silently fall back to builtin. */
    var firstStopId = ctDays.length > 0 ? ctDays[0].stopId : null;
    var firstStopValid = ctStops.some(function(s) { return s.id === firstStopId; });
    var dayCountOk = ctDays.length >= 20 && ctDays.length <= 90;
    var firstStopPos = ctStops.findIndex(function(s) { return s.id === firstStopId; });
    var firstStopInWrongPlace = firstStopPos > Math.floor(ctStops.length * 0.5);
    if (!firstStopValid || !dayCountOk || firstStopInWrongPlace) {
      appState.activeTrip = 'builtin';
      saveState(appState);
      TRIP_STOPS = _BUILTIN_TRIP.stops;
      TRIP_DAYS  = _BUILTIN_TRIP.days;
      CONFIG.startDate  = _BUILTIN_TRIP.startDate;
      CONFIG.endDate    = _BUILTIN_TRIP.endDate;
      CONFIG.totalDays  = _BUILTIN_TRIP.totalDays;
      CONFIG.totalMiles = _BUILTIN_TRIP.totalMiles;
    } else {
      TRIP_STOPS = ctStops;
      TRIP_DAYS  = ctDays;
      if (ct.startDate) CONFIG.startDate = ct.startDate;
      if (ct.endDate)   CONFIG.endDate   = ct.endDate;
      if (ct.totalDays) CONFIG.totalDays = ct.totalDays;
      if (ct.totalMiles) CONFIG.totalMiles = ct.totalMiles;
    }
  } else {
    // Restore builtin data in case we switched back from a custom trip
    TRIP_STOPS = _BUILTIN_TRIP.stops;
    TRIP_DAYS  = _BUILTIN_TRIP.days;
    CONFIG.startDate  = _BUILTIN_TRIP.startDate;
    CONFIG.endDate    = _BUILTIN_TRIP.endDate;
    CONFIG.totalDays  = _BUILTIN_TRIP.totalDays;
    CONFIG.totalMiles = _BUILTIN_TRIP.totalMiles;
    // Apply any manual trip settings overrides on top
    if (appState.tripSettings) {
      var ts = appState.tripSettings;
      if (ts.startDate) CONFIG.startDate = ts.startDate;
      if (ts.endDate)   CONFIG.endDate   = ts.endDate;
      if (ts.totalDays) CONFIG.totalDays = ts.totalDays;
      // Re-date TRIP_DAYS so dates match the saved start date across reloads
      if (ts.startDate) {
        var _tsMs = new Date(ts.startDate + 'T00:00:00').getTime();
        TRIP_DAYS.forEach(function(d, i) {
          var _tsD = new Date(_tsMs + i * 86400000);
          d.date = _tsD.getFullYear() + '-'
            + String(_tsD.getMonth() + 1).padStart(2, '0') + '-'
            + String(_tsD.getDate()).padStart(2, '0');
        });
      }
    }
  }
  _updateLoginDisplay();

  // Update trip selector in header
  _updateTripSelector();

  // Update header stats
  document.getElementById('hdr-day').textContent = tripIsLive() ? tripDay() : 'â€”';
  const p = pct();
  document.getElementById('hdr-progress-bar').style.width = p + '%';
  document.getElementById('hdr-progress-pct').textContent = p + '%';
  updateHeaderMiles();
  // Update sidebar day counter
  var _sdc = document.getElementById('sidebar-day-counter');
  if (_sdc) _sdc.textContent = 'Day ' + (tripIsLive() ? tripDay() : 'â€”') + ' of ' + TRIP_DAYS.length + ' Â· ' + p + '% complete';

  // Render all tabs
  renderDashboard();
  renderSchedule();
  renderSchool();
  renderStops();
  renderJournal();
  renderSuggestions();
  renderAdjustments();
  renderDecisions();
  updateAdjBadge();
  updateDecisionsBadge();
  renderLists();
  renderPostcards();
  renderFun();
  renderGalleryTab();
  renderTools();
  /* Refresh route map markers if the map has already been initialised */
  if (typeof refreshMainMap === 'function') refreshMainMap();

  // Announce
  const today = new Date();
  const start = new Date(CONFIG.startDate);
  const end   = new Date(CONFIG.endDate);
  if (today < start) {
    const days = Math.ceil((start - today) / 86400000);
    showToast('ğŸ—“ï¸ Trip starts in ' + days + ' days â€” get excited!', 4000);
  } else if (today > end) {
    showToast('ğŸ  Welcome home! What an adventure.', 3500);
  } else {
    showToast('ğŸš Day ' + tripDay() + ' of 46 â€” let\'s go!', 3000);
  }

  // Show orange dot on What's New nav tab
  var _toolsDot = document.getElementById('whatsnew-dot');
  if (_toolsDot) _toolsDot.style.display = 'block';

  // Nav hover tooltips
  _initNavTooltips();

  // Launch tutorial for first-time users (post-login, after everything renders)
  _maybeLaunchTutorial();
}

/* â”€â”€ CHANGE THE PLAN MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// â”€â”€ Mode Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function _showSimpleMode() {
  document.getElementById('sm').classList.add('sm-active');
  window._smActivate && window._smActivate();
}
function _hideSimpleMode() {
  document.getElementById('sm').classList.remove('sm-active');
}

function openChangePlanModal() {
  var ov = document.getElementById('change-plan-overlay');
  if (!ov) return;
  ov.style.display = 'flex';
  // Clear previous results and textarea
  var ta = document.getElementById('adj-voice-ta');
  var res = document.getElementById('adj-voice-results');
  var replyBar = document.getElementById('adj-reply-bar');
  var replyInput = document.getElementById('adj-reply-input');
  if (ta)  ta.value = '';
  if (res) res.innerHTML = '';
  if (replyBar) replyBar.style.display = 'none';
  if (replyInput) replyInput.value = '';
  // Reset button label in case it was mid-request
  var btn = document.getElementById('adj-voice-btn');
  if (btn) { btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Get Suggestions'; btn.disabled = false; }
  setTimeout(function() { if (ta) ta.focus(); }, 80);
}
function closeChangePlanModal() {
  var ov = document.getElementById('change-plan-overlay');
  if (ov) ov.style.display = 'none';
  if (_adjMicRecognition) { _adjMicRecognition.stop(); _adjMicRecognition = null; }
}

/* â”€â”€ HELP SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var HELP_ITEMS = [
  {q:'How do I plan a trip?',           a:'Tap "Plan a New Trip" in the top bar â€” TripGenie will help you build a full itinerary with AI.',                        tab:'dashboard',  icon:'fa-map'},
  {q:'Where is the map?',               a:'Tap the Map tab in the left nav bar.',                                                                                    tab:'map',        icon:'fa-map-location-dot'},
  {q:'How do I see the schedule?',      a:'Open the Schedule tab to see all 46 days with drive times, activities, and phases.',                                       tab:'schedule',   icon:'fa-calendar-days'},
  {q:'How do I add a journal entry?',   a:'Go to the Journal tab and tap the "New Entry" button. You can add photos, notes, and tag a location.',                    tab:'journal',    icon:'fa-book'},
  {q:'Where are my photos?',            a:'Open the Gallery tab to see all photos from your journal entries, grouped by location.',                                   tab:'gallery',    icon:'fa-images'},
  {q:'How do I make a postcard?',       a:'Go to the Postcards tab, pick a photo, choose a recipient, and TripGenie will write the message for you.',                 tab:'postcards',  icon:'fa-envelope'},
  {q:'Where is the packing list?',      a:'Open the Lists tab â€” it has a Packing checklist and a Todo list you can customize.',                                       tab:'lists',      icon:'fa-list-check'},
  {q:'How do I change the plan?',       a:'Tap "Change the plan" in the top bar (the â†» button) and tell TripGenie what you want to adjust.',                         tab:'adjustments',icon:'fa-arrows-spin'},
  {q:'How do I ask TripGenie?',         a:'Tap "âœ¨ Ask TripGenie" in the top bar to open the AI chat. You can ask anything about stops, driving, activities, etc.',  tab:'dashboard',  icon:'fa-sparkles'},
  {q:'Where is the weather?',           a:'The weather shows on the Today tile. Tap it for a full forecast. Each stop also has its own weather in the Stops tab.',    tab:'dashboard',  icon:'fa-cloud-sun'},
  {q:'How do I track expenses?',        a:'Go to Tools â†’ Expenses to log trip costs by category and see your running totals.',                                        tab:'tools',      icon:'fa-receipt'},
  {q:'How do I log RV maintenance?',    a:'Go to Tools â†’ RV Log to record oil changes, tire checks, and other maintenance events.',                                   tab:'tools',      icon:'fa-screwdriver-wrench'},
  {q:'Where are the games?',            a:'Open the Fun tab and select Games. There are 12 road trip games including License Plate Bingo and AI Quest.',              tab:'fun',        icon:'fa-gamepad'},
  {q:'How do I track states visited?',  a:'Open Fun â†’ States to see the interactive 50-state map. Tap any state to mark it as visited.',                             tab:'fun',        icon:'fa-flag-usa'},
  {q:'How do I add a stop?',            a:'Open the Stops tab and tap "Add Destination" â€” or use TripGenie to suggest additions based on your route.',               tab:'stops',      icon:'fa-location-dot'},
  {q:'What is the audit log?',          a:'Go to Tools â†’ Audit Log to see a timestamp history of every change made to your trip plan.',                               tab:'tools',      icon:'fa-clock-rotate-left'},
  {q:'How do I duplicate a trip?',      a:'Open the trip selector dropdown in the top bar, then tap "New Trip" to create a copy or start fresh.',                     tab:'dashboard',  icon:'fa-copy'},
  {q:'How do I switch to driving mode?', a:'Tap the "Driving" button in the top right of the header to switch to the simplified one-page-at-a-time view.',                tab:'dashboard',  icon:'fa-mobile-screen-button'},
  {q:'Where are family profiles?',      a:'Go to Tools â†’ Profiles to view and edit each family member\'s profile including interests and age.',                       tab:'tools',      icon:'fa-people-group'},
  {q:'How do I see upcoming days?',     a:'The Dashboard shows the next 3 days. For the full view, open the Schedule tab.',                                           tab:'schedule',   icon:'fa-forward'},
  {q:'What is the school tab?',         a:'The School tab has a homeschool curriculum tied to each stop â€” field trips, geography, history, and science lessons.',     tab:'school',     icon:'fa-graduation-cap'},
  {q:'How do I refresh weather?',       a:'Weather updates automatically. You can also tap any weather tile to open the forecast modal and pull fresh data.',         tab:'dashboard',  icon:'fa-rotate'},
  {q:'What are decisions?',             a:'The Decisions tab shows things that need your attention â€” long drives, schedule conflicts, or TripGenie suggestions.',      tab:'decisions',  icon:'fa-triangle-exclamation'},
  {q:'How do I log in?',                a:'At the login screen, pick your family member avatar and enter the trip password. Ask Paul or Melissa if you don\'t have it.', tab:'dashboard',icon:'fa-lock'},
];

function openHelpSearch() {
  var ov = document.getElementById('help-search-overlay');
  if (!ov) return;
  ov.style.display = 'flex';
  renderHelpResults('');
  setTimeout(function() {
    var inp = document.getElementById('help-search-input');
    if (inp) { inp.value = ''; inp.focus(); }
  }, 80);
}
function closeHelpSearch() {
  var ov = document.getElementById('help-search-overlay');
  if (ov) ov.style.display = 'none';
}
function renderHelpResults(q) {
  var el = document.getElementById('help-results');
  if (!el) return;
  var terms = (q || '').toLowerCase().trim().split(/\s+/).filter(Boolean);
  var scored = HELP_ITEMS.map(function(item) {
    if (!terms.length) return { item: item, score: 1 };
    var hay = (item.q + ' ' + item.a).toLowerCase();
    var score = terms.reduce(function(s, t) { return s + (hay.indexOf(t) >= 0 ? 1 : 0); }, 0);
    return { item: item, score: score };
  }).filter(function(x) { return x.score > 0; })
    .sort(function(a, b) { return b.score - a.score; })
    .slice(0, 8);

  if (!scored.length) {
    el.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-3);font-size:.85rem;">No results for "<strong>' + q + '</strong>" â€” try a different word.</div>';
    return;
  }
  el.innerHTML = scored.map(function(x) {
    var it = x.item;
    return '<div onclick="switchTab(\'' + it.tab + '\');closeHelpSearch();" '
      + 'style="display:flex;gap:12px;align-items:flex-start;padding:11px 10px;border-radius:100px;cursor:pointer;transition:background .12s;" '
      + 'onmouseover="this.style.background=\'var(--bg)\'" onmouseout="this.style.background=\'\'">'
      + '<div style="width:32px;height:32px;border-radius:10px;background:var(--blue-l);color:var(--blue);display:flex;align-items:center;justify-content:center;flex-shrink:0;">'
      + '<i class="fa-solid ' + it.icon + '" style="font-size:.8rem;"></i></div>'
      + '<div style="flex:1;min-width:0;">'
      + '<div style="font-weight:800;font-size:.83rem;color:var(--text);margin-bottom:2px;">' + it.q + '</div>'
      + '<div style="font-size:.76rem;color:var(--text-2);line-height:1.4;">' + it.a + '</div>'
      + '</div>'
      + '<div style="font-size:.65rem;color:var(--text-3);white-space:nowrap;padding-top:2px;">' + it.tab + ' â†’</div>'
      + '</div>';
  }).join('');
}

/* â”€â”€ NAV HOVER TOOLTIPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _initNavTooltips() {
  var tip = document.createElement('div');
  tip.id = 'nav-tooltip';
  tip.style.cssText = 'position:fixed;background:rgba(22,22,32,.92);color:#fff;font-size:.72rem;font-weight:700;padding:5px 11px;border-radius:100px;pointer-events:none;z-index:9999;display:none;white-space:nowrap;letter-spacing:.02em;box-shadow:0 3px 12px rgba(0,0,0,.3);transition:opacity .1s;';
  document.body.appendChild(tip);
  document.querySelectorAll('.nav-tab[data-tooltip]').forEach(function(btn) {
    btn.addEventListener('mouseenter', function() {
      tip.textContent = btn.dataset.tooltip;
      tip.style.display = 'block';
      var rect = btn.getBoundingClientRect();
      var tw   = tip.getBoundingClientRect().width;
      var th   = tip.getBoundingClientRect().height;
      var isSidebar = window.innerWidth >= 1025;
      if (isSidebar) {
        /* Sidebar: tooltip appears to the RIGHT of the nav item */
        tip.style.left = (rect.right + 10) + 'px';
        tip.style.top  = Math.round(rect.top + rect.height / 2 - th / 2) + 'px';
      } else {
        /* Mobile bottom nav: tooltip appears ABOVE the item */
        var left = rect.left + rect.width / 2 - tw / 2;
        left = Math.max(6, Math.min(window.innerWidth - tw - 6, left));
        tip.style.top  = (rect.top - th - 8) + 'px';
        tip.style.left = left + 'px';
      }
    });
    btn.addEventListener('mouseleave', function() { tip.style.display = 'none'; });
    btn.addEventListener('click',      function() { tip.style.display = 'none'; });
  });
}

// Wire map tab to lazy-init the map on first open
document.querySelector('[data-tab="map"]').addEventListener('click', function() {
  setTimeout(initMainMap, 100);
});

/* â”€â”€ NOTE: localStorage is still used for trip edits (sleep/driver)  â”€â”€ */
/* â”€â”€ If storage is unavailable, edits simply won't persist on reload â”€â”€ */

/* â”€â”€ GEMINI CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* Gemini API is proxied through /.netlify/functions/gemini so the key
   never appears in the browser or the public repo.
   Set GEMINI_KEY in Netlify â†’ Site Settings â†’ Environment Variables. */
var GEMINI_KEY = '';  // unused â€” key lives on the server
var GEMINI_URL = '/.netlify/functions/gemini';

/* â”€â”€ MEAL SUITABILITY HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function mealScore(rest, meal) {
  var type  = (rest.type  || '').toLowerCase();
  var hours = (rest.hours || '').toLowerCase();
  var score = 0;
  /* detect close time: e.g. "7amâ€“3pm" â†’ closesEarly */
  var closesEarlyMatch = hours.match(/[â€“\-]\s*(\d+)(am|pm)/);
  var closesEarly = false;
  if (closesEarlyMatch) {
    var closeH = parseInt(closesEarlyMatch[1]);
    var closePm = closesEarlyMatch[2] === 'pm';
    var close24 = closePm ? (closeH < 12 ? closeH + 12 : closeH) : closeH;
    closesEarly = close24 <= 15; /* closes by 3pm */
  }
  /* detect opening time */
  var opensEarlyMatch = hours.match(/^(\d+)(am|pm)/);
  var opensEarly = opensEarlyMatch && opensEarlyMatch[2] === 'am' && parseInt(opensEarlyMatch[1]) <= 8;
  /* detect dinner hours: open into 8pm+ */
  var hasDinnerHours = /[â€“\-]\s*(8|9|10|11|12)\s*pm/.test(hours) || hours === '';

  if (meal === 'breakfast') {
    if (/breakfast|cafÃ©|cafe|bakery|coffee|pastry|pancake|brunch/.test(type)) score += 5;
    if (opensEarly) score += 3;
    if (closesEarly) score += 1; /* breakfast-only hours are fine */
    if (!hasDinnerHours && !closesEarly) score -= 2; /* dinner place, less ideal */
    if (/steakhouse|fine dining|bbq/.test(type)) score -= 4;
  } else if (meal === 'lunch') {
    if (/cafÃ©|cafe|deli|sandwich|casual|market|pub/.test(type)) score += 2;
    if (closesEarly) score += 2; /* closes at 3pm = lunch-friendly */
    /* penalise dinner-only places */
    var opensLateMatch = hours.match(/^(\d+):?\s*(pm)/);
    if (opensLateMatch) { var h = parseInt(opensLateMatch[1]); if (h >= 4) score -= 5; }
    if (/steakhouse|fine dining/.test(type)) score -= 1;
  } else { /* dinner */
    if (closesEarly) score -= 12; /* hard veto for early-closing places */
    if (/steakhouse|fine dining|grill|bbq|brew|italian|mexican/.test(type)) score += 3;
    if (hasDinnerHours) score += 2;
    if (opensEarly && !hasDinnerHours) score -= 3; /* breakfast-only */
    if (/cafÃ©|cafe|bakery|coffee/.test(type) && closesEarly) score -= 8;
  }
  return score;
}

function pickMealRest(rests, meal, usedIdxs, skipIdxs) {
  var skipArr = skipIdxs || [];
  /* first try: exclude used meals AND skipped */
  var candidates = rests.filter(function(r) {
    return usedIdxs.indexOf(r.idx) === -1 && skipArr.indexOf(r.idx) === -1;
  });
  /* second try: skip list exhausted â€” allow skipped but still no duplicates */
  if (!candidates.length) {
    candidates = rests.filter(function(r) { return usedIdxs.indexOf(r.idx) === -1; });
  }
  /* last resort: allow any */
  if (!candidates.length) candidates = rests.slice();
  candidates.sort(function(a, b) { return mealScore(b.item, meal) - mealScore(a.item, meal); });
  return candidates[0] || null;
}

/* â”€â”€ LOCAL MUSIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _musicCache = {}; // keyed by stopId

function openLocalMusic() {
  var d    = _ddmDayNum ? TRIP_DAYS[_ddmDayNum - 1] : null;
  var stop = d ? getStop(d.stopId) : null;
  if (!stop) { showToast('No location info for this day', 2000); return; }

  var modal = document.getElementById('music-modal');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';

  document.getElementById('music-location-title').textContent = _sn(stop);
  document.getElementById('music-scene-desc').textContent = '';
  document.getElementById('music-genres-row').style.display = 'none';

  if (_musicCache[stop.id]) {
    _renderMusicResults(_musicCache[stop.id]);
    return;
  }

  document.getElementById('music-body').innerHTML =
    '<div style="text-align:center;padding:40px 20px;color:var(--text-3);">'
    + '<div style="font-size:2rem;margin-bottom:10px;animation:spin 1.5s linear infinite;display:inline-block;">ğŸµ</div>'
    + '<div style="font-weight:600;">Finding local sounds for ' + stop.name + 'â€¦</div>'
    + '<div style="font-size:.78rem;margin-top:6px;">Asking TripGenie about the music scene</div>'
    + '</div>';

  _fetchLocalMusic(stop);
}

function closeLocalMusic() {
  var modal = document.getElementById('music-modal');
  if (modal) modal.classList.add('hidden');
  document.body.style.overflow = '';
}

function _fetchLocalMusic(stop) {
  var prompt = 'You are a music curator for a family road trip. The family is visiting ' + _sn(stop) + '.\n\n'
    + 'Suggest 5 artists or bands that are FROM this region or strongly associated with this area\'s music culture.\n'
    + 'Be accurate â€” only suggest real artists genuinely connected to this place.\n'
    + 'Include a mix: maybe one famous artist, a few well-known regional ones, and one hidden gem.\n\n'
    + 'Respond ONLY with this exact JSON (no markdown, no explanation):\n'
    + '{\n'
    + '  "scene": "One vivid sentence describing this area\'s music identity",\n'
    + '  "artists": [\n'
    + '    { "name": "Artist Name", "genre": "Genre", "why": "One line about their connection to this place", "searchQuery": "Spotify search term for this artist" },\n'
    + '    { "name": "Artist Name", "genre": "Genre", "why": "One line about their connection to this place", "searchQuery": "Spotify search term" },\n'
    + '    { "name": "Artist Name", "genre": "Genre", "why": "One line about their connection to this place", "searchQuery": "Spotify search term" },\n'
    + '    { "name": "Artist Name", "genre": "Genre", "why": "One line about their connection to this place", "searchQuery": "Spotify search term" },\n'
    + '    { "name": "Artist Name", "genre": "Genre", "why": "One line about their connection to this place", "searchQuery": "Spotify search term" }\n'
    + '  ],\n'
    + '  "genres": ["primary genre", "secondary genre", "regional style"],\n'
    + '  "playlistSearch": "Best Spotify search term for a ' + stop.name + ' music playlist"\n'
    + '}';

  var body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 700, temperature: 0.6 }
  });

  fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    // Strip markdown code fences if present
    text = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
    var result;
    try { result = JSON.parse(text); } catch(e) {
      document.getElementById('music-body').innerHTML =
        '<div style="padding:20px;color:var(--text-2);font-size:.85rem;text-align:center;">'
        + 'ğŸµ Couldn\'t load music suggestions right now. Try again or search Spotify directly for "'
        + stop.name + ' music".</div>';
      return;
    }
    _musicCache[stop.id] = result;
    _renderMusicResults(result);
  })
  .catch(function() {
    document.getElementById('music-body').innerHTML =
      '<div style="padding:20px;color:var(--text-3);font-size:.85rem;text-align:center;">Offline â€” can\'t load music suggestions.</div>';
  });
}

function _renderMusicResults(result) {
  // Scene description in header
  var sceneEl = document.getElementById('music-scene-desc');
  if (sceneEl && result.scene) sceneEl.textContent = result.scene;

  // Artist cards
  var html = '';
  var genreEmojis = { 'Country': 'ğŸ¤ ', 'Rock': 'ğŸ¸', 'Blues': 'ğŸ·', 'Jazz': 'ğŸº', 'Folk': 'ğŸª•', 'Pop': 'â­', 'Hip-Hop': 'ğŸ¤', 'R&B': 'ğŸµ', 'Classical': 'ğŸ»', 'Gospel': 'ğŸ™', 'Bluegrass': 'ğŸª•', 'Soul': 'ğŸ¤', 'Indie': 'ğŸ§', 'Alternative': 'ğŸ§', 'Electronic': 'ğŸ›ï¸', 'Americana': 'ğŸ‡ºğŸ‡¸' };

  (result.artists || []).forEach(function(artist) {
    var emoji = genreEmojis[artist.genre] || 'ğŸµ';
    var spotifySearch = encodeURIComponent(artist.searchQuery || artist.name);
    var spotifyUrl = 'https://open.spotify.com/search/' + spotifySearch;
    var spotifyUri = 'spotify:search:' + spotifySearch;
    html += '<a class="music-artist-card" href="' + spotifyUrl + '" target="_blank" rel="noopener" onclick="event.preventDefault();_openSpotify(\'' + spotifyUri + '\',\'' + spotifyUrl + '\')">'
      + '<div class="music-artist-icon">' + emoji + '</div>'
      + '<div style="flex:1;min-width:0;">'
      + '<div style="font-weight:700;font-size:.9rem;color:var(--text);">' + artist.name + '</div>'
      + '<div style="font-size:.75rem;color:var(--text-3);margin-top:1px;">' + artist.genre + '</div>'
      + '<div style="font-size:.78rem;color:var(--text-2);margin-top:3px;line-height:1.35;">' + artist.why + '</div>'
      + '</div>'
      + '<div style="flex-shrink:0;color:#1DB954;font-size:1.1rem;">â–¶</div>'
      + '</a>';
  });

  if (!html) {
    html = '<div style="padding:20px;text-align:center;color:var(--text-3);font-size:.85rem;">No artists found for this area.</div>';
  }

  document.getElementById('music-body').innerHTML = html;

  // Genre chips
  if (result.genres && result.genres.length) {
    var genreRow = document.getElementById('music-genres-row');
    genreRow.style.display = 'block';
    var chipsHtml = '';
    // "Full playlist" chip first
    if (result.playlistSearch) {
      var ps = encodeURIComponent(result.playlistSearch);
      chipsHtml += '<a onclick="event.preventDefault();_openSpotify(\'spotify:search:' + ps + '\',\'https://open.spotify.com/search/' + ps + '\')" href="#" style="display:inline-flex;align-items:center;gap:5px;background:#1DB954;color:#fff;border-radius:100px;padding:6px 14px;font-size:.78rem;font-weight:700;text-decoration:none;">ğŸµ Local Playlist</a>';
    }
    result.genres.forEach(function(g) {
      var gs = encodeURIComponent(g + ' music');
      chipsHtml += '<a onclick="event.preventDefault();_openSpotify(\'spotify:search:' + gs + '\',\'https://open.spotify.com/search/' + gs + '\')" href="#" style="display:inline-flex;align-items:center;gap:4px;background:var(--bg);border:1.5px solid var(--border);color:var(--text);border-radius:100px;padding:6px 12px;font-size:.78rem;font-weight:600;text-decoration:none;">' + g + '</a>';
    });
    document.getElementById('music-genre-chips').innerHTML = chipsHtml;
  }
}

function _openSpotify(uri, webUrl) {
  // Try to open Spotify app via URI scheme; fall back to web player
  var iframe = document.createElement('iframe');
  iframe.style.display = 'none';
  iframe.src = uri;
  document.body.appendChild(iframe);
  setTimeout(function() {
    document.body.removeChild(iframe);
    window.open(webUrl, '_blank');
  }, 800);
}

function _openMusicForStop(stopId) {
  var stop = getStop(stopId);
  if (!stop) return;
  var modal = document.getElementById('music-modal');
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  document.getElementById('music-location-title').textContent = _sn(stop);
  document.getElementById('music-scene-desc').textContent = '';
  document.getElementById('music-genres-row').style.display = 'none';
  if (_musicCache[stop.id]) { _renderMusicResults(_musicCache[stop.id]); return; }
  document.getElementById('music-body').innerHTML =
    '<div style="text-align:center;padding:40px 20px;color:var(--text-3);">'
    + '<div style="font-size:2rem;margin-bottom:10px;">ğŸµ</div>'
    + '<div style="font-weight:600;">Finding local sounds for ' + stop.name + 'â€¦</div>'
    + '</div>';
  _fetchLocalMusic(stop);
}

/* â”€â”€ DAY DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _ddmDayNum = null;

function openDayDetail(dayNum) {
  var d = TRIP_DAYS[dayNum - 1];
  if (!d) return;
  var stop = getStop(d.stopId);
  _ddmDayNum = dayNum;
  document.getElementById('ddm-phase').textContent = d.phase || '';
  document.getElementById('ddm-title').textContent = d.title;
  var metaParts = [];
  if (d.driveDay && d.miles > 0) metaParts.push('&#128665; ' + d.miles + ' mi &middot; ~' + d.driveHours + 'h drive');
  else metaParts.push('&#127957; Explore day at ' + (stop ? stop.name : 'camp'));
  document.getElementById('ddm-meta').innerHTML = metaParts.join('&nbsp;&nbsp;&middot;&nbsp;&nbsp;');
  document.getElementById('ddm-blocks').innerHTML = renderDayTimeBlocks(d, stop);
  var arrBtn = document.getElementById('ddm-arrive-btn');
  var depBtn = document.getElementById('ddm-leave-btn');
  if (arrBtn) {
    var arr = appState.arrivals && appState.arrivals[d.stopId];
    arrBtn.innerHTML = arr ? '&#10003; Arrived ' + new Date(arr.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '&#129001; We Arrived!';
  }
  if (depBtn) {
    var dep = appState.departures && appState.departures[d.stopId];
    depBtn.innerHTML = dep ? '&#10003; Left ' + new Date(dep.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '&#128666; We Left';
  }
  document.getElementById('day-detail-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeDayDetail() {
  var modal = document.getElementById('day-detail-modal');
  if (modal) {
    modal.classList.add('hidden');
    /* If closed from game-card mode, restore the trip action buttons */
    if (modal.dataset.mode === 'game') {
      modal.dataset.mode = '';
      ['ddm-arrive-btn','ddm-leave-btn'].forEach(function(id) {
        var el2 = document.getElementById(id);
        if (el2) el2.style.display = '';
      });
    }
  }
  document.body.style.overflow = '';
}

/* â”€â”€ Time formatting helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _getTimeFormat() {
  return (appState.tripSettings && appState.tripSettings.timeFormat) || '12h';
}
function _getDepartureHour() {
  var dep = (appState.tripSettings && appState.tripSettings.departureTime) || '08:00';
  var parts = dep.split(':');
  var h = parseInt(parts[0]), m = parseInt(parts[1] || 0);
  return (isNaN(h) ? 8 : h) + (isNaN(m) ? 0 : m) / 60;
}
function _getLatestArrivalHour() {
  var la = (appState.tripSettings && appState.tripSettings.latestArrival) || '20:00';
  var parts = la.split(':');
  var h = parseInt(parts[0]), m = parseInt(parts[1] || 0);
  return (isNaN(h) ? 20 : h) + (isNaN(m) ? 0 : m) / 60;
}
/* Format a fractional hour (e.g. 14.5 = 2:30 PM) as a time string */
function _fmtHour(h) {
  var hWrapped = ((h % 24) + 24) % 24; // wrap midnight
  var hInt = Math.floor(hWrapped);
  var m = Math.round((hWrapped - hInt) * 60);
  if (m === 60) { hInt++; m = 0; hWrapped = ((hInt % 24) + 24) % 24; hInt = Math.floor(hWrapped); }
  if (_getTimeFormat() === '24h') {
    return String(hInt).padStart(2,'0') + ':' + (m < 10 ? '0'+m : m);
  }
  var ampm = hInt >= 12 ? 'PM' : 'AM';
  var dh = hInt > 12 ? hInt - 12 : (hInt === 0 ? 12 : hInt);
  return dh + ':' + (m < 10 ? '0'+m : m) + ' ' + ampm;
}
/* Convert stored "7:00 AM" / "14:30" strings to display using current format */
function _fmtTimeStr(timeStr) {
  if (!timeStr) return timeStr;
  // Try to parse "H:MM AM/PM"
  var m12 = timeStr.match(/^(\d{1,2}):(\d{2})\s*(AM|PM)$/i);
  if (m12) {
    var h = parseInt(m12[1]);
    var mn = parseInt(m12[2]);
    var ap = m12[3].toUpperCase();
    if (ap === 'PM' && h !== 12) h += 12;
    if (ap === 'AM' && h === 12) h = 0;
    return _fmtHour(h + mn / 60);
  }
  // Try to parse "HH:MM" 24h
  var m24 = timeStr.match(/^(\d{1,2}):(\d{2})$/);
  if (m24) {
    return _fmtHour(parseInt(m24[1]) + parseInt(m24[2]) / 60);
  }
  return timeStr;
}
function ddmArrivalTime(driveHours) {
  var depH = _getDepartureHour();
  var arrH = depH + driveHours;
  return _fmtHour(arrH);
}
function _depTimeStr() { return _fmtHour(_getDepartureHour()); }

function renderDayTimeBlocks(d, stop) {
  var html = '';

  /* â”€â”€ Long-drive split suggestion banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  if (d.driveDay && d.miles > 0) {
    var _maxH = (appState.drivingPrefs && appState.drivingPrefs.maxHours) || 4;
    var _splitAlreadyResolved = appState.dayOverrides && appState.dayOverrides[d.day] && appState.dayOverrides[d.day].splitResolved;
    if (d.driveHours > _maxH && !_splitAlreadyResolved) {
      /* Figure out origin stop */
      var _originName = 'previous stop';
      for (var _pi = d.day - 2; _pi >= 0; _pi--) {
        var _prev = TRIP_DAYS[_pi];
        if (_prev && _prev.stopId !== d.stopId) {
          var _ps = getStop(_prev.stopId);
          if (_ps) _originName = _ps.name;
          break;
        }
      }
      var _destName  = stop ? stop.name : 'destination';
      var _halfH     = d.driveHours / 2;
      var _halfMi    = Math.round(d.miles / 2);
      var _halfHDisp = _halfH % 1 === 0 ? _halfH + 'h' : _halfH + 'h';
      var _prevDayN  = d.day - 1;
      var _prevDay   = getDay(_prevDayN);
      var _prevIsExplore = _prevDay && !_prevDay.driveDay;

      html += '<div id="drive-split-warn-' + d.day + '" style="background:var(--orange-l);border:1.5px solid var(--orange);border-radius:12px;padding:14px 16px;margin-bottom:14px;">'
        + '<div style="display:flex;align-items:flex-start;gap:10px;">'
        + '<div style="font-size:1.3rem;flex-shrink:0;">âš ï¸</div>'
        + '<div style="flex:1;">'
        + '<div style="font-weight:900;font-size:.9rem;color:var(--orange-d);margin-bottom:4px;">'
        + d.driveHours + 'h Drive â€” Over Your ' + _maxH + 'h Preference'
        + '</div>'
        + '<div style="font-size:.82rem;color:var(--text);line-height:1.6;margin-bottom:10px;">'
        + '<strong>' + _originName + ' â†’ ' + _destName + '</strong> is ' + d.miles + ' miles. '
        + 'Instead of driving it all today, consider splitting it:'
        + '</div>'
        + '<div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px;">'
        /* Split option A */
        + '<div style="background:#fff;border:1.5px solid var(--orange);border-radius:12px;padding:10px 12px;">'
        + '<div style="font-size:.7rem;font-weight:800;color:var(--orange);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">Split Option â€” Spread over 2 days</div>'
        + '<div style="font-size:.83rem;color:var(--text);line-height:1.55;">'
        + '<strong>Day ' + _prevDayN + ' evening:</strong> Drive first <strong>~' + _halfHDisp + '</strong> (~' + _halfMi + ' mi)'
        + (_prevIsExplore ? ' after exploring. Arriving late at the midpoint â€” a <strong>Walmart parking lot</strong> or truck stop is ideal (no reservation needed!).' : '. Arriving at the midpoint around evening â€” a <strong>Walmart overnight</strong> or truck stop works great.')
        + '<br><strong>Day ' + d.day + ' morning:</strong> Drive the remaining <strong>~' + _halfHDisp + '</strong> (~' + _halfMi + ' mi) into ' + _destName + '. Arrive refreshed!'
        + '</div>'
        + '</div>'
        + '</div>'
        + '<div style="display:flex;gap:8px;flex-wrap:wrap;">'
        + '<button onclick="applySplitDrive(' + d.day + ')" style="background:var(--orange);color:#fff;border:none;border-radius:100px;padding:8px 16px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœ‚ï¸ Split the Drive</button>'
        + '<button onclick="acceptLongDrive(' + d.day + ')" style="background:var(--bg);border:1.5px solid var(--border);border-radius:100px;padding:8px 14px;font-size:.82rem;font-weight:700;cursor:pointer;color:var(--text-2);font-family:var(--font);">ğŸ’ª Drive It All</button>'
        + '</div>'
        + '</div></div></div>';
    }
  }

  var planned = (stop && typeof getPlannedForStop === 'function') ? getPlannedForStop(stop.id) : { activities: [], restaurants: [] };

  /* build sorted act list: planned first */
  var acts = [];
  if (stop) {
    var _stopActs  = stop.activities  || [];
    var _stopRests = stop.restaurants || [];
    for (var pai = 0; pai < planned.activities.length && acts.length < 3; pai++) {
      var pa = _stopActs[planned.activities[pai]];
      if (pa) acts.push({ item: pa, planned: true, idx: planned.activities[pai] });
    }
    for (var uai = 0; uai < _stopActs.length && acts.length < 3; uai++) {
      if (planned.activities.indexOf(uai) === -1) acts.push({ item: _stopActs[uai], planned: false, idx: uai });
    }
  }

  /* build full rest list (no cap â€” we need all options for smart meal picking) */
  var rests = [];
  if (stop) {
    for (var pri = 0; pri < planned.restaurants.length; pri++) {
      var pr = _stopRests[planned.restaurants[pri]];
      if (pr) rests.push({ item: pr, planned: true, idx: planned.restaurants[pri] });
    }
    for (var uri = 0; uri < _stopRests.length; uri++) {
      if (planned.restaurants.indexOf(uri) === -1) rests.push({ item: _stopRests[uri], planned: false, idx: uri });
    }
  }
  /* per-meal skip state */
  var mealSkips = (appState.mealSkips && stop && appState.mealSkips[stop.id]) ? appState.mealSkips[stop.id] : {};
  /* pick distinct restaurants per meal using suitability scoring */
  var _usedMealIdxs = [];
  var bRest = rests.length ? pickMealRest(rests, 'breakfast', _usedMealIdxs, mealSkips.breakfast) : null;
  if (bRest) _usedMealIdxs.push(bRest.idx);
  var lRest = rests.length ? pickMealRest(rests, 'lunch',     _usedMealIdxs, mealSkips.lunch)     : null;
  if (lRest) _usedMealIdxs.push(lRest.idx);
  var dRest = rests.length ? pickMealRest(rests, 'dinner',    _usedMealIdxs, mealSkips.dinner)    : null;

  function tbbAiBtn(type, stopId, idx) {
    return 'openPlaceInfo(\'' + type + '\',' + stopId + ',' + idx + ')';
  }

  /* Pull per-day overrides (custom times, custom places, notes) */
  var _overrides = (appState.dayOverrides && appState.dayOverrides[d.day]) ? appState.dayOverrides[d.day] : {};

  /* helper: apply override time or use default */
  function ovTime(key, def) {
    return (_overrides[key] && _overrides[key].time) ? _overrides[key].time : def;
  }
  function ovTitle(key, def) {
    return (_overrides[key] && _overrides[key].customPlace) ? _overrides[key].customPlace : def;
  }
  function ovSub(key, def) {
    var note = (_overrides[key] && _overrides[key].notes) ? ' Â· ' + _overrides[key].notes : '';
    return ((_overrides[key] && _overrides[key].customSub) ? _overrides[key].customSub : def) + note;
  }

  /* tbbRow â€” tap = AI info modal, âœï¸ button = edit modal, drag handle = reorder */
  function tbbRow(time, icon, title, sub, tag, isPlanned, aiAction, skipAction, editKey) {
    var tagHtml = '';
    if (tag === 'drive')   tagHtml += '<span class="tbb-tag tbb-drive">DRIVE</span>';
    if (tag === 'eat')     tagHtml += '<span class="tbb-tag tbb-eat">EAT</span>';
    if (tag === 'explore') tagHtml += '<span class="tbb-tag tbb-explore">EXPLORE</span>';
    if (isPlanned)         tagHtml += '<span class="tbb-tag tbb-planned">&#9989; PLANNED</span>';
    if (editKey && _overrides[editKey] && (_overrides[editKey].customPlace || _overrides[editKey].notes || _overrides[editKey].time)) {
      tagHtml += '<span class="tbb-tag" style="background:#fff3cd;color:#856404;">âœï¸ Edited</span>';
    }
    var hasAction = aiAction && aiAction.length > 0;
    var hasEdit   = !!editKey;
    var safeTitle = hasEdit ? title.replace(/&[a-z]+;/g,'').replace(/'/g,'').replace(/"/g,'').substring(0,40) : '';

    /* Row click = AI info only; drag handle grabs for reorder; edit btn opens modal */
    /* NOTE: when draggable="true", browsers (esp. iOS) suppress click events on the row.
       So when hasEdit+hasAction, we put onclick on a content-wrapper div, not the row. */
    var rowCursor = (hasAction && !hasEdit) ? 'pointer' : 'default';
    var rowAttrs = ' style="cursor:' + rowCursor + ';"';
    if (hasEdit) {
      rowAttrs += ' data-editable="1" data-edit-key="' + editKey + '" data-day="' + d.day + '"'
        + ' draggable="true"'
        + ' ondragstart="handleTbbDragStart(event,\'' + editKey + '\',' + d.day + ')"'
        + ' ondragover="handleTbbDragOver(event)"'
        + ' ondrop="handleTbbDrop(event,' + d.day + ')"'
        + ' ondragend="handleTbbDragEnd(event)"'
        + ' ondragleave="handleTbbDragLeave(event)"';
      /* NO onclick on draggable row â€” mobile browsers swallow tap on draggable elements */
    } else if (hasAction) {
      rowAttrs += ' onclick="' + aiAction + '"';
    }

    /* Drag handle â€” stopPropagation so clicking handle doesn't fire row onclick */
    var dragHandle = hasEdit
      ? '<div class="tbb-drag" title="Drag to reorder" onclick="event.stopPropagation()">â ¿</div>'
      : '';

    /* Edit button â€” small âœï¸ tap target, stops row click from firing */
    var editBtn = hasEdit
      ? '<button onclick="event.stopPropagation();openItemEdit(' + d.day + ',\'' + editKey + '\',\'' + icon + '\',\'' + safeTitle + '\')" '
        + 'title="Edit" style="background:rgba(255,255,255,.0);border:1.5px solid var(--border);border-radius:100px;padding:3px 7px;font-size:.82rem;cursor:pointer;color:var(--text-3);flex-shrink:0;line-height:1;margin-left:2px;font-family:var(--font);transition:background .15s;" '
        + 'onmouseenter="this.style.background=\'var(--orange-l)\';this.style.color=\'var(--orange)\'" '
        + 'onmouseleave="this.style.background=\'transparent\';this.style.color=\'var(--text-3)\'">âœï¸</button>'
      : '';

    var chevron = (hasAction && !skipAction && !hasEdit) ? '<div style="display:flex;align-items:center;padding:0 6px;color:var(--text-3);font-size:1.1rem;flex-shrink:0;">&#8250;</div>' : '';
    var skipBtn = skipAction
      ? '<button onclick="event.stopPropagation();' + skipAction + '" title="Try a different option" style="background:none;border:1.5px solid var(--border);border-radius:100px;padding:3px 8px;font-size:.9rem;cursor:pointer;color:var(--text-3);flex-shrink:0;line-height:1;margin-left:4px;" aria-label="Swap">ğŸ‘</button>'
      : '';
    var rightEl = dragHandle + editBtn + skipBtn + ((!editBtn && !skipBtn) ? chevron : '');

    /* When row is draggable+clickable, wrap the left content in its own tap target div.
       iOS/Android suppress click on draggable rows, so we put onclick+ontouchend on the inner wrapper.
       The wrapper uses flex to preserve the original time/icon/content layout. */
    var cWrapOpen  = (hasEdit && hasAction)
      ? '<div style="display:flex;align-items:flex-start;gap:10px;flex:1;min-width:0;cursor:pointer;" onclick="' + aiAction + '" ontouchend="event.stopPropagation();' + aiAction + '">'
      : '';
    var cWrapClose = (hasEdit && hasAction) ? '</div>' : '';

    return '<div class="tbb-row"' + rowAttrs + '>'
      + cWrapOpen
      + '<div class="tbb-time">' + time + '</div>'
      + '<div class="tbb-icon">' + icon + '</div>'
      + '<div class="tbb-content">'
      + '<div class="tbb-title">' + title + '</div>'
      + (sub ? '<div class="tbb-sub">' + sub + '</div>' : '')
      + (tagHtml ? '<div class="tbb-tags">' + tagHtml + '</div>' : '')
      + '</div>'
      + cWrapClose
      + rightEl
      + '</div>';
  }

  /* Drive-time micro-separator between place-to-place transitions */
  function driveSep(mins) {
    return '<div class="dtb-drive-sep">ğŸš— ~' + mins + ' min drive</div>';
  }

  /* Get custom order (or build default order) */
  var _orderKeys = (appState.dayOrder && appState.dayOrder[d.day]) ? appState.dayOrder[d.day] : null;

  /* Build items array for default or custom-ordered rendering */
  var _items = [];

  /* â”€â”€ Drive day vs explore day item builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  if (d.driveDay && d.miles > 0) {
    /* DRIVE DAY: morning departure, on-road meals, arrive at destination by evening */
    var _depH   = _getDepartureHour();
    var _arrH   = _depH + d.driveHours;
    var _latestH = _getLatestArrivalHour();
    var _depStr = _fmtHour(_depH);
    var _arrStr = ddmArrivalTime(d.driveHours);

    /* Late arrival warning banner */
    if (_arrH > _latestH) {
      var _overMins = Math.round((_arrH - _latestH) * 60);
      html += '<div style="background:#fff3cd;border:1.5px solid #ffc107;border-radius:10px;padding:12px 14px;margin-bottom:12px;font-size:.83rem;line-height:1.55;">'
        + '<strong>âš ï¸ Late Arrival Warning</strong><br>'
        + 'Estimated arrival ' + _arrStr + ' is ' + _overMins + ' min after your ' + _fmtHour(_latestH) + ' latest check-in. '
        + 'Consider splitting the drive or departing earlier.'
        + '</div>';
    }

    /* Pre-departure: breakfast at origin (no destination restaurant) */
    var bTimeDrive = ovTime('breakfast', _fmtHour(_depH - 1));
    _items.push({ key:'breakfast', html: tbbRow(bTimeDrive,'&#127749;',
      ovTitle('breakfast','Breakfast â€” Before You Leave'),
      ovSub('breakfast','Quick meal before hitting the road'),
      'eat',false,'','','breakfast') });
    /* Override: if a customPlace was saved for breakfast on a drive day (destination restaurant),
       ignore it â€” breakfast is eaten at home before leaving */
    if (_overrides['breakfast'] && _overrides['breakfast'].customPlace && d.driveDay) {
      _items[_items.length-1].html = _items[_items.length-1].html.replace(
        _overrides['breakfast'].customPlace, 'Breakfast Before You Leave');
    }

    /* Depart block */
    var nextNameD = stop ? stop.name : '';
    _items.push({ key:'drive', html: tbbRow(ovTime('drive', _depStr),'&#128656;',
      'Depart' + (nextNameD ? ' \u2192 ' + nextNameD : ''),
      d.miles + ' miles \u00b7 ~' + d.driveHours + 'h drive \u00b7 Arrive ~' + _arrStr,
      'drive',false,'','','drive') });

    /* On-road lunch stop */
    var _lunchH = _depH + (d.driveHours / 2);
    _items.push({ key:'lunch', html: tbbRow(ovTime('lunch', _fmtHour(_lunchH)),'&#127828;',
      ovTitle('lunch','Lunch â€” Road Stop'),
      ovSub('lunch','Find a diner or drive-through on the way'),
      'eat',false,'','','lunch') });

    /* Arrive & check in */
    _items.push({ key:'sleep', html: tbbRow(_arrStr,'&#127957;',
      ovTitle('sleep','Arrive & Check In'),
      ovSub('sleep', d.sleep || 'Next campsite'),
      null,false,'openCampInfo('+d.day+')','','sleep') });

    /* Post-arrival dinner (only if arriving before 6 PM) */
    if (_arrH < 18 && dRest) {
      var dSub2  = ovSub('dinner', (dRest.item.type || '') + (dRest.item.price ? ' \u00b7 ' + dRest.item.price : '') + (dRest.item.hours ? ' \u00b7 ' + dRest.item.hours : ''));
      var dSkip2 = (stop && rests.length > 2) ? 'skipMeal(' + d.day + ',\'dinner\')' : '';
      var _dinH  = Math.max(_arrH + 1.5, 17.5);
      _items.push({ key:'dinner', html: tbbRow(ovTime('dinner', _fmtHour(_dinH)),'&#127869;',
        ovTitle('dinner','Dinner \u2014 '+dRest.item.name),dSub2,'eat',dRest.planned,stop ? tbbAiBtn('r',stop.id,dRest.idx) : '',dSkip2,'dinner') });
    } else if (_arrH < 18) {
      _items.push({ key:'dinner', html: tbbRow(ovTime('dinner', _fmtHour(Math.max(_arrH + 1.5, 17.5))),'&#127869;',
        ovTitle('dinner','Dinner'),ovSub('dinner','Explore dining near the campground'),'eat',false,'','','dinner') });
    }

  } else {
    /* â”€â”€ EXPLORE DAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var bTime = ovTime('breakfast', _fmtHour(7));
    var bSub  = bRest ? ovSub('breakfast', (bRest.item.hours || '') + (bRest.item.address ? ' &middot; ' + bRest.item.address : '')) : 'Make breakfast in the RV';
    var bBtn  = (bRest && stop) ? tbbAiBtn('r', stop.id, bRest.idx) : '';
    var bSkip = (bRest && stop && rests.length > 1) ? 'skipMeal(' + d.day + ',\'breakfast\')' : '';
    _items.push({ key:'breakfast', html: tbbRow(bTime,'&#127749;',
      ovTitle('breakfast','Breakfast' + (bRest ? ' \u2014 ' + bRest.item.name : ' at the RV')),
      bSub,'eat',bRest&&bRest.planned,bBtn,bSkip,'breakfast') });

    if (acts[0]) {
      var a0 = acts[0];
      var a0sub = ovSub('act0', (a0.item.duration ? a0.item.duration : '') + (a0.item.desc ? ' &middot; ' + a0.item.desc.substring(0,100) + (a0.item.desc.length > 100 ? '&hellip;' : '') : ''));
      _items.push({ key:'act0', html: tbbRow(ovTime('act0', _fmtHour(9)),'&#127775;',ovTitle('act0',a0.item.name),a0sub,'explore',a0.planned,stop ? tbbAiBtn('a',stop.id,a0.idx) : '','','act0') });
    } else if (stop) {
      _items.push({ key:'act0', html: tbbRow(ovTime('act0', _fmtHour(9)),'&#127775;',ovTitle('act0','Morning at '+stop.name),ovSub('act0','Explore the area'),'explore',false,'','','act0') });
    }

    if (lRest) {
      var lSub  = ovSub('lunch', (lRest.item.type || '') + (lRest.item.price ? ' &middot; ' + lRest.item.price : '') + (lRest.item.address ? ' &middot; ' + lRest.item.address : ''));
      var lSkip = (stop && rests.length > 2) ? 'skipMeal(' + d.day + ',\'lunch\')' : '';
      _items.push({ key:'lunch', html: tbbRow(ovTime('lunch', _fmtHour(12)),'&#127828;',ovTitle('lunch','Lunch \u2014 '+lRest.item.name),lSub,'eat',lRest.planned,stop ? tbbAiBtn('r',stop.id,lRest.idx) : '',lSkip,'lunch') });
    }

    if (acts.length > 1) {
      var a1 = acts[1];
      var a1sub = ovSub('act1', (a1.item.duration ? a1.item.duration : '') + (a1.item.desc ? ' &middot; ' + a1.item.desc.substring(0,100) + (a1.item.desc.length > 100 ? '&hellip;' : '') : ''));
      _items.push({ key:'act1', html: tbbRow(ovTime('act1', _fmtHour(14)),'&#128506;',ovTitle('act1',a1.item.name),a1sub,'explore',a1.planned,stop ? tbbAiBtn('a',stop.id,a1.idx) : '','','act1') });
    }

    if (dRest) {
      var dSub  = ovSub('dinner', (dRest.item.type || '') + (dRest.item.price ? ' &middot; ' + dRest.item.price : '') + (dRest.item.hours ? ' &middot; ' + dRest.item.hours : ''));
      var dSkip = (stop && rests.length > 2) ? 'skipMeal(' + d.day + ',\'dinner\')' : '';
      _items.push({ key:'dinner', html: tbbRow(ovTime('dinner', _fmtHour(17.5)),'&#127869;',ovTitle('dinner','Dinner \u2014 '+dRest.item.name),dSub,'eat',dRest.planned,stop ? tbbAiBtn('r',stop.id,dRest.idx) : '',dSkip,'dinner') });
    }

    _items.push({ key:'sleep', html: tbbRow(ovTime('sleep', _fmtHour(19)),'&#127769;',
      ovTitle('sleep','Evening at Camp'),
      ovSub('sleep', d.sleep || 'Relax and unwind'),
      null,false,'openCampInfo('+d.day+')','','sleep') });
  }

  /* Apply custom order if set */
  if (_orderKeys && _orderKeys.length && !d.driveDay) {
    var _ordered = [];
    _orderKeys.forEach(function(k) {
      var found = _items.filter(function(it) { return it.key === k; })[0];
      if (found) _ordered.push(found);
    });
    /* append any items not in saved order (e.g. newly added) */
    _items.forEach(function(it) {
      if (!_ordered.some(function(o) { return o.key === it.key; })) _ordered.push(it);
    });
    _items = _ordered;
  }

  /* Render with drive-time separators between non-drive editable items */
  var _driveEstimates = { breakfast:12, act0:10, lunch:10, act1:12, dinner:15, drive:0, sleep:0 };
  for (var _ii = 0; _ii < _items.length; _ii++) {
    html += _items[_ii].html;
    /* add separator after all items except drive/sleep rows and the last item */
    var _k = _items[_ii].key;
    var _nextK = _ii + 1 < _items.length ? _items[_ii+1].key : null;
    if (_nextK && _k !== 'drive' && _k !== 'sleep' && _nextK !== 'drive') {
      html += driveSep(_driveEstimates[_k] || 12);
    } else if (_nextK === 'sleep' && _k !== 'drive') {
      html += driveSep(_driveEstimates['dinner'] || 15);
    }
  }

  return html || '<div style="padding:24px;text-align:center;color:var(--text-3);">No schedule data for this day.</div>';
}

/* â”€â”€ MEAL SKIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function skipMeal(dayNum, meal) {
  var d = getDay(dayNum);
  if (!d) return;
  var stop = getStop(d.stopId);
  if (!stop) return;

  /* initialise skip state */
  if (!appState.mealSkips) appState.mealSkips = {};
  if (!appState.mealSkips[stop.id]) appState.mealSkips[stop.id] = {};
  var skips = appState.mealSkips[stop.id];
  if (!skips.breakfast) skips.breakfast = [];
  if (!skips.lunch)     skips.lunch     = [];
  if (!skips.dinner)    skips.dinner    = [];

  /* rebuild rests list same way renderDayTimeBlocks does */
  var planned = (typeof getPlannedForStop === 'function') ? getPlannedForStop(stop.id) : { activities: [], restaurants: [] };
  var rests = [];
  for (var pri = 0; pri < planned.restaurants.length; pri++) {
    var pr = stop.restaurants[planned.restaurants[pri]];
    if (pr) rests.push({ item: pr, planned: true, idx: planned.restaurants[pri] });
  }
  var _mealRests = stop.restaurants || [];
  for (var uri = 0; uri < _mealRests.length; uri++) {
    if (planned.restaurants.indexOf(uri) === -1) rests.push({ item: _mealRests[uri], planned: false, idx: uri });
  }

  /* find what's currently showing for this meal */
  var usedIdxs = [];
  var bPick = pickMealRest(rests, 'breakfast', usedIdxs, skips.breakfast);
  if (bPick) usedIdxs.push(bPick.idx);
  var lPick = pickMealRest(rests, 'lunch', usedIdxs, skips.lunch);
  if (lPick) usedIdxs.push(lPick.idx);
  var dPick = pickMealRest(rests, 'dinner', usedIdxs, skips.dinner);

  var currentPick = meal === 'breakfast' ? bPick : meal === 'lunch' ? lPick : dPick;
  if (currentPick && skips[meal].indexOf(currentPick.idx) === -1) {
    skips[meal].push(currentPick.idx);
  }

  saveState(appState);
  showToast('Swapped out â€” here\'s a new pick! ğŸ‘', 1800);

  /* re-render the time blocks in place */
  var blocksEl = document.getElementById('ddm-blocks');
  if (blocksEl) blocksEl.innerHTML = renderDayTimeBlocks(d, stop);
}

/* â”€â”€ ITEM LONG-PRESS & EDIT MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _ieLpTimer  = null;   /* long-press timer */
var _ieLpFired  = false;  /* flag to suppress tap after long-press */
var _ieDay      = null;   /* which day is being edited */
var _ieKey      = null;   /* which item key: 'breakfast','lunch','dinner','act0','act1','drive','sleep' */
var _ieDuration = null;   /* selected duration in minutes */
var _ieSearchedPlace = null; /* result from Gemini place search */

function startItemLp(event, dayNum, itemKey, icon, title) {
  _ieLpFired = false;
  if (event.type === 'touchstart') event.preventDefault(); /* prevent ghost click */
  _ieLpTimer = setTimeout(function() {
    _ieLpFired = true;
    cancelItemLp();
    openItemEdit(dayNum, itemKey, icon, title);
  }, 600);
}
function cancelItemLp(event) {
  if (_ieLpTimer) { clearTimeout(_ieLpTimer); _ieLpTimer = null; }
  if (event && event.type === 'touchend' && !_ieLpFired) {
    /* allow default tap â†’ let onclick fire naturally via the data-edit key */
  }
}

function openItemEdit(dayNum, itemKey, icon, title) {
  _ieDay = dayNum; _ieKey = itemKey; _ieDuration = null; _ieSearchedPlace = null;
  var ov = (appState.dayOverrides && appState.dayOverrides[dayNum] && appState.dayOverrides[dayNum][itemKey]) || {};

  /* Set header */
  document.getElementById('iem-icon').textContent = icon || 'ğŸ“‹';
  document.getElementById('iem-title').textContent = title || itemKey;

  /* Set time field */
  var timeStr = ov.time || '';
  var timeInput = document.getElementById('iem-time');
  if (timeInput) {
    /* Convert "7:00 AM" â†’ "07:00" for the input */
    if (timeStr) {
      var tMatch = timeStr.match(/(\d+):(\d+)\s*(AM|PM)/i);
      if (tMatch) {
        var hh = parseInt(tMatch[1]);
        var mm = tMatch[2];
        var ampm = tMatch[3].toUpperCase();
        if (ampm === 'PM' && hh !== 12) hh += 12;
        if (ampm === 'AM' && hh === 12) hh = 0;
        timeInput.value = (hh < 10 ? '0' : '') + hh + ':' + mm;
      } else { timeInput.value = ''; }
    } else { timeInput.value = ''; }
  }

  /* Duration buttons */
  _ieDuration = ov.duration || null;
  var durBtns = document.querySelectorAll('.iem-dur-btn');
  durBtns.forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.mins) === _ieDuration);
  });

  /* Pre-fill search with existing custom place */
  var searchEl = document.getElementById('iem-search');
  if (searchEl) searchEl.value = ov.customPlace || '';
  var resEl = document.getElementById('iem-search-result');
  if (resEl) { resEl.style.display = 'none'; resEl.innerHTML = ''; }
  var altEl = document.getElementById('iem-alt-result');
  if (altEl) { altEl.style.display = 'none'; altEl.innerHTML = ''; }

  /* Notes */
  var notesEl = document.getElementById('iem-notes');
  if (notesEl) notesEl.value = ov.notes || '';

  document.getElementById('item-edit-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function closeItemEdit() {
  document.getElementById('item-edit-modal').classList.add('hidden');
  document.body.style.overflow = '';
  _ieDay = null; _ieKey = null; _ieLpFired = false;
}

function setItemDuration(mins) {
  _ieDuration = mins;
  document.querySelectorAll('.iem-dur-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.mins) === mins);
  });
}

function saveItemEdit() {
  if (!_ieDay || !_ieKey) { closeItemEdit(); return; }
  if (!appState.dayOverrides) appState.dayOverrides = {};
  if (!appState.dayOverrides[_ieDay]) appState.dayOverrides[_ieDay] = {};
  var ov = appState.dayOverrides[_ieDay][_ieKey] || {};

  /* Save time */
  var timeInput = document.getElementById('iem-time');
  if (timeInput && timeInput.value) {
    var parts = timeInput.value.split(':');
    var hh = parseInt(parts[0]); var mm = parts[1] || '00';
    var suffix = hh >= 12 ? 'PM' : 'AM';
    var h12 = hh % 12 || 12;
    ov.time = h12 + ':' + mm + ' ' + suffix;
  } else {
    delete ov.time;
  }

  /* Save duration */
  if (_ieDuration) ov.duration = _ieDuration; else delete ov.duration;

  /* Save place from search result or manual entry */
  var searchEl = document.getElementById('iem-search');
  if (_ieSearchedPlace) {
    ov.customPlace = _ieSearchedPlace.name;
    ov.customSub   = _ieSearchedPlace.sub || '';
  } else if (searchEl && searchEl.value.trim()) {
    ov.customPlace = searchEl.value.trim();
    delete ov.customSub;
  } else {
    delete ov.customPlace; delete ov.customSub;
  }

  /* Save notes */
  var notesEl = document.getElementById('iem-notes');
  if (notesEl && notesEl.value.trim()) ov.notes = notesEl.value.trim(); else delete ov.notes;

  appState.dayOverrides[_ieDay][_ieKey] = ov;
  saveState(appState);
  closeItemEdit();

  /* Re-render day blocks */
  var d = getDay(_ieDay);
  var stop = d ? getStop(d.stopId) : null;
  var blocksEl = document.getElementById('ddm-blocks');
  if (blocksEl && d) blocksEl.innerHTML = renderDayTimeBlocks(d, stop);
  showToast('âœ… Schedule updated!', 2000);
}

function removeItemOverride() {
  if (!_ieDay || !_ieKey) return;
  if (appState.dayOverrides && appState.dayOverrides[_ieDay]) {
    delete appState.dayOverrides[_ieDay][_ieKey];
    saveState(appState);
  }
  closeItemEdit();
  var d = getDay(_ieDay);
  var stop = d ? getStop(d.stopId) : null;
  var blocksEl = document.getElementById('ddm-blocks');
  if (blocksEl && d) blocksEl.innerHTML = renderDayTimeBlocks(d, stop);
  showToast('â†º Reset to default', 1800);
}

/* AI: suggest a different activity/restaurant for the selected slot */
function suggestItemAlternative() {
  if (!_ieDay || !_ieKey) return;
  var d = getDay(_ieDay);
  var stop = d ? getStop(d.stopId) : null;
  var slotLabel = { breakfast:'breakfast place', lunch:'lunch spot', dinner:'dinner restaurant', act0:'morning activity', act1:'afternoon activity', sleep:'campground or overnight spot', drive:'driving route' }[_ieKey] || _ieKey;
  var locName = stop ? _sn(stop) : 'the current location';
  var altEl = document.getElementById('iem-alt-result');
  if (altEl) { altEl.style.display = 'block'; altEl.innerHTML = '<div style="color:var(--text-2);font-size:.82rem;">âœ¨ Asking TripGenieâ€¦</div>'; }

  var prompt = 'Suggest ONE great alternative ' + slotLabel + ' for a family with young kids visiting ' + locName + '. '
    + 'Be specific â€” give the actual name and a 1-2 sentence reason why it\'s good. '
    + 'Format: NAME: [name] | WHY: [reason] | DETAIL: [address or hours or price if known]';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:200,temperature:0.8} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}
    if (!text) { if (altEl) altEl.innerHTML = '<div style="color:var(--red);">Could not get a suggestion. Try again.</div>'; return; }
    /* Parse name, why, detail */
    var nameM   = text.match(/NAME:\s*([^\|]+)/i);
    var whyM    = text.match(/WHY:\s*([^\|]+)/i);
    var detailM = text.match(/DETAIL:\s*(.+)/i);
    var suggName   = nameM   ? nameM[1].trim()   : text.split(/\|/)[0].trim().substring(0,80);
    var suggWhy    = whyM    ? whyM[1].trim()    : '';
    var suggDetail = detailM ? detailM[1].trim() : '';
    // Strip markdown bold markers and any leaked WHY:/DETAIL: from the name
    suggName = suggName.replace(/\*\*/g, '').replace(/WHY:.*$/i, '').replace(/DETAIL:.*$/i, '').replace(/:$/, '').trim();
    if (altEl) {
      altEl.style.display = 'block';
      altEl.innerHTML = '<div style="font-weight:800;font-size:.88rem;color:var(--text);margin-bottom:4px;">âœ¨ ' + suggName + '</div>'
        + (suggWhy ? '<div style="font-size:.8rem;color:var(--text-2);margin-bottom:4px;">' + suggWhy + '</div>' : '')
        + (suggDetail ? '<div style="font-size:.76rem;color:var(--text-3);">' + suggDetail + '</div>' : '')
        + '<button onclick="useAltSuggestion(\'' + suggName.replace(/'/g,'') + '\',\'' + suggDetail.replace(/'/g,'').substring(0,60) + '\')" style="margin-top:8px;background:var(--purple);color:#fff;border:none;border-radius:100px;padding:6px 14px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);">âœ“ Use This</button>';
    }
  })
  .catch(function() { if (altEl) altEl.innerHTML = '<div style="color:var(--red);font-size:.8rem;">Error â€” check connection.</div>'; });
}
function useAltSuggestion(name, sub) {
  _ieSearchedPlace = { name: name, sub: sub };
  var searchEl = document.getElementById('iem-search');
  if (searchEl) searchEl.value = name;
  var altEl = document.getElementById('iem-alt-result');
  if (altEl) altEl.innerHTML += ' <span style="color:var(--green);font-weight:700;">âœ“ Selected</span>';
  showToast('âœ“ "' + name + '" selected â€” tap Save to apply', 2200);
}

/* Place search via Gemini */
function searchItemPlace() {
  var query = (document.getElementById('iem-search') || {}).value || '';
  if (!query.trim()) return;
  var d = getDay(_ieDay);
  var stop = d ? getStop(d.stopId) : null;
  var locHint = stop ? ' near ' + _sn(stop) : '';
  var resEl = document.getElementById('iem-search-result');
  if (resEl) { resEl.style.display = 'block'; resEl.innerHTML = '<div style="color:var(--text-2);font-size:.82rem;">ğŸ” Looking upâ€¦</div>'; }

  var prompt = 'Verify and give info about this place' + locHint + ': "' + query + '".\n'
    + 'If it exists, output exactly: NAME: [official name] | TYPE: [type] | ADDRESS: [address] | HOURS: [brief hours] | NOTE: [1 sentence]\n'
    + 'If it does not exist or you are unsure, output: NOTFOUND: [suggestion]';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:200,temperature:0.3} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}
    if (!text || text.startsWith('NOTFOUND')) {
      var nf = text.replace(/^NOTFOUND:\s*/i,'') || 'Place not found.';
      if (resEl) resEl.innerHTML = '<div style="color:var(--red);font-size:.82rem;">âŒ ' + nf + '</div>';
      return;
    }
    var nameM  = text.match(/NAME:\s*([^\|]+)/i);
    var typeM  = text.match(/TYPE:\s*([^\|]+)/i);
    var addrM  = text.match(/ADDRESS:\s*([^\|]+)/i);
    var hoursM = text.match(/HOURS:\s*([^\|]+)/i);
    var noteM  = text.match(/NOTE:\s*(.+)/i);
    var pName  = nameM  ? nameM[1].trim()  : query;
    var pType  = typeM  ? typeM[1].trim()  : '';
    var pAddr  = addrM  ? addrM[1].trim()  : '';
    var pHours = hoursM ? hoursM[1].trim() : '';
    var pNote  = noteM  ? noteM[1].trim()  : '';
    var subStr = [pType, pAddr, pHours].filter(Boolean).join(' Â· ').substring(0, 80);
    _ieSearchedPlace = { name: pName, sub: subStr };
    if (resEl) {
      resEl.style.display = 'block';
      resEl.innerHTML = '<div style="font-weight:800;font-size:.88rem;color:var(--text);margin-bottom:3px;">âœ“ ' + pName + '</div>'
        + (pType ? '<div style="font-size:.76rem;color:var(--text-2);">' + pType + '</div>' : '')
        + (pAddr ? '<div style="font-size:.74rem;color:var(--text-3);">ğŸ“ ' + pAddr + '</div>' : '')
        + (pHours ? '<div style="font-size:.74rem;color:var(--text-3);">ğŸ• ' + pHours + '</div>' : '')
        + (pNote ? '<div style="font-size:.76rem;color:var(--text-2);margin-top:3px;font-style:italic;">' + pNote + '</div>' : '');
    }
  })
  .catch(function() { if (resEl) resEl.innerHTML = '<div style="color:var(--red);font-size:.8rem;">Error searching. Try again.</div>'; });
}

/* â”€â”€ DRAG-AND-DROP REORDERING FOR DAY BLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _ddSrcKey = null;
var _ddDayNum = null;

function handleTbbDragStart(event, itemKey, dayNum) {
  _ddSrcKey = itemKey; _ddDayNum = dayNum;
  event.dataTransfer.effectAllowed = 'move';
  event.dataTransfer.setData('text/plain', itemKey);
  var el = event.currentTarget;
  setTimeout(function() { if (el) el.classList.add('tbb-dragging'); }, 0);
}
function handleTbbDragOver(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = 'move';
  var row = event.currentTarget;
  if (row && row !== event.target && row.dataset.editKey !== _ddSrcKey) {
    document.querySelectorAll('.tbb-row.tbb-drag-over').forEach(function(r) { r.classList.remove('tbb-drag-over'); });
    row.classList.add('tbb-drag-over');
  }
}
function handleTbbDragLeave(event) {
  var row = event.currentTarget;
  if (row) row.classList.remove('tbb-drag-over');
}
function handleTbbDragEnd(event) {
  var row = event.currentTarget;
  if (row) row.classList.remove('tbb-dragging');
  document.querySelectorAll('.tbb-row.tbb-drag-over').forEach(function(r) { r.classList.remove('tbb-drag-over'); });
  _ddSrcKey = null;
}
function handleTbbDrop(event, dayNum) {
  event.preventDefault();
  var targetKey = event.currentTarget.dataset.editKey;
  if (!targetKey || !_ddSrcKey || targetKey === _ddSrcKey) return;
  /* Build current order from DOM */
  var rows = document.querySelectorAll('#ddm-blocks .tbb-row[data-edit-key]');
  var order = [];
  rows.forEach(function(r) { order.push(r.dataset.editKey); });
  /* Move src to position of target */
  var srcIdx = order.indexOf(_ddSrcKey);
  var tgtIdx = order.indexOf(targetKey);
  if (srcIdx === -1 || tgtIdx === -1) return;
  order.splice(srcIdx, 1);
  order.splice(tgtIdx, 0, _ddSrcKey);
  /* Save and re-render */
  if (!appState.dayOrder) appState.dayOrder = {};
  appState.dayOrder[dayNum] = order;
  saveState(appState);
  var d = getDay(dayNum);
  var stop = d ? getStop(d.stopId) : null;
  var blocksEl = document.getElementById('ddm-blocks');
  if (blocksEl && d) blocksEl.innerHTML = renderDayTimeBlocks(d, stop);
  /* Refresh the meta line so drive-time position reflects new order */
  var _metaEl = document.getElementById('ddm-meta');
  if (_metaEl && d) {
    var _metaParts = [];
    if (d.driveDay && d.miles > 0) {
      var _overridesNow = (appState.dayOverrides && appState.dayOverrides[d.day]) || {};
      var _splitNow = _overridesNow.splitResolved && _overridesNow.splitHours;
      _metaParts.push('ğŸš— ' + d.miles + ' mi Â· ~' + (_splitNow ? _overridesNow.splitHours + 'h each leg' : d.driveHours + 'h') + ' drive');
    } else {
      _metaParts.push('ğŸ•ï¸ Explore day at ' + (stop ? stop.name : 'camp'));
    }
    _metaEl.innerHTML = _metaParts.join('&nbsp;&nbsp;Â·&nbsp;&nbsp;');
  }
  showToast('ğŸ“‹ Day schedule reordered!', 1800);
}

/* â”€â”€ AI INFO MODAL (GEMINI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openPlaceInfo(type, stopId, idx) {
  var stop = getStop(stopId);
  if (!stop) return;
  var item = type === 'a' ? (stop.activities||[])[idx] : (stop.restaurants||[])[idx];
  if (!item) return;
  document.getElementById('aim-title').textContent = item.name;
  document.getElementById('aim-sub').textContent = stop.name + '  \u00b7  ' + (type === 'r' ? (item.type || 'Restaurant') : (item.type || 'Activity'));
  document.getElementById('aim-body').innerHTML = '<div style="text-align:center;padding:36px 20px;color:var(--text-2);font-size:.9rem;">&#129302; Asking Gemini AI\u2026</div>';

  // Price badge â€” show immediately from item data for both restaurants and activities
  var priceBadge = document.getElementById('aim-price-badge');
  if (priceBadge) {
    if (item.price) {
      priceBadge.textContent = item.price;
      priceBadge.style.display = 'inline-block';
    } else {
      priceBadge.style.display = 'none';
    }
  }

  // +Plan button â€” wire up immediately
  var planBtn = document.getElementById('aim-plan-btn');
  if (planBtn) {
    planBtn.onclick = function() { closePlaceInfo(); openPlanPicker(stopId, type, idx); };
    planBtn.style.display = 'inline-block';
    planBtn.textContent = isPlan(stopId, type, idx) ? '\u2705 Planned' : '+ Plan';
  }

  // Address from item data
  var addrEl  = document.getElementById('aim-address-link');
  var addrTxt = document.getElementById('aim-address-text');
  if (addrEl && item.address) {
    addrTxt.textContent = item.address;
    addrEl.href = 'https://maps.google.com/?q=' + encodeURIComponent(item.address);
    addrEl.style.display = 'flex';
  } else if (addrEl) { addrEl.style.display = 'none'; }

  // Phone from item data
  var phoneEl  = document.getElementById('aim-phone');
  var phoneTxt = document.getElementById('aim-phone-text');
  if (phoneEl && item.phone) {
    phoneTxt.textContent = item.phone;
    phoneEl.href = 'tel:' + item.phone.replace(/[^\d+]/g, '');
    phoneEl.style.display = 'flex';
  } else if (phoneEl) { phoneEl.style.display = 'none'; }

  // Website
  var linkEl = document.getElementById('aim-official-link');
  if (item.website) {
    linkEl.href = item.website.startsWith('http') ? item.website : 'https://' + item.website;
    linkEl.textContent = '\u{1F310} ' + item.website;
    linkEl.style.display = 'block';
  } else { linkEl.style.display = 'none'; }

  // Reset rating row
  var ratingRow = document.getElementById('aim-rating-row');
  if (ratingRow) ratingRow.style.display = 'none';

  // Reservation buttons: show for restaurants only
  var resRow      = document.getElementById('aim-reservation-row');
  var otBtn       = document.getElementById('aim-opentable-btn');
  var grBtn       = document.getElementById('aim-google-reserve-btn');
  var noResBadge  = document.getElementById('aim-no-res-badge');
  var waitInfo    = document.getElementById('aim-wait-info');
  if (resRow) {
    if (type === 'r') {
      var resName = encodeURIComponent(item.name);
      var resCity = encodeURIComponent(stop.name + ' ' + stop.state);
      // Pre-set URLs; everything hidden until AI responds so there's no flicker
      if (otBtn) { otBtn.href = 'https://www.opentable.com/s/?term=' + resName + '%20' + resCity + '&covers=4'; otBtn.style.display = 'none'; }
      if (grBtn) { grBtn.href = 'https://www.google.com/search?q=' + resName + '+' + resCity + '+reservations'; grBtn.style.display = 'none'; }
      if (noResBadge) noResBadge.style.display = 'none';
      if (waitInfo) waitInfo.style.display = 'none';
      resRow.style.display = 'none';  // hidden until AI metadata arrives
    } else {
      resRow.style.display = 'none';
    }
  }

  var wxR2 = document.getElementById('aim-weather-row'); if (wxR2) wxR2.style.display = 'none';
  _aimResetPhotoStrip();
  document.getElementById('ai-info-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  fetchAimPhotos(item.name + ' ' + stop.name + ' ' + stop.state);
  fetchGeminiInfo(item, stop, type);
}

function closePlaceInfo() {
  document.getElementById('ai-info-modal').classList.add('hidden');
  document.body.style.overflow = '';
}

/* â”€â”€ AI MODAL: PHOTO CAROUSEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _aimResetPhotoStrip() {
  var strip = document.getElementById('aim-photo-strip');
  if (strip) { strip.style.display = 'none'; strip.innerHTML = ''; }
  var facts = document.getElementById('aim-facts-strip');
  if (facts) { facts.style.display = 'none'; facts.innerHTML = ''; }
}

function fetchAimPhotos(searchTerm) {
  var strip = document.getElementById('aim-photo-strip');
  if (!strip) return;
  strip.style.display = 'flex';
  strip.innerHTML = '<div style="padding:14px 0;color:rgba(255,255,255,.5);font-size:.78rem;font-style:italic;">ğŸ“· Loading photosâ€¦</div>';
  var url = 'https://en.wikipedia.org/w/api.php?action=query'
    + '&generator=images&titles=' + encodeURIComponent(searchTerm)
    + '&prop=imageinfo&iiprop=url|size&gimlimit=30'
    + '&format=json&origin=*';
  fetch(url)
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var pages = (data.query && data.query.pages) || {};
      var photos = [];
      Object.keys(pages).forEach(function(k) {
        var p = pages[k];
        if (p.imageinfo && p.imageinfo[0]) {
          var info = p.imageinfo[0];
          var u = info.url || '';
          if (u.match(/\.(jpg|jpeg|png)$/i)
            && !u.match(/[Ii]con|[Ll]ogo|[Ff]lag|[Cc]oat|[Ss]eal|[Mm]ap[^l]|symbol|[Pp]ortrait|[Aa]rrow|Pictogram|Button|[Ss]ign|[Mm]ark|[Bb]adge/i)
            && (info.size || 0) > 40000) {
            photos.push(u);
          }
        }
      });
      _renderAimPhotos(photos.slice(0, 8));
    })
    .catch(function() { _renderAimPhotos([]); });
}

function _renderAimPhotos(photos) {
  var strip = document.getElementById('aim-photo-strip');
  if (!strip) return;
  if (!photos || photos.length === 0) {
    strip.style.display = 'none';
    return;
  }
  strip.style.display = 'flex';
  strip.innerHTML = photos.map(function(url) {
    var safeUrl = url.replace(/'/g, '%27');
    return '<img src="' + url + '" loading="lazy" '
      + 'onclick="openPhotoModalUrl(\'' + safeUrl + '\')" '
      + 'style="height:110px;width:auto;min-width:80px;max-width:200px;object-fit:cover;border-radius:6px;cursor:zoom-in;flex-shrink:0;border:1.5px solid rgba(255,255,255,.15);" '
      + 'onerror="this.style.display=\'none\'" />';
  }).join('');
}

function openPhotoModalUrl(url) {
  var modal = document.getElementById('photo-modal');
  var img   = document.getElementById('photo-modal-img');
  var cap   = document.getElementById('photo-modal-caption');
  if (modal && img) {
    img.src = url;
    if (cap) cap.textContent = '';
    modal.style.display = 'flex';
  }
}

/* â”€â”€ AI MODAL: FUN FACTS STRIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _AIM_FACT_COLORS = ['#E8813A','#2C5F8A','#7B5EA7','#3A8A5C','#D4A017'];
function _renderAimFacts(factsText) {
  var strip = document.getElementById('aim-facts-strip');
  if (!strip || !factsText) return;
  // Parse lines that start with emoji or dash/bullet as facts
  var lines = factsText.split('\n').map(function(l) { return l.trim().replace(/^[-â€¢*]\s*/,''); }).filter(function(l) { return l.length > 10; });
  if (!lines.length) return;
  var html = '<div style="font-size:.72rem;font-weight:900;text-transform:uppercase;letter-spacing:.06em;color:var(--text-2);margin-bottom:8px;">âš¡ Fun Facts</div>'
    + '<div style="display:flex;flex-direction:column;gap:6px;">';
  lines.forEach(function(line, i) {
    var col = _AIM_FACT_COLORS[i % _AIM_FACT_COLORS.length];
    html += '<div style="display:flex;gap:10px;align-items:flex-start;">'
      + '<span style="background:' + col + ';color:#fff;font-weight:900;font-size:.7rem;min-width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;">' + (i+1) + '</span>'
      + '<div style="font-size:.82rem;line-height:1.55;color:var(--text);">' + line + '</div>'
      + '</div>';
  });
  html += '</div>';
  strip.innerHTML = html;
  strip.style.display = 'block';
}

/* â”€â”€ AREA INFO (phase header "Area Info" button) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openAreaInfo(phase, stopId) {
  var pStop = getStop(stopId);
  var modal = document.getElementById('ai-info-modal');
  document.getElementById('aim-title').textContent = phase;
  document.getElementById('aim-sub').textContent   = pStop ? pStop.state : '';
  document.getElementById('aim-address-link').style.display = 'none';
  document.getElementById('aim-phone').style.display = 'none';
  document.getElementById('aim-official-link').style.display = 'none';
  document.getElementById('aim-body').innerHTML = '<div style="text-align:center;padding:30px;color:var(--text-2);font-size:.88rem;">&#128269; Loading area overview&hellip;</div>';
  // Hide restaurant-specific header elements
  var pb = document.getElementById('aim-price-badge'); if (pb) pb.style.display = 'none';
  var planB = document.getElementById('aim-plan-btn'); if (planB) { planB.style.display = 'none'; planB.onclick = null; }
  var rr = document.getElementById('aim-rating-row'); if (rr) rr.style.display = 'none';
  var resR = document.getElementById('aim-reservation-row'); if (resR) resR.style.display = 'none';
  var wxR = document.getElementById('aim-weather-row'); if (wxR) wxR.style.display = 'none'; // hidden by default; openMapStopInfo re-shows
  _aimResetPhotoStrip();
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  var searchTerm = pStop ? pStop.name + ', ' + pStop.state : phase;
  fetchAimPhotos(searchTerm);
  fetchAreaInfo(phase, searchTerm);
}
function fetchAreaInfo(phase, location) {
  var prompt = 'You are an engaging travel writer. Give me a fun, interesting overview of ' + location + ' for a family road trip.\n\n'
    + 'Use EXACT bold headers (no JSON needed, just sections):\n'
    + '**Overview** (3-4 sentences: character, landscape, why it\'s worth visiting)\n'
    + '**History** (3-4 interesting historical facts or surprising trivia)\n'
    + '**By the Numbers** (population, size, elevation, notable records â€” use bullet list)\n'
    + '**Best Time to Visit** (weather, seasons, what March is like)\n'
    + '**Don\'t Miss** (top 3-4 must-see things in the region, brief descriptions)\n'
    + '**For the Kids** (what children love about this area, interactive or memorable)\n'
    + '**Fun Facts** (4-5 surprising one-liner facts, each on its own line starting with an emoji)\n'
    + (function() {
        var ctx = _getPersonalizationContext();
        if (!ctx) return '';
        var prof = getCurrentProfile();
        if (!prof) return '';
        return '**For ' + prof.name + '** (ONLY include this section if there\'s a genuine surprising connection to their interests: ' + (prof.interests||[]).join(', ') + ' â€” e.g. a famous actor from this town, a local connection to their favorite character or hobby. Skip this section entirely if no real connection exists.)\n';
      }())
    + 'Be specific, concise, and engaging. Friendly family tone. No asterisk decorations.'
    + _getPersonalizationContext();
  var body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 800, temperature: 0.75 }
  });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    if (!text) { document.getElementById('aim-body').innerHTML = '<p style="color:var(--red);padding:16px;">Could not load area info.</p>'; return; }
    var _prof3 = getCurrentProfile();
    var _knownArea = { 'Overview':1, 'History':1, 'By the Numbers':1, 'Best Time to Visit':1, 'Don\'t Miss':1, 'For the Kids':1, 'Fun Facts':1 };
    if (_prof3 && _prof3.name) _knownArea['For ' + _prof3.name] = 1;
    var _profColor3 = getCurrentProfile();
    var sectionColors2 = { 'Overview':'#2C5F8A', 'History':'#7B5EA7', 'By the Numbers':'#3A8A5C', 'Best Time to Visit':'#2C5F8A', 'Don\'t Miss':'#E8813A', 'For the Kids':'#3A8A5C', 'Fun Facts':'#7B5EA7' };
    if (_profColor3 && _profColor3.name) sectionColors2['For ' + _profColor3.name] = '#E8813A';
    var rawParts3 = text.split(/\*\*([^*\n]+)\*\*/);
    var sections3 = [];
    var prePart3  = rawParts3[0] || '';
    var quickFactsText = ''; // kept for compat but no longer used separately
    for (var rpi3 = 1; rpi3 < rawParts3.length; rpi3 += 2) {
      var potTitle3 = (rawParts3[rpi3] || '').trim();
      var potBody3  = rawParts3[rpi3 + 1] || '';
      if (_knownArea[potTitle3]) {
        sections3.push({ title: potTitle3, body: potBody3 });
      } else {
        if (sections3.length > 0) { sections3[sections3.length - 1].body += '**' + potTitle3 + '**' + potBody3; }
        else { prePart3 += '**' + potTitle3 + '**' + potBody3; }
      }
    }
    var html3  = '';
    if (prePart3.trim()) html3 += '<p style="margin:0 0 12px;font-size:.88rem;line-height:1.6;color:var(--text-2);">' + prePart3.trim().replace(/\n/g,'<br>') + '</p>';
    for (var si5 = 0; si5 < sections3.length; si5++) {
      var sec3 = sections3[si5];
      // Fun Facts now render in the same card loop as all other sections
      var sBody2 = sec3.body.trim()
        .replace(/\n- /g, '<br>\u2022 ').replace(/\n\* /g, '<br>\u2022 ')
        .replace(/\n/g, '<br>').replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/(?<![=\w])\*(?!\*)/g,'');
      var sColor2 = sectionColors2[sec3.title] || 'var(--blue)';
      html3 += '<div style="margin-bottom:10px;border-radius:8px;overflow:hidden;border:1px solid var(--border);">'
        + '<div style="background:' + sColor2 + ';color:#fff;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;padding:6px 12px;">' + sec3.title + '</div>'
        + '<div style="padding:10px 12px;font-size:.85rem;line-height:1.65;color:var(--text);">' + sBody2 + '</div>'
        + '</div>';
    }
    document.getElementById('aim-body').innerHTML = html3 || '<p style="color:var(--text-2);">No info available.</p>';
    document.getElementById('aim-facts-strip').style.display = 'none'; // strip no longer used
  })
  .catch(function(err) { document.getElementById('aim-body').innerHTML = '<div style="color:var(--red);padding:16px;">Error: ' + (err.message||'Unknown') + '</div>'; });
}

/* â”€â”€ MAP STOP AI OVERVIEW (called from Leaflet popup button) â”€â”€â”€â”€â”€â”€â”€ */
function openMapStopInfo(stopId) {
  var stop = getStop(stopId);
  if (!stop) return;
  /* Close the Leaflet popup first */
  if (window.mainMap) mainMap.closePopup();
  /* Open the AI area info modal */
  openAreaInfo(_sn(stop), stopId);
  /* Inject weather badge into modal header */
  var wx = STOP_WEATHER[stop.id];
  var wxRow = document.getElementById('aim-weather-row');
  if (wx && wxRow) {
    var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stop.id; });
    var firstD   = stopDays[0];
    var visitMon = firstD ? new Date(firstD.date + 'T12:00:00').toLocaleDateString('en-US', { month:'long' }) : 'Visit';
    document.getElementById('aim-wx-icon').textContent  = wx.icon;
    document.getElementById('aim-wx-label').textContent = visitMon + ' Typical Weather';
    document.getElementById('aim-wx-temps').textContent = wx.hi + 'Â°F high Â· ' + wx.lo + 'Â°F low';
    document.getElementById('aim-wx-desc').textContent  = wx.desc;
    wxRow.style.display = 'flex';
  } else if (wxRow) {
    wxRow.style.display = 'none';
  }
}

/* â”€â”€ CAMPGROUND INFO MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function openCampInfo(dayNum) {
  var d = TRIP_DAYS[dayNum - 1];
  if (!d || !d.sleep) return;
  var stop = getStop(d.stopId);
  var campName = d.sleep;
  var loc = stop ? _sn(stop) : d.phase;
  document.getElementById('aim-title').textContent = campName;
  document.getElementById('aim-sub').textContent = '\u26FA ' + loc;
  document.getElementById('aim-address-link').style.display = 'none';
  document.getElementById('aim-phone').style.display = 'none';
  document.getElementById('aim-official-link').style.display = 'none';
  document.getElementById('aim-body').innerHTML = '<div style="text-align:center;padding:36px 20px;color:var(--text-2);font-size:.9rem;">&#129302; Loading campground info\u2026</div>';
  var pb = document.getElementById('aim-price-badge'); if (pb) pb.style.display = 'none';
  var planB = document.getElementById('aim-plan-btn'); if (planB) { planB.style.display = 'none'; planB.onclick = null; }
  var rr = document.getElementById('aim-rating-row'); if (rr) rr.style.display = 'none';
  var resR = document.getElementById('aim-reservation-row'); if (resR) resR.style.display = 'none';
  var wxR3 = document.getElementById('aim-weather-row'); if (wxR3) wxR3.style.display = 'none';
  _aimResetPhotoStrip();
  document.getElementById('ai-info-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  fetchAimPhotos(campName + ' campground ' + loc);
  fetchCampInfo(campName, loc);
}
function fetchCampInfo(campName, location) {
  var _campAmps = (appState.tripSettings && appState.tripSettings.rvAmps) ? appState.tripSettings.rvAmps + '-amp' : '50-amp';
  var prompt = 'You are a helpful RV travel guide. Provide a detailed info page for the campground/RV park "'
    + campName + '" near ' + location + '. Our RV requires ' + _campAmps + ' service.\n\n'
    + 'CRITICAL: Output ONE raw JSON object on its own line first â€” NO markdown fences:\n'
    + '{"address":"full street address","phone":"phone number or empty","website":"url or empty","nightly":"$XX/night or range","hookups":"full/water-electric/dry","amps":"30/50/both or unknown","checkIn":"3pm","checkOut":"11am","googleRating":4.2,"reviewCount":340}\n\n'
    + 'Then output sections with EXACT bold headers:\n'
    + '**Overview** (2-3 sentences: setting, vibe, who it\'s best for)\n'
    + '**Power & Hookups** (does this campground offer 30-amp, 50-amp, or both? Are full hookup sites available? Explicitly note if our ' + _campAmps + ' RV can be accommodated â€” bullet list)\n'
    + '**Check-in & Checkout** (standard check-in time, check-out time, early arrival policy, late checkout options)\n'
    + '**Nearest Laundromat** (name of the closest laundromat to this campground, approximate distance, hours of operation if known)\n'
    + '**Amenities** (bathrooms, showers, pool, WiFi, store, dump station â€” bullet list)\n'
    + '**Site Types** (pull-through, back-in, big-rig friendly, pet policy)\n'
    + '**Reviews** (3 visitor quotes each starting with a star rating like â˜…â˜…â˜…â˜…â˜† then 1-2 sentences)\n'
    + '**Family Tips** (what kids love, nearby activities, playground/pool)\n'
    + '**Insider Tips** (best sites to request, arrival tips, one pro tip)\n'
    + '**Quick Facts** (4 surprising one-liner facts about this campground or nearby area, each on its own line starting with an emoji)\n'
    + 'Friendly, helpful tone. No markdown code fences anywhere.';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:800,temperature:0.6} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    if (!text) { document.getElementById('aim-body').innerHTML = '<div style="color:var(--red);padding:16px;">Could not load campground info.</div>'; return; }
    text = text.replace(/```json\s*/gi,'').replace(/```\s*/g,'');
    var addrEl = document.getElementById('aim-address-link'); var addrTxt = document.getElementById('aim-address-text');
    var phoneEl = document.getElementById('aim-phone'); var phoneTxt = document.getElementById('aim-phone-text');
    var linkEl = document.getElementById('aim-official-link');
    var jsonStr = null;
    var jlm = text.match(/^[ \t]*(\{[^\n}][^\n]*\})/m);
    var jbm = text.match(/(\{[\s\S]*?\})/);
    if (jlm) { jsonStr = jlm[1]; text = text.replace(jlm[0],'').trim(); }
    else if (jbm) { jsonStr = jbm[1]; text = text.replace(jbm[0],'').trim(); }
    if (jsonStr) {
      try {
        var meta = JSON.parse(jsonStr);
        if (meta.address && addrEl) { addrTxt.textContent = meta.address; addrEl.href = 'https://maps.google.com/?q='+encodeURIComponent(meta.address); addrEl.style.display='flex'; }
        if (meta.phone && phoneEl) { phoneTxt.textContent = meta.phone; phoneEl.href = 'tel:'+meta.phone.replace(/[^\d+]/g,''); phoneEl.style.display='flex'; }
        if (meta.website && linkEl) { linkEl.href = meta.website.startsWith('http')?meta.website:'https://'+meta.website; linkEl.textContent = '\u{1F310} '+meta.website; linkEl.style.display='block'; }
        if (meta.nightly) { var pb2=document.getElementById('aim-price-badge'); if(pb2){pb2.textContent=meta.nightly;pb2.style.display='inline-block';} }
        if (meta.googleRating) {
          var rr2=document.getElementById('aim-rating-row'),rs2=document.getElementById('aim-rating-stars'),rn2=document.getElementById('aim-rating-num'),rc2=document.getElementById('aim-rating-source');
          if(rr2&&rs2){var r2=parseFloat(meta.googleRating),sh2=''; for(var ri3=0;ri3<5;ri3++)sh2+=ri3<Math.round(r2)?'\u2605':'\u2606'; rs2.textContent=sh2; rn2.textContent=r2.toFixed(1); if(meta.reviewCount&&rc2)rc2.textContent='\u00b7 '+Number(meta.reviewCount).toLocaleString()+' reviews \u00b7 Google'; rr2.style.display='flex'; }
        }
      } catch(e2) {}
    }
    var campColors={'Overview':'#2C5F8A','Power & Hookups':'#E65100','Check-in & Checkout':'#1565C0','Nearest Laundromat':'#3A8A5C','Amenities':'#3A8A5C','Site Types':'#7B5EA7','Reviews':'#E8813A','Family Tips':'#3A8A5C','Insider Tips':'#8A2C7B','Quick Facts':'#7B5EA7'};
    var _knownCamp={'Overview':1,'Power & Hookups':1,'Check-in & Checkout':1,'Nearest Laundromat':1,'Amenities':1,'Site Types':1,'Reviews':1,'Family Tips':1,'Insider Tips':1,'Quick Facts':1};
    var rp4=text.split(/\*\*([^*\n]+)\*\*/); var sc4=[]; var pp4=rp4[0]||''; var campFactsText='';
    for(var ri4=1;ri4<rp4.length;ri4+=2){var pt4=(rp4[ri4]||'').trim(),pb4c=rp4[ri4+1]||''; if(_knownCamp[pt4])sc4.push({title:pt4,body:pb4c}); else{if(sc4.length>0)sc4[sc4.length-1].body+='**'+pt4+'**'+pb4c;else pp4+='**'+pt4+'**'+pb4c;}}
    var h4=''; if(pp4.trim())h4+='<p style="margin:0 0 12px;font-size:.87rem;line-height:1.6;color:var(--text-2);">'+pp4.trim().replace(/\n/g,'<br>')+'</p>';
    for(var si7=0;si7<sc4.length;si7++){var s4=sc4[si7]; if(s4.title==='Quick Facts'){campFactsText=s4.body;continue;} var sb4=s4.body.trim().replace(/\n- /g,'<br>\u2022 ').replace(/\n\* /g,'<br>\u2022 ').replace(/\n/g,'<br>').replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/(?<![=\w])\*(?!\*)/g,''),sc4c=campColors[s4.title]||'#2C5F8A'; h4+='<div style="margin-bottom:10px;border-radius:12px;overflow:hidden;border:1px solid var(--border);"><div style="background:'+sc4c+';color:#fff;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;padding:6px 12px;">'+s4.title+'</div><div style="padding:10px 12px;font-size:.84rem;line-height:1.7;color:var(--text);">'+sb4+'</div></div>';}
    document.getElementById('aim-body').innerHTML = h4||'<p style="color:var(--text-2);">No info available.</p>';
    if(campFactsText) _renderAimFacts(campFactsText);
  })
  .catch(function(){ document.getElementById('aim-body').innerHTML='<div style="color:var(--red);padding:16px;">Error loading campground info.</div>'; });
}

/* â”€â”€ EVENTS NEAR A STOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _stopEventsLoaded = {};  // cache so we don't re-fetch on every expand

function toggleStopEvents(stopId) {
  var panel = document.getElementById('stop-events-panel-' + stopId);
  if (!panel) return;
  var isHidden = panel.classList.contains('hidden');
  panel.classList.toggle('hidden');
  if (isHidden && !_stopEventsLoaded[stopId]) {
    _stopEventsLoaded[stopId] = true;
    loadStopEvents(stopId);
  }
}

function loadStopEvents(stopId) {
  var evBody = document.getElementById('stop-events-body-' + stopId);
  if (!evBody) return;
  var stop = getStop(stopId);
  if (!stop) return;

  evBody.innerHTML = '<div style="padding:18px;text-align:center;color:var(--text-2);font-size:.84rem;">'
    + '<i class="fa-solid fa-spinner fa-spin" style="margin-right:6px;"></i>Searching events near ' + stop.name + 'â€¦</div>';

  var now = new Date();
  var dateStr = now.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  // Find the date range this stop is visited
  var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
  var arrivalDate = stopDays.length > 0 ? stopDays[0].date : '';
  var departDate  = stopDays.length > 0 ? stopDays[stopDays.length - 1].date : '';
  var dateContext = arrivalDate
    ? ' We\'ll be visiting around ' + formatDate(arrivalDate) + (departDate !== arrivalDate ? ' through ' + formatDate(departDate) : '') + '.'
    : '';

  var visitRange = '';
  if (arrivalDate) {
    visitRange = ' We will be there ' + formatDate(arrivalDate) + (departDate && departDate !== arrivalDate ? ' through ' + formatDate(departDate) : '') + '.';
  }

  var prompt = 'You are a local events guide. List 5 real, specific family-friendly events '
    + 'near ' + _sn(stop) + ' that typically happen during '
    + (arrivalDate ? formatDate(arrivalDate) : 'spring') + '.'
    + visitRange
    + ' We have kids ages 2, 4, and 9. Include annual festivals, fairs, farmers markets, '
    + 'concerts, cultural events, park programs, and seasonal celebrations that are well-known '
    + 'for this region and time of year.\n\n'
    + 'OUTPUT FORMAT â€” respond with ONLY these lines, no intro, no explanation:\n'
    + 'EVENT: [Full event name]\n'
    + 'DATE: [Typical dates or month, e.g. "Late March" or "Mar 22-24"]\n'
    + 'WHERE: [Venue name and city]\n'
    + 'INFO: [One sentence describing it and why it is good for families]\n'
    + '---\n'
    + 'Repeat the EVENT/DATE/WHERE/INFO/--- block for each of the 5 events. '
    + 'Do not include any text outside these blocks.';

  var body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 700, temperature: 0.4 }
  });

  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    if (!text) {
      evBody.innerHTML = '<div style="padding:14px 16px;color:var(--text-2);font-size:.84rem;">Could not load events â€” try again later.</div>';
      return;
    }

    // Parse structured EVENT/DATE/WHERE/INFO blocks
    var blocks = text.split('---');
    var eventHtml = '';
    var eventCount = 0;
    var evEmojis = ['ğŸ‰','ğŸ¶','ğŸª','ğŸŒŸ','ğŸ¡','ğŸ­','ğŸŠ','ğŸˆ'];

    blocks.forEach(function(block) {
      var evName  = (block.match(/EVENT:\s*(.+)/i) || [])[1];
      var evDate  = (block.match(/DATE:\s*(.+)/i) || [])[1];
      var evWhere = (block.match(/WHERE:\s*(.+)/i) || [])[1];
      var evInfo  = (block.match(/INFO:\s*(.+)/i) || [])[1];
      if (!evName) return;
      evName = evName.trim(); evDate = (evDate||'').trim();
      evWhere = (evWhere||'').trim(); evInfo = (evInfo||'').trim();

      var em = evEmojis[eventCount % evEmojis.length];
      var planId = 'ev_' + stopId + '_' + eventCount;
      var isPlanned = appState.plannedEvents && appState.plannedEvents[planId];

      eventHtml += '<div style="display:flex;gap:11px;padding:12px 14px;'
        + (eventCount > 0 ? 'border-top:1px solid var(--border);' : '')
        + 'align-items:flex-start;">'
        + '<span style="font-size:1.3rem;flex-shrink:0;line-height:1.2">' + em + '</span>'
        + '<div style="min-width:0;flex:1;">'
        + '<div style="font-weight:700;font-size:.87rem;color:var(--text);line-height:1.3;margin-bottom:2px;">' + evName + '</div>'
        + (evDate  ? '<div style="font-size:.74rem;color:var(--orange);font-weight:700;margin-bottom:1px;">ğŸ“… ' + evDate + '</div>' : '')
        + (evWhere ? '<div style="font-size:.74rem;color:var(--blue);font-weight:600;margin-bottom:3px;">ğŸ“ ' + evWhere + '</div>' : '')
        + (evInfo  ? '<div style="font-size:.79rem;color:var(--text-2);line-height:1.45;margin-bottom:6px;">' + evInfo + '</div>' : '')
        + '<button id="ev-plan-btn-' + planId + '" onclick="planStopEvent(\'' + planId + '\',\'' + evName.replace(/'/g,"\\'") + '\',' + stopId + ')" '
        + 'style="background:' + (isPlanned ? 'var(--green)' : 'var(--orange-l)') + ';color:' + (isPlanned ? '#fff' : 'var(--orange)') + ';border:1px solid ' + (isPlanned ? 'var(--green)' : 'var(--orange)') + ';border-radius:100px;padding:4px 12px;font-size:.73rem;font-weight:800;cursor:pointer;font-family:var(--font);">'
        + (isPlanned ? 'âœ… Planned' : '+ Add to Plan') + '</button>'
        + '</div></div>';
      eventCount++;
    });

    if (eventCount === 0) {
      // Fallback: render plain text
      evBody.innerHTML = '<div style="padding:12px 16px;font-size:.83rem;color:var(--text-2);line-height:1.6;">'
        + text.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>') + '</div>';
    } else {
      evBody.innerHTML = eventHtml;
    }

    var evBtn = document.getElementById('stop-events-btn-' + stopId);
    if (evBtn && eventCount > 0) evBtn.innerHTML = '<i class="fa-solid fa-calendar-star"></i> Events (' + eventCount + ')';
  })
  .catch(function() {
    evBody.innerHTML = '<div style="padding:14px 16px;color:var(--red);font-size:.84rem;">Couldn\'t load events â€” check your connection.</div>';
  });
}

function planStopEvent(planId, evName, stopId) {
  if (!appState.plannedEvents) appState.plannedEvents = {};
  if (appState.plannedEvents[planId]) {
    delete appState.plannedEvents[planId];
    showToast('Removed from plan', 1600);
  } else {
    appState.plannedEvents[planId] = { name: evName, stopId: stopId, addedAt: Date.now() };
    showToast('âœ… ' + evName + ' added to plan!', 2200);
  }
  saveState();
  // Toggle the button appearance in-place
  var btn = document.getElementById('ev-plan-btn-' + planId);
  if (btn) {
    var isNowPlanned = !!appState.plannedEvents[planId];
    btn.textContent = isNowPlanned ? 'âœ… Planned' : '+ Add to Plan';
    btn.style.background = isNowPlanned ? 'var(--green)' : 'var(--orange-l)';
    btn.style.color = isNowPlanned ? '#fff' : 'var(--orange)';
    btn.style.borderColor = isNowPlanned ? 'var(--green)' : 'var(--orange)';
  }
}

function fetchGeminiInfo(item, stop, type) {
  var typeLabel = type === 'r' ? 'restaurant' : 'attraction';
  var loc = _sn(stop);
  var isRest = type === 'r';

  var prompt = 'You are a knowledgeable travel guide. Create a detailed info page for '
    + item.name + ' (' + typeLabel + ') near ' + loc + '. Family with kids aged 2, 4, 9.\n\n'
    + 'CRITICAL: Output ONE raw JSON object on its own line first â€” NO markdown fences, NO ```json:\n'
    + (isRest
      ? '{"address":"full street address","phone":"phone or empty","priceRange":"$ or $$ or $$$","takesReservations":true,"opentable":false,"avgWait":"15-20 min or empty","googleRating":4.3,"reviewCount":1250}\n\n'
      : '{"address":"full street address","phone":"phone or empty","priceRange":"$ or $$ or $$$","googleRating":4.5,"reviewCount":800}\n\n')
    + 'Use actual true/false booleans, actual numbers for rating/reviewCount. For opentable: set true ONLY if you are 100% certain this specific restaurant is actively bookable on OpenTable right now â€” default to false for local/small restaurants.\n\n'
    + 'Then output sections with EXACT bold headers on their own lines. '
    + 'IMPORTANT: Within section bodies, do NOT use **bold** for sub-items â€” use plain text or bullet dashes only.\n'
    + '**Overview** (2-3 sentences: vibe, what makes it special)\n'
    + (isRest
      ? '**Hours & Contact** (hours by day, price range)\n'
        + '**Menu Highlights** (list 4-5 must-try dishes as plain "- Item name: short description". '
        + 'End with a line starting "Kids Menu:" listing 2-3 kid options. No bold on item names.)\n'
        + '**Reservations** (do they take reservations? OpenTable available? Walk-in wait times? Booking tips.)\n'
      : '**Hours & Admission** (hours, ticket prices adults/kids, free options)\n'
        + '**What to See & Do** (top 3-5 specific highlights, plain bullet list)\n')
    + '**Reviews** (3 real-feeling visitor quotes, each starting with star rating like â˜…â˜…â˜…â˜…â˜† then 1-2 sentences)\n'
    + '**With Young Kids** (stroller access, toddler tips, what kids love)\n'
    + '**Insider Tips** (best time to visit, what to skip, one pro tip)\n'
    + '**Quick Facts** (4 surprising one-liner facts about this place, each on its own line starting with an emoji)\n'
    + 'Concise, accurate, friendly tone. No markdown code fences anywhere.';

  var body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 900, temperature: 0.7 }
  });

  fetch(GEMINI_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: body
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = '';
    try { text = data.candidates[0].content.parts[0].text || ''; } catch(e) {}
    if (!text) {
      var _apiErr = '';
      try {
        if (data.error) _apiErr = data.error.message || JSON.stringify(data.error);
        else if (data.promptFeedback && data.promptFeedback.blockReason) _apiErr = 'Blocked: ' + data.promptFeedback.blockReason;
        else if (data.candidates && data.candidates[0] && data.candidates[0].finishReason) _apiErr = 'Finish reason: ' + data.candidates[0].finishReason;
        else _apiErr = JSON.stringify(data).substring(0, 300);
      } catch(e2) {}
      document.getElementById('aim-body').innerHTML = '<div style="color:var(--red);padding:16px;line-height:1.6;">Could not load info.<br><small style="color:var(--text-3);font-size:.78rem;word-break:break-all;">' + (_apiErr || 'Empty response from API') + '</small></div>';
      return;
    }

    // â”€â”€ Strip any markdown code fences Gemini may add â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    text = text.replace(/```json\s*/gi, '').replace(/```\s*/g, '');

    // â”€â”€ Extract JSON metadata â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var addrEl   = document.getElementById('aim-address-link');
    var addrTxt  = document.getElementById('aim-address-text');
    var phoneEl  = document.getElementById('aim-phone');
    var phoneTxt = document.getElementById('aim-phone-text');

    var jsonStr  = null;
    var jsonLineMatch = text.match(/^[ \t]*(\{[^\n}][^\n]*\})/m);  // single-line JSON
    var jsonBlockMatch = text.match(/(\{[\s\S]*?\})/);              // fallback: first { } block
    if (jsonLineMatch)       { jsonStr = jsonLineMatch[1]; text = text.replace(jsonLineMatch[0], '').trim(); }
    else if (jsonBlockMatch) { jsonStr = jsonBlockMatch[1]; text = text.replace(jsonBlockMatch[0], '').trim(); }

    if (jsonStr) {
      try {
        var meta = JSON.parse(jsonStr);

        // Address
        if (meta.address && addrEl && addrEl.style.display === 'none') {
          addrTxt.textContent = meta.address;
          addrEl.href = 'https://maps.google.com/?q=' + encodeURIComponent(meta.address);
          addrEl.style.display = 'flex';
        }
        // Phone
        if (meta.phone && phoneEl && phoneEl.style.display === 'none') {
          phoneTxt.textContent = meta.phone;
          phoneEl.href = 'tel:' + meta.phone.replace(/[^\d+]/g, '');
          phoneEl.style.display = 'flex';
        }
        // Rating stars
        if (meta.googleRating) {
          var ratingRow2  = document.getElementById('aim-rating-row');
          var ratingStars = document.getElementById('aim-rating-stars');
          var ratingNum   = document.getElementById('aim-rating-num');
          var ratingSrc   = document.getElementById('aim-rating-source');
          if (ratingRow2 && ratingStars) {
            var r = parseFloat(meta.googleRating);
            var starsHtml = '';
            for (var ri2 = 0; ri2 < 5; ri2++) {
              starsHtml += ri2 < Math.round(r) ? '\u2605' : '\u2606';
            }
            ratingStars.textContent = starsHtml;
            ratingNum.textContent = r.toFixed(1);
            if (meta.reviewCount && ratingSrc) {
              ratingSrc.textContent = 'Â· ' + Number(meta.reviewCount).toLocaleString() + ' reviews Â· Google';
            }
            ratingRow2.style.display = 'flex';
          }
        }
        // Restaurant-only: OpenTable, walk-in badge, avg wait
        if (type === 'r') {
          var noResBadge2 = document.getElementById('aim-no-res-badge');
          var waitInfo2   = document.getElementById('aim-wait-info');
          var otBtn2      = document.getElementById('aim-opentable-btn');
          var grBtn2      = document.getElementById('aim-google-reserve-btn');
          var resRow2     = document.getElementById('aim-reservation-row');

          if (meta.takesReservations === false) {
            // Walk-in only
            if (otBtn2) otBtn2.style.display = 'none';
            if (grBtn2) grBtn2.style.display = 'none';
            if (noResBadge2) noResBadge2.style.display = 'inline-flex';
          } else {
            // Takes reservations
            if (meta.opentable === true && otBtn2) otBtn2.style.display = 'inline-flex';
            // Show Google reservations link as fallback
            if (grBtn2) grBtn2.style.display = 'inline-flex';
          }
          // Avg wait (walk-ins or general wait)
          if (meta.avgWait && meta.avgWait.length > 0 && waitInfo2) {
            waitInfo2.textContent = '\u23F1 ~' + meta.avgWait + ' wait';
            waitInfo2.style.display = 'inline-flex';
            waitInfo2.style.alignItems = 'center';
          }
          // Now reveal the reservation row â€” no flicker since it was hidden until now
          if (resRow2) resRow2.style.display = 'flex';
        }
      } catch(e2) {}
    }

    // â”€â”€ Section rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Known section titles â€” bold text NOT in this list stays as inline content
    var _knownSections = {
      'Overview':1, 'Hours & Contact':1, 'Hours & Admission':1,
      'Menu Highlights':1, 'What to See & Do':1, 'Reviews':1,
      'With Young Kids':1, 'Insider Tips':1,
      'Reservations':1, 'Reservations & Wait':1, 'Quick Facts':1
    };
    var sectionColors = {
      'Overview': '#2C5F8A', 'Hours & Contact': '#3A8A5C',
      'Hours & Admission': '#3A8A5C', 'Menu Highlights': '#C96820',
      'What to See & Do': '#7B5EA7', 'Reviews': '#E8813A',
      'With Young Kids': '#3A8A5C', 'Insider Tips': '#8A2C7B',
      'Reservations': '#1a5276', 'Reservations & Wait': '#1a5276', 'Quick Facts': '#7B5EA7'
    };

    // Split on ALL bold patterns, then re-merge non-section titles back into content
    var rawParts = text.split(/\*\*([^*\n]+)\*\*/);
    var sections = [];
    var prePart  = rawParts[0] || '';
    for (var rpi = 1; rpi < rawParts.length; rpi += 2) {
      var potTitle = (rawParts[rpi] || '').trim();
      var potBody  = rawParts[rpi + 1] || '';
      if (_knownSections[potTitle]) {
        sections.push({ title: potTitle, body: potBody });
      } else {
        // Not a section header â€” treat as bold inline text in previous section's body
        if (sections.length > 0) {
          sections[sections.length - 1].body += '**' + potTitle + '**' + potBody;
        } else {
          prePart += '**' + potTitle + '**' + potBody;
        }
      }
    }

    var html2 = '';
    var placeFactsText = '';
    if (prePart.trim()) {
      html2 += '<p style="margin:0 0 12px;font-size:.87rem;line-height:1.6;color:var(--text-2);">' + prePart.trim().replace(/\n/g,'<br>') + '</p>';
    }
    for (var si4 = 0; si4 < sections.length; si4++) {
      var sec = sections[si4];
      if (sec.title === 'Quick Facts') { placeFactsText = sec.body; continue; }
      var secBody = sec.body.trim()
        .replace(/\n- /g,  '<br>\u2022 ')
        .replace(/\n\* /g, '<br>\u2022 ')
        .replace(/\n/g, '<br>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/(?<![=\w])\*(?!\*)/g, '');
      var secColor = sectionColors[sec.title] || '#2C5F8A';
      html2 += '<div style="margin-bottom:10px;border-radius:8px;overflow:hidden;border:1px solid var(--border);">'
        + '<div style="background:' + secColor + ';color:#fff;font-size:.72rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;padding:6px 12px;">' + sec.title + '</div>'
        + '<div style="padding:10px 12px;font-size:.84rem;line-height:1.7;color:var(--text);">' + secBody + '</div>'
        + '</div>';
    }
    document.getElementById('aim-body').innerHTML = html2 || '<p style="color:var(--text-2);">No info available.</p>';
    if (placeFactsText) _renderAimFacts(placeFactsText);
  })
  .catch(function(err) {
    document.getElementById('aim-body').innerHTML = '<div style="color:var(--red);padding:16px;">Error: ' + (err.message || 'Unknown error') + '</div>';
  });
}


/* â”€â”€ WEATHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _weatherLoaded = false;

function wxIcon(code) {
  if (code == null) return '';
  if (code === 0)   return '&#9728;&#65039;'; // â˜€ï¸
  if (code <= 3)    return '&#9925;';         // â›…
  if (code <= 48)   return '&#127787;&#65039;'; // ğŸŒ«ï¸
  if (code <= 67)   return '&#127783;&#65039;'; // ğŸŒ§ï¸
  if (code <= 77)   return '&#10052;&#65039;';  // â„ï¸
  if (code <= 82)   return '&#127782;&#65039;'; // ğŸŒ¦ï¸
  return '&#9928;&#65039;'; // â›ˆï¸
}

function wxChipInner(wx) {
  /* Returns just the inner HTML (no outer span) so applyWeatherToSchedule can
     set it on the existing span without creating a double-pill. */
  if (!wx) return '';
  if (wx.type === 'typical') {
    return wx.high + '&deg;/' + wx.low + '&deg; <span style="font-size:.65rem;opacity:.75;font-weight:600;">(typical)</span>';
  }
  return wxIcon(wx.code) + ' ' + wx.high + '&deg;/' + wx.low + '&deg;';
}
function wxChip(wx) {
  /* Full pill span â€” used in places that need standalone rendering. */
  if (!wx) return '';
  if (wx.type === 'typical') {
    return '<span style="font-size:.72rem;color:var(--text-3);">' + wxChipInner(wx) + '</span>';
  }
  return '<span class="wx-chip wx-forecast">' + wxChipInner(wx) + '</span>';
}

function applyWeatherToSchedule() {
  for (var i = 0; i < TRIP_DAYS.length; i++) {
    var d  = TRIP_DAYS[i];
    var el = document.getElementById('wx-d-' + d.day);
    if (!el) continue;
    var wx = appState.weather && appState.weather[d.stopId] && appState.weather[d.stopId][d.date];
    if (wx) {
      if (wx.type === 'typical') {
        /* Plain text for far-out days â€” no pill */
        el.className = '';
        el.style.cssText = 'font-size:.72rem;color:var(--text-3);text-align:right;white-space:nowrap;';
      } else {
        /* Forecast pill */
        el.className = 'wx-chip wx-forecast';
        el.style.cssText = 'text-align:right;';
      }
      el.innerHTML = wxChipInner(wx); // no nested span!
    }
  }
}

function loadWeather() {
  if (_weatherLoaded) return;
  _weatherLoaded = true;
  if (!appState.weather) appState.weather = {};

  var today   = new Date();
  var cutoff  = new Date(today);
  cutoff.setDate(cutoff.getDate() + 16);
  var cutoffStr = cutoff.toISOString().slice(0, 10);

  TRIP_STOPS.forEach(function(stop) {
    var sid = stop.id;
    if (!appState.weather[sid]) appState.weather[sid] = {};

    var stopDays = TRIP_DAYS.filter(function(d) { return d.stopId === sid; });
    if (!stopDays.length) return;
    var firstDate = stopDays[0].date;
    var lastDate  = stopDays[stopDays.length - 1].date;

    /* --- Archive: 2025 historical data for "typical" temps --- */
    var archStart = firstDate.replace('2026-', '2025-');
    var archEnd   = lastDate.replace('2026-', '2025-');
    var archUrl   = 'https://archive-api.open-meteo.com/v1/archive?latitude=' + stop.lat
      + '&longitude=' + stop.lng
      + '&start_date=' + archStart + '&end_date=' + archEnd
      + '&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&timezone=auto';

    fetch(archUrl)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (!data.daily || !data.daily.time) return;
        for (var di = 0; di < data.daily.time.length; di++) {
          var tripDate = data.daily.time[di].replace('2025-', '2026-');
          if (!appState.weather[sid][tripDate]) {
            appState.weather[sid][tripDate] = {
              high: Math.round(data.daily.temperature_2m_max[di]),
              low:  Math.round(data.daily.temperature_2m_min[di]),
              type: 'typical'
            };
          }
        }
        applyWeatherToSchedule();
      })
      .catch(function() {});

    /* --- Forecast: only for stops whose days are within 16-day window --- */
    if (firstDate <= cutoffStr) {
      var fUrl = 'https://api.open-meteo.com/v1/forecast?latitude=' + stop.lat
        + '&longitude=' + stop.lng
        + '&daily=temperature_2m_max,temperature_2m_min,weathercode'
        + '&temperature_unit=fahrenheit&timezone=auto&forecast_days=16';

      fetch(fUrl)
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.daily || !data.daily.time) return;
          for (var di = 0; di < data.daily.time.length; di++) {
            var fDate = data.daily.time[di];
            if (fDate >= firstDate && fDate <= lastDate) {
              appState.weather[sid][fDate] = {
                high: Math.round(data.daily.temperature_2m_max[di]),
                low:  Math.round(data.daily.temperature_2m_min[di]),
                code: data.daily.weathercode ? data.daily.weathercode[di] : null,
                type: 'forecast'
              };
            }
          }
          applyWeatherToSchedule();
        })
        .catch(function() {});
    }
  });
}

/* â”€â”€ TRIP START + GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function geoDistance(lat1, lon1, lat2, lon2) {
  var R = 3958.8;
  var dLat = (lat2 - lat1) * Math.PI / 180;
  var dLon = (lon2 - lon1) * Math.PI / 180;
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2)
        + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180)
        * Math.sin(dLon / 2) * Math.sin(dLon / 2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
}

function updateHeaderMiles() {
  var el  = document.getElementById('hdr-miles');
  var lbl = document.getElementById('hdr-miles-lbl');
  if (!el) return;
  if (!appState.tripStarted) {
    el.textContent  = '0';
    if (lbl) lbl.textContent = 'mi driven';
    return;
  }
  var driven = 0;
  var dayNum = tripDay();
  for (var i = 0; i < Math.min(dayNum, TRIP_DAYS.length); i++) {
    driven += TRIP_DAYS[i].miles;
  }
  el.textContent  = driven.toLocaleString();
  if (lbl) lbl.textContent = 'mi driven';
}

function startTrip() {
  function doStart(note) {
    appState.tripStarted = true;
    appState.tripStartTime = new Date().toISOString();
    saveState(appState);
    updateHeaderMiles();
    renderDashboard();
    showToast('ğŸš Trip started! ' + (note || ''), 3500);
  }
  if (!navigator.geolocation) { doStart('(GPS unavailable)'); return; }
  showToast('ğŸ“ Getting GPS locationâ€¦', 2000);
  /* Use the first stop's coordinates as the departure point for GPS proximity check */
  var _gpsStop = TRIP_STOPS.length ? TRIP_STOPS[0] : null;
  var _gpsLat  = (_gpsStop && _gpsStop.lat) ? _gpsStop.lat : 41.2559;
  var _gpsLng  = (_gpsStop && _gpsStop.lng) ? _gpsStop.lng : -74.3593;
  var _gpsName = _tripStartCity();
  navigator.geolocation.getCurrentPosition(
    function(pos) {
      var distMi = geoDistance(pos.coords.latitude, pos.coords.longitude, _gpsLat, _gpsLng);
      var note = distMi < 30
        ? 'âœ… GPS: you\'re near ' + _gpsName + ' â€” let\'s go!'
        : 'ğŸ“ GPS acquired (' + distMi.toFixed(0) + ' mi from ' + _gpsName + ')';
      doStart(note);
    },
    function() { doStart('(GPS unavailable â€” started anyway)'); }
  );
}

/* â”€â”€ FUN TAB SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _funTab = 'games';
function renderFun() {
  var el = document.getElementById('fun-content');
  if (!el) return;
  var tabs = [
    { id:'games',  icon:'ğŸ®', label:'Games'        },
    { id:'states', icon:'ğŸ—ºï¸', label:'State Badges' },
    { id:'trivia', icon:'ğŸ§ ', label:'Trivia'        }
  ];
  var bar = '<div class="section-sub-bar">';
  tabs.forEach(function(t) {
    bar += '<button class="section-sub-btn' + (_funTab===t.id?' active':'') + '" onclick="setFunTab(\'' + t.id + '\')">' + t.icon + ' ' + t.label + '</button>';
  });
  bar += '</div><div id="fun-sub-content"></div>';
  el.innerHTML = bar;
  _renderFunSub();
}
function setFunTab(tab) { _funTab = tab; renderFun(); }
function _renderFunSub() {
  var el = document.getElementById('fun-sub-content');
  if (!el) return;
  if (_funTab === 'games')  { renderGames();  }
  if (_funTab === 'states') { renderStates(); }
  if (_funTab === 'trivia') { renderTrivia(); }
}

/* â”€â”€ STATE BADGE COLLECTOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var US_STATES = [
  /* Northeast */
  {a:'ME',n:'Maine'},{a:'NH',n:'New Hampshire'},{a:'VT',n:'Vermont'},
  {a:'MA',n:'Massachusetts'},{a:'RI',n:'Rhode Island'},{a:'CT',n:'Connecticut'},
  {a:'NY',n:'New York'},{a:'NJ',n:'New Jersey'},{a:'PA',n:'Pennsylvania'},
  {a:'DE',n:'Delaware'},{a:'MD',n:'Maryland'},
  /* Southeast */
  {a:'VA',n:'Virginia'},{a:'WV',n:'West Virginia'},{a:'NC',n:'N. Carolina'},
  {a:'SC',n:'S. Carolina'},{a:'GA',n:'Georgia'},{a:'FL',n:'Florida'},
  {a:'TN',n:'Tennessee'},{a:'KY',n:'Kentucky'},{a:'AL',n:'Alabama'},
  {a:'MS',n:'Mississippi'},{a:'AR',n:'Arkansas'},{a:'LA',n:'Louisiana'},
  /* Midwest */
  {a:'OH',n:'Ohio'},{a:'IN',n:'Indiana'},{a:'MI',n:'Michigan'},
  {a:'WI',n:'Wisconsin'},{a:'MN',n:'Minnesota'},{a:'IA',n:'Iowa'},
  {a:'MO',n:'Missouri'},{a:'IL',n:'Illinois'},{a:'ND',n:'N. Dakota'},
  {a:'SD',n:'S. Dakota'},{a:'NE',n:'Nebraska'},{a:'KS',n:'Kansas'},
  /* South / Central */
  {a:'TX',n:'Texas'},{a:'OK',n:'Oklahoma'},
  /* Mountain */
  {a:'MT',n:'Montana'},{a:'ID',n:'Idaho'},{a:'WY',n:'Wyoming'},
  {a:'CO',n:'Colorado'},{a:'UT',n:'Utah'},{a:'NV',n:'Nevada'},
  {a:'AZ',n:'Arizona'},{a:'NM',n:'New Mexico'},
  /* Pacific */
  {a:'WA',n:'Washington'},{a:'OR',n:'Oregon'},{a:'CA',n:'California'},
  {a:'AK',n:'Alaska'},{a:'HI',n:'Hawaii'}
];
/* States on the Maass 2026 route */
var ROUTE_STATES = {NY:1,NJ:1,PA:1,MD:1,VA:1,NC:1,TN:1,AR:1,MO:1,OK:1,TX:1,NM:1,AZ:1,UT:1,CO:1,KS:1};

function renderStates() {
  var el = document.getElementById('fun-sub-content');
  if (!el) return;
  if (!appState.visitedStates) appState.visitedStates = {};
  var visited = Object.keys(appState.visitedStates).length;
  var html = '';

  /* Header */
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">'
    + '<h2 class="section-title" style="margin:0;">ğŸ—ºï¸ State Badge Collector</h2>'
    + '<div style="text-align:right;">'
    + '<div style="font-size:1.5rem;font-weight:900;color:var(--blue);">' + visited + '<span style="font-size:.9rem;color:var(--text-3)">/50</span></div>'
    + '<div style="font-size:.72rem;color:var(--text-3);">states collected</div>'
    + '</div>'
    + '</div>';

  /* Progress bar */
  var pct = Math.round(visited / 50 * 100);
  html += '<div style="background:var(--border);border-radius:10px;height:10px;margin-bottom:6px;overflow:hidden;">'
    + '<div style="background:linear-gradient(90deg,var(--green),var(--blue));height:100%;border-radius:10px;width:' + pct + '%;transition:width .5s;"></div>'
    + '</div>'
    + '<div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--text-3);margin-bottom:18px;">'
    + '<span style="display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;background:var(--green-l);border:1.5px solid var(--green);border-radius:3px;display:inline-block;"></span>Visited</span>'
    + '<span style="display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;background:var(--blue-l);border:1.5px solid var(--blue);border-radius:3px;display:inline-block;"></span>On your route</span>'
    + '<span style="display:flex;align-items:center;gap:5px;"><span style="width:10px;height:10px;background:#f5f5f2;border:1.5px solid #e0e0d8;border-radius:3px;display:inline-block;"></span>Not yet</span>'
    + '</div>';

  /* State grid */
  html += '<div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center;">';
  US_STATES.forEach(function(s) {
    var v = !!appState.visitedStates[s.a];
    var cls = v ? 'visited' : (ROUTE_STATES[s.a] ? 'on-route' : 'unvisited');
    var textCol = v ? 'var(--green)' : (ROUTE_STATES[s.a] ? 'var(--blue)' : 'var(--text-3)');
    html += '<div class="state-badge ' + cls + '" onclick="toggleState(\'' + s.a + '\')" title="' + s.n + '">'
      + (v ? '<span style="font-size:.8rem;position:absolute;top:3px;right:4px;">âœ…</span>' : '')
      + '<div class="state-abbr" style="color:' + textCol + ';">' + s.a + '</div>'
      + '<div class="state-name" style="color:' + textCol + ';opacity:.75;">' + s.n + '</div>'
      + '</div>';
  });
  html += '</div>';

  /* Route states reminder */
  html += '<div style="background:var(--blue-l);border:1.5px solid var(--blue);border-radius:12px;padding:12px 14px;margin-top:18px;">'
    + '<div style="font-size:.75rem;font-weight:800;color:var(--blue);margin-bottom:4px;">ğŸ—ºï¸ YOUR ROUTE STATES</div>'
    + '<div style="display:flex;flex-wrap:wrap;gap:5px;">';
  Object.keys(ROUTE_STATES).forEach(function(a) {
    var v = appState.visitedStates[a];
    html += '<span style="background:' + (v ? 'var(--green)' : 'var(--blue)') + ';color:#fff;font-size:.75rem;font-weight:800;padding:2px 9px;border-radius:100px;">' + a + (v ? ' âœ“' : '') + '</span>';
  });
  html += '</div></div>';

  el.innerHTML = html;
}

function toggleState(abbr) {
  if (!appState.visitedStates) appState.visitedStates = {};
  var wasVisited = !!appState.visitedStates[abbr];
  if (wasVisited) {
    delete appState.visitedStates[abbr];
    showToast(abbr + ' uncollected', 1400);
  } else {
    appState.visitedStates[abbr] = new Date().toISOString();
    showToast('ğŸ‰ ' + abbr + ' collected!', 1800);
  }
  saveState(appState);
  renderStates();
}

/* â”€â”€ AI TRIVIA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _triviaQuestions = [];
var _triviaScore     = 0;
var _triviaTotal     = 0;
var _triviaAnswered  = [];

function renderTrivia() {
  var el = document.getElementById('fun-sub-content');
  if (!el) return;
  var dayNum  = tripDay();
  var dayData = getDay(dayNum);
  /* Next destination: find next stop after today */
  var nextStop = null;
  for (var di = 0; di < TRIP_DAYS.length; di++) {
    if (TRIP_DAYS[di].day >= dayNum) {
      nextStop = getStop(TRIP_DAYS[di].stopId);
      if (nextStop) break;
    }
  }
  var locLabel = nextStop ? nextStop.name : 'your trip destination';

  var html = '<h2 class="section-title"><i class="fa-solid fa-brain"></i> Road Trip Trivia</h2>';
  html += '<div style="background:linear-gradient(135deg,#4527A0,#1565C0);color:#fff;border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:14px;">'
    + '<span style="font-size:2rem;">ğŸ§ </span>'
    + '<div style="flex:1;">'
    + '<div style="font-weight:900;font-size:1rem;">Questions about: ' + locLabel + '</div>'
    + '<div style="font-size:.8rem;opacity:.85;">AI-generated trivia fresh from Gemini</div>'
    + '</div>'
    + '<button onclick="fetchTrivia()" id="trivia-gen-btn" style="background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.5);color:#fff;border-radius:100px;padding:8px 16px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;">âœ¨ Generate</button>'
    + '</div>';

  if (_triviaTotal > 0) {
    html += '<div style="background:var(--card);border:1.5px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;">'
      + '<div style="font-weight:800;font-size:.9rem;color:var(--text);">Score: <span style="color:var(--green);">' + _triviaScore + '</span> / ' + _triviaTotal + '</div>'
      + '<button onclick="fetchTrivia()" style="background:var(--blue);color:#fff;border:none;border-radius:100px;padding:5px 14px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);">New Questions</button>'
      + '</div>';
  }

  html += '<div id="trivia-cards-area">';
  if (_triviaQuestions.length === 0) {
    html += '<div style="text-align:center;padding:40px 20px;color:var(--text-3);">'
      + '<div style="font-size:3rem;margin-bottom:12px;">ğŸ§ </div>'
      + '<div style="font-size:.92rem;font-weight:600;">Tap Generate to get 3 trivia questions<br>about where you\'re headed!</div>'
      + '</div>';
  } else {
    _triviaQuestions.forEach(function(q, qi) {
      var answered = _triviaAnswered[qi];
      html += '<div class="trivia-card">'
        + '<div style="font-size:.68rem;font-weight:800;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">Question ' + (qi+1) + ' of ' + _triviaQuestions.length + '</div>'
        + '<div class="trivia-q">' + q.question + '</div>';
      q.options.forEach(function(opt, oi) {
        var cls = '';
        if (answered !== undefined) {
          if (oi === q.correct) cls = ' correct';
          else if (oi === answered && oi !== q.correct) cls = ' wrong';
        }
        html += '<button class="trivia-opt' + cls + '" '
          + (answered !== undefined ? 'disabled' : 'onclick="answerTrivia(' + qi + ',' + oi + ')"')
          + '>' + opt + '</button>';
      });
      if (answered !== undefined) {
        var correct = answered === q.correct;
        html += '<div style="margin-top:8px;padding:8px 12px;border-radius:12px;background:' + (correct?'var(--green-l)':'var(--orange-l)') + ';font-size:.82rem;color:' + (correct?'var(--green)':'var(--orange)') + ';font-weight:700;">'
          + (correct ? 'âœ… Correct! ' : 'âŒ The answer was: <strong>' + q.options[q.correct] + '</strong>. ')
          + (q.fact ? q.fact : '')
          + '</div>';
      }
      html += '</div>';
    });
  }
  html += '</div>';
  el.innerHTML = html;
}

function fetchTrivia() {
  var btn = document.getElementById('trivia-gen-btn');
  if (btn) { btn.textContent = 'â³ Loadingâ€¦'; btn.disabled = true; }
  var dayNum = tripDay();
  var nextStop = null;
  for (var di = 0; di < TRIP_DAYS.length; di++) {
    if (TRIP_DAYS[di].day >= dayNum) {
      nextStop = getStop(TRIP_DAYS[di].stopId);
      if (nextStop) break;
    }
  }
  var loc = nextStop ? (nextStop.name + ' â€” ' + (nextStop.description || '')) : 'a US road trip destination';
  var prompt = 'You are a trivia game master for a family road trip. Generate exactly 3 trivia questions about: ' + loc + '.\n\n'
    + 'Return ONLY valid JSON â€” no markdown, no explanation, no code blocks. Format:\n'
    + '[\n'
    + '  {"question":"...", "options":["A","B","C","D"], "correct":0, "fact":"One cool sentence about the answer."}\n'
    + ']\n'
    + 'correct is the 0-based index of the right option. Make questions fun and family-friendly. Mix history, nature, and pop culture.';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:700,temperature:0.8} });
  fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
  .then(function(r){ return r.json(); })
  .then(function(data) {
    var raw = data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts&&data.candidates[0].content.parts[0]&&data.candidates[0].content.parts[0].text || '[]';
    raw = raw.replace(/```json/g,'').replace(/```/g,'').trim();
    var qs = JSON.parse(raw);
    _triviaQuestions = qs;
    _triviaAnswered  = [];
    _triviaScore     = 0;
    _triviaTotal     = qs.length;
    renderTrivia();
  })
  .catch(function() {
    showToast('Trivia fetch failed â€” check connection', 2500);
    if (btn) { btn.textContent = 'âœ¨ Generate'; btn.disabled = false; }
  });
}

function answerTrivia(qi, oi) {
  if (_triviaAnswered[qi] !== undefined) return;
  _triviaAnswered[qi] = oi;
  if (oi === _triviaQuestions[qi].correct) _triviaScore++;
  _triviaTotal = _triviaQuestions.length;
  renderTrivia();
}

/* â”€â”€ TOOLS TAB SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _toolsTab = 'expenses';
function renderTools() {
  var el = document.getElementById('tools-content');
  if (!el) return;
  var tabs = [
    { id:'expenses', icon:'ğŸ’°', label:'Expenses'     },
    { id:'rvlog',    icon:'ğŸš', label:'RV Log'       },
    { id:'membook',  icon:'ğŸ“–', label:'Memory Book'  },
    { id:'profiles', icon:'ğŸ‘¤', label:'Profiles'     },
    { id:'auditlog', icon:'ğŸ“‹', label:'Audit Log'    },
    { id:'settings', icon:'âš™ï¸', label:'Settings'      }
  ];
  var effectiveTab = _toolsTab;
  var bar = '<div class="section-sub-bar">';
  tabs.forEach(function(t) {
    bar += '<button class="section-sub-btn' + (effectiveTab===t.id?' active':'') + '" onclick="setToolsTab(\'' + t.id + '\')">' + t.icon + ' ' + t.label + '</button>';
  });
  bar += '</div><div id="tools-sub-content"></div>';
  el.innerHTML = bar;
  _renderToolsSub();
}
function setToolsTab(tab) { _toolsTab = tab; renderTools(); }
function _renderToolsSub() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;
  if (_toolsTab === 'expenses') renderExpenses();
  if (_toolsTab === 'rvlog')    renderRVMaintenance();
  if (_toolsTab === 'membook')  renderMemoryBook();
  if (_toolsTab === 'profiles') renderProfiles();
  if (_toolsTab === 'auditlog') renderAuditLog();
  if (_toolsTab === 'settings') renderTripSettings();
}

/* â”€â”€ WHAT'S NEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderWhatsNew() {
  // Can render into either the standalone tab or the tools sub-content slot
  var el = document.getElementById('whatsnew-content') || document.getElementById('tools-sub-content');
  if (!el) return;

  // Trip Builder card
  var tripBuilderHtml = '<div style="background:linear-gradient(135deg,#E8813A,#c05a10);color:#fff;border-radius:var(--radius);padding:18px 20px;margin-bottom:16px;display:flex;align-items:center;gap:14px;cursor:pointer;" onclick="openTripBuilder()">'
    + '<span style="font-size:2.2rem;">ğŸ—ºï¸</span>'
    + '<div style="flex:1;">'
    + '<div style="font-weight:900;font-size:.98rem;margin-bottom:3px;">âœ¨ Build a New Trip with AI</div>'
    + '<div style="font-size:.81rem;opacity:.9;line-height:1.5;">Describe your adventure in plain English â€” TripGenie builds the full itinerary, stop list, drive schedule, and day-by-day plan.</div>'
    + '</div>'
    + '<div style="flex-shrink:0;background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.5);border-radius:12px;padding:8px 14px;font-size:.82rem;font-weight:800;white-space:nowrap;">Start â†’</div>'
    + '</div>';

  // Tutorial rerun banner
  var tutHtml = '<div style="background:linear-gradient(135deg,#7B2FBE,#4A90D9);color:#fff;border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:14px;">'
    + '<span style="font-size:2rem;">ğŸ“</span>'
    + '<div style="flex:1;">'
    + '<div style="font-weight:900;font-size:.95rem;margin-bottom:2px;">Interactive App Tutorial</div>'
    + '<div style="font-size:.82rem;opacity:.88;">A step-by-step guided tour of every major feature â€” highlights each button and explains how to use it.</div>'
    + '</div>'
    + '<button onclick="rerunTutorial()" style="background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.5);color:#fff;border-radius:100px;padding:8px 16px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;">â–¶ Start Tour</button>'
    + '</div>';

  var releases = [
    {
      version: 'This Week',
      date: 'Feb 2026',
      badge: 'ğŸ†•',
      badgeColor: '#E8813A',
      features: [
        { icon: 'âœ¨', title: "What's New log", desc: 'This screen! A running changelog of every feature added to the app.' },
        { icon: 'ğŸµ', title: 'Local Music (Spotify)', desc: 'Tap "ğŸµ Local Music" in any day\'s orange header or the schedule phase banner. TripGenie suggests 5 real local artists, one-line backstories, and genre chips â€” tap any to open directly in Spotify.' },
        { icon: 'ğŸ‘¤', title: 'Family Profiles', desc: 'Tools â†’ Profiles. Add a name, age, emoji, and interests for each person or pet. Luna\'s pre-loaded with Sonic the Hedgehog; Leila with acting & theater.' },
        { icon: 'ğŸ¯', title: 'AI personalization', desc: 'Area Info and TripGenie now tailor suggestions to whoever\'s logged in. If Leila views an area info and a famous actor grew up there, it adds a "For Leila" section.' },
        { icon: 'ğŸ“¸', title: 'Gallery tab', desc: 'Photo Gallery is now its own tab in the top nav â€” no longer buried in Journal. 3-column grid, zoom-in lightbox, location labels.' },
        { icon: 'ğŸ“‹', title: 'Audit Log', desc: 'Tools â†’ Audit Log. Timestamped history of every significant change â€” destinations added, decisions resolved, prefs saved. Color-coded by action type.' },
        { icon: 'ğŸ‘', title: 'View-only mode', desc: 'Password "readonly" logs in with full access to all tabs but zero saves. Perfect for sharing the trip plan without risking edits.' },
        { icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', title: 'Profile picker on login', desc: 'Choose who you are (Paul, Melissa, Leila, Luna, Eli) before entering the password. Journal author auto-populates and the header says hi.' },
        { icon: 'âš ï¸', title: 'Multi-user conflict detection', desc: 'If Melissa saves while Paul is editing, a red banner appears with the save time and two buttons: "Keep Mine" or "Take Theirs." No more silent overwrites.' },
        { icon: 'â˜ï¸', title: 'Last-saved-by tracking', desc: 'Cloud sync status now shows who last saved ("Saved (Paul)") so you always know whose version is live.' },
      ]
    },
    {
      version: 'Previous Build',
      date: 'Early Feb 2026',
      badge: 'âœ…',
      badgeColor: '#3A8A5C',
      features: [
        { icon: 'ğŸŒ¤ï¸', title: 'Weather on phase cards', desc: 'Dashboard Trip Phases cards now show a typical high/low temp chip pulled from historical weather data.' },
        { icon: 'ğŸ›‘', title: 'Kids stop-break settings', desc: 'Trip Settings â†’ Driving Preferences. Set stop-break frequency (every 1â€“3h) and duration (15â€“60 min). Live preview shows impact on a 7-hour drive.' },
        { icon: 'ğŸ”„', title: 'Accept trade-off vs. Decide Later', desc: 'Add Destination modal now has two buttons: "ğŸ”„ Accept Trade-off" (go to Adjustments) or "â• Add, Decide Later" (creates a Decisions item).' },
        { icon: 'âœ¨', title: 'Inline TripGenie on pause cards', desc: 'Decisions â†’ pause cards now have an "âœ¨ Ideas" button. TripGenie suggests how to shorten/rearrange the trip to accommodate the pause.' },
        { icon: 'ğŸ”º', title: 'Schedule overflow detection', desc: 'Adding a flight pause pushes trip past allocated days. Overflow days show a red ğŸ”º badge in the schedule and flow into Decisions.' },
        { icon: 'ğŸ–¼ï¸', title: 'License plate gallery', desc: 'License Plate Bingo now has a "ğŸ–¼ See Plates" button that loads real plate images from Wikipedia so you know what to look for.' },
        { icon: 'ğŸš¦', title: 'Drive split override', desc: 'Long Drive decisions now have a "âœ“ Plan the Split" button that marks the day as resolved and stores the per-leg hours.' },
        { icon: 'âœˆï¸', title: 'Trip Pause blocks in Schedule', desc: 'Flight / pause days are injected as full visual blocks in the Schedule tab, with effective date calculation and overnight count.' },
      ]
    },
    {
      version: 'Foundation',
      date: 'Janâ€“Feb 2026',
      badge: 'ğŸš€',
      badgeColor: '#2C5F8A',
      features: [
        { icon: 'ğŸ—“ï¸', title: 'Schedule & day detail', desc: '46-day daily schedule with drive-day vs. explore-day markers, weather chips, and a slide-up orange day detail modal.' },
        { icon: 'ğŸ—ºï¸', title: 'Interactive route map', desc: 'Leaflet map with all stops plotted, drive routes, miles/hours per leg, and a mini-map on the Dashboard.' },
        { icon: 'ğŸ“Š', title: 'Dashboard', desc: 'Live trip stats, hero banner, Tonight/Campground card, Up Next cards, and Trip Phases progress tracker.' },
        { icon: 'ğŸ•ï¸', title: 'Stops & campground search', desc: 'All 14 destinations with descriptions, campground notes, arrival/departure recording, and RV-specific filters.' },
        { icon: 'ğŸ“š', title: 'School tab', desc: 'Curriculum planning tied to each stop â€” geography, history, science, and math lessons that match where you are.' },
        { icon: 'ğŸ“–', title: 'Trip Journal', desc: 'Day-by-day journal entries with photo uploads, EXIF date support, voice-note style entries, and AI cleanup.' },
        { icon: 'ğŸ“¬', title: 'Postcards', desc: 'AI-written postcard messages with background image, editable text, and share/download.' },
        { icon: 'âœ…', title: 'Lists & packing', desc: 'Packing lists, to-dos, and custom checklists with drag-to-reorder.' },
        { icon: 'ğŸ’¡', title: 'Friend suggestions', desc: 'Share the friends password (maassfriends) and people can suggest stops, restaurants, and tips.' },
        { icon: 'ğŸ®', title: 'Fun & games', desc: 'License Plate Bingo (with state images), Road Trip Trivia, and State Badges â€” all persistent across sessions.' },
        { icon: 'âœ¨', title: 'TripGenie AI assistant', desc: 'Full-screen AI chat drawer with photo attachment, postcard writer, journal cleanup, area info deep-dives, and destination validation.' },
        { icon: 'ğŸ’°', title: 'Expenses tracker', desc: 'Log trip expenses by category with running totals and a bar chart.' },
        { icon: 'ğŸš', title: 'RV Maintenance log', desc: 'Log oil changes, tire checks, fluid levels, and other maintenance events with dates.' },
        { icon: 'â˜ï¸', title: 'Supabase cloud sync', desc: 'Auto-saves to Supabase on every change. All family members stay in sync. Works offline with local storage fallback.' },
        { icon: 'ğŸ§ª', title: 'Test mode', desc: 'Explore the whole app with a fake data set â€” zero risk of changing your real plans.' },
      ]
    }
  ];

  var html = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-star"></i> What\'s New</h2>'
    + '</div>';
  html += '<p style="font-size:.82rem;color:var(--text-2);margin-bottom:20px;line-height:1.5;">A full log of every feature built into this app â€” newest first.</p>';

  releases.forEach(function(rel) {
    html += '<div style="margin-bottom:24px;">';
    // Release header
    html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">'
      + '<span style="background:' + rel.badgeColor + ';color:#fff;font-size:.7rem;font-weight:800;padding:3px 10px;border-radius:20px;">' + rel.badge + ' ' + rel.version + '</span>'
      + '<span style="font-size:.75rem;color:var(--text-3);font-weight:600;">' + rel.date + '</span>'
      + '<div style="flex:1;height:1px;background:var(--border);"></div>'
      + '</div>';
    // Feature cards
    rel.features.forEach(function(f) {
      html += '<div style="display:flex;align-items:flex-start;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);">'
        + '<div style="font-size:1.25rem;line-height:1;flex-shrink:0;margin-top:1px;">' + f.icon + '</div>'
        + '<div style="flex:1;">'
        + '<div style="font-weight:700;font-size:.88rem;color:var(--text);margin-bottom:2px;">' + f.title + '</div>'
        + '<div style="font-size:.8rem;color:var(--text-2);line-height:1.5;">' + f.desc + '</div>'
        + '</div>'
        + '</div>';
    });
    html += '</div>';
  });

  el.innerHTML = tripBuilderHtml + tutHtml + html;
}

/* â”€â”€ AUDIT LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _audit(action, detail) {
  if (!appState.auditLog) appState.auditLog = [];
  appState.auditLog.unshift({
    ts:     new Date().toISOString(),
    user:   _userName || 'Family',
    action: action,
    detail: detail || ''
  });
  // Keep last 200 entries
  if (appState.auditLog.length > 200) appState.auditLog = appState.auditLog.slice(0, 200);
  // Note: don't call saveState here to avoid recursion â€” callers handle that
}

function renderAuditLog() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;
  var log = appState.auditLog || [];
  var html = '<h2 class="section-title"><i class="fa-solid fa-clock-rotate-left"></i> Change History</h2>';
  html += '<p style="font-size:.83rem;color:var(--text-2);margin-bottom:16px;line-height:1.5;">A record of significant changes made to the trip plan.</p>';

  if (!log.length) {
    html += '<div style="text-align:center;padding:40px 20px;color:var(--text-3);">'
      + '<div style="font-size:2.5rem;margin-bottom:10px;">ğŸ“‹</div>'
      + '<div style="font-weight:700;font-size:.9rem;">No changes recorded yet</div>'
      + '<div style="font-size:.8rem;margin-top:4px;">Changes will appear here as you plan your trip.</div>'
      + '</div>';
    el.innerHTML = html;
    return;
  }

  var dateGroups = {};
  var dateOrder  = [];
  log.forEach(function(entry) {
    var d = entry.ts ? entry.ts.slice(0,10) : 'Unknown';
    if (!dateGroups[d]) { dateGroups[d] = []; dateOrder.push(d); }
    dateGroups[d].push(entry);
  });

  dateOrder.forEach(function(d) {
    var label = d === new Date().toISOString().slice(0,10) ? 'Today' : formatDate(d);
    html += '<div style="font-size:.72rem;font-weight:800;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;padding:8px 0 4px;">' + label + '</div>';
    dateGroups[d].forEach(function(entry) {
      var t = entry.ts ? new Date(entry.ts).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}) : '';
      var actionColors = {
        'Added destination': 'var(--green)',
        'Removed destination': 'var(--red)',
        'Resolved decision': 'var(--blue)',
        'Added trip pause': 'var(--orange)',
        'Removed trip pause': 'var(--red)',
        'Campground changed': 'var(--purple)',
        'Stop added to plan': 'var(--green)',
        'Stop removed from plan': 'var(--orange)',
        'Day note saved': 'var(--text-3)',
        'Driving prefs saved': 'var(--text-3)',
        'Trip settings saved': 'var(--text-3)',
        'Profiles updated': 'var(--purple)'
      };
      var color = actionColors[entry.action] || 'var(--blue)';
      html += '<div style="display:flex;align-items:flex-start;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);">'
        + '<div style="width:6px;height:6px;border-radius:50%;background:' + color + ';margin-top:5px;flex-shrink:0;"></div>'
        + '<div style="flex:1;">'
        + '<div style="font-size:.85rem;font-weight:700;color:var(--text);">' + entry.action + '</div>'
        + (entry.detail ? '<div style="font-size:.78rem;color:var(--text-2);margin-top:2px;">' + entry.detail + '</div>' : '')
        + '</div>'
        + '<div style="font-size:.72rem;color:var(--text-3);white-space:nowrap;">'
        + (entry.user ? '<span style="color:var(--text-2);font-weight:600;">' + entry.user + '</span> Â· ' : '')
        + t + '</div></div>';
    });
  });

  html += '<button onclick="if(confirm(\'Clear all change history?\')) { appState.auditLog=[]; saveState(appState); renderAuditLog(); }" style="margin-top:16px;width:100%;padding:10px;background:transparent;border:1.5px solid var(--border);border-radius:var(--radius-s);color:var(--text-3);font-size:.8rem;cursor:pointer;font-family:var(--font);">ğŸ—‘ Clear history</button>';

  el.innerHTML = html;
}

/* â”€â”€ PROFILES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _DEFAULT_PROFILES = [
  { id:'paul',    name:'Paul',    role:'person', emoji:'ğŸ‘¨', age:'',  interests:['photography','BBQ','history','hiking'] },
  { id:'melissa', name:'Melissa', role:'person', emoji:'ğŸ‘©', age:'',  interests:[] },
  { id:'leila',   name:'Leila',   role:'person', emoji:'ğŸŒŸ', age:'9', interests:['acting','theater','performing arts','movies','Broadway'] },
  { id:'luna',    name:'Luna',    role:'person', emoji:'ğŸ¦”', age:'4', interests:['Sonic the Hedgehog','animals','running','video games'] },
  { id:'eli',     name:'Eli',     role:'person', emoji:'ğŸ§¸', age:'2', interests:[] }
];

function _getProfiles() {
  if (!appState.profiles || !appState.profiles.length) return JSON.parse(JSON.stringify(_DEFAULT_PROFILES));
  return appState.profiles;
}

function _saveProfiles(profiles) {
  appState.profiles = profiles;
  saveState(appState);
  _audit('Profiles updated', 'Profile data changed');
}

function getCurrentProfile() {
  var profiles = _getProfiles();
  if (!_userName) return null;
  return profiles.find(function(p) { return p.name === _userName; }) || null;
}

function _getPersonalizationContext() {
  var prof = getCurrentProfile();
  var parts = [];
  if (prof && prof.interests && prof.interests.length) {
    parts.push('Currently viewing: ' + prof.name + (prof.age ? ' (age ' + prof.age + ')' : '') + '. '
      + 'They love: ' + prof.interests.join(', ') + '. '
      + 'When relevant to this location, naturally weave in any surprising connections to their interests '
      + '(e.g., if they love Sonic the Hedgehog and a game designer grew up here; if they love acting and a famous actor is from this town). '
      + 'Only mention if there\'s a genuine connection.');
  }
  var skipPrefs = appState.skipPrefs || {};
  var skipItems = skipPrefs.items || [];
  var skipCustom = skipPrefs.custom || '';
  var SKIP_LABELS = {
    heights:'heights/high altitude lookouts', crowds:'large crowds and busy tourist traps',
    hikes:'strenuous hikes', caves:'caves and enclosed spaces', water:'water activities',
    haunted:'haunted or scary attractions', shopping:'heavy shopping/malls',
    spicy:'very spicy food', loud:'very loud venues', long_drives:'extra long drive days'
  };
  var skipDescriptions = skipItems.map(function(k){ return SKIP_LABELS[k] || k; });
  if (skipCustom) skipDescriptions.push(skipCustom);
  if (skipDescriptions.length) {
    parts.push('IMPORTANT: This family prefers to AVOID or skip: ' + skipDescriptions.join(', ') + '. Do NOT recommend these things.');
  }
  return parts.length ? '\n\n' + parts.join('\n\n') : '';
}

function _toggleSkipPref(id) {
  if (!appState.skipPrefs) appState.skipPrefs = { items: [], custom: '' };
  if (!appState.skipPrefs.items) appState.skipPrefs.items = [];
  var idx = appState.skipPrefs.items.indexOf(id);
  if (idx !== -1) appState.skipPrefs.items.splice(idx, 1);
  else appState.skipPrefs.items.push(id);
  renderTripSettings();
}

function _toggleDietPref(id) {
  if (!appState.dietPrefs) appState.dietPrefs = {};
  appState.dietPrefs[id] = !appState.dietPrefs[id];
  saveState(appState);
  var btn = document.getElementById('diet-btn-' + id);
  if (btn) {
    var active = appState.dietPrefs[id];
    btn.style.background = active ? 'var(--green)' : 'var(--bg)';
    btn.style.color = active ? '#fff' : 'var(--text-2)';
    btn.style.borderColor = active ? 'var(--green)' : 'var(--border)';
  }
}
function saveDietPrefs() {
  saveState(appState);
  showToast('ğŸŒ¿ Diet preferences saved!', 2000);
}
function getDietContext() {
  var prefs = appState.dietPrefs || {};
  var active = Object.keys(prefs).filter(function(k) { return prefs[k]; });
  if (!active.length) return '';
  var labels = { vegan:'Vegan', vegetarian:'Vegetarian', dairy_free:'Dairy Free', gluten_free:'Gluten Free' };
  return 'Diet restrictions: ' + active.map(function(k){ return labels[k]||k; }).join(', ') + '. Do NOT recommend restaurants that conflict with these dietary requirements. ';
}

function saveSkipPrefs() {
  if (!appState.skipPrefs) appState.skipPrefs = { items: [], custom: '' };
  var customEl = document.getElementById('skip-custom');
  if (customEl) appState.skipPrefs.custom = customEl.value.trim();
  saveState();
  showToast('&#10003; Skip preferences saved â€” AI will avoid these going forward!', 2800);
  _audit('skip-prefs', 'Updated skip preferences: ' + (appState.skipPrefs.items || []).join(', '));
}

var _editingProfileId = null;

function renderProfiles() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;
  var profiles = _getProfiles();
  var html = '<h2 class="section-title"><i class="fa-solid fa-users"></i> Family Profiles</h2>';
  html += '<p style="font-size:.83rem;color:var(--text-2);margin-bottom:16px;line-height:1.5;">TripGenie uses these profiles to personalize suggestions for whoever\'s logged in. Set interests and it\'ll look for local connections â€” acting studios, Sonic references, you name it.</p>';

  profiles.forEach(function(p, idx) {
    var isEditing = _editingProfileId === p.id;
    var interestStr = (p.interests || []).join(', ');
    html += '<div style="background:var(--card);border:1.5px solid ' + (isEditing ? 'var(--orange)' : 'var(--border)') + ';border-radius:var(--radius);margin-bottom:12px;overflow:hidden;">';
    // Header row
    html += '<div style="display:flex;align-items:center;gap:12px;padding:14px 16px;cursor:pointer;" onclick="toggleEditProfile(\'' + p.id + '\')">';
    html += '<div style="font-size:1.8rem;line-height:1;">' + (p.emoji || (p.role === 'pet' ? 'ğŸ¾' : 'ğŸ‘¤')) + '</div>';
    html += '<div style="flex:1;">';
    html += '<div style="font-weight:700;font-size:.95rem;">' + p.name + (p.age ? ' <span style="font-size:.78rem;color:var(--text-3);font-weight:600;">age ' + p.age + '</span>' : '') + '</div>';
    html += '<div style="font-size:.75rem;color:var(--text-3);">' + (p.role === 'pet' ? 'ğŸ¾ Pet' : 'ğŸ‘¤ Person') + (interestStr ? ' Â· â¤ï¸ ' + (p.interests.slice(0,3).join(', ')) + (p.interests.length > 3 ? 'â€¦' : '') : '') + '</div>';
    html += '</div>';
    html += '<span style="font-size:.8rem;color:var(--text-3);">' + (isEditing ? 'â–² Close' : 'âœï¸ Edit') + '</span>';
    html += '</div>';
    // Edit panel
    if (isEditing) {
      html += '<div style="border-top:1px solid var(--border);padding:14px 16px;display:flex;flex-direction:column;gap:12px;background:var(--bg);">';
      // Name
      html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;">Name</label>';
      html += '<input id="prof-name-' + p.id + '" type="text" value="' + p.name + '" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.9rem;font-family:var(--font);background:var(--card);color:var(--text);outline:none;box-sizing:border-box;" /></div>';
      // Age
      html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;">Age</label>';
      html += '<input id="prof-age-' + p.id + '" type="text" value="' + (p.age || '') + '" placeholder="e.g. 9" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.9rem;font-family:var(--font);background:var(--card);color:var(--text);outline:none;box-sizing:border-box;" /></div>';
      // Emoji
      html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;">Emoji / Icon</label>';
      html += '<input id="prof-emoji-' + p.id + '" type="text" value="' + (p.emoji || '') + '" placeholder="e.g. ğŸ¦”" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:1.3rem;font-family:var(--font);background:var(--card);color:var(--text);outline:none;box-sizing:border-box;" /></div>';
      // Role
      html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">Type</label>';
      html += '<div style="display:flex;gap:8px;">';
      html += '<button onclick="document.getElementById(\'prof-role-' + p.id + '\').value=\'person\';this.style.background=\'var(--blue)\';this.style.color=\'#fff\';this.nextElementSibling.style.background=\'\';this.nextElementSibling.style.color=\'\';" style="flex:1;padding:7px;border:1.5px solid var(--border);border-radius:var(--radius-s);cursor:pointer;font-weight:600;font-size:.82rem;font-family:var(--font);' + (p.role !== 'pet' ? 'background:var(--blue);color:#fff;' : '') + '">ğŸ‘¤ Person</button>';
      html += '<button onclick="document.getElementById(\'prof-role-' + p.id + '\').value=\'pet\';this.style.background=\'var(--green)\';this.style.color=\'#fff\';this.previousElementSibling.style.background=\'\';this.previousElementSibling.style.color=\'\';" style="flex:1;padding:7px;border:1.5px solid var(--border);border-radius:var(--radius-s);cursor:pointer;font-weight:600;font-size:.82rem;font-family:var(--font);' + (p.role === 'pet' ? 'background:var(--green);color:#fff;' : '') + '">ğŸ¾ Pet</button>';
      html += '</div><input type="hidden" id="prof-role-' + p.id + '" value="' + p.role + '" /></div>';
      // Interests
      html += '<div><label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:4px;text-transform:uppercase;letter-spacing:.04em;">Interests <span style="font-weight:400;text-transform:none;letter-spacing:0;">(comma-separated)</span></label>';
      html += '<textarea id="prof-interests-' + p.id + '" placeholder="e.g. Sonic the Hedgehog, animals, running" style="width:100%;padding:8px 10px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.88rem;font-family:var(--font);background:var(--card);color:var(--text);outline:none;resize:vertical;min-height:60px;box-sizing:border-box;">' + interestStr + '</textarea>';
      html += '<div style="font-size:.72rem;color:var(--text-3);margin-top:3px;">TripGenie uses these to find surprising local connections for this person.</div></div>';
      // Actions
      html += '<div style="display:flex;gap:8px;">';
      html += '<button onclick="saveProfile(\'' + p.id + '\')" style="flex:1;padding:9px;background:var(--orange);color:#fff;border:none;border-radius:var(--radius-s);font-weight:700;cursor:pointer;font-family:var(--font);">ğŸ’¾ Save</button>';
      if (idx >= 5) { // allow deleting added profiles (not the core family)
        html += '<button onclick="deleteProfile(\'' + p.id + '\')" style="padding:9px 14px;background:var(--red,#e53935);color:#fff;border:none;border-radius:var(--radius-s);font-weight:700;cursor:pointer;font-family:var(--font);">ğŸ—‘</button>';
      }
      html += '</div>';
      html += '</div>'; // edit panel
    }
    html += '</div>'; // card
  });

  // Add person/pet button
  html += '<button onclick="addNewProfile(\'person\')" style="width:100%;margin-top:4px;padding:12px;background:transparent;border:2px dashed var(--border);border-radius:var(--radius);color:var(--text-2);font-size:.88rem;font-weight:700;cursor:pointer;font-family:var(--font);">â• Add Person or Pet</button>';

  el.innerHTML = html;
}

function toggleEditProfile(id) {
  _editingProfileId = _editingProfileId === id ? null : id;
  renderProfiles();
}

function saveProfile(id) {
  var profiles = _getProfiles();
  var idx = profiles.findIndex(function(p) { return p.id === id; });
  if (idx === -1) return;
  var nameEl   = document.getElementById('prof-name-' + id);
  var ageEl    = document.getElementById('prof-age-' + id);
  var emojiEl  = document.getElementById('prof-emoji-' + id);
  var roleEl   = document.getElementById('prof-role-' + id);
  var interEl  = document.getElementById('prof-interests-' + id);
  if (nameEl)  profiles[idx].name      = nameEl.value.trim();
  if (ageEl)   profiles[idx].age       = ageEl.value.trim();
  if (emojiEl) profiles[idx].emoji     = emojiEl.value.trim();
  if (roleEl)  profiles[idx].role      = roleEl.value;
  if (interEl) profiles[idx].interests = interEl.value.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
  _editingProfileId = null;
  _saveProfiles(profiles);
  renderProfiles();
  showToast('âœ“ Profile saved', 1800);
}

function deleteProfile(id) {
  var profiles = _getProfiles().filter(function(p) { return p.id !== id; });
  _editingProfileId = null;
  _saveProfiles(profiles);
  renderProfiles();
  showToast('Profile removed', 1600);
}

function addNewProfile(role) {
  var profiles = _getProfiles();
  var newId = 'profile-' + Date.now();
  profiles.push({ id: newId, name: role === 'pet' ? 'Pet' : 'New Person', role: role, emoji: role === 'pet' ? 'ğŸ¾' : 'ğŸ‘¤', age: '', interests: [] });
  appState.profiles = profiles;
  saveState(appState);
  _editingProfileId = newId;
  renderProfiles();
}

/* â”€â”€ TRIP SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderTripSettings() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;

  // Current values â€” use any saved overrides, otherwise CONFIG defaults
  var s = appState.tripSettings || {};
  var startVal = s.startDate || CONFIG.startDate;
  var endVal   = s.endDate   || CONFIG.endDate;
  var nameVal  = s.tripName  || 'Maass Family RV Adventure 2026';

  // Compute days between the two dates
  function daysBetween(a, b) {
    var ms = new Date(b + 'T12:00:00') - new Date(a + 'T12:00:00');
    return Math.max(1, Math.round(ms / 86400000) + 1);
  }
  var numDays = daysBetween(startVal, endVal);

  var html = '<h2 class="section-title"><i class="fa-solid fa-gear"></i> Trip Settings</h2>';
  html += '<div style="background:var(--blue-l);border:1px solid #7aaac8;border-radius:var(--radius);padding:14px 16px;margin-bottom:20px;font-size:.83rem;color:var(--blue);line-height:1.55;">';
  html += '<strong>Changes here update the whole app</strong> â€” schedule dates, day counter, progress bar, and "Today" highlighting will all reflect the new dates.';
  html += '</div>';

  // Settings card
  html += '<div class="card"><div class="card-body" style="display:flex;flex-direction:column;gap:18px;">';

  // Trip name
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">Trip Name</label>';
  html += '<input id="ts-name" type="text" value="' + nameVal + '" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '</div>';

  // City info (read-only â€” derived from first/last stop)
  html += '<div style="background:var(--bg-2,#f7f9fb);border:1.5px solid var(--border);border-radius:var(--radius-s);padding:11px 14px;">';
  html += '<div style="font-size:.72rem;font-weight:700;color:var(--text-2);text-transform:uppercase;letter-spacing:.04em;margin-bottom:7px;">ğŸ“ Route</div>';
  html += '<div style="display:flex;align-items:center;gap:8px;font-size:.88rem;font-weight:700;color:var(--text);">';
  html += '<span>ğŸ  ' + _tripStartCity() + '</span>';
  if (!_tripIsRoundTrip()) {
    html += '<span style="color:var(--text-3);">â†’</span>';
    html += '<span>ğŸ ' + _tripEndCity() + '</span>';
  } else {
    html += '<span style="color:var(--text-3);">â†’ â€¦ â†’</span>';
    html += '<span>ğŸ  ' + _tripStartCity() + ' (round trip)</span>';
  }
  html += '</div>';
  html += '<div style="font-size:.73rem;color:var(--text-3);margin-top:5px;">Start &amp; end cities are set by the first and last stop in your itinerary.</div>';
  html += '</div>';

  // Start date
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#128197; Departure Date</label>';
  html += '<input id="ts-start" type="date" value="' + startVal + '" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '<div style="font-size:.75rem;color:var(--text-3);margin-top:4px;">The day you leave home â€” Day 1 of the trip.</div>';
  html += '</div>';

  // End date
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#127968; Return Date</label>';
  html += '<input id="ts-end" type="date" value="' + endVal + '" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '<div style="font-size:.75rem;color:var(--text-3);margin-top:4px;">The day you arrive back home.</div>';
  html += '</div>';

  // Computed duration display
  html += '<div id="ts-duration" style="background:var(--orange-l);border:1px solid var(--orange);border-radius:var(--radius-s);padding:12px 14px;font-size:.9rem;font-weight:700;color:var(--orange-d);text-align:center;">';
  html += '&#127951; ' + numDays + ' days &nbsp;&#8226;&nbsp; ' + startVal + ' â†’ ' + endVal;
  html += '</div>';

  // RV Power (Amps)
  var _tsAmps = (appState.tripSettings && appState.tripSettings.rvAmps) ? appState.tripSettings.rvAmps : 50;
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#9889; RV Power Required</label>';
  html += '<select id="ts-amps" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;">';
  html += '<option value="50"' + (_tsAmps == 50 ? ' selected' : '') + '>50 Amps (most large RVs &amp; 5th wheels)</option>';
  html += '<option value="30"' + (_tsAmps == 30 ? ' selected' : '') + '>30 Amps (smaller RVs &amp; travel trailers)</option>';
  html += '<option value="20"' + (_tsAmps == 20 ? ' selected' : '') + '>20 Amps (dry camping / basic hookup)</option>';
  html += '</select>';
  html += '<div style="font-size:.75rem;color:var(--text-3);margin-top:4px;">Used by AI to check hookup compatibility at campgrounds.</div>';
  html += '</div>';

  // Time Format
  var _tsFmt = (appState.tripSettings && appState.tripSettings.timeFormat) ? appState.tripSettings.timeFormat : '12h';
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#128336; Time Display Format</label>';
  html += '<select id="ts-timefmt" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;">';
  html += '<option value="12h"' + (_tsFmt === '12h' ? ' selected' : '') + '>12-hour (7:30 AM / 5:00 PM)</option>';
  html += '<option value="24h"' + (_tsFmt === '24h' ? ' selected' : '') + '>24-hour (07:30 / 17:00)</option>';
  html += '</select>';
  html += '</div>';

  // Departure Time (drive days)
  var _tsDep = (appState.tripSettings && appState.tripSettings.departureTime) ? appState.tripSettings.departureTime : '08:00';
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#128666; Drive Day Departure Time</label>';
  html += '<input id="ts-deptime" type="time" value="' + _tsDep + '" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '<div style="font-size:.75rem;color:var(--text-3);margin-top:4px;">What time you aim to leave on driving days.</div>';
  html += '</div>';

  // Latest Arrival Time
  var _tsLate = (appState.tripSettings && appState.tripSettings.latestArrival) ? appState.tripSettings.latestArrival : '20:00';
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#127759; Latest Campground Arrival</label>';
  html += '<input id="ts-latearrival" type="time" value="' + _tsLate + '" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.95rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '<div style="font-size:.75rem;color:var(--text-3);margin-top:4px;">Drive days that arrive later will show a warning.</div>';
  html += '</div>';

  // Save button
  html += '<button onclick="saveTripSettings()" style="width:100%;background:var(--orange);color:#fff;border:none;border-radius:var(--radius-s);padding:13px;font-size:.95rem;font-weight:800;cursor:pointer;font-family:var(--font);">&#10003; Save Trip Settings</button>';

  html += '</div></div>';

  /* â”€â”€ Driving Preferences â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var dp    = appState.drivingPrefs || {};
  var maxHv = dp.maxHours !== undefined ? dp.maxHours : 4;

  /* Find all drive days that currently exceed the preference */
  var longDrives = TRIP_DAYS.filter(function(d) { return d.driveDay && d.driveHours > maxHv; });

  html += '<h2 class="section-title" style="margin-top:28px;"><i class="fa-solid fa-road"></i> Driving Preferences</h2>';
  html += '<div style="background:var(--orange-l);border:1px solid #f0c89e;border-radius:var(--radius-s);padding:12px 15px;margin-bottom:16px;font-size:.82rem;color:var(--text);line-height:1.55;">'
    + '<strong>How these work:</strong> Set your preferred daily driving limit. Any drive day that exceeds it gets a '
    + '<span style="background:var(--orange);color:#fff;font-size:.7rem;padding:1px 7px;border-radius:100px;font-weight:800;"><i class="fa-solid fa-triangle-exclamation"></i> Long Drive</span>'
    + ' badge in the Schedule, and the day detail will show a specific split suggestion â€” e.g. "drive 4h on Day 38 evening, then 4h on Day 39."'
    + '</div>';

  html += '<div class="card"><div class="card-body" style="display:flex;flex-direction:column;gap:18px;">';

  var stopEvery = dp.stopBreakEvery !== undefined ? dp.stopBreakEvery : 0;
  var stopMins  = dp.stopBreakMins  !== undefined ? dp.stopBreakMins  : 15;

  /* Max hours slider */
  html += '<div>'
    + '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;"><i class="fa-solid fa-clock"></i> Max Drive Hours Per Day</label>'
    + '<div style="display:flex;align-items:center;gap:14px;">'
    + '<input id="dp-max-hours" type="range" min="2" max="10" step=".5" value="' + maxHv + '" oninput="document.getElementById(\'dp-hours-display\').textContent=this.value+\'h\'" style="flex:1;accent-color:var(--orange);" />'
    + '<span id="dp-hours-display" style="font-size:1.1rem;font-weight:900;color:var(--orange);min-width:32px;text-align:right;">' + maxHv + 'h</span>'
    + '</div>'
    + '<div style="font-size:.75rem;color:var(--text-3);margin-top:4px;">Drives longer than this get a split suggestion. Default: 4h.</div>'
    + '</div>';

  /* Kids / passenger stop break setting */
  html += '<div>'
    + '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:8px;text-transform:uppercase;letter-spacing:.04em;">ğŸ§’ Passenger Stop Breaks</label>'
    + '<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-s);padding:12px 14px;display:flex;flex-direction:column;gap:12px;">'
    /* â€” Frequency row â€” */
    + '<div>'
    + '<div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:6px;">Stop break everyâ€¦</div>'
    + '<div style="display:flex;gap:6px;flex-wrap:wrap;" id="dp-break-freq">';
  var freqOpts = [{v:0,l:'None (no stops)'},{v:1,l:'1 h'},{v:1.5,l:'1.5 h'},{v:2,l:'2 h'},{v:2.5,l:'2.5 h'},{v:3,l:'3 h'}];
  freqOpts.forEach(function(opt) {
    var active = stopEvery === opt.v;
    html += '<button onclick="_dpSetFreq(' + opt.v + ')" id="dpf-' + opt.v.toString().replace('.','_') + '" '
      + 'style="background:' + (active ? 'var(--orange)' : 'var(--bg)') + ';color:' + (active ? '#fff' : 'var(--text-2)') + ';border:1.5px solid ' + (active ? 'var(--orange)' : 'var(--border)') + ';border-radius:20px;padding:5px 12px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;">'
      + opt.l + '</button>';
  });
  html += '</div></div>'
    /* â€” Duration row (hidden when None) â€” */
    + '<div id="dp-break-dur-row" style="display:' + (stopEvery > 0 ? 'block' : 'none') + ';">'
    + '<div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:6px;">Break duration</div>'
    + '<div style="display:flex;gap:6px;flex-wrap:wrap;" id="dp-break-dur">';
  [15,30,45,60].forEach(function(m) {
    var active = stopMins === m;
    html += '<button onclick="_dpSetMins(' + m + ')" id="dpm-' + m + '" '
      + 'style="background:' + (active ? 'var(--orange)' : 'var(--bg)') + ';color:' + (active ? '#fff' : 'var(--text-2)') + ';border:1.5px solid ' + (active ? 'var(--orange)' : 'var(--border)') + ';border-radius:20px;padding:5px 12px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);">'
      + m + ' min</button>';
  });
  html += '</div></div>'
    /* â€” Preview â€” */
    + '<div id="dp-break-preview" style="font-size:.75rem;color:var(--text-3);line-height:1.5;">'
    + _stopBreakPreview(stopEvery, stopMins)
    + '</div>'
    + '</div>'
    + '<div style="font-size:.74rem;color:var(--text-3);margin-top:4px;">Adds rest stops to drive time estimates throughout the schedule.</div>'
    + '</div>';

  /* Long-drive summary */
  if (longDrives.length > 0) {
    html += '<div style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-s);padding:12px 14px;">'
      + '<div style="font-size:.75rem;font-weight:800;color:var(--orange);text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;display:flex;align-items:center;gap:5px;"><i class="fa-solid fa-triangle-exclamation"></i> ' + longDrives.length + ' Drive' + (longDrives.length > 1 ? 's' : '') + ' Over Your Current ' + maxHv + 'h Limit</div>'
      + '<div style="display:flex;flex-direction:column;gap:5px;">';
    longDrives.forEach(function(d) {
      var fromStop = (function() {
        for (var i = d.day - 2; i >= 0; i--) {
          var prev = TRIP_DAYS[i];
          if (prev && prev.stopId !== d.stopId) {
            var s = getStop(prev.stopId);
            return s ? s.name : '?';
          }
        }
        return 'Home';
      })();
      var toStop = getStop(d.stopId);
      var halfH = (d.driveHours / 2).toFixed(1).replace(/\.0$/,'');
      html += '<div style="display:flex;align-items:center;justify-content:space-between;font-size:.8rem;gap:8px;">'
        + '<span style="color:var(--text);">Day ' + d.day + ' â€” <strong>' + d.driveHours + 'h</strong> ' + fromStop + ' â†’ ' + (toStop ? toStop.name : '?') + '</span>'
        + '<span style="background:var(--orange-l);color:var(--orange-d);font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:100px;white-space:nowrap;">Split: ' + halfH + 'h + ' + halfH + 'h</span>'
        + '</div>';
    });
    html += '</div></div>';
  } else {
    html += '<div style="background:var(--green-l);border:1px solid #a8d5b8;border-radius:var(--radius-s);padding:11px 14px;font-size:.83rem;color:var(--green);font-weight:700;">âœ… All drive days are within your ' + maxHv + 'h limit!</div>';
  }

  /* Buttons */
  html += '<div style="display:flex;gap:8px;flex-wrap:wrap;">'
    + '<button onclick="saveDrivingPrefs()" style="flex:1;background:var(--orange);color:#fff;border:none;border-radius:var(--radius-s);padding:11px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœ“ Save Preferences</button>'
    + (longDrives.length > 0 ? '<button onclick="generateDriveSplitSuggestions()" style="flex:1;background:var(--red);color:#fff;border:none;border-radius:var(--radius-s);padding:11px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ”º Add All Splits to Decisions</button>' : '')
    + '</div>';

  html += '</div></div>'; /* end driving prefs card */

  /* â”€â”€ AI Skip Preferences â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var skipPrefs = appState.skipPrefs || {};
  var skipList  = skipPrefs.items || [];
  var SKIP_OPTIONS = [
    { id:'heights',      label:'Heights / High Altitude',    icon:'ğŸ”ï¸' },
    { id:'crowds',       label:'Large Crowds / Busy Tourist Spots', icon:'ğŸ‘¥' },
    { id:'hikes',        label:'Strenuous Hikes',            icon:'ğŸ¥¾' },
    { id:'caves',        label:'Caves / Enclosed Spaces',    icon:'ğŸ•³ï¸' },
    { id:'water',        label:'Water Activities / Swimming', icon:'ğŸŠ' },
    { id:'haunted',      label:'Haunted / Scary Attractions', icon:'ğŸ‘»' },
    { id:'shopping',     label:'Heavy Shopping / Malls',     icon:'ğŸ›ï¸' },
    { id:'spicy',        label:'Very Spicy Food',            icon:'ğŸŒ¶ï¸' },
    { id:'loud',         label:'Very Loud Venues / Concerts',icon:'ğŸ”Š' },
    { id:'long_drives',  label:'Extra Long Drive Days',      icon:'ğŸ›£ï¸' }
  ];

  /* â”€â”€ Diet Preferences â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var dietPrefs = (appState.dietPrefs) || {};
  var DIET_OPTIONS = [
    { id:'vegan',       label:'Vegan',        icon:'ğŸŒ±' },
    { id:'vegetarian',  label:'Vegetarian',   icon:'ğŸ¥¦' },
    { id:'dairy_free',  label:'Dairy Free',   icon:'ğŸ¥›' },
    { id:'gluten_free', label:'Gluten Free',  icon:'ğŸŒ¾' }
  ];
  html += '<h2 class="section-title" style="margin-top:28px;"><i class="fa-solid fa-utensils"></i> Diet Preferences</h2>';
  html += '<div style="background:var(--green-l,#e8f5ee);border:1px solid var(--green);border-radius:var(--radius-s);padding:12px 15px;margin-bottom:16px;font-size:.82rem;color:var(--text);line-height:1.55;">'
    + 'ğŸŒ¿ These are passed to TripGenie when recommending restaurants â€” we won\'t suggest a steakhouse to a vegan!'
    + '</div>';
  html += '<div class="card"><div class="card-body" style="display:flex;flex-wrap:wrap;gap:8px;">';
  DIET_OPTIONS.forEach(function(opt) {
    var active = dietPrefs[opt.id];
    html += '<button onclick="_toggleDietPref(\'' + opt.id + '\')" id="diet-btn-' + opt.id + '" '
      + 'style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:' + (active ? 'var(--green)' : 'var(--bg)') + ';color:' + (active ? '#fff' : 'var(--text-2)') + ';border:1.5px solid ' + (active ? 'var(--green)' : 'var(--border)') + ';border-radius:20px;font-size:.8rem;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;transition:all .15s;">'
      + '<span>' + opt.icon + '</span><span>' + opt.label + '</span>'
      + (active ? '<span style=\"font-size:.65rem;\">âœ“</span>' : '')
      + '</button>';
  });
  html += '<button onclick="saveDietPrefs()" style="margin-left:auto;background:var(--orange);color:#fff;border:none;border-radius:20px;padding:8px 16px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœ“ Save</button>';
  html += '</div></div>';

  html += '<h2 class="section-title" style="margin-top:28px;"><i class="fa-solid fa-ban"></i> AI Preferences â€” Things to Skip</h2>';
  html += '<div style="background:var(--purple-l);border:1px solid #c9b8e8;border-radius:var(--radius-s);padding:12px 15px;margin-bottom:16px;font-size:.82rem;color:var(--text);line-height:1.55;">'
    + '&#129302; The AI uses these to filter out recommendations you\'d rather skip. TripGenie, Area Info, and activity suggestions will avoid these when possible.'
    + '</div>';
  html += '<div class="card"><div class="card-body" style="display:flex;flex-direction:column;gap:16px;">';
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;" id="skip-options-grid">';
  SKIP_OPTIONS.forEach(function(opt) {
    var active = skipList.indexOf(opt.id) !== -1;
    html += '<button onclick="_toggleSkipPref(\'' + opt.id + '\')" id="skip-btn-' + opt.id + '" '
      + 'style="display:flex;align-items:center;gap:6px;padding:8px 14px;background:' + (active ? '#c0392b' : 'var(--bg)') + ';color:' + (active ? '#fff' : 'var(--text-2)') + ';border:1.5px solid ' + (active ? '#c0392b' : 'var(--border)') + ';border-radius:20px;font-size:.8rem;font-weight:700;cursor:pointer;font-family:var(--font);white-space:nowrap;transition:all .15s;">'
      + '<span>' + opt.icon + '</span><span>' + opt.label + '</span>'
      + (active ? '<span style="font-size:.65rem;">âœ•</span>' : '')
      + '</button>';
  });
  html += '</div>';
  // Custom skip text
  var customSkip = skipPrefs.custom || '';
  html += '<div>';
  html += '<label style="font-size:.72rem;font-weight:700;color:var(--text-2);display:block;margin-bottom:6px;text-transform:uppercase;letter-spacing:.04em;">&#10133; Other things to skip (free text)</label>';
  html += '<input id="skip-custom" type="text" placeholder="e.g. roller coasters, seafood, museumsâ€¦" value="' + customSkip.replace(/"/g,'&quot;') + '" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.88rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;" />';
  html += '</div>';
  html += '<button onclick="saveSkipPrefs()" style="background:var(--orange);color:#fff;border:none;border-radius:var(--radius-s);padding:11px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);width:100%;">&#10003; Save Skip Preferences</button>';
  html += '</div></div>'; /* end skip card */

  // Live-update the duration chip as dates change
  html += '<script>';
  html += '(function() {';
  html += '  function upd() {';
  html += '    var s = document.getElementById("ts-start");';
  html += '    var e = document.getElementById("ts-end");';
  html += '    if (!s || !e || !s.value || !e.value) return;';
  html += '    var ms = new Date(e.value+"T12:00:00") - new Date(s.value+"T12:00:00");';
  html += '    var d = Math.max(1, Math.round(ms/86400000)+1);';
  html += '    var chip = document.getElementById("ts-duration");';
  html += '    if (chip) chip.innerHTML = "\u{1F3CF} " + d + " days &nbsp;&bull;&nbsp; " + s.value + " \u2192 " + e.value;';
  html += '  }';
  html += '  var si = document.getElementById("ts-start");';
  html += '  var ei = document.getElementById("ts-end");';
  html += '  if (si) si.addEventListener("change", upd);';
  html += '  if (ei) ei.addEventListener("change", upd);';
  html += '})();';
  html += '<\/script>';

  /* â”€â”€ Duplicate Trip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  html += '<h2 class="section-title" style="margin-top:28px;"><i class="fa-solid fa-copy"></i> Duplicate Trip</h2>';
  html += '<div class="card"><div class="card-body">';
  html += '<div style="font-size:.83rem;color:var(--text-2);line-height:1.6;margin-bottom:14px;">Create a copy of the current trip plan so you can experiment with changes without affecting the original. The copy will be saved as your Custom Trip and you\'ll be switched to it.</div>';
  var dupName = ((appState.tripSettings && appState.tripSettings.tripName) || _BUILTIN_TRIP.tripName || 'Trip') + ' Copy';
  if (appState.activeTrip === 'custom' && appState.customTripData) {
    dupName = (appState.customTripData.tripName || 'Custom Trip') + ' Copy';
  }
  html += '<input id="dup-trip-name" type="text" value="' + dupName.replace(/"/g,'&quot;') + '" placeholder="Name for the copy" style="width:100%;padding:10px 12px;border:1.5px solid var(--border);border-radius:var(--radius-s);font-size:.88rem;font-family:var(--font);background:var(--bg);color:var(--text);outline:none;box-sizing:border-box;margin-bottom:12px;" />';
  html += '<button onclick="duplicateTrip()" style="width:100%;background:var(--orange);color:#fff;border:none;border-radius:var(--radius-s);padding:12px;font-size:.9rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ“‹ Duplicate This Trip</button>';
  html += '</div></div>';

  /* â”€â”€ Restart Trip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  html += '<h2 class="section-title" style="margin-top:28px;"><i class="fa-solid fa-rotate-left"></i> Trip Reset</h2>';
  html += '<div class="card"><div class="card-body">';
  html += '<div style="font-size:.83rem;color:var(--text-2);line-height:1.6;margin-bottom:14px;">If you accidentally tapped <strong>Start Trip</strong> or want to reset progress tracking back to zero, use this button. Your journals, photos, lists, and notes are kept â€” only the trip-started flag and odometer are reset.</div>';
  html += '<button onclick="restartTrip()" style="width:100%;background:#d32f2f;color:#fff;border:none;border-radius:var(--radius-s);padding:12px;font-size:.9rem;font-weight:800;cursor:pointer;font-family:var(--font);">â†º Restart Trip (Reset Progress)</button>';
  html += '</div></div>';

  el.innerHTML = html;
}

function restartTrip() {
  if (!confirm('Reset trip progress? Your journals, lists, and photos are kept â€” only the "started" flag and odometer reset.')) return;
  appState.tripStarted    = false;
  appState.tripStartTime  = null;
  appState.currentMiles   = 0;
  appState._tripRestartedAt = new Date().toISOString();
  saveState(appState);
  switchTab('dashboard');
  renderDashboard();
  showToast('â†º Trip has been restarted! Tap "Start Trip" on the dashboard when you\'re ready to go! ğŸš', 4500);
}

function duplicateTrip() {
  var nameEl = document.getElementById('dup-trip-name');
  var newName = (nameEl ? nameEl.value.trim() : '') || 'Trip Copy';

  // Deep-copy the currently active trip data
  var srcStops = JSON.parse(JSON.stringify(TRIP_STOPS));
  var srcDays  = JSON.parse(JSON.stringify(TRIP_DAYS));
  var srcStart = CONFIG.startDate;
  var srcEnd   = CONFIG.endDate;
  var srcDaysN = CONFIG.totalDays;
  var srcMiles = CONFIG.totalMiles;

  // Warn if overwriting an existing custom trip
  if (appState.customTripData && appState.activeTrip !== 'custom') {
    var existName = appState.customTripData.tripName || 'Custom Trip';
    if (!confirm('This will replace your existing "' + existName + '" custom trip with the duplicate. Continue?')) return;
  }

  appState.customTripData = {
    tripName:   newName,
    stops:      srcStops,
    days:       srcDays,
    startDate:  srcStart,
    endDate:    srcEnd,
    totalDays:  srcDaysN,
    totalMiles: srcMiles
  };
  appState.activeTrip = 'custom';
  saveState(appState);
  initApp();
  showToast('ğŸ“‹ "' + newName + '" created â€” you\'re now on the copy!', 3500);
}

function _buildDriveSplitSuggestion(dayNum) {
  var d = getDay(dayNum);
  if (!d || !d.driveDay) return null;
  var maxH      = (appState.drivingPrefs && appState.drivingPrefs.maxHours) || 4;
  var halfH     = d.driveHours / 2;
  var halfMi    = Math.round(d.miles / 2);
  var halfHDisp = halfH % 1 === 0 ? halfH + 'h' : halfH + 'h';
  var prevDayN  = d.day - 1;
  var destStop  = getStop(d.stopId);
  var destName  = destStop ? destStop.name : 'destination';
  var originName = 'previous stop';
  for (var pi = d.day - 2; pi >= 0; pi--) {
    var prev = TRIP_DAYS[pi];
    if (prev && prev.stopId !== d.stopId) {
      var ps = getStop(prev.stopId); if (ps) originName = ps.name; break;
    }
  }
  return {
    id:          'split-' + dayNum + '-' + Date.now(),
    sourceDay:   dayNum,
    title:       'ğŸš— Split ' + d.driveHours + 'h Drive â€” Day ' + dayNum + ' (' + originName + ' â†’ ' + destName + ')',
    detail:      'Day ' + prevDayN + ' evening: drive the first ~' + halfHDisp + ' (~' + halfMi + ' mi) â€” arriving late, so overnight at a Walmart parking lot or truck stop (no reservation needed). '
               + 'Day ' + dayNum + ' morning: drive the remaining ~' + halfHDisp + ' (~' + halfMi + ' mi) into ' + destName + '. '
               + 'Splits a ' + d.driveHours + 'h day into two ' + halfHDisp + ' drives â€” within your ' + maxH + 'h preference.',
    impact:      'Spreads ' + d.driveHours + 'h into two ' + halfHDisp + ' drives',
    affectedDays: [prevDayN, dayNum],
    status:      'pending',
    isSplitDrive: true,
    driveDay:     dayNum
  };
}

function addDriveSplitToAdjustments(dayNum) {
  var sugg = _buildDriveSplitSuggestion(dayNum);
  if (!sugg) return;
  if (!appState.decisions) appState.decisions = [];
  /* avoid duplicates */
  var already = appState.decisions.find(function(s) { return s.isSplitDrive && s.driveDay === dayNum; });
  if (already) { showToast('Split plan for Day ' + dayNum + ' already in Decisions!', 2200); return; }
  appState.decisions.unshift(sugg);
  saveState(appState);
  updateDecisionsBadge();
  // Collapse the warning banner in the day detail modal immediately
  var warnEl = document.getElementById('drive-split-warn-' + dayNum);
  if (warnEl) {
    warnEl.style.transition = 'opacity .3s';
    warnEl.style.opacity = '0';
    setTimeout(function() { if (warnEl.parentNode) warnEl.remove(); }, 320);
  }
  showToast('ğŸ”º Split plan added to Decisions!', 2400);
}

/* Apply the drive split immediately â€” splits hours and fixes schedule */
function applySplitDrive(dayNum) {
  if (!appState.dayOverrides) appState.dayOverrides = {};
  if (!appState.dayOverrides[dayNum]) appState.dayOverrides[dayNum] = {};
  var d = getDay(dayNum);
  if (d) appState.dayOverrides[dayNum].splitHours = Math.round(d.driveHours / 2 * 10) / 10;
  appState.dayOverrides[dayNum].splitResolved = true;
  // Also add/resolve in decisions
  if (!appState.decisions) appState.decisions = [];
  var existing = appState.decisions.find(function(s) { return s.isSplitDrive && s.driveDay === dayNum; });
  if (!existing) {
    var sugg = _buildDriveSplitSuggestion(dayNum);
    if (sugg) { sugg.status = 'resolved'; appState.decisions.unshift(sugg); }
  } else { existing.status = 'resolved'; }
  saveState(appState);
  updateDecisionsBadge();
  var warnEl = document.getElementById('drive-split-warn-' + dayNum);
  if (warnEl) {
    warnEl.style.transition = 'opacity .3s';
    warnEl.style.opacity = '0';
    setTimeout(function() { if (warnEl.parentNode) warnEl.remove(); }, 320);
  }
  renderSchedule();
  showToast('âœ‚ï¸ Drive split applied! Schedule updated.', 3000);
}

/* Accept the long drive â€” suppress warning, mark as decided */
function acceptLongDrive(dayNum) {
  if (!appState.dayOverrides) appState.dayOverrides = {};
  if (!appState.dayOverrides[dayNum]) appState.dayOverrides[dayNum] = {};
  appState.dayOverrides[dayNum].splitResolved = true;
  if (appState.decisions) {
    var existing = appState.decisions.find(function(s) { return s.isSplitDrive && s.driveDay === dayNum; });
    if (existing) existing.status = 'dismissed';
  }
  saveState(appState);
  updateDecisionsBadge();
  var warnEl = document.getElementById('drive-split-warn-' + dayNum);
  if (warnEl) {
    warnEl.style.transition = 'opacity .3s';
    warnEl.style.opacity = '0';
    setTimeout(function() { if (warnEl.parentNode) warnEl.remove(); }, 320);
  }
  showToast('ğŸ’ª Got it â€” driving the full distance on Day ' + dayNum + '!', 2500);
}

function generateDriveSplitSuggestions() {
  var maxH = (appState.drivingPrefs && appState.drivingPrefs.maxHours) || 4;
  var longDrives = TRIP_DAYS.filter(function(d) { return d.driveDay && d.driveHours > maxH; });
  if (!longDrives.length) { showToast('No drives over your ' + maxH + 'h limit!', 2200); return; }
  if (!appState.decisions) appState.decisions = [];
  var added = 0;
  longDrives.forEach(function(d) {
    var already = appState.decisions.find(function(s) { return s.isSplitDrive && s.driveDay === d.day; });
    if (!already) {
      var sugg = _buildDriveSplitSuggestion(d.day);
      if (sugg) { appState.decisions.unshift(sugg); added++; }
    }
  });
  saveState(appState);
  renderDecisions();
  updateDecisionsBadge();
  switchTab('decisions');
  showToast('ğŸ”º Added ' + added + ' split suggestion' + (added !== 1 ? 's' : '') + ' to Decisions!', 3000);
}

function _stopBreakPreview(everyH, mins) {
  if (!everyH) return 'No planned stop breaks.';
  var exH = 7; /* use a 7h drive day as example */
  var stops = Math.floor(exH / everyH);
  var extraH = (stops * mins / 60);
  var totalH = (exH + extraH).toFixed(1).replace(/\.0$/,'');
  return 'Example: a ' + exH + 'h drive â†’ ' + stops + ' stop' + (stops !== 1 ? 's' : '') + ' Ã— ' + mins + ' min = ' + totalH + 'h total. Drive time labels will show "Xh + stops."';
}

function _dpSetFreq(val) {
  /* Toggle button styles */
  [0,1,1.5,2,2.5,3].forEach(function(v) {
    var btn = document.getElementById('dpf-' + v.toString().replace('.','_'));
    if (!btn) return;
    var active = v === val;
    btn.style.background = active ? 'var(--orange)' : 'var(--bg)';
    btn.style.color       = active ? '#fff' : 'var(--text-2)';
    btn.style.borderColor = active ? 'var(--orange)' : 'var(--border)';
  });
  var durRow = document.getElementById('dp-break-dur-row');
  if (durRow) durRow.style.display = val > 0 ? 'block' : 'none';
  window._dpFreqVal = val;
  var curMins = window._dpMinsVal !== undefined ? window._dpMinsVal : ((appState.drivingPrefs && appState.drivingPrefs.stopBreakMins) || 15);
  var prev = document.getElementById('dp-break-preview');
  if (prev) prev.innerHTML = _stopBreakPreview(val, curMins);
}

function _dpSetMins(val) {
  [15,30,45,60].forEach(function(m) {
    var btn = document.getElementById('dpm-' + m);
    if (!btn) return;
    var active = m === val;
    btn.style.background = active ? 'var(--orange)' : 'var(--bg)';
    btn.style.color       = active ? '#fff' : 'var(--text-2)';
    btn.style.borderColor = active ? 'var(--orange)' : 'var(--border)';
  });
  window._dpMinsVal = val;
  var curFreq = window._dpFreqVal !== undefined ? window._dpFreqVal : ((appState.drivingPrefs && appState.drivingPrefs.stopBreakEvery) || 0);
  var prev = document.getElementById('dp-break-preview');
  if (prev) prev.innerHTML = _stopBreakPreview(curFreq, val);
}

function saveDrivingPrefs() {
  var maxEl = document.getElementById('dp-max-hours');
  if (!maxEl) return;
  var maxH = parseFloat(maxEl.value) || 4;
  maxH = Math.max(1, Math.min(12, maxH));
  var stopEvery = window._dpFreqVal !== undefined ? window._dpFreqVal : ((appState.drivingPrefs && appState.drivingPrefs.stopBreakEvery) || 0);
  var stopMins  = window._dpMinsVal !== undefined ? window._dpMinsVal  : ((appState.drivingPrefs && appState.drivingPrefs.stopBreakMins)  || 15);
  if (!appState.drivingPrefs) appState.drivingPrefs = {};
  appState.drivingPrefs.maxHours     = maxH;
  appState.drivingPrefs.stopBreakEvery = stopEvery;
  appState.drivingPrefs.stopBreakMins  = stopMins;
  window._dpFreqVal = undefined;
  window._dpMinsVal = undefined;
  saveState(appState);
  showToast('âœ… Driving preferences saved!', 2200);
  renderSchedule();
  renderTripSettings();
}

/* Update the login page header to reflect current trip settings */
function _updateLoginDisplay() {
  var ts    = appState.tripSettings || {};
  var name  = ts.tripName  || 'Maass Family RV 2026';
  var start = ts.startDate || CONFIG.startDate;
  var end   = ts.endDate   || CONFIG.endDate;
  var days  = ts.totalDays || CONFIG.totalDays || 46;
  function _ldf(d) {
    return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { month:'short', day:'numeric' });
  }
  var year      = start ? start.slice(0,4) : new Date().getFullYear();
  var dateRange = (start && end) ? _ldf(start) + ' â€“ ' + _ldf(end) + ', ' + year : '';
  var parts   = name.split(' ');
  var mid     = Math.ceil(parts.length / 2);
  var nameHtml = parts.length > 2
    ? parts.slice(0,mid).join(' ') + '<br>' + parts.slice(mid).join(' ')
    : name;
  var titleEl = document.getElementById('login-trip-title');
  var subEl   = document.getElementById('login-trip-sub');
  var datesEl = document.getElementById('login-trip-dates');
  if (titleEl) titleEl.innerHTML = nameHtml;
  if (subEl)   subEl.textContent = 'Your ' + days + '-day cross-country road trip';
  if (datesEl) datesEl.textContent = dateRange;
}

function saveTripSettings() {
  var nameEl  = document.getElementById('ts-name');
  var startEl = document.getElementById('ts-start');
  var endEl   = document.getElementById('ts-end');
  if (!startEl || !endEl) return;

  var newStart = startEl.value;
  var newEnd   = endEl.value;
  var newName  = nameEl ? nameEl.value.trim() : CONFIG.tripName;

  if (!newStart || !newEnd) { showToast('Please fill in both dates.', 2200); return; }
  if (new Date(newEnd) <= new Date(newStart)) { showToast('Return date must be after departure.', 2400); return; }

  var newDays = Math.max(1, Math.round((new Date(newEnd + 'T12:00:00') - new Date(newStart + 'T12:00:00')) / 86400000) + 1);

  // Persist to appState (no startCity/endCity â€” those come from TRIP_STOPS[0]/[last])
  var _saveAmps     = parseInt(((document.getElementById('ts-amps') || {}).value) || '50') || 50;
  var _saveTimeFmt  = ((document.getElementById('ts-timefmt') || {}).value) || '12h';
  var _saveDepTime  = ((document.getElementById('ts-deptime') || {}).value) || '08:00';
  var _saveLateArr  = ((document.getElementById('ts-latearrival') || {}).value) || '20:00';
  appState.tripSettings = { startDate: newStart, endDate: newEnd, tripName: newName, totalDays: newDays, rvAmps: _saveAmps, timeFormat: _saveTimeFmt, departureTime: _saveDepTime, latestArrival: _saveLateArr };
  saveState(appState);

  // Apply to live CONFIG so everything recalculates immediately
  CONFIG.startDate = newStart;
  CONFIG.endDate   = newEnd;
  CONFIG.totalDays = newDays;
  if (newName) CONFIG.tripName = newName;

  // Re-date all TRIP_DAYS from the new start date so schedule shows correct dates
  var _rdMs = new Date(newStart + 'T00:00:00').getTime();
  TRIP_DAYS.forEach(function(d, i) {
    var _rdD = new Date(_rdMs + i * 86400000);
    d.date = _rdD.getFullYear() + '-'
      + String(_rdD.getMonth() + 1).padStart(2, '0') + '-'
      + String(_rdD.getDate()).padStart(2, '0');
  });
  _updateTripSelector();

  // Refresh header stats
  document.getElementById('hdr-day').textContent = tripIsLive() ? tripDay() : 'â€”';
  var p = pct();
  document.getElementById('hdr-progress-bar').style.width  = p + '%';
  document.getElementById('hdr-progress-pct').textContent  = p + '%';
  updateHeaderMiles();

  // Re-render visible tab
  var activeTab = document.querySelector('.nav-tab.active');
  if (activeTab) {
    var tab = activeTab.dataset.tab;
    if (tab === 'dashboard')   renderDashboard();
    if (tab === 'schedule')    renderSchedule();
    if (tab === 'planner')     renderSchedule();
    if (tab === 'school')      renderSchool();
    if (tab === 'stops')       renderStops();
  }

  _updateLoginDisplay();
  showToast('âœ… Trip settings saved! Dates updated across the whole app.', 3000);
}

/* â”€â”€ EXPENSE TRACKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var EXP_CATS = [
  { id:'fuel',      icon:'â›½', label:'Fuel',       color:'#E65100', bg:'#FFF3E0' },
  { id:'campsite',  icon:'ğŸ•ï¸', label:'Campsite',   color:'#2E7D32', bg:'#E8F5E9' },
  { id:'food',      icon:'ğŸ”', label:'Food',        color:'#AD1457', bg:'#FCE4EC' },
  { id:'activity',  icon:'ğŸ¡', label:'Activity',    color:'#1565C0', bg:'#E3F2FD' },
  { id:'shopping',  icon:'ğŸ›ï¸', label:'Shopping',   color:'#6A1B9A', bg:'#F3E5F5' },
  { id:'other',     icon:'ğŸ’°', label:'Other',       color:'#546E7A', bg:'#ECEFF1' }
];
var _expScanB64  = null;
var _expScanMime = 'image/jpeg';
var _expSelCat   = 'food';

function renderExpenses() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;
  if (!appState.expenses)    appState.expenses    = [];
  if (!appState.tripBudget)  appState.tripBudget  = 10000;
  var total    = appState.expenses.reduce(function(s,e){ return s + (e.amount||0); }, 0);
  var budget   = appState.tripBudget;
  var pctUsed  = Math.min(100, Math.round(total / budget * 100));
  var barColor = pctUsed > 90 ? 'var(--red)' : pctUsed > 70 ? 'var(--orange)' : 'var(--green)';

  var html = '<h2 class="section-title"><i class="fa-solid fa-dollar-sign"></i> Trip Expenses</h2>';

  /* Budget bar */
  html += '<div style="background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:18px;">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">'
    + '<div style="font-weight:800;font-size:1rem;color:var(--text);">$' + total.toFixed(2) + ' <span style="font-size:.8rem;color:var(--text-3);font-weight:500;">spent</span></div>'
    + '<div style="display:flex;align-items:center;gap:8px;">'
    + '<span style="font-size:.8rem;color:var(--text-3);">Budget:</span>'
    + '<input type="number" value="' + budget + '" onchange="setTripBudget(this.value)" style="width:80px;border:1px solid var(--border);border-radius:100px;padding:3px 7px;font-size:.82rem;font-family:var(--font);text-align:right;" />'
    + '</div>'
    + '</div>'
    + '<div style="background:var(--border);border-radius:10px;height:12px;overflow:hidden;margin-bottom:5px;">'
    + '<div style="background:' + barColor + ';height:100%;border-radius:10px;width:' + pctUsed + '%;transition:width .5s;"></div>'
    + '</div>'
    + '<div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--text-3);">'
    + '<span>' + pctUsed + '% used</span>'
    + '<span>$' + Math.max(0, budget - total).toFixed(2) + ' remaining</span>'
    + '</div></div>';

  /* Category breakdown */
  var catTotals = {};
  EXP_CATS.forEach(function(c){ catTotals[c.id] = 0; });
  appState.expenses.forEach(function(e){ if(catTotals[e.category]!==undefined) catTotals[e.category] += e.amount||0; });
  html += '<div style="display:flex;flex-wrap:wrap;gap:7px;margin-bottom:18px;">';
  EXP_CATS.forEach(function(c) {
    if (catTotals[c.id] === 0) return;
    html += '<div style="background:' + c.bg + ';border:1.5px solid ' + c.color + ';border-radius:12px;padding:6px 12px;text-align:center;">'
      + '<div style="font-size:.68rem;font-weight:800;color:' + c.color + ';">' + c.icon + ' ' + c.label + '</div>'
      + '<div style="font-size:.9rem;font-weight:900;color:' + c.color + ';">$' + catTotals[c.id].toFixed(0) + '</div>'
      + '</div>';
  });
  html += '</div>';

  /* Add expense form */
  html += '<div style="background:var(--card);border:1.5px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:20px;">';
  html += '<div style="font-weight:800;font-size:.9rem;color:var(--text);margin-bottom:12px;">â• Add Expense</div>';

  /* Receipt scan button */
  html += '<div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;padding:10px 14px;background:linear-gradient(135deg,#f3e8ff,#e8f0ff);border:1.5px solid #c9a8f8;border-radius:12px;">'
    + '<span style="font-size:1.3rem;">ğŸ“·</span>'
    + '<div style="flex:1;">'
    + '<div style="font-weight:800;font-size:.82rem;color:#5b1fa3;">Scan a receipt</div>'
    + '<div style="font-size:.72rem;color:var(--text-3);">AI will fill in the details automatically</div>'
    + '</div>'
    + '<input type="file" id="exp-receipt-input" accept="image/*" style="display:none" onchange="scanExpenseReceipt(event)" />'
    + '<button onclick="document.getElementById(\'exp-receipt-input\').click()" style="background:#7B2FBE;color:#fff;border:none;border-radius:100px;padding:6px 14px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ“· Scan</button>'
    + '</div>';

  /* Category selector */
  html += '<div style="margin-bottom:10px;"><div style="font-size:.75rem;font-weight:700;color:var(--text-3);margin-bottom:6px;">CATEGORY</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
  EXP_CATS.forEach(function(c) {
    var sel = _expSelCat === c.id;
    html += '<button class="exp-cat-btn' + (sel?' sel':'') + '" onclick="setExpCat(\'' + c.id + '\')" style="' + (sel ? 'background:' + c.color + ';border-color:' + c.color + ';' : '') + '">' + c.icon + ' ' + c.label + '</button>';
  });
  html += '</div></div>';

  /* Amount + note */
  html += '<div style="display:flex;gap:10px;margin-bottom:10px;">'
    + '<div style="flex:1;">'
    + '<div style="font-size:.75rem;font-weight:700;color:var(--text-3);margin-bottom:4px;">AMOUNT ($)</div>'
    + '<input type="number" id="exp-amount" placeholder="0.00" step="0.01" min="0" style="width:100%;border:1.5px solid var(--border);border-radius:100px;padding:8px 12px;font-size:.92rem;font-family:var(--font);box-sizing:border-box;" />'
    + '</div>'
    + '<div style="flex:2;">'
    + '<div style="font-size:.75rem;font-weight:700;color:var(--text-3);margin-bottom:4px;">NOTE (optional)</div>'
    + '<input type="text" id="exp-note" placeholder="Gas station, restaurant nameâ€¦" style="width:100%;border:1.5px solid var(--border);border-radius:100px;padding:8px 12px;font-size:.88rem;font-family:var(--font);box-sizing:border-box;" />'
    + '</div>'
    + '</div>';
  html += '<button onclick="addExpense()" style="width:100%;background:var(--green);color:#fff;border:none;border-radius:100px;padding:11px;font-size:.9rem;font-weight:800;cursor:pointer;font-family:var(--font);">+ Add to Trip</button>';
  html += '</div>';

  /* Expense list */
  if (appState.expenses.length > 0) {
    html += '<div style="font-weight:800;font-size:.82rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px;">All Expenses</div>';
    var byDay = {};
    appState.expenses.forEach(function(e) {
      var dk = e.dayNum || 0;
      if (!byDay[dk]) byDay[dk] = [];
      byDay[dk].push(e);
    });
    var dayKeys = Object.keys(byDay).sort(function(a,b){ return b-a; });
    dayKeys.forEach(function(dk) {
      var dayLabel = dk > 0 ? 'Day ' + dk : 'Pre-trip';
      var dayTotal = byDay[dk].reduce(function(s,e){ return s + (e.amount||0); }, 0);
      html += '<div style="font-size:.72rem;font-weight:800;color:var(--text-3);text-transform:uppercase;letter-spacing:.04em;margin-bottom:4px;display:flex;justify-content:space-between;">'
        + '<span>' + dayLabel + '</span><span>$' + dayTotal.toFixed(2) + '</span></div>';
      byDay[dk].forEach(function(e) {
        var cat = EXP_CATS.find(function(c){ return c.id === e.category; }) || EXP_CATS[5];
        html += '<div style="display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:9px 12px;margin-bottom:5px;">'
          + '<span style="font-size:1.1rem;">' + cat.icon + '</span>'
          + '<div style="flex:1;">'
          + '<div style="font-size:.85rem;font-weight:700;color:var(--text);">' + (e.note || cat.label) + '</div>'
          + '<div style="font-size:.7rem;color:var(--text-3);">' + cat.label + (e.date ? ' Â· ' + e.date : '') + '</div>'
          + '</div>'
          + '<div style="font-weight:800;font-size:.92rem;color:' + cat.color + ';">$' + (e.amount||0).toFixed(2) + '</div>'
          + '<button onclick="deleteExpense(\'' + e.id + '\')" style="background:var(--red-l);border:1px solid var(--red);color:var(--red);border-radius:100px;padding:3px 8px;font-size:.72rem;cursor:pointer;font-family:var(--font);">âœ•</button>'
          + '</div>';
      });
      html += '<div style="height:8px;"></div>';
    });
  } else {
    html += '<div style="text-align:center;padding:30px 20px;color:var(--text-3);font-size:.88rem;">No expenses logged yet.<br>Scan a receipt or add your first entry above!</div>';
  }

  el.innerHTML = html;
}

function setExpCat(id) { _expSelCat = id; renderExpenses(); }
function setTripBudget(v) {
  appState.tripBudget = parseFloat(v) || 10000;
  saveState(appState);
}

function scanExpenseReceipt(e) {
  var file = e.target.files && e.target.files[0];
  if (!file) return;
  var mime = file.type || 'image/jpeg';
  var reader = new FileReader();
  reader.onload = function(ev) {
    var b64 = ev.target.result.split(',')[1];
    showToast('ğŸ” AI scanning receiptâ€¦', 2500);
    var prompt = 'You are an expense scanner. Look at this receipt image and return ONLY valid JSON with no markdown:\n'
      + '{"amount": 12.99, "category": "food", "note": "McDonald\'s"}\n'
      + 'Category must be one of: fuel, campsite, food, activity, shopping, other.\n'
      + 'amount is a number. note is the merchant or item name. If you cannot read the receipt clearly, make your best guess.';
    var body = JSON.stringify({
      contents:[{ parts:[{ text: prompt },{ inline_data:{ mime_type: mime, data: b64 }}]}],
      generationConfig:{ maxOutputTokens:120, temperature:0.2 }
    });
    fetch(GEMINI_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:body })
    .then(function(r){ return r.json(); })
    .then(function(data) {
      var raw = data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts&&data.candidates[0].content.parts[0]&&data.candidates[0].content.parts[0].text||'{}';
      raw = raw.replace(/```json/g,'').replace(/```/g,'').trim();
      var parsed = JSON.parse(raw);
      if (parsed.amount) {
        var amtEl = document.getElementById('exp-amount');
        if (amtEl) amtEl.value = parsed.amount.toFixed(2);
      }
      if (parsed.note) {
        var noteEl = document.getElementById('exp-note');
        if (noteEl) noteEl.value = parsed.note;
      }
      if (parsed.category && EXP_CATS.find(function(c){ return c.id===parsed.category; })) {
        _expSelCat = parsed.category;
        renderExpenses();
        /* Restore values after re-render */
        setTimeout(function() {
          var ae = document.getElementById('exp-amount');
          var ne = document.getElementById('exp-note');
          if (ae && parsed.amount) ae.value = parsed.amount.toFixed(2);
          if (ne && parsed.note)   ne.value = parsed.note;
        }, 50);
      }
      showToast('âœ… Receipt scanned! Check the fields.', 2500);
    })
    .catch(function(){ showToast('Could not read receipt â€” fill in manually', 2500); });
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function addExpense() {
  var amtEl  = document.getElementById('exp-amount');
  var noteEl = document.getElementById('exp-note');
  var amt    = parseFloat(amtEl ? amtEl.value : 0);
  if (!amt || amt <= 0) { showToast('Enter a valid amount', 1600); return; }
  if (!appState.expenses) appState.expenses = [];
  var today = new Date();
  appState.expenses.unshift({
    id:       'exp_' + Date.now(),
    category: _expSelCat,
    amount:   amt,
    note:     noteEl ? noteEl.value.trim() : '',
    dayNum:   tripDay(),
    date:     today.toLocaleDateString('en-US',{month:'short',day:'numeric'})
  });
  saveState(appState);
  renderExpenses();
  showToast('ğŸ’° Expense added!', 1600);
}

function deleteExpense(id) {
  if (!appState.expenses) return;
  appState.expenses = appState.expenses.filter(function(e){ return e.id !== id; });
  saveState(appState);
  renderExpenses();
}

/* â”€â”€ RV MAINTENANCE LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var RV_ITEMS = [
  { id:'gray',     icon:'ğŸª£', label:'Gray Water Dump',    warn:4,  unit:'days' },
  { id:'black',    icon:'ğŸ’©', label:'Black Water Dump',   warn:7,  unit:'days' },
  { id:'fresh',    icon:'ğŸ’§', label:'Fresh Water Fill',   warn:3,  unit:'days' },
  { id:'tires',    icon:'ğŸ›', label:'Tire Pressure Check',warn:7,  unit:'days' },
  { id:'propane',  icon:'ğŸ”¥', label:'Propane Level Check',warn:5,  unit:'days' },
  { id:'generator',icon:'âš¡', label:'Generator Check',   warn:14, unit:'days' },
  { id:'oil',      icon:'ğŸ›¢ï¸', label:'Oil Check',         warn:14, unit:'days' },
  { id:'slides',   icon:'ğŸ“', label:'Slide-outs Lubed',  warn:30, unit:'days' }
];

function renderRVMaintenance() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;
  if (!appState.rvLog) appState.rvLog = {};
  var now = new Date();
  var html = '<h2 class="section-title"><i class="fa-solid fa-wrench"></i> RV Maintenance</h2>';
  html += '<div style="font-size:.82rem;color:var(--text-3);margin-bottom:16px;">Tap âœ… Done when completed. Red = overdue, yellow = due soon.</div>';
  html += '<div style="display:flex;flex-direction:column;gap:8px;">';
  RV_ITEMS.forEach(function(item) {
    var last = appState.rvLog[item.id] ? new Date(appState.rvLog[item.id]) : null;
    var daysSince = last ? Math.floor((now - last) / 86400000) : null;
    var overdue  = daysSince !== null && daysSince >= item.warn;
    var dueSoon  = daysSince !== null && daysSince >= item.warn * 0.75 && !overdue;
    var never    = daysSince === null;
    var bg    = overdue ? '#ffebee' : dueSoon ? '#fff8e1' : (never ? 'var(--bg)' : 'var(--green-l)');
    var border= overdue ? 'var(--red)' : dueSoon ? 'var(--orange)' : (never ? 'var(--border)' : 'var(--green)');
    var badge = overdue ? '<span style="background:var(--red);color:#fff;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:100px;white-space:nowrap;">OVERDUE</span>'
              : dueSoon ? '<span style="background:var(--orange);color:#fff;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:100px;white-space:nowrap;">DUE SOON</span>'
              : never   ? '<span style="background:var(--text-3);color:#fff;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:100px;">NEVER LOGGED</span>'
              : '<span style="background:var(--green);color:#fff;font-size:.65rem;font-weight:800;padding:2px 7px;border-radius:100px;white-space:nowrap;">OK</span>';
    var lastStr = last ? ('Last: ' + last.toLocaleDateString('en-US',{month:'short',day:'numeric'}) + ' (' + daysSince + 'd ago)') : 'Never done â€” tap Done when complete';
    html += '<div style="display:flex;align-items:center;gap:12px;background:' + bg + ';border:1.5px solid ' + border + ';border-radius:12px;padding:12px 14px;">'
      + '<span style="font-size:1.4rem;flex-shrink:0;">' + item.icon + '</span>'
      + '<div style="flex:1;min-width:0;">'
      + '<div style="font-weight:700;font-size:.88rem;color:var(--text);">' + item.label + '</div>'
      + '<div style="font-size:.72rem;color:var(--text-3);margin-top:2px;">' + lastStr + '</div>'
      + '</div>'
      + badge
      + '<button onclick="logRVItem(\'' + item.id + '\')" style="background:var(--green);color:#fff;border:none;border-radius:100px;padding:7px 12px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);flex-shrink:0;white-space:nowrap;">âœ… Done</button>'
      + '</div>';
  });
  html += '</div>';

  /* Overdue count banner */
  var overdueItems = RV_ITEMS.filter(function(item) {
    var last = appState.rvLog[item.id] ? new Date(appState.rvLog[item.id]) : null;
    if (!last) return false;
    return Math.floor((now - last) / 86400000) >= item.warn;
  });
  if (overdueItems.length > 0) {
    html = '<div style="background:#ffebee;border:1.5px solid var(--red);border-radius:12px;padding:12px 16px;margin-bottom:16px;font-size:.85rem;font-weight:700;color:var(--red);">'
      + 'âš ï¸ ' + overdueItems.length + ' maintenance item' + (overdueItems.length>1?'s':'') + ' overdue: ' + overdueItems.map(function(i){ return i.label; }).join(', ')
      + '</div>' + html;
  }

  el.innerHTML = html;
}

function logRVItem(id) {
  if (!appState.rvLog) appState.rvLog = {};
  appState.rvLog[id] = new Date().toISOString();
  saveState(appState);
  renderRVMaintenance();
  var item = RV_ITEMS.find(function(i){ return i.id === id; });
  showToast('âœ… ' + (item ? item.label : 'Item') + ' logged!', 1800);
}

/* â”€â”€ MEMORY BOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderMemoryBook() {
  var el = document.getElementById('tools-sub-content');
  if (!el) return;
  var entries = [];
  try {
    var raw = localStorage.getItem('rv_journal');
    entries = raw ? JSON.parse(raw) : [];
  } catch(e) {}
  var html = '<h2 class="section-title"><i class="fa-solid fa-book-open"></i> Memory Book</h2>';
  html += '<div style="background:linear-gradient(135deg,#AD1457,#6A1B9A);color:#fff;border-radius:var(--radius);padding:20px 24px;margin-bottom:20px;text-align:center;">'
    + '<div style="font-size:2.5rem;margin-bottom:8px;">ğŸ“–</div>'
    + '<div style="font-weight:900;font-size:1.2rem;margin-bottom:4px;">Maass Family RV Adventure 2026</div>'
    + '<div style="opacity:.85;font-size:.88rem;margin-bottom:16px;">Turn all your journal entries into a beautiful printable memory book</div>'
    + '<div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">'
    + '<div style="background:rgba(255,255,255,.2);border-radius:12px;padding:8px 16px;">'
    + '<div style="font-size:1.4rem;font-weight:900;">' + entries.length + '</div>'
    + '<div style="font-size:.72rem;opacity:.8;">journal entries</div>'
    + '</div>'
    + '<div style="background:rgba(255,255,255,.2);border-radius:12px;padding:8px 16px;">'
    + '<div style="font-size:1.4rem;font-weight:900;">' + entries.reduce(function(s,e){ return s + (e.photos ? e.photos.length : 0); }, 0) + '</div>'
    + '<div style="font-size:.72rem;opacity:.8;">photos</div>'
    + '</div>'
    + '<div style="background:rgba(255,255,255,.2);border-radius:12px;padding:8px 16px;">'
    + '<div style="font-size:1.4rem;font-weight:900;">46</div>'
    + '<div style="font-size:.72rem;opacity:.8;">days of adventure</div>'
    + '</div>'
    + '</div>'
    + '</div>';

  html += '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;">';
  var features = [
    {icon:'ğŸ—“ï¸', t:'Day-by-day layout', d:'Each journal entry gets its own page with date and location'},
    {icon:'ğŸ“¸', t:'Your photos included', d:'All journal photos are embedded in the book'},
    {icon:'ğŸ–¨ï¸', t:'Print-ready formatting', d:'Open in browser â†’ Print â†’ Save as PDF for a keepsake'},
    {icon:'âœï¸', t:'Kid-written entries', d:'Everything your family wrote, preserved exactly as typed'}
  ];
  features.forEach(function(f) {
    html += '<div style="display:flex;align-items:flex-start;gap:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 14px;">'
      + '<span style="font-size:1.4rem;">' + f.icon + '</span>'
      + '<div><div style="font-weight:700;font-size:.88rem;color:var(--text);">' + f.t + '</div>'
      + '<div style="font-size:.78rem;color:var(--text-3);">' + f.d + '</div></div>'
      + '</div>';
  });
  html += '</div>';

  if (entries.length === 0) {
    html += '<div style="background:var(--orange-l);border:1.5px solid var(--orange);border-radius:12px;padding:14px 16px;font-size:.85rem;color:var(--text);margin-bottom:16px;">ğŸ“ No journal entries yet! Start writing in the Journal tab â€” your memories will appear here once the trip begins.</div>';
  }

  html += '<button onclick="generateMemoryBook()" style="width:100%;background:linear-gradient(135deg,#AD1457,#6A1B9A);color:#fff;border:none;border-radius:100px;padding:16px;font-size:1rem;font-weight:900;cursor:pointer;font-family:var(--font);letter-spacing:.01em;box-shadow:0 4px 16px rgba(106,27,154,.3);">'
    + 'ğŸ“– Generate My Memory Book</button>';

  el.innerHTML = html;
}

function generateMemoryBook() {
  var entries = [];
  try {
    var raw = localStorage.getItem('rv_journal');
    entries = raw ? JSON.parse(raw) : [];
  } catch(e) {}

  var html = '<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8">'
    + '<title>Maass Family RV Adventure 2026 â€” Memory Book</title>'
    + '<style>'
    + 'body{margin:0;font-family:Georgia,serif;background:#fff;color:#222;}'
    + '.cover{background:linear-gradient(135deg,#AD1457,#6A1B9A);color:#fff;min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:60px 40px;box-sizing:border-box;page-break-after:always;}'
    + '.cover h1{font-size:3rem;margin:0 0 16px;letter-spacing:-.02em;}'
    + '.cover h2{font-size:1.4rem;font-weight:400;opacity:.85;margin:0 0 32px;}'
    + '.cover .stats{display:flex;gap:40px;justify-content:center;flex-wrap:wrap;}'
    + '.cover .stat{background:rgba(255,255,255,.2);border-radius:16px;padding:20px 32px;}'
    + '.cover .stat-n{font-size:2.5rem;font-weight:900;}'
    + '.cover .stat-l{font-size:.9rem;opacity:.8;}'
    + '.entry{padding:48px 64px;border-bottom:3px solid #f0e8ff;page-break-after:always;max-width:860px;margin:0 auto;}'
    + '.entry-header{border-left:6px solid #AD1457;padding-left:20px;margin-bottom:28px;}'
    + '.entry-day{font-size:.85rem;font-weight:700;color:#AD1457;text-transform:uppercase;letter-spacing:.08em;}'
    + '.entry-title{font-size:1.6rem;font-weight:700;margin:4px 0;}'
    + '.entry-meta{font-size:.85rem;color:#888;}'
    + '.entry-text{font-size:1rem;line-height:1.8;margin:20px 0;white-space:pre-wrap;}'
    + '.photo-grid{display:flex;flex-wrap:wrap;gap:12px;margin-top:20px;}'
    + '.photo-grid img{max-width:calc(50% - 6px);border-radius:10px;object-fit:cover;max-height:280px;}'
    + '@media print{'
    + '  .cover{page-break-after:always;}'
    + '  .entry{page-break-after:always;}'
    + '  body{-webkit-print-color-adjust:exact;print-color-adjust:exact;}'
    + '}'
    + '</style></head><body>';

  /* Cover page */
  html += '<div class="cover">'
    + '<div style="font-size:5rem;margin-bottom:24px;">ğŸš</div>'
    + '<h1>Maass Family RV Adventure</h1>'
    + '<h2>February 28 â€“ April 14, 2026</h2>'
    + '<div class="stats">'
    + '<div class="stat"><div class="stat-n">46</div><div class="stat-l">Days</div></div>'
    + '<div class="stat"><div class="stat-n">~7,000</div><div class="stat-l">Miles</div></div>'
    + '<div class="stat"><div class="stat-n">' + entries.length + '</div><div class="stat-l">Journal Entries</div></div>'
    + '</div>'
    + '<div style="margin-top:48px;font-size:1rem;opacity:.7;">Generated ' + new Date().toLocaleDateString('en-US',{month:'long',day:'numeric',year:'numeric'}) + '</div>'
    + '</div>';

  /* Entries */
  if (entries.length === 0) {
    html += '<div class="entry"><h2>No journal entries yet!</h2><p>Start writing in the Journal tab on your trip app.</p></div>';
  } else {
    entries.sort(function(a,b){ return (a.dayNum||0)-(b.dayNum||0); });
    entries.forEach(function(e) {
      var d = e.dayNum ? getDay(e.dayNum) : null;
      var stop = d ? getStop(d.stopId) : null;
      html += '<div class="entry">'
        + '<div class="entry-header">'
        + '<div class="entry-day">Day ' + (e.dayNum||'?') + (d ? ' &nbsp;Â·&nbsp; ' + d.date : '') + '</div>'
        + '<div class="entry-title">' + (stop ? stop.emoji + ' ' + stop.name : 'On the Road') + '</div>'
        + '<div class="entry-meta">' + (e.location || '') + (e.mood ? ' &nbsp;Â·&nbsp; Mood: ' + e.mood : '') + '</div>'
        + '</div>'
        + '<div class="entry-text">' + (e.text || '').replace(/&/g,'&amp;').replace(/</g,'&lt;') + '</div>';
      if (e.photos && e.photos.length > 0) {
        html += '<div class="photo-grid">';
        e.photos.forEach(function(p) {
          html += '<img src="' + p + '" alt="Trip photo" />';
        });
        html += '</div>';
      }
      html += '</div>';
    });
  }

  html += '<div style="text-align:center;padding:60px;color:#888;font-size:.9rem;">â™¥ The Maass Family RV Adventure 2026 â™¥</div>';
  html += '</body></html>';

  var w = window.open('', '_blank');
  if (!w) { showToast('Allow pop-ups to generate the memory book', 2500); return; }
  w.document.write(html);
  w.document.close();
  setTimeout(function() { w.print(); }, 800);
}

/* â”€â”€ GAMES TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
/* â”€â”€ US STATES for License Plate Bingo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var US_STATES_LP = [
  {abbr:'AL',name:'Alabama'},{abbr:'AK',name:'Alaska'},{abbr:'AZ',name:'Arizona'},
  {abbr:'AR',name:'Arkansas'},{abbr:'CA',name:'California'},{abbr:'CO',name:'Colorado'},
  {abbr:'CT',name:'Connecticut'},{abbr:'DE',name:'Delaware'},{abbr:'FL',name:'Florida'},
  {abbr:'GA',name:'Georgia'},{abbr:'HI',name:'Hawaii'},{abbr:'ID',name:'Idaho'},
  {abbr:'IL',name:'Illinois'},{abbr:'IN',name:'Indiana'},{abbr:'IA',name:'Iowa'},
  {abbr:'KS',name:'Kansas'},{abbr:'KY',name:'Kentucky'},{abbr:'LA',name:'Louisiana'},
  {abbr:'ME',name:'Maine'},{abbr:'MD',name:'Maryland'},{abbr:'MA',name:'Massachusetts'},
  {abbr:'MI',name:'Michigan'},{abbr:'MN',name:'Minnesota'},{abbr:'MS',name:'Mississippi'},
  {abbr:'MO',name:'Missouri'},{abbr:'MT',name:'Montana'},{abbr:'NE',name:'Nebraska'},
  {abbr:'NV',name:'Nevada'},{abbr:'NH',name:'New Hampshire'},{abbr:'NJ',name:'New Jersey'},
  {abbr:'NM',name:'New Mexico'},{abbr:'NY',name:'New York'},{abbr:'NC',name:'North Carolina'},
  {abbr:'ND',name:'North Dakota'},{abbr:'OH',name:'Ohio'},{abbr:'OK',name:'Oklahoma'},
  {abbr:'OR',name:'Oregon'},{abbr:'PA',name:'Pennsylvania'},{abbr:'RI',name:'Rhode Island'},
  {abbr:'SC',name:'South Carolina'},{abbr:'SD',name:'South Dakota'},{abbr:'TN',name:'Tennessee'},
  {abbr:'TX',name:'Texas'},{abbr:'UT',name:'Utah'},{abbr:'VT',name:'Vermont'},
  {abbr:'VA',name:'Virginia'},{abbr:'WA',name:'Washington'},{abbr:'WV',name:'West Virginia'},
  {abbr:'WI',name:'Wisconsin'},{abbr:'WY',name:'Wyoming'}
];

/* â”€â”€ Mad Libs blanks template â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _ML_BLANKS = [
  {label:'adjective',            placeholder:'wiggly'},
  {label:'your last name',       placeholder:'Maass'},
  {label:'silly adjective',      placeholder:'smelly'},
  {label:'RV nickname',          placeholder:'Big Betsy'},
  {label:'verb (past tense)',    placeholder:'snored'},
  {label:'verb (past tense)',    placeholder:'sang loudly'},
  {label:'adjective',            placeholder:'enormous'},
  {label:'animal',               placeholder:'armadillo'},
  {label:'what everyone did',    placeholder:'screamed'},
  {label:'adjective',            placeholder:'greasy'},
  {label:'US state or city',     placeholder:'Texas'},
  {label:'weird food',           placeholder:'pickle pie'},
  {label:'condiment',            placeholder:'ketchup'},
  {label:'adjective',            placeholder:'unforgettable'},
  {label:'family member\'s name',placeholder:'Dad'},
  {label:'verb (past tense)',    placeholder:'snored'},
  {label:'animal',               placeholder:'raccoon'},
  {label:'exclamation',          placeholder:'Ever'}
];

var _name5Categories = [
  'Things you might see from a highway','Types of animals in the Southwest',
  'Things you need for camping','US States','Famous national parks',
  'Types of food at a roadside diner','Things you find in an RV',
  'Types of trucks on the highway','Animals that live in the desert',
  'Things you find at a rest stop','Words that rhyme with "trip"',
  'Types of pizza toppings','Cartoon characters','Things that are orange',
  'Types of clouds you can see','Things you see at a campground'
];
var _name5TimerInterval = null;

var GAMES = [
  {
    id:'license', emoji:'ğŸš—', title:'License Plate Bingo',
    ages:'All ages', players:'2+', time:'Whole trip',
    color:'#1565C0', colorL:'#E3F2FD',
    desc:'Spot license plates from as many US states as possible. First to find all 50 wins â€” or just see how many you can collect by the end of the trip!',
    rules:['Call out a state when you spot its plate','Each player keeps their own list','Rarest plates: Alaska, Hawaii, North Dakota','Bonus: find Canada or Mexico plates!'],
    tip:'Download a printable bingo card or just keep a running tally in the Journal tab!'
  },
  {
    id:'alphabet', emoji:'ğŸ”¤', title:'Alphabet Game',
    ages:'5+', players:'1â€“6', time:'20â€“40 min',
    color:'#2E7D32', colorL:'#E8F5E9',
    desc:'Find every letter of the alphabet â€” in order â€” on road signs, billboards, storefronts, and license plates.',
    rules:['Must go in order A â†’ Z','Letters must appear at the START of a word','Q and Z are the hardest â€” look for "Quality" and "Zone"','Cooperate or compete!'],
    tip:'Q tip: watch for "Quality Inn" signs. Z tip: "Zone" speed limit signs work!'
  },
  {
    id:'20q', emoji:'ğŸ¤”', title:'20 Questions',
    ages:'6+', players:'2+', time:'10â€“15 min',
    color:'#6A1B9A', colorL:'#F3E5F5',
    desc:'One person thinks of something (animal, vegetable, or mineral). Everyone else asks up to 20 yes/no questions to figure out what it is.',
    rules:['One thinker, everyone else guesses','Only YES or NO answers allowed','You get exactly 20 questions total','Winner is whoever guesses correctly â€” or the thinker if nobody gets it'],
    tip:'Start broad: "Is it alive?" â†’ "Is it an animal?" â†’ "Is it bigger than a car?"'
  },
  {
    id:'ispy', emoji:'ğŸ‘ï¸', title:'I Spy',
    ages:'3+', players:'2+', time:'5â€“10 min',
    color:'#E65100', colorL:'#FFF3E0',
    desc:'Classic! One person picks something they can see and gives a clue. Everyone else guesses what it is.',
    rules:['Say "I spy with my little eye, something beginning with [letter]"','Or use color: "something RED"','Object must be visible right now (not something you passed)','First to guess correctly goes next'],
    tip:'For toddlers, use colors instead of letters. Works great at rest stops too!'
  },
  {
    id:'storytelling', emoji:'ğŸ“–', title:'Round-Robin Story',
    ages:'5+', players:'3+', time:'Unlimited',
    color:'#AD1457', colorL:'#FCE4EC',
    desc:'Build a wacky adventure story together â€” one sentence at a time. Nobody knows where it\'s going!',
    rules:['Someone starts: "Once upon a time, an RV family found a mysterious map..."','Each person adds ONE sentence','Must continue the story (no ending it early!)','Bonus: record it and play it back â€” hilarious!'],
    tip:'Name the characters after the family! The Maass Family\'s RV Adventure is already halfway to a story.'
  },
  {
    id:'truckwave', emoji:'ğŸš›', title:'Trucker Wave',
    ages:'All ages', players:'1+', time:'Whole trip',
    color:'#00695C', colorL:'#E0F2F1',
    desc:'Get big-rig truck drivers to honk their horns! Make the classic arm-pump gesture at truckers and count how many actually honk.',
    rules:['Pump your arm up and down when a big rig passes','Count every honk as 1 point','Double points if two trucks honk at once','Family team or individual competition'],
    tip:'Works best from the right side of the RV where truckers can see you more easily!'
  },
  {
    id:'carcolor', emoji:'ğŸ¨', title:'Car Color Count',
    ages:'3+', players:'2+', time:'15 min',
    color:'#1565C0', colorL:'#E8EAF6',
    desc:'Pick a color, set a timer for 5 minutes, and count how many cars of that color drive by. Highest count wins that round!',
    rules:['Everyone picks a DIFFERENT color','Set timer for 5 minutes','Count every car of your color you see','Reveal counts when timer ends â€” highest wins!'],
    tip:'White and black are common â€” go for rarer colors like yellow or purple for a tougher challenge!'
  },
  {
    id:'wouldyou', emoji:'ğŸŒ¶ï¸', title:'Would You Rather?',
    ages:'7+', players:'2+', time:'15â€“30 min',
    color:'#BF360C', colorL:'#FBE9E7',
    desc:'Take turns asking impossible choices. No "neither" allowed â€” you MUST pick one!',
    rules:['Ask: "Would you rather... or...?"','Everyone must answer AND explain why','Debate each choice â€” more fun that way!','No "both" or "neither" answers allowed'],
    examples:['Would you rather eat only gas station food for a week OR sleep in a tent every night?','Would you rather visit every National Park OR every Major League Baseball stadium?','Would you rather drive through a tornado OR an earthquake?']
  },
  {
    id:'geography', emoji:'ğŸŒ', title:'Geography Chain',
    ages:'8+', players:'2+', time:'15â€“20 min',
    color:'#1B5E20', colorL:'#F1F8E9',
    desc:'Name a place â€” city, state, country, river, mountain. Next person must name a place starting with the LAST LETTER of your place.',
    rules:['Player 1: "Texas" â†’ Player 2 must start with "S"','"San Antonio" â†’ next starts with "O"','No repeating places','If you can\'t think of one in 10 seconds, you\'re out!'],
    tip:'Save yourself with "A" â€” Alaska, Argentina, Arizona, Atlanta, Amsterdamâ€¦'
  },
  {
    id:'spotit', emoji:'ğŸ”­', title:'Roadside Spotter',
    ages:'4+', players:'All', time:'Whole trip',
    color:'#4527A0', colorL:'#EDE7F6',
    desc:'Take turns calling out roadside things to spot. Points awarded for how hard they are to find!',
    spots:[
      {thing:'Water tower', pts:1},{thing:'Horse or cow', pts:1},{thing:'Cemetery', pts:1},
      {thing:'Fire truck', pts:2},{thing:'Tractor in a field', pts:2},{thing:'School bus', pts:1},
      {thing:'State trooper', pts:2},{thing:'Hot air balloon', pts:5},{thing:'Drive-in movie theater', pts:10},
      {thing:'An RV bigger than ours', pts:3},{thing:'Rainbow', pts:5},{thing:'Roadrunner bird', pts:8}
    ],
    rules:['Shout it when you see it!','First to spot gets the points','Keep a running tally','Count up points at dinner!']
  },
  {
    id:'nomymom', emoji:'ğŸ§ ', title:'Name 5',
    ages:'7+', players:'2+', time:'10â€“20 min',
    color:'#F57F17', colorL:'#FFFDE7',
    desc:'Give someone a category and challenge them to name 5 things in that category before a 10-second countdown ends.',
    rules:['Pick a person and give them a category','They must name 5 things before time runs out','No repeats between turns','Can\'t say "uh" or pause more than 2 seconds'],
    examples:['5 types of trees','5 US Presidents','5 things you find at a campground','5 animals you might see in the Ozarks','5 things in a kitchen']
  },
  {
    id:'aiquest', emoji:'ğŸ¤–', title:'AI Quest',
    ages:'5+', players:'All', time:'20â€“40 min',
    color:'#7B2FBE', colorL:'#F3E5F5',
    desc:'AI generates a custom trivia quiz or scavenger hunt based on wherever you are right now â€” no TripGenie needed!',
    rules:['Tap "Trivia Quiz" for 8 AI-generated questions about your current stop','Or tap "Scavenger Hunt" for 10 things to spot from the car','Take turns answering trivia â€” give points for correct answers','First to spot all scavenger hunt items wins!'],
    tip:'The questions and hunt items are tailored to your exact location on the trip!'
  },
  {
    id:'madlibs', emoji:'âœï¸', title:'RV Mad Libs',
    ages:'5+', players:'2+', time:'10â€“20 min',
    color:'#E65100', colorL:'#FFF3E0',
    desc:'Fill in silly words one at a time â€” without peeking at the story! Then read the hilarious results out loud. Every round is different.',
    rules:['One person reads only the LABEL (e.g. "give me an adjective")','Others call out words without seeing the story','Fill all 18 blanks, THEN tap Reveal!','Read the story out loud â€” the sillier the words, the funnier it gets!'],
    tip:'Try using family members\' names, sounds, or inside jokes for maximum laughs!',
    isMadLibs: true
  }
];

var _gameFilter = 'all';
/* Games that have an interactive Play-Now tool (not just info cards) */
var _PLAY_IDS = { license:1, alphabet:1, truckwave:1, spotit:1, wouldyou:1, nomymom:1, '20q':1, carcolor:1, madlibs:1, aiquest:1 };

function renderGames() {
  var el = document.getElementById('fun-sub-content');
  if (!el) return;
  var html = '';

  /* Header */
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-gamepad"></i> Road Trip Games</h2>'
    + '<div style="font-size:.8rem;color:var(--text-3);">' + GAMES.length + ' games ready to play</div>'
    + '</div>';

  /* Quick-play suggestion banner */
  var dayNum  = tripDay();
  var dayData = getDay(dayNum);
  var stop    = dayData ? getStop(dayData.stopId) : null;
  var driveDay = dayData && dayData.driveDay;
  var suggGame = driveDay ? GAMES[0] : GAMES[4];
  html += '<div style="background:linear-gradient(135deg,#7B2FBE,#4A90D9);color:#fff;border-radius:var(--radius);padding:16px 20px;margin-bottom:20px;display:flex;align-items:center;gap:14px;">'
    + '<span style="font-size:2rem;">' + suggGame.emoji + '</span>'
    + '<div style="flex:1;">'
    + '<div style="font-size:.72rem;font-weight:800;opacity:.8;text-transform:uppercase;letter-spacing:.06em;">Suggested for ' + (driveDay ? 'today\'s drive' : 'right now') + '</div>'
    + '<div style="font-weight:800;font-size:1rem;margin:2px 0;">' + suggGame.title + '</div>'
    + '<div style="font-size:.8rem;opacity:.85;">' + suggGame.desc.substring(0, 80) + 'â€¦</div>'
    + '</div>'
    + '<button onclick="openGameCard(\'' + suggGame.id + '\')" style="background:rgba(255,255,255,.2);border:1.5px solid rgba(255,255,255,.5);color:#fff;border-radius:100px;padding:7px 16px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;">Play â–¶</button>'
    + '</div>';

  /* Game cards grid â€” 2 columns */
  html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">';
  GAMES.forEach(function(g) {

    html += '<div style="background:var(--card);border:1.5px solid ' + g.colorL.replace('FD','CA').replace('F9','AA').replace('E9','CC').replace('F5','D0').replace('E0','B0').replace('F6','D0').replace('E4','C0').replace('F8','D0').replace('F2','C8').replace('DE7','BC0').replace('E7','C5').replace('F6','D0') + ';border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:transform .15s,box-shadow .15s;" onclick="openGameCard(\'' + g.id + '\')" onmouseover="this.style.transform=\'translateY(-2px)\';this.style.boxShadow=\'0 6px 20px rgba(0,0,0,.12)\'" onmouseout="this.style.transform=\'\';this.style.boxShadow=\'\'">';
    /* Card header */
    html += '<div style="background:' + g.color + ';padding:14px 16px;display:flex;align-items:center;gap:10px;">'
      + '<span style="font-size:1.8rem;line-height:1;">' + g.emoji + '</span>'
      + '<div style="flex:1;">'
      + '<div style="font-weight:900;color:#fff;font-size:.97rem;">' + g.title + '</div>'
      + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-top:4px;">'
      + '<span style="background:rgba(255,255,255,.2);color:#fff;font-size:.64rem;font-weight:700;padding:2px 6px;border-radius:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">ğŸ‘¥ ' + g.players + '</span>'
      + '<span style="background:rgba(255,255,255,.2);color:#fff;font-size:.64rem;font-weight:700;padding:2px 6px;border-radius:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">â± ' + g.time + '</span>'
      + '<span style="background:rgba(255,255,255,.2);color:#fff;font-size:.64rem;font-weight:700;padding:2px 6px;border-radius:100px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Age ' + g.ages + '</span>'
      + '</div>'
      + '</div>'
      + (g.isAi ? '<span style="background:rgba(255,255,255,.25);color:#fff;font-size:.62rem;font-weight:900;padding:3px 8px;border-radius:100px;letter-spacing:.04em;">AI</span>' : '')
      + '</div>';
    /* Card body */
    html += '<div style="padding:12px 14px;">'
      + '<div style="font-size:.83rem;color:var(--text-2);line-height:1.5;">' + g.desc.substring(0, 100) + (g.desc.length > 100 ? 'â€¦' : '') + '</div>'
      + '<div style="margin-top:10px;text-align:right;">'
      + '<button onclick="event.stopPropagation();openGameCard(\'' + g.id + '\')" style="background:' + g.color + ';color:#fff;border:none;border-radius:100px;padding:8px 18px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:var(--font);">' + (_PLAY_IDS[g.id] ? 'ğŸ® Play Now' : 'ğŸ“– How to Play') + '</button>'
      + '</div>'
      + '</div>'
      + '</div>';
  });
  html += '</div>';

  el.innerHTML = html;
}

function setGameFilter(f) {
  _gameFilter = f;
  renderGames();
}

function openGameCard(id) {
  var g = GAMES.find(function(x){ return x.id === id; });
  if (!g) return;

  var html = '';

  /* â”€â”€ Mad Libs: special full-screen form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  if (g.isMadLibs) {
    html += '<div style="text-align:center;margin-bottom:12px;">'
      + '<div style="font-size:2rem;">' + g.emoji + '</div>'
      + '<div style="font-size:.82rem;color:var(--text-2);margin-top:4px;">Fill each blank, then tap Reveal!</div>'
      + '</div>';
    html += '<div style="display:flex;flex-direction:column;gap:7px;margin-bottom:14px;">';
    _ML_BLANKS.forEach(function(b, i) {
      html += '<div style="display:flex;align-items:center;gap:8px;">'
        + '<span style="background:' + g.color + ';color:#fff;border-radius:50%;width:22px;height:22px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:900;">' + (i+1) + '</span>'
        + '<div style="flex:1;">'
        + '<div style="font-size:.7rem;color:var(--text-2);font-weight:700;text-transform:capitalize;margin-bottom:2px;">' + b.label + '</div>'
        + '<input id="ml-' + i + '" type="text" placeholder="' + b.placeholder + '" style="width:100%;padding:6px 10px;border:1.5px solid var(--border);border-radius:100px;font-size:16px;font-family:var(--font);color:var(--text);background:var(--card);outline:none;" />'
        + '</div></div>';
    });
    html += '</div>';
    html += '<button onclick="revealMadLib()" style="width:100%;background:' + g.color + ';color:#fff;border:none;border-radius:100px;padding:12px;font-size:.95rem;font-weight:900;cursor:pointer;font-family:var(--font);margin-bottom:10px;">âœ¨ Reveal the Story!</button>';
    html += '<div id="madlib-story" style="display:none;background:var(--card);border:2px solid ' + g.color + ';border-radius:12px;padding:16px;font-size:.9rem;line-height:1.8;color:var(--text);margin-bottom:14px;"></div>';
    /* Rules below the form */
    html += '<div style="font-weight:800;font-size:.8rem;color:' + g.color + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">How to Play</div>';
    (g.rules || []).forEach(function(r, ri) {
      html += '<div style="display:flex;gap:8px;font-size:.83rem;color:var(--text);line-height:1.5;margin-bottom:5px;">'
        + '<span style="background:' + g.color + ';color:#fff;border-radius:50%;width:20px;height:20px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:900;margin-top:1px;">' + (ri+1) + '</span>'
        + r + '</div>';
    });
    if (g.tip) html += '<div style="background:var(--orange-l);border:1.5px solid var(--orange);border-radius:12px;padding:10px 13px;margin-top:10px;margin-bottom:4px;"><div style="font-size:.7rem;font-weight:900;color:var(--orange);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">ğŸ’¡ Pro Tip</div><div style="font-size:.83rem;color:var(--text);line-height:1.5;">' + g.tip + '</div></div>';

  } else {
    /* â”€â”€ Standard game card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    html += '<div style="font-size:2.2rem;text-align:center;margin-bottom:8px;">' + g.emoji + '</div>';
    html += '<div style="font-weight:900;font-size:1.15rem;color:' + g.color + ';margin-bottom:4px;">' + g.title + '</div>';
    html += '<div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">'
      + '<span style="background:' + g.colorL + ';color:' + g.color + ';font-size:.72rem;font-weight:800;padding:3px 10px;border-radius:100px;">ğŸ‘¥ ' + g.players + '</span>'
      + '<span style="background:' + g.colorL + ';color:' + g.color + ';font-size:.72rem;font-weight:800;padding:3px 10px;border-radius:100px;">â± ' + g.time + '</span>'
      + '<span style="background:' + g.colorL + ';color:' + g.color + ';font-size:.72rem;font-weight:800;padding:3px 10px;border-radius:100px;">Age ' + g.ages + '</span>'
      + '</div>';
    html += '<div style="font-size:.87rem;color:var(--text);line-height:1.6;margin-bottom:14px;">' + g.desc + '</div>';

    /* â”€â”€ Interactive Play Tool â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var toolHtml = _buildGameTool(g);
    if (toolHtml) {
      html += '<div style="background:' + g.colorL + ';border:1.5px solid ' + g.color + '30;border-radius:12px;padding:14px;margin-bottom:14px;">'
        + '<div style="font-weight:900;font-size:.78rem;color:' + g.color + ';text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">ğŸ® Play Now</div>'
        + toolHtml
        + '</div>';
    }

    /* â”€â”€ Rules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    if (g.rules && !g.isAi) {
      html += '<div style="font-weight:800;font-size:.8rem;color:' + g.color + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">How to Play</div>';
      html += '<div style="display:flex;flex-direction:column;gap:5px;margin-bottom:14px;">';
      g.rules.forEach(function(r, ri) {
        html += '<div style="display:flex;align-items:flex-start;gap:8px;font-size:.83rem;color:var(--text);line-height:1.5;">'
          + '<span style="background:' + g.color + ';color:#fff;border-radius:50%;width:20px;height:20px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:900;margin-top:1px;">' + (ri+1) + '</span>'
          + r + '</div>';
      });
      html += '</div>';
    }

    if (g.examples) {
      html += '<div style="font-weight:800;font-size:.8rem;color:' + g.color + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">Example Prompts</div>';
      html += '<div style="display:flex;flex-direction:column;gap:4px;margin-bottom:14px;">';
      g.examples.forEach(function(ex) {
        html += '<div style="background:' + g.colorL + ';border-radius:12px;padding:7px 11px;font-size:.82rem;color:var(--text);font-style:italic;">"' + ex + '"</div>';
      });
      html += '</div>';
    }

    if (g.spots) {
      html += '<div style="font-weight:800;font-size:.8rem;color:' + g.color + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">Point Values</div>';
      html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-bottom:14px;">';
      g.spots.forEach(function(s) {
        html += '<div style="background:' + g.colorL + ';border-radius:12px;padding:6px 10px;display:flex;justify-content:space-between;align-items:center;">'
          + '<span style="font-size:.8rem;color:var(--text);">' + s.thing + '</span>'
          + '<span style="background:' + g.color + ';color:#fff;border-radius:100px;padding:1px 7px;font-size:.72rem;font-weight:800;">' + s.pts + ' pt' + (s.pts > 1 ? 's' : '') + '</span>'
          + '</div>';
      });
      html += '</div>';
    }

    if (g.tip) {
      html += '<div style="background:var(--orange-l);border:1.5px solid var(--orange);border-radius:12px;padding:10px 13px;margin-bottom:14px;">'
        + '<div style="font-size:.7rem;font-weight:900;color:var(--orange);text-transform:uppercase;letter-spacing:.05em;margin-bottom:3px;">ğŸ’¡ Pro Tip</div>'
        + '<div style="font-size:.83rem;color:var(--text);line-height:1.5;">' + g.tip + '</div>'
        + '</div>';
    }

    if (g.isAi) {
      html += '<button onclick="closeDayDetail();openTripGenie()" style="width:100%;background:linear-gradient(135deg,#7B2FBE,#4A90D9);color:#fff;border:none;border-radius:100px;padding:12px;font-size:.9rem;font-weight:800;cursor:pointer;font-family:var(--font);margin-bottom:8px;">âœ¨ Open TripGenie Now</button>';
    }
  }

  html += '<button onclick="closeDayDetail()" style="width:100%;background:var(--bg);border:1.5px solid var(--border);border-radius:100px;padding:10px;font-size:.88rem;font-weight:700;cursor:pointer;font-family:var(--font);color:var(--text-2);margin-top:4px;">â† Back to Games</button>';

  /* Reuse day-detail modal */
  var modal = document.getElementById('day-detail-modal');
  var body  = document.getElementById('ddm-blocks');
  if (!modal || !body) return;
  var titleEl = document.getElementById('ddm-title');
  if (titleEl) titleEl.textContent = g.title;
  var phaseEl = document.getElementById('ddm-phase');
  if (phaseEl) phaseEl.textContent = g.ages + ' Â· ' + g.players + ' players Â· ' + g.time;
  var metaEl = document.getElementById('ddm-meta');
  if (metaEl) metaEl.textContent = '';
  ['ddm-arrive-btn','ddm-leave-btn'].forEach(function(xid) {
    var el2 = document.getElementById(xid);
    if (el2) el2.style.display = 'none';
  });
  body.innerHTML = html;
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  modal.dataset.mode = 'game';
}

/* â”€â”€ Interactive game tool builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _buildGameTool(g) {
  if (!appState.games) appState.games = {};
  var c = g.color;

  if (g.id === 'license') {
    if (!appState.games.license) appState.games.license = { found: [] };
    var found = appState.games.license.found;
    var stateCount = found.filter(function(s){ return s !== 'CANADA' && s !== 'MEXICO'; }).length;
    var h = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:6px;">'
      + '<div style="font-size:.78rem;color:var(--text-2);flex:1;">Tap a state when you spot its plate!</div>'
      + '<button onclick="openPlateGallery()" style="background:var(--blue-l);border:1px solid var(--blue);color:var(--blue);border-radius:100px;padding:4px 10px;font-size:.7rem;font-weight:800;cursor:pointer;font-family:var(--font);white-space:nowrap;flex-shrink:0;">ğŸ–¼ See Plates</button>'
      + '<div style="font-weight:900;font-size:1rem;color:' + c + ';flex-shrink:0;" id="lp-count">' + stateCount + '/50</div>'
      + '</div>';
    h += '<div style="display:grid;grid-template-columns:repeat(5,1fr);gap:3px;">';
    US_STATES_LP.forEach(function(s) {
      var f = found.indexOf(s.abbr) >= 0;
      h += '<button id="lp-' + s.abbr + '" onclick="toggleLicenseState(\'' + s.abbr + '\')" title="' + s.name + '" style="background:' + (f ? c : '#E3F2FD') + ';color:' + (f ? '#fff' : c) + ';border:none;border-radius:100px;padding:5px 2px;font-size:.62rem;font-weight:800;cursor:pointer;font-family:var(--font);text-align:center;">' + s.abbr + '</button>';
    });
    h += '</div>';
    h += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-top:5px;">';
    ['CANADA','MEXICO'].forEach(function(x) {
      var f2 = found.indexOf(x) >= 0;
      var flag = x === 'CANADA' ? 'ğŸ‡¨ğŸ‡¦' : 'ğŸ‡²ğŸ‡½';
      h += '<button id="lp-' + x + '" onclick="toggleLicenseState(\'' + x + '\')" style="background:' + (f2 ? c : '#E3F2FD') + ';color:' + (f2 ? '#fff' : c) + ';border:none;border-radius:100px;padding:5px;font-size:.65rem;font-weight:800;cursor:pointer;font-family:var(--font);">' + flag + ' ' + x.charAt(0) + x.slice(1).toLowerCase() + '</button>';
    });
    h += '</div>';
    return h;

  } else if (g.id === 'alphabet') {
    if (!appState.games.alphabet) appState.games.alphabet = { found: [] };
    var af = appState.games.alphabet.found;
    var h2 = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">'
      + '<div style="font-size:.78rem;color:var(--text-2);">Tap a letter when you find it on a sign!</div>'
      + '<div style="font-weight:900;font-size:1rem;color:' + c + ';" id="alpha-count">' + af.length + '/26</div>'
      + '</div>';
    h2 += '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:3px;">';
    'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(function(l) {
      var lf = af.indexOf(l) >= 0;
      h2 += '<button id="alpha-' + l + '" onclick="toggleAlphabetLetter(\'' + l + '\')" style="background:' + (lf ? c : '#E8F5E9') + ';color:' + (lf ? '#fff' : c) + ';border:none;border-radius:100px;padding:6px 2px;font-size:.75rem;font-weight:900;cursor:pointer;font-family:var(--font);">' + l + '</button>';
    });
    h2 += '</div>';
    return h2;

  } else if (g.id === 'truckwave') {
    if (!appState.games.truckwave) appState.games.truckwave = { count: 0 };
    var twc = appState.games.truckwave.count || 0;
    return '<div style="text-align:center;">'
      + '<div style="font-size:.75rem;color:var(--text-2);margin-bottom:3px;">ğŸ‰ Honks Today</div>'
      + '<div style="font-size:3rem;font-weight:900;color:' + c + ';line-height:1;margin-bottom:10px;" id="truck-count">' + twc + '</div>'
      + '<div style="display:flex;gap:10px;justify-content:center;">'
      + '<button onclick="adjustTruckCount(-1)" style="background:#fff;border:2px solid ' + c + ';color:' + c + ';border-radius:100px;padding:8px 24px;font-size:1.3rem;font-weight:900;cursor:pointer;font-family:var(--font);">âˆ’</button>'
      + '<button onclick="adjustTruckCount(1)" style="background:' + c + ';border:none;color:#fff;border-radius:100px;padding:8px 28px;font-size:1.3rem;font-weight:900;cursor:pointer;font-family:var(--font);">+</button>'
      + '<button onclick="adjustTruckCount(-999)" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text-3);border-radius:100px;padding:8px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">â†©</button>'
      + '</div>'
      + '<div style="margin-top:8px;font-size:.72rem;color:var(--text-3);">Pump your arm out the window at truckers!</div>'
      + '</div>';

  } else if (g.id === 'spotit') {
    if (!appState.games.spotit) appState.games.spotit = { total: 0, spotted: [] };
    var spTotal = appState.games.spotit.total || 0;
    var spSpotted = appState.games.spotit.spotted || [];
    var h3 = '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">'
      + '<div style="font-size:.78rem;color:var(--text-2);">Tap when you spot it to score!</div>'
      + '<div style="font-weight:900;font-size:1rem;color:' + c + ';">Score: <span id="spot-total">' + spTotal + '</span> pts</div>'
      + '</div><div style="display:flex;flex-direction:column;gap:4px;">';
    g.spots.forEach(function(s, si) {
      var alreadySpotted = spSpotted.indexOf(si) >= 0;
      h3 += '<button id="spot-btn-' + si + '" onclick="spotItem(' + si + ',' + s.pts + ')" style="display:flex;justify-content:space-between;align-items:center;background:#fff;border:1.5px solid ' + c + '30;border-radius:100px;padding:7px 10px;cursor:pointer;font-family:var(--font);width:100%;text-align:left;transition:opacity .2s;'+(alreadySpotted?'opacity:.35;pointer-events:none;text-decoration:line-through;':'')+'">'
        + '<span style="font-size:.82rem;color:var(--text);">' + s.thing + '</span>'
        + '<span style="background:' + c + ';color:#fff;border-radius:100px;padding:2px 8px;font-size:.7rem;font-weight:800;flex-shrink:0;">+' + s.pts + 'pt' + (s.pts > 1 ? 's' : '') + '</span></button>';
    });
    h3 += '</div><button onclick="resetSpotter()" style="margin-top:8px;background:transparent;border:1px solid var(--border);color:var(--text-3);border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">â†© Reset</button>';
    return h3;

  } else if (g.id === 'wouldyou') {
    if (!appState.games.wouldyou) appState.games.wouldyou = { lastQ: '' };
    var wyrLast = appState.games.wouldyou.lastQ || '';
    return '<div id="wyr-box" style="background:var(--card);border-radius:12px;padding:12px;margin-bottom:10px;min-height:60px;font-size:.9rem;color:var(--text);line-height:1.6;text-align:center;border:1.5px solid ' + c + '25;">'
      + (wyrLast ? '<strong style="font-size:.92rem;">' + wyrLast + '</strong>' : '<em style="color:var(--text-3);">Tap for an AI-generated question!</em>')
      + '</div>'
      + '<button onclick="loadWYR()" style="width:100%;background:' + c + ';color:#fff;border:none;border-radius:100px;padding:10px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸŒ¶ï¸ New Question (AI)</button>';

  } else if (g.id === 'nomymom') {
    return '<div style="text-align:center;">'
      + '<div id="n5-cat" style="background:var(--card);border-radius:12px;padding:10px 12px;margin-bottom:10px;font-size:.9rem;font-weight:700;color:var(--text);min-height:44px;display:flex;align-items:center;justify-content:center;border:1.5px solid ' + c + '25;">'
      + '<em style="color:var(--text-3);">Pick a category below!</em></div>'
      + '<div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">'
      + '<button onclick="spinN5()" style="background:' + c + ';color:#fff;border:none;border-radius:100px;padding:8px 16px;font-size:.85rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ² Random Category</button>'
      + '</div>'
      + '<div style="display:flex;gap:10px;align-items:center;justify-content:center;">'
      + '<div style="font-size:2.8rem;font-weight:900;color:' + c + ';min-width:56px;text-align:center;" id="n5-timer">10</div>'
      + '<button onclick="startN5Timer()" style="background:' + c + ';color:#fff;border:none;border-radius:100px;padding:9px 18px;font-size:.85rem;font-weight:800;cursor:pointer;font-family:var(--font);">â–¶ Start</button>'
      + '</div>'
      + '</div>';

  } else if (g.id === '20q') {
    if (!appState.games.twentyq) appState.games.twentyq = { count: 0 };
    var q20c = appState.games.twentyq.count || 0;
    var q20color = q20c >= 17 ? '#D94F3D' : q20c >= 12 ? '#E8813A' : c;
    return '<div style="text-align:center;">'
      + '<div style="font-size:.75rem;color:var(--text-2);margin-bottom:3px;">Questions Asked</div>'
      + '<div style="font-size:3rem;font-weight:900;color:' + q20color + ';line-height:1;" id="q20-num">' + q20c + '</div>'
      + '<div style="font-size:.8rem;color:var(--text-3);margin-bottom:12px;">/ 20</div>'
      + '<div style="display:flex;gap:8px;justify-content:center;">'
      + '<button onclick="adj20Q(-1)" style="background:#fff;border:2px solid ' + c + ';color:' + c + ';border-radius:100px;padding:7px 20px;font-size:1.2rem;font-weight:900;cursor:pointer;font-family:var(--font);">âˆ’</button>'
      + '<button onclick="adj20Q(1)" style="background:' + c + ';border:none;color:#fff;border-radius:100px;padding:7px 24px;font-size:1.2rem;font-weight:900;cursor:pointer;font-family:var(--font);">+</button>'
      + '<button onclick="reset20Q()" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text-2);border-radius:100px;padding:7px 12px;font-size:.78rem;font-weight:700;cursor:pointer;font-family:var(--font);">â†© New</button>'
      + '</div></div>';

  } else if (g.id === 'carcolor') {
    if (!appState.games.carcolor) appState.games.carcolor = { counts: [0,0,0,0], timerSec: 300, timerRunning: false };
    var ccCounts = appState.games.carcolor.counts || [0,0,0,0];
    var ccTimeSec = appState.games.carcolor.timerSec !== undefined ? appState.games.carcolor.timerSec : 300;
    var ccMins = Math.floor(ccTimeSec / 60);
    var ccSecs = ccTimeSec % 60;
    var ccTimerDisplay = ccMins + ':' + (ccSecs < 10 ? '0' : '') + ccSecs;
    return '<div>'
      + '<div style="text-align:center;margin-bottom:10px;padding:10px;background:' + g.colorL + ';border-radius:12px;border:1.5px solid ' + c + '30;">'
      + '<div style="font-size:.72rem;font-weight:700;color:' + c + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px;">â± Round Timer</div>'
      + '<div style="font-size:2.2rem;font-weight:900;color:' + c + ';line-height:1;margin-bottom:8px;" id="cc-timer-display">' + ccTimerDisplay + '</div>'
      + '<div style="display:flex;gap:6px;justify-content:center;">'
      + '<button onclick="startCCTimer()" id="cc-timer-start" style="background:' + c + ';color:#fff;border:none;border-radius:100px;padding:7px 16px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);">â–¶ Start</button>'
      + '<button onclick="pauseCCTimer()" style="background:#fff;border:1.5px solid ' + c + ';color:' + c + ';border-radius:100px;padding:7px 12px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);">â¸ Pause</button>'
      + '<button onclick="resetCCTimer()" style="background:var(--bg);border:1.5px solid var(--border);color:var(--text-3);border-radius:100px;padding:7px 12px;font-size:.8rem;font-weight:700;cursor:pointer;font-family:var(--font);">â†©</button>'
      + '</div></div>'
      + '<div style="font-size:.78rem;color:var(--text-2);margin-bottom:8px;">Each person picks a color and counts:</div>'
      + '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">'
      + ['Paul','Melissa','Kids','Bonus'].map(function(p, pi) {
          return '<div style="background:var(--card);border-radius:12px;padding:8px 10px;border:1px solid var(--border);">'
            + '<div style="font-size:.72rem;font-weight:700;color:var(--text-2);margin-bottom:5px;">' + p + '</div>'
            + '<div style="display:flex;align-items:center;gap:6px;">'
            + '<button onclick="adjColor(' + pi + ',-1)" style="background:var(--bg);border:1px solid var(--border);border-radius:6px;width:26px;height:26px;font-size:1rem;cursor:pointer;font-family:var(--font);">âˆ’</button>'
            + '<span id="cc-' + pi + '" style="font-size:1.2rem;font-weight:900;color:' + c + ';min-width:24px;text-align:center;">' + (ccCounts[pi] || 0) + '</span>'
            + '<button onclick="adjColor(' + pi + ',1)" style="background:' + c + ';border:none;color:#fff;border-radius:6px;width:26px;height:26px;font-size:1rem;cursor:pointer;font-family:var(--font);">+</button>'
            + '</div></div>';
        }).join('')
      + '</div></div>';

  } else if (g.id === 'aiquest') {
    if (!appState.games.aiquest) appState.games.aiquest = { lastQuest: '', lastType: '' };
    var aqLast = appState.games.aiquest.lastQuest || '';
    var aqType = appState.games.aiquest.lastType || '';
    var aqLabel = aqType === 'trivia' ? 'ğŸ§  Trivia Quiz' : aqType === 'scavenger' ? 'ğŸ—ºï¸ Scavenger Hunt' : '';
    return '<div style="margin-bottom:10px;">'
      + '<div style="font-size:.75rem;color:var(--text-2);margin-bottom:6px;text-align:center;">Choose your quest type â€” AI generates it instantly!</div>'
      + '<div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">'
      + '<button onclick="loadAIQuest(\'trivia\')" style="flex:1;background:' + c + ';color:#fff;border:none;border-radius:100px;padding:9px 6px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ§  Trivia Quiz</button>'
      + '<button onclick="loadAIQuest(\'scavenger\')" style="flex:1;background:#2C5F8A;color:#fff;border:none;border-radius:100px;padding:9px 6px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);">ğŸ—ºï¸ Scavenger Hunt</button>'
      + '</div>'
      + '<div id="aiquest-box" style="background:var(--card);border-radius:12px;padding:12px;min-height:80px;font-size:.82rem;color:var(--text);line-height:1.6;border:1.5px solid ' + c + '25;white-space:pre-wrap;">'
      + (aqLast
          ? '<div style="font-size:.7rem;font-weight:700;color:' + c + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">' + aqLabel + '</div>' + aqLast
          : '<em style="color:var(--text-3);">Tap a button above to generate your quest!</em>')
      + '</div>'
      + (aqLast ? '<button onclick="clearAIQuest()" style="margin-top:6px;background:transparent;border:1px solid var(--border);color:var(--text-3);border-radius:100px;padding:4px 12px;font-size:.72rem;font-weight:700;cursor:pointer;font-family:var(--font);width:100%;">â†© Clear</button>' : '')
      + '</div>';
  }

  return '';  /* No interactive tool for this game */
}

/* â”€â”€ Game helper functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleLicenseState(abbr) {
  if (!appState.games) appState.games = {};
  if (!appState.games.license) appState.games.license = { found: [] };
  var found = appState.games.license.found;
  var idx = found.indexOf(abbr);
  if (idx >= 0) found.splice(idx, 1); else found.push(abbr);
  saveState(appState);
  var btn = document.getElementById('lp-' + abbr);
  var g = GAMES.find(function(x){ return x.id === 'license'; });
  var c = g ? g.color : '#1565C0';
  if (btn) { var f = found.indexOf(abbr) >= 0; btn.style.background = f ? c : '#E3F2FD'; btn.style.color = f ? '#fff' : c; }
  var countEl = document.getElementById('lp-count');
  if (countEl) countEl.textContent = found.filter(function(s){ return s !== 'CANADA' && s !== 'MEXICO'; }).length + '/50';
}

function toggleAlphabetLetter(letter) {
  if (!appState.games) appState.games = {};
  if (!appState.games.alphabet) appState.games.alphabet = { found: [] };
  var found = appState.games.alphabet.found;
  var idx = found.indexOf(letter);
  if (idx >= 0) found.splice(idx, 1); else found.push(letter);
  saveState(appState);
  var btn = document.getElementById('alpha-' + letter);
  var g = GAMES.find(function(x){ return x.id === 'alphabet'; });
  var c = g ? g.color : '#2E7D32';
  if (btn) { var f = found.indexOf(letter) >= 0; btn.style.background = f ? c : '#E8F5E9'; btn.style.color = f ? '#fff' : c; }
  var countEl = document.getElementById('alpha-count');
  if (countEl) countEl.textContent = found.length + '/26';
}

function adjustTruckCount(delta) {
  if (!appState.games) appState.games = {};
  if (!appState.games.truckwave) appState.games.truckwave = { count: 0 };
  var el = document.getElementById('truck-count');
  var cur = el ? parseInt(el.textContent) : (appState.games.truckwave.count || 0);
  var n = delta <= -999 ? 0 : Math.max(0, cur + delta);
  appState.games.truckwave.count = n;
  saveState(appState);
  if (el) el.textContent = n;
}

function spotItem(idx, pts) {
  if (!appState.games) appState.games = {};
  if (!appState.games.spotit) appState.games.spotit = { total: 0, spotted: [] };
  if (appState.games.spotit.spotted.indexOf(idx) >= 0) return; // already spotted
  appState.games.spotit.spotted.push(idx);
  appState.games.spotit.total = (appState.games.spotit.total || 0) + pts;
  saveState(appState);
  var btn = document.getElementById('spot-btn-' + idx);
  if (btn) { btn.style.opacity = '.35'; btn.style.pointerEvents = 'none'; btn.style.textDecoration = 'line-through'; }
  var el = document.getElementById('spot-total');
  if (el) el.textContent = appState.games.spotit.total;
}

function resetSpotter() {
  if (!appState.games) appState.games = {};
  appState.games.spotit = { total: 0, spotted: [] };
  saveState(appState);
  var el = document.getElementById('spot-total');
  if (el) el.textContent = '0';
  var i = 0;
  while (document.getElementById('spot-btn-' + i)) {
    var b = document.getElementById('spot-btn-' + i);
    b.style.opacity = '1'; b.style.pointerEvents = ''; b.style.textDecoration = '';
    i++;
  }
}

function loadWYR() {
  var box = document.getElementById('wyr-box');
  if (!box) return;
  box.innerHTML = '<em style="color:var(--text-3);">ğŸ¤” Asking AI...</em>';
  var prompt = 'Give a single funny, family-friendly "Would You Rather?" question for a road trip with kids ages 2, 4, and 9. Road-trip or nature theme. Output ONLY the question in format: "Would you rather [A] or [B]?"';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:100,temperature:1.0} });
  fetch(GEMINI_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:body})
    .then(function(r){return r.json();})
    .then(function(data){
      var t = ''; try{t=data.candidates[0].content.parts[0].text.trim();}catch(e){}
      if (t) {
        if (!appState.games) appState.games = {};
        if (!appState.games.wouldyou) appState.games.wouldyou = {};
        appState.games.wouldyou.lastQ = t;
        saveState(appState);
      }
      if (box) box.innerHTML = t ? '<strong style="font-size:.92rem;">' + t + '</strong>' : '<em style="color:var(--red);">Could not load question. Check connection.</em>';
    })
    .catch(function(){ if(box) box.innerHTML='<em style="color:var(--red);">Error. Check connection.</em>'; });
}

function loadAIQuest(type) {
  var box = document.getElementById('aiquest-box');
  if (!box) return;
  box.innerHTML = '<em style="color:var(--text-3);">ğŸ¤– Generating your quest...</em>';
  var dayNum  = tripDay();
  var dayData = getDay(dayNum);
  var stop    = dayData ? getStop(dayData.stopId) : null;
  var place   = stop ? stop.name : 'our road trip location';
  var region  = stop && stop.state ? stop.state : 'the area';
  var prompt = type === 'trivia'
    ? 'Create a fun 8-question trivia quiz about ' + place + ' (' + region + ') for a family road trip with kids ages 2, 4, and 9. Mix easy and medium difficulty. Format each question as:\nQ1. [Question]\nA: [Answer]\n\nKeep answers short. Make it educational and exciting!'
    : 'Create a 10-item roadside scavenger hunt list for a family driving near ' + place + ' (' + region + '). Each item should be something realistic to spot from the car or at a rest stop. Format as:\n1. [Item to find]\n2. [Item to find]\n...and so on. Include a mix of nature, signs, vehicles, and local culture. Make it fun for kids ages 2-9!';
  var body = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:500,temperature:0.9} });
  fetch(GEMINI_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:body})
    .then(function(r){return r.json();})
    .then(function(data){
      var t = ''; try{t=data.candidates[0].content.parts[0].text.trim();}catch(e){}
      if (t) {
        if (!appState.games) appState.games = {};
        if (!appState.games.aiquest) appState.games.aiquest = {};
        appState.games.aiquest.lastQuest = t;
        appState.games.aiquest.lastType  = type;
        saveState(appState);
      }
      if (box) {
        var label = type === 'trivia' ? 'ğŸ§  Trivia Quiz' : 'ğŸ—ºï¸ Scavenger Hunt';
        var g = GAMES.find(function(x){return x.id==='aiquest';});
        var col = g ? g.color : '#7B2FBE';
        box.innerHTML = t
          ? '<div style="font-size:.7rem;font-weight:700;color:' + col + ';text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px;">' + label + '</div>' + t
          : '<em style="color:var(--red);">Could not generate quest. Check connection.</em>';
        var parent = box.parentNode;
        var existing = parent ? parent.querySelector('.aiquest-clear-btn') : null;
        if (!existing && t && parent) {
          var cb = document.createElement('button');
          cb.className = 'aiquest-clear-btn';
          cb.style.cssText = 'margin-top:6px;background:transparent;border:1px solid var(--border);color:var(--text-3);border-radius:100px;padding:4px 12px;font-size:.72rem;font-weight:700;cursor:pointer;font-family:var(--font);width:100%;';
          cb.textContent = 'â†© Clear';
          cb.onclick = clearAIQuest;
          parent.appendChild(cb);
        }
      }
    })
    .catch(function(){ if(box) box.innerHTML='<em style="color:var(--red);">Error. Check connection.</em>'; });
}

function clearAIQuest() {
  if (!appState.games) appState.games = {};
  appState.games.aiquest = { lastQuest: '', lastType: '' };
  saveState(appState);
  var box = document.getElementById('aiquest-box');
  if (box) box.innerHTML = '<em style="color:var(--text-3);">Tap a button above to generate your quest!</em>';
  var cb = box && box.parentNode ? box.parentNode.querySelector('.aiquest-clear-btn') : null;
  if (cb) cb.remove();
}

function spinN5() {
  var cat = _name5Categories[Math.floor(Math.random() * _name5Categories.length)];
  var el = document.getElementById('n5-cat');
  if (el) el.innerHTML = '<strong>' + cat + '</strong>';
  var timerEl = document.getElementById('n5-timer');
  if (timerEl) { timerEl.textContent = '10'; timerEl.style.color = '#F57F17'; }
  if (_name5TimerInterval) { clearInterval(_name5TimerInterval); _name5TimerInterval = null; }
}

function startN5Timer() {
  if (_name5TimerInterval) { clearInterval(_name5TimerInterval); _name5TimerInterval = null; }
  var timerEl = document.getElementById('n5-timer');
  if (!timerEl) return;
  var count = 10; timerEl.textContent = count; timerEl.style.color = '#F57F17';
  _name5TimerInterval = setInterval(function() {
    count--;
    if (timerEl) { timerEl.textContent = count; if (count <= 3) timerEl.style.color = '#D94F3D'; }
    if (count <= 0) {
      clearInterval(_name5TimerInterval); _name5TimerInterval = null;
      if (timerEl) { timerEl.textContent = 'â°'; timerEl.style.color = '#D94F3D'; }
    }
  }, 1000);
}

function adj20Q(delta) {
  if (!appState.games) appState.games = {};
  if (!appState.games.twentyq) appState.games.twentyq = { count: 0 };
  var el = document.getElementById('q20-num');
  var cur = el ? parseInt(el.textContent) : (appState.games.twentyq.count || 0);
  var c2 = Math.max(0, Math.min(20, cur + delta));
  appState.games.twentyq.count = c2;
  saveState(appState);
  if (el) { el.textContent = c2; el.style.color = c2 >= 17 ? '#D94F3D' : c2 >= 12 ? '#E8813A' : '#6A1B9A'; }
}

function reset20Q() {
  if (!appState.games) appState.games = {};
  appState.games.twentyq = { count: 0 };
  saveState(appState);
  var el = document.getElementById('q20-num');
  if (el) { el.textContent = '0'; el.style.color = '#6A1B9A'; }
}

function adjColor(idx, delta) {
  if (!appState.games) appState.games = {};
  if (!appState.games.carcolor) appState.games.carcolor = { counts: [0,0,0,0], timerSec: 300 };
  if (!appState.games.carcolor.counts) appState.games.carcolor.counts = [0,0,0,0];
  var el = document.getElementById('cc-' + idx);
  var cur = el ? parseInt(el.textContent) : (appState.games.carcolor.counts[idx] || 0);
  var n = Math.max(0, cur + delta);
  appState.games.carcolor.counts[idx] = n;
  saveState(appState);
  if (el) el.textContent = n;
}

/* Car Color Count timer */
var _ccTimerInterval = null;
function startCCTimer() {
  if (_ccTimerInterval) return; // already running
  if (!appState.games) appState.games = {};
  if (!appState.games.carcolor) appState.games.carcolor = { counts:[0,0,0,0], timerSec:300 };
  if (appState.games.carcolor.timerSec <= 0) appState.games.carcolor.timerSec = 300;
  _ccTimerInterval = setInterval(function() {
    if (!appState.games.carcolor) return;
    appState.games.carcolor.timerSec = Math.max(0, (appState.games.carcolor.timerSec || 0) - 1);
    saveState(appState);
    var s = appState.games.carcolor.timerSec;
    var el = document.getElementById('cc-timer-display');
    if (el) {
      var m = Math.floor(s/60), sec = s%60;
      el.textContent = m + ':' + (sec<10?'0':'') + sec;
      el.style.color = s <= 30 ? '#D94F3D' : s <= 60 ? '#E8813A' : '#1565C0';
    }
    if (s <= 0) {
      clearInterval(_ccTimerInterval); _ccTimerInterval = null;
      showToast('â° Time\'s up! Reveal your counts!', 3000);
    }
  }, 1000);
}
function pauseCCTimer() {
  if (_ccTimerInterval) { clearInterval(_ccTimerInterval); _ccTimerInterval = null; }
}
function resetCCTimer() {
  pauseCCTimer();
  if (!appState.games) appState.games = {};
  if (!appState.games.carcolor) appState.games.carcolor = { counts:[0,0,0,0], timerSec:300 };
  appState.games.carcolor.timerSec = 300;
  appState.games.carcolor.counts = [0,0,0,0];
  saveState(appState);
  var el = document.getElementById('cc-timer-display');
  if (el) { el.textContent = '5:00'; el.style.color = '#1565C0'; }
  for (var ci=0;ci<4;ci++){var ce=document.getElementById('cc-'+ci); if(ce)ce.textContent='0';}
}

function revealMadLib() {
  var words = _ML_BLANKS.map(function(b, i) {
    var inp = document.getElementById('ml-' + i);
    return (inp && inp.value.trim()) ? inp.value.trim() : b.placeholder;
  });
  var story = 'One <strong>' + words[0] + '</strong> day, the <strong>' + words[1] + '</strong> family piled into their <strong>' + words[2] + '</strong> RV named "<strong>' + words[3] + '</strong>". <strong>' + words[14] + '</strong> <strong>' + words[4] + '</strong> the whole time while everyone else <strong>' + words[5] + '</strong>. Suddenly, they spotted a <strong>' + words[6] + '</strong> <strong>' + words[7] + '</strong> by the side of the highway! Everyone <strong>' + words[8] + '</strong>. They pulled off at a <strong>' + words[9] + '</strong> diner in <strong>' + words[10] + '</strong> and ordered <strong>' + words[11] + '</strong> smothered in <strong>' + words[12] + '</strong>. It was the most <strong>' + words[13] + '</strong> meal of the entire road trip. That night at the campground, <strong>' + words[14] + '</strong> <strong>' + words[15] + '</strong> so loudly that a wild <strong>' + words[16] + '</strong> ran away into the desert. Best. Road Trip. <strong>' + words[17] + '</strong>! ğŸ‰';
  var storyEl = document.getElementById('madlib-story');
  if (storyEl) {
    storyEl.innerHTML = story;
    storyEl.style.display = 'block';
    storyEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

/* â”€â”€ GAMES TAB end â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

/* â”€â”€ TRIPGENIE AI ASSISTANT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _tgHistory    = [];   // { role:'user'|'genie', text, imgBase64? }
var _tgPhotoB64   = null; // base64 of attached photo (no data: prefix)
var _tgPhotoMime  = 'image/jpeg';
var _tgBusy       = false;

function openTripGenie(prefill) {
  var drawer = document.getElementById('tg-drawer');
  drawer.classList.add('open');
  document.body.style.overflow = 'hidden';
  if (_tgHistory.length === 0) _tgRenderWelcome();
  setTimeout(function() {
    var inp = document.getElementById('tg-input');
    if (inp) {
      if (prefill) inp.value = prefill;
      inp.focus();
    }
  }, 350);
}

function closeTripGenie() {
  document.getElementById('tg-drawer').classList.remove('open');
  document.body.style.overflow = '';
}

function _tgRenderWelcome() {
  var dayNum  = tripDay();
  var dayData = getDay(dayNum);
  var stop    = dayData ? getStop(dayData.stopId) : null;
  var where   = stop ? stop.name : 'the open road';
  _tgAppendBubble('genie',
    '<strong>Hey Maass family! ğŸ‘‹</strong><br>'
    + 'I\'m TripGenie â€” your AI co-pilot for this adventure. Ask me anything:<br><br>'
    + 'â€¢ RV how-tos & troubleshooting<br>'
    + 'â€¢ What to see near <em>' + where + '</em><br>'
    + 'â€¢ Campfire recipes, kid activities, driving tips<br>'
    + 'â€¢ Take a photo and I\'ll help identify what you\'re seeing<br><br>'
    + 'What\'s on your mind?'
  );
}

function _tgAppendBubble(role, html) {
  var hist = document.getElementById('tg-history');
  if (!hist) return;
  var div = document.createElement('div');
  div.className = role === 'user' ? 'tg-bubble-user' : 'tg-bubble-genie';
  div.innerHTML = html;
  hist.appendChild(div);
  hist.scrollTop = hist.scrollHeight;
}

function _tgFormatResponse(text) {
  /* Convert Gemini markdown-lite to HTML */
  return text
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/^#+\s+(.+)$/gm, '<strong>$1</strong>')
    .replace(/\n\n/g, '<br><br>')
    .replace(/\n/g, '<br>')
    .replace(/^[-â€¢]\s+(.+)$/gm, 'â€¢ $1');
}

function tgSuggest(btn) {
  var inp = document.getElementById('tg-input');
  if (inp) inp.value = btn.textContent;
  document.getElementById('tg-suggestions').style.display = 'none';
  if (inp) inp.focus();
}

function handleTripGeniePhoto(e) {
  var file = e.target.files && e.target.files[0];
  if (!file) return;
  _tgPhotoMime = file.type || 'image/jpeg';
  var reader = new FileReader();
  reader.onload = function(ev) {
    var dataUrl = ev.target.result;
    _tgPhotoB64 = dataUrl.split(',')[1]; // strip "data:image/jpeg;base64,"
    var strip = document.getElementById('tg-photo-strip');
    var thumb = document.getElementById('tg-photo-thumb');
    if (thumb) thumb.src = dataUrl;
    if (strip) strip.style.display = 'flex';
  };
  reader.readAsDataURL(file);
  /* reset input so same file can be reselected */
  e.target.value = '';
}

function removeTripGeniePhoto() {
  _tgPhotoB64 = null;
  var strip = document.getElementById('tg-photo-strip');
  if (strip) strip.style.display = 'none';
  var thumb = document.getElementById('tg-photo-thumb');
  if (thumb) thumb.src = '';
}

function askTripGenie() {
  if (_tgBusy) return;
  var inp  = document.getElementById('tg-input');
  var text = inp ? inp.value.trim() : '';
  if (!text && !_tgPhotoB64) { if (inp) inp.focus(); return; }

  _tgBusy = true;

  /* Hide suggestions after first real message */
  document.getElementById('tg-suggestions').style.display = 'none';

  /* Build user bubble */
  var userHtml = '';
  if (_tgPhotoB64) {
    userHtml += '<img class="tg-photo-prev" src="data:' + _tgPhotoMime + ';base64,' + _tgPhotoB64 + '" alt="Photo" />';
  }
  userHtml += (text ? _tgFormatResponse(text) : '<em>ğŸ“· Photo attached</em>');
  _tgAppendBubble('user', userHtml);

  /* Snapshot photo before clearing */
  var photoB64  = _tgPhotoB64;
  var photoMime = _tgPhotoMime;

  /* Clear input */
  if (inp) { inp.value = ''; inp.style.height = 'auto'; }
  removeTripGeniePhoto();

  /* Show thinking indicator */
  var thinkId = 'tg-think-' + Date.now();
  _tgAppendBubble('genie', '<span class="tg-thinking" id="' + thinkId + '">âœ¨ TripGenie is thinkingâ€¦</span>');

  /* Build Gemini request */
  var dayNum   = tripDay();
  var dayData  = getDay(dayNum);
  var stop     = dayData ? getStop(dayData.stopId) : null;
  var _tgTripName = (appState && appState.tripSettings && appState.tripSettings.tripName) || CONFIG.tripName || 'RV trip';
  var context  = 'You are TripGenie, a friendly and knowledgeable AI assistant for this family\'s RV trip. '
    + 'They are on a ' + _tgTripName + ' from ' + _tripStartCity()
    + (_tripIsRoundTrip() ? ' (round trip)' : ' to ' + _tripEndCity())
    + ', dates ' + CONFIG.startDate + ' to ' + CONFIG.endDate + '. '
    + (stop ? 'They are currently at/near: ' + stop.name + ' (' + (stop.description || '') + '). ' : '')
    + 'Give practical, friendly, helpful answers. '
    + 'For RV maintenance questions, be specific and safety-conscious. '
    + 'For local attraction questions, focus on family-friendly options. '
    + 'Keep responses concise but thorough. Use bullet points for steps.'
    + _getPersonalizationContext();

  var parts = [{ text: context + '\n\nUser question: ' + (text || '(See attached photo â€” describe what you see and provide helpful context for an RV family trip)') }];
  if (photoB64) {
    parts.push({ inline_data: { mime_type: photoMime, data: photoB64 } });
  }

  var body = JSON.stringify({
    contents: [{ parts: parts }],
    generationConfig: { maxOutputTokens: 600, temperature: 0.75 }
  });

  fetch(GEMINI_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: body
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var thinking = document.getElementById(thinkId);
    if (thinking) thinking.parentElement.remove();
    var raw = (data.candidates && data.candidates[0] && data.candidates[0].content
              && data.candidates[0].content.parts && data.candidates[0].content.parts[0]
              && data.candidates[0].content.parts[0].text) || 'Sorry, I couldn\'t get a response. Try again!';
    _tgAppendBubble('genie', _tgFormatResponse(raw));
    _tgBusy = false;
  })
  .catch(function() {
    var thinking = document.getElementById(thinkId);
    if (thinking) thinking.parentElement.remove();
    _tgAppendBubble('genie', 'âš ï¸ Couldn\'t reach TripGenie right now. Check your connection and try again!');
    _tgBusy = false;
  });
}

/* â”€â”€ JOURNAL GPS LOCATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function detectJournalLocation() {
  if (!navigator.geolocation) {
    showToast('Geolocation not supported in this browser', 2500);
    return;
  }
  showToast('Detecting location\u2026', 2000);
  navigator.geolocation.getCurrentPosition(
    function(pos) {
      var lat = pos.coords.latitude.toFixed(5);
      var lng = pos.coords.longitude.toFixed(5);
      fetch('https://nominatim.openstreetmap.org/reverse?lat=' + lat + '&lon=' + lng + '&format=json')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var addr = data.address || {};
          var city  = addr.city || addr.town || addr.village || addr.county || '';
          var state = addr.state || '';
          var label = '&#128205; ' + (city ? city + (state ? ', ' + state : '') : '(' + lat + ', ' + lng + ')');
          setJournalLocationCustom(label);
        })
        .catch(function() {
          setJournalLocationCustom('&#128205; (' + lat + ', ' + lng + ')');
        });
    },
    function(err) {
      showToast('Could not get location: ' + (err.message || 'permission denied'), 2800);
    },
    { timeout: 8000, maximumAge: 60000 }
  );
}

function setJournalLocationCustom(label) {
  var locSel = document.getElementById('j-location-select');
  if (!locSel) return;
  var existing = document.getElementById('j-loc-gps-opt');
  if (existing) {
    existing.innerHTML = label;
    existing.value = 'gps:' + label;
    locSel.value = existing.value;
  } else {
    var opt = document.createElement('option');
    opt.id        = 'j-loc-gps-opt';
    opt.value     = 'gps:' + label;
    opt.innerHTML = label;
    locSel.insertBefore(opt, locSel.firstChild);
    locSel.value = opt.value;
  }
  showToast('Location updated', 1800);
}


/* â”€â”€ ARRIVE / LEAVE / GEMINI SCHEDULE ADJUST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _longPressTimer = null;

function startLongPress(type) {
  cancelLongPress();
  _longPressTimer = setTimeout(function() {
    _longPressTimer = null;
    openTimeEdit(type);
  }, 650);
}
function cancelLongPress() {
  if (_longPressTimer) { clearTimeout(_longPressTimer); _longPressTimer = null; }
}
function openTimeEdit(type) {
  if (!_ddmDayNum) return;
  var d = TRIP_DAYS[_ddmDayNum - 1]; if (!d) return;
  var ex = type === 'arrive'
    ? (appState.arrivals && appState.arrivals[d.stopId] ? new Date(appState.arrivals[d.stopId].time) : null)
    : (appState.departures && appState.departures[d.stopId] ? new Date(appState.departures[d.stopId].time) : null);
  document.getElementById('teo-label').innerHTML = type === 'arrive' ? '&#129001; Edit Arrival Time' : '&#128666; Edit Departure Time';
  var now = ex || new Date();
  document.getElementById('teo-time').value = String(now.getHours()).padStart(2,'0') + ':' + String(now.getMinutes()).padStart(2,'0');
  document.getElementById('teo-time').dataset.editType = type;
  document.getElementById('time-edit-overlay').classList.remove('hidden');
}
function confirmTimeEdit() {
  var type = document.getElementById('teo-time').dataset.editType;
  var val  = document.getElementById('teo-time').value;
  if (!val || !_ddmDayNum) return;
  var d = TRIP_DAYS[_ddmDayNum - 1]; if (!d) return;
  var stop = getStop(d.stopId);
  var pts = val.split(':');
  var edited = new Date(d.date + 'T12:00:00');
  edited.setHours(parseInt(pts[0]), parseInt(pts[1]), 0, 0);
  document.getElementById('time-edit-overlay').classList.add('hidden');
  var ts = edited.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  if (type === 'arrive') {
    if (!appState.arrivals) appState.arrivals = {};
    appState.arrivals[d.stopId] = { dayNum: _ddmDayNum, time: edited.toISOString() };
    saveState(appState);
    var ab = document.getElementById('ddm-arrive-btn');
    if (ab) { ab.innerHTML = '\u2713 Arrived ' + ts; ab.style.background = 'rgba(58,138,92,.35)'; }
    showToast('Arrival time updated \u2014 rechecking\u2026', 2200);
    geminiAdjustSchedule(_ddmDayNum, 'arrive', stop, (new Date(d.date+'T12:00:00') - edited) / 3600000);
  } else {
    if (!appState.departures) appState.departures = {};
    appState.departures[d.stopId] = { dayNum: _ddmDayNum, time: edited.toISOString() };
    saveState(appState);
    var db2 = document.getElementById('ddm-leave-btn');
    if (db2) { db2.innerHTML = '\u2713 Left ' + ts; db2.style.background = 'rgba(200,104,32,.35)'; }
    showToast('Departure time updated \u2014 adjusting\u2026', 2200);
    geminiAdjustSchedule(_ddmDayNum, 'depart', stop, (new Date(d.date+'T19:00:00') - edited) / 3600000);
  }
}

function recordArrival() {
  if (_longPressTimer) return;
  if (!_ddmDayNum) return;
  var d = TRIP_DAYS[_ddmDayNum - 1]; if (!d) return;
  var stop = getStop(d.stopId);
  var btn  = document.getElementById('ddm-arrive-btn');
  if (!appState.arrivals) appState.arrivals = {};
  if (appState.arrivals[d.stopId]) {
    delete appState.arrivals[d.stopId]; saveState(appState);
    if (btn) { btn.innerHTML = '&#129001; We Arrived!'; btn.style.background = 'rgba(255,255,255,.18)'; }
    showToast('Arrival cleared', 1800); return;
  }
  var now = new Date();
  appState.arrivals[d.stopId] = { dayNum: _ddmDayNum, time: now.toISOString() };
  saveState(appState);
  if (btn) { btn.innerHTML = '\u2713 Arrived ' + now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); btn.style.background = 'rgba(58,138,92,.35)'; }
  showToast('Arrival recorded \u2014 checking pace\u2026', 2400);
  geminiAdjustSchedule(_ddmDayNum, 'arrive', stop, (new Date(d.date+'T12:00:00') - now) / 3600000);
}

function recordDeparture() {
  if (_longPressTimer) return;
  if (!_ddmDayNum) return;
  var d = TRIP_DAYS[_ddmDayNum - 1]; if (!d) return;
  var stop = getStop(d.stopId);
  var btn  = document.getElementById('ddm-leave-btn');
  if (!appState.departures) appState.departures = {};
  if (appState.departures[d.stopId]) {
    delete appState.departures[d.stopId];
    if (appState.aiSuggestions) {
      appState.aiSuggestions = appState.aiSuggestions.filter(function(s) {
        return !(s.sourceDay === _ddmDayNum && s.status !== 'accepted');
      });
    }
    if (appState.dayNotes) delete appState.dayNotes[_ddmDayNum];
    saveState(appState);
    if (btn) { btn.innerHTML = '&#128666; We Left'; btn.style.background = 'rgba(255,255,255,.18)'; }
    renderSchedule(); renderAdjustments(); updateAdjBadge();
    showToast('Departure cleared \u2014 suggestions reverted', 2200); return;
  }
  var now = new Date();
  appState.departures[d.stopId] = { dayNum: _ddmDayNum, time: now.toISOString() };
  saveState(appState);
  if (btn) { btn.innerHTML = '\u2713 Left ' + now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); btn.style.background = 'rgba(200,104,32,.35)'; }
  showToast('Departure recorded \u2014 adjusting schedule\u2026', 2400);
  geminiAdjustSchedule(_ddmDayNum, 'depart', stop, (new Date(d.date+'T19:00:00') - now) / 3600000);
}

function geminiAdjustSchedule(dayNum, type, stop, hoursAdj) {
  var remaining = [];
  for (var ri = dayNum; ri < TRIP_DAYS.length && remaining.length < 12; ri++) {
    var rd = TRIP_DAYS[ri]; var rs = getStop(rd.stopId);
    remaining.push('Day ' + rd.day + ' (' + rd.date + '): ' + rd.title + (rs ? ' [' + rs.name + ', ' + rs.state + ']' : ''));
  }
  if (TRIP_DAYS.length > dayNum + 12) remaining.push('... and ' + (TRIP_DAYS.length - dayNum - 12) + ' more days');
  var direction = hoursAdj > 2  ? 'AHEAD of schedule by ~' + Math.round(hoursAdj) + ' hours'
                : hoursAdj < -2 ? 'BEHIND schedule by ~' + Math.round(-hoursAdj) + ' hours'
                : 'roughly ON schedule';
  var prompt = 'We are on a 46-day family RV road trip (kids 9, 4, 2). Today: ' + new Date().toLocaleDateString() + '.\n'
    + 'We just ' + (type === 'arrive' ? 'ARRIVED at' : 'DEPARTED from') + ' '
    + (stop ? _sn(stop) : 'a stop') + ' and are ' + direction + '.\n\n'
    + 'Remaining schedule:\n' + remaining.join('\n') + '\n\n'
    + 'Return a JSON array of 3-4 practical trip adjustment suggestions:\n'
    + '[{"id":"s1","title":"Short action","detail":"1-2 sentence explanation","impact":"e.g. Saves 1 day","affectedDays":[14,15]}]\n'
    + (hoursAdj > 2 ? 'Extra time \u2014 suggest additions.' : 'Behind schedule \u2014 suggest cuts.')
    + '\nRespond ONLY with the JSON array.';
  var body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 500, temperature: 0.7 }
  });
  fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var text = '';
      try { text = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}
      if (!text) return;
      var parsed = null;
      try { parsed = JSON.parse(text); } catch(e2) {}
      if (!parsed) {
        var m = text.match(/\[[\s\S]*\]/);
        if (m) { try { parsed = JSON.parse(m[0]); } catch(e3) {} }
      }
      if (Array.isArray(parsed)) { storeSuggestions(dayNum, type, parsed); return; }
      // Fallback plain text
      if (!appState.dayNotes) appState.dayNotes = {};
      appState.dayNotes[dayNum] = text.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
      saveState(appState); renderSchedule();
      showToast('\u{1F916} TripGenie has suggestions!', 2500);
    })
    .catch(function() {});
}

function storeSuggestions(sourceDay, type, arr) {
  if (!appState.aiSuggestions) appState.aiSuggestions = [];
  appState.aiSuggestions = appState.aiSuggestions.filter(function(s) {
    return !(s.sourceDay === sourceDay && s.status === 'pending');
  });
  var ts = new Date().toISOString();
  for (var ai5 = 0; ai5 < arr.length; ai5++) {
    var s = arr[ai5];
    appState.aiSuggestions.push({
      id: s.id || ('sg' + Date.now() + ai5),
      title: s.title || 'Suggestion', detail: s.detail || '',
      impact: s.impact || '', affectedDays: s.affectedDays || [sourceDay],
      sourceDay: sourceDay, triggerType: type, status: 'pending', created: ts
    });
  }
  saveState(appState); renderSchedule(); renderAdjustments(); updateAdjBadge();
  showToast('\u{1F916} TripGenie has ' + arr.length + ' suggestion' + (arr.length !== 1 ? 's' : '') + '!', 2800);
}

function openRecommendationInfo(info) {
  var modal = document.getElementById('aim-modal');
  if (!modal) return;
  var titleEl = document.getElementById('aim-title');
  var subEl   = document.getElementById('aim-sub');
  var bodyEl  = document.getElementById('aim-body');
  if (titleEl) titleEl.textContent = info.title || 'Recommendation';
  if (subEl)   subEl.textContent   = info.impact ? 'ğŸ’¡ ' + info.impact : 'TripGenie Recommendation';
  if (bodyEl)  bodyEl.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-2);">â³ Asking TripGenieâ€¦</div>';
  modal.classList.remove('hidden');
  var stops = TRIP_STOPS.map(function(s){ return s.name; }).join(', ');
  var diet = (typeof getDietContext === 'function') ? getDietContext() : '';
  var prompt = 'I am on a family RV trip visiting: ' + stops + '. ' + diet + 'I have a trip recommendation: "' + (info.title||'') + '". Details: ' + (info.detail||'') + '. Impact: ' + (info.impact||'') + '. Give me a rich, helpful breakdown of this recommendation for a family with kids â€” what it means, pros and cons, how to execute it, and any tips. Format with clear sections. Keep it practical and friendly. Under 300 words.';
  var body2 = JSON.stringify({ contents:[{parts:[{text:prompt}]}], generationConfig:{maxOutputTokens:600,temperature:0.7} });
  fetch(GEMINI_URL, {method:'POST',headers:{'Content-Type':'application/json'},body:body2})
    .then(function(r){return r.json();})
    .then(function(data){
      var text='';try{text=data.candidates[0].content.parts[0].text.trim();}catch(e){}
      if (bodyEl) bodyEl.innerHTML = '<div style="font-size:.85rem;color:var(--text);line-height:1.7;white-space:pre-wrap;">' + text.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>') + '</div>';
    })
    .catch(function(){
      if (bodyEl) bodyEl.innerHTML = '<div style="color:var(--red);">Could not load AI info. Please check your connection.</div>';
    });
}

function renderAdjustments() {
  var el = document.getElementById('adjustments-content');
  if (!el) return;
  var all      = appState.aiSuggestions || [];
  var pending  = all.filter(function(s) { return s.status === 'pending'; });
  var accepted = all.filter(function(s) { return s.status === 'accepted'; });
  var dismissed= all.filter(function(s) { return s.status === 'dismissed'; });
  // Day picker options for manual generation
  var dayOpts = '';
  for (var dpi = 0; dpi < TRIP_DAYS.length; dpi++) {
    var dpd = TRIP_DAYS[dpi];
    dayOpts += '<option value="' + dpd.day + '">Day ' + dpd.day + ' \u2014 ' + dpd.title.substring(0, 40) + '</option>';
  }

  /* â”€â”€ Day-count warning â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  var activeSuggs = all.filter(function(s) { return s.isNewDest && s.status !== 'dismissed'; });
  var extraDays   = activeSuggs.reduce(function(sum, s) { return sum + (s.daysNeeded || 0); }, 0);
  var tripDays    = CONFIG.totalDays || 46;
  var dayWarning  = '';
  if (extraDays > 0) {
    var isOver = extraDays > 0; /* any new dest is a potential conflict unless something removed */
    var warnColor = 'var(--orange)';
    var warnBg    = 'var(--orange-l)';
    var warnBorder= '#f0c89e';
    dayWarning = '<div style="background:' + warnBg + ';border:1.5px solid ' + warnBorder + ';border-radius:12px;padding:13px 16px;margin-bottom:16px;display:flex;align-items:flex-start;gap:12px;">'
      + '<i class="fa-solid fa-triangle-exclamation" style="font-size:1.3rem;flex-shrink:0;color:var(--orange);"></i>'
      + '<div style="flex:1;">'
      + '<div style="font-weight:800;font-size:.88rem;color:' + warnColor + ';margin-bottom:3px;">Day Budget Heads-Up</div>'
      + '<div style="font-size:.82rem;color:var(--text);line-height:1.5;">'
      + 'Your new destination' + (activeSuggs.length > 1 ? 's add' : ' adds') + ' <strong>' + extraDays + ' day' + (extraDays !== 1 ? 's' : '') + '</strong> to your ' + tripDays + '-day trip. '
      + 'To keep the same total length, you\'ll need to remove or shorten ' + extraDays + ' day' + (extraDays !== 1 ? 's' : '') + ' elsewhere &mdash; check each suggestion\'s <em>trade-off</em> advice.'
      + '</div>'
      + (activeSuggs.length > 1 ? '<div style="margin-top:6px;font-size:.78rem;color:var(--text-2);">New destinations: ' + activeSuggs.map(function(s){return s.destName || s.title;}).join(', ') + '</div>' : '')
      + '</div></div>';
  }

  var html = dayWarning
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:8px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-wand-magic-sparkles"></i> Recommendations</h2>'
    + '<div style="display:flex;gap:6px;align-items:center;">'
    + (pending.length ? '<span style="background:var(--orange);color:#fff;font-size:.75rem;font-weight:800;padding:4px 12px;border-radius:100px;">' + pending.length + ' pending</span>' : '')
    + '<button onclick="switchTab(\'decisions\')" style="background:var(--red);color:#fff;border:none;border-radius:100px;padding:5px 10px;font-size:.75rem;font-weight:800;cursor:pointer;font-family:var(--font);"><i class="fa-solid fa-triangle-exclamation"></i> Decisions</button>'
    + '</div>'
    + '</div>';


  if (!all.length) {
    html += '<div style="text-align:center;padding:32px 20px;color:var(--text-3);"><div style="font-size:2.5rem;margin-bottom:12px;">&#129302;</div>'
      + '<div style="font-weight:700;font-size:.95rem;margin-bottom:6px;">No suggestions yet</div>'
      + '<div style="font-size:.82rem;line-height:1.5;">Use the generator above, or suggestions appear automatically when you record arrivals &amp; departures in the Schedule tab.</div></div>';
  } else {
    if (pending.length) {
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">Pending Review</div>'
        + '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">';
      for (var pi2 = 0; pi2 < pending.length; pi2++) html += adjCard(pending[pi2], true);
      html += '</div>';
    }
    if (accepted.length) {
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--green);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">&#10003; Accepted</div>'
        + '<div style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;">';
      for (var ai6 = 0; ai6 < accepted.length; ai6++) html += adjCard(accepted[ai6], false);
      html += '</div>';
    }
    if (dismissed.length) {
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">Dismissed</div>'
        + '<div style="display:flex;flex-direction:column;gap:6px;">';
      for (var di2 = 0; di2 < dismissed.length; di2++) html += adjCard(dismissed[di2], false);
      html += '</div>';
    }
  }
  el.innerHTML = html;
}

function adjCard(s, showActions) {
  var col = s.status === 'accepted' ? 'var(--green)' : s.status === 'dismissed' ? '#bbb' : 'var(--orange)';
  var h = '<div style="background:var(--card);border:1px solid var(--border);border-left:3px solid ' + col + ';border-radius:var(--radius-s);padding:14px 16px;">'
    + '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">'
    + '<div style="flex:1;"><div style="font-weight:800;font-size:.9rem;margin-bottom:4px;">' + (s.title||'') + '</div>';
  if (s.detail) h += '<div style="font-size:.82rem;color:var(--text-2);line-height:1.5;margin-bottom:6px;">' + s.detail + '</div>';
  if (!window._recInfoStore) window._recInfoStore = [];
  var _recIdx2 = window._recInfoStore.length;
  window._recInfoStore.push({title: s.title||'', detail: s.detail||'', impact: s.impact||''});
  h += '<button onclick="openRecommendationInfo(window._recInfoStore[' + _recIdx2 + '])" style="margin-top:8px;background:var(--purple-l);border:1px solid #c8b4e8;color:var(--purple);border-radius:100px;padding:5px 12px;font-size:.75rem;font-weight:700;cursor:pointer;font-family:var(--font);">âœ¨ Explore with AI</button>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
  if (s.impact) h += '<span style="background:var(--orange-l);color:var(--orange);font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:100px;">&#9889; ' + s.impact + '</span>';
  if (s.affectedDays && s.affectedDays.length) h += '<span style="background:var(--blue-l);color:var(--blue);font-size:.72rem;padding:2px 8px;border-radius:100px;">Days ' + s.affectedDays.join(', ') + '</span>';
  h += '</div></div>';
  if (showActions && s.status === 'pending') {
    h += '<div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">'
      + '<button onclick="acceptSuggestion(\'' + s.id + '\')" style="background:var(--green);color:#fff;border:none;border-radius:100px;font-family:var(--font);font-size:.75rem;font-weight:800;padding:6px 12px;cursor:pointer;">&#10003; Accept</button>'
      + '<button onclick="dismissSuggestion(\'' + s.id + '\')" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;font-family:var(--font);font-size:.75rem;padding:6px 12px;cursor:pointer;color:var(--text-2);">Dismiss</button></div>';
  } else if (s.status === 'accepted') {
    h += '<div style="font-size:.75rem;color:var(--green);font-weight:800;flex-shrink:0;">&#10003; Applied</div>';
  }
  return h + '</div></div>';
}

function acceptSuggestion(id) {
  if (!appState.aiSuggestions) return;
  for (var ai7 = 0; ai7 < appState.aiSuggestions.length; ai7++) {
    if (appState.aiSuggestions[ai7].id === id) {
      var s = appState.aiSuggestions[ai7]; s.status = 'accepted';
      if (!appState.dayNotes) appState.dayNotes = {};
      var days = (s.affectedDays && s.affectedDays.length) ? s.affectedDays : [s.sourceDay];
      for (var di3 = 0; di3 < days.length; di3++) {
        var dn = days[di3];
        appState.dayNotes[dn] = (appState.dayNotes[dn] ? appState.dayNotes[dn] + '<br>' : '') + '<strong>' + s.title + '</strong> \u2014 ' + s.detail;
      }
      break;
    }
  }
  saveState(appState); renderSchedule(); renderAdjustments(); updateAdjBadge();
  showToast('&#10003; Suggestion accepted!', 2400);
}

function dismissSuggestion(id) {
  if (!appState.aiSuggestions) return;
  for (var ai8 = 0; ai8 < appState.aiSuggestions.length; ai8++) {
    if (appState.aiSuggestions[ai8].id === id) { appState.aiSuggestions[ai8].status = 'dismissed'; break; }
  }
  saveState(appState); renderAdjustments(); updateAdjBadge();
  showToast('Suggestion dismissed', 1600);
}

function updateAdjBadge() {
  var pending = (appState.aiSuggestions || []).filter(function(s) { return s.status === 'pending'; }).length;
  var navBtn = document.getElementById('adj-nav-tab');
  if (!navBtn) return;
  // Tab is always visible â€” just manage the badge count
  var badge = navBtn.querySelector('.adj-badge');
  if (pending > 0) {
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'adj-badge';
      badge.style.cssText = 'background:var(--orange);color:#fff;font-size:.6rem;font-weight:900;padding:1px 5px;border-radius:100px;margin-left:4px;vertical-align:middle;';
      navBtn.appendChild(badge);
    }
    badge.textContent = pending;
  } else {
    if (badge) badge.remove();
  }
}

/* â”€â”€ DECISIONS TAB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

function computeTripVariance() {
  var today = new Date();
  today.setHours(0,0,0,0);
  var tripStart = new Date(CONFIG.startDate + 'T00:00:00');
  var tripEnd   = new Date(CONFIG.endDate   + 'T00:00:00');
  if (today < tripStart) {
    var daysLeft = Math.round((tripStart - today) / 86400000);
    return { type: 'pretrip', days: daysLeft };
  }
  if (today > new Date(tripEnd.getTime() + 86400000)) {
    return { type: 'posttrip' };
  }
  // Planned day number based purely on calendar
  var plannedDay = Math.min(Math.round((today - tripStart) / 86400000) + 1, TRIP_DAYS.length);
  // Pause days taken so far add delay to planned end date
  var pauseNights = 0;
  (appState.pauseDays || []).forEach(function(pd) {
    if (pd.startDate && pd.endDate) {
      var n = Math.max(0, Math.round((new Date(pd.endDate + 'T00:00:00') - new Date(pd.startDate + 'T00:00:00')) / 86400000));
      pauseNights += n;
    }
  });
  // Variance: how many days the trip has shifted relative to planned end
  var shiftedEnd = new Date(tripEnd.getTime() + pauseNights * 86400000);
  var daysDelta  = Math.round((shiftedEnd - tripEnd) / 86400000);
  return { type: 'ontrip', plannedDay: plannedDay, totalDays: TRIP_DAYS.length, pauseNights: pauseNights, shiftedEnd: shiftedEnd, daysDelta: daysDelta };
}

/* â”€â”€ GENIE ITEM PARSING â€” split numbered AI response into action cards â”€â”€ */
var _genieItems      = [];   // main TripGenie suggestions for renderDecisions
var _pauseGenieItems = {};   // per-pause suggestions keyed by pauseId

function _parseGenieItems(rawText) {
  if (!rawText) return [];
  // Strip HTML tags to get plain text
  var plain = rawText
    .replace(/<br\s*\/?>/gi, '\n')
    .replace(/<strong>/gi, '').replace(/<\/strong>/gi, '')
    .replace(/<[^>]+>/g, '');
  var items = [];
  var lines  = plain.split('\n');
  var current = null;
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    var m = line.match(/^(\d+)[.)]\s+(.+)/);
    if (m) {
      if (current) items.push(current);
      current = { num: parseInt(m[1]), text: m[2] };
    } else if (current && line) {
      current.text += ' ' + line;
    }
  }
  if (current) items.push(current);
  return items;
}

function _renderGenieCards(items, accentColor, bgColor, borderColor) {
  if (!items || !items.length) return '';
  var html = '<div style="display:flex;flex-direction:column;gap:8px;border-top:1px solid ' + borderColor + ';padding-top:10px;margin-top:6px;">';
  items.forEach(function(item, idx) {
    var escapedText = item.text.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
    html += '<div style="background:' + bgColor + ';border:1px solid ' + borderColor + ';border-radius:12px;padding:12px 14px;">'
      + '<div style="font-size:.82rem;color:' + accentColor + ';line-height:1.55;margin-bottom:9px;"><strong>' + item.num + '.</strong> ' + item.text + '</div>'
      + '<button id="genie-btn-' + idx + '" onclick="_applyGenieItem(' + idx + ')" style="background:' + accentColor + ';color:#fff;border:none;border-radius:100px;padding:8px 18px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:var(--font);">âœ“ Make This Change</button>'
      + '</div>';
  });
  html += '</div>';
  return html;
}

function _applyGenieItem(idx) {
  var item = _genieItems[idx];
  if (!item) return;
  _applyGenieChangeWithAI(item.text, 'genie-btn-' + idx);
}

function _applyPauseGenieItem(pauseId, idx) {
  var items = _pauseGenieItems[pauseId] || [];
  var item  = items[idx];
  if (!item) return;
  _applyGenieChangeWithAI(item.text, 'pgenie-btn-' + pauseId + '-' + idx);
}

/* Extract a JSON array from text using bracket counting, string-aware.
   Looks for [{ or [[ pattern to avoid picking up preamble like "[3] suggestions:" */
function _extractJsonArray(text) {
  /* Prefer the first '[' that's immediately followed by '{' or '[' (array of objects/arrays).
     This skips things like "[3] changes" that Gemini sometimes prepends. */
  var reObjArray = /\[\s*[{\[]/;
  var m = reObjArray.exec(text);
  var start = m ? m.index : text.indexOf('[');
  if (start === -1) return null;
  var depth = 0, inStr = false, esc = false;
  for (var ci = start; ci < text.length; ci++) {
    var ch = text[ci];
    if (esc)                  { esc = false; continue; }
    if (ch === '\\' && inStr) { esc = true;  continue; }
    if (ch === '"')           { inStr = !inStr; continue; }
    if (inStr)                { continue; }
    if (ch === '[')           { depth++; }
    else if (ch === ']')      { depth--; if (depth === 0) return text.substring(start, ci + 1); }
  }
  return null;
}

/* Strip JS-style single-line and block comments from JSON-like text before parsing */
function _stripJsonComments(s) {
  return s.replace(/\/\/[^\n\r]*/g, '').replace(/\/\*[\s\S]*?\*\//g, '');
}

/* Fast text-based parser â€” handles the structured suggestions the AI generates
   without needing a second API round-trip */
function _parseChangesFromText(suggestion) {
  var s = suggestion.toLowerCase();
  var changes = [];

  /* Build a lookup: partial name â†’ stop */
  TRIP_STOPS.forEach(function(stop) {
    var words = stop.name.toLowerCase().split(/[\s,\/]+/);
    /* Find the first meaningful keyword from the stop name in the suggestion */
    var found = words.some(function(w) { return w.length > 3 && s.indexOf(w) !== -1; });
    if (!found) return;

    var currentNights = TRIP_DAYS.filter(function(d) { return d.stopId === stop.id && !d.driveDay; }).length;

    /* Skip / remove */
    if (/\b(skip|remove|drop|eliminate|cut)\b/.test(s) && s.indexOf(stop.name.toLowerCase().split(/[\s,]/)[0]) !== -1) {
      changes.push({ stopId: stop.id, name: stop.name, remove: true });
      return;
    }

    /* "from X nights to Y nights" or "from X to Y nights" */
    var fromTo = s.match(/from\s+(\d+)\s+(?:nights?\s+)?to\s+(\d+)/);
    if (fromTo) {
      changes.push({ stopId: stop.id, name: stop.name, nights: parseInt(fromTo[2], 10) });
      return;
    }

    /* "reduce/shorten/cut to N nights" or "extend/increase/add to N nights" */
    var toN = s.match(/(?:to|down to|up to)\s+(\d+)\s+nights?/);
    if (toN) {
      changes.push({ stopId: stop.id, name: stop.name, nights: parseInt(toN[1], 10) });
      return;
    }

    /* "add N nights" â†’ currentNights + N */
    var addN = s.match(/add\s+(\d+)\s+nights?/);
    if (addN && currentNights > 0) {
      changes.push({ stopId: stop.id, name: stop.name, nights: currentNights + parseInt(addN[1], 10) });
      return;
    }

    /* "N nights" anywhere near this stop name */
    var anyN = s.match(/(\d+)\s+nights?/);
    if (anyN) {
      var n = parseInt(anyN[1], 10);
      if (n !== currentNights && n > 0 && n <= 14) {
        changes.push({ stopId: stop.id, name: stop.name, nights: n });
      }
    }
  });

  /* De-duplicate by stopId â€” keep first */
  var seen = {};
  return changes.filter(function(c) {
    if (seen[c.stopId]) return false;
    seen[c.stopId] = true;
    return true;
  });
}

function _applyGenieChangeWithAI(suggestion, btnId) {
  var btn = document.getElementById(btnId);
  if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Applyingâ€¦'; btn.disabled = true; }

  /* â”€â”€ Fast path: simple night changes / removals parsed directly from text â”€â”€ */
  var fastChanges = _parseChangesFromText(suggestion);
  if (fastChanges.length > 0) {
    _applyTripChanges(fastChanges, suggestion, btn);
    return;
  }

  /* â”€â”€ Full restructure path: ask Gemini for complete new ordered stop list â”€â”€ */
  var validIds = {};
  var stopSummary = TRIP_STOPS.map(function(s) {
    var nights = TRIP_DAYS.filter(function(d) { return d.stopId === s.id && !d.driveDay; }).length;
    validIds[s.id] = true;
    return { stopId: s.id, name: s.name, currentNights: nights };
  });

  var prompt = 'You are an expert RV trip planner. Apply the requested change and return the COMPLETE new ordered stop list as a JSON array.\n\n'
    + 'Current stops in order:\n' + JSON.stringify(stopSummary) + '\n\n'
    + 'Departure city: ' + _tripStartCity() + '\n'
    + 'Arrival city: ' + (_tripIsRoundTrip() ? _tripStartCity() + ' (round trip)' : _tripEndCity()) + '\n'
    + 'Trip dates: ' + CONFIG.startDate + ' â†’ ' + CONFIG.endDate + '\n\n'
    + 'Change: "' + suggestion.replace(/"/g, "'") + '"\n\n'
    + 'Return a JSON array listing EVERY stop that should remain, in the correct travel order:\n'
    + '[{"stopId":1,"name":"Shenandoah Valley","nights":2}, ...]\n'
    + 'RULES:\n'
    + '- Use ONLY stopId numbers from the list above â€” do not invent new stopIds\n'
    + '- You may reorder, change nights, or omit stops to remove them\n'
    + '- nights = total explore nights (drive day handled separately)\n'
    + '- If no change is needed, return the current list exactly as-is\n'
    + 'Output ONLY the raw JSON array, no markdown, no explanation.';

  var body = JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] });

  fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var rawText = ((data.candidates[0].content.parts[0].text) || '').trim();
      rawText = rawText.replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/i, '').trim();
      var jsonStr = _extractJsonArray(rawText);
      if (!jsonStr) throw new Error('No JSON array: ' + rawText.slice(0, 120));
      var newOrder = JSON.parse(jsonStr);
      if (!Array.isArray(newOrder) || newOrder.length === 0) throw new Error('Empty order');

      /* Validate: every stopId must be known, and we need at least half the original stops */
      var unknown = newOrder.filter(function(item) { return !validIds[parseInt(item.stopId, 10)]; });
      if (unknown.length > 0) throw new Error('Unknown stopIds: ' + unknown.map(function(u){return u.stopId;}).join(','));
      if (newOrder.length < Math.floor(TRIP_STOPS.length / 2)) throw new Error('Too few stops returned');

      _applyFullReorder(newOrder, suggestion, btn);
    })
    .catch(function(err) {
      console.warn('[ChangePlan] Error:', err);
      if (btn) { btn.innerHTML = 'âœ“ Make This Change'; btn.disabled = false; }
      showToast('Could not apply â€” please rephrase or try again.', 3500);
    });
}

/* Rebuild TRIP_DAYS from a new ordered stop list [{stopId, name, nights}].
   Preserves all existing day details (campsite names, drivers, etc.) where possible. */
function _applyFullReorder(newOrder, description, sourceBtn) {
  var newDays = [];
  var changeLog = [];

  newOrder.forEach(function(item, idx) {
    /* Resolve stopId â€” exact match first, then name fuzzy match */
    var stopId = parseInt(item.stopId, 10);
    var stop = TRIP_STOPS.find(function(s) { return s.id === stopId; });
    if (!stop && item.name) {
      var needle = String(item.name).toLowerCase().split(/[\s,]+/)[0];
      stop = TRIP_STOPS.find(function(s) { return s.name.toLowerCase().indexOf(needle) !== -1; });
      if (stop) stopId = stop.id;
    }
    if (!stop) { console.warn('[ChangePlan] Unknown stop:', item); return; }

    var targetNights = Math.max(1, parseInt(item.nights, 10) || 1);

    /* Pull existing days for this stop */
    var exDays    = TRIP_DAYS.filter(function(d) { return d.stopId === stopId; });
    var exDrive   = exDays.filter(function(d)  { return d.driveDay; });
    var exExplore = exDays.filter(function(d)  { return !d.driveDay; });
    var origNights = exExplore.length;

    /* --- Drive day --- */
    if (exDrive.length > 0) {
      /* Use existing drive day data (has real miles, campsite, driver, etc.) */
      newDays.push(JSON.parse(JSON.stringify(exDrive[0])));
    } else if (idx > 0) {
      /* Synthesise a drive day if none exists */
      newDays.push({
        stopId: stopId, driveDay: true, miles: 300, driveHours: 5,
        driver: (idx % 2 === 0 ? 'Paul' : 'Melissa'),
        sleep: stop.name, sleepType: 'rv_park', springBreak: false,
        phase: stop.region || stop.name,
        title: 'Drive to ' + stop.name
      });
    }

    /* --- Explore days --- */
    for (var ni = 0; ni < targetNights; ni++) {
      if (ni < exExplore.length) {
        newDays.push(JSON.parse(JSON.stringify(exExplore[ni])));
      } else {
        /* Clone last available explore day as template */
        var tmpl = exExplore.length > 0
          ? JSON.parse(JSON.stringify(exExplore[exExplore.length - 1]))
          : { stopId: stopId, driveDay: false, miles: 0, driveHours: 0,
              driver: 'Paul', sleep: stop.name, sleepType: 'rv_park',
              springBreak: false, phase: stop.region || stop.name,
              title: 'Explore ' + stop.name };
        tmpl.stopId = stopId;
        tmpl.driveDay = false; tmpl.miles = 0; tmpl.driveHours = 0;
        tmpl.title = 'Extra day â€” ' + stop.name;
        newDays.push(tmpl);
      }
    }

    if (targetNights !== origNights) {
      changeLog.push(stop.name + ': ' + origNights + 'â†’' + targetNights + ' night' + (targetNights !== 1 ? 's' : ''));
    }
  });

  if (!newDays.length) {
    if (sourceBtn) { sourceBtn.innerHTML = 'âœ“ Make This Change'; sourceBtn.disabled = false; }
    showToast('Could not rebuild trip â€” try again.', 3000);
    return;
  }

  /* Renumber days and reassign dates from CONFIG.startDate */
  var startMs = new Date(CONFIG.startDate + 'T00:00:00').getTime();
  newDays = newDays.map(function(d, i) {
    var dd = new Date(startMs + i * 86400000);
    var ds = dd.getFullYear() + '-' + String(dd.getMonth() + 1).padStart(2, '0') + '-' + String(dd.getDate()).padStart(2, '0');
    return Object.assign({}, d, { day: i + 1, date: ds });
  });

  /* Persist as custom trip */
  var tripName = (appState.activeTrip === 'custom' && appState.customTripData && appState.customTripData.tripName)
    ? appState.customTripData.tripName
    : (((appState.tripSettings && appState.tripSettings.tripName) || 'My Trip') + ' (Modified)');

  appState.customTripData = {
    tripName:   tripName,
    stops:      JSON.parse(JSON.stringify(TRIP_STOPS)),
    days:       newDays,
    startDate:  CONFIG.startDate,
    endDate:    CONFIG.endDate,
    totalDays:  newDays.length,
    totalMiles: CONFIG.totalMiles
  };
  appState.activeTrip = 'custom';

  if (typeof _audit === 'function') _audit('Trip Restructured', description + (changeLog.length ? ' â†’ ' + changeLog.join('; ') : ''));

  saveState(appState);
  initApp();

  var msg = changeLog.length ? 'âœ… Applied: ' + changeLog.join(', ') : 'âœ… Trip updated!';
  showToast(msg, 5000);
  if (sourceBtn) { try { sourceBtn.innerHTML = 'âœ… Applied!'; sourceBtn.style.background = '#2e7d52'; sourceBtn.disabled = true; } catch(e) {} }
  _adjShowMorePrompt();
}

function _applyTripChanges(changes, description, sourceBtn) {
  var newDays  = JSON.parse(JSON.stringify(TRIP_DAYS));
  var applied  = [];

  changes.forEach(function(change) {
    var stopId = change.stopId;
    /* Resolve stop â€” try exact id match first, then name-based fuzzy fallback */
    var stop = TRIP_STOPS.find(function(s) { return s.id === stopId || s.id === parseInt(stopId, 10); });
    if (!stop && change.name) {
      var needle = String(change.name).toLowerCase();
      stop = TRIP_STOPS.find(function(s) {
        var hay = s.name.toLowerCase();
        return hay.indexOf(needle) !== -1 || needle.indexOf(hay) !== -1;
      });
    }
    if (stop) stopId = stop.id;
    var stopName = stop ? stop.name : (change.name || String(stopId));

    if (change.remove) {
      var before = newDays.length;
      newDays = newDays.filter(function(d) { return d.stopId !== stopId; });
      var removed = before - newDays.length;
      /* Also remove the stop from TRIP_STOPS so the Stops tab reflects the change */
      var stopIdx = TRIP_STOPS.findIndex(function(s) { return s.id === stopId; });
      if (stopIdx !== -1) TRIP_STOPS.splice(stopIdx, 1);
      if (removed > 0 || stopIdx !== -1) applied.push('Removed ' + stopName + ' (' + removed + ' day' + (removed !== 1 ? 's' : '') + ')');

    } else if (typeof change.nights !== 'undefined') {
      var targetNights = parseInt(change.nights, 10);
      if (isNaN(targetNights) || targetNights < 0) return;
      var currentNights = newDays.filter(function(d) { return d.stopId === stopId && !d.driveDay; }).length;

      if (targetNights < currentNights) {
        /* Reduce nights â€” remove excess explore days from the end of this stop */
        var toRemove = currentNights - targetNights;
        var removedCount = 0;
        for (var k = newDays.length - 1; k >= 0 && removedCount < toRemove; k--) {
          if (newDays[k].stopId === stopId && !newDays[k].driveDay) {
            newDays.splice(k, 1);
            removedCount++;
          }
        }
        applied.push(stopName + ': ' + currentNights + 'â†’' + targetNights + ' night' + (targetNights !== 1 ? 's' : ''));

      } else if (targetNights > currentNights) {
        /* Increase nights â€” clone the last explore day and insert copies after it */
        var toAdd = targetNights - currentNights;
        var lastIdx = -1;
        for (var ki = newDays.length - 1; ki >= 0; ki--) {
          if (newDays[ki].stopId === stopId && !newDays[ki].driveDay) { lastIdx = ki; break; }
        }
        /* Fallback: find the last day for this stop at all */
        if (lastIdx === -1) {
          for (var kj = newDays.length - 1; kj >= 0; kj--) {
            if (newDays[kj].stopId === stopId) { lastIdx = kj; break; }
          }
        }
        if (lastIdx !== -1) {
          var template = JSON.parse(JSON.stringify(newDays[lastIdx]));
          template.driveDay = false; template.miles = 0; template.driveHours = 0;
          template.title = 'Extra day â€” ' + stopName;
          var inserts = [];
          for (var ai = 0; ai < toAdd; ai++) inserts.push(JSON.parse(JSON.stringify(template)));
          newDays.splice.apply(newDays, [lastIdx + 1, 0].concat(inserts));
          applied.push(stopName + ': ' + currentNights + 'â†’' + targetNights + ' night' + (targetNights !== 1 ? 's' : ''));
        }
      }
      /* If targetNights === currentNights, nothing to do for this stop */
    }
  });

  if (!applied.length) {
    if (sourceBtn) { sourceBtn.innerHTML = 'âœ“ Make This Change'; sourceBtn.disabled = false; }
    showToast('No changes were needed â€” the trip already matches this.', 2800);
    return;
  }

  /* Renumber days and reassign dates sequentially from CONFIG.startDate */
  var _startMs = new Date(CONFIG.startDate + 'T00:00:00').getTime();
  for (var i = 0; i < newDays.length; i++) {
    var _d = new Date(_startMs + i * 86400000);
    var _dateStr = _d.getFullYear() + '-'
      + String(_d.getMonth() + 1).padStart(2, '0') + '-'
      + String(_d.getDate()).padStart(2, '0');
    newDays[i] = Object.assign({}, newDays[i], { day: i + 1, date: _dateStr });
  }

  /* Save as / overwrite custom trip */
  var tripName;
  if (appState.activeTrip === 'custom' && appState.customTripData && appState.customTripData.tripName) {
    tripName = appState.customTripData.tripName;
  } else {
    var baseName = (appState.tripSettings && appState.tripSettings.tripName) || (_BUILTIN_TRIP && _BUILTIN_TRIP.tripName) || 'My Trip';
    tripName = baseName + ' (Modified)';
  }

  appState.customTripData = {
    tripName:   tripName,
    stops:      JSON.parse(JSON.stringify(TRIP_STOPS)),
    days:       newDays,
    startDate:  CONFIG.startDate,
    endDate:    CONFIG.endDate,
    totalDays:  newDays.length,
    totalMiles: CONFIG.totalMiles
  };
  appState.activeTrip = 'custom';

  if (typeof _audit === 'function') {
    _audit('Trip Modified by TripGenie', description + ' â†’ ' + applied.join('; '));
  }

  saveState(appState);
  initApp();
  showToast('âœ… Done! ' + applied.join(', '), 5000);

  /* Mark the card as applied â€” stay open so user can apply more changes */
  if (sourceBtn) {
    try { sourceBtn.innerHTML = 'âœ… Applied!'; sourceBtn.style.background = '#2e7d52'; sourceBtn.disabled = true; } catch(e) {}
  }
  _adjShowMorePrompt();
}

/* â”€â”€ Adjustments tab: voice/text change request â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _adjVoiceItems      = [];
var _adjMicRecognition  = null;

function _adjStartMic() {
  var SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) { showToast('Speech recognition not supported â€” try Chrome!', 3000); return; }
  var btn = document.getElementById('adj-voice-mic-btn');
  var ta  = document.getElementById('adj-voice-ta');
  /* Toggle off if already recording */
  if (_adjMicRecognition) {
    _adjMicRecognition.stop();
    _adjMicRecognition = null;
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.style.background = 'var(--orange)'; }
    return;
  }
  var rec = new SpeechRec();
  rec.continuous = true; rec.interimResults = true; rec.lang = 'en-US';
  _adjMicRecognition = rec;
  var existingText = (ta ? ta.value.trim() : '');
  rec.onstart = function() {
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-stop"></i>'; btn.style.background = 'var(--red,#e53935)'; }
    if (ta)  { ta.style.borderColor = 'var(--red,#e53935)'; }
  };
  rec.onresult = function(e) {
    var final = existingText; var interim = '';
    for (var i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += (final ? ' ' : '') + e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    if (ta) { ta.value = final + (interim ? ' ' + interim : ''); ta.style.borderColor = 'var(--orange)'; }
    existingText = final;
  };
  rec.onerror = function() {
    _adjMicRecognition = null;
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.style.background = 'var(--orange)'; }
    if (ta)  { ta.style.borderColor = '#b3d4f5'; }
  };
  rec.onend = function() {
    _adjMicRecognition = null;
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.style.background = 'var(--orange)'; }
    if (ta)  { ta.style.borderColor = '#b3d4f5'; }
  };
  rec.start();
}

function _adjGetSuggestions() {
  var ta = document.getElementById('adj-voice-ta');
  var request = ta ? ta.value.trim() : '';
  if (!request) { showToast('Describe the change you need first â€” try the microphone!', 2800); return; }

  /* Stop mic if still running */
  if (_adjMicRecognition) { _adjMicRecognition.stop(); _adjMicRecognition = null; }

  var btn     = document.getElementById('adj-voice-btn');
  var results = document.getElementById('adj-voice-results');
  if (btn)     { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Thinkingâ€¦'; btn.disabled = true; }
  if (results) { results.innerHTML = ''; }

  /* Build a rich stop summary for the AI â€” include id, name, state, region, coords, current nights */
  /* Mark first and last stops as protected so Genie never suggests removing them */
  var _adjFirstId = TRIP_STOPS.length ? TRIP_STOPS[0].id : null;
  var _adjLastId  = TRIP_STOPS.length ? TRIP_STOPS[TRIP_STOPS.length - 1].id : null;
  var _adjRound   = _tripIsRoundTrip();
  var stopSummaryArr = TRIP_STOPS.map(function(s) {
    var nights = TRIP_DAYS.filter(function(d) { return d.stopId === s.id && !d.driveDay; }).length;
    var isStart = (s.id === _adjFirstId);
    var isEnd   = (!_adjRound && s.id === _adjLastId);
    return { stopId: s.id, name: s.name, state: s.state || '', region: s.region || '',
             lat: s.lat || 0, lng: s.lng || 0, nights: nights,
             protected: isStart || isEnd,
             protectedReason: isStart ? 'START' : (isEnd ? 'END' : '') };
  });
  var stopLines = stopSummaryArr.map(function(s) {
    var tag = s.protected ? ' [PROTECTED-' + s.protectedReason + ': never remove]' : '';
    return 'stopId ' + s.stopId + ': ' + s.name + ' (' + s.state + ', ' + s.nights + ' nights)' + tag;
  }).join('\n');

  /* City context â€” derived from TRIP_STOPS, always in sync */
  var cityLine = 'Trip departure city: ' + _tripStartCity() + '\n'
    + 'Trip arrival city: ' + (_adjRound ? _tripStartCity() + ' (same as departure â€” round trip)' : _tripEndCity()) + '\n';

  var prompt = 'You are an expert RV trip planner. A family is asking you to help adjust their cross-country RV itinerary.\n\n'
    + 'Current stops in travel order:\n' + stopLines + '\n\n'
    + cityLine
    + 'Trip dates: ' + CONFIG.startDate + ' to ' + CONFIG.endDate + '\n\n'
    + 'The family says: "' + request.replace(/"/g, "'") + '"\n\n'
    + 'TASK: Return a JSON array of 1-4 specific, actionable suggestions that DIRECTLY address what the family said.\n'
    + 'Each item must have an "op" field â€” one of: "set_nights", "remove", "add_stop", or "none".\n\n'
    + 'Return a plain JSON array (no comments, no markdown) using exactly these op types:\n'
    + '[\n'
    + '  {"op":"set_nights","stopId":3,"stopName":"Stop Name","nights":4,"text":"One friendly sentence explaining this change."},\n'
    + '  {"op":"remove","stopId":3,"stopName":"Stop Name","text":"One friendly sentence explaining why."},\n'
    + '  {"op":"add_stop","name":"City Name","state":"XX","region":"Region","lat":35.5,"lng":-90.1,"nights":2,"afterStopId":3,"text":"One friendly sentence."},\n'
    + '  {"op":"none","text":"One friendly sentence explaining why no change is needed."}\n'
    + ']\n\n'
    + 'CRITICAL RULES:\n'
    + '1. ONLY respond to what the family actually asked. Do not invent unrelated changes.\n'
    + '2. For add_stop: choose a geographically logical real place. Provide accurate lat/lng. Set afterStopId to the nearest stop they should pass through before this new stop.\n'
    + '3. For add_stop adding days: you may ALSO include a set_nights for another stop to keep the total trip length roughly the same (optional).\n'
    + '4. For set_nights and remove: use ONLY stopId numbers from the current stops list above. Do not invent new stopIds.\n'
    + '5. "text" must be a short, friendly, human-readable sentence explaining this change.\n'
    + '6. If the request is already satisfied (e.g. trip already starts there, stop is already there), use op:"none" with an explanation.\n'
    + '6b. If the family asks a direct question (e.g. "How many days does this add?", "What is the weather like?"), answer it clearly using op:"none" with the answer in "text". Include it FIRST in the array before any actionable suggestions.\n'
    + '7. Output ONLY the raw JSON array. No markdown fences, no extra text outside the array.\n'
    + '8. NEVER suggest op:"remove" for any stop marked [PROTECTED-START] or [PROTECTED-END]. These are the fixed departure and arrival cities and cannot be removed from the itinerary.';

  var body = JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] });

  fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var rawText = ((data.candidates[0].content.parts[0].text) || '').trim();
      rawText = rawText.replace(/^```[a-z]*\n?/i, '').replace(/\n?```$/i, '').trim();

      if (btn) { btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i> Get Suggestions'; btn.disabled = false; }

      /* Parse structured JSON suggestions */
      var parsed = [];
      try {
        var jsonStr = _extractJsonArray(rawText);
        if (jsonStr) parsed = JSON.parse(_stripJsonComments(jsonStr));
      } catch(e) {
        /* Fallback: try parsing the whole (comment-stripped) response */
        try { parsed = JSON.parse(_stripJsonComments(rawText)); } catch(e2) { parsed = []; }
      }

      /* Client-side safety: determine protected stop IDs (first + last) */
      var _protectedIds = [];
      if (TRIP_STOPS.length) {
        _protectedIds.push(TRIP_STOPS[0].id);
        var _lastStop = TRIP_STOPS[TRIP_STOPS.length - 1];
        if (_lastStop.id !== TRIP_STOPS[0].id) _protectedIds.push(_lastStop.id);
      }

      /* Filter/validate â€” ensure each item has op and text; block remove on protected stops */
      _adjVoiceItems = parsed.filter(function(item) {
        if (!item || typeof item.op !== 'string' || typeof item.text !== 'string') return false;
        /* Never show a remove suggestion for a protected (start/end) stop */
        if (item.op === 'remove' && _protectedIds.indexOf(item.stopId) !== -1) return false;
        return true;
      }).map(function(item, i) {
        return Object.assign({ num: i + 1 }, item);
      });

      if (!_adjVoiceItems.length) {
        /* Fallback: display raw text as info */
        if (results) results.innerHTML = '<div style="font-size:.82rem;color:var(--text-2);padding:10px 0;line-height:1.6;">' + rawText.replace(/</g,'&lt;') + '</div>';
        return;
      }

      /* Check for "none" â€” if all items are op:none, just show message */
      var actionable = _adjVoiceItems.filter(function(it) { return it.op !== 'none'; });
      if (!actionable.length) {
        if (results) results.innerHTML = '<div style="font-size:.84rem;color:var(--text-2);padding:10px 0;line-height:1.6;background:#f0f7ff;border-radius:10px;padding:12px 14px;border:1px solid #b3d4f5;">'
          + '<i class="fa-solid fa-circle-check" style="color:#2e7d52;margin-right:6px;"></i>'
          + _adjVoiceItems[0].text + '</div>';
        var replyBar2 = document.getElementById('adj-reply-bar');
        if (replyBar2) replyBar2.style.display = 'block';
        return;
      }

      var cnt = _adjVoiceItems.length;
      var cardsHtml = '<div style="padding-top:12px;border-top:1px solid #b3d4f5;margin-top:10px;">'
        + '<div style="font-size:.77rem;font-weight:900;color:#1a4a8a;text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px;">'
        + '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i>'
        + ' <span style="background:#1a4a8a;color:#fff;border-radius:100px;padding:1px 8px;font-size:.72rem;margin-left:2px;">' + cnt + '</span>'
        + '&nbsp;Suggestion' + (cnt !== 1 ? 's' : '') + ' for your trip</div>';

      _adjVoiceItems.forEach(function(item, idx) {
        /* â”€â”€ Info / Q&A card (op:none) â”€â”€ */
        if (item.op === 'none') {
          cardsHtml += '<div style="background:#f0f7ff;border:1px solid #b3d4f5;border-radius:12px;padding:12px 14px;margin-bottom:8px;font-size:.82rem;color:var(--text-2);line-height:1.55;">'
            + '<i class="fa-solid fa-circle-info" style="color:#1565c0;margin-right:6px;"></i>' + item.text + '</div>';
          return;
        }

        /* â”€â”€ Calculate day impact â”€â”€ */
        var dayDelta = 0;
        var dayLabel = '';
        if (item.op === 'add_stop') {
          var addNights = Math.max(1, parseInt(item.nights, 10) || 2);
          dayDelta = addNights + 1; /* explore nights + 1 drive day */
          dayLabel = '+' + dayDelta + ' day' + (dayDelta !== 1 ? 's' : '')
            + ' <span style="opacity:.75;font-weight:600;">(1 drive + ' + addNights + ' explore)</span>';
        } else if (item.op === 'set_nights') {
          var currentNights = TRIP_DAYS.filter(function(d) { return d.stopId === item.stopId && !d.driveDay; }).length;
          dayDelta = (parseInt(item.nights, 10) || 0) - currentNights;
          if (dayDelta !== 0) {
            dayLabel = (dayDelta > 0 ? '+' : '') + dayDelta + ' day' + (Math.abs(dayDelta) !== 1 ? 's' : '')
              + ' <span style="opacity:.75;font-weight:600;">(was ' + currentNights + ' â†’ ' + item.nights + ' nights)</span>';
          }
        } else if (item.op === 'remove') {
          var removeDays = TRIP_DAYS.filter(function(d) { return d.stopId === item.stopId; }).length;
          dayDelta = -removeDays;
          if (removeDays > 0) {
            dayLabel = '-' + removeDays + ' day' + (removeDays !== 1 ? 's' : '')
              + ' <span style="opacity:.75;font-weight:600;">(removes entire stop)</span>';
          }
        }

        var dayImpactHtml = '';
        if (dayLabel) {
          var impactColor = dayDelta > 0 ? '#2e7d52' : dayDelta < 0 ? '#c62828' : '#555';
          dayImpactHtml = '<div style="margin-bottom:9px;">'
            + '<div style="font-size:.67rem;font-weight:900;text-transform:uppercase;letter-spacing:.06em;color:var(--text-3);margin-bottom:4px;">Trip Impact</div>'
            + '<div style="display:inline-flex;align-items:center;gap:5px;background:#f4f7fb;border:1px solid #d0dff0;border-radius:100px;padding:4px 11px;font-size:.76rem;font-weight:800;color:' + impactColor + ';">'
            + '<i class="fa-solid fa-calendar-days" style="font-size:.68rem;"></i> ' + dayLabel + '</div>'
            + '</div>';
        }

        /* â”€â”€ Op badge & button â”€â”€ */
        var opBadge = '';
        var btnLabel = 'âœ“ Make This Change';
        if (item.op === 'add_stop') {
          opBadge = '<span style="background:#2e7d52;color:#fff;border-radius:100px;padding:1px 8px;font-size:.68rem;font-weight:800;margin-right:6px;">+ ADD STOP</span>';
          btnLabel = '+ Add This Stop';
        } else if (item.op === 'remove') {
          opBadge = '<span style="background:#c62828;color:#fff;border-radius:100px;padding:1px 8px;font-size:.68rem;font-weight:800;margin-right:6px;">âœ• REMOVE</span>';
          btnLabel = 'âœ• Remove This Stop';
        } else if (item.op === 'set_nights') {
          opBadge = '<span style="background:#1565c0;color:#fff;border-radius:100px;padding:1px 8px;font-size:.68rem;font-weight:800;margin-right:6px;">âœ CHANGE NIGHTS</span>';
        }

        cardsHtml += '<div style="background:#fff;border:1.5px solid #b3d4f5;border-radius:12px;padding:12px 14px;margin-bottom:8px;">'
          + dayImpactHtml
          + '<div style="font-size:.82rem;color:#1a4a8a;line-height:1.55;margin-bottom:9px;">' + opBadge + item.text + '</div>'
          + '<button id="adjvoice-btn-' + idx + '" onclick="_applyAdjVoiceItem(' + idx + ')" style="background:linear-gradient(135deg,#1a4a8a 0%,#5b2d8a 100%);color:#fff;border:none;border-radius:100px;padding:8px 18px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:var(--font);">' + btnLabel + '</button>'
          + '</div>';
      });
      cardsHtml += '</div>';

      if (results) results.innerHTML = cardsHtml;
      var replyBar = document.getElementById('adj-reply-bar');
      if (replyBar) replyBar.style.display = 'block';
    })
    .catch(function(err) {
      console.warn('[ChangePlan] suggestions error:', err);
      if (btn) { btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i> Get Suggestions'; btn.disabled = false; }
      if (results) results.innerHTML = '<div style="font-size:.82rem;color:var(--red,#e53935);padding:10px 0;"><i class="fa-solid fa-triangle-exclamation"></i> Could not reach TripGenie â€” please try again.</div>';
    });
}

/* Show a "make another change?" prompt below the cards after an apply */
function _adjShowMorePrompt() {
  var results = document.getElementById('adj-voice-results');
  if (!results) return;
  /* Remove any existing prompt so we don't stack duplicates */
  var old = results.querySelector('.adj-more-prompt');
  if (old) old.remove();
  var div = document.createElement('div');
  div.className = 'adj-more-prompt';
  div.style.cssText = 'margin-top:14px;padding:12px 14px;background:#f0f7ff;border:1px solid #b3d4f5;border-radius:12px;text-align:center;';
  div.innerHTML = '<div style="font-size:.82rem;font-weight:700;color:#1a4a8a;margin-bottom:8px;">âœ… Change applied! Want to make another?</div>'
    + '<div style="display:flex;gap:8px;justify-content:center;">'
    + '<button onclick="_adjClearAndFocus()" style="background:var(--orange);color:#fff;border:none;border-radius:100px;padding:8px 18px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœï¸ Ask for another change</button>'
    + '<button onclick="closeChangePlanModal()" style="background:#e8edf2;color:#444;border:none;border-radius:100px;padding:8px 18px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:var(--font);">âœ• Done</button>'
    + '</div>';
  results.appendChild(div);
}

/* Clear the text box, scroll it into view, and focus it for another request */
function _adjClearAndFocus() {
  var ta = document.getElementById('adj-voice-ta');
  var results = document.getElementById('adj-voice-results');
  if (ta) { ta.value = ''; ta.focus(); ta.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
  if (results) { results.innerHTML = ''; }
}

function _applyAdjVoiceItem(idx) {
  var item = _adjVoiceItems[idx];
  if (!item) return;
  var btnId = 'adjvoice-btn-' + idx;
  var btn = document.getElementById(btnId);

  if (!item.op || item.op === 'none') {
    showToast(item.text || 'No change needed.', 3000);
    return;
  }

  if (item.op === 'set_nights') {
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Applyingâ€¦'; btn.disabled = true; }
    _applyTripChanges([{ stopId: item.stopId, name: item.stopName, nights: item.nights }], item.text, btn);
    return;
  }

  if (item.op === 'remove') {
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Removingâ€¦'; btn.disabled = true; }
    _applyTripChanges([{ stopId: item.stopId, name: item.stopName, remove: true }], item.text, btn);
    return;
  }

  if (item.op === 'add_stop') {
    _addNewStop(item, btn);
    return;
  }

  /* Fallback for any other op: use legacy AI-based approach */
  _applyGenieChangeWithAI(item.text, btnId);
}

/* Add a brand-new stop to the trip â€” creates new TRIP_STOPS entry + drive/explore days */
function _addNewStop(item, sourceBtn) {
  if (sourceBtn) { sourceBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Adding stopâ€¦'; sourceBtn.disabled = true; }

  /* Generate a new unique stopId */
  var maxId = 0;
  TRIP_STOPS.forEach(function(s) { if (s.id > maxId) maxId = s.id; });
  var newStopId = maxId + 1;

  var nights = Math.max(1, parseInt(item.nights, 10) || 2);
  var _attraction = item.attraction || _admConfirmedAttraction || '';
  var _cityName   = item.city || item.name || 'New Stop';
  var _initActs   = _attraction
    ? [{ name: _attraction, desc: 'A must-see in ' + _cityName + '.', duration: '2-3 hours', type: 'attraction', mustDo: true }]
    : [];

  var newStop = {
    id:          newStopId,
    name:        _cityName,
    state:       item.state       || '',
    region:      item.region      || '',
    lat:         parseFloat(item.lat)  || 0,
    lng:         parseFloat(item.lng)  || 0,
    tag:         item.tag         || 'attraction',
    emoji:       item.emoji       || 'ğŸ“',
    desc:        _cityName + (_attraction ? ' â€” featuring ' + _attraction : '') + ' â€” added via Change Plan',
    description: _cityName + (_attraction ? ' â€” featuring ' + _attraction + '.' : '.') + ' Added during trip planning.',
    activities:  _initActs,
    restaurants: [],
    sleepOptions: [],
    highlights:   _attraction ? [_attraction] : []
  };

  /* Clone stops and insert after afterStopId */
  var newStops = JSON.parse(JSON.stringify(TRIP_STOPS));
  var afterStopId = item.afterStopId ? parseInt(item.afterStopId, 10) : 0;
  var afterStopIdx = afterStopId > 0 ? newStops.findIndex(function(s) { return s.id === afterStopId; }) : -1;
  if (afterStopIdx >= 0) {
    newStops.splice(afterStopIdx + 1, 0, newStop);
  } else {
    newStops.push(newStop);
  }

  /* Find insertion point in TRIP_DAYS â€” after the last day belonging to afterStopId */
  var newDays = JSON.parse(JSON.stringify(TRIP_DAYS));
  var insertAfterDayIdx = newDays.length - 1;
  if (afterStopId > 0) {
    for (var ki = newDays.length - 1; ki >= 0; ki--) {
      if (newDays[ki].stopId === afterStopId) { insertAfterDayIdx = ki; break; }
    }
  }

  /* Build days to insert: drive day + explore days */
  var daysToInsert = [];
  daysToInsert.push({
    stopId: newStopId, driveDay: true, miles: 250, driveHours: 4,
    driver: 'Paul', sleep: newStop.name, sleepType: 'rv_park',
    springBreak: false, phase: newStop.region || newStop.name,
    title: 'Drive to ' + newStop.name
  });
  for (var ni = 0; ni < nights; ni++) {
    daysToInsert.push({
      stopId: newStopId, driveDay: false, miles: 0, driveHours: 0,
      driver: 'Paul', sleep: newStop.name, sleepType: 'rv_park',
      springBreak: false, phase: newStop.region || newStop.name,
      title: (ni === 0 ? 'Explore ' : 'More time in ') + newStop.name,
      activities: []
    });
  }

  /* Splice days in */
  newDays.splice.apply(newDays, [insertAfterDayIdx + 1, 0].concat(daysToInsert));

  /* Renumber + redate from CONFIG.startDate */
  var startMs = new Date(CONFIG.startDate + 'T00:00:00').getTime();
  newDays = newDays.map(function(d, i) {
    var dd = new Date(startMs + i * 86400000);
    var ds = dd.getFullYear() + '-' + String(dd.getMonth() + 1).padStart(2,'0') + '-' + String(dd.getDate()).padStart(2,'0');
    return Object.assign({}, d, { day: i + 1, date: ds });
  });

  /* Persist as custom trip */
  var tripName = (appState.activeTrip === 'custom' && appState.customTripData && appState.customTripData.tripName)
    ? appState.customTripData.tripName
    : (((appState.tripSettings && appState.tripSettings.tripName) || 'My Trip') + ' (Modified)');

  appState.customTripData = {
    tripName:   tripName,
    stops:      newStops,
    days:       newDays,
    startDate:  CONFIG.startDate,
    endDate:    CONFIG.endDate,
    totalDays:  newDays.length,
    totalMiles: CONFIG.totalMiles
  };
  appState.activeTrip = 'custom';

  if (typeof _audit === 'function') _audit('New Stop Added', 'Added ' + newStop.name + ' (' + nights + ' night' + (nights !== 1 ? 's' : '') + ') after stopId ' + afterStopId);

  saveState(appState);
  initApp();

  showToast('âœ… Added ' + newStop.name + ' â€” ' + nights + ' night' + (nights !== 1 ? 's' : '') + '! Trip is now ' + newDays.length + ' days.', 6000);
  if (sourceBtn) { try { sourceBtn.innerHTML = 'âœ… Added!'; sourceBtn.style.background = '#2e7d52'; sourceBtn.disabled = true; } catch(e) {} }
  _adjShowMorePrompt();

  /* If Gemini didn't supply coordinates, geocode via Nominatim and refresh the map */
  if (!newStop.lat || !newStop.lng) {
    var _geoQ = encodeURIComponent(newStop.name + (newStop.state ? ', ' + newStop.state : ''));
    fetch('https://nominatim.openstreetmap.org/search?q=' + _geoQ + '&format=json&limit=1', {
      headers: { 'Accept-Language': 'en' }
    })
    .then(function(r) { return r.json(); })
    .then(function(geo) {
      if (geo && geo[0]) {
        var gLat = parseFloat(geo[0].lat), gLng = parseFloat(geo[0].lon);
        /* Patch the live TRIP_STOPS array so the map can show this stop */
        TRIP_STOPS.forEach(function(s) { if (s.id === newStopId) { s.lat = gLat; s.lng = gLng; } });
        /* Also patch customTripData so the coords persist on next load */
        if (appState.customTripData && appState.customTripData.stops) {
          appState.customTripData.stops.forEach(function(s) { if (s.id === newStopId) { s.lat = gLat; s.lng = gLng; } });
        }
        saveState(appState);
        refreshMainMap();
      }
    })
    .catch(function() { /* map just won't show the new stop â€” silent fail */ });
  }
}

function _adjRefineSuggestions() {
  var ta = document.getElementById('adj-voice-ta');
  var replyInput = document.getElementById('adj-reply-input');
  var replyBar = document.getElementById('adj-reply-bar');
  var reply = replyInput ? replyInput.value.trim() : '';
  if (!reply) { showToast('Type your refinement first!', 2000); return; }
  /* Append the reply as additional context */
  if (ta) {
    ta.value = (ta.value.trim() ? ta.value.trim() + '\n' : '') + 'Additional: ' + reply;
  }
  if (replyInput) replyInput.value = '';
  if (replyBar) replyBar.style.display = 'none';
  _adjGetSuggestions();
}


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   IDEAS / PRODUCT SUGGESTIONS  (writable by all users incl. viewers)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var _ideasMicRecognition = null;
var _ideasCache          = null;  // in-memory cache so re-renders stay fast
var IDEAS_ROW            = 'maass_ideas';

/* â”€â”€ Get or create a stable voter-ID in localStorage â”€â”€ */
function _getVoterId() {
  var k = 'rv_voter_id';
  var v = localStorage.getItem(k);
  if (!v) {
    v = 'v_' + Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
    localStorage.setItem(k, v);
  }
  return v;
}

/* â”€â”€ Load ideas from Supabase (separate row, bypasses _isViewer) â”€â”€ */
function _loadIdeas(cb) {
  if (_ideasCache) { cb(_ideasCache); return; }
  fetch(SUPA_URL + '/rest/v1/' + SUPA_TABLE + '?id=eq.' + IDEAS_ROW + '&select=data', {
    headers: { 'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY }
  })
  .then(function(r) { return r.json(); })
  .then(function(rows) {
    var ideas = [];
    if (rows && rows.length && rows[0].data && rows[0].data.ideas) {
      ideas = rows[0].data.ideas;
    }
    _ideasCache = ideas;
    cb(ideas);
  })
  .catch(function() { cb([]); });
}

/* â”€â”€ Save ideas to Supabase (always â€” even for viewers) â”€â”€ */
function _saveIdeasToCloud(ideas, cb) {
  _ideasCache = ideas;
  var payload = JSON.stringify({ id: IDEAS_ROW, data: { ideas: ideas }, updated_at: new Date().toISOString() });
  fetch(SUPA_URL + '/rest/v1/' + SUPA_TABLE, {
    method: 'POST',
    headers: {
      'apikey': SUPA_KEY, 'Authorization': 'Bearer ' + SUPA_KEY,
      'Content-Type': 'application/json', 'Prefer': 'resolution=merge-duplicates'
    },
    body: payload
  })
  .then(function() { if (cb) cb(true); })
  .catch(function() { if (cb) cb(false); });
}

/* â”€â”€ Mic: start / stop for ideas textarea â”€â”€ */
function _ideasStartMic() {
  var SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRec) { showToast('Speech recognition not supported â€” try Chrome!', 3000); return; }
  var btn = document.getElementById('ideas-mic-btn');
  var ta  = document.getElementById('ideas-ta');
  if (_ideasMicRecognition) {
    _ideasMicRecognition.stop(); _ideasMicRecognition = null;
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.style.background = 'var(--orange)'; }
    return;
  }
  var rec = new SpeechRec();
  rec.continuous = true; rec.interimResults = true; rec.lang = 'en-US';
  _ideasMicRecognition = rec;
  var existing = ta ? ta.value.trim() : '';
  rec.onstart = function() {
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-stop"></i>'; btn.style.background = 'var(--red,#e53935)'; }
  };
  rec.onresult = function(e) {
    var final = existing; var interim = '';
    for (var i = 0; i < e.results.length; i++) {
      if (e.results[i].isFinal) final += (final ? ' ' : '') + e.results[i][0].transcript;
      else interim += e.results[i][0].transcript;
    }
    if (ta) ta.value = final + (interim ? ' ' + interim : '');
    existing = final;
  };
  rec.onerror = rec.onend = function() {
    _ideasMicRecognition = null;
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-microphone"></i>'; btn.style.background = 'var(--orange)'; }
  };
  rec.start();
}

/* â”€â”€ AI polish of the suggestion text â”€â”€ */
function _ideasEnhance() {
  var ta  = document.getElementById('ideas-ta');
  var btn = document.getElementById('ideas-enhance-btn');
  var raw = ta ? ta.value.trim() : '';
  if (!raw) { showToast('Write your idea first, then polish it!', 2000); return; }
  if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; btn.disabled = true; }
  var prompt = 'Polish this product/app idea into a clear, concise 1-3 sentence suggestion. Keep the original intent exactly. Fix grammar, improve clarity. Return only the polished text, no preamble:\n\n"' + raw.replace(/"/g, "'") + '"';
  fetch(GEMINI_URL, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    var polished = d.candidates[0].content.parts[0].text.trim().replace(/^["']|["']$/g,'');
    if (ta) ta.value = polished;
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Polish'; btn.disabled = false; }
    showToast('âœ¨ Polished!', 1800);
  })
  .catch(function() {
    if (btn) { btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i> Polish'; btn.disabled = false; }
    showToast('Could not reach AI â€” try again', 2000);
  });
}

/* â”€â”€ Submit a new idea â”€â”€ */
function _ideasSubmit() {
  var nameEl = document.getElementById('ideas-name');
  var ta     = document.getElementById('ideas-ta');
  var btn    = document.getElementById('ideas-submit-btn');
  var name   = nameEl ? nameEl.value.trim() : '';
  var text   = ta ? ta.value.trim() : '';
  if (!name) { showToast('Please enter your name first!', 2000); if (nameEl) nameEl.focus(); return; }
  if (!text) { showToast('Please write your idea first!', 2000); if (ta) ta.focus(); return; }
  if (_ideasMicRecognition) { _ideasMicRecognition.stop(); _ideasMicRecognition = null; }
  if (btn) { btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Submittingâ€¦'; btn.disabled = true; }
  _loadIdeas(function(ideas) {
    var newIdea = {
      id:         'idea_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
      name:       name,
      text:       text,
      upvotes:    0,
      downvotes:  0,
      voters:     {},
      created_at: new Date().toISOString()
    };
    ideas = [newIdea].concat(ideas);  // newest first
    _saveIdeasToCloud(ideas, function(ok) {
      if (btn) { btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i> Submit Idea'; btn.disabled = false; }
      if (ok) {
        if (ta) ta.value = '';
        /* Auto-fill name next time via localStorage */
        localStorage.setItem('ideas_name', name);
        renderIdeas();
        showToast('ğŸ’¡ Idea submitted â€” thanks, ' + name + '!', 3000);
        /* Show green dot to others */
        var dot = document.getElementById('ideas-new-dot');
        if (dot) dot.style.display = 'block';
      } else {
        showToast('Could not save â€” check your connection', 3000);
      }
    });
  });
}

/* â”€â”€ Upvote / downvote â”€â”€ */
function _ideasVote(ideaId, dir) {
  var voterId = _getVoterId();
  _loadIdeas(function(ideas) {
    var idea = null;
    for (var i = 0; i < ideas.length; i++) { if (ideas[i].id === ideaId) { idea = ideas[i]; break; } }
    if (!idea) return;
    var prev = idea.voters ? idea.voters[voterId] : null;
    if (prev === dir) {
      /* toggle off â€” remove vote */
      delete idea.voters[voterId];
      if (dir === 'up')   idea.upvotes   = Math.max(0, (idea.upvotes   || 0) - 1);
      if (dir === 'down') idea.downvotes = Math.max(0, (idea.downvotes || 0) - 1);
    } else {
      /* switching or new vote */
      if (prev === 'up')   idea.upvotes   = Math.max(0, (idea.upvotes   || 0) - 1);
      if (prev === 'down') idea.downvotes = Math.max(0, (idea.downvotes || 0) - 1);
      if (!idea.voters) idea.voters = {};
      idea.voters[voterId] = dir;
      if (dir === 'up')   idea.upvotes   = (idea.upvotes   || 0) + 1;
      if (dir === 'down') idea.downvotes = (idea.downvotes || 0) + 1;
    }
    _saveIdeasToCloud(ideas, function() { renderIdeas(); });
  });
}

/* â”€â”€ Main render â”€â”€ */
function renderIdeas() {
  var el = document.getElementById('ideas-content');
  if (!el) return;
  var voterId   = _getVoterId();
  var savedName = localStorage.getItem('ideas_name') || _userName || '';

  /* Submit card â€” always writable (even for viewers) */
  var html = '<div style="background:linear-gradient(135deg,#fffde7,#fff9c4);border:1.5px solid #f9e44a;border-radius:var(--radius-s);padding:16px 18px;margin-bottom:22px;">'
    + '<div style="font-weight:900;font-size:1rem;color:#5c4700;margin-bottom:4px;"><i class="fa-solid fa-lightbulb" style="color:#f9a825;"></i> Share an Idea</div>'
    + '<div style="font-size:.8rem;color:#7a6000;margin-bottom:14px;line-height:1.45;">Would love to hear your ideas on what changes or improvements can be made for the Road Trip Planner App! Speak or type your idea â€” everyone can read and vote, and suggestions are saved across updates.</div>'

    /* Name row */
    + '<div style="margin-bottom:10px;">'
    + '<label style="font-size:.75rem;font-weight:800;color:#5c4700;text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px;">Your name</label>'
    + '<input id="ideas-name" type="text" placeholder="e.g. Paul" value="' + savedName.replace(/"/g,'&quot;') + '" style="width:100%;box-sizing:border-box;padding:8px 12px;border:1.5px solid #f0d800;border-radius:100px;font-size:.88rem;font-family:var(--font);background:#fff;color:var(--text);outline:none;">'
    + '</div>'

    /* Text area + mic */
    + '<div style="margin-bottom:10px;">'
    + '<label style="font-size:.75rem;font-weight:800;color:#5c4700;text-transform:uppercase;letter-spacing:.05em;display:block;margin-bottom:4px;">Your idea</label>'
    + '<div style="position:relative;">'
    + '<textarea id="ideas-ta" rows="3" placeholder="e.g. Add a packing list that syncs with the weather forecast for each stopâ€¦" style="width:100%;box-sizing:border-box;min-height:84px;padding:10px 48px 10px 12px;border:1.5px solid #f0d800;border-radius:10px;font-size:.85rem;font-family:var(--font);color:var(--text);background:#fff;resize:vertical;outline:none;line-height:1.5;"></textarea>'
    + '<button id="ideas-mic-btn" onclick="_ideasStartMic()" title="Tap to speak" style="position:absolute;bottom:10px;right:10px;width:34px;height:34px;border-radius:50%;background:var(--orange);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:.9rem;"><i class="fa-solid fa-microphone"></i></button>'
    + '</div>'
    + '</div>'

    /* Buttons row */
    + '<div style="display:flex;gap:8px;">'
    + '<button id="ideas-enhance-btn" onclick="_ideasEnhance()" style="background:#fff;border:1.5px solid #f9a825;color:#8a6200;border-radius:100px;padding:8px 14px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:6px;"><i class="fa-solid fa-wand-magic-sparkles"></i> Polish</button>'
    + '<button id="ideas-submit-btn" onclick="_ideasSubmit()" style="flex:1;background:linear-gradient(135deg,#f9a825,#e65100);color:#fff;border:none;border-radius:100px;padding:8px 18px;font-size:.88rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;justify-content:center;gap:7px;"><i class="fa-solid fa-paper-plane"></i> Submit Idea</button>'
    + '</div>'
    + '</div>';

  /* Feed header */
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-comments"></i> All Ideas</h2>'
    + '<button onclick="_ideasCache=null;renderIdeas();" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;padding:5px 10px;font-size:.75rem;cursor:pointer;font-family:var(--font);color:var(--text-2);"><i class="fa-solid fa-rotate-right"></i> Refresh</button>'
    + '</div>';

  el.innerHTML = html + '<div id="ideas-feed" style="display:flex;flex-direction:column;gap:10px;">'
    + '<div style="text-align:center;padding:24px;color:var(--text-3);"><i class="fa-solid fa-spinner fa-spin"></i> Loading ideasâ€¦</div>'
    + '</div>';

  /* Async: load + render feed */
  _ideasCache = null;  // always fresh on explicit render
  _loadIdeas(function(ideas) {
    var feed = document.getElementById('ideas-feed');
    if (!feed) return;
    if (!ideas.length) {
      feed.innerHTML = '<div style="text-align:center;padding:32px 20px;color:var(--text-3);">'
        + '<div style="font-size:2.2rem;margin-bottom:10px;">ğŸ’¡</div>'
        + '<div style="font-weight:700;font-size:.95rem;margin-bottom:5px;">No ideas yet</div>'
        + '<div style="font-size:.82rem;">Be the first to share a suggestion above!</div>'
        + '</div>';
      return;
    }
    var fHtml = '';
    ideas.forEach(function(idea) {
      var myVote   = idea.voters ? idea.voters[voterId] : null;
      var upCount  = idea.upvotes   || 0;
      var downCount= idea.downvotes || 0;
      var score    = upCount - downCount;
      var dateStr  = idea.created_at ? new Date(idea.created_at).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}) : '';
      var upStyle  = 'background:' + (myVote==='up'   ? 'var(--green)'            : 'var(--green-l,#e8f5e9)')  + ';color:' + (myVote==='up'   ? '#fff' : 'var(--green)')  + ';border:1.5px solid var(--green);border-radius:100px;padding:5px 12px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:5px;';
      var downStyle= 'background:' + (myVote==='down' ? 'var(--red,#e53935)'      : '#fce4ec')                  + ';color:' + (myVote==='down' ? '#fff' : 'var(--red,#e53935)') + ';border:1.5px solid var(--red,#e53935);border-radius:100px;padding:5px 12px;font-size:.8rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:5px;';
      var scoreColor = score > 0 ? 'var(--green)' : score < 0 ? 'var(--red,#e53935)' : 'var(--text-3)';
      fHtml += '<div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius-s);padding:14px 16px;">'
        + '<div style="display:flex;align-items:flex-start;gap:10px;">'
        /* Vote column */
        + '<div style="display:flex;flex-direction:column;align-items:center;gap:4px;flex-shrink:0;padding-top:2px;">'
        + '<button style="' + upStyle + '" onclick="_ideasVote(\'' + idea.id + '\',\'up\')"><i class="fa-solid fa-thumbs-up"></i> ' + upCount + '</button>'
        + '<button style="' + downStyle + '" onclick="_ideasVote(\'' + idea.id + '\',\'down\')"><i class="fa-solid fa-thumbs-down"></i> ' + downCount + '</button>'
        + '</div>'
        /* Content */
        + '<div style="flex:1;min-width:0;">'
        + '<div style="font-size:.88rem;color:var(--text);line-height:1.6;margin-bottom:7px;">' + idea.text + '</div>'
        + '<div style="font-size:.75rem;color:var(--text-3);display:flex;align-items:center;gap:8px;flex-wrap:wrap;">'
        + '<span><i class="fa-solid fa-user"></i> <strong style="color:var(--text-2);">' + idea.name + '</strong></span>'
        + (dateStr ? '<span>&middot; ' + dateStr + '</span>' : '')
        + '<span style="margin-left:auto;font-weight:800;color:' + scoreColor + ';">' + (score > 0 ? '+' : '') + score + ' net</span>'
        + '</div>'
        + '</div>'
        + '</div></div>';
    });
    feed.innerHTML = fHtml;
  });
}

function renderDecisions() {
  var el = document.getElementById('decisions-content');
  if (!el) return;
  var decisions = appState.decisions || [];
  var pauseDays = appState.pauseDays || [];

  /* â”€â”€ Schedule Variance Banner â”€â”€ */
  var vari = computeTripVariance();
  var variBanner = '';
  if (vari.type === 'pretrip') {
    variBanner = '<div style="background:var(--blue-l);border:1px solid var(--border);border-left:4px solid var(--blue);border-radius:var(--radius-s);padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;">'
      + '<span style="font-size:1.4rem;">ğŸ“…</span><div>'
      + '<div style="font-weight:800;font-size:.88rem;color:var(--blue);margin-bottom:2px;">Trip starts in ' + vari.days + ' day' + (vari.days !== 1 ? 's' : '') + '</div>'
      + '<div style="font-size:.8rem;color:var(--text-2);">Planned start: ' + CONFIG.startDate + ' &rarr; End: ' + CONFIG.endDate + '</div>'
      + '</div></div>';
  } else if (vari.type === 'ontrip') {
    var endStr = vari.shiftedEnd.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
    var varColor = vari.daysDelta > 0 ? 'var(--red)' : 'var(--green)';
    var varBg    = vari.daysDelta > 0 ? '#fde8e8' : '#e8f5e9';
    var varBorder= vari.daysDelta > 0 ? 'var(--red)' : 'var(--green)';
    var varText  = vari.daysDelta > 0
      ? 'âš ï¸ ' + vari.daysDelta + ' day' + (vari.daysDelta !== 1 ? 's' : '') + ' over schedule due to ' + vari.pauseNights + ' pause-day night' + (vari.pauseNights !== 1 ? 's' : '') + '. Trip now ends ' + endStr + '.'
      : vari.daysDelta < 0
        ? 'âœ… ' + Math.abs(vari.daysDelta) + ' days ahead â€” trip could end ' + endStr + '.'
        : 'âœ… On schedule â€” trip end ' + endStr + '.';
    variBanner = '<div style="background:' + varBg + ';border:2px solid ' + varBorder + ';border-radius:var(--radius-s);padding:16px;margin-bottom:16px;">'
      + (vari.daysDelta > 0
        ? '<div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;">'
          + '<div style="background:var(--red);color:#fff;border-radius:12px;padding:8px 16px;font-size:1.6rem;font-weight:900;white-space:nowrap;">+' + vari.daysDelta + ' day' + (vari.daysDelta !== 1 ? 's' : '') + '</div>'
          + '<div><div style="font-weight:900;font-size:.95rem;color:var(--red);">Over Schedule</div>'
          + '<div style="font-size:.8rem;color:var(--text-2);">Your trip now ends ' + (endStr || 'TBD') + '</div></div>'
          + '</div>'
          + '<div style="font-size:.82rem;color:var(--text);line-height:1.55;margin-bottom:8px;">' + varText.replace(/^âš ï¸ /, '') + '</div>'
          + '<div style="font-size:.8rem;font-weight:700;color:var(--text-2);margin-bottom:6px;">Ways to get back on track:</div>'
          + '<div style="display:flex;flex-direction:column;gap:6px;">'
          + '<div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:.8rem;"><strong>âœ‚ï¸ Shorten a stop</strong> â€” Cut 1 night from a 3+ night stop</div>'
          + '<div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:.8rem;"><strong>ğŸï¸ Remove a stop</strong> â€” Drive through instead of staying</div>'
          + '<div style="background:#fff;border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:.8rem;"><strong>ğŸ¤– Ask TripGenie</strong> â€” Get personalized suggestions below</div>'
          + '</div>'
        : '<div style="font-size:.84rem;font-weight:700;color:' + varColor + ';line-height:1.5;">' + varText + '</div>')
      + '<div style="font-size:.76rem;color:var(--text-2);margin-top:8px;">Day ' + vari.plannedDay + ' of ' + vari.totalDays + ' planned</div>'
      + '</div>';
  }

  /* TripGenie section â€” show when trip is over schedule due to pauses */
  var genieSection = '';
  if (vari.type === 'ontrip' && vari.daysDelta > 0) {
    var _cached = appState.tripGenieAdvice || '';
    var _genieLoading = appState.tripGenieLoading;
    genieSection = '<div style="background:linear-gradient(135deg,#f3e5f5,#ede7f6);border:1px solid #ce93d8;border-left:4px solid #9c27b0;border-radius:var(--radius-s);padding:14px 16px;margin-bottom:16px;">'
      + '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;margin-bottom:8px;">'
      + '<div>'
      + '<div style="font-weight:900;font-size:.9rem;color:#6a1b9a;margin-bottom:2px;display:flex;align-items:center;gap:6px;"><i class="fa-solid fa-wand-magic-sparkles"></i><i class="fa-solid fa-lightbulb"></i> TripGenie â€” Compression Ideas</div>'
      + '<div style="font-size:.76rem;color:#7b1fa2;">Your trip is <strong>' + vari.daysDelta + ' day' + (vari.daysDelta !== 1 ? 's' : '') + '</strong> over schedule. Here\'s how to get back on track:</div>'
      + '</div>'
      + (function() {
          var _cnt = _cached ? _parseGenieItems(_cached).length : 0;
          var _lbl = _genieLoading
            ? 'â³ Thinkingâ€¦'
            : (_cached
              ? '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i> <span style="background:rgba(255,255,255,.3);border-radius:100px;padding:1px 8px;font-size:.72rem;font-weight:900;margin-left:2px;">' + _cnt + '</span>'
              : '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i> Get Ideas');
          return '<button onclick="getTripGenieSuggestions()" style="background:#9c27b0;color:#fff;border:none;border-radius:100px;padding:8px 18px;font-size:.82rem;font-weight:700;cursor:pointer;font-family:var(--font);flex-shrink:0;display:flex;align-items:center;gap:5px;">' + _lbl + '</button>';
        }())
      + '</div>'
      + (function() {
          if (!_cached) {
            return _genieLoading ? '' : '<div style="font-size:.78rem;color:#7b1fa2;opacity:.8;">Tap "Ask TripGenie" for personalized suggestions on trimming ' + vari.daysDelta + ' day' + (vari.daysDelta !== 1 ? 's' : '') + ' without losing the highlights.</div>';
          }
          // Parse into discrete action cards
          _genieItems = _parseGenieItems(_cached);
          if (_genieItems.length > 0) {
            return _renderGenieCards(_genieItems, '#4a148c', 'rgba(255,255,255,.75)', '#e1bee7');
          }
          // Fallback: raw text
          return '<div style="font-size:.81rem;color:#4a148c;line-height:1.65;border-top:1px solid #ce93d8;padding-top:10px;margin-top:4px;">' + _cached + '</div>';
        }())
      + '</div>';
  }

  var html = variBanner + genieSection;
  html += '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">'
    + '<h2 class="section-title" style="margin:0;"><i class="fa-solid fa-triangle-exclamation" style="color:var(--red);"></i> Decisions Needed</h2>'
    + '<button onclick="openPauseDayModal()" style="background:var(--red);color:#fff;border:none;border-radius:100px;padding:7px 14px;font-size:.82rem;font-weight:800;cursor:pointer;font-family:var(--font);display:flex;align-items:center;gap:6px;"><i class="fa-solid fa-plane-departure"></i> Add Trip Pause</button>'
    + '</div>';

  /* â”€â”€ Pause Days section â”€â”€ */
  if (pauseDays.length) {
    html += '<div style="font-weight:700;font-size:.8rem;color:var(--red);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;display:flex;align-items:center;gap:6px;"><i class="fa-solid fa-plane-departure"></i> Trip Pauses</div>'
      + '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">';
    for (var pdi = 0; pdi < pauseDays.length; pdi++) {
      html += _pauseDayCard(pauseDays[pdi]);
    }
    html += '</div>';
  }

  /* â”€â”€ Drive split decisions â”€â”€ */
  var pending   = decisions.filter(function(s) { return s.status === 'pending'; });
  var resolved  = decisions.filter(function(s) { return s.status !== 'pending'; });

  if (!decisions.length && !pauseDays.length) {
    html += '<div style="text-align:center;padding:36px 20px;color:var(--text-3);">'
      + '<div style="font-size:2.5rem;margin-bottom:12px;color:var(--text-3);"><i class="fa-solid fa-circle-check"></i></div>'
      + '<div style="font-weight:700;font-size:.95rem;margin-bottom:6px;">No open decisions</div>'
      + '<div style="font-size:.82rem;line-height:1.5;">Drive split plans and pause days will appear here when you add them. Use the button above to add a flight break, or flag long drives in the Schedule tab.</div>'
      + '</div>';
  } else {
    if (pending.length) {
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-2);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;display:flex;align-items:center;gap:6px;"><i class="fa-solid fa-car-side"></i> Drive Splits â€” Needs Resolution</div>'
        + '<div style="display:flex;flex-direction:column;gap:10px;margin-bottom:24px;">';
      for (var ddi = 0; ddi < pending.length; ddi++) html += _decisionCard(pending[ddi]);
      html += '</div>';
    }
    if (resolved.length) {
      html += '<div style="font-weight:700;font-size:.8rem;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">Resolved</div>'
        + '<div style="display:flex;flex-direction:column;gap:8px;">';
      for (var rdi = 0; rdi < resolved.length; rdi++) html += _decisionCard(resolved[rdi]);
      html += '</div>';
    }
  }
  el.innerHTML = html;
}

function getPauseGenieSuggestions(pauseId) {
  var pd = (appState.pauseDays || []).find(function(p) { return p.id === pauseId; });
  if (!pd) return;
  var key = GEMINI_KEY || (CONFIG && CONFIG.geminiKey) || '';
  if (!key) { showToast('No Gemini key configured', 2000); return; }
  var nights = (pd.startDate && pd.endDate)
    ? Math.max(0, Math.round((new Date(pd.endDate+'T00:00:00') - new Date(pd.startDate+'T00:00:00')) / 86400000))
    : 0;
  appState.pauseGenieLoading = pauseId;
  renderDecisions();
  var stops = TRIP_DAYS.reduce(function(acc, d) {
    if (d.phase && acc.indexOf(d.phase) === -1) acc.push(d.phase);
    return acc;
  }, []).join(', ');
  var prompt = 'I am on a ' + TRIP_DAYS.length + '-day RV road trip visiting: ' + stops + '. I added a trip pause of ' + nights + ' night(s) to fly to ' + (pd.destination || 'a destination') + ' (dates: ' + (pd.startDate||'?') + ' to ' + (pd.endDate||'?') + '). This has added ' + nights + ' extra day(s) to my trip. Give me exactly ' + nights + ' to ' + (nights+1) + ' specific, practical suggestions for how to shorten the RV trip to absorb these extra days â€” naming specific stops, which nights to cut, and what you\'d still keep. Format as a numbered list. Be direct and concrete. Under 200 words.';
  fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + key, {
    method: 'POST', headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = (data.candidates&&data.candidates[0]&&data.candidates[0].content&&data.candidates[0].content.parts&&data.candidates[0].content.parts[0]) ? data.candidates[0].content.parts[0].text : '';
    appState.pauseGenieLoading = null;
    if (!appState.pauseGenieAdvice) appState.pauseGenieAdvice = {};
    appState.pauseGenieAdvice[pauseId] = text.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
    saveState(appState); renderDecisions();
    showToast('ğŸ¤– TripGenie has ideas!', 2000);
  })
  .catch(function() {
    appState.pauseGenieLoading = null;
    renderDecisions();
    showToast('TripGenie unavailable', 2000);
  });
}

function _pauseDayCard(pd) {
  var nights = '';
  if (pd.startDate && pd.endDate) {
    var ms = new Date(pd.endDate + 'T12:00:00') - new Date(pd.startDate + 'T12:00:00');
    var n = Math.max(0, Math.round(ms / 86400000));
    nights = n + ' night' + (n !== 1 ? 's' : '');
  }
  var h = '<div style="background:var(--card);border:1.5px solid var(--red);border-left:4px solid var(--red);border-radius:var(--radius-s);padding:14px 16px;">'
    + '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">'
    + '<div style="flex:1;">'
    + '<div style="font-weight:900;font-size:.92rem;margin-bottom:5px;"><i class="fa-solid fa-plane-departure"></i> ' + (pd.destination || 'Flight Break') + '</div>'
    + '<div style="font-size:.82rem;color:var(--text-2);line-height:1.55;margin-bottom:8px;">'
    + (pd.fromCity ? '<strong>Departing:</strong> ' + pd.fromCity + '<br>' : '')
    + (pd.startDate ? '<strong>Dates:</strong> ' + pd.startDate + (pd.endDate ? ' â†’ ' + pd.endDate : '') + (nights ? ' (' + nights + ')' : '') + '<br>' : '')
    + (pd.layoverCity ? '<strong>Layover:</strong> ' + pd.layoverCity + '<br>' : '')
    + (pd.flightOut ? '<strong>Outbound:</strong> ' + pd.flightOut + (pd.flightRet ? '  |  <strong>Return:</strong> ' + pd.flightRet : '') + '<br>' : (pd.flightRet ? '<strong>Return:</strong> ' + pd.flightRet + '<br>' : ''))
    + (pd.notes ? '<em>' + pd.notes + '</em>' : '')
    + '</div>'
    + '<div style="display:flex;gap:6px;flex-wrap:wrap;">'
    + (nights ? '<span style="background:#fde8e8;color:var(--red);font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:100px;">âš¡ ' + nights + ' off-trip</span>' : '')
    + '</div>'
    + '</div>'
    + '<div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">'
    + '<button onclick="editPauseDay(\'' + pd.id + '\')" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;font-family:var(--font);font-size:.75rem;padding:5px 10px;cursor:pointer;color:var(--text-2);">âœï¸ Edit</button>'
    + '<button onclick="deletePauseDay(\'' + pd.id + '\')" style="background:#fde8e8;border:1px solid var(--red);border-radius:100px;font-family:var(--font);font-size:.75rem;padding:5px 10px;cursor:pointer;color:var(--red);">âœ• Remove</button>'
    + '</div>'
    + '</div>'
    /* â”€â”€ Inline TripGenie compression ideas per pause â”€â”€ */
    + (function() {
        var cached = appState.pauseGenieAdvice && appState.pauseGenieAdvice[pd.id];
        var loading = appState.pauseGenieLoading === pd.id;
        return '<div style="border-top:1px solid #ffcdd2;padding:10px 14px 4px;background:linear-gradient(135deg,#fce4ec,#fdf2f8);border-radius:0 0 var(--radius-s) var(--radius-s);">'
          + '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:' + (cached ? '8px' : '0') + ';">'
          + '<div style="font-size:.73rem;font-weight:800;color:#880e4f;display:flex;align-items:center;gap:5px;"><i class="fa-solid fa-wand-magic-sparkles"></i><i class="fa-solid fa-lightbulb"></i> TripGenie â€” How to reclaim ' + (nights || 'lost') + '</div>'
          + (function() {
              var _pcnt = cached ? _parseGenieItems(cached).length : 0;
              var _plbl = loading
                ? 'â³â€¦'
                : (cached
                  ? '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i> <span style="background:rgba(255,255,255,.3);border-radius:100px;padding:1px 7px;font-size:.68rem;font-weight:900;margin-left:1px;">' + _pcnt + '</span>'
                  : '<i class="fa-solid fa-wand-magic-sparkles"></i> <i class="fa-solid fa-lightbulb"></i>');
              return '<button onclick="getPauseGenieSuggestions(\'' + pd.id + '\')" style="background:#ad1457;color:#fff;border:none;border-radius:100px;padding:4px 10px;font-size:.7rem;font-weight:800;cursor:pointer;font-family:var(--font);flex-shrink:0;display:flex;align-items:center;gap:4px;">' + _plbl + '</button>';
            }())
          + '</div>'
          + (function() {
              if (!cached) return '';
              // Parse into discrete action cards
              _pauseGenieItems[pd.id] = _parseGenieItems(cached);
              if (_pauseGenieItems[pd.id].length > 0) {
                var pItems = _pauseGenieItems[pd.id];
                var pHtml = '<div style="display:flex;flex-direction:column;gap:7px;margin-top:4px;">';
                pItems.forEach(function(item, idx) {
                  pHtml += '<div style="background:rgba(255,255,255,.7);border:1px solid #f48fb1;border-radius:12px;padding:10px 12px;">'
                    + '<div style="font-size:.79rem;color:#4a0027;line-height:1.55;margin-bottom:7px;"><strong>' + item.num + '.</strong> ' + item.text + '</div>'
                    + '<button id="pgenie-btn-' + pd.id + '-' + idx + '" onclick="_applyPauseGenieItem(\'' + pd.id + '\',' + idx + ')" style="background:#ad1457;color:#fff;border:none;border-radius:100px;padding:5px 12px;font-size:.73rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœ“ Make This Change</button>'
                    + '</div>';
                });
                return pHtml + '</div>';
              }
              return '<div style="font-size:.78rem;color:#4a0027;line-height:1.6;padding-bottom:8px;">' + cached + '</div>';
            }())
          + '</div>';
      }())
    + '</div>';
  return h;
}

function _decisionCard(s) {
  var col = s.status === 'resolved' ? 'var(--green)' : s.status === 'dismissed' ? '#bbb' : 'var(--red)';
  var h = '<div style="background:var(--card);border:1px solid var(--border);border-left:3px solid ' + col + ';border-radius:var(--radius-s);padding:14px 16px;">'
    + '<div style="display:flex;align-items:flex-start;justify-content:space-between;gap:10px;">'
    + '<div style="flex:1;"><div style="font-weight:800;font-size:.9rem;margin-bottom:4px;">' + (s.title||'') + '</div>';
  if (s.detail) h += '<div style="font-size:.82rem;color:var(--text-2);line-height:1.5;margin-bottom:6px;">' + s.detail + '</div>';
  h += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
  if (s.impact) h += '<span style="background:var(--orange-l);color:var(--orange);font-size:.72rem;font-weight:700;padding:2px 8px;border-radius:100px;">âš¡ ' + s.impact + '</span>';
  if (s.affectedDays && s.affectedDays.length) h += '<span style="background:var(--blue-l);color:var(--blue);font-size:.72rem;padding:2px 8px;border-radius:100px;">Days ' + s.affectedDays.join(', ') + '</span>';
  h += '</div></div>';
  if (s.status === 'pending') {
    if (s.isSplitDrive) {
      h += '<div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">'
        + '<button onclick="resolveDecision(\'' + s.id + '\')" style="background:var(--orange);color:#fff;border:none;border-radius:100px;font-family:var(--font);font-size:.75rem;font-weight:800;padding:7px 11px;cursor:pointer;white-space:nowrap;">âœ‚ï¸ Split the Drive</button>'
        + '<button onclick="dismissSplitDecision(\'' + s.id + '\')" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;font-family:var(--font);font-size:.75rem;padding:6px 10px;cursor:pointer;color:var(--text-2);white-space:nowrap;">ğŸ’ª Drive It All</button>'
        + '</div>';
    } else {
      h += '<div style="display:flex;flex-direction:column;gap:6px;flex-shrink:0;">'
        + '<button onclick="resolveDecision(\'' + s.id + '\')" style="background:var(--green);color:#fff;border:none;border-radius:100px;font-family:var(--font);font-size:.75rem;font-weight:800;padding:6px 10px;cursor:pointer;">âœ“ Make Change</button>'
        + '<button onclick="dismissDecision(\'' + s.id + '\')" style="background:var(--bg);border:1px solid var(--border);border-radius:100px;font-family:var(--font);font-size:.75rem;padding:6px 10px;cursor:pointer;color:var(--text-2);">Skip</button>'
        + '</div>';
    }
  } else if (s.status === 'resolved') {
    h += '<div style="font-size:.75rem;color:var(--green);font-weight:800;flex-shrink:0;">' + (s.isSplitDrive ? 'âœ‚ï¸ Split Applied' : 'âœ“ Done') + '</div>';
  } else {
    h += '<div style="font-size:.75rem;color:var(--text-3);flex-shrink:0;">' + (s.isSplitDrive ? 'ğŸ’ª Driving It All' : 'Skipped') + '</div>';
  }
  return h + '</div></div>';
}

function getTripGenieSuggestions() {
  var vari = computeTripVariance();
  if (!vari || vari.daysDelta <= 0) { showToast('Trip is on schedule â€” no compression needed!', 2000); return; }
  var key = GEMINI_KEY || (CONFIG && CONFIG.geminiKey) || '';
  if (!key) { showToast('No Gemini key configured', 2000); return; }
  appState.tripGenieLoading = true;
  renderDecisions();
  var pauseSummary = (appState.pauseDays || []).map(function(pd) {
    var n = (pd.startDate && pd.endDate) ? Math.max(0, Math.round((new Date(pd.endDate+'T00:00:00') - new Date(pd.startDate+'T00:00:00')) / 86400000)) : 0;
    return (pd.destination || 'Flight break') + ' (' + n + ' nights, ' + pd.startDate + 'â€“' + pd.endDate + ')';
  }).join('; ');
  var stops = TRIP_DAYS.reduce(function(acc, d) {
    if (d.phase && acc.indexOf(d.phase) === -1) acc.push(d.phase);
    return acc;
  }, []).join(', ');
  var prompt = 'I am on a ' + TRIP_DAYS.length + '-day RV trip visiting: ' + stops + '. I have added ' + vari.pauseNights + ' off-trip pause night(s) for: ' + pauseSummary + '. This has pushed my trip ' + vari.daysDelta + ' day(s) over the original planned end date. Give me exactly ' + vari.daysDelta + ' to ' + (vari.daysDelta + 2) + ' specific, actionable suggestions to compress the trip and get back within the original timeframe. For each suggestion, name the specific stop, how many nights to cut, and what you would NOT miss. Format as a numbered list. Be concrete and practical. Keep it under 250 words.';
  fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=' + key, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
  })
  .then(function(r) { return r.json(); })
  .then(function(data) {
    var text = (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) ? data.candidates[0].content.parts[0].text : '';
    appState.tripGenieLoading = false;
    appState.tripGenieAdvice = text.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br>');
    saveState(appState);
    renderDecisions();
    showToast('ğŸ¤– TripGenie has suggestions!', 2500);
  })
  .catch(function() {
    appState.tripGenieLoading = false;
    renderDecisions();
    showToast('TripGenie unavailable â€” check connection', 2500);
  });
}

function resolveDecision(id) {
  var decisions = appState.decisions || [];
  for (var i = 0; i < decisions.length; i++) {
    if (decisions[i].id === id) {
      decisions[i].status = 'resolved';
      /* If this is a drive split decision, record the override to suppress the warning */
      if (decisions[i].isSplitDrive && decisions[i].driveDay) {
        if (!appState.dayOverrides) appState.dayOverrides = {};
        if (!appState.dayOverrides[decisions[i].driveDay]) appState.dayOverrides[decisions[i].driveDay] = {};
        appState.dayOverrides[decisions[i].driveDay].splitResolved = true;
        var _origD = getDay(decisions[i].driveDay);
        if (_origD) appState.dayOverrides[decisions[i].driveDay].splitHours = Math.round(_origD.driveHours / 2 * 10) / 10;
      }
      break;
    }
  }
  saveState(appState); renderDecisions(); renderSchedule(); updateDecisionsBadge();
  showToast('âœ‚ï¸ Drive split applied â€” schedule updated!', 2500);
}

/* Dismiss a split-drive decision AND suppress the warning banner in the day modal */
function dismissSplitDecision(id) {
  var decisions = appState.decisions || [];
  var dayNum = null;
  for (var i = 0; i < decisions.length; i++) {
    if (decisions[i].id === id) {
      decisions[i].status = 'dismissed';
      dayNum = decisions[i].driveDay || null;
      break;
    }
  }
  // Suppress the orange warning banner so it doesn't keep nagging
  if (dayNum) {
    if (!appState.dayOverrides) appState.dayOverrides = {};
    if (!appState.dayOverrides[dayNum]) appState.dayOverrides[dayNum] = {};
    appState.dayOverrides[dayNum].splitResolved = true;
  }
  saveState(appState); renderDecisions(); updateDecisionsBadge();
  showToast('ğŸ’ª Got it â€” driving the full distance!', 2000);
}

function dismissDecision(id) {
  var decisions = appState.decisions || [];
  for (var i = 0; i < decisions.length; i++) {
    if (decisions[i].id === id) { decisions[i].status = 'dismissed'; break; }
  }
  saveState(appState); renderDecisions(); updateDecisionsBadge();
  showToast('Decision skipped', 1600);
}

function updateDecisionsBadge() {
  var pendingD = (appState.decisions || []).filter(function(s) { return s.status === 'pending'; }).length;
  var pendingP = (appState.pauseDays || []).length;
  var total = pendingD + pendingP;
  var navBtn = document.getElementById('decisions-nav-tab');
  if (!navBtn) return;
  var badge = navBtn.querySelector('.decisions-badge');
  if (total > 0) {
    if (!badge) {
      badge = document.createElement('span');
      badge.className = 'decisions-badge';
      badge.style.cssText = 'background:var(--red);color:#fff;font-size:.6rem;font-weight:900;padding:1px 5px;border-radius:100px;margin-left:4px;vertical-align:middle;';
      navBtn.appendChild(badge);
    }
    badge.textContent = total;
  } else {
    if (badge) badge.remove();
  }
}

/* â”€â”€ PAUSE DAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

var _editingPauseDayId = null;

function openPauseDayModal(editId) {
  _editingPauseDayId = editId || null;
  var modal = document.getElementById('pause-day-modal');
  if (!modal) return;
  // Reset fields
  var fields = ['pd-destination','pd-from','pd-start','pd-end','pd-layover','pd-flight-out','pd-flight-ret','pd-notes'];
  fields.forEach(function(f) { var el = document.getElementById(f); if (el) el.value = ''; });
  // If editing, prefill
  if (editId) {
    var existing = (appState.pauseDays || []).find(function(p) { return p.id === editId; });
    if (existing) {
      if (document.getElementById('pd-destination')) document.getElementById('pd-destination').value = existing.destination || '';
      if (document.getElementById('pd-from'))        document.getElementById('pd-from').value        = existing.fromCity   || '';
      if (document.getElementById('pd-start'))       document.getElementById('pd-start').value       = existing.startDate  || '';
      if (document.getElementById('pd-end'))         document.getElementById('pd-end').value         = existing.endDate    || '';
      if (document.getElementById('pd-layover'))     document.getElementById('pd-layover').value     = existing.layoverCity|| '';
      if (document.getElementById('pd-flight-out'))  document.getElementById('pd-flight-out').value  = existing.flightOut  || '';
      if (document.getElementById('pd-flight-ret'))  document.getElementById('pd-flight-ret').value  = existing.flightRet  || '';
      if (document.getElementById('pd-notes'))       document.getElementById('pd-notes').value       = existing.notes      || '';
    }
  }
  modal.classList.remove('hidden');
}

function closePauseDayModal() {
  var modal = document.getElementById('pause-day-modal');
  if (modal) modal.classList.add('hidden');
  _editingPauseDayId = null;
}

function savePauseDay() {
  var dest     = (document.getElementById('pd-destination') || {}).value || '';
  var fromCity = (document.getElementById('pd-from')        || {}).value || '';
  var startD   = (document.getElementById('pd-start')       || {}).value || '';
  var endD     = (document.getElementById('pd-end')         || {}).value || '';
  var layover  = (document.getElementById('pd-layover')     || {}).value || '';
  var flightOut= (document.getElementById('pd-flight-out')  || {}).value || '';
  var flightRet= (document.getElementById('pd-flight-ret')  || {}).value || '';
  var notes    = (document.getElementById('pd-notes')       || {}).value || '';

  if (!dest) { showToast('Please enter a destination.', 2000); return; }

  if (!appState.pauseDays) appState.pauseDays = [];

  if (_editingPauseDayId) {
    /* update existing */
    for (var i = 0; i < appState.pauseDays.length; i++) {
      if (appState.pauseDays[i].id === _editingPauseDayId) {
        appState.pauseDays[i].destination = dest;
        appState.pauseDays[i].fromCity    = fromCity;
        appState.pauseDays[i].startDate   = startD;
        appState.pauseDays[i].endDate     = endD;
        appState.pauseDays[i].layoverCity = layover;
        appState.pauseDays[i].flightOut   = flightOut;
        appState.pauseDays[i].flightRet   = flightRet;
        appState.pauseDays[i].notes       = notes;
        break;
      }
    }
    showToast('âœˆï¸ Trip pause updated!', 2400);
  } else {
    /* new entry */
    appState.pauseDays.push({
      id:          'pause-' + Date.now(),
      destination: dest,
      fromCity:    fromCity,
      startDate:   startD,
      endDate:     endD,
      layoverCity: layover,
      flightOut:   flightOut,
      flightRet:   flightRet,
      notes:       notes
    });
    showToast('âœˆï¸ Trip pause added!', 2800);
  }
  saveState(appState);
  closePauseDayModal();
  renderDecisions();
  updateDecisionsBadge();
  switchTab('decisions');
}

function editPauseDay(id) {
  openPauseDayModal(id);
}

function deletePauseDay(id) {
  if (!appState.pauseDays) return;
  appState.pauseDays = appState.pauseDays.filter(function(p) { return p.id !== id; });
  saveState(appState);
  renderDecisions();
  updateDecisionsBadge();
  showToast('Pause day removed', 1800);
}

function manualGenerateSuggestions() {
  var daySel  = document.getElementById('adj-day-sel');
  var modeSel = document.getElementById('adj-mode-sel');
  var dayNum  = daySel  ? parseInt(daySel.value)  : 1;
  var hoursAdj= modeSel ? parseFloat(modeSel.value) : 0;
  var d    = getDay(dayNum);
  var stop = d ? getStop(d.stopId) : null;
  var btn  = document.getElementById('adj-gen-btn');
  if (btn) { btn.textContent = '&#129302; Asking TripGenie\u2026'; btn.disabled = true; }
  geminiAdjustSchedule(dayNum, hoursAdj >= 0 ? 'arrive' : 'depart', stop, hoursAdj);
  setTimeout(function() {
    if (btn) { btn.innerHTML = '&#129302; Generate'; btn.disabled = false; }
  }, 8000);
}

/* â”€â”€ JOURNAL AI CLEANUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function cleanupJournalEntry(id) {
  var entry = null;
  for (var ci = 0; ci < _journalEntries.length; ci++) {
    if (_journalEntries[ci].id === id) { entry = _journalEntries[ci]; break; }
  }
  if (!entry || !entry.text) { showToast('No text to clean up', 2000); return; }
  var btn = document.getElementById('jclean-' + id);
  if (btn) { btn.textContent = '\u23f3'; btn.disabled = true; }

  var prompt = 'Clean up this family travel journal entry. Fix grammar, spelling, and flow, '
    + 'but preserve the author\'s voice, personality, humor, and any funny kid quotes. '
    + 'Keep approximately the same length. Return ONLY the cleaned text:\n\n' + entry.text;

  var body = JSON.stringify({
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: { maxOutputTokens: 600, temperature: 0.5 }
  });

  fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: body })
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var cleaned = '';
      try { cleaned = data.candidates[0].content.parts[0].text.trim(); } catch(e) {}
      if (!cleaned) { showToast('AI cleanup failed', 2000); if (btn) { btn.textContent = '\u{1F916} Clean up'; btn.disabled = false; } return; }
      for (var ci2 = 0; ci2 < _journalEntries.length; ci2++) {
        if (_journalEntries[ci2].id === id) { _journalEntries[ci2].text = cleaned; break; }
      }
      saveJournal();
      renderJournalEntries();
      showToast('\uD83D\uDCDD Entry polished by AI!', 2200);
    })
    .catch(function() {
      showToast('AI cleanup error', 2000);
      if (btn) { btn.textContent = '\u{1F916} Clean up'; btn.disabled = false; }
    });
}



/* â”€â”€ GUIDED TOUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _tutorialSteps = [
  {
    title: 'ğŸ‘‹ Welcome to Maass Family RV 2026!',
    body:  'This quick tour walks you through the key features. You\'ll be on the road in no time! Tap <strong>Next</strong> to continue or <strong>Skip Tour</strong> to jump straight in.',
    target: null,
    position: 'center'
  },
  {
    title: 'ğŸ—ºï¸ Dashboard',
    body:  'Your home base. See today\'s day, miles, drive time, and tonight\'s sleep spot. New stat cards track photos, postcards, and license plates found. The <strong>Start Trip</strong> button lives here too.',
    target: '[data-tab="dashboard"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ“… Schedule',
    body:  'View all 46 days organized by trip phase. Tap any day to open its detail â€” you\'ll see drive time, sleep type, a packing list, and AI suggestions. Long drives get a split recommendation.',
    target: '[data-tab="schedule"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ“ Trip Stops',
    body:  'Browse all 14 destinations with activities, restaurants, sleep options, and live weather. Tap <strong>Forecast</strong> on any stop to load current temps. Hit <strong>+ Plan</strong> to mark things you want to do.',
    target: '[data-tab="stops"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ—ºï¸ Map',
    body:  'See your full 7,000-mile route across the US. Blue dots = outbound, orange = return. Tap a stop pin for details. Switch to full-screen from the Dashboard\'s Route Overview card.',
    target: '[data-tab="map"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ“– Journal',
    body:  'Log daily memories, photos, and notes. Each entry tracks the author and day. Use the <strong>AI Clean Up</strong> button to polish your writing. Photos also appear in the Gallery tab.',
    target: '[data-tab="journal"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ–¼ï¸ Gallery',
    body:  'All your trip photos in one place, pulled from journal entries. Tap any photo to view it full-size. Add photos in the Journal tab.',
    target: '[data-tab="gallery"]',
    position: 'bottom'
  },
  {
    title: 'âœ‰ï¸ Postcards',
    body:  'Pick a photo, choose a destination, and let AI write a postcard from your journal entries. Then save or download it to share with family and friends.',
    target: '[data-tab="postcards"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ® Games',
    body:  'Road trip games for the whole family â€” I Spy, Mad Libs, License Plate Hunt, Trivia, and more. Includes AI-powered games that generate questions based on your current location.',
    target: '[data-tab="fun"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ¤– TripGenie â€” Your AI Co-Pilot',
    body:  'Tap the <strong>âœ¨ Ask TripGenie</strong> button in the top-left header to ask anything: "What should we do in Moab?", "Plan our day at Bryce Canyon", or "What\'s good for a 4-year-old here?"',
    target: '#tg-btn',
    position: 'bottom'
  },
  {
    title: 'ğŸ› ï¸ Tools',
    body:  'The Tools tab has everything else: expenses, RV maintenance log, memory book, family profiles, audit log, AI skip preferences, and trip settings. <strong>What\'s New</strong> shows the latest features.',
    target: '[data-tab="tools"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ‘¤ Profiles & Personalization',
    body:  'Under <strong>Tools â†’ Profiles</strong>, set each family member\'s age and interests. The AI will tailor suggestions â€” if Leila\'s logged in, it looks for acting/theater connections. If Luna\'s logged in, it finds Sonic references!',
    target: '[data-tab="tools"]',
    position: 'bottom'
  },
  {
    title: 'ğŸš« Skip Preferences',
    body:  'Under <strong>Tools â†’ Trip Settings</strong>, scroll to <em>AI Preferences â€” Things to Skip</em>. Check off heights, large crowds, strenuous hikes, or anything else you\'d rather avoid. The AI will filter those out of all recommendations.',
    target: '[data-tab="tools"]',
    position: 'bottom'
  },
  {
    title: 'ğŸ‰ You\'re all set!',
    body:  'That\'s the full tour! You can relaunch this tutorial anytime from <strong>Tools â†’ What\'s New â†’ Rerun Tutorial</strong>. Have an amazing trip! ğŸš',
    target: null,
    position: 'center'
  }
];

var _tutorialActive  = false;
var _tutorialStep    = 0;
var _tutorialOverlay = null;
var _tutorialHighlight = null;

function startTutorial() {
  if (appState.tutorialDone && !arguments[0]) return; // skip if already done, unless forced
  _tutorialActive = true;
  _tutorialStep   = 0;
  _buildTutorialOverlay();
  _showTutorialStep();
}

function _buildTutorialOverlay() {
  var old = document.getElementById('tutorial-overlay');
  if (old) old.remove();

  var ov = document.createElement('div');
  ov.id = 'tutorial-overlay';
  ov.style.cssText = 'position:fixed;inset:0;z-index:9000;pointer-events:none;';
  ov.innerHTML = '<div id="tutorial-bg" style="position:absolute;inset:0;background:rgba(0,0,0,.0);pointer-events:all;"></div>'
    + '<div id="tutorial-spotlight" style="position:fixed;box-shadow:0 0 0 9999px rgba(0,0,0,.6);border-radius:10px;pointer-events:none;transition:left .3s,top .3s,width .3s,height .3s;z-index:1;display:none;"></div>'
    + '<div id="tutorial-card" style="position:fixed;background:#fff;border-radius:16px;padding:20px 22px;max-width:320px;width:calc(100vw - 32px);box-shadow:0 12px 40px rgba(0,0,0,.35);pointer-events:all;z-index:9002;transition:top .3s,left .3s;">'
    + '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">'
    + '<div id="tutorial-step-count" style="font-size:.7rem;font-weight:800;color:#999;text-transform:uppercase;letter-spacing:.06em;"></div>'
    + '<button onclick="skipTutorial()" style="background:none;border:none;font-size:.75rem;color:#bbb;cursor:pointer;font-family:inherit;padding:2px 6px;border-radius:100px;white-space:nowrap;">âœ• Exit Tour</button>'
    + '</div>'
    + '<div id="tutorial-title" style="font-size:1rem;font-weight:900;color:#1a1a2e;margin-bottom:7px;line-height:1.3;"></div>'
    + '<div id="tutorial-body" style="font-size:.83rem;color:#555;line-height:1.6;margin-bottom:16px;"></div>'
    + '<div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">'
    + '<div id="tutorial-dots" style="display:flex;gap:4px;flex:1;flex-wrap:wrap;"></div>'
    + '<div style="display:flex;gap:8px;flex-shrink:0;">'
    + '<button id="tutorial-prev" onclick="tutorialPrev()" style="background:#f0f0f0;border:none;border-radius:100px;padding:8px 14px;font-size:.8rem;font-weight:700;cursor:pointer;font-family:inherit;color:#555;display:none;">â† Back</button>'
    + '<button id="tutorial-next" onclick="tutorialNext()" style="background:linear-gradient(135deg,#E8813A,#d4611e);color:#fff;border:none;border-radius:100px;padding:8px 16px;font-size:.83rem;font-weight:800;cursor:pointer;font-family:inherit;">Next â†’</button>'
    + '</div></div>'
    + '</div>';
  document.body.appendChild(ov);
  _tutorialOverlay = ov;

  // Tap/click anywhere on background asks to exit
  function _askExit(e) {
    e.preventDefault();
    if (confirm('Exit the tutorial?')) skipTutorial();
  }
  var bg = document.getElementById('tutorial-bg');
  bg.addEventListener('click', _askExit);
  bg.addEventListener('touchend', _askExit, { passive: false });

  // Also re-position card on window resize / orientation change
  window.addEventListener('resize', _onTutorialResize);
}

function _onTutorialResize() {
  if (_tutorialActive) _showTutorialStep();
}

function _showTutorialStep() {
  if (!_tutorialActive) return;
  var step   = _tutorialSteps[_tutorialStep];
  var card   = document.getElementById('tutorial-card');
  var spot   = document.getElementById('tutorial-spotlight');
  var titleEl = document.getElementById('tutorial-title');
  var bodyEl  = document.getElementById('tutorial-body');
  var countEl = document.getElementById('tutorial-step-count');
  var nextBtn = document.getElementById('tutorial-next');
  var prevBtn = document.getElementById('tutorial-prev');
  var dotsEl  = document.getElementById('tutorial-dots');
  if (!card) return;

  titleEl.innerHTML = step.title;
  bodyEl.innerHTML  = step.body;
  countEl.textContent = 'Step ' + (_tutorialStep + 1) + ' of ' + _tutorialSteps.length;

  // Dots
  dotsEl.innerHTML = '';
  for (var di = 0; di < _tutorialSteps.length; di++) {
    var dot = document.createElement('div');
    dot.style.cssText = 'width:6px;height:6px;border-radius:50%;flex-shrink:0;background:' + (di === _tutorialStep ? '#E8813A' : '#ddd') + ';';
    dotsEl.appendChild(dot);
  }

  prevBtn.style.display = _tutorialStep > 0 ? 'block' : 'none';
  nextBtn.textContent   = _tutorialStep === _tutorialSteps.length - 1 ? 'ğŸ‰ Done!' : 'Next â†’';

  // Try to find target element; if not found treat as null
  var targetEl = (step.target && document.querySelector(step.target)) || null;

  function _doPosition() {
    if (targetEl) {
      // Scroll target into view so getBoundingClientRect() returns in-viewport coords
      try { targetEl.scrollIntoView({ behavior: 'instant', block: 'nearest', inline: 'nearest' }); } catch(e) {}
      var rect = targetEl.getBoundingClientRect();
      var pad  = 6;
      spot.style.display  = 'block';
      spot.style.left     = (rect.left - pad) + 'px';
      spot.style.top      = (rect.top  - pad) + 'px';
      spot.style.width    = (rect.width  + pad * 2) + 'px';
      spot.style.height   = (rect.height + pad * 2) + 'px';
      _positionCardNearTarget(card, rect);
    } else {
      spot.style.display = 'none';
      _centerCard(card);
    }
  }

  // Give browser a frame to settle after any scrollIntoView
  requestAnimationFrame(_doPosition);
}

function _centerCard(card) {
  var vw = window.innerWidth;
  var vh = window.innerHeight;
  var cw = Math.min(320, vw - 32);
  card.style.transform = 'none';
  card.style.width  = cw + 'px';
  card.style.left   = Math.max(16, (vw - cw) / 2) + 'px';
  card.style.top    = Math.max(20, vh / 2 - 160) + 'px';
}

function _positionCardNearTarget(card, rect) {
  var vw   = window.innerWidth;
  var vh   = window.innerHeight;
  var cw   = Math.min(320, vw - 32);
  var pad  = 14;
  card.style.transform = 'none';
  card.style.width = cw + 'px';

  // Measure card height after setting width
  card.style.visibility = 'hidden';
  var ch = card.offsetHeight || 240;
  card.style.visibility = '';

  var top, left;
  // Try below target first, then above, then center vertically
  if (rect.bottom + ch + pad <= vh) {
    top = rect.bottom + pad;
  } else if (rect.top - ch - pad >= 0) {
    top = rect.top - ch - pad;
  } else {
    top = Math.max(16, Math.min(rect.top, vh - ch - 16));
  }

  // Align card horizontally centered on target, but clamped within viewport
  left = rect.left + rect.width / 2 - cw / 2;
  left = Math.max(16, Math.min(left, vw - cw - 16));

  // Final clamp: ensure top is always inside viewport
  top = Math.max(16, Math.min(top, vh - ch - 16));

  card.style.top  = top + 'px';
  card.style.left = left + 'px';
}

function tutorialNext() {
  if (_tutorialStep >= _tutorialSteps.length - 1) {
    endTutorial();
    return;
  }
  _tutorialStep++;
  _showTutorialStep();
}

function tutorialPrev() {
  if (_tutorialStep > 0) { _tutorialStep--; _showTutorialStep(); }
}

function skipTutorial() {
  endTutorial();
}

function endTutorial() {
  _tutorialActive = false;
  window.removeEventListener('resize', _onTutorialResize);
  var ov = document.getElementById('tutorial-overlay');
  if (ov) ov.remove();
  appState.tutorialDone = true;
  saveState();
  showToast('&#128218; Tutorial complete! Find it again under Tools â†’ What\'s New.', 3000);
}

function rerunTutorial() {
  appState.tutorialDone = false;
  startTutorial(true);
}

/* â”€â”€ PER-PAGE CONTEXTUAL HELP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
var _PAGE_HELP = {
  dashboard: [
    { title: 'ğŸ“Š Dashboard Overview',  target: '[data-tab="dashboard"]', body: 'This is your trip command center. The blue header card shows today\'s date, miles, drive time, and tonight\'s sleep spot. All your key trip stats are shown as tiles below.' },
    { title: 'ğŸšŒ Starting Your Trip',   target: '#dashboard-content',     body: 'When you\'re ready to go, tap the orange <strong>Start Trip</strong> button in the blue Day card header. This activates live progress tracking, miles driven, and "Days on the Road" counting.' },
    { title: 'â¬†ï¸ Up Next',             target: '#dashboard-content',     body: 'The three cards directly below the Day card show your next upcoming days. Tap any one to open that day\'s full detail â€” drive info, sleep type, packing list, and AI suggestions.' },
    { title: 'ğŸ“Š Stat Tiles',          target: '#dashboard-content',     body: 'Tiles are clickable! Tap <strong>Photos Taken</strong> to jump to Journal, <strong>Postcards</strong> to the postcard builder, <strong>License Plates</strong> to Games. The ğŸŒ§ï¸ tile has a <strong>Load Data</strong> button to fetch precipitation totals.' },
    { title: 'ğŸ—ºï¸ States Visited',      target: '#dashboard-content',     body: 'Counts unique states reached so far based on your current day. The sub-label lists each state abbreviation.' },
    { title: 'ğŸŒ¡ï¸ High & Low Temps',    target: '#dashboard-content',     body: 'Shows the hottest and coldest days across your entire trip once weather is loaded. Go to Trip Stops and tap <strong>ğŸŒ¡ï¸ Forecast</strong> on each stop to load weather data.' },
    { title: 'ğŸ—ºï¸ Route Overview',      target: '#mini-map-container',    body: 'The mini map shows your full 7,000-mile route. Tap <strong>Full Map</strong> to expand it, or switch to the Map tab in the nav bar.' }
  ],
  schedule: [
    { title: 'ğŸ“… Schedule',            target: '[data-tab="schedule"]',  body: 'All 46 days are grouped by trip phase. Each phase card shows the region, date range, drive stats, and weather. Expand a phase to see individual days.' },
    { title: 'ğŸ“… Opening a Day',       target: '#schedule-content',      body: 'Tap any day row to open its full detail. You\'ll see drive hours, sleep type, a packing checklist, a daily itinerary, and AI-powered suggestions for that stop.' },
    { title: 'ğŸ“ Area Info Button',    target: '#schedule-content',      body: 'Each phase header has an <strong>ğŸ“ Area Info</strong> button. Tap it for an AI-generated local guide: history, fun facts, food picks, kid-friendly tips, and personalized suggestions for whoever\'s logged in.' },
    { title: 'ğŸµ Local Music',         target: '#schedule-content',      body: 'In the day detail modal, tap the <strong>ğŸµ</strong> button in the orange header row to get AI-suggested local artists and genres. Links open directly in Spotify.' },
    { title: 'ğŸš— Drive Split',         target: '#schedule-content',      body: 'Drive days over your max-hours limit show a yellow banner. Tap <strong>Add to Decisions</strong> to create a split â€” e.g. drive half on Day 38 evening, finish on Day 39 morning.' },
    { title: 'ğŸŒ¤ï¸ Phase Weather',       target: '#schedule-content',      body: 'Phase headers show a weather chip (icon + high/low) for the first day of that phase, from historical climate data. Load live data via Trip Stops â†’ Forecast.' },
    { title: 'âœï¸ Day Notes',           target: '#schedule-content',      body: 'Inside any day detail, scroll to the Notes section to add your own notes. They save to the cloud automatically.' }
  ],
  stops: [
    { title: 'ğŸ“ Trip Stops',          target: '[data-tab="stops"]',     body: 'All 14 destinations are listed here. Each card shows the stop name, date range, nights, and weather. The <strong>HERE NOW</strong> badge marks your current location when live.' },
    { title: 'ğŸ“‚ Expanding a Stop',    target: '#stops-content',         body: 'Tap any stop header to expand it. You\'ll see a description, highlight tags, activities, restaurants, sleep options, and quick-links to weather and Google Maps.' },
    { title: 'ğŸ¯ Activities',          target: '#stops-content',         body: 'Each activity shows a type badge, toddler-OK indicator, and kid rating (e.g. 4â˜…). Tap the card for full details, or tap <strong>+ Plan</strong> to mark it as planned.' },
    { title: 'ğŸ½ï¸ Restaurants',        target: '#stops-content',         body: 'Restaurant cards show rating, price tier, hours, and address. Tap <strong>+ Plan</strong> to add to your list. Planned items show a green âœ… badge on the collapsed header.' },
    { title: 'ğŸŒ¡ï¸ Stop Weather',        target: '#stops-content',         body: 'Each stop shows a temp range if weather is loaded. Tap the <strong>ğŸŒ¡ï¸ Forecast</strong> button to fetch historical temps from Open-Meteo for exactly your stay dates.' },
    { title: 'ğŸ“… Events Near Here',    target: '#stops-content',         body: 'Inside an expanded stop, tap <strong>ğŸ“… Events Near Here</strong> to find local concerts, festivals, and family events happening during your stay.' }
  ],
  map: [
    { title: 'ğŸ—ºï¸ Route Map',          target: '[data-tab="map"]',       body: 'Your full 7,000-mile route across the US. Blue line = outbound. Orange line = return. Numbered pins mark each of your 14 destinations.' },
    { title: 'ğŸ“ Stop Pins',           target: '#main-map',              body: 'Tap any numbered pin to see the stop name, state, emoji, and a quick link to the stop\'s detail. The current location pulses orange.' },
    { title: 'ğŸ” Zoom & Pan',          target: '#main-map',              body: 'Pinch to zoom, drag to pan, double-tap to zoom in. The map starts centered on the full US route.' }
  ],
  journal: [
    { title: 'ğŸ“– Journal',             target: '[data-tab="journal"]',   body: 'Log memories, photos, and notes for each day. Entries are sorted by date and show the author, location, and a photo strip.' },
    { title: 'âœï¸ Adding an Entry',     target: '#journal-content',       body: 'The compose form at the top of this page is always ready. Pick the day and author, write your notes, then tap <strong>Save Entry</strong>. Your name is pre-filled from your profile.' },
    { title: 'ğŸ“· Adding Photos',       target: '#journal-content',       body: 'Inside an entry, tap the photo area to upload images from your device. They\'re stored per entry and appear in the Gallery tab automatically.' },
    { title: 'ğŸ¤– AI Clean Up',         target: '#journal-content',       body: 'Tap <strong>ğŸ¤– Clean up</strong> on any entry to have AI polish the writing â€” better grammar, vivid details, improved flow. Review the result before saving.' },
    { title: 'ğŸ–Šï¸ Edit & Delete',       target: '#journal-content',       body: 'Tap the pencil icon to edit any entry, or the trash icon to delete it. Changes sync to the cloud immediately.' }
  ],
  gallery: [
    { title: 'ğŸ–¼ï¸ Gallery',             target: '[data-tab="gallery"]',   body: 'All photos from your journal entries appear here in a 3-column grid, grouped by location. Add photos in the Journal tab and they show up here automatically.' },
    { title: 'ğŸ” Tapping a Photo',     target: '#gallery-tab-content',   body: 'Tap any photo to view it full-size in a lightbox. Use the arrows or swipe to browse between photos. Tap X or the background to close.' },
    { title: 'ğŸ“· How to Add Photos',   target: '[data-tab="journal"]',   body: 'Go to the Journal tab, open or create an entry, and tap the photo upload area. New photos appear here in Gallery automatically.' }
  ],
  postcards: [
    { title: 'âœ‰ï¸ Postcard Builder',    target: '[data-tab="postcards"]', body: 'âš ï¸ Under construction! Pick a journal photo, choose a destination, and let AI write a postcard message. Then generate and download it.' },
    { title: 'ğŸ“· Choosing Photos',     target: '#postcards-content',     body: 'Scroll the photo strip at the top and tap up to 3 journal photos. Selected photos get a blue checkmark and appear on the left side of the postcard.' },
    { title: 'ğŸ“ Location & Message',  target: '#postcards-content',     body: 'Pick a destination from the dropdown, then tap <strong>Write my postcard from our journal entries</strong> â€” AI drafts a message based on your recent journal notes.' },
    { title: 'ğŸ’¾ Download & Save',     target: '#postcards-content',     body: 'After generating, tap <strong>Download</strong> to save the image. Saved postcards increment your Postcards count on the Dashboard.' }
  ],
  games: [
    { title: 'ğŸ® Road Trip Games',     target: '[data-tab="games"]',     body: 'Games for the whole family â€” quick car games, classics, and AI-powered games that use your current location for custom questions and challenges.' },
    { title: 'ğŸ² Suggested Game',      target: '#fun-sub-content',       body: 'The banner at the top suggests the best game for right now â€” a car game on drive days, or an explore activity on rest days. Tap <strong>Play â–¶</strong> to jump in.' },
    { title: 'â–¶ï¸ Playing a Game',      target: '#fun-sub-content',       body: 'Tap any game card to open it. Each game shows player count, age range, and how long it takes. Tap <strong>How to Play</strong> for rules, or <strong>Play Now</strong> for interactive games.' },
    { title: 'ğŸ¤– AI Games',            target: '#fun-sub-content',       body: 'Cards labeled <strong>AI</strong> use TripGenie to generate fresh questions from your current location â€” trivia, story prompts, challenges. Every play is different!' },
    { title: 'ğŸš— License Plate Hunt',  target: '#fun-sub-content',       body: 'Spot state license plates on the road and tap to mark them found. Your running total appears on the Dashboard as <strong>License Plates</strong>.' }
  ],
  decisions: [
    { title: 'ğŸ”´ Decisions',            target: '[data-tab="decisions"]', body: 'Decisions are issues that need your input â€” long drives to split, trip variance alerts, and TripGenie suggestions. Each card shows the problem and the recommended action.' },
    { title: 'ğŸš— Drive Split Cards',    target: '#decisions-content',     body: 'If a driving day is over your comfort limit, a red card appears here. Tap <strong>Accept Split Plan</strong> to break it into two shorter drives automatically.' },
    { title: 'ğŸ“… Trip Variance',        target: '#decisions-content',     body: 'If pause days or scheduling changes push the trip over its planned end date, a purple card shows how many days over you are. Tap <strong>âœ¨ Ask TripGenie</strong> for personalized suggestions to trim the trip.' },
    { title: 'âœ… Resolving Decisions',  target: '#decisions-content',     body: 'Once you act on a decision, tap <strong>Dismiss</strong> or <strong>Resolve</strong> to archive it. Resolved decisions are kept in a log at the bottom of this page.' }
  ],
  lists: [
    { title: 'ğŸ“‹ Packing Lists',        target: '[data-tab="lists"]',     body: 'Packing checklists organized by category â€” kids, clothing, kitchen, tech, and more. Check off items as you pack. Progress is saved automatically.' },
    { title: 'âœ”ï¸ Checking Items',       target: '#lists-content',         body: 'Tap any item to toggle it checked/unchecked. A progress bar at the top shows how packed-up you are. Completed categories collapse for a clean view.' },
    { title: 'â• Custom Items',         target: '#lists-content',         body: 'Tap <strong>+ Add Item</strong> at the bottom of any category to add your own items. Custom items are saved per category and persist between sessions.' }
  ],
  school: [
    { title: 'ğŸ“š Road School',          target: '[data-tab="school"]',    body: 'Learning activities tied to where you are on the trip â€” science, history, geography, and more. Content adapts to ages 2, 4, and 9.' },
    { title: 'ğŸ—ºï¸ Location-Based',      target: '#school-content',        body: 'Activities are curated for your current stop â€” so in the Pacific Northwest you\'ll find volcano science and salmon ecology, not Florida reef content.' },
    { title: 'ğŸ¯ Age Levels',           target: '#school-content',        body: 'Each activity includes a difficulty tag. Luna\'s section has toddler-friendly sensory activities; Leila\'s has deeper reading and writing prompts; Jax gets in-between.' }
  ],
  adjustments: [
    { title: 'âš™ï¸ Trip Adjustments',    target: '[data-tab="adjustments"]', body: 'Make changes to the planned trip â€” add pause days, modify stop durations, and customize daily schedules. Changes flow through to the Schedule and Dashboard automatically.' },
    { title: 'âœˆï¸ Pause Days',          target: '#adjustments-content',   body: 'Use <strong>+ Add Pause</strong> to insert off-trip days â€” flights home, family breaks, etc. Pause days are shown in the Schedule and counted in the Trip Variance.' },
    { title: 'ğŸ•ï¸ Stop Changes',        target: '#adjustments-content',   body: 'You can extend or shorten any stop using the night-count controls. The schedule will update across all affected days.' }
  ],
  suggestions: [
    { title: 'ğŸ’¡ AI Suggestions',       target: '[data-tab="suggestions"]', body: 'TripGenie\'s proactive recommendations â€” things to add, things to skip, and alerts based on your current stop and preferences.' },
    { title: 'ğŸ¯ Personalized Picks',   target: '#suggestions-content',   body: 'Suggestions are filtered by your skip preferences (no heights, caves, etc.) and adapted to whoever is logged in â€” Leila\'s theater interests, Luna\'s Sonic love, Jax\'s nature picks.' },
    { title: 'ğŸ“Œ Acting on Tips',       target: '#suggestions-content',   body: 'Tap <strong>+ Plan</strong> on any suggestion to add it directly to your planned activities. Tap <strong>Skip</strong> to dismiss it and not see it again.' }
  ],
  tools: [
    { title: 'ğŸ› ï¸ Tools',               target: '[data-tab="tools"]',     body: 'The Tools tab holds utilities that don\'t need their own nav tab. Use the sub-tabs at the top to switch between sections.' },
    { title: 'âœ¨ What\'s New',          target: '#tools-sub-content',     body: 'Start here! See the latest features organized by release. Tap <strong>â–¶ Start Tour</strong> to rerun the full walkthrough tutorial.' },
    { title: 'ğŸ’° Expenses',            target: '#tools-sub-content',     body: 'Track trip spending by category â€” fuel, food, activities, and more. Running totals are shown per category with a grand total.' },
    { title: 'ğŸ‘¤ Profiles',            target: '#tools-sub-content',     body: 'Set up name, age, emoji, and interests per family member. When Leila\'s logged in, AI looks for theater/acting connections. When Luna\'s logged in, it finds Sonic references!' },
    { title: 'ğŸš« Skip Preferences',    target: '#tools-sub-content',     body: 'Under Trip Settings, check off things to avoid â€” heights, crowds, strenuous hikes, caves, etc. All AI recommendations filter these out automatically.' },
    { title: 'ğŸ“‹ Audit Log',           target: '#tools-sub-content',     body: 'A timestamped history of every significant change â€” destinations added, decisions resolved, prefs saved. Color-coded by action type.' }
  ]
};

function openPageTutorial() {
  // Figure out which tab is active
  var activeTab = 'dashboard';
  var navTabs = document.querySelectorAll('.nav-tab');
  for (var i = 0; i < navTabs.length; i++) {
    if (navTabs[i].classList.contains('active')) {
      activeTab = navTabs[i].getAttribute('data-tab') || 'dashboard';
      break;
    }
  }
  // Map data-tab values that don't match _PAGE_HELP keys
  var _tabAliases = { 'fun': 'games' };
  var helpKey = _tabAliases[activeTab] || activeTab;
  var steps = _PAGE_HELP[helpKey] || _PAGE_HELP['dashboard'];

  // Build a mini-tutorial with just these steps (no global appState.tutorialDone flag)
  var old = document.getElementById('tutorial-overlay');
  if (old) old.remove();
  window.removeEventListener('resize', _onTutorialResize);

  _tutorialActive = true;
  _tutorialStep   = 0;

  // Temporarily swap the step list
  var _savedSteps = _tutorialSteps;
  _tutorialSteps = steps.map(function(s) { return { title: s.title, body: s.body, target: s.target || null }; });

  _buildTutorialOverlay();
  _showTutorialStep();

  // When this mini-tutorial ends, restore the main steps and do NOT set tutorialDone
  var _origEnd = endTutorial;
  endTutorial = function() {
    _tutorialActive = false;
    window.removeEventListener('resize', _onTutorialResize);
    var ov = document.getElementById('tutorial-overlay');
    if (ov) ov.remove();
    _tutorialSteps = _savedSteps;
    endTutorial = _origEnd;
    showToast('â“ Tip: tap <strong>â“ Help</strong> anytime for page-specific guidance.', 3000);
  };
}

// Called from initApp() after login completes â€” NOT on page load
function _maybeLaunchTutorial() {
  if (!appState.tutorialDone && !_isViewer) {
    setTimeout(startTutorial, 1200);
  }
}

/* â”€â”€ DARK MODE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function _initDarkMode() {
  var pref = appState.darkMode; // 'dark', 'light', or undefined (auto)
  if (pref === 'dark') {
    document.body.classList.add('dark-mode');
    document.body.classList.remove('light-mode');
    _updateDarkBtn(true);
  } else if (pref === 'light') {
    document.body.classList.add('light-mode');
    document.body.classList.remove('dark-mode');
    _updateDarkBtn(false);
  } else {
    // Auto â€” follow system preference; update button based on what the system chose
    var sysDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    _updateDarkBtn(sysDark);
  }
}

function _updateDarkBtn(isDark) {
  var btn = document.getElementById('dark-mode-btn');
  if (btn) btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
}

function toggleDarkMode() {
  var isDark = document.body.classList.contains('dark-mode')
    || (!document.body.classList.contains('light-mode') && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches);
  if (isDark) {
    // Switch to light
    document.body.classList.remove('dark-mode');
    document.body.classList.add('light-mode');
    appState.darkMode = 'light';
    _updateDarkBtn(false);
  } else {
    // Switch to dark
    document.body.classList.add('dark-mode');
    document.body.classList.remove('light-mode');
    appState.darkMode = 'dark';
    _updateDarkBtn(true);
  }
  saveState(appState);
}

// Listen for system preference changes
if (window.matchMedia) {
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', function(e) {
    if (!appState.darkMode || appState.darkMode === 'auto') {
      _updateDarkBtn(e.matches);
    }
  });
}


// â•â• SIMPLE MODE â€” self-contained module â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
;(function(){
  // Only run init when SM is activated, not on page load
  var _smReady = false;


/* â”€â”€ NAV STATE â”€â”€ */
var _activeScreen = 's-today';
var _activeNav    = 'nav-today';
var _navStack     = [];  /* history stack for back button */

function _smSeg(which) {
  var schDiv = document.getElementById('sm-schedule-content');
  var stpDiv = document.getElementById('sm-stops-content');
  var btnSch = document.getElementById('seg-btn-schedule');
  var btnStp = document.getElementById('seg-btn-stops');
  if (!schDiv || !stpDiv) return;
  if (which === 'schedule') {
    schDiv.style.display = 'block';
    stpDiv.style.display = 'none';
    if (btnSch) { btnSch.classList.add('active'); }
    if (btnStp) { btnStp.classList.remove('active'); }
  } else {
    schDiv.style.display = 'none';
    stpDiv.style.display = 'block';
    if (btnSch) { btnSch.classList.remove('active'); }
    if (btnStp) { btnStp.classList.add('active'); }
    renderStops();
  }
}

function switchNav(screenId, navId, title) {
  /* If going to a deep screen, clear the back stack */
  if (_activeScreen !== screenId) {
    _navStack = [];
    _showScreen(screenId, false);
  }
  /* Update nav buttons */
  document.querySelectorAll('.nav-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById(navId).classList.add('active');
  _activeNav = navId;

  /* If navigating to the planner screen, reset to days view if not already in stops */
  if (screenId === 's-schedule') {
    var _segSchDiv = document.getElementById('sm-schedule-content');
    var _segStpDiv = document.getElementById('sm-stops-content');
    if (_segSchDiv && _segStpDiv && _segStpDiv.style.display !== 'block') {
      _segSchDiv.style.display = 'block';
      _segStpDiv.style.display = 'none';
      var _segBtnSch = document.getElementById('seg-btn-schedule');
      var _segBtnStp = document.getElementById('seg-btn-stops');
      if (_segBtnSch) _segBtnSch.classList.add('active');
      if (_segBtnStp) _segBtnStp.classList.remove('active');
    }
  }

  /* Update top bar */
  document.getElementById('top-title').textContent = 'Maass Family RV 2026';
  document.getElementById('back-btn').classList.remove('show');
  document.getElementById('top-action').classList.add('show');
  document.getElementById('top-action').textContent = 'âœ¨ Ask';
}

function goTo(screenId, title, subtitle, fromNav) {
  _navStack.push({ screen: _activeScreen, title: document.getElementById('top-title').textContent });
  _showScreen(screenId, true);

  /* Update top bar */
  document.getElementById('top-title').textContent = title || '';
  document.getElementById('back-btn').classList.add('show');
  document.getElementById('top-action').classList.remove('show');
}

function goBack() {
  if (_navStack.length === 0) return;
  var prev = _navStack.pop();
  _showScreen(prev.screen, false);
  document.getElementById('top-title').textContent = prev.title || 'Maass Family RV 2026';
  if (_navStack.length === 0) {
    document.getElementById('back-btn').classList.remove('show');
    document.getElementById('top-action').classList.add('show');
  }
}

function _showScreen(screenId, isForward) {
  var old = document.getElementById(_activeScreen);
  var nw  = document.getElementById(screenId);
  if (!nw || old === nw) return;

  if (isForward) {
    nw.style.transform = 'translateX(100%)';
    old.classList.add('exit-left');
  } else {
    nw.style.transform = 'translateX(-40%)';
    old.classList.remove('exit-left');
    old.classList.remove('active');
    old.style.transform = 'translateX(100%)';
  }

  requestAnimationFrame(function() {
    nw.classList.add('active');
    nw.style.transform = '';
    if (isForward) {
      setTimeout(function() { old.classList.remove('active', 'exit-left'); }, 320);
    }
  });

  _activeScreen = screenId;
  /* Scroll new screen to top */
  setTimeout(function() { nw.scrollTop = 0; }, 50);
}

function handleTopAction() {
  showGenieDemoToast();
}

/* â”€â”€ TOAST â”€â”€ */
var _toastTimer;
function _smToast(msg, dur) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  t.style.transform = 'translateX(-50%) translateY(0)';
  clearTimeout(_toastTimer);
  _toastTimer = setTimeout(function() {
    t.style.opacity = '0';
    t.style.transform = 'translateX(-50%) translateY(20px)';
  }, dur || 2500);
}

function showGenieDemoToast() {
  var msgs = [
    'âœ¨ TripGenie is thinkingâ€¦',
    'âœ¨ "Great question! Mesa Verde hasâ€¦"',
    'âœ¨ Opening TripGenieâ€¦',
    'âœ¨ This would open the full TripGenie in the real app',
  ];
  _smToast(msgs[Math.floor(Math.random() * msgs.length)], 2800);
}

/* â”€â”€ ACTIVITY PLAN (Stop Detail) â”€â”€ */
var _plannedActivities = {};

function toggleActivity(el, name) {
  if (el.classList.contains('added')) {
    el.classList.remove('added');
    delete _plannedActivities[name];
    _smToast('Removed from plan', 1800);
  } else {
    el.classList.add('added');
    _plannedActivities[name] = true;
    _smToast('âœ“ Added to your plan!', 2000);
  }
  _updateStopPlan();
}

function removeFromPlan(name) {
  delete _plannedActivities[name];
  document.querySelectorAll('.act-tag').forEach(function(tag) {
    if (tag.dataset.activity === name) tag.classList.remove('added');
  });
  _updateStopPlan();
  _smToast('Removed from plan', 1800);
}

function _updateStopPlan() {
  var section = document.getElementById('stop-plan-section');
  var list    = document.getElementById('stop-plan-list');
  var countEl = document.getElementById('stop-plan-count');
  var keys    = Object.keys(_plannedActivities);
  if (!section) return;

  countEl.textContent = keys.length;

  if (keys.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  list.innerHTML = keys.map(function(k) {
    return '<div class="plan-row">'
      + '<i class="fa-solid fa-check-circle" style="color:var(--green);font-size:1rem;flex-shrink:0;"></i>'
      + '<div style="flex:1;">' + k + '</div>'
      + '<button onclick="removeFromPlan(\'' + k.replace(/'/g, "\\'") + '\')" '
      + 'style="background:none;border:none;color:var(--text-3);cursor:pointer;font-size:.8rem;padding:4px 6px;border-radius:6px;" '
      + 'title="Remove">âœ•</button>'
      + '</div>';
  }).join('');
}

/* â”€â”€ DYNAMIC RENDERERS â”€â”€ */

/* Helper: format a date string "YYYY-MM-DD" â†’ "Mon Mar 27" */
function _smFmtDate(ds) {
  if (!ds) return '';
  var d = new Date(ds + 'T12:00:00');
  return d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
}
function _smFmtDateShort(ds) {
  if (!ds) return '';
  var d = new Date(ds + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
}
function _smMonDay(ds) {
  if (!ds) return { d:'', mo:'' };
  var d = new Date(ds + 'T12:00:00');
  return { d: d.getDate(), mo: d.toLocaleDateString('en-US',{month:'short'}) };
}

/* Find today's day index (0-based) in TRIP_DAYS by matching date string */
function _smTodayIdx() {
  var today = new Date();
  var ts = today.getFullYear() + '-'
    + String(today.getMonth()+1).padStart(2,'0') + '-'
    + String(today.getDate()).padStart(2,'0');
  var idx = (typeof TRIP_DAYS !== 'undefined' ? TRIP_DAYS : []).findIndex(function(d){ return d.date === ts; });
  /* If before trip, return 0; if after trip, return last day */
  if (idx === -1) {
    var days = typeof TRIP_DAYS !== 'undefined' ? TRIP_DAYS : [];
    if (!days.length) return 0;
    if (ts < days[0].date) return 0;
    return days.length - 1;
  }
  return idx;
}

function _smRenderToday() {
  var el = document.getElementById('sm-today-content');
  if (!el) return;
  var days = typeof TRIP_DAYS !== 'undefined' ? TRIP_DAYS : [];
  var stops = typeof TRIP_STOPS !== 'undefined' ? TRIP_STOPS : [];
  if (!days.length) { el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-3);">No trip data found.</div>'; return; }

  var idx = _smTodayIdx();
  var day = days[idx];
  var stop = stops.find(function(s){ return s.id === day.stopId; }) || {};
  var totalDays = days.length;
  var pct = Math.round(((idx + 1) / totalDays) * 100);
  var dLeft = totalDays - idx - 1;
  var dateLabel = _smFmtDate(day.date);

  /* Drive card vs explore card */
  var driveHtml = '';
  if (day.driveDay) {
    /* Previous stop = where we're coming from */
    var prevDay = idx > 0 ? days[idx - 1] : null;
    var prevStop = prevDay ? (stops.find(function(s){ return s.id === prevDay.stopId; }) || {}) : {};
    var fromName = prevStop.name || 'Home';
    var toName = stop.name || 'Next Stop';
    var miText = day.miles ? day.miles + ' mi' : '';
    var hrText = day.driveHours ? day.driveHours + 'h' : '';
    driveHtml = '<div class="today-drive" onclick="switchNav(\'s-schedule\',\'nav-schedule\',\'Schedule\')">'
      + '<div class="today-drive-head">'
      + '<div class="today-drive-icon"><i class="fa-solid fa-car-side"></i></div>'
      + '<div><div style="font-size:.68rem;font-weight:800;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px;">Drive Day</div>'
      + '<div style="font-size:1rem;font-weight:900;">' + fromName + ' â†’ ' + toName + '</div></div>'
      + '</div>'
      + '<div class="route-viz"><div class="route-dot"></div><div class="route-line"><span class="route-car"><i class="fa-solid fa-van-shuttle"></i></span></div><div class="route-dot end"></div></div>'
      + '<div class="route-label"><span>' + fromName + '</span><span>' + toName + '</span></div>'
      + '<div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">'
      + (miText ? '<span class="pill pill-dark"><i class="fa-solid fa-road"></i> ' + miText + '</span>' : '')
      + (hrText ? '<span class="pill pill-dark"><i class="fa-solid fa-clock"></i> ' + hrText + '</span>' : '')
      + '<span class="pill pill-green"><i class="fa-solid fa-circle-check"></i> Drive day</span>'
      + '</div></div>';
  } else {
    var actCount = (stop.activities || []).length;
    driveHtml = '<div class="today-drive" onclick="switchNav(\'s-schedule\',\'nav-schedule\',\'Schedule\')">'
      + '<div class="today-drive-head">'
      + '<div class="today-drive-icon" style="background:var(--green-l);"><i class="fa-solid fa-person-hiking" style="color:var(--green);"></i></div>'
      + '<div><div style="font-size:.68rem;font-weight:800;color:var(--green);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px;">Explore Day</div>'
      + '<div style="font-size:1rem;font-weight:900;">' + (stop.name || 'Rest day') + '</div></div>'
      + '</div>'
      + (day.title ? '<div style="font-size:.82rem;color:var(--text-2);margin-top:10px;line-height:1.5;">' + day.title + '</div>' : '')
      + '<div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">'
      + '<span class="pill pill-green"><i class="fa-solid fa-leaf"></i> No driving</span>'
      + (actCount ? '<span class="pill pill-dark"><i class="fa-solid fa-star"></i> ' + actCount + ' activities</span>' : '')
      + '</div></div>';
  }

  /* Tonight's stop hero */
  var heroHtml = '<h2 class="section-head">Tonight</h2>'
    + '<div class="hero-card" onclick="openCampInfo(' + (idx + 1) + ')">'
    + '<div class="hero-bg"></div><div class="hero-overlay"></div>'
    + '<div class="hero-label"><i class="fa-solid fa-location-dot"></i> Tonight\'s stop</div>'
    + '<div class="hero-title">' + (stop.emoji || 'ğŸ“') + ' ' + (stop.name || 'Unknown') + (stop.state ? ', ' + stop.state : '') + '</div>'
    + '<div class="hero-sub">' + (day.sleep || stop.name || '') + (day.sleepType ? ' Â· ' + day.sleepType.replace(/_/g,' ') : '') + '</div>'
    + '</div>';

  /* Stats */
  var statsHtml = '<div class="stat-row">'
    + '<div class="stat-box"><div class="stat-num">' + day.day + '</div><div class="stat-lbl">Day</div></div>'
    + '<div class="stat-box"><div class="stat-num">' + dLeft + '</div><div class="stat-lbl">Left</div></div>'
    + '<div class="stat-box"><div class="stat-num" style="color:var(--orange)">' + (day.miles || 0) + '</div><div class="stat-lbl">Miles</div></div>'
    + '</div>';

  /* Header */
  var hdr = '<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">'
    + '<div><div class="screen-eyebrow">Today Â· ' + dateLabel + '</div><div class="screen-title">Day ' + day.day + '</div></div>'
    + '<div style="text-align:right;"><div style="font-size:.72rem;font-weight:700;color:var(--text-3);margin-bottom:4px;">Trip progress</div>'
    + '<div style="font-size:1.2rem;font-weight:900;color:var(--orange);">' + pct + '%</div></div>'
    + '</div>';

  /* Genie bar */
  var genieHtml = '<div class="genie-bar" onclick="showGenieDemoToast()">'
    + '<div class="genie-icon">âœ¨</div>'
    + '<div class="genie-text"><div class="t1">Ask TripGenie anything</div>'
    + '<div class="t2">"What should the kids do today at ' + (stop.name || 'this stop') + '?"</div></div>'
    + '<i class="fa-solid fa-chevron-right" style="color:rgba(255,255,255,.5);margin-left:auto;"></i></div>';

  /* Quick actions */
  var qaHtml = '<h2 class="section-head">Quick actions</h2>'
    + '<div class="card" style="padding:4px 12px;">'
    + '<div class="list-row" onclick="goTo(\'s-journal\',\'Journal\',\'Today\',\'today\')">'
    + '<div class="row-icon" style="background:var(--blue-l);color:var(--blue);"><i class="fa-solid fa-book"></i></div>'
    + '<div class="row-body"><div class="row-title">Write today\'s journal</div><div class="row-sub">Capture today\'s memories</div></div>'
    + '<i class="fa-solid fa-chevron-right row-caret"></i></div>'
    + '<div class="list-row" onclick="goTo(\'s-school\',\'School\',\'Today\',\'today\')">'
    + '<div class="row-icon" style="background:var(--green-l);color:var(--green);"><i class="fa-solid fa-book-open"></i></div>'
    + '<div class="row-body"><div class="row-title">School for today</div><div class="row-sub">' + (day.driveDay ? 'Drive day â€” 2h formal + audiobooks' : 'Explore day â€” enrichment curriculum') + '</div></div>'
    + '<i class="fa-solid fa-chevron-right row-caret"></i></div>'
    + '<div class="list-row" onclick="showGenieDemoToast()">'
    + '<div class="row-icon" style="background:var(--orange-l);color:var(--orange-d);"><i class="fa-solid fa-arrows-spin"></i></div>'
    + '<div class="row-body"><div class="row-title">Change the plan</div><div class="row-sub">Tell TripGenie what needs adjusting</div></div>'
    + '<i class="fa-solid fa-chevron-right row-caret"></i></div>'
    + '</div>';

  /* Update progress strip */
  var fill = document.getElementById('progress-fill');
  if (fill) fill.style.width = pct + '%';

  el.innerHTML = hdr + driveHtml + statsHtml + heroHtml + genieHtml + qaHtml;
}

function _smRenderSchedule() {
  var el = document.getElementById('sm-schedule-content');
  if (!el) return;
  var days = typeof TRIP_DAYS !== 'undefined' ? TRIP_DAYS : [];
  var stops = typeof TRIP_STOPS !== 'undefined' ? TRIP_STOPS : [];
  if (!days.length) { el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-3);">No schedule data.</div>'; return; }

  var todayIdx = _smTodayIdx();
  var totalMiles = (typeof CONFIG !== 'undefined' && CONFIG.totalMiles) || 0;

  /* Header */
  var start = _smFmtDateShort(days[0].date);
  var end   = _smFmtDateShort(days[days.length-1].date);
  var html = '<div class="screen-eyebrow">' + days.length + ' days' + (totalMiles ? ' Â· ' + totalMiles.toLocaleString() + ' mi' : '') + '</div>'
    + '<div class="screen-title">Schedule</div>'
    + '<div class="screen-subtitle">' + start + ' â€“ ' + end + '</div>';

  /* Group days by week (7-day chunks) */
  var MONTHS = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  var weekStart = 0;
  while (weekStart < days.length) {
    var weekEnd = Math.min(weekStart + 7, days.length);
    var wDays = days.slice(weekStart, weekEnd);
    var wNum = Math.floor(weekStart / 7) + 1;
    var wS = _smFmtDateShort(wDays[0].date);
    var wE = _smFmtDateShort(wDays[wDays.length-1].date);
    /* Determine week status */
    var wStatus = '';
    if (weekEnd - 1 < todayIdx) wStatus = ' Â· Past';
    else if (weekStart <= todayIdx && todayIdx < weekEnd) wStatus = ' Â· Current';
    html += '<div class="week-head">Week ' + wNum + ' â€” ' + wS + 'â€“' + wE + wStatus + '</div>';

    wDays.forEach(function(day, wi) {
      var globalIdx = weekStart + wi;
      var isPast = globalIdx < todayIdx;
      var isToday = globalIdx === todayIdx;
      var md = _smMonDay(day.date);
      var stop = stops.find(function(s){ return s.id === day.stopId; }) || {};
      var rowClass = 'day-row' + (isToday ? ' is-today' : isPast ? ' is-past' : '');
      var pillClass = isToday ? 'pill-orange' : 'pill-dark';
      var subText = day.driveDay
        ? 'Drive' + (day.miles ? ' Â· ' + day.miles + ' mi' : '') + (day.driveHours ? ' Â· ' + day.driveHours + 'h' : '')
        : 'Explore Â· ' + (stop.name || '');
      if (isToday) subText = '<i class="fa-solid fa-star" style="font-size:.65rem;"></i> Today Â· ' + subText;
      var subStyle = isToday ? 'font-size:.75rem;color:var(--orange);font-weight:700;' : 'font-size:.75rem;color:var(--text-2);';
      html += '<div class="' + rowClass + '" onclick="switchNav(\'s-schedule\',\'nav-schedule\',\'Schedule\')">'
        + '<div class="day-num"><div class="d"' + (isToday ? ' style="color:var(--orange);"' : '') + '>' + md.d + '</div><div class="mo">' + md.mo + '</div></div>'
        + '<div style="flex:1;min-width:0;">'
        + '<div style="font-size:.88rem;font-weight:800;margin-bottom:2px;">' + (day.title || stop.name || 'Day ' + day.day) + '</div>'
        + '<div style="' + subStyle + '">' + subText + '</div>'
        + '</div>'
        + '<span class="pill ' + pillClass + '" style="font-size:.65rem;">D' + day.day + '</span>'
        + '</div>';
    });
    weekStart = weekEnd;
  }
  html += '<div style="height:8px;"></div>';
  el.innerHTML = html;
}

function _smRenderStops() {
  var el = document.getElementById('sm-stops-content');
  if (!el) return;
  var days = typeof TRIP_DAYS !== 'undefined' ? TRIP_DAYS : [];
  var stops = typeof TRIP_STOPS !== 'undefined' ? TRIP_STOPS : [];
  if (!stops.length) { el.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-3);">No stops found.</div>'; return; }

  var todayIdx = _smTodayIdx();
  var todayStopId = days[todayIdx] ? days[todayIdx].stopId : -1;

  var html = '<div class="screen-eyebrow">' + stops.length + ' stops</div>'
    + '<div class="screen-title">Stops</div>'
    + '<div class="screen-subtitle">Your complete route</div>'
    + '<div class="card" style="padding:4px 12px;margin-bottom:20px;">';

  stops.forEach(function(stop) {
    var stopDays = days.filter(function(d){ return d.stopId === stop.id; });
    var firstDay = stopDays[0];
    var lastDay  = stopDays[stopDays.length - 1];
    var nights   = stopDays.filter(function(d){ return !d.driveDay; }).length;
    var isTonight = stop.id === todayStopId;
    /* Determine if stop is past, current, or future */
    var firstIdx = firstDay ? days.indexOf(firstDay) : 9999;
    var lastIdx  = lastDay  ? days.indexOf(lastDay)  : 9999;
    var isPast   = lastIdx < todayIdx;
    var isCurrent = firstIdx <= todayIdx && todayIdx <= lastIdx;

    var iconBg = isPast ? '#f0f0f0' : isCurrent ? 'var(--orange-l)' : 'var(--blue-l)';
    var iconColor = isPast ? 'var(--text-3)' : isCurrent ? 'var(--orange)' : 'var(--blue)';
    var iconEl = isPast ? 'fa-circle-check' : 'fa-location-dot';
    var rowStyle = isCurrent ? 'border-left:3px solid var(--orange);padding-left:13px;' : isPast ? 'opacity:.55;' : '';

    var dateRange = '';
    if (firstDay && lastDay) {
      dateRange = _smFmtDateShort(firstDay.date) + (firstDay.date !== lastDay.date ? 'â€“' + _smFmtDateShort(lastDay.date) : '');
    }
    var subText = (dateRange ? dateRange + ' Â· ' : '') + (nights ? nights + ' night' + (nights!==1?'s':'') : 'transit');

    var tonightBadge = isTonight ? '<span class="pill pill-orange" style="font-size:.62rem;padding:3px 7px;margin-left:4px;">Tonight</span>' : '';

    html += '<div class="list-row" style="' + rowStyle + '" onclick="switchNav(\'s-schedule\',\'nav-schedule\',\'Planner\'); _smSeg(\'stops\')">'
      + '<div class="row-icon" style="background:' + iconBg + ';color:' + iconColor + ';font-size:1rem;">' + (stop.emoji || '<i class="fa-solid ' + iconEl + '"></i>') + '</div>'
      + '<div class="row-body">'
      + '<div class="row-title">' + (stop.name || 'Unknown') + (stop.state ? ', ' + stop.state : '') + tonightBadge + '</div>'
      + '<div class="row-sub">' + subText + '</div>'
      + '</div>'
      + '<i class="fa-solid fa-chevron-right row-caret"></i>'
      + '</div>';
  });

  html += '</div>';
  el.innerHTML = html;
}

function _smRenderAll() {
  _smRenderToday();
  _smRenderSchedule();
  _smRenderStops();
}

/* â”€â”€ INIT â”€â”€ */
/* s-today already has class="screen active" in the HTML; no DOM call needed here */

  // Expose to window so onclick="" attributes work
  window.switchNav   = typeof switchNav   === 'function' ? switchNav   : window.switchNav;
  window.goTo        = typeof goTo        === 'function' ? goTo        : window.goTo;
  window.goBack      = typeof goBack      === 'function' ? goBack      : window.goBack;
  window.goToScreen  = typeof goToScreen  === 'function' ? goToScreen  : window.goToScreen;
  window.handleTopAction = typeof handleTopAction === 'function' ? handleTopAction : function(){};
  window._smToast    = typeof _smToast    === 'function' ? _smToast    : function(){};

  // SM init â€” called when switching to simple mode; re-renders on every activation
  window._smActivate = function() {
    _smReady = true;
    _smRenderAll();
  };
})();

</script>

  <!-- â•â• SIMPLE MODE OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="sm">
    <div id="shell">

  <!-- TOP BAR -->
  <div id="top-bar">
    <button id="back-btn" onclick="goBack()"><i class="fa-solid fa-arrow-left"></i></button>
    <div id="top-title">Maass Family RV 2026</div>
    <button id="top-action" class="show" onclick="handleTopAction()">âœ¨ Ask</button>
    <div title="Switch view" style="display:flex;align-items:center;background:rgba(30,77,123,.08);border:1.5px solid rgba(30,77,123,.2);border-radius:12px;padding:3px;gap:2px;flex-shrink:0;">
      <span style="background:var(--orange);color:#fff;border-radius:100px;padding:4px 11px;font-size:.7rem;font-weight:800;white-space:nowrap;font-family:inherit;"><i class="fa-solid fa-mobile-screen-button"></i> Driving</span>
      <span style="background:transparent;color:var(--blue);border-radius:100px;padding:4px 11px;font-size:.7rem;font-weight:800;cursor:pointer;white-space:nowrap;font-family:inherit;" onclick="_hideSimpleMode()"><i class="fa-solid fa-sliders"></i> Planning</span>
    </div>
  </div>

  <!-- PROGRESS STRIP -->
  <div id="progress-strip"><div id="progress-fill" style="width:26%"></div></div>

  <!-- SCREENS -->
  <div id="screen-area">

    <!-- â•â• SCREEN: TODAY â•â• -->
    <div class="screen active" id="s-today">
      <div id="sm-today-content"><div style="padding:40px 0;text-align:center;color:var(--text-3);font-size:.9rem;">Loadingâ€¦</div></div>
    </div><!-- /s-today -->


    <!-- â•â• SCREEN: SCHEDULE + STOPS (combined) â•â• -->
    <div class="screen" id="s-schedule">
      <div class="sm-seg-bar">
        <button id="seg-btn-schedule" class="sm-seg-btn active" onclick="_smSeg('schedule')"><i class="fa-solid fa-calendar-days"></i> Days</button>
        <button id="seg-btn-stops" class="sm-seg-btn" onclick="_smSeg('stops')"><i class="fa-solid fa-campground"></i> Stops</button>
      </div>
      <div id="sm-schedule-content" style="display:block"><div style="padding:40px 0;text-align:center;color:var(--text-3);font-size:.9rem;">Loadingâ€¦</div></div>
      <div id="sm-stops-content" style="display:none"><div style="padding:40px 0;text-align:center;color:var(--text-3);font-size:.9rem;">Loadingâ€¦</div></div>
    </div><!-- /s-schedule+stops -->


    <!-- â•â• SCREEN: STOP DETAIL â•â• -->
    <div class="screen" id="s-stop">

      <div class="stop-photo" id="stop-photo-el">
        <div style="position:absolute;inset:0;background-image:url('https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/Cliff_Palace_2006_09_12.jpg/1280px-Cliff_Palace_2006_09_12.jpg');background-size:cover;background-position:center;opacity:.6;"></div>
        <div style="position:absolute;inset:0;background:linear-gradient(to top,rgba(10,20,40,.8) 0%,rgba(10,20,40,.1) 60%);"></div>
        <div class="stop-photo-label">
          <div>
            <div style="font-size:1.4rem;font-weight:900;color:#fff;line-height:1.1;" id="stop-name-el">Mesa Verde NP</div>
            <div style="font-size:.78rem;color:rgba(255,255,255,.75);margin-top:3px;"><i class="fa-solid fa-moon"></i> 3 nights Â· Mar 27â€“30</div>
          </div>
          <div class="stop-photo-num">3N</div>
        </div>
      </div>

      <!-- Key facts -->
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px;">
        <span class="pill pill-green"><i class="fa-solid fa-plug"></i> Full hookup</span>
        <span class="pill pill-blue"><i class="fa-solid fa-campground"></i> RV Park</span>
        <span class="pill pill-orange"><i class="fa-solid fa-star"></i> Top rated</span>
      </div>

      <!-- Weather forecast -->
      <h2 class="section-head"><i class="fa-solid fa-cloud-sun" style="color:var(--blue);margin-right:6px;"></i>Weather at Mesa Verde</h2>
      <div class="card" style="padding:14px 16px 10px;margin-bottom:20px;">
        <div style="display:flex;gap:6px;overflow-x:auto;padding-bottom:4px;">
          <div class="wx-day today">
            <div class="wx-day-name">Thu</div>
            <div class="wx-icon">â›…</div>
            <div class="wx-hi">62Â°</div>
            <div class="wx-lo">38Â°</div>
          </div>
          <div class="wx-day">
            <div class="wx-day-name">Fri</div>
            <div class="wx-icon">â˜€ï¸</div>
            <div class="wx-hi">68Â°</div>
            <div class="wx-lo">41Â°</div>
          </div>
          <div class="wx-day">
            <div class="wx-day-name">Sat</div>
            <div class="wx-icon">â›…</div>
            <div class="wx-hi">65Â°</div>
            <div class="wx-lo">39Â°</div>
          </div>
          <div class="wx-day">
            <div class="wx-day-name">Sun</div>
            <div class="wx-icon">â˜ï¸</div>
            <div class="wx-hi">58Â°</div>
            <div class="wx-lo">35Â°</div>
          </div>
          <div class="wx-day">
            <div class="wx-day-name">Mon</div>
            <div class="wx-icon">ğŸŒ§ï¸</div>
            <div class="wx-hi">52Â°</div>
            <div class="wx-lo">32Â°</div>
          </div>
        </div>
        <div style="margin-top:10px;font-size:.72rem;color:var(--text-2);line-height:1.5;">
          <i class="fa-solid fa-triangle-exclamation" style="color:var(--orange);"></i>
          <strong>Friâ€“Sat best days</strong> for outdoor activities Â· cold nights near freezing Â· layers recommended
        </div>
        <button onclick="showGenieDemoToast()" style="margin-top:10px;background:var(--blue-l);border:1.5px solid rgba(30,77,123,.2);color:var(--blue);border-radius:100px;padding:7px 14px;font-size:.75rem;font-weight:800;cursor:pointer;font-family:var(--font);">âœ¨ Ask TripGenie about weather</button>
      </div>

      <!-- Activities -->
      <h2 class="section-head">Things to do</h2>
      <div style="margin:-4px;margin-bottom:8px;">
        <span class="act-tag" data-activity="Cliff Palace Tour" onclick="toggleActivity(this,'Cliff Palace Tour')">
          <i class="fa-solid fa-landmark" style="color:var(--orange);"></i> Cliff Palace Tour
          <i class="fa-solid fa-circle-check act-check" style="display:none;margin-left:4px;"></i>
        </span>
        <span class="act-tag" data-activity="Balcony House Hike" onclick="toggleActivity(this,'Balcony House Hike')">
          <i class="fa-solid fa-person-hiking" style="color:var(--green);"></i> Balcony House Hike
          <i class="fa-solid fa-circle-check act-check" style="display:none;margin-left:4px;"></i>
        </span>
        <span class="act-tag" data-activity="Chapin Mesa Overlook" onclick="toggleActivity(this,'Chapin Mesa Overlook')">
          <i class="fa-solid fa-binoculars" style="color:var(--blue);"></i> Chapin Mesa Overlook
          <i class="fa-solid fa-circle-check act-check" style="display:none;margin-left:4px;"></i>
        </span>
        <span class="act-tag" data-activity="Sunset Point" onclick="toggleActivity(this,'Sunset Point')">
          <i class="fa-solid fa-camera" style="color:var(--text-2);"></i> Sunset Point
          <i class="fa-solid fa-circle-check act-check" style="display:none;margin-left:4px;"></i>
        </span>
        <span class="act-tag" data-activity="Spruce Tree House" onclick="toggleActivity(this,'Spruce Tree House')">
          <i class="fa-solid fa-tree" style="color:var(--green);"></i> Spruce Tree House
          <i class="fa-solid fa-circle-check act-check" style="display:none;margin-left:4px;"></i>
        </span>
      </div>
      <div style="font-size:.72rem;color:var(--text-3);margin-bottom:16px;padding-left:4px;">Tap an activity to add it to your plan</div>

      <!-- Plan for this stop (hidden until items added) -->
      <div id="stop-plan-section" style="display:none;margin-bottom:20px;">
        <h2 class="section-head"><i class="fa-solid fa-clipboard-list" style="color:var(--orange);margin-right:6px;"></i>Your plan for this stop <span id="stop-plan-count" style="background:var(--orange);color:#fff;border-radius:100px;padding:2px 8px;font-size:.65rem;font-weight:900;margin-left:4px;">0</span></h2>
        <div class="card" style="padding:4px 16px;" id="stop-plan-list"></div>
      </div>

      <!-- School at this stop -->
      <h2 class="section-head">School at this stop</h2>
      <div class="card" style="padding:8px 16px;margin-bottom:20px;">
        <div class="school-card">
          <div class="school-icon" style="background:var(--green-l);color:var(--green);"><i class="fa-solid fa-person-hiking"></i></div>
          <div>
            <div style="font-size:.85rem;font-weight:800;margin-bottom:2px;">Field Trip Day</div>
            <div style="font-size:.75rem;color:var(--text-2);">Ancestral Puebloans Â· history + science</div>
          </div>
        </div>
        <div class="school-card">
          <div class="school-icon" style="background:var(--blue-l);color:var(--blue);"><i class="fa-solid fa-book-open"></i></div>
          <div>
            <div style="font-size:.85rem;font-weight:800;margin-bottom:2px;">Regular school day</div>
            <div style="font-size:.75rem;color:var(--text-2);">4h curriculum + 2h enrichment</div>
          </div>
        </div>
        <div class="school-card">
          <div class="school-icon" style="background:var(--orange-l);color:var(--orange-d);"><i class="fa-solid fa-car-side"></i></div>
          <div>
            <div style="font-size:.85rem;font-weight:800;margin-bottom:2px;">Drive day</div>
            <div style="font-size:.75rem;color:var(--text-2);">Shorter day Â· 2h formal + audiobooks</div>
          </div>
        </div>
      </div>

      <!-- TripGenie for this stop -->
      <div class="genie-bar" onclick="showGenieDemoToast()">
        <div class="genie-icon">âœ¨</div>
        <div class="genie-text">
          <div class="t1">Ask about Mesa Verde</div>
          <div class="t2">"Best hike for a 9-year-old?" Â· "Good sunset spots?"</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:rgba(255,255,255,.5);margin-left:auto;"></i>
      </div>

    </div><!-- /s-stop -->


    <!-- â•â• SCREEN: DAY DETAIL â•â• -->
    <div class="screen" id="s-day-detail">

      <div class="screen-eyebrow" id="dd-eyebrow">Friday, Mar 27</div>
      <div class="screen-title" id="dd-title">Day 12</div>
      <div style="margin-bottom:20px;display:flex;gap:8px;">
        <span class="pill pill-orange" id="dd-type-pill"><i class="fa-solid fa-car-side"></i> Drive Day</span>
      </div>

      <!-- Drive detail -->
      <div class="today-drive" style="margin-bottom:20px;">
        <div class="today-drive-head">
          <div class="today-drive-icon"><i class="fa-solid fa-car-side"></i></div>
          <div>
            <div style="font-size:.68rem;font-weight:800;color:var(--orange);letter-spacing:.06em;text-transform:uppercase;margin-bottom:2px;">Route</div>
            <div style="font-size:1rem;font-weight:900;" id="dd-route">Moab â†’ Mesa Verde</div>
          </div>
        </div>
        <div class="route-viz">
          <div class="route-dot"></div>
          <div class="route-line"><span class="route-car"><i class="fa-solid fa-van-shuttle"></i></span></div>
          <div class="route-dot end"></div>
        </div>
        <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap;">
          <span class="pill pill-dark"><i class="fa-solid fa-road"></i> 112 mi</span>
          <span class="pill pill-dark"><i class="fa-solid fa-clock"></i> 2h 10m</span>
          <span class="pill pill-green"><i class="fa-solid fa-circle-check"></i> Easy drive</span>
        </div>
      </div>

      <!-- School -->
      <h2 class="section-head">School</h2>
      <div class="card" style="padding:16px;margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
          <div class="school-icon" style="background:var(--orange-l);color:var(--orange-d);width:36px;height:36px;font-size:.85rem;"><i class="fa-solid fa-car-side"></i></div>
          <div style="font-size:.88rem;font-weight:800;">Drive day school</div>
        </div>
        <div style="font-size:.82rem;color:var(--text-2);line-height:1.6;">
          â± 2h formal school<br>
          ğŸ“» Audiobooks + podcasts while driving<br>
          ğŸ‘©â€ğŸ« Lauren's day
        </div>
      </div>

      <!-- Notes -->
      <h2 class="section-head">Notes for today</h2>
      <div class="field">
        <textarea rows="4" placeholder="Anything to remember about this dayâ€¦" style="font-size:.88rem;"></textarea>
      </div>

      <div class="genie-bar" onclick="showGenieDemoToast()">
        <div class="genie-icon">âœ¨</div>
        <div class="genie-text">
          <div class="t1">TripGenie suggestions</div>
          <div class="t2">Get tips for this specific day</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:rgba(255,255,255,.5);margin-left:auto;"></i>
      </div>

    </div><!-- /s-day-detail -->


    <!-- â•â• SCREEN: JOURNAL â•â• -->
    <div class="screen" id="s-journal">

      <div class="screen-eyebrow">Day 12 Â· Mar 27</div>
      <div class="screen-title">Journal</div>
      <div class="screen-subtitle">What happened today?</div>

      <div class="field">
        <label>Today's entry</label>
        <textarea rows="8" placeholder="Write about todayâ€¦ What did you see? What made the kids laugh? Any surprises?&#10;&#10;You can speak instead â€” tap the mic below."></textarea>
      </div>

      <div style="display:flex;gap:10px;margin-bottom:20px;">
        <button class="btn-secondary" style="flex:1;" onclick="showGenieDemoToast()"><i class="fa-solid fa-microphone"></i> Speak</button>
        <button class="btn-secondary" style="flex:1;" onclick="showGenieDemoToast()"><i class="fa-solid fa-camera"></i> Add photo</button>
      </div>

      <button class="btn-primary" onclick="showToast('Journal saved! âœï¸')"><i class="fa-solid fa-check"></i> Save entry</button>

      <h2 class="section-head">Previous entries</h2>
      <div class="card" style="padding:4px 12px;">
        <div class="list-row" onclick="showGenieDemoToast()">
          <div class="row-icon" style="background:var(--blue-l);color:var(--blue);"><i class="fa-solid fa-calendar-day"></i></div>
          <div class="row-body">
            <div class="row-title">Mar 26 Â· Day 11</div>
            <div class="row-sub">Arches at sunrise was unrealâ€¦</div>
          </div>
          <i class="fa-solid fa-chevron-right row-caret"></i>
        </div>
        <div class="list-row" onclick="showGenieDemoToast()">
          <div class="row-icon" style="background:var(--blue-l);color:var(--blue);"><i class="fa-solid fa-calendar-day"></i></div>
          <div class="row-body">
            <div class="row-title">Mar 25 Â· Day 10</div>
            <div class="row-sub">The kids found a lizard at Canyonlands</div>
          </div>
          <i class="fa-solid fa-chevron-right row-caret"></i>
        </div>
      </div>

    </div><!-- /s-journal -->


    <!-- â•â• SCREEN: SCHOOL â•â• -->
    <div class="screen" id="s-school">

      <div class="screen-eyebrow">Day 12 Â· Drive Day</div>
      <div class="screen-title">School</div>
      <div class="screen-subtitle">Lauren's day Â· 2h formal + enrichment</div>

      <div class="stat-row">
        <div class="stat-box">
          <div class="stat-num">68</div>
          <div class="stat-lbl">Days done</div>
        </div>
        <div class="stat-box">
          <div class="stat-num">12</div>
          <div class="stat-lbl">Field trips</div>
        </div>
        <div class="stat-box">
          <div class="stat-num" style="color:var(--green);">âœ“</div>
          <div class="stat-lbl">On track</div>
        </div>
      </div>

      <h2 class="section-head">Today's plan</h2>
      <div class="card" style="padding:8px 16px;margin-bottom:20px;">

        <div class="school-card">
          <div class="school-icon" style="background:var(--blue-l);color:var(--blue);"><i class="fa-solid fa-calculator"></i></div>
          <div>
            <div style="font-size:.85rem;font-weight:800;margin-bottom:2px;">Math Â· 45 min</div>
            <div style="font-size:.75rem;color:var(--text-2);">Khan Academy Â· fractions unit</div>
          </div>
          <i class="fa-solid fa-chevron-right row-caret" style="margin-left:auto;font-size:.75rem;color:var(--text-3);"></i>
        </div>

        <div class="school-card">
          <div class="school-icon" style="background:var(--green-l);color:var(--green);"><i class="fa-solid fa-book"></i></div>
          <div>
            <div style="font-size:.85rem;font-weight:800;margin-bottom:2px;">Reading Â· 30 min</div>
            <div style="font-size:.75rem;color:var(--text-2);">Warrior Cats Â· chapters 14â€“16</div>
          </div>
          <i class="fa-solid fa-chevron-right row-caret" style="margin-left:auto;font-size:.75rem;color:var(--text-3);"></i>
        </div>

        <div class="school-card">
          <div class="school-icon" style="background:var(--orange-l);color:var(--orange-d);"><i class="fa-solid fa-earth-americas"></i></div>
          <div>
            <div style="font-size:.85rem;font-weight:800;margin-bottom:2px;">Geography Â· 45 min</div>
            <div style="font-size:.75rem;color:var(--text-2);">Southwest states Â· map study</div>
          </div>
          <i class="fa-solid fa-chevron-right row-caret" style="margin-left:auto;font-size:.75rem;color:var(--text-3);"></i>
        </div>

      </div>

      <div class="genie-bar" onclick="showGenieDemoToast()">
        <div class="genie-icon">âœ¨</div>
        <div class="genie-text">
          <div class="t1">Generate today's lesson plan</div>
          <div class="t2">Customized for drive day + Mesa Verde</div>
        </div>
        <i class="fa-solid fa-chevron-right" style="color:rgba(255,255,255,.5);margin-left:auto;"></i>
      </div>

    </div><!-- /s-school -->

  </div><!-- /screen-area -->

  <!-- RIGHT CONTEXT PANEL (desktop only) -->
  <div id="right-panel">
    <!-- Today summary widget -->
    <div style="padding:24px 20px 0;flex-shrink:0;">
      <div style="font-size:.62rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--text-3);margin-bottom:14px;">Trip Status</div>
      <div style="display:flex;gap:8px;margin-bottom:16px;">
        <div style="flex:1;background:var(--bg);border-radius:12px;padding:12px 8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:900;color:var(--text);line-height:1;">12</div>
          <div style="font-size:.6rem;font-weight:700;color:var(--text-3);text-transform:uppercase;margin-top:3px;letter-spacing:.06em;">Day</div>
        </div>
        <div style="flex:1;background:var(--bg);border-radius:12px;padding:12px 8px;text-align:center;">
          <div style="font-size:1.5rem;font-weight:900;color:var(--text);line-height:1;">34</div>
          <div style="font-size:.6rem;font-weight:700;color:var(--text-3);text-transform:uppercase;margin-top:3px;letter-spacing:.06em;">Left</div>
        </div>
        <div style="flex:1;background:var(--orange-l);border-radius:12px;padding:12px 8px;text-align:center;">
          <div style="font-size:1.2rem;font-weight:900;color:var(--orange-d);line-height:1;">26%</div>
          <div style="font-size:.6rem;font-weight:700;color:var(--orange-d);text-transform:uppercase;margin-top:3px;letter-spacing:.06em;">Done</div>
        </div>
      </div>
      <!-- Progress bar -->
      <div style="height:4px;background:var(--border);border-radius:2px;margin-bottom:20px;overflow:hidden;">
        <div style="width:26%;height:100%;background:var(--orange);border-radius:2px;"></div>
      </div>
      <!-- Tonight's stop -->
      <div style="background:var(--blue-l);border-radius:14px;padding:14px 16px;margin-bottom:12px;">
        <div style="font-size:.6rem;font-weight:800;color:var(--blue);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px;"><i class="fa-solid fa-moon"></i> Tonight's Stop</div>
        <div style="font-weight:900;font-size:.9rem;color:var(--text);">Mesa Verde NP</div>
        <div style="font-size:.75rem;color:var(--text-2);margin-top:2px;">Morefield Camp Â· 3 nights Â· Full hookup</div>
      </div>
      <!-- Weather -->
      <div style="display:flex;align-items:center;gap:12px;background:var(--bg);border-radius:14px;padding:12px 16px;margin-bottom:20px;">
        <div style="font-size:1.8rem;line-height:1;">â›…</div>
        <div>
          <div style="font-weight:800;font-size:.88rem;color:var(--text);">58Â° â€“ 72Â°F tonight</div>
          <div style="font-size:.72rem;color:var(--text-2);margin-top:2px;">Partly cloudy Â· Mesa Verde, CO</div>
        </div>
      </div>
      <div style="height:1px;background:var(--border);margin:0 -20px 20px;"></div>
      <!-- TripGenie -->
      <div style="font-size:.62rem;font-weight:800;letter-spacing:.12em;text-transform:uppercase;color:var(--text-3);margin-bottom:12px;">âœ¨ Ask TripGenie</div>
    </div>
    <!-- TripGenie input area -->
    <div style="padding:0 20px 20px;flex-shrink:0;">
      <div style="background:#fff;border:1.5px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);">
        <textarea id="rp-genie-input" rows="3"
          placeholder="Ask anything about todayâ€¦&#10;&#10;&quot;What should we do first?&quot;"
          style="width:100%;border:none;outline:none;font-size:.84rem;font-family:var(--font);color:var(--text);background:transparent;resize:none;line-height:1.5;padding:14px 14px 0;box-sizing:border-box;"
          onfocus="this.parentElement.style.borderColor='var(--orange)'"
          onblur="this.parentElement.style.borderColor='var(--border)'"></textarea>
        <div style="padding:8px 10px;display:flex;justify-content:flex-end;">
          <button onclick="showGenieDemoToast()" style="background:var(--orange);color:#fff;border:none;border-radius:9px;padding:8px 16px;font-size:.78rem;font-weight:800;cursor:pointer;font-family:var(--font);">Ask â†’</button>
        </div>
      </div>
      <!-- Quick prompts -->
      <div style="margin-top:10px;display:flex;flex-direction:column;gap:6px;">
        <button onclick="showGenieDemoToast()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:.75rem;font-weight:600;cursor:pointer;font-family:var(--font);color:var(--text-2);text-align:left;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--orange)'" onmouseout="this.style.borderColor='var(--border)'">"Best hike for a 9-year-old at Mesa Verde?"</button>
        <button onclick="showGenieDemoToast()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:.75rem;font-weight:600;cursor:pointer;font-family:var(--font);color:var(--text-2);text-align:left;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--orange)'" onmouseout="this.style.borderColor='var(--border)'">"What time does Cliff Palace open?"</button>
        <button onclick="showGenieDemoToast()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:.75rem;font-weight:600;cursor:pointer;font-family:var(--font);color:var(--text-2);text-align:left;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--orange)'" onmouseout="this.style.borderColor='var(--border)'">"Dinner near Morefield Campground?"</button>
        <button onclick="showGenieDemoToast()" style="background:var(--bg);border:1.5px solid var(--border);border-radius:10px;padding:9px 12px;font-size:.75rem;font-weight:600;cursor:pointer;font-family:var(--font);color:var(--text-2);text-align:left;transition:border-color .15s;" onmouseover="this.style.borderColor='var(--orange)'" onmouseout="this.style.borderColor='var(--border)'">"Change the plan â€” skip Moab"</button>
      </div>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav id="bottom-nav">
    <!-- Sidebar brand â€” desktop only -->
    <div id="sidebar-brand-2">
      <div style="font-size:.72rem;font-weight:700;color:var(--text-2);" id="sidebar-day-counter">Day 12 of 46 Â· 26% complete</div>
    </div>
    <button class="nav-btn active" id="nav-today" onclick="switchNav('s-today','nav-today','Today')">
      <i class="fa-solid fa-house"></i>
      <span>Today</span>
    </button>
    <button class="nav-btn" id="nav-schedule" onclick="switchNav('s-schedule','nav-schedule','Planner')">
      <i class="fa-solid fa-route"></i>
      <span>Planner</span>
    </button>
    <button class="nav-btn" id="nav-journal" onclick="switchNav('s-journal','nav-journal','Journal')">
      <i class="fa-solid fa-book"></i>
      <span>Journal</span>
    </button>
    <button class="nav-btn" id="nav-school" onclick="switchNav('s-school','nav-school','School')">
      <i class="fa-solid fa-book-open"></i>
      <span>School</span>
    </button>
  </nav>
</div>

<!-- TOAST -->
<div id="toast" style="position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(20px);background:rgba(22,22,32,.9);color:#fff;padding:12px 20px;border-radius:12px;font-size:.82rem;font-weight:700;white-space:nowrap;z-index:9999;opacity:0;transition:all .25s;backdrop-filter:blur(10px);pointer-events:none;max-width:90vw;text-align:center;"></div>
  </div>
</body>
</html>
